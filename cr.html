<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
    <title data-i18n-key="page_title">Cursed Lab Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --bg-primary: #111827; /* gray-900 */
            --bg-secondary: #1f2937; /* gray-800 */
            --bg-tertiary: #374151; /* gray-700 */
            --border-color: #6b7280; /* gray-500 */
            --text-primary: #f3f4f6; /* gray-100 */
            --text-secondary: #9ca3af; /* gray-400 */
            --accent-primary: #8b5cf6; /* violet-500 */
            --accent-secondary: #ec4899; /* pink-500 */
            --success-color: #22c55e; /* green-500 */
        }
        html {
            font-size: 80%;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            background-image: radial-gradient(circle at 5% 5%, rgba(139, 92, 246, 0.08) 0%, transparent 30%),
                              radial-gradient(circle at 95% 95%, rgba(236, 72, 153, 0.08) 0%, transparent 30%);
            background-attachment: fixed;
        }
        .fade-in-up { animation: fadeInUp 0.5s ease-in-out forwards; opacity: 0; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .main-card {
            background: linear-gradient(145deg, rgba(31, 41, 55, 0.5), rgba(17, 24, 39, 0.5));
            border: 1px solid var(--border-color);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            box-shadow: 0 4px 25px rgba(0,0,0,0.3);
        }
        .sub-card {
            background-color: rgba(55, 65, 81, 0.25);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        .sub-card:hover {
            border-color: var(--accent-primary);
        }
        .glass-input, .glass-select {
             background-color: rgba(17, 24, 39, 0.6);
             border: 1px solid var(--border-color);
             transition: all 0.3s ease;
             color: var(--text-primary);
             padding: 0.75rem 1rem;
             font-size: 1rem;
        }
        .glass-input:focus, .glass-select:focus {
             border-color: var(--accent-primary);
             box-shadow: 0 0 10px rgba(139, 92, 246, 0.2);
             outline: none;
        }
        .nav-link {
            position: relative;
            transition: color 0.3s ease;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
        }
        .nav-link.active { 
            color: white; 
            background: rgba(255,255,255,0.1);
        }
        .nav-link:hover {
             background: rgba(255,255,255,0.05);
        }
        .hidden { display: none; }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        .btn-primary {
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }
        
        #toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .toast {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.1);
            animation: slideInRight 0.5s forwards, fadeOut 0.5s 3.5s forwards;
        }
        .toast.success {
            background: linear-gradient(90deg, var(--success-color), #16a34a);
        }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; transform: translateY(-20px); } }
        
        .player-card {
            background: linear-gradient(145deg, rgba(31, 41, 55, 0.4), rgba(17, 24, 39, 0.4));
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        .player-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
        }
        .player-card .rank {
            background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary));
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        #mobile-menu {
            transition: transform 0.3s ease-in-out;
            transform: translateX(100%);
        }
        #mobile-menu.open {
            transform: translateX(0);
        }
        #menu-overlay {
            transition: opacity 0.3s ease-in-out;
        }
        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid var(--accent-primary);
            object-fit: cover;
        }
    </style>
</head>
<body class="text-slate-200">

    <div id="toast-container"></div>
    <div id="menu-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-40 hidden"></div>

    <!-- Auth Modal -->
    <div id="auth-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden p-4">
        <div class="main-card rounded-xl w-full max-w-sm p-6 space-y-4">
            <h2 id="auth-title" class="text-2xl font-bold text-center text-white" data-i18n-key="auth_login_title">Login</h2>
            <form id="auth-form" class="space-y-3">
                <div id="username-field" class="hidden">
                    <label for="username" class="text-xs font-medium text-slate-300" data-i18n-key="auth_username">Username</label>
                    <input type="text" id="username" class="w-full glass-input rounded-md mt-1 focus:ring-0">
                </div>
                 <div id="alliance-field" class="hidden">
                    <label for="alliance-select" class="text-xs font-medium text-slate-300" data-i18n-key="auth_alliance">Alliance</label>
                    <select id="alliance-select" class="w-full glass-select rounded-md mt-1 focus:ring-0">
                        <option value="none" data-i18n-key="auth_alliance_none">None</option>
                        <option value="THOR">THOR</option>
                        <option value="fAfO">fAfO</option>
                        <option value="HeRa">HeRa</option>
                        <option value="pHNx">pHNx</option>
                        <option value="TroW">TroW</option>
                        <option value="VaLT">VaLT</option>
                        <option value="Tone">Tone</option>
                        <option value="COLD">COLD</option>
                        <option value="DoM">DoM</option>
                        <option value="MINI">MINI</option>
                        <option value="MEGA">MEGA</option>
                        <option value="Lat1">Lat1</option>
                    </select>
                </div>
                <div>
                    <label for="email" class="text-xs font-medium text-slate-300" data-i18n-key="auth_email">Email Address</label>
                    <input type="email" id="email" required class="w-full glass-input rounded-md mt-1 focus:ring-0">
                </div>
                <div>
                    <label for="password" class="text-xs font-medium text-slate-300" data-i18n-key="auth_password">Password</label>
                    <input type="password" id="password" required minlength="6" class="w-full glass-input rounded-md mt-1 focus:ring-0">
                </div>
                <div id="confirm-password-field" class="hidden">
                    <label for="confirm-password" class="text-xs font-medium text-slate-300" data-i18n-key="auth_confirm_password">Confirm Password</label>
                    <input type="password" id="confirm-password" class="w-full glass-input rounded-md mt-1 focus:ring-0">
                </div>
                <p id="auth-error" class="text-red-400 text-sm h-3"></p>
                <button type="submit" id="auth-submit-btn" class="w-full px-4 py-2 btn-primary rounded-md font-semibold text-white" data-i18n-key="auth_login_btn">Login</button>
            </form>
            <p class="text-center text-sm text-slate-400">
                <span id="auth-toggle-text" data-i18n-key="auth_no_account">Don't have an account?</span>
                <button id="auth-toggle-btn" class="font-semibold text-violet-400 hover:text-violet-300" data-i18n-key="auth_register_link">Register</button>
            </p>
        </div>
    </div>
    
    <!-- Profile Edit Modal -->
    <div id="profile-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden p-4">
        <div class="main-card rounded-xl w-full max-w-sm p-6 space-y-4">
            <h2 class="text-2xl font-bold text-center text-white" data-i18n-key="profile_title">Edit Profile</h2>
            <form id="profile-form" class="space-y-4">
                <div class="flex flex-col items-center space-y-2">
                    <img id="profile-avatar-preview" src="https://placehold.co/150x150/1f2937/9ca3af?text=Avatar" class="w-24 h-24 rounded-full object-cover border-2 border-violet-400">
                    <input type="file" id="avatar-upload" class="hidden" accept="image/*">
                    <button type="button" id="avatar-upload-btn" class="px-3 py-1 text-sm bg-slate-600 hover:bg-slate-500 rounded-md" data-i18n-key="profile_change_avatar">Change Avatar</button>
                </div>
                <div>
                    <label for="profile-username" class="text-xs font-medium text-slate-300" data-i18n-key="auth_username">Username</label>
                    <input type="text" id="profile-username" class="w-full glass-input rounded-md mt-1 focus:ring-0">
                </div>
                 <div>
                    <label for="profile-alliance-select" class="text-xs font-medium text-slate-300" data-i18n-key="auth_alliance">Alliance</label>
                    <select id="profile-alliance-select" class="w-full glass-select rounded-md mt-1 focus:ring-0">
                        <option value="none" data-i18n-key="auth_alliance_none">None</option>
                        <option value="THOR">THOR</option>
                        <option value="fAfO">fAfO</option>
                        <option value="HeRa">HeRa</option>
                        <option value="pHNx">pHNx</option>
                        <option value="TroW">TroW</option>
                        <option value="VaLT">VaLT</option>
                        <option value="Tone">Tone</option>
                        <option value="COLD">COLD</option>
                        <option value="DoM">DoM</option>
                        <option value="MINI">MINI</option>
                        <option value="MEGA">MEGA</option>
                        <option value="Lat1">Lat1</option>
                    </select>
                </div>
                <p id="profile-error" class="text-red-400 text-sm h-3"></p>
                <button type="submit" id="profile-save-btn" class="w-full px-4 py-2 btn-primary rounded-md font-semibold text-white" data-i18n-key="profile_save_btn">Save Changes</button>
            </form>
            <div class="border-t border-slate-700/50 pt-4">
                 <button id="logout-btn-profile" class="w-full px-4 py-2 bg-pink-600 hover:bg-pink-500 rounded-md font-semibold text-white transition-colors" data-i18n-key="auth_logout_btn">Logout</button>
            </div>
        </div>
    </div>

    <!-- Language Selection Modal -->
    <div id="language-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden p-4">
        <div class="main-card rounded-xl w-full max-w-sm p-6 space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-white" data-i18n-key="language_modal_title">Select Language</h2>
                <button id="close-language-modal-btn" class="p-2 text-slate-300 hover:text-white"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div id="language-options-container" class="grid grid-cols-1 sm:grid-cols-2 gap-3 pt-2">
                <!-- Language buttons will be injected here by JS -->
            </div>
        </div>
    </div>


    <!-- Navigation Bar -->
    <nav class="main-card sticky top-0 md:top-2 z-30 w-full max-w-5xl mx-auto rounded-none md:rounded-xl shadow-lg border-x-0 border-t-0 md:border">
        <div class="flex items-center justify-between p-3">
            <div class="flex items-center gap-3">
                <i class="fas fa-virus text-violet-400 text-2xl"></i>
                <h1 class="text-xl font-bold text-white">CR-Calc</h1>
            </div>
            <div id="desktop-menu" class="hidden md:flex items-center gap-2">
                <a href="#" class="nav-link active text-sm" data-page="calculator" data-i18n-key="nav_calculator">Calculator</a>
                <a href="#" class="nav-link text-sm" data-page="leaderboard" data-i18n-key="nav_leaderboard">Leaderboard</a>
                <a href="#" class="nav-link text-sm" data-page="information" data-i18n-key="nav_information">Information</a>
                <a href="#" id="language-modal-btn" class="nav-link text-sm" data-i18n-key="nav_language">Language</a>
            </div>
            <div class="hidden md:flex items-center gap-2">
                <div id="auth-container">
                    <button id="login-btn" class="px-3 py-1.5 btn-primary rounded-md transition-colors text-sm font-semibold" data-i18n-key="auth_login_btn_short">Login</button>
                    <div id="user-info" class="hidden items-center gap-2">
                         <img id="user-avatar" src="https://placehold.co/150x150/1f2937/9ca3af?text=Avatar" class="avatar w-8 h-8 cursor-pointer" title="Edit Profile">
                        <span id="user-display-name" class="hidden sm:block text-sm font-semibold text-slate-300"></span>
                    </div>
                </div>
            </div>
            <button id="hamburger-btn" class="md:hidden p-2 rounded-md text-slate-300 hover:bg-slate-700 flex items-center gap-2">
                <span class="font-semibold text-sm">Menu</span>
                <i class="fas fa-bars fa-lg"></i>
            </button>
        </div>
    </nav>

    <!-- Mobile Menu Panel -->
    <div id="mobile-menu" class="fixed top-0 right-0 bottom-0 w-4/5 max-w-xs bg-gray-900/95 backdrop-blur-lg z-50 p-4 flex flex-col">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-lg font-bold text-white">Menu</h2>
            <button id="close-menu-btn" class="p-2 text-slate-300 hover:text-white"><i class="fas fa-times fa-lg"></i></button>
        </div>
        <div class="flex flex-col gap-2">
            <a href="#" class="nav-link active text-base" data-page="calculator" data-i18n-key="nav_calculator">Calculator</a>
            <a href="#" class="nav-link text-base" data-page="leaderboard" data-i18n-key="nav_leaderboard">Leaderboard</a>
            <a href="#" class="nav-link text-base" data-page="information" data-i18n-key="nav_information">Information</a>
            <a href="#" id="language-modal-btn-mobile" class="nav-link text-base" data-i18n-key="nav_language">Language</a>
        </div>
        <div class="mt-auto border-t border-slate-700 pt-4 flex flex-col items-center gap-3">
            <div id="auth-container-mobile" class="w-full">
                <button id="login-btn-mobile" class="w-full px-3 py-2 btn-primary rounded-md transition-colors text-sm font-semibold" data-i18n-key="auth_login_btn_short">Login</button>
                <div id="user-info-mobile" class="hidden items-center justify-between gap-2">
                    <div class="flex items-center gap-2">
                        <img id="user-avatar-mobile" src="https://placehold.co/150x150/1f2937/9ca3af?text=Avatar" class="avatar w-8 h-8 cursor-pointer" title="Edit Profile">
                        <span id="user-display-name-mobile" class="text-sm font-semibold text-slate-300 truncate"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content Area -->
    <main class="w-full max-w-5xl mx-auto my-4 px-4">
        <div id="page-content" class="fade-in-up">
            <!-- Calculator Page -->
            <div id="calculator-page" class="main-card rounded-xl p-4 md:p-6 space-y-4">
                 <div class="flex justify-center">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 w-full max-w-4xl">
                        <!-- Fountains Section -->
                        <section class="sub-card p-4 rounded-xl space-y-4">
                            <h2 class="text-lg font-semibold text-white flex items-center justify-center gap-2"><i class="fas fa-water text-sky-400 fa-fw"></i><span data-i18n-key="calc_fountains_title">Blessed Fountains</span></h2>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm font-medium text-slate-300 mb-1 block" data-i18n-key="calc_fountain_1">Fountain 1</label>
                                    <select id="fountain1" class="fountain-level w-full glass-select rounded-md"></select>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-slate-300 mb-1 block" data-i18n-key="calc_fountain_2">Fountain 2</label>
                                    <select id="fountain2" class="fountain-level w-full glass-select rounded-md"></select>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-slate-300 mb-1 block" data-i18n-key="calc_fountain_3">Fountain 3</label>
                                    <select id="fountain3" class="fountain-level w-full glass-select rounded-md"></select>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-slate-300 mb-1 block" data-i18n-key="calc_fountain_4">Fountain 4</label>
                                    <select id="fountain4" class="fountain-level w-full glass-select rounded-md"></select>
                                </div>
                            </div>
                            <div id="fountain5-wrapper" class="space-y-2 pt-2">
                                 <div class="flex items-center justify-between">
                                    <label class="text-sm text-slate-300" data-i18n-key="calc_fountain_5_toggle">Enable 5th Fountain</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="fountain5-toggle">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <select id="fountain5" class="fountain-level w-full glass-select rounded-md" disabled></select>
                            </div>
                            <div class="pt-2 text-center border-t border-slate-700/50">
                                 <h3 class="text-sm font-medium text-slate-400" data-i18n-key="calc_total_water">Total Water / Hour</h3>
                                 <p id="total-output" class="text-3xl font-bold mt-1 text-sky-300">0</p>
                            </div>
                        </section>
                        <!-- Lab Upgrade Section -->
                        <section class="sub-card p-4 rounded-xl space-y-4 flex flex-col">
                            <h2 class="text-lg font-semibold text-white flex items-center justify-center gap-2"><i class="fas fa-flask-vial text-teal-400 fa-fw"></i><span data-i18n-key="calc_lab_title">Cursed Lab Upgrade</span></h2>
                            <div class="flex-grow space-y-4">
                                <div>
                                    <label for="current-water" class="text-sm font-medium text-slate-300 mb-1 block flex items-center gap-2">
                                        <i class="fas fa-fill-drip fa-fw text-slate-400"></i>
                                        <span data-i18n-key="calc_current_water">Current Sacred Water</span>
                                    </label>
                                    <input type="number" id="current-water" class="w-full glass-input rounded-md" placeholder="e.g., 50000">
                                </div>
                                <div>
                                    <label for="lab-level" class="text-sm font-medium text-slate-300 mb-1 block flex items-center gap-2">
                                        <i class="fas fa-arrow-up-right-dots fa-fw text-slate-400"></i>
                                        <span data-i18n-key="calc_target_level">Target Lab Level</span>
                                    </label>
                                    <select id="lab-level" class="w-full glass-select rounded-md"></select>
                                </div>
                            </div>
                             <div class="pt-4 text-center border-t border-slate-700/50">
                                 <h3 class="text-sm font-medium text-slate-400" data-i18n-key="calc_completion_time">Upgrade Completion Time</h3>
                                 <p id="lab-completion-time" class="text-3xl font-bold mt-1 text-teal-300">--</p>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
            
            <!-- Leaderboard Page -->
            <div id="leaderboard-page" class="main-card rounded-xl p-4 md:p-6 space-y-4 hidden">
                <div class="flex justify-between items-center flex-wrap gap-3">
                    <div>
                        <h2 class="text-xl font-semibold text-white flex items-center gap-2"><i class="fas fa-shield-alt text-violet-400 fa-fw"></i><span data-i18n-key="leaderboard_title">Resistance Development Leaderboard</span></h2>
                        <p class="text-slate-400 mt-1 text-sm" data-i18n-key="leaderboard_subtitle">See how you stack up against other players.</p>
                    </div>
                     <div id="leaderboard-login-prompt" class="sub-card p-3 rounded-xl text-center hidden">
                        <p class="text-slate-300 text-xs"><span data-i18n-key="leaderboard_login_prompt_1">Please</span> <button id="leaderboard-login-btn" class="font-bold text-sky-400 hover:underline" data-i18n-key="leaderboard_login_prompt_2">log in</button> <span data-i18n-key="leaderboard_login_prompt_3">to join the leaderboard.</span></p>
                    </div>
                </div>

                <!-- Player List -->
                <div id="player-list-container" class="flex flex-col gap-3">
                    <!-- Player list items will be injected here -->
                </div>
            </div>

            <!-- Information Page -->
            <div id="information-page" class="main-card rounded-xl p-4 md:p-6 space-y-4 hidden">
                <h2 class="text-xl font-semibold text-white flex items-center gap-2"><i class="fas fa-info-circle text-amber-400 fa-fw"></i><span data-i18n-key="info_title">Information</span></h2>
                <div class="prose prose-sm prose-invert max-w-none text-slate-300 space-y-3">
                    <p data-i18n-key="info_p1">This tool is designed to help you plan your resource management for the Cursed Lab and Blessed Fountains. Optimize your upgrades, see how you compare to others, and save your progress.</p>
                    
                    <h3 data-i18n-key="info_h_calc">Calculator Page</h3>
                    <ul class="list-disc list-inside space-y-1">
                        <li data-i18n-key="info_li_calc1"><b>Blessed Fountains:</b> Select the current level for each of your four primary fountains. If you have unlocked the fifth, use the toggle to enable it and set its level.</li>
                        <li data-i18n-key="info_li_calc2"><b>Total Production:</b> The calculator will instantly show your total Sacred Water production per hour based on your fountain levels.</li>
                        <li data-i18n-key="info_li_calc3"><b>Lab Upgrade:</b> Enter your current amount of Sacred Water and select the Cursed Lab level you are aiming for.</li>
                        <li data-i18n-key="info_li_calc4"><b>Completion Time:</b> The tool will calculate the exact date and time you will have enough resources for the selected lab upgrade.</li>
                    </ul>

                    <h3 data-i18n-key="info_h_leaderboard">Leaderboard</h3>
                    <p data-i18n-key="info_p_leaderboard">Log in to join the Leaderboard. Once logged in, your data will automatically sync to the leaderboard as you make changes in the calculator, allowing you to see how your progress and production rate compare to other players in real-time.</p>
                    
                    <h3 data-i18n-key="info_h_save">Saving Your Data</h3>
                    <p data-i18n-key="info_p_save">Creating an account and logging in automatically saves your data (fountain levels, current resources) to our database. The next time you visit, all your information will be pre-filled, so you can continue your planning without missing a beat.</p>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        /*
        Firebase v2 Security Rules:
        rules_version = '2';
        service cloud.firestore {
          match /databases/{database}/documents {
            // Private user data: Only the user can read/write their own data
            match /artifacts/{appId}/users/{userId} {
              allow read, write: if request.auth != null && request.auth.uid == userId;
            }
            // Public leaderboard data: Authenticated users can read all, but only write their own
            match /artifacts/{appId}/public/data/playerData/{userId} {
              allow read: if request.auth != null;
              allow write: if request.auth != null && request.auth.uid == userId;
            }
          }
        }
        
        // ADDED: Firebase Storage Security Rules
        // service firebase.storage {
        //   match /b/{bucket}/o {
        //     // Avatars: Allow authenticated users to write to their own avatar path
        //     // Anyone can read avatars.
        //     match /avatars/{userId}/{fileName} {
        //       allow read;
        //       allow write: if request.auth != null && request.auth.uid == userId;
        //     }
        //   }
        // }
        */

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB-XKrs7nCZgq1XOg_ouOs6x6ZCkjrJsf4",
            authDomain: "thecursedlab-709f3.firebaseapp.com",
            projectId: "thecursedlab-709f3",
            storageBucket: "thecursedlab-709f3.firebasestorage.app",
            messagingSenderId: "751252568769",
            appId: "1:751252568769:web:22a928747cbf1b6aec3240",
            measurementId: "G-M0Y9LSM58J"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'thecursedlab-709f3';
        const fountainProductionRates = { 0: 0, 1: 720, 2: 1440, 3: 2160, 4: 2880, 5: 3600, 6: 4320, 7: 5040, 8: 5760, 9: 6480, 10: 7200, 11: 7920, 12: 8640, 13: 9360, 14: 10080, 15: 10800, 16: 11520, 17: 12240, 18: 12960, 19: 13600, 20: 14400, 21: 15120, 22: 15840, 23: 16560, 24: 17280, 25: 18000, 26: 18720, 27: 19440, 28: 20160, 29: 20880, 30: 21600 };
        const labUpgradeData = { 1:{cost:0,res:400}, 2:{cost:11200,res:200}, 3:{cost:22400,res:300}, 4:{cost:44800,res:400}, 5:{cost:89600,res:500}, 6:{cost:125400,res:750}, 7:{cost:163100,res:1000}, 8:{cost:195700,res:1250}, 9:{cost:234800,res:1500}, 10:{cost:281800,res:1750}, 11:{cost:338100,res:2000}, 12:{cost:405800,res:2250}, 13:{cost:486900,res:2500}, 14:{cost:584300,res:2750}, 15:{cost:701200,res:3000}, 16:{cost:771300,res:3400}, 17:{cost:848400,res:3800}, 18:{cost:933301,res:4200}, 19:{cost:1026600,res:4600}, 20:{cost:1129301,res:5000}, 21:{cost:1242200,res:5500}, 22:{cost:1366400,res:6000}, 23:{cost:1503000,res:6500}, 24:{cost:1653301,res:7000}, 25:{cost:1818701,res:7500}, 26:{cost:2159600,res:8000}, 27:{cost:2505101,res:8500}, 28:{cost:2855301,res:9000}, 29:{cost:3460600,res:9500}, 30:{cost:4321100,res:10000} };
        
        let app, auth, db, storage, currentUserId = null;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            storage = getStorage(app);
        } catch (e) { console.error("Firebase initialization failed:", e); }
        
        onAuthStateChanged(auth, user => {
            currentUserId = user ? user.uid : null;
            updateUIForAuthState(user);
            if (user) { 
                loadDataFromFirestore();
                listenForPublicPlayerData();
            } else {
                dom.leaderboard.playerListContainer.innerHTML = ''; // Clear leaderboard on logout
            }
        });

        const dom = {
            toastContainer: document.getElementById('toast-container'),
            fountainSelectors: document.querySelectorAll('.fountain-level'),
            fifthFountain: {
                toggle: document.getElementById('fountain5-toggle'),
                selector: document.getElementById('fountain5')
            },
            calculator: {
                totalOutput: document.getElementById('total-output'),
                currentWater: document.getElementById('current-water'),
                labLevel: document.getElementById('lab-level'),
                completionTime: document.getElementById('lab-completion-time')
            },
            auth: {
                modal: document.getElementById('auth-modal'),
                form: document.getElementById('auth-form'),
                loginBtn: document.getElementById('login-btn'),
                userInfo: document.getElementById('user-info'),
                userAvatar: document.getElementById('user-avatar'),
                userDisplayName: document.getElementById('user-display-name'),
                loginBtnMobile: document.getElementById('login-btn-mobile'),
                userInfoMobile: document.getElementById('user-info-mobile'),
                userAvatarMobile: document.getElementById('user-avatar-mobile'),
                userDisplayNameMobile: document.getElementById('user-display-name-mobile'),
                usernameField: document.getElementById('username-field'),
                allianceField: document.getElementById('alliance-field'),
                confirmPasswordField: document.getElementById('confirm-password-field'),
                title: document.getElementById('auth-title'),
                submitBtn: document.getElementById('auth-submit-btn'),
                toggleText: document.getElementById('auth-toggle-text'),
                toggleBtn: document.getElementById('auth-toggle-btn'),
                error: document.getElementById('auth-error')
            },
            profile: {
                modal: document.getElementById('profile-modal'),
                form: document.getElementById('profile-form'),
                avatarPreview: document.getElementById('profile-avatar-preview'),
                avatarUpload: document.getElementById('avatar-upload'),
                avatarUploadBtn: document.getElementById('avatar-upload-btn'),
                usernameInput: document.getElementById('profile-username'),
                allianceSelect: document.getElementById('profile-alliance-select'),
                error: document.getElementById('profile-error'),
                saveBtn: document.getElementById('profile-save-btn'),
                logoutBtn: document.getElementById('logout-btn-profile')
            },
            leaderboard: {
                loginPrompt: document.getElementById('leaderboard-login-prompt'),
                loginBtn: document.getElementById('leaderboard-login-btn'),
                playerListContainer: document.getElementById('player-list-container')
            },
            nav: {
                links: document.querySelectorAll('.nav-link'),
                hamburgerBtn: document.getElementById('hamburger-btn'),
                mobileMenu: document.getElementById('mobile-menu'),
                closeMenuBtn: document.getElementById('close-menu-btn'),
                menuOverlay: document.getElementById('menu-overlay'),
                desktopMenu: document.getElementById('desktop-menu'),
            },
            language: {
                modal: document.getElementById('language-modal'),
                openBtn: document.getElementById('language-modal-btn'),
                openBtnMobile: document.getElementById('language-modal-btn-mobile'),
                closeBtn: document.getElementById('close-language-modal-btn'),
                optionsContainer: document.getElementById('language-options-container')
            },
            pages: {
                calculator: document.getElementById('calculator-page'),
                leaderboard: document.getElementById('leaderboard-page'),
                information: document.getElementById('information-page')
            }
        };

        const state = {
            hourlyProduction: 0,
            fountainLevels: [0,0,0,0,0],
            fountain5Enabled: false,
            currentWater: 0,
            targetLabLevel: 1,
            alliance: 'none',
            updatedAt: null
        };
        
        const translations = {
            en: {
                page_title: "Cursed Lab Calculator", nav_calculator: "Calculator", nav_leaderboard: "Leaderboard", nav_information: "Information", nav_language: "Language",
                auth_login_title: "Login", auth_register_title: "Create Account", auth_username: "Username", auth_email: "Email Address", auth_password: "Password", auth_confirm_password: "Confirm Password", auth_login_btn: "Login", auth_register_btn: "Register", auth_no_account: "Don't have an account?", auth_have_account: "Already have an account?", auth_register_link: "Register", auth_login_link: "Login", auth_login_btn_short: "Login", auth_logout_btn: "Logout", auth_alliance: "Alliance", auth_alliance_none: "None",
                profile_title: "Edit Profile", profile_change_avatar: "Change Avatar", profile_save_btn: "Save Changes", profile_success: "Profile updated successfully!",
                language_modal_title: "Select Language",
                calc_fountains_title: "Blessed Fountains", calc_fountain_1: "Fountain 1", calc_fountain_2: "Fountain 2", calc_fountain_3: "Fountain 3", calc_fountain_4: "Fountain 4", calc_fountain_5_toggle: "Enable 5th Fountain", calc_total_water: "Total Water / Hour",
                calc_lab_title: "Cursed Lab Upgrade", calc_current_water: "Current Sacred Water", calc_target_level: "Target Lab Level", calc_completion_time: "Upgrade Completion Time",
                leaderboard_title: "Resistance Development Leaderboard", leaderboard_subtitle: "See how you stack up against other players.", leaderboard_login_prompt_1: "Please", leaderboard_login_prompt_2: "log in", leaderboard_login_prompt_3: "to join the leaderboard.",
                leaderboard_card_next_level: "Next Level", leaderboard_card_lab_level: "Lab Level", leaderboard_card_resistance: "Resistance", leaderboard_card_water_hr: "Water/hr",
                info_title: "Information", 
                info_p1: "This tool is designed to help you plan your resource management for the Cursed Lab and Blessed Fountains. Optimize your upgrades, see how you compare to others, and save your progress.",
                info_h_calc: "Calculator Page",
                info_li_calc1: "Blessed Fountains: Select the current level for each of your four primary fountains. If you have unlocked the fifth, use the toggle to enable it and set its level.",
                info_li_calc2: "Total Production: The calculator will instantly show your total Sacred Water production per hour based on your fountain levels.",
                info_li_calc3: "Lab Upgrade: Enter your current amount of Sacred Water and select the Cursed Lab level you are aiming for.",
                info_li_calc4: "Completion Time: The tool will calculate the exact date and time you will have enough resources for the selected lab upgrade.",
                info_h_leaderboard: "Leaderboard",
                info_p_leaderboard: "Log in to join the Leaderboard. Once logged in, your data will automatically sync to the leaderboard as you make changes in the calculator, allowing you to see how your progress and production rate compare to other players in real-time.",
                info_h_save: "Saving Your Data",
                info_p_save: "Creating an account and logging in automatically saves your data (fountain levels, current resources) to our database. The next time you visit, all your information will be pre-filled, so you can continue your planning without missing a beat.",
                time_ready: "Ready!", time_no_prod: "No Production", toast_data_synced: "Leaderboard synced!",
            },
             es: {
                page_title: "Calculadora de Laboratorio Maldito", nav_calculator: "Calculadora", nav_leaderboard: "Clasificación", nav_information: "Información", nav_language: "Idioma",
                auth_login_title: "Iniciar Sesión", auth_register_title: "Crear Cuenta", auth_username: "Usuario", auth_email: "Correo Electrónico", auth_password: "Contraseña", auth_confirm_password: "Confirmar Contraseña", auth_login_btn: "Iniciar Sesión", auth_register_btn: "Registrarse", auth_no_account: "¿No tienes una cuenta?", auth_have_account: "¿Ya tienes una cuenta?", auth_register_link: "Regístrate", auth_login_link: "Inicia Sesión", auth_login_btn_short: "Login", auth_logout_btn: "Salir", auth_alliance: "Alianza", auth_alliance_none: "Ninguna",
                profile_title: "Editar Perfil", profile_change_avatar: "Cambiar Avatar", profile_save_btn: "Guardar Cambios", profile_success: "¡Perfil actualizado con éxito!",
                language_modal_title: "Seleccionar Idioma",
                calc_fountains_title: "Fuentes Benditas", calc_fountain_1: "Fuente 1", calc_fountain_2: "Fuente 2", calc_fountain_3: "Fuente 3", calc_fountain_4: "Fuente 4", calc_fountain_5_toggle: "Habilitar 5ª Fuente", calc_total_water: "Agua Total / Hora",
                calc_lab_title: "Mejora de Laboratorio Maldito", calc_current_water: "Agua Sagrada Actual", calc_target_level: "Nivel de Laboratorio Deseado", calc_completion_time: "Tiempo de Finalización",
                leaderboard_title: "Clasificación de Desarrollo de Resistencia", leaderboard_subtitle: "Compara tu progreso con otros jugadores.", leaderboard_login_prompt_1: "Por favor", leaderboard_login_prompt_2: "inicia sesión", leaderboard_login_prompt_3: "para unirte.",
                leaderboard_card_next_level: "Siguiente Nivel", leaderboard_card_lab_level: "Nivel Lab", leaderboard_card_resistance: "Resistencia", leaderboard_card_water_hr: "Agua/h",
                info_title: "Información",
                info_p1: "Esta herramienta está diseñada para ayudarte a planificar la gestión de tus recursos y mejoras de edificios de manera efectiva.",
                info_h_calc: "Página de la Calculadora",
                info_li_calc1: "Fuentes Benditas: Selecciona el nivel actual para cada una de tus cuatro fuentes principales. Si has desbloqueado la quinta, usa el interruptor para habilitarla y establecer su nivel.",
                info_li_calc2: "Producción Total: La calculadora mostrará instantáneamente tu producción total de Agua Sagrada por hora según los niveles de tus fuentes.",
                info_li_calc3: "Mejora de Laboratorio: Ingresa tu cantidad actual de Agua Sagrada y selecciona el nivel de Laboratorio Maldito que deseas alcanzar.",
                info_li_calc4: "Tiempo de Finalización: La herramienta calculará la fecha y hora exactas en que tendrás suficientes recursos para la mejora de laboratorio seleccionada.",
                info_h_leaderboard: "Clasificación",
                info_p_leaderboard: "Inicia sesión para unirte a la tabla de clasificación. Una vez que hayas iniciado sesión, tus datos se sincronizarán automáticamente con la tabla de clasificación a medida que realices cambios en la calculadora, lo que te permitirá ver cómo se compara tu progreso y tu tasa de producción con otros jugadores en tiempo real.",
                info_h_save: "Guardando Tus Datos",
                info_p_save: "Al crear una cuenta e iniciar sesión, tus datos (niveles de fuente, recursos actuales) se guardan automáticamente en nuestra base de datos. La próxima vez que visites, toda tu información estará pre-cargada, para que puedas continuar tu planificación sin perder el ritmo.",
                time_ready: "¡Listo!", time_no_prod: "Sin Producción", toast_data_synced: "¡Clasificación sincronizada!",
            },
        };

        const supportedLangs = { en: "English", es: "Español" };

        function showToast(messageKey, type = 'success') {
            const lang = localStorage.getItem('language') || 'en';
            const message = translations[lang][messageKey] || 'Success!';
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas fa-check-circle mr-3"></i> ${message}`;
            dom.toastContainer.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        function setLanguage(lang) {
            const langCode = translations[lang] ? lang : 'en';
            document.querySelectorAll('[data-i18n-key]').forEach(el => {
                const key = el.getAttribute('data-i18n-key');
                if (translations[langCode] && translations[langCode][key]) {
                    el.textContent = translations[langCode][key];
                }
            });
            localStorage.setItem('language', langCode);
            runCalculations();
        }

        function initializeCurrentLanguage() {
            const savedLang = localStorage.getItem('language');
            const browserLang = navigator.language.split('-')[0];
            setLanguage(savedLang || (supportedLangs[browserLang] ? browserLang : 'en'));
        }
        
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        async function updatePublicLeaderboard() {
            if (!currentUserId || !auth.currentUser) return;
            if (dom.calculator.currentWater.value === '' || !state.targetLabLevel) {
                console.log("Sync skipped: missing required calculator data.");
                return;
            }
            const publicData = { 
                username: auth.currentUser.displayName, 
                avatarUrl: auth.currentUser.photoURL,
                alliance: state.alliance,
                calculatorData: state, 
                updatedAt: new Date() 
            };
            try {
                const publicUserDocRef = doc(db, `artifacts/${appId}/public/data/playerData/${currentUserId}`);
                await setDoc(publicUserDocRef, publicData, { merge: true });
                console.log("Leaderboard updated automatically.");
            } catch (error) { 
                console.error("Error writing public data automatically: ", error); 
            }
        }

        const debouncedUpdatePublicLeaderboard = debounce(updatePublicLeaderboard, 1500);

        function runCalculations(baseTime = Date.now()) {
            state.hourlyProduction = 0;
            for (let i = 0; i < 4; i++) {
                const level = parseInt(dom.fountainSelectors[i].value, 10);
                state.hourlyProduction += fountainProductionRates[level] || 0;
                state.fountainLevels[i] = level;
            }

            state.fountain5Enabled = dom.fifthFountain.toggle.checked;
            if (state.fountain5Enabled) {
                const level = parseInt(dom.fifthFountain.selector.value, 10);
                state.hourlyProduction += fountainProductionRates[level] || 0;
                state.fountainLevels[4] = level;
            } else {
                state.fountainLevels[4] = 0;
            }

            dom.calculator.totalOutput.textContent = state.hourlyProduction.toLocaleString();
            state.targetLabLevel = parseInt(dom.calculator.labLevel.value, 10);
            state.currentWater = parseInt(dom.calculator.currentWater.value, 10) || 0;
            
            const labCost = labUpgradeData[state.targetLabLevel]?.cost || 0;
            const waterNeeded = labCost - state.currentWater;

            const lang = localStorage.getItem('language') || 'en';
            if (waterNeeded <= 0) {
                dom.calculator.completionTime.textContent = translations[lang].time_ready;
                dom.calculator.completionTime.className = "text-3xl font-bold mt-1 text-green-400";
            } else if (state.hourlyProduction <= 0) {
                dom.calculator.completionTime.textContent = translations[lang].time_no_prod;
                dom.calculator.completionTime.className = "text-3xl font-bold mt-1 text-red-400";
            } else {
                const hoursNeeded = waterNeeded / state.hourlyProduction;
                const completionDate = new Date(baseTime + hoursNeeded * 3600000);
                dom.calculator.completionTime.textContent = completionDate.toLocaleString(lang, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                dom.calculator.completionTime.className = "text-3xl font-bold mt-1 text-teal-300";
            }
        }
        
        async function savePrivateDataSilently() {
            if (!currentUserId || !db) return;
            state.updatedAt = new Date();
            try {
                const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}`);
                await setDoc(userDocRef, state, { merge: true });
            } catch (error) { console.error("Error saving data silently: ", error); }
        }

        async function loadDataFromFirestore() {
            if (!currentUserId || !db) return;
            const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}`);
            const docSnap = await getDoc(userDocRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                Object.assign(state, data); // Load all data into state
                
                if(data.fountainLevels) {
                    dom.fountainSelectors.forEach((sel, i) => { if(data.fountainLevels[i] !== undefined) sel.value = data.fountainLevels[i]; });
                }
                if(data.fountain5Enabled !== undefined) {
                    dom.fifthFountain.toggle.checked = data.fountain5Enabled;
                    dom.fifthFountain.selector.disabled = !data.fountain5Enabled;
                    dom.fifthFountain.selector.style.opacity = data.fountain5Enabled ? 1 : 0.5;
                    if (data.fountainLevels && data.fountainLevels[4] !== undefined) {
                         dom.fifthFountain.selector.value = data.fountainLevels[4];
                    }
                }
                if(data.currentWater !== undefined) dom.calculator.currentWater.value = data.currentWater;
                if(data.targetLabLevel !== undefined) dom.calculator.labLevel.value = data.targetLabLevel;
                
                const lastUpdateTime = data.updatedAt?.toDate()?.getTime() || Date.now();
                runCalculations(lastUpdateTime);
            }
        }
        
        function calculateCompletionDate(player) {
            const data = player.calculatorData;
            if (!data) return null;

            const targetLabLevel = data.targetLabLevel || 0;
            const labCost = labUpgradeData[targetLabLevel]?.cost || 0;
            const hourlyProduction = data.hourlyProduction || 0;
            const lastUpdateWater = data.currentWater || 0;
            const lastUpdateTime = player.updatedAt?.toDate();

            if (!lastUpdateTime) return null;

            const waterNeeded = labCost - lastUpdateWater;

            if (waterNeeded <= 0) {
                return new Date(lastUpdateTime.getTime());
            }
            
            if (hourlyProduction <= 0) {
                return null; // Represents infinity
            }

            const hoursNeeded = waterNeeded / hourlyProduction;
            const completionTimestamp = lastUpdateTime.getTime() + hoursNeeded * 3600000;
            
            return new Date(completionTimestamp);
        }

        function listenForPublicPlayerData() {
            if (!db) return;
            const q = query(collection(db, `artifacts/${appId}/public/data/playerData`));
            onSnapshot(q, (querySnapshot) => {
                const players = [];
                querySnapshot.forEach((doc) => players.push(doc.data()));
                
                players.sort((a, b) => {
                    const dataA = a.calculatorData || {};
                    const dataB = b.calculatorData || {};
                    const labLevelA = dataA.targetLabLevel || 0;
                    const labLevelB = dataB.targetLabLevel || 0;
                    if (labLevelB !== labLevelA) return labLevelB - labLevelA;
                    const completionDateA = calculateCompletionDate(a);
                    const completionDateB = calculateCompletionDate(b);
                    if (!completionDateA && completionDateB) return 1;
                    if (completionDateA && !completionDateB) return -1;
                    if (!completionDateA && !completionDateB) return 0;
                    return completionDateA.getTime() - completionDateB.getTime();
                });

                dom.leaderboard.playerListContainer.innerHTML = '';
                if (players.length === 0) {
                    dom.leaderboard.playerListContainer.innerHTML = `<p class="text-center text-slate-400 col-span-full py-8" data-i18n-key="leaderboard_no_players">No players yet. Be the first!</p>`;
                    setLanguage(localStorage.getItem('language') || 'en');
                    return;
                }
                
                const lang = localStorage.getItem('language') || 'en';
                players.forEach((player, index) => {
                    const data = player.calculatorData || {};
                    let completionTimeText = '--';
                    let completionTimeClass = 'text-slate-300';
                    const completionDate = calculateCompletionDate(player);

                    if (completionDate) {
                        if (completionDate.getTime() <= Date.now()) {
                            completionTimeText = translations[lang].time_ready;
                            completionTimeClass = 'text-green-400';
                        } else {
                            completionTimeText = completionDate.toLocaleString(lang, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                            completionTimeClass = 'text-teal-300';
                        }
                    } else {
                        completionTimeText = translations[lang].time_no_prod;
                        completionTimeClass = 'text-red-400';
                    }

                    const fountains = data.fountainLevels || [0,0,0,0,0];
                    const f5OpacityClass = data.fountain5Enabled ? '' : 'opacity-50';
                    const avatarUrl = player.avatarUrl || 'https://placehold.co/150x150/1f2937/9ca3af?text=N/A';
                    const allianceName = player.alliance && player.alliance !== 'none' ? player.alliance : 'No Alliance';

                    const card = `
                        <div class="player-card rounded-lg flex">
                            <div class="rank flex items-center justify-center w-16 shrink-0 rounded-l-lg">
                                <p class="text-3xl font-bold text-white">#${index + 1}</p>
                            </div>
                            <div class="p-3 py-2 flex-grow">
                                <div class="flex items-start justify-between gap-3">
                                    <div class="flex items-center gap-3">
                                        <img src="${avatarUrl}" class="w-12 h-12 rounded-full object-cover border-2 border-slate-600">
                                        <div>
                                            <p class="font-bold text-lg text-white truncate">${player.username || 'Anonymous'}</p>
                                            <p class="text-xs text-violet-300 -mt-1">${allianceName}</p>
                                        </div>
                                    </div>
                                    <div class="text-right shrink-0">
                                        <p class="text-xs text-slate-400" data-i18n-key="leaderboard_card_next_level">Next Level</p>
                                        <p class="font-semibold text-base ${completionTimeClass}">${completionTimeText}</p>
                                    </div>
                                </div>
                                <div class="border-t mt-2 border-slate-700/50 pt-2 grid grid-cols-3 gap-2 text-center">
                                    <div>
                                        <p class="text-xs text-slate-400" data-i18n-key="leaderboard_card_lab_level">Lab Level</p>
                                        <p class="font-bold text-2xl text-white">${data.targetLabLevel || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-slate-400" data-i18n-key="leaderboard_card_resistance">Resistance</p>
                                        <p class="font-bold text-2xl text-violet-300">${(labUpgradeData[data.targetLabLevel]?.res || 0).toLocaleString()}</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-slate-400" data-i18n-key="leaderboard_card_water_hr">Water/hr</p>
                                        <p class="font-bold text-2xl text-sky-400">${(data.hourlyProduction || 0).toLocaleString()}</p>
                                    </div>
                                </div>
                                <div class="mt-2 grid grid-cols-5 gap-2 text-center text-xs bg-slate-900/50 p-1.5 rounded-md flex-grow">
                                    <div><p class="text-slate-400">F1</p><p class="font-bold text-white text-base">${fountains[0]}</p></div>
                                    <div><p class="text-slate-400">F2</p><p class="font-bold text-white text-base">${fountains[1]}</p></div>
                                    <div><p class="text-slate-400">F3</p><p class="font-bold text-white text-base">${fountains[2]}</p></div>
                                    <div><p class="text-slate-400">F4</p><p class="font-bold text-white text-base">${fountains[3]}</p></div>
                                    <div class="${f5OpacityClass}"><p class="text-slate-400">F5</p><p class="font-bold text-white text-base">${data.fountain5Enabled ? fountains[4] : '—'}</p></div>
                                </div>
                            </div>
                        </div>
                    `;
                    dom.leaderboard.playerListContainer.innerHTML += card;
                });
                setLanguage(lang);
            });
        }

        function updateUIForAuthState(user) {
            const defaultAvatar = 'https://placehold.co/150x150/1f2937/9ca3af?text=Avatar';
            if (user) {
                const avatarUrl = user.photoURL || defaultAvatar;
                // Desktop
                dom.auth.loginBtn.classList.add('hidden');
                dom.auth.userInfo.classList.remove('hidden');
                dom.auth.userInfo.classList.add('flex');
                dom.auth.userAvatar.src = avatarUrl;
                dom.auth.userDisplayName.textContent = user.displayName || user.email;
                // Mobile
                dom.auth.loginBtnMobile.classList.add('hidden');
                dom.auth.userInfoMobile.classList.remove('hidden');
                dom.auth.userInfoMobile.classList.add('flex');
                dom.auth.userAvatarMobile.src = avatarUrl;
                dom.auth.userDisplayNameMobile.textContent = user.displayName || user.email;

                dom.leaderboard.loginPrompt.classList.add('hidden');
            } else {
                // Desktop
                dom.auth.loginBtn.classList.remove('hidden');
                dom.auth.userInfo.classList.add('hidden');
                dom.auth.userAvatar.src = defaultAvatar;
                // Mobile
                dom.auth.loginBtnMobile.classList.remove('hidden');
                dom.auth.userInfoMobile.classList.add('hidden');
                dom.auth.userAvatarMobile.src = defaultAvatar;

                dom.leaderboard.loginPrompt.classList.remove('hidden');
            }
        }
        
        function handleInputChange() {
            runCalculations();
            if (currentUserId) {
                savePrivateDataSilently();
                debouncedUpdatePublicLeaderboard();
            }
        }
        
        // --- Profile Edit Functions ---
        function openProfileModal() {
            if (!auth.currentUser) return;
            const user = auth.currentUser;
            dom.profile.usernameInput.value = user.displayName || '';
            dom.profile.avatarPreview.src = user.photoURL || 'https://placehold.co/150x150/1f2937/9ca3af?text=Avatar';
            dom.profile.allianceSelect.value = state.alliance || 'none';
            dom.profile.error.textContent = '';
            dom.profile.modal.classList.remove('hidden');
        }

        // Image resize function
        function resizeImage(file, width, height, callback) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    callback(canvas.toDataURL('image/jpeg')); // Get base64 string
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // --- Language Modal Functions ---
        function openLanguageModal() {
            dom.language.optionsContainer.innerHTML = ''; // Clear previous options
            Object.entries(supportedLangs).forEach(([code, name]) => {
                const button = document.createElement('button');
                button.textContent = name;
                button.className = 'w-full px-4 py-3 bg-slate-700 hover:bg-slate-600 rounded-md font-semibold text-white transition-colors';
                button.onclick = () => {
                    setLanguage(code);
                    closeLanguageModal();
                };
                dom.language.optionsContainer.appendChild(button);
            });
            dom.language.modal.classList.remove('hidden');
        }

        function closeLanguageModal() {
            dom.language.modal.classList.add('hidden');
        }


        document.addEventListener('DOMContentLoaded', () => {
            let fountainOptions = ''; for (let i = 0; i <= 30; i++) fountainOptions += `<option value="${i}">Level ${i}</option>`;
            dom.fountainSelectors.forEach(sel => sel.innerHTML = fountainOptions);
            let labOptions = ''; for (let i = 1; i <= 30; i++) labOptions += `<option value="${i}">Level ${i}</option>`;
            dom.calculator.labLevel.innerHTML = labOptions;

            const allInputs = [...dom.fountainSelectors, dom.calculator.currentWater, dom.calculator.labLevel, dom.fifthFountain.toggle];
            allInputs.forEach(input => {
                input.addEventListener('change', handleInputChange);
                if (input.type === 'number') input.addEventListener('keyup', handleInputChange);
            });
            
            const closeMobileMenu = () => {
                dom.nav.mobileMenu.classList.remove('open');
                dom.nav.menuOverlay.classList.add('hidden');
                dom.nav.menuOverlay.style.opacity = 0;
            };

            const navLinks = [...document.querySelectorAll('.nav-link')];
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    const pageId = e.currentTarget.getAttribute('data-page');
                    if (!pageId) return; // Don't do anything for non-page links like Language
                    e.preventDefault();
                    navLinks.forEach(l => {
                        if (l.getAttribute('data-page')) l.classList.remove('active');
                    });
                    document.querySelectorAll(`.nav-link[data-page='${pageId}']`).forEach(l => l.classList.add('active'));
                    Object.values(dom.pages).forEach(page => page.classList.add('hidden'));
                    dom.pages[pageId].classList.remove('hidden');
                    closeMobileMenu();
                });
            });

            dom.nav.hamburgerBtn.addEventListener('click', () => {
                dom.nav.mobileMenu.classList.add('open');
                dom.nav.menuOverlay.classList.remove('hidden');
                setTimeout(() => dom.nav.menuOverlay.style.opacity = 1, 10);
            });

            dom.nav.closeMenuBtn.addEventListener('click', closeMobileMenu);
            dom.nav.menuOverlay.addEventListener('click', closeMobileMenu);

            let isRegisterMode = false;
            function toggleAuthMode() {
                isRegisterMode = !isRegisterMode;
                dom.auth.form.reset();
                dom.auth.error.textContent = '';
                dom.auth.usernameField.classList.toggle('hidden', !isRegisterMode);
                dom.auth.allianceField.classList.toggle('hidden', !isRegisterMode);
                document.getElementById('username').required = isRegisterMode;
                dom.auth.confirmPasswordField.classList.toggle('hidden', !isRegisterMode);
                document.getElementById('confirm-password').required = isRegisterMode;
                const lang = localStorage.getItem('language') || 'en';
                dom.auth.title.textContent = translations[lang][isRegisterMode ? 'auth_register_title' : 'auth_login_title'];
                dom.auth.submitBtn.textContent = translations[lang][isRegisterMode ? 'auth_register_btn' : 'auth_login_btn'];
                dom.auth.toggleText.textContent = translations[lang][isRegisterMode ? 'auth_have_account' : 'auth_no_account'];
                dom.auth.toggleBtn.textContent = translations[lang][isRegisterMode ? 'auth_login_link' : 'auth_register_link'];
            }
            
            const openAuthModal = () => {
                closeMobileMenu();
                dom.auth.modal.classList.remove('hidden');
            };
            dom.auth.loginBtn.addEventListener('click', openAuthModal);
            dom.auth.loginBtnMobile.addEventListener('click', openAuthModal);
            dom.leaderboard.loginBtn.addEventListener('click', openAuthModal);

            const handleLogout = () => {
                signOut(auth);
                dom.profile.modal.classList.add('hidden'); // Close profile modal on logout
            };
            dom.profile.logoutBtn.addEventListener('click', handleLogout);
            
            dom.auth.modal.addEventListener('click', (e) => { if(e.target === dom.auth.modal) dom.auth.modal.classList.add('hidden'); });
            dom.auth.toggleBtn.addEventListener('click', toggleAuthMode);

            dom.auth.form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const pass = document.getElementById('password').value;
                dom.auth.error.textContent = '';
                if (isRegisterMode) {
                    const username = document.getElementById('username').value;
                    const alliance = document.getElementById('alliance-select').value;
                    const confirmPass = document.getElementById('confirm-password').value;
                    if (pass !== confirmPass) { dom.auth.error.textContent = 'Passwords do not match.'; return; }
                    if (username.length < 3) { dom.auth.error.textContent = 'Username must be at least 3 characters.'; return; }
                    try {
                        const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
                        await updateProfile(userCredential.user, { displayName: username });
                        const userData = { username: username, email: email, alliance: alliance, createdAt: new Date() };
                        await setDoc(doc(db, `artifacts/${appId}/users/${userCredential.user.uid}`), userData);
                        dom.auth.modal.classList.add('hidden');
                    } catch (error) { dom.auth.error.textContent = error.message.replace('Firebase: ', ''); }
                } else {
                    try {
                        await signInWithEmailAndPassword(auth, email, pass);
                        dom.auth.modal.classList.add('hidden');
                    } catch (error) { dom.auth.error.textContent = error.message.replace('Firebase: ', ''); }
                }
            });
            
            // Profile Modal Listeners
            dom.auth.userAvatar.addEventListener('click', openProfileModal);
            dom.auth.userAvatarMobile.addEventListener('click', openProfileModal);
            dom.profile.modal.addEventListener('click', (e) => { if(e.target === dom.profile.modal) dom.profile.modal.classList.add('hidden'); });
            dom.profile.avatarUploadBtn.addEventListener('click', () => dom.profile.avatarUpload.click());
            dom.profile.avatarUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    resizeImage(file, 150, 150, (dataUrl) => {
                        dom.profile.avatarPreview.src = dataUrl;
                    });
                }
            });

            dom.profile.form.addEventListener('submit', async (e) => {
                e.preventDefault();
                dom.profile.saveBtn.disabled = true;
                dom.profile.error.textContent = '';
                const user = auth.currentUser;
                if (!user) return;

                const newUsername = dom.profile.usernameInput.value;
                const newAlliance = dom.profile.allianceSelect.value;
                let newAvatarUrl = user.photoURL;

                try {
                    // 1. Upload avatar if it has changed
                    const avatarPreviewSrc = dom.profile.avatarPreview.src;
                    if (avatarPreviewSrc && !avatarPreviewSrc.startsWith('https')) { // It's a base64 string
                        const storageRef = ref(storage, `avatars/${user.uid}/avatar.jpg`);
                        const uploadResult = await uploadString(storageRef, avatarPreviewSrc, 'data_url');
                        newAvatarUrl = await getDownloadURL(uploadResult.ref);
                    }
                    
                    // 2. Update Auth Profile
                    await updateProfile(user, {
                        displayName: newUsername,
                        photoURL: newAvatarUrl
                    });

                    // 3. Update Firestore Documents
                    const privateDocRef = doc(db, `artifacts/${appId}/users/${user.uid}`);
                    await updateDoc(privateDocRef, {
                        username: newUsername,
                        alliance: newAlliance,
                        avatarUrl: newAvatarUrl
                    });
                    
                    const publicDocRef = doc(db, `artifacts/${appId}/public/data/playerData/${user.uid}`);
                    await updateDoc(publicDocRef, {
                        username: newUsername,
                        alliance: newAlliance,
                        avatarUrl: newAvatarUrl
                    });

                    state.alliance = newAlliance; // Update local state
                    showToast('profile_success');
                    dom.profile.modal.classList.add('hidden');

                } catch (error) {
                    console.error("Profile update error:", error);
                    dom.profile.error.textContent = error.message.replace('Firebase: ', '');
                } finally {
                    dom.profile.saveBtn.disabled = false;
                }
            });

            // Language Modal Listeners
            dom.language.openBtn.addEventListener('click', openLanguageModal);
            dom.language.openBtnMobile.addEventListener('click', (e) => {
                e.preventDefault();
                closeMobileMenu();
                openLanguageModal();
            });
            dom.language.closeBtn.addEventListener('click', closeLanguageModal);
            dom.language.modal.addEventListener('click', (e) => { if (e.target === dom.language.modal) closeLanguageModal(); });

            initializeCurrentLanguage();
            runCalculations();
            if(!currentUserId) listenForPublicPlayerData(); // Initial load for non-logged in users
        });
    </script>
</body>
</html>
