<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
    <title data-i18n-key="page_title">Cursed Lab Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --bg-primary: #111827; /* gray-900 */
            --bg-secondary: #1f2937; /* gray-800 */
            --bg-tertiary: #374151; /* gray-700 */
            --border-color: #6b7280; /* gray-500 */
            --text-primary: #f3f4f6; /* gray-100 */
            --text-secondary: #9ca3af; /* gray-400 */
            --accent-primary: #8b5cf6; /* violet-500 */
            --accent-secondary: #ec4899; /* pink-500 */
            --success-color: #22c55e; /* green-500 */
        }
        html {
            font-size: 80%;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            background-image: radial-gradient(circle at 5% 5%, rgba(139, 92, 246, 0.08) 0%, transparent 30%),
                              radial-gradient(circle at 95% 95%, rgba(236, 72, 153, 0.08) 0%, transparent 30%);
            background-attachment: fixed;
        }
        .fade-in-up { animation: fadeInUp 0.5s ease-in-out forwards; opacity: 0; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .main-card {
            background: linear-gradient(145deg, rgba(31, 41, 55, 0.5), rgba(17, 24, 39, 0.5));
            border: 1px solid var(--border-color);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            box-shadow: 0 4px 25px rgba(0,0,0,0.3);
        }
        .sub-card {
            background-color: rgba(55, 65, 81, 0.25);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        .sub-card:hover {
            border-color: var(--accent-primary);
        }
        .glass-input, .glass-select {
             background-color: rgba(17, 24, 39, 0.6);
             border: 1px solid var(--border-color);
             transition: all 0.3s ease;
             color: var(--text-primary);
             padding: 0.75rem 1rem;
             font-size: 1rem;
        }
        .glass-input:focus, .glass-select:focus {
             border-color: var(--accent-primary);
             box-shadow: 0 0 10px rgba(139, 92, 246, 0.2);
             outline: none;
        }
        .nav-link {
            position: relative;
            transition: color 0.3s ease;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
        }
        .nav-link.active { 
            color: white; 
            background: rgba(255,255,255,0.1);
        }
        .nav-link:hover {
             background: rgba(255,255,255,0.05);
        }
        .hidden { display: none; }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        .btn-primary {
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }
        
        #toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        html[dir="rtl"] #toast-container {
            right: auto;
            left: 1rem;
        }
        .toast {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.1);
            animation: slideInRight 0.5s forwards, fadeOut 0.5s 3.5s forwards;
        }
        html[dir="rtl"] .toast {
            animation-name: slideInLeft;
        }
        .toast.success {
            background: linear-gradient(90deg, var(--success-color), #16a34a);
        }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideInLeft { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; transform: translateY(-20px); } }
        
        .player-card {
            background: linear-gradient(145deg, rgba(31, 41, 55, 0.4), rgba(17, 24, 39, 0.4));
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        .player-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
        }
        .player-card .rank {
            background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary));
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        #mobile-menu {
            transition: transform 0.3s ease-in-out;
            transform: translateX(100%);
        }
        html[dir="rtl"] #mobile-menu {
            transform: translateX(-100%);
        }
        #mobile-menu.open {
            transform: translateX(0);
        }
        #menu-overlay {
            transition: opacity 0.3s ease-in-out;
        }
        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid var(--accent-primary);
            object-fit: cover;
        }
    </style>
</head>
<body class="text-slate-200">

    <div id="toast-container"></div>
    <div id="menu-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-40 hidden"></div>

    <!-- Auth Modal -->
    <div id="auth-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden p-4">
        <div class="main-card rounded-xl w-full max-w-sm p-6 space-y-4">
            <h2 id="auth-title" class="text-2xl font-bold text-center text-white" data-i18n-key="auth_login_title">Login</h2>
            <form id="auth-form" class="space-y-3">
                <div id="username-field" class="hidden">
                    <label for="username" class="text-xs font-medium text-slate-300" data-i18n-key="auth_username">Username</label>
                    <input type="text" id="username" class="w-full glass-input rounded-md mt-1 focus:ring-0">
                </div>
                 <div id="alliance-field" class="hidden">
                    <label for="alliance-select" class="text-xs font-medium text-slate-300" data-i18n-key="auth_alliance">Alliance</label>
                    <select id="alliance-select" class="w-full glass-select rounded-md mt-1 focus:ring-0">
                        <option value="none" data-i18n-key="auth_alliance_none">None</option>
                        <option value="THOR">THOR</option>
                        <option value="fAfO">fAfO</option>
                        <option value="HeRa">HeRa</option>
                        <option value="pHNx">pHNx</option>
                        <option value="TroW">TroW</option>
                        <option value="VaLT">VaLT</option>
                        <option value="Tone">Tone</option>
                        <option value="COLD">COLD</option>
                        <option value="DoM">DoM</option>
                        <option value="MINI">MINI</option>
                        <option value="MEGA">MEGA</option>
                        <option value="Lat1">Lat1</option>
                    </select>
                </div>
                <div>
                    <label for="email" class="text-xs font-medium text-slate-300" data-i18n-key="auth_email">Email Address</label>
                    <input type="email" id="email" required class="w-full glass-input rounded-md mt-1 focus:ring-0">
                </div>
                <div>
                    <label for="password" class="text-xs font-medium text-slate-300" data-i18n-key="auth_password">Password</label>
                    <input type="password" id="password" required minlength="6" class="w-full glass-input rounded-md mt-1 focus:ring-0">
                </div>
                <div id="confirm-password-field" class="hidden">
                    <label for="confirm-password" class="text-xs font-medium text-slate-300" data-i18n-key="auth_confirm_password">Confirm Password</label>
                    <input type="password" id="confirm-password" class="w-full glass-input rounded-md mt-1 focus:ring-0">
                </div>
                <p id="auth-error" class="text-red-400 text-sm h-3"></p>
                <button type="submit" id="auth-submit-btn" class="w-full px-4 py-2 btn-primary rounded-md font-semibold text-white" data-i18n-key="auth_login_btn">Login</button>
            </form>
            <p class="text-center text-sm text-slate-400">
                <span id="auth-toggle-text" data-i18n-key="auth_no_account">Don't have an account?</span>
                <button id="auth-toggle-btn" class="font-semibold text-violet-400 hover:text-violet-300" data-i18n-key="auth_register_link">Register</button>
            </p>
        </div>
    </div>
    
    <!-- Profile Edit Modal -->
    <div id="profile-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden p-4">
        <div class="main-card rounded-xl w-full max-w-sm p-6 space-y-4">
            <h2 class="text-2xl font-bold text-center text-white" data-i18n-key="profile_title">Edit Profile</h2>
            <form id="profile-form" class="space-y-4">
                <div class="flex flex-col items-center space-y-2">
                    <img id="profile-avatar-preview" src="https://placehold.co/150x150/1f2937/9ca3af?text=Avatar" class="w-24 h-24 rounded-full object-cover border-2 border-violet-400">
                    <input type="file" id="avatar-upload" class="hidden" accept="image/*">
                    <button type="button" id="avatar-upload-btn" class="px-3 py-1 text-sm bg-slate-600 hover:bg-slate-500 rounded-md" data-i18n-key="profile_change_avatar">Change Avatar</button>
                </div>
                <div>
                    <label for="profile-username" class="text-xs font-medium text-slate-300" data-i18n-key="auth_username">Username</label>
                    <input type="text" id="profile-username" class="w-full glass-input rounded-md mt-1 focus:ring-0">
                </div>
                 <div>
                    <label for="profile-alliance-select" class="text-xs font-medium text-slate-300" data-i18n-key="auth_alliance">Alliance</label>
                    <select id="profile-alliance-select" class="w-full glass-select rounded-md mt-1 focus:ring-0">
                        <option value="none" data-i18n-key="auth_alliance_none">None</option>
                        <option value="THOR">THOR</option>
                        <option value="fAfO">fAfO</option>
                        <option value="HeRa">HeRa</option>
                        <option value="pHNx">pHNx</option>
                        <option value="TroW">TroW</option>
                        <option value="VaLT">VaLT</option>
                        <option value="Tone">Tone</option>
                        <option value="COLD">COLD</option>
                        <option value="DoM">DoM</option>
                        <option value="MINI">MINI</option>
                        <option value="MEGA">MEGA</option>
                        <option value="Lat1">Lat1</option>
                    </select>
                </div>
                <p id="profile-error" class="text-red-400 text-sm h-3"></p>
                <button type="submit" id="profile-save-btn" class="w-full px-4 py-2 btn-primary rounded-md font-semibold text-white" data-i18n-key="profile_save_btn">Save Changes</button>
            </form>
            <div class="border-t border-slate-700/50 pt-4">
                 <button id="logout-btn-profile" class="w-full px-4 py-2 bg-pink-600 hover:bg-pink-500 rounded-md font-semibold text-white transition-colors" data-i18n-key="auth_logout_btn">Logout</button>
            </div>
        </div>
    </div>

    <!-- Language Selection Modal -->
    <div id="language-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden p-4">
        <div class="main-card rounded-xl w-full max-w-md p-6 space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-white" data-i18n-key="language_modal_title">Select Language</h2>
                <button id="close-language-modal-btn" class="p-2 text-slate-300 hover:text-white"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div id="language-options-container" class="grid grid-cols-2 sm:grid-cols-3 gap-3 pt-2">
                <!-- Language buttons will be injected here by JS -->
            </div>
        </div>
    </div>


    <!-- Navigation Bar -->
    <nav class="main-card sticky top-0 md:top-2 z-30 w-full max-w-5xl mx-auto rounded-none md:rounded-xl shadow-lg border-x-0 border-t-0 md:border">
        <div class="flex items-center justify-between p-3">
            <div class="flex items-center gap-3">
                <i class="fas fa-virus text-violet-400 text-2xl"></i>
                <h1 class="text-xl font-bold text-white">CR-Calc</h1>
            </div>
            <div id="desktop-menu" class="hidden md:flex items-center gap-2">
                <a href="#" class="nav-link active text-sm" data-page="calculator" data-i18n-key="nav_calculator">Calculator</a>
                <a href="#" class="nav-link text-sm" data-page="leaderboard" data-i18n-key="nav_leaderboard">Leaderboard</a>
                <a href="#" class="nav-link text-sm" data-page="information" data-i18n-key="nav_information">Information</a>
                <a href="#" id="language-modal-btn" class="nav-link text-sm" data-i18n-key="nav_language">Language</a>
            </div>
            <div class="hidden md:flex items-center gap-2">
                <div id="auth-container">
                    <button id="login-btn" class="px-3 py-1.5 btn-primary rounded-md transition-colors text-sm font-semibold" data-i18n-key="auth_login_btn_short">Login</button>
                    <div id="user-info" class="hidden items-center gap-2" title="Edit Profile">
                         <img id="user-avatar" src="https://placehold.co/150x150/1f2937/9ca3af?text=Avatar" class="avatar w-8 h-8">
                        <span id="user-display-name" class="hidden sm:block text-sm font-semibold text-slate-300"></span>
                    </div>
                </div>
            </div>
            <button id="hamburger-btn" class="md:hidden p-2 rounded-md text-slate-300 hover:bg-slate-700 flex items-center gap-2">
                <span class="font-semibold text-sm">Menu</span>
                <i class="fas fa-bars fa-lg"></i>
            </button>
        </div>
    </nav>

    <!-- Mobile Menu Panel -->
    <div id="mobile-menu" class="fixed top-0 right-0 bottom-0 w-4/5 max-w-xs bg-gray-900/95 backdrop-blur-lg z-50 p-4 flex flex-col">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-lg font-bold text-white">Menu</h2>
            <button id="close-menu-btn" class="p-2 text-slate-300 hover:text-white"><i class="fas fa-times fa-lg"></i></button>
        </div>
        <div class="flex flex-col gap-2">
            <a href="#" class="nav-link active text-base" data-page="calculator" data-i18n-key="nav_calculator">Calculator</a>
            <a href="#" class="nav-link text-base" data-page="leaderboard" data-i18n-key="nav_leaderboard">Leaderboard</a>
            <a href="#" class="nav-link text-base" data-page="information" data-i18n-key="nav_information">Information</a>
            <a href="#" id="language-modal-btn-mobile" class="nav-link text-base" data-i18n-key="nav_language">Language</a>
        </div>
        <div class="mt-auto border-t border-slate-700 pt-4 flex flex-col items-center gap-3">
            <div id="auth-container-mobile" class="w-full">
                <button id="login-btn-mobile" class="w-full px-3 py-2 btn-primary rounded-md transition-colors text-sm font-semibold" data-i18n-key="auth_login_btn_short">Login</button>
                <div id="user-info-mobile" class="hidden items-center justify-between gap-2" title="Edit Profile">
                    <div class="flex items-center gap-2">
                        <img id="user-avatar-mobile" src="https://placehold.co/150x150/1f2937/9ca3af?text=Avatar" class="avatar w-8 h-8">
                        <span id="user-display-name-mobile" class="text-sm font-semibold text-slate-300 truncate"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content Area -->
    <main class="w-full max-w-5xl mx-auto my-4 px-4">
        <div id="page-content" class="fade-in-up">
            <!-- Calculator Page -->
            <div id="calculator-page" class="main-card rounded-xl p-4 md:p-6 space-y-4">
                 <div class="flex justify-center">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 w-full max-w-4xl">
                        <!-- Fountains Section -->
                        <section class="sub-card p-4 rounded-xl space-y-4">
                            <h2 class="text-lg font-semibold text-white flex items-center justify-center gap-2"><i class="fas fa-water text-sky-400 fa-fw"></i><span data-i18n-key="calc_fountains_title">Blessed Fountains</span></h2>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm font-medium text-slate-300 mb-1 block" data-i18n-key="calc_fountain_1">Fountain 1</label>
                                    <select id="fountain1" class="fountain-level w-full glass-select rounded-md"></select>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-slate-300 mb-1 block" data-i18n-key="calc_fountain_2">Fountain 2</label>
                                    <select id="fountain2" class="fountain-level w-full glass-select rounded-md"></select>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-slate-300 mb-1 block" data-i18n-key="calc_fountain_3">Fountain 3</label>
                                    <select id="fountain3" class="fountain-level w-full glass-select rounded-md"></select>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-slate-300 mb-1 block" data-i18n-key="calc_fountain_4">Fountain 4</label>
                                    <select id="fountain4" class="fountain-level w-full glass-select rounded-md"></select>
                                </div>
                            </div>
                            <div id="fountain5-wrapper" class="space-y-2 pt-2">
                                 <div class="flex items-center justify-between">
                                    <label class="text-sm text-slate-300" data-i18n-key="calc_fountain_5_toggle">Enable 5th Fountain</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="fountain5-toggle">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <select id="fountain5" class="fountain-level w-full glass-select rounded-md" disabled></select>
                            </div>
                            <div class="pt-2 text-center border-t border-slate-700/50">
                                 <h3 class="text-sm font-medium text-slate-400" data-i18n-key="calc_total_water">Total Water / Hour</h3>
                                 <p id="total-output" class="text-3xl font-bold mt-1 text-sky-300">0</p>
                            </div>
                        </section>
                        <!-- Lab Upgrade Section -->
                        <section class="sub-card p-4 rounded-xl space-y-4 flex flex-col">
                            <h2 class="text-lg font-semibold text-white flex items-center justify-center gap-2"><i class="fas fa-flask-vial text-teal-400 fa-fw"></i><span data-i18n-key="calc_lab_title">Cursed Lab Upgrade</span></h2>
                            <div class="flex-grow space-y-4">
                                <div>
                                    <label for="current-water" class="text-sm font-medium text-slate-300 mb-1 block flex items-center gap-2">
                                        <i class="fas fa-fill-drip fa-fw text-slate-400"></i>
                                        <span data-i18n-key="calc_current_water">Current Sacred Water</span>
                                    </label>
                                    <input type="number" id="current-water" class="w-full glass-input rounded-md" placeholder="e.g., 50000">
                                </div>
                                <div>
                                    <label for="lab-level" class="text-sm font-medium text-slate-300 mb-1 block flex items-center gap-2">
                                        <i class="fas fa-arrow-up-right-dots fa-fw text-slate-400"></i>
                                        <span data-i18n-key="calc_target_level">Target Lab Level</span>
                                    </label>
                                    <select id="lab-level" class="w-full glass-select rounded-md"></select>
                                </div>
                            </div>
                             <div class="pt-4 text-center border-t border-slate-700/50">
                                 <h3 class="text-sm font-medium text-slate-400" data-i18n-key="calc_completion_time">Upgrade Completion Time</h3>
                                 <p id="lab-completion-time" class="text-3xl font-bold mt-1 text-teal-300">--</p>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
            
            <!-- Leaderboard Page -->
            <div id="leaderboard-page" class="main-card rounded-xl p-4 md:p-6 space-y-4 hidden">
                <div class="flex justify-between items-center flex-wrap gap-3">
                    <div>
                        <h2 class="text-xl font-semibold text-white flex items-center gap-2"><i class="fas fa-shield-alt text-violet-400 fa-fw"></i><span data-i18n-key="leaderboard_title">Resistance Development Leaderboard</span></h2>
                        <p class="text-slate-400 mt-1 text-sm" data-i18n-key="leaderboard_subtitle">See how you stack up against other players.</p>
                    </div>
                    <!-- START: Alliance Filter -->
                    <div class="flex items-center gap-2">
                        <label for="alliance-filter" class="text-sm font-medium text-slate-300" data-i18n-key="auth_alliance">Alliance</label>
                        <select id="alliance-filter" class="glass-select rounded-md text-sm py-1 px-2">
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    <!-- END: Alliance Filter -->
                     <div id="leaderboard-login-prompt" class="sub-card p-3 rounded-xl text-center hidden">
                        <p class="text-slate-300 text-xs"><span data-i18n-key="leaderboard_login_prompt_1">Please</span> <button id="leaderboard-login-btn" class="font-bold text-sky-400 hover:underline" data-i18n-key="leaderboard_login_prompt_2">log in</button> <span data-i18n-key="leaderboard_login_prompt_3">to join the leaderboard.</span></p>
                    </div>
                </div>

                <!-- Player List -->
                <div id="player-list-container" class="flex flex-col gap-3">
                    <!-- Player list items will be injected here -->
                </div>
            </div>

            <!-- Information Page -->
            <div id="information-page" class="main-card rounded-xl p-4 md:p-6 space-y-4 hidden">
                <h2 class="text-xl font-semibold text-white flex items-center gap-2"><i class="fas fa-info-circle text-amber-400 fa-fw"></i><span data-i18n-key="info_title">Information</span></h2>
                <div class="prose prose-sm prose-invert max-w-none text-slate-300 space-y-3">
                    <p data-i18n-key="info_p1">This tool is designed to help you plan your resource management for the Cursed Lab and Blessed Fountains. Optimize your upgrades, see how you compare to others, and save your progress.</p>
                    
                    <h3 data-i18n-key="info_h_calc">Calculator Page</h3>
                    <ul class="list-disc list-inside space-y-1">
                        <li data-i18n-key="info_li_calc1"><b>Blessed Fountains:</b> Select the current level for each of your four primary fountains. If you have unlocked the fifth, use the toggle to enable it and set its level.</li>
                        <li data-i18n-key="info_li_calc2"><b>Total Production:</b> The calculator will instantly show your total Sacred Water production per hour based on your fountain levels.</li>
                        <li data-i18n-key="info_li_calc3"><b>Lab Upgrade:</b> Enter your current amount of Sacred Water and select the Cursed Lab level you are aiming for.</li>
                        <li data-i18n-key="info_li_calc4"><b>Completion Time:</b> The tool will calculate the exact date and time you will have enough resources for the selected lab upgrade.</li>
                    </ul>

                    <h3 data-i18n-key="info_h_leaderboard">Leaderboard</h3>
                    <p data-i18n-key="info_p_leaderboard">Log in to join the Leaderboard. Once logged in, your data will automatically sync to the leaderboard as you make changes in the calculator, allowing you to see how your progress and production rate compare to other players in real-time.</p>
                    
                    <h3 data-i18n-key="info_h_save">Saving Your Data</h3>
                    <p data-i18n-key="info_p_save">Creating an account and logging in automatically saves your data (fountain levels, current resources) to our database. The next time you visit, all your information will be pre-filled, so you can continue your planning without missing a beat.</p>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        /*
        Firebase v2 Security Rules:
        rules_version = '2';
        service cloud.firestore {
          match /databases/{database}/documents {
            // Private user data: Only the user can read/write their own data
            match /artifacts/{appId}/users/{userId} {
              allow read, write: if request.auth != null && request.auth.uid == userId;
            }
            // Public leaderboard data: Authenticated users can read all, but only write their own
            match /artifacts/{appId}/public/data/playerData/{userId} {
              // IMPORTANT: The rule below MUST be `allow read;` to let non-logged-in users see the leaderboard.
              allow read; 
              allow write: if request.auth != null && request.auth.uid == userId;
            }
          }
        }
        
        // ADDED: Firebase Storage Security Rules
        // service firebase.storage {
        //   match /b/{bucket}/o {
        //     // Avatars: Allow authenticated users to write to their own avatar path
        //     // Anyone can read avatars.
        //     match /avatars/{userId}/{fileName} {
        //       allow read;
        //       allow write: if request.auth != null && request.auth.uid == userId;
        //     }
        //   }
        // }
        */

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB-XKrs7nCZgq1XOg_ouOs6x6ZCkjrJsf4",
            authDomain: "thecursedlab-709f3.firebaseapp.com",
            projectId: "thecursedlab-709f3",
            storageBucket: "thecursedlab-709f3.firebasestorage.app",
            messagingSenderId: "751252568769",
            appId: "1:751252568769:web:22a928747cbf1b6aec3240",
            measurementId: "G-M0Y9LSM58J"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'thecursedlab-709f3';
        const fountainProductionRates = { 0: 0, 1: 720, 2: 1440, 3: 2160, 4: 2880, 5: 3600, 6: 4320, 7: 5040, 8: 5760, 9: 6480, 10: 7200, 11: 7920, 12: 8640, 13: 9360, 14: 10080, 15: 10800, 16: 11520, 17: 12240, 18: 12960, 19: 13600, 20: 14400, 21: 15120, 22: 15840, 23: 16560, 24: 17280, 25: 18000, 26: 18720, 27: 19440, 28: 20160, 29: 20880, 30: 21600 };
        const labUpgradeData = { 1:{cost:0,res:400}, 2:{cost:11200,res:200}, 3:{cost:22400,res:300}, 4:{cost:44800,res:400}, 5:{cost:89600,res:500}, 6:{cost:125400,res:750}, 7:{cost:163100,res:1000}, 8:{cost:195700,res:1250}, 9:{cost:234800,res:1500}, 10:{cost:281800,res:1750}, 11:{cost:338100,res:2000}, 12:{cost:405800,res:2250}, 13:{cost:486900,res:2500}, 14:{cost:584300,res:2750}, 15:{cost:701200,res:3000}, 16:{cost:771300,res:3400}, 17:{cost:848400,res:3800}, 18:{cost:933301,res:4200}, 19:{cost:1026600,res:4600}, 20:{cost:1129301,res:5000}, 21:{cost:1242200,res:5500}, 22:{cost:1366400,res:6000}, 23:{cost:1503000,res:6500}, 24:{cost:1653301,res:7000}, 25:{cost:1818701,res:7500}, 26:{cost:2159600,res:8000}, 27:{cost:2505101,res:8500}, 28:{cost:2855301,res:9000}, 29:{cost:3460600,res:9500}, 30:{cost:4321100,res:10000} };
        
        let app, auth, db, storage, currentUserId = null;
        let allPlayersData = []; // Holds all player data for filtering
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            storage = getStorage(app);
        } catch (e) { console.error("Firebase initialization failed:", e); }
        
        onAuthStateChanged(auth, user => {
            currentUserId = user ? user.uid : null;
            updateUIForAuthState(user);
            if (user) { 
                loadDataFromFirestore();
            }
        });

        const dom = {
            toastContainer: document.getElementById('toast-container'),
            fountainSelectors: document.querySelectorAll('.fountain-level'),
            fifthFountain: {
                toggle: document.getElementById('fountain5-toggle'),
                selector: document.getElementById('fountain5')
            },
            calculator: {
                totalOutput: document.getElementById('total-output'),
                currentWater: document.getElementById('current-water'),
                labLevel: document.getElementById('lab-level'),
                completionTime: document.getElementById('lab-completion-time')
            },
            auth: {
                modal: document.getElementById('auth-modal'),
                form: document.getElementById('auth-form'),
                loginBtn: document.getElementById('login-btn'),
                userInfo: document.getElementById('user-info'),
                userAvatar: document.getElementById('user-avatar'),
                userDisplayName: document.getElementById('user-display-name'),
                loginBtnMobile: document.getElementById('login-btn-mobile'),
                userInfoMobile: document.getElementById('user-info-mobile'),
                userAvatarMobile: document.getElementById('user-avatar-mobile'),
                userDisplayNameMobile: document.getElementById('user-display-name-mobile'),
                usernameField: document.getElementById('username-field'),
                allianceField: document.getElementById('alliance-field'),
                confirmPasswordField: document.getElementById('confirm-password-field'),
                title: document.getElementById('auth-title'),
                submitBtn: document.getElementById('auth-submit-btn'),
                toggleText: document.getElementById('auth-toggle-text'),
                toggleBtn: document.getElementById('auth-toggle-btn'),
                error: document.getElementById('auth-error')
            },
            profile: {
                modal: document.getElementById('profile-modal'),
                form: document.getElementById('profile-form'),
                avatarPreview: document.getElementById('profile-avatar-preview'),
                avatarUpload: document.getElementById('avatar-upload'),
                avatarUploadBtn: document.getElementById('avatar-upload-btn'),
                usernameInput: document.getElementById('profile-username'),
                allianceSelect: document.getElementById('profile-alliance-select'),
                error: document.getElementById('profile-error'),
                saveBtn: document.getElementById('profile-save-btn'),
                logoutBtn: document.getElementById('logout-btn-profile')
            },
            leaderboard: {
                loginPrompt: document.getElementById('leaderboard-login-prompt'),
                loginBtn: document.getElementById('leaderboard-login-btn'),
                playerListContainer: document.getElementById('player-list-container'),
                allianceFilter: document.getElementById('alliance-filter')
            },
            nav: {
                links: document.querySelectorAll('.nav-link'),
                hamburgerBtn: document.getElementById('hamburger-btn'),
                mobileMenu: document.getElementById('mobile-menu'),
                closeMenuBtn: document.getElementById('close-menu-btn'),
                menuOverlay: document.getElementById('menu-overlay'),
                desktopMenu: document.getElementById('desktop-menu'),
            },
            language: {
                modal: document.getElementById('language-modal'),
                openBtn: document.getElementById('language-modal-btn'),
                openBtnMobile: document.getElementById('language-modal-btn-mobile'),
                closeBtn: document.getElementById('close-language-modal-btn'),
                optionsContainer: document.getElementById('language-options-container')
            },
            pages: {
                calculator: document.getElementById('calculator-page'),
                leaderboard: document.getElementById('leaderboard-page'),
                information: document.getElementById('information-page')
            }
        };

        const state = {
            hourlyProduction: 0,
            fountainLevels: [0,0,0,0,0],
            fountain5Enabled: false,
            currentWater: 0,
            targetLabLevel: 1,
            alliance: 'none',
            updatedAt: null
        };
        
        const i18nData = {
            page_title: { en: "Cursed Lab Calculator", es: "Calculadora de Laboratorio Maldito", de: "Verfluchtes Labor Rechner", fr: "Calculateur de Laboratoire Maudit", pt: "Calculadora do Laboratório Amaldiçoado", ru: "Калькулятор Проклятой Лаборатории", ja: "呪われた研究室計算機", zh: "诅咒实验室计算器", hi: "शापित लैब कैलकुलेटर", ar: "حاسبة المختبر الملعون" },
            nav_calculator: { en: "Calculator", es: "Calculadora", de: "Rechner", fr: "Calculateur", pt: "Calculadora", ru: "Калькулятор", ja: "計算機", zh: "计算器", hi: "कैलकुलेटर", ar: "حاسبة" },
            nav_leaderboard: { en: "Leaderboard", es: "Clasificación", de: "Bestenliste", fr: "Classement", pt: "Quadro de Líderes", ru: "Таблица лидеров", ja: "リーダーボード", zh: "排行榜", hi: "लीडरबोर्ड", ar: "لوحة الصدارة" },
            nav_information: { en: "Information", es: "Información", de: "Informationen", fr: "Informations", pt: "Informações", ru: "Информация", ja: "情報", zh: "信息", hi: "जानकारी", ar: "معلومات" },
            nav_language: { en: "Language", es: "Idioma", de: "Sprache", fr: "Langue", pt: "Idioma", ru: "Язык", ja: "言語", zh: "语言", hi: "भाषा", ar: "لغة" },
            auth_login_title: { en: "Login", es: "Iniciar Sesión", de: "Anmelden", fr: "Connexion", pt: "Entrar", ru: "Вход", ja: "ログイン", zh: "登录", hi: "लॉग इन करें", ar: "تسجيل الدخول" },
            auth_register_title: { en: "Create Account", es: "Crear Cuenta", de: "Konto erstellen", fr: "Créer un compte", pt: "Criar Conta", ru: "Создать аккаунт", ja: "アカウントを作成", zh: "创建账户", hi: "खाता बनाएं", ar: "إنشاء حساب" },
            auth_username: { en: "Username", es: "Usuario", de: "Benutzername", fr: "Nom d'utilisateur", pt: "Nome de Usuário", ru: "Имя пользователя", ja: "ユーザー名", zh: "用户名", hi: "उपयोगकर्ता नाम", ar: "اسم المستخدم" },
            auth_email: { en: "Email Address", es: "Correo Electrónico", de: "E-Mail-Adresse", fr: "Adresse e-mail", pt: "Endereço de Email", ru: "Адрес электронной почты", ja: "メールアドレス", zh: "电子邮件地址", hi: "ईमेल पता", ar: "عنوان البريد الإلكتروني" },
            auth_password: { en: "Password", es: "Contraseña", de: "Passwort", fr: "Mot de passe", pt: "Senha", ru: "Пароль", ja: "パスワード", zh: "密码", hi: "पासवर्ड", ar: "كلمة المرور" },
            auth_confirm_password: { en: "Confirm Password", es: "Confirmar Contraseña", de: "Passwort bestätigen", fr: "Confirmez le mot de passe", pt: "Confirmar Senha", ru: "Подтвердите пароль", ja: "パスワードを確認", zh: "确认密码", hi: "पासवर्ड की पुष्टि कीजिये", ar: "تأكيد كلمة المرور" },
            auth_login_btn: { en: "Login", es: "Iniciar Sesión", de: "Anmelden", fr: "Connexion", pt: "Entrar", ru: "Войти", ja: "ログイン", zh: "登录", hi: "लॉग इन करें", ar: "تسجيل الدخول" },
            auth_register_btn: { en: "Register", es: "Registrarse", de: "Registrieren", fr: "S'inscrire", pt: "Registrar", ru: "Зарегистрироваться", ja: "登録", zh: "注册", hi: "पंजीकरण करवाना", ar: "تسجيل" },
            auth_no_account: { en: "Don't have an account?", es: "¿No tienes una cuenta?", de: "Kein Konto?", fr: "Pas de compte ?", pt: "Não tem uma conta?", ru: "Нет аккаунта?", ja: "アカウントがありませんか？", zh: "没有账户？", hi: "खाता नहीं है?", ar: "ليس لديك حساب؟" },
            auth_have_account: { en: "Already have an account?", es: "¿Ya tienes una cuenta?", de: "Bereits ein Konto?", fr: "Déjà un compte ?", pt: "Já tem uma conta?", ru: "Уже есть аккаунт?", ja: "すでにアカウントをお持ちですか？", zh: "已经有账户了？", hi: "पहले से ही एक खाता श्रेष्ठ है?", ar: "لديك حساب بالفعل؟" },
            auth_register_link: { en: "Register", es: "Regístrate", de: "Registrieren", fr: "S'inscrire", pt: "Registrar", ru: "Регистрация", ja: "登録", zh: "注册", hi: "पंजीकरण करवाना", ar: "تسجيل" },
            auth_login_link: { en: "Login", es: "Inicia Sesión", de: "Anmelden", fr: "Connexion", pt: "Entrar", ru: "Вход", ja: "ログイン", zh: "登录", hi: "लॉग इन करें", ar: "تسجيل الدخول" },
            auth_login_btn_short: { en: "Login", es: "Login", de: "Login", fr: "Login", pt: "Login", ru: "Вход", ja: "ログイン", zh: "登录", hi: "लॉग इन", ar: "دخول" },
            auth_logout_btn: { en: "Logout", es: "Salir", de: "Abmelden", fr: "Déconnexion", pt: "Sair", ru: "Выйти", ja: "ログアウト", zh: "登出", hi: "लॉग आउट", ar: "خروج" },
            auth_alliance: { en: "Alliance", es: "Alianza", de: "Allianz", fr: "Alliance", pt: "Aliança", ru: "Альянс", ja: "同盟", zh: "联盟", hi: "संधि", ar: "تحالف" },
            auth_alliance_none: { en: "None", es: "Ninguna", de: "Keine", fr: "Aucune", pt: "Nenhuma", ru: "Нет", ja: "なし", zh: "无", hi: "कोई नहीं", ar: "لا شيء" },
            profile_title: { en: "Edit Profile", es: "Editar Perfil", de: "Profil bearbeiten", fr: "Modifier le profil", pt: "Editar Perfil", ru: "Редактировать профиль", ja: "プロフィールを編集", zh: "编辑个人资料", hi: "प्रोफ़ाइल संपादित करें", ar: "تعديل الملف الشخصي" },
            profile_change_avatar: { en: "Change Avatar", es: "Cambiar Avatar", de: "Avatar ändern", fr: "Changer d'avatar", pt: "Mudar Avatar", ru: "Сменить аватар", ja: "アバターを変更", zh: "更换头像", hi: "अवतार बदलें", ar: "تغيير الصورة الرمزية" },
            profile_save_btn: { en: "Save Changes", es: "Guardar Cambios", de: "Änderungen speichern", fr: "Sauvegarder les modifications", pt: "Salvar Alterações", ru: "Сохранить изменения", ja: "変更を保存", zh: "保存更改", hi: "बदलाव सहेजें", ar: "حفظ التغييرات" },
            profile_success: { en: "Profile updated successfully!", es: "¡Perfil actualizado con éxito!", de: "Profil erfolgreich aktualisiert!", fr: "Profil mis à jour avec succès !", pt: "Perfil atualizado com sucesso!", ru: "Профиль успешно обновлен!", ja: "プロフィールが正常に更新されました！", zh: "个人资料更新成功！", hi: "प्रोफ़ाइल सफलतापूर्वक अपडेट किया गया!", ar: "تم تحديث الملف الشخصي بنجاح!" },
            language_modal_title: { en: "Select Language", es: "Seleccionar Idioma", de: "Sprache auswählen", fr: "Sélectionner la langue", pt: "Selecionar Idioma", ru: "Выберите язык", ja: "言語を選択", zh: "选择语言", hi: "भाषा चुनें", ar: "اختار اللغة" },
            calc_fountains_title: { en: "Blessed Fountains", es: "Fuentes Benditas", de: "Gesegnete Brunnen", fr: "Fontaines bénies", pt: "Fontes Abençoadas", ru: "Благословенные фонтаны", ja: "祝福された泉", zh: "祝福之泉", hi: "धन्य फव्वारे", ar: "النوافير المباركة" },
            calc_fountain_1: { en: "Fountain 1", es: "Fuente 1", de: "Brunnen 1", fr: "Fontaine 1", pt: "Fonte 1", ru: "Фонтан 1", ja: "泉1", zh: "1号泉", hi: "फव्वारा 1", ar: "نافورة 1" },
            calc_fountain_2: { en: "Fountain 2", es: "Fuente 2", de: "Brunnen 2", fr: "Fontaine 2", pt: "Fonte 2", ru: "Фонтан 2", ja: "泉2", zh: "2号泉", hi: "फव्वारा 2", ar: "نافورة 2" },
            calc_fountain_3: { en: "Fountain 3", es: "Fuente 3", de: "Brunnen 3", fr: "Fontaine 3", pt: "Fonte 3", ru: "Фонтан 3", ja: "泉3", zh: "3号泉", hi: "फव्वारा 3", ar: "نافورة 3" },
            calc_fountain_4: { en: "Fountain 4", es: "Fuente 4", de: "Brunnen 4", fr: "Fontaine 4", pt: "Fonte 4", ru: "Фонтан 4", ja: "泉4", zh: "4号泉", hi: "फव्वारा 4", ar: "نافورة 4" },
            calc_fountain_5_toggle: { en: "Enable 5th Fountain", es: "Habilitar 5ª Fuente", de: "5. Brunnen aktivieren", fr: "Activer la 5ème fontaine", pt: "Ativar 5ª Fonte", ru: "Включить 5-й фонтан", ja: "5番目の泉を有効にする", zh: "启用第五泉", hi: "5वां फव्वारा सक्षम करें", ar: "تمكين النافورة الخامسة" },
            calc_total_water: { en: "Total Water / Hour", es: "Agua Total / Hora", de: "Gesamtwasser / Stunde", fr: "Eau totale / Heure", pt: "Água Total / Hora", ru: "Всего воды / час", ja: "総水量/時", zh: "总水量/小时", hi: "कुल पानी / घंटा", ar: "إجمالي المياه / الساعة" },
            calc_lab_title: { en: "Cursed Lab Upgrade", es: "Mejora de Laboratorio Maldito", de: "Verfluchtes Labor-Upgrade", fr: "Amélioration du laboratoire maudit", pt: "Upgrade do Laboratório Amaldiçoado", ru: "Улучшение Проклятой Лаборатории", ja: "呪われた研究室のアップグレード", zh: "诅咒实验室升级", hi: "शापित लैब अपग्रेड", ar: "ترقية المختبر الملعون" },
            calc_current_water: { en: "Current Sacred Water", es: "Agua Sagrada Actual", de: "Aktuelles Heiliges Wasser", fr: "Eau sacrée actuelle", pt: "Água Sagrada Atual", ru: "Текущая Священная вода", ja: "現在の聖水", zh: "当前圣水量", hi: "वर्तमान पवित्र जल", ar: "المياه المقدسة الحالية" },
            calc_target_level: { en: "Target Lab Level", es: "Nivel de Laboratorio Deseado", de: "Ziellaborlevel", fr: "Niveau de laboratoire cible", pt: "Nível Alvo do Laboratório", ru: "Целевой уровень лаборатории", ja: "目標の研究室レベル", zh: "目标实验室等级", hi: "लक्ष्य लैब स्तर", ar: "مستوى المختبر المستهدف" },
            calc_completion_time: { en: "Upgrade Completion Time", es: "Tiempo de Finalización", de: "Abschlusszeit des Upgrades", fr: "Temps de réalisation de l'amélioration", pt: "Tempo de Conclusão do Upgrade", ru: "Время завершения улучшения", ja: "アップグレード完了時間", zh: "升级完成时间", hi: "अपग्रेड সমাপ্তિ સમય", ar: "وقت اكتمال الترقية" },
            leaderboard_title: { en: "Resistance Development Leaderboard", es: "Clasificación de Desarrollo de Resistencia", de: "Bestenliste der Widerstandsentwicklung", fr: "Classement du développement de la résistance", pt: "Quadro de Líderes de Desenvolvimento de Resistência", ru: "Таблица лидеров по развитию сопротивления", ja: "耐性開発リーダーボード", zh: "抵抗发展排行榜", hi: "प्रतिरोध विकास लीडरबोर्ड", ar: "لوحة صدارة تطوير المقاومة" },
            leaderboard_subtitle: { en: "See how you stack up against other players.", es: "Compara tu progreso con otros jugadores.", de: "Sieh, wie du dich gegen andere Spieler schlägst.", fr: "Voyez comment vous vous situez par rapport aux autres joueurs.", pt: "Veja como você se compara a outros jogadores.", ru: "Посмотрите, как вы смотритесь на фоне других игроков.", ja: "他のプレイヤーとの比較をご覧ください。", zh: "看看你与其他玩家的比较。", hi: "देखें कि आप अन्य खिलाड़ियों के खिलाफ कैसे टिकते हैं।", ar: "انظر كيف تقارن باللاعبين الآخرين." },
            leaderboard_login_prompt_1: { en: "Please", es: "Por favor", de: "Bitte", fr: "S'il vous plaît", pt: "Por favor", ru: "Пожалуйста", ja: "お願いします", zh: "请", hi: "कृपया", ar: "من فضلك" },
            leaderboard_login_prompt_2: { en: "log in", es: "inicia sesión", de: "anmelden", fr: "connectez-vous", pt: "faça login", ru: "войдите", ja: "ログイン", zh: "登录", hi: "लॉग इन करें", ar: "تسجيل الدخول" },
            leaderboard_login_prompt_3: { en: "to join the leaderboard.", es: "para unirte.", de: "um der Bestenliste beizutreten.", fr: "pour rejoindre le classement.", pt: "para se juntar ao quadro de líderes.", ru: "чтобы присоединиться к таблице лидеров.", ja: "リーダーボードに参加する。", zh: "加入排行榜。", hi: "लीडरबोर्ड में शामिल होने के लिए।", ar: "للانضمام إلى لوحة الصدارة." },
            leaderboard_card_next_level: { en: "Next Level", es: "Siguiente Nivel", de: "Nächstes Level", fr: "Niveau suivant", pt: "Próximo Nível", ru: "Следующий уровень", ja: "次のレベル", zh: "下一级", hi: "अगला स्तर", ar: "المستوى التالي" },
            leaderboard_card_lab_level: { en: "Lab Level", es: "Nivel Lab", de: "Laborlevel", fr: "Niv Lab", pt: "Nível Lab", ru: "Уровень лаб.", ja: "研究室レベル", zh: "实验室等级", hi: "लैब स्तर", ar: "مستوى المختبر" },
            leaderboard_card_resistance: { en: "Resistance", es: "Resistencia", de: "Widerstand", fr: "Résistance", pt: "Resistência", ru: "Сопротивление", ja: "耐性", zh: "抵抗力", hi: "प्रतिरोध", ar: "مقاومة" },
            leaderboard_card_water_hr: { en: "Water/hr", es: "Agua/h", de: "Wasser/h", fr: "Eau/h", pt: "Água/h", ru: "Вода/час", ja: "水/時", zh: "水/小时", hi: "पानी/घंटा", ar: "ماء/ساعة" },
            info_title: { en: "Information", es: "Información", de: "Informationen", fr: "Informations", pt: "Informações", ru: "Информация", ja: "情報", zh: "信息", hi: "जानकारी", ar: "معلومات" },
            info_p1: { en: "This tool is designed to help you plan your resource management for the Cursed Lab and Blessed Fountains. Optimize your upgrades, see how you compare to others, and save your progress.", es: "Esta herramienta está diseñada para ayudarte a planificar la gestión de tus recursos y mejoras de edificios de manera efectiva.", de: "Dieses Tool soll Ihnen bei der Planung Ihres Ressourcenmanagements für das Verfluchte Labor und die Gesegneten Brunnen helfen. Optimieren Sie Ihre Upgrades, vergleichen Sie sich mit anderen und speichern Sie Ihren Fortschritt.", fr: "Cet outil est conçu pour vous aider à planifier votre gestion des ressources pour le Laboratoire Maudit et les Fontaines Bénies. Optimisez vos améliorations, comparez-vous aux autres et sauvegardez votre progression.", pt: "Esta ferramenta foi projetada para ajudá-lo a planejar sua gestão de recursos para o Laboratório Amaldiçoado e as Fontes Abençoadas. Otimize seus upgrades, veja como você se compara aos outros e salve seu progresso.", ru: "Этот инструмент предназначен для планирования управления ресурсами для Проклятой Лаборатории и Благословенных Фонтанов. Оптимизируйте улучшения, сравнивайте себя с другими и сохраняйте свой прогресс.", ja: "このツールは、呪われた研究室と祝福された泉のリソース管理を計画するのに役立ちます。アップグレードを最適化し、他のプレイヤーと比較し、進行状況を保存します。", zh: "此工具旨在帮助您规划诅咒实验室和祝福之泉的资源管理。优化您的升级，与他人比较，并保存您的进度。", hi: "यह उपकरण आपको शापित लैब और धन्य फव्वारों के लिए अपने संसाधन प्रबंधन की योजना बनाने में मदद करने के लिए डिज़ाइन किया गया है। अपने अपग्रेड को अनुकूलित करें, देखें कि आप दूसरों की तुलना में कैसे हैं, और अपनी प्रगति को सहेजें।", ar: "تم تصميم هذه الأداة لمساعدتك في تخطيط إدارة الموارد الخاصة بك للمختبر الملعون والنوافير المباركة. قم بتحسين ترقياتك ، وقارن نفسك بالآخرين ، واحفظ تقدمك." },
            info_h_calc: { en: "Calculator Page", es: "Página de la Calculadora", de: "Rechnerseite", fr: "Page Calculateur", pt: "Página da Calculadora", ru: "Страница калькулятора", ja: "計算機ページ", zh: "计算器页面", hi: "कैलकुलेटर पृष्ठ", ar: "صفحة الحاسبة" },
            info_li_calc1: { en: "Blessed Fountains: Select the current level for each of your four primary fountains. If you have unlocked the fifth, use the toggle to enable it and set its level.", es: "Fuentes Benditas: Selecciona el nivel actual para cada una de tus cuatro fuentes principales. Si has desbloqueado la quinta, usa el interruptor para habilitarla y establecer su nivel.", de: "Gesegnete Brunnen: Wählen Sie das aktuelle Level für jeden Ihrer vier Hauptbrunnen. Wenn Sie den fünften freigeschaltet haben, verwenden Sie den Schalter, um ihn zu aktivieren und sein Level einzustellen.", fr: "Fontaines bénies : Sélectionnez le niveau actuel pour chacune de vos quatre fontaines principales. Si vous avez déverrouillé la cinquième, utilisez le bouton pour l'activer et définir son niveau.", pt: "Fontes Abençoadas: Selecione o nível atual para cada uma de suas quatro fontes primárias. Se você desbloqueou a quinta, use o botão para ativá-la и definir seu nível.", ru: "Благословенные фонтаны: выберите текущий уровень для каждого из ваших четырех основных фонтанов. Если вы разблокировали пятый, используйте переключатель, чтобы включить его и установить его уровень.", ja: "祝福された泉：4つの主要な泉それぞれの現在のレベルを選択します。 5番目のロックを解除した場合は、トグルを使用して有効にし、そのレベルを設定します。", zh: "祝福之泉：为您四个主要泉水选择当前等级。如果您已解锁第五个，请使用切换开关启用并设置其等级。", hi: "धन्य फव्वारे: अपने चार प्राथमिक फव्वारों में से प्रत्येक के लिए वर्तमान स्तर का चयन करें। यदि आपने पांचवां अनलॉक कर लिया है, तो इसे सक्षम करने और इसका स्तर सेट करने के लिए टॉगल का उपयोग करें।", ar: "النوافير المباركة: حدد المستوى الحالي لكل من النوافير الأربعة الأساسية. إذا قمت بإلغاء قفل الخامس ، فاستخدم التبديل لتمكينه وتعيين مستواه." },
            info_li_calc2: { en: "Total Production: The calculator will instantly show your total Sacred Water production per hour based on your fountain levels.", es: "Producción Total: La calculadora mostrará instantáneamente tu producción total de Agua Sagrada por hora según los niveles de tus fuentes.", de: "Gesamtproduktion: Der Rechner zeigt sofort Ihre gesamte Heilige-Wasser-Produktion pro Stunde basierend auf Ihren Brunnenleveln an.", fr: "Production totale : Le calculateur affichera instantanément votre production totale d'Eau sacrée par heure en fonction des niveaux de vos fontaines.", pt: "Produção Total: A calculadora mostrará instantaneamente sua produção total de Água Sagrada por hora com base nos níveis de suas fontes.", ru: "Общее производство: калькулятор мгновенно покажет ваше общее производство Священной воды в час в зависимости от уровней ваших фонтанов.", ja: "総生産量：計算機は、泉のレベルに基づいて1時間あたりの総聖水生産量を即座に表示します。", zh: "总产量：计算器将根据您的泉水等级立即显示您每小时的总圣水产量。", hi: "कुल उत्पादन: कैलकुलेटर आपके फव्वारे के स्तर के आधार पर प्रति घंटे आपके कुल पवित्र जल उत्पादन को तुरंत दिखाएगा।", ar: "الإنتاج الإجمالي: ستعرض الحاسبة على الفور إجمالي إنتاجك من المياه المقدسة في الساعة بناءً على مستويات نوافيرك." },
            info_li_calc3: { en: "Lab Upgrade: Enter your current amount of Sacred Water and select the Cursed Lab level you are aiming for.", es: "Mejora de Laboratorio: Ingresa tu cantidad actual de Agua Sagrada y selecciona el nivel de Laboratorio Maldito que deseas alcanzar.", de: "Labor-Upgrade: Geben Sie Ihre aktuelle Menge an Heiligem Wasser ein und wählen Sie das angestrebte Laborlevel aus.", fr: "Amélioration du laboratoire : Entrez votre quantité actuelle d'Eau sacrée et sélectionnez le niveau de laboratoire maudit que vous visez.", pt: "Upgrade do Laboratório: Insira sua quantidade atual de Água Sagrada e selecione o nível do Laboratório Amaldiçoado que você almeja.", ru: "Улучшение лаборатории: введите ваше текущее количество Священной воды и выберите целевой уровень Проклятой лаборатории.", ja: "研究室のアップグレード：現在の聖水の量を入力し、目指している呪われた研究室のレベルを選択します。", zh: "实验室升级：输入您当前的圣水量，然后选择您要达到的诅咒实验室等级。", hi: "लैब अपग्रेड: अपनी वर्तमान पवित्र जल की मात्रा दर्ज करें और उस शापित लैब स्तर का चयन करें जिसका आप लक्ष्य बना रहे हैं।", ar: "ترقية المختبر: أدخل الكمية الحالية من المياه المقدسة وحدد مستوى المختبر الملعون الذي تستهدفه." },
            info_li_calc4: { en: "Completion Time: The tool will calculate the exact date and time you will have enough resources for the selected lab upgrade.", es: "Tiempo de Finalización: La herramienta calculará la fecha y hora exactas en que tendrás suficientes recursos para la mejora de laboratorio seleccionada.", de: "Abschlusszeit: Das Tool berechnet das genaue Datum und die Uhrzeit, zu der Sie genügend Ressourcen für das ausgewählte Labor-Upgrade haben werden.", fr: "Temps de réalisation : L'outil calculera la date et l'heure exactes auxquelles vous aurez suffisamment de ressources pour l'amélioration de laboratoire sélectionnée.", pt: "Tempo de Conclusão: A ferramenta calculará a data e a hora exatas em que você terá recursos suficientes para o upgrade de laboratório selecionado.", ru: "Время завершения: инструмент рассчитает точную дату и время, когда у вас будет достаточно ресурсов для выбранного улучшения лаборатории.", ja: "完了時間：このツールは、選択した研究室のアップグレードに十分なリソースがある正確な日時を計算します。", zh: "完成时间：该工具将计算您有足够资源进行所选实验室升级的确切日期和时间。", hi: "समापन समय: उपकरण उस सटीक तारीख और समय की गणना करेगा जब आपके पास चयनित लैब अपग्रेड के लिए पर्याप्त संसाधन होंगे।", ar: "وقت الإكمال: ستحسب الأداة التاريخ والوقت المحددين اللذين سيكون لديك فيهما موارد كافية لترقية المختبر المحددة." },
            info_h_leaderboard: { en: "Leaderboard", es: "Clasificación", de: "Bestenliste", fr: "Classement", pt: "Quadro de Líderes", ru: "Таблица лидеров", ja: "リーダーボード", zh: "排行榜", hi: "लीडरबोर्ड", ar: "لوحة الصدارة" },
            info_p_leaderboard: { en: "Log in to join the Leaderboard. Once logged in, your data will automatically sync to the leaderboard as you make changes in the calculator, allowing you to see how your progress and production rate compare to other players in real-time.", es: "Inicia sesión para unirte a la tabla de clasificación. Una vez que hayas iniciado sesión, tus datos se sincronizarán automáticamente con la tabla de clasificación a medida que realices cambios en la calculadora, lo que te permitirá ver cómo se compara tu progreso y tu tasa de producción con otros jugadores en tiempo real.", de: "Melden Sie sich an, um der Bestenliste beizutreten. Nach der Anmeldung werden Ihre Daten automatisch mit der Bestenliste synchronisiert, wenn Sie Änderungen im Rechner vornehmen, sodass Sie sehen können, wie Ihr Fortschritt und Ihre Produktionsrate im Vergleich zu anderen Spielern in Echtzeit abschneiden.", fr: "Connectez-vous pour rejoindre le classement. Une fois connecté, vos données se synchroniseront automatiquement avec le classement au fur et à mesure que vous apporterez des modifications dans le calculateur, vous permettant de voir comment votre progression et votre taux de production se comparent aux autres joueurs en temps réel.", pt: "Faça login para entrar no Quadro de Líderes. Uma vez logado, seus dados serão sincronizados automaticamente com o quadro de líderes à medida que você fizer alterações na calculadora, permitindo que você veja como seu progresso e taxa de produção se comparam a outros jogadores em tempo real.", ru: "Войдите, чтобы присоединиться к таблице лидеров. После входа ваши данные будут автоматически синхронизироваться с таблицей лидеров по мере внесения изменений в калькулятор, что позволит вам в реальном времени видеть, как ваш прогресс и скорость производства соотносятся с другими игроками.", ja: "リーダーボードに参加するにはログインしてください。ログインすると、計算機で変更を加えるたびにデータがリーダーボードに自動的に同期され、リアルタイムで他のプレイヤーと自分の進捗状況や生産率を比較できます。", zh: "登录以加入排行榜。登录后，当您在计算器中进行更改时，您的数据将自动同步到排行榜，从而使您可以实时查看自己的进度和生产率与其他玩家的比较情况。", hi: "लीडरबोर्ड में शामिल होने के लिए लॉग इन करें। एक बार लॉग इन करने के बाद, कैलकुलेटर में बदलाव करने पर आपका डेटा स्वचालित रूप से लीडरबोर्ड से समन्वयित हो जाएगा, जिससे आप देख सकेंगे कि आपकी प्रगति और उत्पादन दर वास्तविक समय में अन्य खिलाड़ियों की तुलना में कैसी है।", ar: "سجل الدخول للانضمام إلى لوحة الصدارة. بمجرد تسجيل الدخول ، ستتم مزامنة بياناتك تلقائيًا مع لوحة الصدارة عند إجراء تغييرات في الحاسبة ، مما يتيح لك معرفة كيفية مقارنة تقدمك ومعدل إنتاجك باللاعبين الآخرين في الوقت الفعلي." },
            info_h_save: { en: "Saving Your Data", es: "Guardando Tus Datos", de: "Speichern Ihrer Daten", fr: "Sauvegarde de vos données", pt: "Salvando Seus Dados", ru: "Сохранение ваших данных", ja: "データの保存", zh: "保存您的数据", hi: "अपना डेटा सहेजना", ar: "حفظ بياناتك" },
            info_p_save: { en: "Creating an account and logging in automatically saves your data (fountain levels, current resources) to our database. The next time you visit, all your information will be pre-filled, so you can continue your planning without missing a beat.", es: "Al crear una cuenta e iniciar sesión, tus datos (niveles de fuente, recursos actuales) se guardan automáticamente en nuestra base de datos. La próxima vez que visites, toda tu información estará pre-cargada, para que puedas continuar tu planificación sin perder el ritmo.", de: "Durch das Erstellen eines Kontos und das Anmelden werden Ihre Daten (Brunnenlevel, aktuelle Ressourcen) automatisch in unserer Datenbank gespeichert. Bei Ihrem nächsten Besuch sind alle Ihre Informationen vorausgefüllt, sodass Sie Ihre Planung ohne Unterbrechung fortsetzen können.", fr: "La création d'un compte et la connexion enregistrent automatiquement vos données (niveaux de fontaine, ressources actuelles) dans notre base de données. La prochaine fois que vous visiterez, toutes vos informations seront pré-remplies, afin que vous puissiez continuer votre planification sans perdre un instant.", pt: "Criar uma conta e fazer login salva automaticamente seus dados (níveis de fonte, recursos atuais) em nosso banco de dados. Na próxima vez que você visitar, todas as suas informações estarão pré-preenchidas, para que você possa continuar seu planejamento sem perder o ritmo.", ru: "Создание учетной записи и вход в систему автоматически сохраняют ваши данные (уровни фонтанов, текущие ресурсы) в нашей базе данных. При следующем посещении вся ваша информация будет предварительно заполнена, чтобы вы могли продолжить планирование без промедления.", ja: "アカウントを作成してログインすると、データ（泉のレベル、現在のリソース）が自動的にデータベースに保存されます。次回アクセスすると、すべての情報が事前に入力されているため、中断することなく計画を続行できます。", zh: "创建帐户并登录会自动将您的数据（泉水等级，当前资源）保存到我们的数据库中。下次访问时，您的所有信息都将预先填写，因此您可以继续进行计划而不会错过任何一个节拍。", hi: "एक खाता बनाने और लॉग इन करने से आपका डेटा (फव्वारे का स्तर, वर्तमान संसाधन) हमारे डेटाबेस में स्वचालित रूप से सहेजा जाता है। अगली बार जब आप आएंगे, तो आपकी सभी जानकारी पहले से भरी होगी, ताकि आप बिना किसी रुकावट के अपनी योजना जारी रख सकें।", ar: "يؤدي إنشاء حساب وتسجيل الدخول إلى حفظ بياناتك تلقائيًا (مستويات النافورة والموارد الحالية) في قاعدة بياناتنا. في المرة القادمة التي تزور فيها ، سيتم ملء جميع معلوماتك مسبقًا ، حتى تتمكن من متابعة التخطيط دون أي انقطاع." },
            time_ready: { en: "Ready!", es: "¡Listo!", de: "Bereit!", fr: "Prêt !", pt: "Pronto!", ru: "Готово!", ja: "準備完了！", zh: "准备好了！", hi: "तैयार!", ar: "جاهز!" },
            time_no_prod: { en: "No Production", es: "Sin Producción", de: "Keine Produktion", fr: "Pas de production", pt: "Sem Produção", ru: "Нет производства", ja: "生産なし", zh: "没有生产", hi: "कोई उत्पादन नहीं", ar: "لا يوجد إنتاج" },
            toast_data_synced: { en: "Leaderboard synced!", es: "¡Clasificación sincronizada!", de: "Bestenliste synchronisiert!", fr: "Classement synchronisé !", pt: "Quadro de Líderes sincronizado!", ru: "Таблица лидеров синхронизирована!", ja: "リーダーボードが同期されました！", zh: "排行榜已同步！", hi: "लीडरबोर्ड समन्वयित!", ar: "تمت مزامنة لوحة الصدارة!" },
        };

        const supportedLangs = { 
            en: "English", 
            es: "Español",
            de: "Deutsch",
            fr: "Français",
            pt: "Português",
            ru: "Русский",
            ja: "日本語",
            zh: "中文 (简体)",
            hi: "हिन्दी",
            ar: "العربية"
        };
        
        function getTranslation(key, lang) {
            if (i18nData[key] && i18nData[key][lang]) {
                return i18nData[key][lang];
            }
            // Fallback to English if translation is missing
            return i18nData[key] ? i18nData[key]['en'] : key;
        }


        function showToast(messageKey, type = 'success') {
            const lang = localStorage.getItem('language') || 'en';
            const message = getTranslation(messageKey, lang);
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas fa-check-circle mx-3"></i> ${message}`;
            dom.toastContainer.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        function setLanguage(lang) {
            const langCode = supportedLangs[lang] ? lang : 'en';
            document.querySelectorAll('[data-i18n-key]').forEach(el => {
                const key = el.getAttribute('data-i18n-key');
                el.textContent = getTranslation(key, langCode);
            });
            
            if (langCode === 'ar') {
                document.documentElement.setAttribute('dir', 'rtl');
            } else {
                document.documentElement.setAttribute('dir', 'ltr');
            }

            localStorage.setItem('language', langCode);
            runCalculations(); // Recalculate to update time formats etc.
            if(document.getElementById('leaderboard-page').classList.contains('hidden') === false) {
                 renderLeaderboard(); // Re-render leaderboard if visible
            }
        }

        function initializeCurrentLanguage() {
            const savedLang = localStorage.getItem('language');
            const browserLang = navigator.language.split('-')[0];
            const defaultLang = savedLang || (supportedLangs[browserLang] ? browserLang : 'en');
            setLanguage(defaultLang);
        }
        
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        async function updatePublicLeaderboard() {
            if (!currentUserId || !auth.currentUser) return;
            if (dom.calculator.currentWater.value === '' || !state.targetLabLevel) {
                console.log("Sync skipped: missing required calculator data.");
                return;
            }
            const publicData = { 
                username: auth.currentUser.displayName, 
                avatarUrl: auth.currentUser.photoURL,
                alliance: state.alliance,
                calculatorData: state, 
                updatedAt: new Date() 
            };
            try {
                const publicUserDocRef = doc(db, `artifacts/${appId}/public/data/playerData/${currentUserId}`);
                await setDoc(publicUserDocRef, publicData, { merge: true });
                console.log("Leaderboard updated automatically.");
            } catch (error) { 
                console.error("Error writing public data automatically: ", error); 
            }
        }

        const debouncedUpdatePublicLeaderboard = debounce(updatePublicLeaderboard, 1500);

        function runCalculations(baseTime = Date.now()) {
            state.hourlyProduction = 0;
            for (let i = 0; i < 4; i++) {
                const level = parseInt(dom.fountainSelectors[i].value, 10);
                state.hourlyProduction += fountainProductionRates[level] || 0;
                state.fountainLevels[i] = level;
            }

            state.fountain5Enabled = dom.fifthFountain.toggle.checked;
            dom.fifthFountain.selector.disabled = !state.fountain5Enabled;
            dom.fifthFountain.selector.style.opacity = state.fountain5Enabled ? 1 : 0.5;

            if (state.fountain5Enabled) {
                const level = parseInt(dom.fifthFountain.selector.value, 10);
                state.hourlyProduction += fountainProductionRates[level] || 0;
                state.fountainLevels[4] = level;
            } else {
                state.fountainLevels[4] = 0;
            }

            dom.calculator.totalOutput.textContent = state.hourlyProduction.toLocaleString();
            state.targetLabLevel = parseInt(dom.calculator.labLevel.value, 10);
            state.currentWater = parseInt(dom.calculator.currentWater.value, 10) || 0;
            
            const labCost = labUpgradeData[state.targetLabLevel]?.cost || 0;
            const waterNeeded = labCost - state.currentWater;

            const lang = localStorage.getItem('language') || 'en';
            if (waterNeeded <= 0) {
                dom.calculator.completionTime.textContent = getTranslation('time_ready', lang);
                dom.calculator.completionTime.className = "text-3xl font-bold mt-1 text-green-400";
            } else if (state.hourlyProduction <= 0) {
                dom.calculator.completionTime.textContent = getTranslation('time_no_prod', lang);
                dom.calculator.completionTime.className = "text-3xl font-bold mt-1 text-red-400";
            } else {
                const hoursNeeded = waterNeeded / state.hourlyProduction;
                const completionDate = new Date(baseTime + hoursNeeded * 3600000);
                dom.calculator.completionTime.textContent = completionDate.toLocaleString(lang, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                dom.calculator.completionTime.className = "text-3xl font-bold mt-1 text-teal-300";
            }
        }
        
        async function savePrivateDataSilently() {
            if (!currentUserId || !db) return;
            state.updatedAt = new Date();
            try {
                const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}`);
                await setDoc(userDocRef, state, { merge: true });
            } catch (error) { console.error("Error saving data silently: ", error); }
        }

        async function loadDataFromFirestore() {
            if (!currentUserId || !db) return;
            const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}`);
            const docSnap = await getDoc(userDocRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                Object.assign(state, data); // Load all data into state
                
                if(data.fountainLevels) {
                    dom.fountainSelectors.forEach((sel, i) => { if(data.fountainLevels[i] !== undefined) sel.value = data.fountainLevels[i]; });
                }
                if(data.fountain5Enabled !== undefined) {
                    dom.fifthFountain.toggle.checked = data.fountain5Enabled;
                }
                if(data.currentWater !== undefined) dom.calculator.currentWater.value = data.currentWater;
                if(data.targetLabLevel !== undefined) dom.calculator.labLevel.value = data.targetLabLevel;
                
                const lastUpdateTime = data.updatedAt?.toDate()?.getTime() || Date.now();
                runCalculations(lastUpdateTime);
            }
        }
        
        function calculateCompletionDate(player) {
            const data = player.calculatorData;
            if (!data) return null;

            const targetLabLevel = data.targetLabLevel || 0;
            const labCost = labUpgradeData[targetLabLevel]?.cost || 0;
            const hourlyProduction = data.hourlyProduction || 0;
            const lastUpdateWater = data.currentWater || 0;
            const lastUpdateTime = player.updatedAt?.toDate();

            if (!lastUpdateTime) return null;

            const waterNeeded = labCost - lastUpdateWater;

            if (waterNeeded <= 0) {
                return new Date(lastUpdateTime.getTime());
            }
            
            if (hourlyProduction <= 0) {
                return null; // Represents infinity
            }

            const hoursNeeded = waterNeeded / hourlyProduction;
            const completionTimestamp = lastUpdateTime.getTime() + hoursNeeded * 3600000;
            
            return new Date(completionTimestamp);
        }

        function renderLeaderboard() {
            const lang = localStorage.getItem('language') || 'en';
            const selectedAlliance = dom.leaderboard.allianceFilter.value;

            const filteredPlayers = selectedAlliance === 'All'
                ? allPlayersData
                : allPlayersData.filter(p => (p.alliance || 'none') === selectedAlliance);

            dom.leaderboard.playerListContainer.innerHTML = '';
            if (filteredPlayers.length === 0) {
                dom.leaderboard.playerListContainer.innerHTML = `<p class="text-center text-slate-400 col-span-full py-8">No players found for this filter.</p>`;
                return;
            }
            
            filteredPlayers.forEach((player) => {
                const data = player.calculatorData || {};
                let completionTimeText = '--';
                let completionTimeClass = 'text-slate-300';
                const completionDate = calculateCompletionDate(player);

                if (completionDate) {
                    if (completionDate.getTime() <= Date.now()) {
                        completionTimeText = getTranslation('time_ready', lang);
                        completionTimeClass = 'text-green-400';
                    } else {
                        completionTimeText = completionDate.toLocaleString(lang, { hour: '2-digit', minute: '2-digit' });
                        completionTimeClass = 'text-teal-300';
                    }
                } else {
                    completionTimeText = getTranslation('time_no_prod', lang);
                    completionTimeClass = 'text-red-400';
                }

                const avatarUrl = player.avatarUrl || 'https://placehold.co/150x150/1f2937/9ca3af?text=N/A';
                const allianceName = player.alliance && player.alliance !== 'none' ? player.alliance : 'No Alliance';
                const originalRank = allPlayersData.indexOf(player) + 1;

                const card = `
                    <div class="player-card rounded-lg flex">
                        <div class="rank flex items-center justify-center w-16 shrink-0 rounded-l-lg">
                            <p class="text-3xl font-bold text-white">#${originalRank}</p>
                        </div>
                        <div class="p-3 py-2 flex-grow">
                            <div class="flex items-start justify-between gap-3">
                                <div class="flex items-center gap-3">
                                    <img src="${avatarUrl}" class="w-12 h-12 rounded-full object-cover border-2 border-slate-600">
                                    <div>
                                        <p class="font-bold text-lg text-white truncate">${player.username || 'Anonymous'}</p>
                                        <p class="text-xs text-violet-300 -mt-1">${allianceName}</p>
                                    </div>
                                </div>
                                <div class="text-right shrink-0">
                                    <p class="text-xs text-slate-400" data-i18n-key="leaderboard_card_next_level">Next Level</p>
                                    <p class="font-semibold text-base ${completionTimeClass}">${completionTimeText}</p>
                                </div>
                            </div>
                            <div class="border-t mt-2 border-slate-700/50 pt-2 grid grid-cols-3 gap-2 text-center">
                                <div>
                                    <p class="text-xs text-slate-400" data-i18n-key="leaderboard_card_lab_level">Lab Level</p>
                                    <p class="font-bold text-2xl text-white">${data.targetLabLevel || 'N/A'}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-slate-400" data-i18n-key="leaderboard_card_resistance">Resistance</p>
                                    <p class="font-bold text-2xl text-violet-300">${(labUpgradeData[data.targetLabLevel]?.res || 0).toLocaleString()}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-slate-400" data-i18n-key="leaderboard_card_water_hr">Water/hr</p>
                                    <p class="font-bold text-2xl text-sky-400">${(data.hourlyProduction || 0).toLocaleString()}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                dom.leaderboard.playerListContainer.innerHTML += card;
            });
            setLanguage(lang);
        }

        /*
        NOTE FOR DEPLOYMENT:
        To allow non-logged-in users to view the leaderboard,
        the Firestore security rules for the public data collection must be updated.
        Change:
          allow read: if request.auth != null;
        To:
          allow read;

        In path: /artifacts/{appId}/public/data/playerData/{userId}
        */
        function listenForPublicPlayerData() {
            if (!db) return;
            const q = query(collection(db, `artifacts/${appId}/public/data/playerData`));
            onSnapshot(q, (querySnapshot) => {
                const players = [];
                querySnapshot.forEach((doc) => players.push(doc.data()));
                
                players.sort((a, b) => {
                    const dataA = a.calculatorData || {};
                    const dataB = b.calculatorData || {};
                    const labLevelA = dataA.targetLabLevel || 0;
                    const labLevelB = dataB.targetLabLevel || 0;
                    if (labLevelB !== labLevelA) return labLevelB - labLevelA;
                    const completionDateA = calculateCompletionDate(a);
                    const completionDateB = calculateCompletionDate(b);
                    if (!completionDateA && completionDateB) return 1;
                    if (completionDateA && !completionDateB) return -1;
                    if (!completionDateA && !completionDateB) return 0;
                    return completionDateA.getTime() - completionDateB.getTime();
                });

                allPlayersData = players;
                renderLeaderboard();
            }, (error) => {
                console.error("Leaderboard read failed: ", error);
                dom.leaderboard.playerListContainer.innerHTML = `<p class="text-center text-red-400 col-span-full py-8">Could not load leaderboard. Check security rules.</p>`;
            });
        }

        function updateUIForAuthState(user) {
            const defaultAvatar = 'https://placehold.co/150x150/1f2937/9ca3af?text=Avatar';
            if (user) {
                const avatarUrl = user.photoURL || defaultAvatar;
                // Desktop
                dom.auth.loginBtn.classList.add('hidden');
                dom.auth.userInfo.classList.remove('hidden');
                dom.auth.userInfo.classList.add('flex', 'cursor-pointer');
                dom.auth.userAvatar.src = avatarUrl;
                dom.auth.userDisplayName.textContent = user.displayName || user.email;
                // Mobile
                dom.auth.loginBtnMobile.classList.add('hidden');
                dom.auth.userInfoMobile.classList.remove('hidden');
                dom.auth.userInfoMobile.classList.add('flex', 'cursor-pointer');
                dom.auth.userAvatarMobile.src = avatarUrl;
                dom.auth.userDisplayNameMobile.textContent = user.displayName || user.email;

                dom.leaderboard.loginPrompt.classList.add('hidden');
            } else {
                // Desktop
                dom.auth.loginBtn.classList.remove('hidden');
                dom.auth.userInfo.classList.add('hidden');
                dom.auth.userInfo.classList.remove('cursor-pointer');
                dom.auth.userAvatar.src = defaultAvatar;
                // Mobile
                dom.auth.loginBtnMobile.classList.remove('hidden');
                dom.auth.userInfoMobile.classList.add('hidden');
                dom.auth.userInfoMobile.classList.remove('cursor-pointer');
                dom.auth.userAvatarMobile.src = defaultAvatar;

                dom.leaderboard.loginPrompt.classList.remove('hidden');
            }
        }
        
        function handleInputChange() {
            runCalculations();
            if (currentUserId) {
                savePrivateDataSilently();
                debouncedUpdatePublicLeaderboard();
            }
        }
        
        // --- Profile Edit Functions ---
        function openProfileModal() {
            if (!auth.currentUser) return;
            const user = auth.currentUser;
            dom.profile.usernameInput.value = user.displayName || '';
            dom.profile.avatarPreview.src = user.photoURL || 'https://placehold.co/150x150/1f2937/9ca3af?text=Avatar';
            dom.profile.allianceSelect.value = state.alliance || 'none';
            dom.profile.error.textContent = '';
            dom.profile.modal.classList.remove('hidden');
        }

        // Image resize function
        function resizeImage(file, width, height, callback) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    callback(canvas.toDataURL('image/jpeg')); // Get base64 string
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // --- Language Modal Functions ---
        function openLanguageModal() {
            dom.language.optionsContainer.innerHTML = ''; // Clear previous options
            Object.entries(supportedLangs).forEach(([code, name]) => {
                const button = document.createElement('button');
                button.textContent = name;
                button.className = 'w-full px-4 py-3 bg-slate-700 hover:bg-slate-600 rounded-md font-semibold text-white transition-colors';
                button.onclick = () => {
                    setLanguage(code);
                    closeLanguageModal();
                };
                dom.language.optionsContainer.appendChild(button);
            });
            dom.language.modal.classList.remove('hidden');
        }

        function closeLanguageModal() {
            dom.language.modal.classList.add('hidden');
        }


        document.addEventListener('DOMContentLoaded', () => {
            let fountainOptions = ''; for (let i = 0; i <= 30; i++) fountainOptions += `<option value="${i}">Level ${i}</option>`;
            dom.fountainSelectors.forEach(sel => sel.innerHTML = fountainOptions);
            let labOptions = ''; for (let i = 1; i <= 30; i++) labOptions += `<option value="${i}">Level ${i}</option>`;
            dom.calculator.labLevel.innerHTML = labOptions;

            const allInputs = [...dom.fountainSelectors, dom.calculator.currentWater, dom.calculator.labLevel, dom.fifthFountain.toggle];
            allInputs.forEach(input => {
                input.addEventListener('change', handleInputChange);
                if (input.type === 'number') input.addEventListener('keyup', handleInputChange);
            });

            // Alliance Filter Setup
            const allianceOptions = `
                <option value="All">All</option>
                <option value="none">None</option>
                <option value="THOR">THOR</option>
                <option value="fAfO">fAfO</option>
                <option value="HeRa">HeRa</option>
                <option value="pHNx">pHNx</option>
                <option value="TroW">TroW</option>
                <option value="VaLT">VaLT</option>
                <option value="Tone">Tone</option>
                <option value="COLD">COLD</option>
                <option value="DoM">DoM</option>
                <option value="MINI">MINI</option>
                <option value="MEGA">MEGA</option>
                <option value="Lat1">Lat1</option>
            `;
            dom.leaderboard.allianceFilter.innerHTML = allianceOptions;
            dom.leaderboard.allianceFilter.addEventListener('change', renderLeaderboard);
            
            const closeMobileMenu = () => {
                dom.nav.mobileMenu.classList.remove('open');
                dom.nav.menuOverlay.classList.add('hidden');
                dom.nav.menuOverlay.style.opacity = 0;
            };

            const navLinks = [...document.querySelectorAll('.nav-link')];
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    const pageId = e.currentTarget.getAttribute('data-page');
                    if (!pageId) return; // Don't do anything for non-page links like Language
                    e.preventDefault();
                    navLinks.forEach(l => {
                        if (l.getAttribute('data-page')) l.classList.remove('active');
                    });
                    document.querySelectorAll(`.nav-link[data-page='${pageId}']`).forEach(l => l.classList.add('active'));
                    Object.values(dom.pages).forEach(page => page.classList.add('hidden'));
                    dom.pages[pageId].classList.remove('hidden');
                    closeMobileMenu();
                });
            });

            dom.nav.hamburgerBtn.addEventListener('click', () => {
                dom.nav.mobileMenu.classList.add('open');
                dom.nav.menuOverlay.classList.remove('hidden');
                setTimeout(() => dom.nav.menuOverlay.style.opacity = 1, 10);
            });

            dom.nav.closeMenuBtn.addEventListener('click', closeMobileMenu);
            dom.nav.menuOverlay.addEventListener('click', closeMobileMenu);

            let isRegisterMode = false;
            function toggleAuthMode() {
                isRegisterMode = !isRegisterMode;
                const lang = localStorage.getItem('language') || 'en';
                dom.auth.form.reset();
                dom.auth.error.textContent = '';
                dom.auth.usernameField.classList.toggle('hidden', !isRegisterMode);
                dom.auth.allianceField.classList.toggle('hidden', !isRegisterMode);
                document.getElementById('username').required = isRegisterMode;
                dom.auth.confirmPasswordField.classList.toggle('hidden', !isRegisterMode);
                document.getElementById('confirm-password').required = isRegisterMode;
                
                dom.auth.title.textContent = getTranslation(isRegisterMode ? 'auth_register_title' : 'auth_login_title', lang);
                dom.auth.submitBtn.textContent = getTranslation(isRegisterMode ? 'auth_register_btn' : 'auth_login_btn', lang);
                dom.auth.toggleText.textContent = getTranslation(isRegisterMode ? 'auth_have_account' : 'auth_no_account', lang);
                dom.auth.toggleBtn.textContent = getTranslation(isRegisterMode ? 'auth_login_link' : 'auth_register_link', lang);
            }
            
            const openAuthModal = () => {
                closeMobileMenu();
                dom.auth.modal.classList.remove('hidden');
            };
            dom.auth.loginBtn.addEventListener('click', openAuthModal);
            dom.auth.loginBtnMobile.addEventListener('click', openAuthModal);
            dom.leaderboard.loginBtn.addEventListener('click', openAuthModal);

            const handleLogout = () => {
                signOut(auth);
                dom.profile.modal.classList.add('hidden'); // Close profile modal on logout
            };
            dom.profile.logoutBtn.addEventListener('click', handleLogout);
            
            dom.auth.modal.addEventListener('click', (e) => { if(e.target === dom.auth.modal) dom.auth.modal.classList.add('hidden'); });
            dom.auth.toggleBtn.addEventListener('click', toggleAuthMode);

            dom.auth.form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const pass = document.getElementById('password').value;
                dom.auth.error.textContent = '';
                if (isRegisterMode) {
                    const username = document.getElementById('username').value;
                    const alliance = document.getElementById('alliance-select').value;
                    const confirmPass = document.getElementById('confirm-password').value;
                    if (pass !== confirmPass) { dom.auth.error.textContent = 'Passwords do not match.'; return; }
                    if (username.length < 3) { dom.auth.error.textContent = 'Username must be at least 3 characters.'; return; }
                    try {
                        const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
                        await updateProfile(userCredential.user, { displayName: username });
                        const userData = { username: username, email: email, alliance: alliance, createdAt: new Date() };
                        await setDoc(doc(db, `artifacts/${appId}/users/${userCredential.user.uid}`), userData);
                        dom.auth.modal.classList.add('hidden');
                    } catch (error) { dom.auth.error.textContent = error.message.replace('Firebase: ', ''); }
                } else {
                    try {
                        await signInWithEmailAndPassword(auth, email, pass);
                        dom.auth.modal.classList.add('hidden');
                    } catch (error) { dom.auth.error.textContent = error.message.replace('Firebase: ', ''); }
                }
            });
            
            // Profile Modal Listeners
            dom.auth.userInfo.addEventListener('click', openProfileModal);
            dom.auth.userInfoMobile.addEventListener('click', openProfileModal);
            dom.profile.modal.addEventListener('click', (e) => { if(e.target === dom.profile.modal) dom.profile.modal.classList.add('hidden'); });
            dom.profile.avatarUploadBtn.addEventListener('click', () => dom.profile.avatarUpload.click());
            dom.profile.avatarUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    resizeImage(file, 150, 150, (dataUrl) => {
                        dom.profile.avatarPreview.src = dataUrl;
                    });
                }
            });

            dom.profile.form.addEventListener('submit', async (e) => {
                e.preventDefault();
                dom.profile.saveBtn.disabled = true;
                dom.profile.error.textContent = '';
                const user = auth.currentUser;
                if (!user) return;

                const newUsername = dom.profile.usernameInput.value;
                const newAlliance = dom.profile.allianceSelect.value;
                let newAvatarUrl = user.photoURL;

                try {
                    // 1. Upload avatar if it has changed
                    const avatarPreviewSrc = dom.profile.avatarPreview.src;
                    if (avatarPreviewSrc && !avatarPreviewSrc.startsWith('https')) { // It's a base64 string
                        const storageRef = ref(storage, `avatars/${user.uid}/avatar.jpg`);
                        const uploadResult = await uploadString(storageRef, avatarPreviewSrc, 'data_url');
                        newAvatarUrl = await getDownloadURL(uploadResult.ref);
                    }
                    
                    // 2. Update Auth Profile
                    await updateProfile(user, {
                        displayName: newUsername,
                        photoURL: newAvatarUrl
                    });

                    // 3. Update Firestore Documents
                    const privateDocRef = doc(db, `artifacts/${appId}/users/${user.uid}`);
                    await updateDoc(privateDocRef, {
                        username: newUsername,
                        alliance: newAlliance,
                        avatarUrl: newAvatarUrl
                    });
                    
                    const publicDocRef = doc(db, `artifacts/${appId}/public/data/playerData/${user.uid}`);
                    await updateDoc(publicDocRef, {
                        username: newUsername,
                        alliance: newAlliance,
                        avatarUrl: newAvatarUrl
                    });

                    state.alliance = newAlliance; // Update local state
                    showToast('profile_success');
                    dom.profile.modal.classList.add('hidden');

                } catch (error) {
                    console.error("Profile update error:", error);
                    dom.profile.error.textContent = error.message.replace('Firebase: ', '');
                } finally {
                    dom.profile.saveBtn.disabled = false;
                }
            });

            // Language Modal Listeners
            dom.language.openBtn.addEventListener('click', openLanguageModal);
            dom.language.openBtnMobile.addEventListener('click', (e) => {
                e.preventDefault();
                closeMobileMenu();
                openLanguageModal();
            });
            dom.language.closeBtn.addEventListener('click', closeLanguageModal);
            dom.language.modal.addEventListener('click', (e) => { if (e.target === dom.language.modal) closeLanguageModal(); });

            initializeCurrentLanguage();
            runCalculations();
            listenForPublicPlayerData(); // Always listen for leaderboard data regardless of auth state
        });
    </script>
</body>
</html>
