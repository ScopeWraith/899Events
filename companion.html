import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { 
    getAuth, 
    createUserWithEmailAndPassword, 
    signInWithEmailAndPassword, 
    signOut, 
    onAuthStateChanged,
    updateProfile
} from 'firebase/auth';
import { 
    getFirestore, 
    doc, 
    setDoc, 
    getDoc,
    collection,
    query,
    where,
    getDocs,
    updateDoc,
    deleteDoc
} from 'firebase/firestore';
import { 
    getStorage, 
    ref, 
    uploadBytes, 
    getDownloadURL 
} from "firebase/storage";
import { Shield, Users, Info, Annoyed, Gamepad2, LogIn, Menu, X, LogOut, UserCircle, ShieldCheck, Server as ServerIcon, Edit, Save, UploadCloud, AlertCircle } from 'lucide-react';

// --- Firebase Configuration ---
const firebaseConfig = {
  apiKey: "AIzaSyBq1dC_O1qj3WJz_6DWm8vBZfaEOZW6XoY",
  authDomain: "lastwar-alliancecompanion.firebaseapp.com",
  projectId: "lastwar-alliancecompanion",
  storageBucket: "lastwar-alliancecompanion.appspot.com",
  messagingSenderId: "591144202239",
  appId: "1:591144202239:web:88a724721d7ba5e7f941ca",
  measurementId: "G-6M3T2205Z4"
};

// --- Initialize Firebase ---
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app); // Initialize Firebase Storage

// --- Style Component for Theming ---
const GlobalStyles = () => (
    <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #020617; /* bg-slate-950 */
            background-image: radial-gradient(circle at top right, rgba(14, 165, 233, 0.1), transparent 40%),
                              radial-gradient(circle at bottom left, rgba(168, 85, 247, 0.1), transparent 50%);
        }
        .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }
        .card {
            background-color: rgba(30, 41, 59, 0.5); /* bg-slate-800/50 */
            backdrop-filter: blur(12px);
            border: 1px solid rgba(51, 65, 85, 0.5); /* border-slate-700/50 */
            position: relative;
        }
        .card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            border-radius: inherit;
            padding: 1px;
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.4), rgba(168, 85, 247, 0.4));
            -webkit-mask:
                linear-gradient(#fff 0 0) content-box,
                linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
        }
        .text-glow-cyan {
            text-shadow: 0 0 8px rgba(34, 211, 238, 0.9), 0 0 20px rgba(34, 211, 238, 0.7);
        }
    `}</style>
);


// --- Main App Component ---
export default function App() {
    const [user, setUser] = useState(null);
    const [loading, setLoading] = useState(true);
    const [userData, setUserData] = useState(null);
    const [appKey, setAppKey] = useState(0); // Add a key to force re-renders

    const refreshUserData = async () => {
        if (auth.currentUser) {
            const userDocRef = doc(db, "users", auth.currentUser.uid);
            const userDocSnap = await getDoc(userDocRef);
            if (userDocSnap.exists()) {
                setUserData(userDocSnap.data());
            }
            setAppKey(prevKey => prevKey + 1); // Increment key to trigger re-render
        }
    };

    useEffect(() => {
        const unsubscribe = onAuthStateChanged(auth, async (user) => {
            setUser(user);
            if (user) {
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    setUserData(userDocSnap.data());
                } else {
                    console.log("No such user document!");
                    setUserData(null);
                }
            } else {
                setUserData(null);
            }
            setLoading(false);
        });

        return () => unsubscribe();
    }, []);

    const handleLogout = async () => {
        try {
            await signOut(auth);
        } catch (error) {
            console.error("Error signing out: ", error);
        }
    };

    if (loading) {
        return (
            <div className="flex items-center justify-center min-h-screen bg-slate-950 text-white">
                <div className="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-cyan-500"></div>
            </div>
        );
    }

    return (
        <>
            <GlobalStyles />
            <div className="bg-slate-950 text-slate-200 min-h-screen" key={appKey}>
                {user ? (
                    <Dashboard user={user} userData={userData} onLogout={handleLogout} onProfileUpdate={refreshUserData} />
                ) : (
                    <AuthPage />
                )}
            </div>
        </>
    );
}

// --- Authentication Page ---
const AuthPage = () => {
    const [isLogin, setIsLogin] = useState(true);

    return (
        <div className="flex flex-col items-center justify-center min-h-screen p-4">
            <div className="card w-full max-w-md p-8 rounded-2xl shadow-2xl">
                <h1 className="text-4xl font-bold text-center text-white mb-2 font-orbitron text-glow-cyan">Last War</h1>
                <h2 className="text-2xl font-semibold text-center text-cyan-400 mb-6">Alliance Companion</h2>
                
                {isLogin ? <LoginForm /> : <SignUpForm />}

                <p className="mt-6 text-center text-slate-400">
                    {isLogin ? "Don't have an account?" : "Already have an account?"}
                    <button onClick={() => setIsLogin(!isLogin)} className="ml-2 font-semibold text-cyan-400 hover:text-cyan-300 transition-colors">
                        {isLogin ? "Sign Up" : "Log In"}
                    </button>
                </p>
            </div>
        </div>
    );
};

// --- Login Form ---
const LoginForm = () => {
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [error, setError] = useState('');

    const handleLogin = async (e) => {
        e.preventDefault();
        setError('');
        try {
            await signInWithEmailAndPassword(auth, email, password);
        } catch (err) {
            setError(err.message);
        }
    };

    return (
        <form onSubmit={handleLogin}>
            <div className="space-y-4">
                <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="Email Address" className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500" required />
                <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="Password" className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500" required />
            </div>
            {error && <p className="mt-4 text-sm text-red-400">{error}</p>}
            <button type="submit" className="w-full mt-6 py-3 bg-cyan-600 hover:bg-cyan-700 rounded-lg text-lg font-bold transition-all transform hover:scale-105">
                <LogIn className="inline-block mr-2" size={20} />
                Login
            </button>
        </form>
    );
};

// --- Sign Up Form ---
const SignUpForm = () => {
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [inGameName, setInGameName] = useState('');
    const [server, setServer] = useState('');
    const [alliance, setAlliance] = useState('');
    const [rank, setRank] = useState('R1');
    const [error, setError] = useState('');

    const handleSignUp = async (e) => {
        e.preventDefault();
        setError('');
        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;
            
            await updateProfile(user, { displayName: inGameName });

            const isVerified = ['R1', 'R2', 'R3'].includes(rank);

            await setDoc(doc(db, "users", user.uid), {
                uid: user.uid,
                inGameName,
                server,
                alliance,
                rank,
                rankVerified: isVerified,
                email: user.email,
                avatarUrl: '', // Start with an empty avatar URL
                createdAt: new Date(),
            });

        } catch (err) {
            setError(err.message);
        }
    };

    return (
        <form onSubmit={handleSignUp}>
            <div className="space-y-3">
                 <input type="text" value={inGameName} onChange={(e) => setInGameName(e.target.value)} placeholder="In-Game Name" className="w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500" required />
                 <input type="text" value={server} onChange={(e) => setServer(e.target.value)} placeholder="Server Number (e.g., 101)" className="w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500" required />
                 <input type="text" value={alliance} onChange={(e) => setAlliance(e.target.value)} placeholder="Alliance Tag (e.g., ABC)" className="w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500" required />
                 <select value={rank} onChange={(e) => setRank(e.target.value)} className="w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500">
                    <option value="R1">R1</option>
                    <option value="R2">R2</option>
                    <option value="R3">R3</option>
                    <option value="R4">R4 (Requires Verification)</option>
                    <option value="R5">R5 (Requires Verification)</option>
                 </select>
                 <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="Email Address" className="w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500" required />
                 <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="Password" className="w-full px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500" required />
            </div>
            {error && <p className="mt-4 text-sm text-red-400">{error}</p>}
            <button type="submit" className="w-full mt-6 py-3 bg-green-600 hover:bg-green-700 rounded-lg text-lg font-bold transition-all transform hover:scale-105">
                Create Account
            </button>
        </form>
    );
};


// --- Dashboard ---
const Dashboard = ({ user, userData, onLogout, onProfileUpdate }) => {
    const [activeView, setActiveView] = useState('Announcements');
    const [isSidebarOpen, setIsSidebarOpen] = useState(false);

    const navItems = [
        { name: 'Announcements', icon: Annoyed },
        { name: 'Member Info', icon: Users },
        { name: 'Alliance Info', icon: Shield },
        { name: 'Server Info', icon: ServerIcon },
        { name: 'Game Info', icon: Gamepad2 },
        { name: 'Profile', icon: UserCircle },
    ];
    
    if (userData?.isAdmin) navItems.push({ name: 'Admin', icon: ShieldCheck });
    if (userData?.rank === 'R5' && userData?.rankVerified) navItems.push({ name: 'Alliance Management', icon: Shield });

    const renderContent = () => {
        switch (activeView) {
            case 'Member Info': return <MemberInfoPage currentUserData={userData} />;
            case 'Alliance Info': return <AllianceInfoPage />;
            case 'Server Info': return <ServerInfoPage />;
            case 'Profile': return <ProfilePage user={user} userData={userData} onProfileUpdate={onProfileUpdate} />;
            case 'Admin': return <AdminPanel />;
            case 'Alliance Management': return <AllianceManagementPanel currentUserData={userData} />;
            default: return <ContentBox title={activeView}>Content for {activeView} goes here.</ContentBox>;
        }
    };
    
    const Sidebar = () => (
        <aside className={`card rounded-none md:rounded-2xl flex flex-col transition-all duration-300 ${isSidebarOpen ? 'w-64' : 'w-0'} md:w-64 overflow-hidden`}>
            <div className="flex items-center justify-center h-20 border-b border-slate-700/50">
                <Shield size={28} className="text-cyan-400" />
                <h1 className="text-xl font-bold ml-2 font-orbitron text-white">LWAC</h1>
            </div>
            <nav className="flex-1 p-2 space-y-1">
                {navItems.map(item => (
                    <button
                        key={item.name}
                        onClick={() => {
                            setActiveView(item.name);
                            if (isSidebarOpen) setIsSidebarOpen(false);
                        }}
                        className={`w-full flex items-center p-3 rounded-lg transition-colors text-slate-300 hover:bg-slate-700/30 hover:text-slate-100 ${activeView === item.name ? 'bg-cyan-500/10 text-cyan-400 border-l-4 border-cyan-400' : 'border-l-4 border-transparent'}`}
                    >
                        <item.icon className="mr-3" size={20} />
                        <span className="font-semibold">{item.name}</span>
                    </button>
                ))}
            </nav>
            <div className="p-4 border-t border-slate-700/50">
                <div className="flex items-center space-x-3">
                    <img src={userData?.avatarUrl || `https://placehold.co/40x40/1e293b/94a3b8?text=${(userData?.inGameName || 'U').charAt(0)}`} alt="Avatar" className="w-10 h-10 rounded-full bg-slate-700 object-cover" />
                    <div className="text-sm">
                        <p className="font-semibold text-white">{userData?.inGameName || user.displayName}</p>
                        <p className="text-slate-400">S: {userData?.server} | A: {userData?.alliance}</p>
                    </div>
                </div>
                <button onClick={onLogout} className="w-full flex items-center justify-center mt-4 px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg font-semibold transition-colors">
                    <LogOut className="mr-2" size={18} />
                    Logout
                </button>
            </div>
        </aside>
    );

    return (
        <div className="flex flex-col md:flex-row h-screen p-0 md:p-8 gap-8">
            <div className="md:hidden fixed top-4 left-4 z-20">
                <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="p-2 bg-slate-800/80 rounded-md backdrop-blur-sm">
                    {isSidebarOpen ? <X size={24} /> : <Menu size={24} />}
                </button>
            </div>
            
            <div className={`fixed inset-0 z-10 md:relative md:flex ${isSidebarOpen ? 'block' : 'hidden'} md:block`}>
                 <Sidebar />
            </div>

            <main className="flex-1 flex flex-col min-h-0">
                <header className="flex items-center justify-between md:justify-end h-20 px-6 md:hidden bg-slate-800/50">
                    <h1 className="text-xl font-bold font-orbitron text-white">{activeView}</h1>
                </header>
                <div className="p-4 md:p-0 flex-1">
                    {renderContent()}
                </div>
            </main>
        </div>
    );
};

// --- Image Resizing Utility ---
const resizeImage = (file, width, height) => {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                canvas.toBlob((blob) => {
                    resolve(blob);
                }, 'image/jpeg', 0.9); // Return as high-quality JPEG
            };
            img.onerror = (error) => reject(error);
        };
        reader.onerror = (error) => reject(error);
    });
};


// --- Profile Page ---
const ProfilePage = ({ user, userData, onProfileUpdate }) => {
    const [isEditing, setIsEditing] = useState(false);
    const [displayName, setDisplayName] = useState(userData?.inGameName || '');
    const [avatarFile, setAvatarFile] = useState(null);
    const [uploading, setUploading] = useState(false);
    const [previewUrl, setPreviewUrl] = useState(userData?.avatarUrl || '');
    const [error, setError] = useState('');

    useEffect(() => {
        setDisplayName(userData?.inGameName || '');
        setPreviewUrl(userData?.avatarUrl || '');
    }, [userData]);

    const handleFileChange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        // Validate file type
        const allowedTypes = ['image/jpeg', 'image/png'];
        if (!allowedTypes.includes(file.type)) {
            setError('Invalid file type. Please upload a JPG or PNG.');
            return;
        }
        setError('');
        setAvatarFile(file);
        setPreviewUrl(URL.createObjectURL(file));
    };

    const handleSave = async () => {
        if (!user) return;
        setUploading(true);
        setError('');

        let newAvatarUrl = userData.avatarUrl;

        if (avatarFile) {
            try {
                // Resize the image before uploading
                const resizedBlob = await resizeImage(avatarFile, 300, 300);
                const avatarRef = ref(storage, `avatars/${user.uid}/avatar.jpg`);
                
                const snapshot = await uploadBytes(avatarRef, resizedBlob);
                newAvatarUrl = await getDownloadURL(snapshot.ref);
            } catch (err) {
                console.error("Error uploading/resizing avatar:", err);
                setError('Failed to upload avatar. Please try again.');
                setUploading(false);
                return;
            }
        }

        try {
            const userDocRef = doc(db, "users", user.uid);
            await updateDoc(userDocRef, {
                inGameName: displayName,
                avatarUrl: newAvatarUrl,
            });
            if (auth.currentUser.displayName !== displayName) {
                await updateProfile(auth.currentUser, { displayName: displayName });
            }
            
            await onProfileUpdate(); // Callback to refresh App state
        } catch (err) {
            console.error("Error updating profile:", err);
            setError('Failed to save profile.');
        } finally {
            setUploading(false);
            setIsEditing(false);
        }
    };

    if (!userData) return <ContentBox title="Profile">Loading profile data...</ContentBox>;

    return (
        <ContentBox title="Your Profile">
            <div className="flex items-center justify-between mb-6">
                <h2 className="text-2xl font-bold text-white font-orbitron">{isEditing ? 'Edit Profile' : 'Profile Overview'}</h2>
                {!isEditing ? (
                    <button onClick={() => setIsEditing(true)} className="flex items-center bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors">
                        <Edit size={16} className="mr-2" /> Edit
                    </button>
                ) : (
                    <div className="flex items-center gap-2">
                        <button onClick={() => { setIsEditing(false); setError(''); setPreviewUrl(userData.avatarUrl); }} className="flex items-center bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors">
                            Cancel
                        </button>
                        <button onClick={handleSave} disabled={uploading} className="flex items-center bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors disabled:bg-slate-500">
                            <Save size={16} className="mr-2" /> {uploading ? 'Saving...' : 'Save Changes'}
                        </button>
                    </div>
                )}
            </div>

            {error && (
                <div className="bg-red-900/50 border border-red-700 text-red-300 p-3 rounded-lg mb-4 flex items-center">
                    <AlertCircle size={20} className="mr-3" />
                    {error}
                </div>
            )}

            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className="md:col-span-1 flex flex-col items-center">
                    <img src={previewUrl || `https://placehold.co/128x128/1e293b/94a3b8?text=${(displayName || 'U').charAt(0)}`} alt="Avatar" className="w-32 h-32 rounded-full bg-slate-700 mb-4 object-cover" />
                    {isEditing && (
                        <div className="w-full">
                            <label htmlFor="avatar-upload" className="w-full cursor-pointer flex items-center justify-center bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors">
                                <UploadCloud size={16} className="mr-2" /> Upload Avatar
                            </label>
                            <input id="avatar-upload" type="file" accept="image/jpeg, image/png" className="hidden" onChange={handleFileChange} />
                        </div>
                    )}
                </div>

                <div className="md:col-span-2 space-y-4">
                    <div>
                        <label className="text-sm font-semibold text-slate-400">In-Game Name</label>
                        {isEditing ? (
                            <input type="text" value={displayName} onChange={(e) => setDisplayName(e.target.value)} className="w-full mt-1 px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500" />
                        ) : (
                            <p className="text-lg text-white">{displayName}</p>
                        )}
                    </div>
                    <div><label className="text-sm font-semibold text-slate-400">Email</label><p className="text-lg text-white">{userData.email}</p></div>
                    <div><label className="text-sm font-semibold text-slate-400">Server</label><p className="text-lg text-white">{userData.server}</p></div>
                    <div><label className="text-sm font-semibold text-slate-400">Alliance</label><p className="text-lg text-white">{userData.alliance}</p></div>
                    <div>
                        <label className="text-sm font-semibold text-slate-400">Rank</label>
                        <p className="text-lg text-white flex items-center">{userData.rank} 
                             {userData.rankVerified ? 
                                <span className="ml-2 text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-green-600 bg-green-200">Verified</span> : 
                                <span className="ml-2 text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-yellow-600 bg-yellow-200">Pending</span>
                            }
                        </p>
                    </div>
                </div>
            </div>
        </ContentBox>
    );
};


// --- Table Component ---
const InfoTable = ({ headers, data }) => (
    <div className="overflow-x-auto">
        <table className="min-w-full bg-slate-800/30 rounded-lg">
            <thead>
                <tr className="bg-slate-700/50">
                    {headers.map(header => (
                        <th key={header} className="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">{header}</th>
                    ))}
                </tr>
            </thead>
            <tbody className="divide-y divide-slate-700/50">
                {data.map((row, rowIndex) => (
                    <tr key={rowIndex} className="hover:bg-slate-700/40">
                        {row.map((cell, cellIndex) => (
                            <td key={cellIndex} className="px-6 py-4 whitespace-nowrap text-sm text-slate-200">{cell}</td>
                        ))}
                    </tr>
                ))}
            </tbody>
        </table>
    </div>
);

// --- Member Info Page ---
const MemberInfoPage = ({ currentUserData }) => {
    const [members, setMembers] = useState([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        if (!currentUserData) return;
        const fetchMembers = async () => {
            setLoading(true);
            const q = query(collection(db, "users"), where("server", "==", currentUserData.server), where("alliance", "==", currentUserData.alliance));
            const querySnapshot = await getDocs(q);
            const memberList = querySnapshot.docs.map(doc => doc.data());
            setMembers(memberList);
            setLoading(false);
        };
        fetchMembers();
    }, [currentUserData]);

    const tableHeaders = ["Avatar", "In-Game Name", "Rank", "Status"];
    const tableData = members.map(m => [
        <img src={m.avatarUrl || `https://placehold.co/32x32/1e293b/94a3b8?text=${m.inGameName.charAt(0)}`} alt="avatar" className="w-8 h-8 rounded-full bg-slate-700 object-cover" />,
        m.inGameName,
        m.rank,
        m.rankVerified ? 
            <span className="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-green-600 bg-green-200">Verified</span> : 
            <span className="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-yellow-600 bg-yellow-200">Pending</span>
    ]);

    return (
        <ContentBox title={`Alliance Members - [${currentUserData?.alliance}]`}>
            {loading ? <p>Loading members...</p> : <InfoTable headers={tableHeaders} data={tableData} />}
        </ContentBox>
    );
};

// --- Other Pages (Alliance, Server, Admin, etc.) - Theming applied ---
const AllianceInfoPage = () => {
    const [alliances, setAlliances] = useState([]);
    const [loading, setLoading] = useState(true);
    useEffect(() => {
        const fetchAlliances = async () => {
            setLoading(true);
            const querySnapshot = await getDocs(collection(db, "users"));
            const uniqueAlliances = querySnapshot.docs.reduce((acc, doc) => {
                const { server, alliance } = doc.data();
                const key = `${server}-${alliance}`;
                if (!acc.has(key)) acc.set(key, { server, alliance });
                return acc;
            }, new Map());
            setAlliances(Array.from(uniqueAlliances.values()));
            setLoading(false);
        };
        fetchAlliances();
    }, []);
    const tableHeaders = ["Server", "Alliance Tag"];
    const tableData = alliances.map(a => [a.server, a.alliance]);
    return <ContentBox title="Registered Alliances">{loading ? <p>Loading...</p> : <InfoTable headers={tableHeaders} data={tableData} />}</ContentBox>;
};

const ServerInfoPage = () => {
    const [servers, setServers] = useState([]);
    const [loading, setLoading] = useState(true);
    useEffect(() => {
        const fetchServers = async () => {
            setLoading(true);
            const querySnapshot = await getDocs(collection(db, "users"));
            const uniqueServers = new Set(querySnapshot.docs.map(doc => doc.data().server));
            setServers(Array.from(uniqueServers));
            setLoading(false);
        };
        fetchServers();
    }, []);
    const tableHeaders = ["Server Number"];
    const tableData = servers.map(s => [s]);
    return <ContentBox title="Registered Servers">{loading ? <p>Loading...</p> : <InfoTable headers={tableHeaders} data={tableData} />}</ContentBox>;
};

const AdminPanel = () => {
    const [pendingR5s, setPendingR5s] = useState([]);
    const [loading, setLoading] = useState(true);
    const fetchPendingR5s = async () => {
        setLoading(true);
        const q = query(collection(db, "users"), where("rank", "==", "R5"), where("rankVerified", "==", false));
        const querySnapshot = await getDocs(q);
        setPendingR5s(querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        setLoading(false);
    };
    useEffect(() => { fetchPendingR5s(); }, []);
    const handleVerification = async (userId, approve) => {
        const userDocRef = doc(db, "users", userId);
        if (approve) await updateDoc(userDocRef, { rankVerified: true });
        else await deleteDoc(userDocRef);
        fetchPendingR5s(); 
    };
    return <ContentBox title="Admin - R5 Verification">{loading ? <p>Loading...</p> : (pendingR5s.length > 0 ? <div className="space-y-4">{pendingR5s.map(user => (<div key={user.id} className="bg-slate-700/50 p-4 rounded-lg flex items-center justify-between"><div><p className="font-bold text-white">{user.inGameName}</p><p className="text-sm text-slate-400">Server: {user.server} | Alliance: {user.alliance}</p></div><div className="space-x-2"><button onClick={() => handleVerification(user.id, true)} className="bg-green-600 hover:bg-green-700 px-3 py-1 rounded-md text-sm font-semibold">Approve</button><button onClick={() => handleVerification(user.id, false)} className="bg-red-600 hover:bg-red-700 px-3 py-1 rounded-md text-sm font-semibold">Deny</button></div></div>))}</div> : <p>No pending R5 verifications.</p>)}</ContentBox>;
};

const AllianceManagementPanel = ({ currentUserData }) => {
    const [pendingR4s, setPendingR4s] = useState([]);
    const [loading, setLoading] = useState(true);
    const fetchPendingR4s = async () => {
        if (!currentUserData) return;
        setLoading(true);
        const q = query(collection(db, "users"), where("alliance", "==", currentUserData.alliance), where("server", "==", currentUserData.server), where("rank", "==", "R4"), where("rankVerified", "==", false));
        const querySnapshot = await getDocs(q);
        setPendingR4s(querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        setLoading(false);
    };
    useEffect(() => { fetchPendingR4s(); }, [currentUserData]);
    const handleVerification = async (userId, approve) => {
        const userDocRef = doc(db, "users", userId);
        if (approve) await updateDoc(userDocRef, { rankVerified: true });
        else await deleteDoc(userDocRef);
        fetchPendingR4s();
    };
    return <ContentBox title="Alliance Management - R4 Verification">{loading ? <p>Loading...</p> : (pendingR4s.length > 0 ? <div className="space-y-4">{pendingR4s.map(user => (<div key={user.id} className="bg-slate-700/50 p-4 rounded-lg flex items-center justify-between"><div><p className="font-bold text-white">{user.inGameName}</p><p className="text-sm text-slate-400">Rank: {user.rank}</p></div><div className="space-x-2"><button onClick={() => handleVerification(user.id, true)} className="bg-green-600 hover:bg-green-700 px-3 py-1 rounded-md text-sm font-semibold">Approve</button><button onClick={() => handleVerification(user.id, false)} className="bg-red-600 hover:bg-red-700 px-3 py-1 rounded-md text-sm font-semibold">Deny</button></div></div>))}</div> : <p>No pending R4 verifications in your alliance.</p>)}</ContentBox>;
};

// --- Content Box Component ---
const ContentBox = ({ title, children }) => {
    return (
        <div className="card w-full h-full p-6 rounded-2xl">
            <h2 className="text-2xl font-bold text-white font-orbitron mb-4 text-glow-cyan">{title}</h2>
            <div className="text-slate-300">
                {children}
            </div>
        </div>
    );
};
