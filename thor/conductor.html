<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Train Conductor Selector</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background: #0f172a; /* bg-slate-900 */
        }
        .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }
        .card {
            background-color: rgba(30, 41, 59, 0.5); /* bg-slate-800/50 */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(51, 65, 85, 0.5); /* border-slate-700/50 */
            border-radius: 1rem;
            display: flex;
            flex-direction: column;
        }
        .conductor-reveal {
            animation: reveal 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
        }
        @keyframes reveal {
            0% { letter-spacing: -0.5em; opacity: 0; }
            40% { opacity: 0.6; }
            100% { letter-spacing: normal; opacity: 1; }
        }
        .item-enter {
            animation: item-enter 0.5s ease-out;
        }
        @keyframes item-enter {
            0% { opacity: 0; transform: scale(0.95) translateY(10px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* Loading Spinner */
        .loader {
            border: 4px solid #334155; /* border-slate-700 */
            border-top: 4px solid #06b6d4; /* border-cyan-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tab-btn {
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
            padding-bottom: 0.25rem;
            color: #94a3b8; /* text-slate-400 */
        }
        .tab-btn:hover {
             color: #e2e8f0; /* text-slate-200 */
        }
        .tab-btn.active {
            color: #06b6d4; /* text-cyan-500 */
            border-bottom-color: #06b6d4;
            font-weight: 600;
        }
        .text-glow {
            text-shadow: 0 0 5px rgba(250, 204, 21, 0.6), 0 0 15px rgba(250, 204, 21, 0.4);
        }
    </style>
</head>
<body class="text-slate-300">

    <div id="loading-overlay" class="fixed inset-0 bg-slate-900/80 flex flex-col items-center justify-center z-50 transition-opacity duration-300">
        <div class="loader"></div>
        <p class="mt-4 text-lg text-slate-300">Connecting to Database...</p>
    </div>

    <div class="min-h-screen p-4 flex flex-col items-center">
        <header class="text-center w-full max-w-xl mx-auto mb-6">
            <h1 class="font-orbitron text-3xl md:text-4xl font-bold text-cyan-400">CONDUCTOR APP</h1>
        </header>

        <main class="w-full max-w-xl mx-auto">
            <div class="card p-4 md:p-6">
                <!-- Conductor Display -->
                <div class="relative mb-3">
                    <h2 class="text-xl font-bold text-yellow-400 text-center text-glow">Today's Conductor</h2>
                     <button id="info-button" class="absolute top-0 right-0 text-slate-400 hover:text-cyan-400 transition-colors" title="Luck System Info">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </button>
                </div>
                <div id="conductor-display" class="bg-slate-900/70 rounded-lg p-4 min-h-[100px] flex items-center justify-center text-center">
                    <span id="conductor-name" class="font-orbitron text-2xl md:text-3xl font-bold text-slate-500 transition-colors duration-300">SELECT A CONDUCTOR</span>
                </div>

                <!-- Action Buttons -->
                <div id="action-buttons-container" class="mt-4">
                    <div id="random-buttons-container" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <button id="random-select-button" class="w-full bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm transition-all transform hover:scale-[1.02] focus:outline-none focus:ring-4 focus:ring-cyan-300/50">
                            CHOOSE RANDOMLY
                        </button>
                        <button id="leader-select-button" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm transition-all transform hover:scale-[1.02] focus:outline-none focus:ring-4 focus:ring-purple-300/50">
                            CHOOSE LEADER
                        </button>
                    </div>
                     <div id="lock-in-container" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <button id="cancel-lock-in-button" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm transition-all transform hover:scale-[1.02] focus:outline-none focus:ring-4 focus:ring-slate-400/50">
                            CANCEL
                        </button>
                        <button id="lock-in-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm transition-all transform hover:scale-[1.02] focus:outline-none focus:ring-4 focus:ring-green-300/50">
                            LOCK IN CONDUCTOR
                        </button>
                    </div>
                </div>

                <!-- Tabbed Lists -->
                <div class="mt-6">
                    <!-- Tab Buttons -->
                    <div class="border-b border-slate-700 flex space-x-4">
                        <button id="tab-manual-pick" class="tab-btn active">Manual Pick</button>
                        <button id="tab-history" class="tab-btn">History</button>
                    </div>

                    <!-- Tab Content -->
                    <div class="mt-3">
                        <!-- Manual Pick Content -->
                        <div id="content-manual-pick">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-base font-bold text-white">Alliance Members</h3>
                                <button id="add-member-button" class="text-cyan-400 hover:text-cyan-300 transition-colors" title="Add new member">
                                   <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                </button>
                            </div>
                            <div id="manual-pick-list-container" class="space-y-1 custom-scrollbar pr-2 overflow-y-auto" style="max-height: 200px;"></div>
                        </div>

                        <!-- History Content -->
                        <div id="content-history" class="hidden">
                             <div class="mb-2">
                                <input type="text" id="history-search-input" placeholder="Search player history..." class="w-full bg-slate-800/60 border border-slate-600 rounded-lg px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-cyan-400">
                             </div>
                             <div id="history-list-container" class="space-y-1 custom-scrollbar pr-2 overflow-y-auto" style="max-height: 220px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="info-modal" class="hidden fixed inset-0 bg-slate-900/80 flex items-center justify-center z-50">
        <div class="card p-6 w-full max-w-md relative">
             <button id="close-info-modal-btn" class="absolute top-4 right-4 text-slate-400 hover:text-white">&times;</button>
            <h2 class="text-xl font-bold text-white mb-4">Luck System Information</h2>
            <div class="text-sm space-y-4 text-slate-300 custom-scrollbar pr-2 overflow-y-auto" style="max-height: 60vh;">
                <p>The random selection process is weighted by a "Luck" percentage. A player's total luck increases their chances of being chosen.</p>
                <div>
                    <h3 class="font-semibold text-cyan-400 mb-1">Rank Luck (Permanent)</h3>
                    <ul class="list-disc list-inside space-y-1">
                        <li><span class="font-semibold">R2:</span> +5% Luck</li>
                        <li><span class="font-semibold">R3:</span> +7% Luck</li>
                        <li><span class="font-semibold">R4:</span> +10% Luck</li>
                    </ul>
                </div>
                 <div>
                    <h3 class="font-semibold text-cyan-400 mb-1">Medal Luck (30 Day Duration)</h3>
                    <ul class="list-disc list-inside space-y-1">
                        <li><span class="font-semibold">VS Gold:</span> +20% Luck</li>
                        <li><span class="font-semibold">VS Silver:</span> +18% Luck</li>
                        <li><span class="font-semibold">VS Bronze:</span> +15% Luck</li>
                        <li><span class="font-semibold">Alliance Star - Gold:</span> +15% Luck</li>
                        <li><span class="font-semibold">Alliance Star - Silver:</span> +12% Luck</li>
                        <li><span class="font-semibold">Alliance Star - Bronze:</span> +10% Luck</li>
                        <li><span class="font-semibold">Alliance Donator - 1st:</span> +10% Luck</li>
                        <li><span class="font-semibold">Alliance Donator - 2nd:</span> +8% Luck</li>
                        <li><span class="font-semibold">Alliance Donator - 3rd:</span> +5% Luck</li>
                         <li><span class="font-semibold">Desert Storm Team A - MVP:</span> +5% Luck</li>
                        <li><span class="font-semibold">Desert Storm Team B - MVP:</span> +5% Luck</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div id="add-modal" class="hidden fixed inset-0 bg-slate-900/80 flex items-center justify-center z-50">
        <div class="card p-6 w-full max-w-sm">
            <h2 class="text-xl font-bold text-white mb-4">Add New Member</h2>
            <div class="space-y-4">
                <div>
                    <label for="add-name-input" class="block text-sm font-medium text-slate-300">Name</label>
                    <input type="text" id="add-name-input" class="mt-1 w-full bg-slate-700/50 border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-400">
                </div>
                <div>
                    <label for="add-rank-select" class="block text-sm font-medium text-slate-300">Rank</label>
                    <select id="add-rank-select" class="mt-1 w-full bg-slate-700/50 border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-400">
                        <option>R1</option> <option>R2</option> <option>R3</option> <option>R4</option> <option>R5</option>
                    </select>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-add-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg text-sm">Cancel</button>
                <button id="save-add-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Save Member</button>
            </div>
        </div>
    </div>
    <div id="edit-modal" class="hidden fixed inset-0 bg-slate-900/80 flex items-center justify-center z-50">
        <div class="card p-6 w-full max-w-md">
             <h2 class="text-xl font-bold text-white mb-4">Edit Member</h2>
            <div class="space-y-4">
                <div>
                    <label for="edit-name-input" class="block text-sm font-medium text-slate-300">Name</label>
                    <input type="text" id="edit-name-input" class="mt-1 w-full bg-slate-700/50 border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-400">
                </div>
                <div>
                    <label for="edit-rank-select" class="block text-sm font-medium text-slate-300">Rank</label>
                    <select id="edit-rank-select" class="mt-1 w-full bg-slate-700/50 border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-400">
                        <option>R1</option> <option>R2</option> <option>R3</option> <option>R4</option> <option>R5</option>
                    </select>
                </div>
                <div class="border-t border-slate-700 pt-4">
                    <label for="award-medal-select" class="block text-sm font-medium text-slate-300">Award a Medal (30 Day Bonus)</label>
                    <div class="flex gap-2 mt-1">
                        <select id="award-medal-select" class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-400"></select>
                        <button id="award-medal-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold px-4 rounded-lg text-sm">Award</button>
                    </div>
                </div>
                 <div>
                    <h3 class="text-sm font-medium text-slate-300">Active Medals</h3>
                    <div id="active-medals-list" class="mt-2 space-y-2"></div>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-edit-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg text-sm">Done</button>
                <button id="save-edit-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-sm">Save Name/Rank</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        document.addEventListener('DOMContentLoaded', async () => {
            // --- CONSTANTS ---
            const RANK_LUCK = { 'R2': 5, 'R3': 7, 'R4': 10 };
            const MEDAL_LUCK = {
                'VS Gold': 20, 'VS Silver': 18, 'VS Bronze': 15,
                'Desert Storm Team A - MVP': 5, 'Desert Storm Team B - MVP': 5,
                'Alliance Star - Gold': 15, 'Alliance Star - Silver': 12, 'Alliance Star - Bronze': 10,
                'Alliance Donator - 1st': 10, 'Alliance Donator - 2nd': 8, 'Alliance Donator - 3rd': 5,
            };
            const leadershipTeam = ["Cindelll", "Ms Andrea", "Squeeze1", "Drewstroyer", "Dumpchicken", "MattCat 맷 더 캣", "KBL50", "SimBLÅNK", "BLÅNK", "LÅDY", "ScopeWraith"];
            const leadershipCooldownDays = 14;
            const memberCooldownDays = 30;

            // --- ELEMENTS ---
            const loadingOverlay = document.getElementById('loading-overlay');
            const historyListContainer = document.getElementById('history-list-container');
            const conductorNameSpan = document.getElementById('conductor-name');
            const randomSelectButton = document.getElementById('random-select-button');
            const leaderSelectButton = document.getElementById('leader-select-button');
            const lockInButton = document.getElementById('lock-in-button');
            const cancelLockInButton = document.getElementById('cancel-lock-in-button');
            const lockInContainer = document.getElementById('lock-in-container');
            const randomButtonsContainer = document.getElementById('random-buttons-container');
            const addMemberButton = document.getElementById('add-member-button');
            const manualPickListContainer = document.getElementById('manual-pick-list-container');
            const tabManualPick = document.getElementById('tab-manual-pick');
            const tabHistory = document.getElementById('tab-history');
            const contentManualPick = document.getElementById('content-manual-pick');
            const contentHistory = document.getElementById('content-history');
            const historySearchInput = document.getElementById('history-search-input');
            const addModal = document.getElementById('add-modal');
            const addNameInput = document.getElementById('add-name-input');
            const addRankSelect = document.getElementById('add-rank-select');
            const saveAddBtn = document.getElementById('save-add-btn');
            const cancelAddBtn = document.getElementById('cancel-add-btn');
            const editModal = document.getElementById('edit-modal');
            const editNameInput = document.getElementById('edit-name-input');
            const editRankSelect = document.getElementById('edit-rank-select');
            const saveEditBtn = document.getElementById('save-edit-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const awardMedalSelect = document.getElementById('award-medal-select');
            const awardMedalBtn = document.getElementById('award-medal-btn');
            const activeMedalsList = document.getElementById('active-medals-list');
            const infoButton = document.getElementById('info-button');
            const infoModal = document.getElementById('info-modal');
            const closeInfoModalBtn = document.getElementById('close-info-modal-btn');

            // --- LOCAL STATE ---
            let allianceMembers = [];
            let selectionHistory = [];
            let currentConductor = 'SELECT A CONDUCTOR';
            let previewConductor = null;
            let memberToEditId = null;
            let db, docRef;

            // --- FIREBASE SETUP ---
            async function initializeFirebase() {
                try {
                    const firebaseConfig = {
                      apiKey: "AIzaSyBL9GRWKf15wDTYdguYnQtU28WblgqT5jE",
                      authDomain: "allianceconductor.firebaseapp.com",
                      projectId: "allianceconductor",
                      storageBucket: "allianceconductor.appspot.com",
                      messagingSenderId: "650853696222",
                      appId: "1:650853696222:web:a3c418857558336bee384f"
                    };
                    
                    const docId = 'conductor-selector-data';
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    const auth = getAuth(app);
                    
                    await signInAnonymously(auth);

                    const collectionPath = `conductors`;
                    docRef = doc(db, collectionPath, docId);

                    onSnapshot(docRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            allianceMembers = (data.members || []).map((member, index) => {
                                if (typeof member === 'string') {
                                    return { id: Date.now() + index, name: member, rank: 'R1', medals: [] };
                                }
                                return { ...member, id: member.id || Date.now() + index, medals: member.medals || [] };
                            });
                            selectionHistory = (data.history || []).map((item, index) => ({
                                ...item,
                                id: item.id || Date.now() + index 
                            }));
                            currentConductor = data.currentConductor || 'SELECT A CONDUCTOR';
                        } else {
                            console.log("No data found in Firestore. Initializing with default data.");
                            initializeDefaultData();
                        }
                        renderAll();
                        loadingOverlay.style.opacity = '0';
                        setTimeout(() => loadingOverlay.style.display = 'none', 300);
                    });

                } catch (error) {
                    console.error("Firebase Initialization Error:", error);
                    loadingOverlay.innerHTML = `<p class="text-red-400 text-center">Connection Failed.<br>Please check console for errors.</p>`;
                }
            }

            // --- DATA MANAGEMENT ---
            async function updateFirestore() {
                if (!docRef) return;
                try {
                    await setDoc(docRef, { 
                        members: allianceMembers, 
                        history: selectionHistory,
                        currentConductor: currentConductor
                    });
                } catch (error) {
                    console.error("Error updating Firestore:", error);
                }
            }

            function initializeDefaultData() {
                allianceMembers = ["13Edy13", "Aceman12", "Aheleosthe2nd", "AirForester", "Andre Rabelo", "Anthony 69", "Arghonut 모험가", "atalon", "aZzIel", "Bamslang", "Basow", "Beezees", "Belleroo", "Bettel nerd", "B L Ä N K", "bobo1987 보보", "CaeTaka", "CaptainObviouss", "Chan 찬", "Chefjuanpi", "Churchill JAPABR", "Cindelll", "Curty Mc", "Dauntethemechanic", "DARS MILK", "Dino1311", "Dollystroyer", "DontWorryDaddysHere", "Drewstroyer", "Duck0311", "Dumpchicken", "Ender", "foxzilla", "Gangster 25", "General Bjam", "Grande Anão", "GPêê", "Guerneros del Chaco", "Gunbarista", "Hadrianswall", "ilovecafs", "Isorryl", "jessictia", "Jmelo1686", "JojoBans", "JTWolf", "KAYRONMAN", "KBL50", "Keylonis", "Kitt3nnnn", "LÄDY", "Leccarré", "leoyutian", "likes2ride", "LION 1937", "MÄXIMÜS", "MattCat 맷 더 캣", "Mayhem007", "Maz·Ibrahim.ч", "MICH3773", "MotoM0t0", "Mr Peaches", "Ms Andrea", "n3tt1k", "NinerGang211", "NikolaiVolkoff", "NoShtSherlock 셜록", "NyahNyah메롱", "Peacekëeper", "PewnurScope", "Ratatoui11e", "Reb13", "Risssy", "Robert ツ", "ScopeWraith", "scrap11", "SHAMAN ЛЮТЬ", "Shbeda", "SimBLÄ NK", "SimplyMom", "SniperXT3", "SN0WMan", "Squeeze1", "st ALBA", "SuperElectron Bioman", "techwrath", "TeeOhiNwhY", "The Palette", "Tigerfan1", "turtletime 거북이", "uJeam", "UrSwigBoaBro", "VENOM THENEW CARNAGE", "Vuladi", "Warrior Poet", "Whedonite92", "Xelaesor", "Zerrrro", "윤스 oops", "에녹 · Enoch"]
                .map((name, index) => ({ id: Date.now() + index, name: name, rank: 'R1', medals: [] }));
                selectionHistory = [{ player: "Rat", date: "06-26", id: Date.now()+1 }, { player: "Lecarre", date: "06-25", id: Date.now()+2 }, { player: "MagicalMike (AllDayDad)", date: "06-24", id: Date.now()+3 }];
                currentConductor = 'SELECT A CONDUCTOR';
                updateFirestore();
            }

            // --- RENDER FUNCTIONS ---
            function populateMedalSelect() {
                awardMedalSelect.innerHTML = `<option value="">Select a medal...</option>`;
                for (const medalName in MEDAL_LUCK) {
                    const option = document.createElement('option');
                    option.value = medalName;
                    option.textContent = medalName;
                    awardMedalSelect.appendChild(option);
                }
            }
            const renderManualPickList = () => {
                manualPickListContainer.innerHTML = '';
                const sortedMembers = [...allianceMembers].sort((a, b) => a.name.localeCompare(b.name));

                sortedMembers.forEach((member) => {
                    const div = document.createElement('div');
                    div.className = 'item-enter flex justify-between items-center p-2 rounded-lg hover:bg-slate-700/50 transition-colors duration-200 group text-sm';
                    
                    const now = Date.now();
                    const activeMedals = member.medals.filter(m => m.expires > now);
                    let medalIcons = '';
                    if (activeMedals.length > 0) {
                        medalIcons = `<span class="text-xs ml-2">${activeMedals.map(m => '🏅').join('')}</span>`;
                    }

                    div.innerHTML = `
                        <button class="flex-grow text-left manual-pick-btn" data-name="${member.name}">
                            <span class="font-semibold">${member.name}</span>
                            <span class="text-xs text-slate-400 ml-2">${member.rank}</span>
                            ${medalIcons}
                        </button>
                        <div class="flex items-center space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button class="edit-member-btn text-slate-400 hover:text-cyan-400" data-id="${member.id}" title="Edit member">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                            </button>
                            <button class="delete-member-btn text-slate-400 hover:text-red-400" data-id="${member.id}" title="Delete member">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                    `;
                    manualPickListContainer.appendChild(div);
                });
            };
            const renderHistory = () => {
                const searchTerm = historySearchInput.value.toLowerCase();
                historyListContainer.innerHTML = '';
                 const sortedHistory = [...selectionHistory].sort((a, b) => {
                    const dateA = new Date(`2000-${a.date.replace('-', '/')}`);
                    const dateB = new Date(`2000-${b.date.replace('-', '/')}`);
                    return dateB - dateA;
                 });

                const filteredHistory = sortedHistory.filter(item => 
                    item.player.toLowerCase().includes(searchTerm)
                );

                filteredHistory.forEach((item) => {
                    const div = document.createElement('div');
                    div.className = 'item-enter flex justify-between items-center p-2 rounded-lg hover:bg-slate-700/50 transition-colors duration-200 group text-sm';
                    div.innerHTML = `
                        <p class="font-semibold text-white truncate pr-2">${item.player}</p>
                        <div class="flex items-center space-x-2 flex-shrink-0">
                            <p class="text-xs text-slate-400">${item.date}</p>
                            <button class="delete-history-btn text-slate-500 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity" data-id="${item.id}" title="Delete history entry">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                    `;
                    historyListContainer.appendChild(div);
                });
            };
            const renderConductor = () => {
                if (currentConductor && currentConductor !== 'SELECT A CONDUCTOR') {
                    conductorNameSpan.textContent = currentConductor;
                    conductorNameSpan.classList.remove('text-slate-500', 'text-cyan-400');
                    conductorNameSpan.classList.add('text-yellow-400', 'conductor-reveal', 'text-glow');
                    conductorNameSpan.addEventListener('animationend', () => conductorNameSpan.classList.remove('conductor-reveal'), { once: true });
                } else {
                    conductorNameSpan.textContent = 'SELECT A CONDUCTOR';
                    conductorNameSpan.classList.remove('text-yellow-400', 'text-glow', 'text-cyan-400');
                    conductorNameSpan.classList.add('text-slate-500');
                }
            };
            const renderActiveMedals = () => {
                if (memberToEditId === null) return;
                const member = allianceMembers.find(m => m.id === memberToEditId);
                activeMedalsList.innerHTML = '';
                if (!member || member.medals.length === 0) {
                    activeMedalsList.innerHTML = `<p class="text-xs text-slate-400 italic">No active medals.</p>`;
                    return;
                }
                member.medals.forEach(medal => {
                    const now = Date.now();
                    const daysLeft = Math.ceil((medal.expires - now) / (1000 * 60 * 60 * 24));
                    if (daysLeft <= 0) return;

                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center bg-slate-700/50 p-2 rounded-md';
                    div.innerHTML = `
                        <div>
                            <p class="text-sm font-semibold text-white">${medal.name}</p>
                            <p class="text-xs text-slate-400">Expires in ${daysLeft} day(s)</p>
                        </div>
                        <button class="remove-medal-btn text-red-500 hover:text-red-400" data-medal-id="${medal.id}" title="Remove Medal">&times;</button>
                    `;
                    activeMedalsList.appendChild(div);
                });
            };
            const renderAll = () => {
                renderManualPickList();
                renderHistory();
                renderConductor();
            };

            // --- LUCK CALCULATION ---
            const calculateTotalLuck = (member) => {
                let totalLuck = 0;
                totalLuck += RANK_LUCK[member.rank] || 0;
                const now = Date.now();
                member.medals.forEach(medal => {
                    if (medal.expires > now) {
                        totalLuck += MEDAL_LUCK[medal.name] || 0;
                    }
                });
                return totalLuck;
            };

            // --- UI STATE MANAGEMENT ---
            function showLockInMode(name) {
                previewConductor = name;
                conductorNameSpan.textContent = name;
                conductorNameSpan.classList.remove('text-yellow-400', 'text-glow', 'text-slate-500');
                conductorNameSpan.classList.add('text-cyan-400');
                randomButtonsContainer.classList.add('hidden');
                lockInContainer.classList.remove('hidden');
            }
            function showRandomMode() {
                previewConductor = null;
                renderConductor();
                randomButtonsContainer.classList.remove('hidden');
                lockInContainer.classList.add('hidden');
            }

            // --- CORE LOGIC & EVENT HANDLERS ---
            const selectRandomly = (pool, buttonToUpdate) => {
                showRandomMode();
                if (pool.length === 0) return;
                
                randomSelectButton.disabled = true;
                leaderSelectButton.disabled = true;
                buttonToUpdate.textContent = 'CHOOSING...';

                const now = new Date();
                const eligibleByCooldown = pool.filter(member => {
                    const memberName = typeof member === 'object' ? member.name : member;
                    const memberHistory = selectionHistory.filter(h => h.player === memberName).sort((a, b) => new Date(`2000-${b.date.replace('-', '/')}`) - new Date(`2000-${a.date.replace('-', '/')}`));
                    if (memberHistory.length === 0) return true;
                    const lastSelection = memberHistory[0];
                    const lastDate = new Date(now.getFullYear(), parseInt(lastSelection.date.split('-')[0]) - 1, parseInt(lastSelection.date.split('-')[1]));
                    if (now < lastDate) lastDate.setFullYear(now.getFullYear() - 1);
                    const diffTime = now - lastDate;
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                    const isLeader = leadershipTeam.includes(memberName);
                    const cooldown = isLeader ? leadershipCooldownDays : memberCooldownDays;
                    return diffDays >= cooldown;
                });
                
                const selectionPool = eligibleByCooldown.length > 0 ? eligibleByCooldown : pool;

                const weightedPool = selectionPool.map(member => {
                    const memberObject = typeof member === 'object' ? member : allianceMembers.find(m => m.name === member);
                    const luck = memberObject ? calculateTotalLuck(memberObject) : 0;
                    return { member: memberObject || {name: member}, weight: 100 + luck };
                });

                const totalWeight = weightedPool.reduce((sum, item) => sum + item.weight, 0);
                let randomWeight = Math.random() * totalWeight;
                let winner = weightedPool[weightedPool.length - 1].member;

                for(const item of weightedPool) {
                    randomWeight -= item.weight;
                    if (randomWeight <= 0) {
                        winner = item.member;
                        break;
                    }
                }
                
                let drumRollCount = 0;
                const drumRollInterval = setInterval(() => {
                    const randomIndex = Math.floor(Math.random() * selectionPool.length);
                    const memberName = typeof selectionPool[randomIndex] === 'object' ? selectionPool[randomIndex].name : selectionPool[randomIndex];
                    conductorNameSpan.textContent = memberName;
                    conductorNameSpan.classList.remove('text-yellow-400', 'text-glow');
                    conductorNameSpan.classList.add('text-cyan-400');
                    if (++drumRollCount > 15) {
                        clearInterval(drumRollInterval);
                        
                        currentConductor = winner.name;
                        
                        const today = new Date();
                        const dateStr = `${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                        selectionHistory.unshift({ player: winner.name, date: dateStr, id: Date.now() });
                        
                        updateFirestore();
                        
                        randomSelectButton.disabled = false;
                        leaderSelectButton.disabled = false;
                        randomSelectButton.textContent = 'CHOOSE RANDOMLY';
                        leaderSelectButton.textContent = 'CHOOSE LEADER';
                    }
                }, 100);
            };
            
            addMemberButton.addEventListener('click', () => {
                addNameInput.value = '';
                addRankSelect.value = 'R1';
                addModal.classList.remove('hidden');
            });
            manualPickListContainer.addEventListener('click', (e) => {
                const pickBtn = e.target.closest('.manual-pick-btn');
                if (pickBtn) showLockInMode(pickBtn.dataset.name);

                const editBtn = e.target.closest('.edit-member-btn');
                if (editBtn) {
                    memberToEditId = parseFloat(editBtn.dataset.id);
                    const member = allianceMembers.find(m => m.id === memberToEditId);
                    if (member) {
                        editNameInput.value = member.name;
                        editRankSelect.value = member.rank;
                        renderActiveMedals();
                        editModal.classList.remove('hidden');
                    }
                }
                const deleteBtn = e.target.closest('.delete-member-btn');
                if (deleteBtn) {
                    const idToDelete = parseFloat(deleteBtn.dataset.id);
                    allianceMembers = allianceMembers.filter(m => m.id !== idToDelete);
                    updateFirestore();
                }
            });
            lockInButton.addEventListener('click', () => {
                if(previewConductor) {
                    currentConductor = previewConductor;
                    const today = new Date();
                    const dateStr = `${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                    selectionHistory.unshift({ player: currentConductor, date: dateStr, id: Date.now() });
                    updateFirestore();
                    showRandomMode();
                }
            });
            cancelLockInButton.addEventListener('click', showRandomMode);
            historyListContainer.addEventListener('click', (e) => {
                 const deleteButton = e.target.closest('.delete-history-btn');
                 if (deleteButton) {
                    const idToDelete = parseFloat(deleteButton.dataset.id);
                    selectionHistory = selectionHistory.filter(item => item.id !== idToDelete);
                    updateFirestore();
                 }
            });
            saveAddBtn.addEventListener('click', () => {
                const newName = addNameInput.value.trim();
                if (newName && !allianceMembers.some(m => m.name === newName)) {
                    allianceMembers.push({ id: Date.now(), name: newName, rank: addRankSelect.value, medals: [] });
                    updateFirestore();
                    addModal.classList.add('hidden');
                } else if (newName) alert("A member with this name already exists.");
            });
            cancelAddBtn.addEventListener('click', () => addModal.classList.add('hidden'));
            addModal.addEventListener('click', (e) => { if (e.target.id === 'add-modal') cancelAddBtn.click(); });
            
            saveEditBtn.addEventListener('click', () => {
                if (memberToEditId) {
                    const memberIndex = allianceMembers.findIndex(m => m.id === memberToEditId);
                    if (memberIndex > -1) {
                        allianceMembers[memberIndex].name = editNameInput.value.trim();
                        allianceMembers[memberIndex].rank = editRankSelect.value;
                        updateFirestore();
                    }
                }
            });
            awardMedalBtn.addEventListener('click', () => {
                const memberIndex = allianceMembers.findIndex(m => m.id === memberToEditId);
                const medalName = awardMedalSelect.value;
                if(memberIndex > -1 && medalName) {
                    const expires = Date.now() + (30 * 24 * 60 * 60 * 1000);
                    allianceMembers[memberIndex].medals.push({ id: Date.now(), name: medalName, expires: expires });
                    renderActiveMedals();
                    updateFirestore();
                }
            });
            activeMedalsList.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-medal-btn');
                if (removeBtn && memberToEditId) {
                    const medalId = parseFloat(removeBtn.dataset.medalId);
                    const memberIndex = allianceMembers.findIndex(m => m.id === memberToEditId);
                    if(memberIndex > -1) {
                        allianceMembers[memberIndex].medals = allianceMembers[memberIndex].medals.filter(m => m.id !== medalId);
                        renderActiveMedals();
                        updateFirestore();
                    }
                }
            });
            cancelEditBtn.addEventListener('click', () => {
                editModal.classList.add('hidden');
                memberToEditId = null;
            });
            editModal.addEventListener('click', (e) => { if (e.target.id === 'edit-modal') cancelEditBtn.click(); });
            
            infoButton.addEventListener('click', () => infoModal.classList.remove('hidden'));
            closeInfoModalBtn.addEventListener('click', () => infoModal.classList.add('hidden'));
            infoModal.addEventListener('click', (e) => { if (e.target.id === 'info-modal') infoModal.classList.add('hidden'); });

            tabManualPick.addEventListener('click', () => {
                tabManualPick.classList.add('active');
                tabHistory.classList.remove('active');
                contentManualPick.classList.remove('hidden');
                contentHistory.classList.add('hidden');
            });
            tabHistory.addEventListener('click', () => {
                tabHistory.classList.add('active');
                tabManualPick.classList.remove('active');
                contentHistory.classList.remove('hidden');
                contentManualPick.classList.add('hidden');
            });
            
            historySearchInput.addEventListener('input', renderHistory);
            randomSelectButton.addEventListener('click', () => selectRandomly(allianceMembers, randomSelectButton));
            leaderSelectButton.addEventListener('click', () => selectRandomly(leadershipTeam, leaderSelectButton));

            // --- INITIALIZATION ---
            populateMedalSelect();
            initializeFirebase();
        });
    </script>
</body>
</html>
