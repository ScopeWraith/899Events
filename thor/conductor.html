<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Train Conductor Selector</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #020617; /* bg-slate-950 */
            background-image: radial-gradient(circle at top right, rgba(14, 165, 233, 0.15), transparent 40%),
                              radial-gradient(circle at bottom left, rgba(168, 85, 247, 0.15), transparent 50%);
        }
        .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }
        .card {
            background-color: rgba(30, 41, 59, 0.5); /* bg-slate-800/50 */
            backdrop-filter: blur(12px);
            border: 1px solid rgba(51, 65, 85, 0.5); /* border-slate-700/50 */
            border-radius: 1.5rem; /* Increased rounding */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* To contain the bottom nav */
        }
        /* Aurora border effect */
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 1.5rem;
            padding: 1px;
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.4), rgba(168, 85, 247, 0.4));
            -webkit-mask: 
                linear-gradient(#fff 0 0) content-box, 
                linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            z-index: -1;
        }
        .conductor-reveal {
            animation: reveal 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
        }
        @keyframes reveal {
            0% { letter-spacing: -0.5em; opacity: 0; }
            40% { opacity: 0.6; }
            100% { letter-spacing: normal; opacity: 1; }
        }
        .item-enter {
            animation: item-enter 0.5s ease-out;
        }
        @keyframes item-enter {
            0% { opacity: 0; transform: scale(0.95) translateY(10px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* Loading Spinner */
        .loader {
            border: 4px solid #334155; /* border-slate-700 */
            border-top: 4px solid #06b6d4; /* border-cyan-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .nav-btn {
            transition: all 0.3s ease;
            color: #94a3b8; /* text-slate-400 */
            position: relative;
        }
        .nav-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 2px;
            background-color: #06b6d4;
            transition: width 0.3s ease;
        }
        .nav-btn.active {
            color: #06b6d4; /* text-cyan-500 */
        }
        .nav-btn.active::after {
            width: 50%;
        }
        .text-glow-gold {
            text-shadow: 0 0 8px rgba(250, 204, 21, 0.9), 0 0 20px rgba(250, 204, 21, 0.7);
        }
        .text-glow-cyan {
            text-shadow: 0 0 8px rgba(34, 211, 238, 0.9), 0 0 20px rgba(34, 211, 238, 0.7);
        }
        
        /* Auth Visibility Control */
        .logged-out .admin-control {
            display: none !important;
        }
        .logged-in .login-button {
             display: none !important;
        }
        .logged-out .logout-button {
            display: none !important;
        }

    </style>
</head>
<body class="text-slate-300 logged-out">

    <div id="loading-overlay" class="fixed inset-0 bg-slate-900/80 flex flex-col items-center justify-center z-50 transition-opacity duration-300">
        <div class="loader"></div>
        <p class="mt-4 text-lg text-slate-300">Connecting to Database...</p>
    </div>

    <div class="min-h-screen p-4 sm:pt-8 flex flex-col items-center">
        <main class="w-full max-w-md mx-auto">
            <div class="card">
                <div class="p-4 md:p-6">
                    <!-- Conductor Display -->
                    <div class="relative mb-3">
                        <h2 class="text-2xl font-bold text-white text-center text-glow-cyan">Today's Conductor</h2>
                    </div>
                    <div id="conductor-display" class="bg-slate-900/70 rounded-lg p-4 min-h-[90px] flex items-center justify-center text-center">
                        <span id="conductor-name" class="font-orbitron text-3xl md:text-4xl font-bold text-slate-500 transition-colors duration-300">SELECT A CONDUCTOR</span>
                    </div>

                    <!-- Action Buttons -->
                    <div id="action-buttons-container" class="admin-control mt-4">
                        <div id="random-buttons-container" class="grid grid-cols-1">
                            <button id="random-select-button" class="w-full bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md text-sm transition-all transform hover:scale-[1.02] focus:outline-none focus:ring-4 focus:ring-cyan-300/50">
                                CHOOSE CONDUCTOR
                            </button>
                        </div>
                         <div id="pending-buttons-container" class="hidden grid grid-cols-2 gap-3">
                            <button id="substitute-button" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 px-4 rounded-lg shadow-md text-sm transition-all transform hover:scale-[1.02] focus:outline-none focus:ring-4 focus:ring-slate-400/50">
                                SUBSTITUTE
                            </button>
                            <button id="lock-in-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-md text-sm transition-all transform hover:scale-[1.02] focus:outline-none focus:ring-4 focus:ring-green-300/50">
                                LOCK IN
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tab Navigation -->
                <div class="mt-2 border-b border-t border-slate-700">
                    <div class="grid grid-cols-3 text-center">
                        <button id="tab-manual-pick" class="nav-btn p-3 flex flex-col items-center justify-center">
                            <svg class="w-5 h-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197"></path></svg>
                            <span class="text-xs font-semibold">Members</span>
                        </button>
                        <button id="tab-history" class="nav-btn active p-3 flex flex-col items-center justify-center">
                            <svg class="w-5 h-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <span class="text-xs font-semibold">History</span>
                        </button>
                        <button id="tab-medals" class="nav-btn p-3 flex flex-col items-center justify-center">
                            <svg class="w-5 h-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path></svg>
                            <span class="text-xs font-semibold">Medals</span>
                        </button>
                    </div>
                </div>
                
                <!-- Tab Content -->
                <div class="p-4 flex-grow min-h-[250px]">
                    <div id="content-manual-pick" class="hidden">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-base font-bold text-white">Alliance Members</h3>
                            <button id="add-member-button" class="admin-control text-cyan-400 hover:text-cyan-300 transition-colors" title="Add new member">
                               <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </button>
                        </div>
                        <div id="manual-pick-list-container" class="space-y-1 custom-scrollbar pr-2 overflow-y-auto" style="max-height: 250px;"></div>
                    </div>
                    <div id="content-history">
                         <div class="flex items-center mb-2">
                            <input type="text" id="history-search-input" placeholder="Search player history..." class="w-full bg-slate-800/60 border border-slate-600 rounded-lg px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-cyan-400">
                            <button id="add-history-button" class="admin-control ml-2 text-cyan-400 hover:text-cyan-300" title="Add history entry">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </button>
                         </div>
                         <div id="history-list-container" class="space-y-1 custom-scrollbar pr-2 overflow-y-auto" style="max-height: 220px;"></div>
                    </div>
                    <div id="content-medals" class="hidden">
                        <div class="flex justify-between items-center mb-3">
                             <h3 class="text-base font-bold text-white">Active Medals</h3>
                             <button id="open-award-medal-modal-btn" class="admin-control bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-1 px-3 rounded-lg text-xs flex items-center space-x-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path></svg>
                                 <span>Award Medals</span>
                             </button>
                        </div>
                        <div id="medals-list-container" class="space-y-2 custom-scrollbar pr-2 overflow-y-auto" style="max-height: 220px;"></div>
                    </div>
                </div>
                 <!-- Auth Footer -->
                <div class="p-4 border-t border-slate-700/50 mt-auto flex items-center justify-between space-x-4">
                    <button id="read-me-button" class="text-slate-400 hover:text-cyan-400 font-bold py-2 px-4 rounded-lg text-xs transition-colors flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span>Read Me</span>
                    </button>
                    <div class="flex-grow text-right">
                        <button id="open-login-modal-btn" class="login-button bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg text-xs transition-colors">Admin Login</button>
                        <button id="logout-button" class="logout-button bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-xs transition-colors">Logout</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="login-modal" class="hidden fixed inset-0 bg-slate-950/90 flex items-center justify-center z-50">
        <div class="card p-6 w-full max-w-sm">
            <h2 class="text-xl font-bold text-white mb-4 text-center">Admin Login</h2>
            <div class="space-y-4">
                <div>
                    <label for="username-input" class="block text-sm font-medium text-slate-300">Username</label>
                    <input type="text" id="username-input" class="mt-1 w-full bg-slate-700/50 border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-400">
                </div>
                <div>
                    <label for="password-input" class="block text-sm font-medium text-slate-300">Password</label>
                    <input type="password" id="password-input" class="mt-1 w-full bg-slate-700/50 border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-400">
                </div>
                <p id="login-error-msg" class="text-xs text-red-400 h-4 text-center"></p>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-login-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg text-sm">Cancel</button>
                <button id="login-button" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Login</button>
            </div>
        </div>
    </div>
     <div id="confirmation-modal" class="hidden fixed inset-0 bg-slate-900/80 flex items-center justify-center z-50">
        <div class="card p-6 w-full max-w-sm text-center">
            <h2 id="confirmation-title" class="text-lg font-bold text-white mb-4">Are you sure?</h2>
            <p id="confirmation-message" class="text-sm text-slate-300 mb-6">This action cannot be undone.</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded-lg text-sm">Cancel</button>
                <button id="confirm-action-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg text-sm">Confirm</button>
            </div>
        </div>
    </div>
    <div id="add-history-modal" class="hidden fixed inset-0 bg-slate-900/80 flex items-center justify-center z-50">
        <div class="card p-6 w-full max-w-sm">
            <h2 class="text-xl font-bold text-white mb-4">Add History Entry</h2>
            <div class="space-y-4">
                <div>
                    <label for="add-history-player-select" class="block text-sm font-medium text-slate-300">Player</label>
                    <select id="add-history-player-select" class="mt-1 w-full bg-slate-700/50 border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-400"></select>
                </div>
                <div>
                    <label for="add-history-date-input" class="block text-sm font-medium text-slate-300">Date (MM-DD)</label>
                    <input type="text" id="add-history-date-input" class="mt-1 w-full bg-slate-700/50 border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-400">
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-add-history-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg text-sm">Cancel</button>
                <button id="save-add-history-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Save Entry</button>
            </div>
        </div>
    </div>
    <div id="add-modal" class="hidden fixed inset-0 bg-slate-900/80 flex items-center justify-center z-50">
        <div class="card p-6 w-full max-w-sm">
            <h2 class="text-xl font-bold text-white mb-4">Add New Member</h2>
            <div class="space-y-4">
                <div>
                    <label for="add-name-input" class="block text-sm font-medium text-slate-300">Name</label>
                    <input type="text" id="add-name-input" class="mt-1 w-full bg-slate-700/50 border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-400">
                </div>
                <div>
                    <label for="add-rank-select" class="block text-sm font-medium text-slate-300">Rank</label>
                    <select id="add-rank-select" class="mt-1 w-full bg-slate-700/50 border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-400">
                        <option>R1</option> <option>R2</option> <option>R3</option> <option>R4</option> <option>R5</option>
                    </select>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-add-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg text-sm">Cancel</button>
                <button id="save-add-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Save Member</button>
            </div>
        </div>
    </div>
    <div id="edit-modal" class="hidden fixed inset-0 bg-slate-900/80 flex items-center justify-center z-50">
        <div class="card p-6 w-full max-w-md">
             <h2 class="text-xl font-bold text-white mb-4">Edit Member</h2>
            <div class="space-y-4">
                <div>
                    <label for="edit-name-input" class="block text-sm font-medium text-slate-300">Name</label>
                    <input type="text" id="edit-name-input" class="mt-1 w-full bg-slate-700/50 border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-400">
                </div>
                <div>
                    <label for="edit-rank-select" class="block text-sm font-medium text-slate-300">Rank</label>
                    <select id="edit-rank-select" class="mt-1 w-full bg-slate-700/50 border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-400">
                        <option>R1</option> <option>R2</option> <option>R3</option> <option>R4</option> <option>R5</option>
                    </select>
                </div>
                <div class="border-t border-slate-700 pt-4">
                    <label for="award-medal-select" class="block text-sm font-medium text-slate-300">Award a Medal (30 Day Bonus)</label>
                    <div class="flex gap-2 mt-1">
                        <select id="award-medal-select" class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-400"></select>
                        <button id="award-medal-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold px-4 rounded-lg text-sm">Award</button>
                    </div>
                </div>
                 <div>
                    <h3 class="text-sm font-medium text-slate-300">Active Medals</h3>
                    <div id="active-medals-list" class="mt-2 space-y-2"></div>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-edit-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg text-sm">Done</button>
                <button id="save-edit-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-sm">Save Name/Rank</button>
            </div>
        </div>
    </div>
    
    <!-- New Award Medal Modal -->
    <div id="award-medal-modal" class="hidden fixed inset-0 bg-slate-900/80 flex items-center justify-center z-50">
        <div class="card p-6 w-full max-w-sm">
            <h2 class="text-xl font-bold text-white mb-4">Award a Medal</h2>
            <div class="space-y-4">
                <div>
                    <label for="award-medal-member-select" class="block text-sm font-medium text-slate-300">Member</label>
                    <select id="award-medal-member-select" class="mt-1 w-full bg-slate-700/50 border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-400"></select>
                </div>
                <div>
                    <label for="award-medal-type-select" class="block text-sm font-medium text-slate-300">Medal</label>
                    <select id="award-medal-type-select" class="mt-1 w-full bg-slate-700/50 border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-400"></select>
                </div>
                <p id="award-medal-validation-msg" class="text-xs text-yellow-400 h-4"></p>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-award-medal-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg text-sm">Cancel</button>
                <button id="save-award-medal-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg text-sm disabled:bg-slate-600 disabled:cursor-not-allowed" disabled>Award Medal</button>
            </div>
        </div>
    </div>

    <!-- Read Me Modal -->
    <div id="read-me-modal" class="hidden fixed inset-0 bg-slate-950/90 flex items-center justify-center z-50">
        <div class="card p-6 w-full max-w-lg">
            <h2 class="text-2xl font-bold text-white mb-4 text-center font-orbitron">Read Me</h2>
            <div class="text-sm space-y-4 text-slate-300 custom-scrollbar pr-2 overflow-y-auto" style="max-height: 70vh;">
                 <div>
                    <h3 class="font-semibold text-cyan-400 mb-1 text-lg">How It Works</h3>
                    <p>This tool is designed to select a "Train Conductor" from a pool of alliance members based on a weighted random selection. The goal is to create a fair and balanced rotation.</p>
                    <ul class="list-disc list-inside space-y-1 mt-2">
                        <li>An admin must log in to perform actions like choosing a conductor, editing members, or awarding medals.</li>
                        <li>The selection process considers member rank and active medals to calculate a "luck" score, which influences their chance of being picked.</li>
                        <li>After a member is chosen, they enter a cooldown period based on their rank, during which they cannot be selected again.</li>
                        <li>Certain medals can reduce this cooldown period.</li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-semibold text-cyan-400 mb-1 text-lg">Rank Cooldown Rules</h3>
                    <ul class="list-disc list-inside space-y-1">
                        <li><span class="font-semibold">R1 Members:</span> 120 day cooldown.</li>
                        <li><span class="font-semibold">R2 Members:</span> 90 day cooldown.</li>
                        <li><span class="font-semibold">R3 Members:</span> 60 day cooldown.</li>
                        <li><span class="font-semibold">R4 Members:</span> 45 day cooldown.</li>
                        <li><span class="font-semibold">R5 Members:</span> 40 day cooldown.</li>
                    </ul>
                    <p class="pt-2 italic text-xs">Note: If all members are on cooldown, these rules are ignored and everyone is eligible.</p>
                </div>
                <div id="read-me-cooldown-reduction">
                    <h3 class="font-semibold text-cyan-400 mb-1 text-lg">Medal Cooldown Reductions</h3>
                    <p>Earning the following medals will reduce a player's remaining conductor cooldown by the specified percentage:</p>
                    <ul class="list-disc list-inside space-y-1 mt-2">
                        <!-- This will be populated by script -->
                    </ul>
                </div>
                <div>
                    <h3 class="font-semibold text-cyan-400 mb-1 text-lg">Rank Luck (Permanent)</h3>
                     <p>Higher ranks receive a permanent luck bonus, increasing their chances of being selected when eligible.</p>
                    <ul class="list-disc list-inside space-y-1 mt-2">
                        <li><span class="font-semibold">R2:</span> +10% Luck</li>
                        <li><span class="font-semibold">R3:</span> +20% Luck</li>
                        <li><span class="font-semibold">R4:</span> +30% Luck</li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-semibold text-cyan-400 mb-1 text-lg">Medal Luck (30 Day Duration)</h3>
                    <p>Awarded medals provide a temporary luck bonus for 30 days.</p>
                    <ul class="list-disc list-inside space-y-1 mt-2" id="read-me-medal-luck-list">
                        <!-- This will be populated by script -->
                    </ul>
                </div>
            </div>
             <div class="mt-6 flex justify-end">
                <button id="close-read-me-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-6 rounded-lg text-sm">Close</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        document.addEventListener('DOMContentLoaded', async () => {
            // --- CONFIGURATION ---
            const CONFIG = {
                RANK_LUCK: { 'R2': 10, 'R3': 20, 'R4': 30 },
                MEDAL_LUCK: {
                    'VS Gold': 20, 'VS Silver': 18, 'VS Bronze': 15,
                    'Desert Storm Team A - MVP': 5, 'Desert Storm Team B - MVP': 5,
                    'Alliance Star - Gold': 15, 'Alliance Star - Silver': 12, 'Alliance Star - Bronze': 10,
                    'Alliance Donator - 1st': 10, 'Alliance Donator - 2nd': 8, 'Alliance Donator - 3rd': 5,
                },
                RANK_COOLDOWN: { 'R1': 120, 'R2': 90, 'R3': 60, 'R4': 45, 'R5': 40 },
                MEDAL_COOLDOWN_REDUCTION: {
                    'VS Gold': 0.30,
                    'VS Silver': 0.20,
                    'VS Bronze': 0.10,
                    'Desert Storm Team A - MVP': 0.15,
                    'Desert Storm Team B - MVP': 0.15,
                    'Alliance Star - Gold': 0.10,
                    'Alliance Donator - 1st': 0.20,
                    'Alliance Donator - 2nd': 0.15,
                    'Alliance Donator - 3rd': 0.10,
                }
            };

            // --- ELEMENTS ---
            const loadingOverlay = document.getElementById('loading-overlay');
            const historyListContainer = document.getElementById('history-list-container');
            const conductorNameSpan = document.getElementById('conductor-name');
            const randomSelectButton = document.getElementById('random-select-button');
            const lockInButton = document.getElementById('lock-in-button');
            const substituteButton = document.getElementById('substitute-button');
            const pendingButtonsContainer = document.getElementById('pending-buttons-container');
            const randomButtonsContainer = document.getElementById('random-buttons-container');
            const addMemberButton = document.getElementById('add-member-button');
            const manualPickListContainer = document.getElementById('manual-pick-list-container');
            const tabManualPick = document.getElementById('tab-manual-pick');
            const tabHistory = document.getElementById('tab-history');
            const tabMedals = document.getElementById('tab-medals');
            const contentManualPick = document.getElementById('content-manual-pick');
            const contentHistory = document.getElementById('content-history');
            const contentMedals = document.getElementById('content-medals');
            const historySearchInput = document.getElementById('history-search-input');
            const addHistoryButton = document.getElementById('add-history-button');
            const addHistoryModal = document.getElementById('add-history-modal');
            const addHistoryPlayerSelect = document.getElementById('add-history-player-select');
            const addHistoryDateInput = document.getElementById('add-history-date-input');
            const saveAddHistoryBtn = document.getElementById('save-add-history-btn');
            const cancelAddHistoryBtn = document.getElementById('cancel-add-history-btn');
            const addModal = document.getElementById('add-modal');
            const addNameInput = document.getElementById('add-name-input');
            const addRankSelect = document.getElementById('add-rank-select');
            const saveAddBtn = document.getElementById('save-add-btn');
            const cancelAddBtn = document.getElementById('cancel-add-btn');
            const editModal = document.getElementById('edit-modal');
            const editNameInput = document.getElementById('edit-name-input');
            const editRankSelect = document.getElementById('edit-rank-select');
            const saveEditBtn = document.getElementById('save-edit-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const awardMedalSelect = document.getElementById('award-medal-select');
            const awardMedalBtn = document.getElementById('award-medal-btn');
            const activeMedalsList = document.getElementById('active-medals-list');
            const medalsListContainer = document.getElementById('medals-list-container');
            const confirmationModal = document.getElementById('confirmation-modal');
            const confirmationTitle = document.getElementById('confirmation-title');
            const confirmationMessage = document.getElementById('confirmation-message');
            const confirmActionBtn = document.getElementById('confirm-action-btn');
            const confirmCancelBtn = document.getElementById('confirm-cancel-btn');

            // Award Medal Modal Elements
            const openAwardMedalModalBtn = document.getElementById('open-award-medal-modal-btn');
            const awardMedalModal = document.getElementById('award-medal-modal');
            const awardMedalMemberSelect = document.getElementById('award-medal-member-select');
            const awardMedalTypeSelect = document.getElementById('award-medal-type-select');
            const awardMedalValidationMsg = document.getElementById('award-medal-validation-msg');
            const saveAwardMedalBtn = document.getElementById('save-award-medal-btn');
            const cancelAwardMedalBtn = document.getElementById('cancel-award-medal-btn');

            // Auth Elements
            const loginModal = document.getElementById('login-modal');
            const loginButton = document.getElementById('login-button');
            const openLoginModalBtn = document.getElementById('open-login-modal-btn');
            const cancelLoginBtn = document.getElementById('cancel-login-btn');
            const logoutButton = document.getElementById('logout-button');
            const usernameInput = document.getElementById('username-input');
            const passwordInput = document.getElementById('password-input');
            const loginErrorMsg = document.getElementById('login-error-msg');

            // Read Me Modal Elements
            const readMeButton = document.getElementById('read-me-button');
            const readMeModal = document.getElementById('read-me-modal');
            const closeReadMeBtn = document.getElementById('close-read-me-btn');

            // --- LOCAL STATE ---
            let allianceMembers = [];
            let selectionHistory = [];
            let currentConductor = 'SELECT A CONDUCTOR';
            let pendingConductor = null;
            let memberToEditId = null;
            let db, docRef;
            let confirmCallback = null;
            let isAuthenticated = false;

            // --- FIREBASE SETUP ---
            async function initializeFirebase() {
                try {
                    const firebaseConfig = {
                      apiKey: "AIzaSyBL9GRWKf15wDTYdguYnQtU28WblgqT5jE",
                      authDomain: "allianceconductor.firebaseapp.com",
                      projectId: "allianceconductor",
                      storageBucket: "allianceconductor.appspot.com",
                      messagingSenderId: "650853696222",
                      appId: "1:650853696222:web:a3c418857558336bee384f"
                    };
                    
                    const docId = 'conductor-selector-data';
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    const auth = getAuth(app);
                    
                    await signInAnonymously(auth);

                    const collectionPath = `conductors`;
                    docRef = doc(db, collectionPath, docId);

                    onSnapshot(docRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            allianceMembers = (data.members || []).map((member, index) => {
                                if (typeof member === 'string') {
                                    return { id: Date.now() + index, name: member, rank: 'R1', medals: [] };
                                }
                                const medals = (member.medals || []).map(m => ({
                                    ...m,
                                    id: m.id || Date.now() + Math.random(),
                                    awardedDate: m.awardedDate || m.expires - (30 * 24 * 60 * 60 * 1000)
                                }));
                                return { ...member, id: member.id || Date.now() + index, medals: medals };
                            });
                            selectionHistory = (data.history || []).map((item, index) => ({
                                ...item,
                                id: item.id || Date.now() + index 
                            }));
                            currentConductor = data.currentConductor || 'SELECT A CONDUCTOR';
                        } else {
                            console.log("No data found in Firestore. Initializing with default data.");
                            initializeDefaultData();
                        }
                        renderAll();
                        loadingOverlay.style.opacity = '0';
                        setTimeout(() => loadingOverlay.style.display = 'none', 300);
                    });

                } catch (error) {
                    console.error("Firebase Initialization Error:", error);
                    loadingOverlay.innerHTML = `<p class="text-red-400 text-center">Connection Failed.<br>Please check console for errors.</p>`;
                }
            }

            // --- DATA MANAGEMENT ---
            async function updateFirestore() {
                if (!isAuthenticated) {
                    console.log("Not authenticated. Skipping Firestore update.");
                    return;
                }
                if (!docRef) return;
                try {
                    await setDoc(docRef, { 
                        members: allianceMembers, 
                        history: selectionHistory,
                        currentConductor: currentConductor
                    });
                } catch (error) {
                    console.error("Error updating Firestore:", error);
                }
            }

            function initializeDefaultData() {
                allianceMembers = ["13Edy13", "Aceman12", "Aheleosthe2nd", "AirForester", "Andre Rabelo", "Anthony 69", "Arghonut 모험가", "atalon", "aZzIel", "Bamslang", "Basow", "Beezees", "Belleroo", "Bettel nerd", "B L Ä N K", "bobo1987 보보", "CaeTaka", "CaptainObviouss", "Chan 찬", "Chefjuanpi", "Churchill JAPABR", "Cindelll", "Curty Mc", "Dauntethemechanic", "DARS MILK", "Dino1311", "Dollystroyer", "DontWorryDaddysHere", "Drewstroyer", "Duck0311", "Dumpchicken", "Ender", "foxzilla", "Gangster 25", "General Bjam", "Grande Anão", "GPêê", "Guerneros del Chaco", "Gunbarista", "Hadrianswall", "ilovecafs", "Isorryl", "jessictia", "Jmelo1686", "JojoBans", "JTWolf", "KAYRONMAN", "KBL50", "Keylonis", "Kitt3nnnn", "LÄDY", "Leccarré", "leoyutian", "likes2ride", "LION 1937", "MÄXIMÜS", "MattCat 맷 더 캣", "Mayhem007", "Maz·Ibrahim.ч", "MICH3773", "MotoM0t0", "Mr Peaches", "Ms Andrea", "n3tt1k", "NinerGang211", "NikolaiVolkoff", "NoShtSherlock 셜록", "NyahNyah메롱", "Peacekëeper", "PewnurScope", "Ratatoui11e", "Reb13", "Risssy", "Robert ツ", "ScopeWraith", "scrap11", "SHAMAN ЛЮТЬ", "Shbeda", "SimBLÄ NK", "SimplyMom", "SniperXT3", "SN0WMan", "Squeeze1", "st ALBA", "SuperElectron Bioman", "techwrath", "TeeOhiNwhY", "The Palette", "Tigerfan1", "turtletime 거북이", "uJeam", "UrSwigBoaBro", "VENOM THENEW CARNAGE", "Vuladi", "Warrior Poet", "Whedonite92", "Xelaesor", "Zerrrro", "윤스 oops", "에녹 · Enoch"]
                .map((name, index) => ({ id: Date.now() + index, name: name, rank: 'R1', medals: [] }));
                selectionHistory = [{ player: "Rat", date: "06-26", id: Date.now()+1 }, { player: "Lecarre", date: "06-25", id: Date.now()+2 }, { player: "MagicalMike (AllDayDad)", date: "06-24", id: Date.now()+3 }];
                currentConductor = 'SELECT A CONDUCTOR';
                if (isAuthenticated) updateFirestore();
            }
            
            function awardMedal(memberId, medalName) {
                const memberIndex = allianceMembers.findIndex(m => m.id === memberId);
                if (memberIndex > -1) {
                    const member = allianceMembers[memberIndex];
                    const now = Date.now();
                    const newMedal = {
                        id: now,
                        name: medalName,
                        awardedDate: now,
                        expires: now + (30 * 24 * 60 * 60 * 1000)
                    };
                    if (!member.medals) member.medals = [];
                    member.medals.push(newMedal);

                    // Apply cooldown reduction
                    const reductionPercent = CONFIG.MEDAL_COOLDOWN_REDUCTION[medalName];
                    if (reductionPercent) {
                        const cooldownInfo = getMemberCooldownInfo(member.name);
                        if (cooldownInfo && cooldownInfo.remainingDays > 0) {
                            const daysToReduce = cooldownInfo.remainingDays * reductionPercent;
                            const msToReduce = daysToReduce * 24 * 60 * 60 * 1000;
                            
                            const historyEntry = selectionHistory.find(h => h.id === cooldownInfo.historyId);
                            if(historyEntry) {
                                const newDate = new Date(cooldownInfo.lastSelectionDate.getTime() - msToReduce);
                                historyEntry.date = `${String(newDate.getMonth() + 1).padStart(2, '0')}-${String(newDate.getDate()).padStart(2, '0')}`;
                            }
                        }
                    }
                    
                    updateFirestore();
                    return true;
                }
                return false;
            }

            // --- RENDER FUNCTIONS ---
            function populateHelpLists() {
                const cooldownList = document.querySelector("#read-me-cooldown-reduction ul");
                cooldownList.innerHTML = '';
                for(const [medal, reduction] of Object.entries(CONFIG.MEDAL_COOLDOWN_REDUCTION)) {
                    const li = document.createElement('li');
                    li.innerHTML = `<span class="font-semibold">${medal}:</span> ${reduction * 100}% reduction`;
                    cooldownList.appendChild(li);
                }

                const luckList = document.getElementById("read-me-medal-luck-list");
                luckList.innerHTML = '';
                 for(const [medal, luck] of Object.entries(CONFIG.MEDAL_LUCK)) {
                    const li = document.createElement('li');
                    li.innerHTML = `<span class="font-semibold">${medal}:</span> +${luck}% Luck`;
                    luckList.appendChild(li);
                }
            }
            function populateMedalSelect(selectElement) {
                selectElement.innerHTML = `<option value="">Select a medal...</option>`;
                for (const medalName in CONFIG.MEDAL_LUCK) {
                    const option = document.createElement('option');
                    option.value = medalName;
                    option.textContent = medalName;
                    selectElement.appendChild(option);
                }
            }
            const renderManualPickList = () => {
                manualPickListContainer.innerHTML = '';
                const sortedMembers = [...allianceMembers].sort((a, b) => a.name.localeCompare(b.name));

                sortedMembers.forEach((member) => {
                    const div = document.createElement('div');
                    div.className = 'item-enter flex justify-between items-center p-2 rounded-lg hover:bg-slate-700/50 transition-colors duration-200 group text-sm';
                    
                    const now = Date.now();
                    const activeMedals = member.medals ? member.medals.filter(m => m.expires > now) : [];
                    let medalIcons = '';
                    if (activeMedals.length > 0) {
                        medalIcons = `<span class="text-xs ml-2">${activeMedals.map(m => '🏅').join('')}</span>`;
                    }

                    div.innerHTML = `
                        <button class="flex-grow text-left manual-pick-btn" data-name="${member.name}">
                            <span class="font-semibold">${member.name}</span>
                            <span class="text-xs text-slate-400 ml-2">${member.rank}</span>
                            ${medalIcons}
                        </button>
                        <div class="admin-control flex items-center space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button class="edit-member-btn text-slate-400 hover:text-cyan-400" data-id="${member.id}" title="Edit member">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                            </button>
                            <button class="delete-member-btn text-slate-400 hover:text-red-400" data-id="${member.id}" title="Delete member">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                    `;
                    manualPickListContainer.appendChild(div);
                });
            };
            const renderHistory = () => {
                const searchTerm = historySearchInput.value.toLowerCase();
                historyListContainer.innerHTML = '';
                 const sortedHistory = [...selectionHistory].sort((a, b) => {
                    const dateA = new Date(new Date().getFullYear(), parseInt(a.date.split('-')[0]) - 1, parseInt(a.date.split('-')[1]));
                    const dateB = new Date(new Date().getFullYear(), parseInt(b.date.split('-')[0]) - 1, parseInt(b.date.split('-')[1]));
                    return dateB - dateA;
                 });

                const filteredHistory = sortedHistory.filter(item => 
                    item.player.toLowerCase().includes(searchTerm)
                );
                
                const renderedCooldowns = new Set();

                filteredHistory.forEach((item) => {
                    const div = document.createElement('div');
                    div.className = 'item-enter flex justify-between items-center p-2 rounded-lg hover:bg-slate-700/50 transition-colors duration-200 group text-sm';
                    
                    let cooldownHTML = '';
                    if (!renderedCooldowns.has(item.player)) {
                        const cooldownInfo = getMemberCooldownInfo(item.player);
                        if (cooldownInfo && cooldownInfo.remainingDays > 0) {
                            cooldownHTML = `<span class="text-xs text-red-400 font-semibold ml-2">(${cooldownInfo.remainingDays}d left)</span>`;
                        } else if (cooldownInfo) {
                             cooldownHTML = `<span class="text-xs text-green-400 font-semibold ml-2">(Eligible)</span>`;
                        }
                        renderedCooldowns.add(item.player);
                    }

                    div.innerHTML = `
                        <p class="font-semibold text-white truncate pr-2">${item.player} ${cooldownHTML}</p>
                        <div class="flex items-center space-x-2 flex-shrink-0">
                            <p class="text-xs text-slate-400">${item.date}</p>
                            <button class="admin-control delete-history-btn text-slate-500 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity" data-id="${item.id}" title="Delete history entry">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                    `;
                    historyListContainer.appendChild(div);
                });
            };
            const renderConductor = () => {
                if (currentConductor && currentConductor !== 'SELECT A CONDUCTOR') {
                    conductorNameSpan.textContent = currentConductor;
                    conductorNameSpan.classList.remove('text-slate-500', 'text-cyan-400');
                    conductorNameSpan.classList.add('text-white', 'conductor-reveal', 'text-glow-gold');
                    conductorNameSpan.addEventListener('animationend', () => conductorNameSpan.classList.remove('conductor-reveal'), { once: true });
                } else {
                    conductorNameSpan.textContent = 'SELECT A CONDUCTOR';
                    conductorNameSpan.classList.remove('text-white', 'text-glow-gold', 'text-cyan-400');
                    conductorNameSpan.classList.add('text-slate-500');
                }
            };
            const renderActiveMedalsInEditModal = () => {
                if (memberToEditId === null) return;
                const member = allianceMembers.find(m => m.id === memberToEditId);
                activeMedalsList.innerHTML = '';
                if (!member || !member.medals || member.medals.length === 0) {
                    activeMedalsList.innerHTML = `<p class="text-xs text-slate-400 italic">No active medals.</p>`;
                    return;
                }
                
                const now = Date.now();
                const activeMedals = member.medals.filter(medal => medal.expires > now);

                if (activeMedals.length === 0) {
                     activeMedalsList.innerHTML = `<p class="text-xs text-slate-400 italic">No active medals.</p>`;
                     return;
                }

                activeMedals.forEach(medal => {
                    const daysLeft = Math.ceil((medal.expires - now) / (1000 * 60 * 60 * 24));
                    
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center bg-slate-700/50 p-2 rounded-md';
                    div.innerHTML = `
                        <div>
                            <p class="text-sm font-semibold text-white">${medal.name}</p>
                            <p class="text-xs text-slate-400">Expires in ${daysLeft} day(s)</p>
                        </div>
                        <button class="remove-medal-btn text-red-500 hover:text-red-400" data-medal-id="${medal.id}" title="Remove Medal">&times;</button>
                    `;
                    activeMedalsList.appendChild(div);
                });
            };
            const renderMedalsTab = () => {
                medalsListContainer.innerHTML = '';
                const membersWithMedals = allianceMembers.filter(m => m.medals && m.medals.some(medal => medal.expires > Date.now()));

                if (membersWithMedals.length === 0) {
                    medalsListContainer.innerHTML = `<p class="text-sm text-slate-400 italic">No members have active medals.</p>`;
                    return;
                }

                membersWithMedals.forEach(member => {
                    const div = document.createElement('div');
                    div.className = 'item-enter p-2 rounded-lg bg-slate-800/50 text-sm';
                    
                    const activeMedalsHTML = member.medals
                        .filter(m => m.expires > Date.now())
                        .map(m => {
                            const awardedDate = new Date(m.awardedDate);
                            const formattedDate = `${String(awardedDate.getMonth() + 1).padStart(2, '0')}/${String(awardedDate.getDate()).padStart(2, '0')}`;
                            return `<div class="flex items-center justify-between bg-cyan-800/50 text-cyan-300 px-2 py-0.5 rounded-full">
                                        <span>${m.name}</span>
                                        <span class="text-xs text-cyan-500 ml-2">(${formattedDate})</span>
                                    </div>`;
                        }).join('');

                    div.innerHTML = `
                        <div>
                            <p class="font-semibold text-white mb-1">${member.name}</p>
                            <div class="flex flex-col gap-1">
                                ${activeMedalsHTML}
                            </div>
                        </div>
                    `;
                    medalsListContainer.appendChild(div);
                });
            };
            const renderAll = () => {
                renderManualPickList();
                renderHistory();
                renderConductor();
                renderMedalsTab();
                populateHelpLists();
            };

            // --- LUCK & COOLDOWN CALCULATION ---
            const getMemberCooldownInfo = (memberName) => {
                const memberObject = allianceMembers.find(m => m.name === memberName);
                if (!memberObject) return null;

                const sortedMemberHistory = selectionHistory
                    .filter(h => h.player === memberObject.name)
                    .sort((a, b) => {
                        const dateA = new Date(new Date().getFullYear(), parseInt(a.date.split('-')[0]) - 1, parseInt(a.date.split('-')[1]));
                        const dateB = new Date(new Date().getFullYear(), parseInt(b.date.split('-')[0]) - 1, parseInt(b.date.split('-')[1]));
                        return dateB - dateA;
                    });

                if (sortedMemberHistory.length === 0) return { remainingDays: 0 };
                
                const lastSelection = sortedMemberHistory[0];
                const now = new Date();
                const lastDate = new Date(now.getFullYear(), parseInt(lastSelection.date.split('-')[0]) - 1, parseInt(lastSelection.date.split('-')[1]));
                if (now < lastDate) lastDate.setFullYear(now.getFullYear() - 1);
                
                const diffTime = now - lastDate;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                const totalCooldown = CONFIG.RANK_COOLDOWN[memberObject.rank] || 30;
                const remaining = totalCooldown - diffDays;

                return {
                    lastSelectionDate: lastDate,
                    totalCooldownDays: totalCooldown,
                    remainingDays: Math.max(0, remaining),
                    historyId: lastSelection.id
                };
            };

            const calculateTotalLuck = (member) => {
                let totalLuck = 0;
                totalLuck += CONFIG.RANK_LUCK[member.rank] || 0;
                const now = Date.now();
                if (member.medals) {
                    member.medals.forEach(medal => {
                        if (medal.expires > now) {
                            totalLuck += CONFIG.MEDAL_LUCK[medal.name] || 0;
                        }
                    });
                }
                return totalLuck;
            };

            // --- UI STATE & AUTH MANAGEMENT ---
            function setAuthState(state) {
                isAuthenticated = state;
                if (isAuthenticated) {
                    document.body.classList.remove('logged-out');
                    document.body.classList.add('logged-in');
                    loginModal.classList.add('hidden');
                } else {
                    document.body.classList.remove('logged-in');
                    document.body.classList.add('logged-out');
                }
            }
            function showPendingMode(name) {
                pendingConductor = name;
                conductorNameSpan.textContent = name;
                conductorNameSpan.classList.remove('text-white', 'text-glow-gold', 'text-slate-500');
                conductorNameSpan.classList.add('text-cyan-400');
                randomButtonsContainer.style.display = 'none';
                pendingButtonsContainer.style.display = 'grid';
            }
            function showRandomMode() {
                pendingConductor = null;
                renderConductor();
                randomButtonsContainer.style.display = 'grid';
                pendingButtonsContainer.style.display = 'none';
            }
            function showConfirmationModal(title, message, onConfirm) {
                confirmationTitle.textContent = title;
                confirmationMessage.textContent = message;
                confirmCallback = onConfirm;
                confirmationModal.classList.remove('hidden');
            }

            // --- CORE LOGIC & EVENT HANDLERS ---
            const selectRandomly = (pool, buttonToUpdate, excludedMember = null) => {
                if (!isAuthenticated) return;
                showRandomMode();
                if (pool.length === 0) return;
                
                randomSelectButton.disabled = true;
                if (buttonToUpdate) buttonToUpdate.textContent = 'CHOOSING...';

                const eligibleByCooldown = pool.filter(member => {
                    const info = getMemberCooldownInfo(member.name);
                    return (!info || info.remainingDays <= 0) && (!excludedMember || member.name !== excludedMember.name);
                });

                const selectionPool = eligibleByCooldown.length > 0 ? eligibleByCooldown : pool.filter(m => excludedMember ? m.name !== excludedMember.name : true);

                if (selectionPool.length === 0) {
                    alert("No eligible members found based on current rules.");
                     randomSelectButton.disabled = false;
                     if(buttonToUpdate) buttonToUpdate.textContent = 'CHOOSE CONDUCTOR';
                    return;
                }

                const weightedPool = selectionPool.map(member => {
                    const luck = calculateTotalLuck(member);
                    return { member, weight: 100 + luck };
                });

                const totalWeight = weightedPool.reduce((sum, item) => sum + item.weight, 0);
                let randomWeight = Math.random() * totalWeight;
                let winner = weightedPool[weightedPool.length - 1].member;

                for(const item of weightedPool) {
                    randomWeight -= item.weight;
                    if (randomWeight <= 0) {
                        winner = item.member;
                        break;
                    }
                }
                
                let drumRollCount = 0;
                const drumRollInterval = setInterval(() => {
                    const randomIndex = Math.floor(Math.random() * selectionPool.length);
                    conductorNameSpan.textContent = selectionPool[randomIndex].name;
                    conductorNameSpan.classList.remove('text-white', 'text-glow-gold');
                    conductorNameSpan.classList.add('text-cyan-400');
                    if (++drumRollCount > 15) {
                        clearInterval(drumRollInterval);
                        showPendingMode(winner.name);
                        randomSelectButton.disabled = false;
                        if(buttonToUpdate) buttonToUpdate.textContent = 'CHOOSE CONDUCTOR';
                    }
                }, 100);
            };
            
            addMemberButton.addEventListener('click', () => { if(isAuthenticated) addModal.classList.remove('hidden'); });
            manualPickListContainer.addEventListener('click', (e) => {
                const pickBtn = e.target.closest('.manual-pick-btn');
                if (pickBtn && isAuthenticated) {
                    showPendingMode(pickBtn.dataset.name);
                }

                const editBtn = e.target.closest('.edit-member-btn');
                if (editBtn && isAuthenticated) {
                    memberToEditId = parseFloat(editBtn.dataset.id);
                    const member = allianceMembers.find(m => m.id === memberToEditId);
                    if (member) {
                        editNameInput.value = member.name;
                        editRankSelect.value = member.rank;
                        renderActiveMedalsInEditModal();
                        editModal.classList.remove('hidden');
                    }
                }
                const deleteBtn = e.target.closest('.delete-member-btn');
                if (deleteBtn && isAuthenticated) {
                    const idToDelete = parseFloat(deleteBtn.dataset.id);
                    allianceMembers = allianceMembers.filter(m => m.id !== idToDelete);
                    updateFirestore();
                }
            });
            lockInButton.addEventListener('click', () => {
                if (!isAuthenticated) return;
                showConfirmationModal('Lock In Conductor?', `Are you sure you want to lock in ${pendingConductor}?`, () => {
                    if(pendingConductor) {
                        currentConductor = pendingConductor;
                        const today = new Date();
                        const dateStr = `${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                        selectionHistory.unshift({ player: currentConductor, date: dateStr, id: Date.now() });
                        updateFirestore();
                        showRandomMode();
                    }
                });
            });
            substituteButton.addEventListener('click', () => {
                if (!isAuthenticated) return;
                showConfirmationModal('Choose Substitute?', `This will return ${pendingConductor} to the pool and pick a new conductor.`, () => {
                    const originalPick = allianceMembers.find(m => m.name === pendingConductor);
                    selectRandomly(allianceMembers, null, originalPick);
                });
            });
            historyListContainer.addEventListener('click', (e) => {
                 if (!isAuthenticated) return;
                 const deleteButton = e.target.closest('.delete-history-btn');
                 if (deleteButton) {
                    const idToDelete = parseFloat(deleteButton.dataset.id);
                    selectionHistory = selectionHistory.filter(item => item.id !== idToDelete);
                    updateFirestore();
                 }
            });
            saveAddBtn.addEventListener('click', () => {
                if (!isAuthenticated) return;
                const newName = addNameInput.value.trim();
                if (newName && !allianceMembers.some(m => m.name === newName)) {
                    allianceMembers.push({ id: Date.now(), name: newName, rank: addRankSelect.value, medals: [] });
                    updateFirestore();
                    addModal.classList.add('hidden');
                } else if (newName) alert("A member with this name already exists.");
            });
            cancelAddBtn.addEventListener('click', () => addModal.classList.add('hidden'));
            addModal.addEventListener('click', (e) => { if (e.target.id === 'add-modal') cancelAddBtn.click(); });
            
            saveEditBtn.addEventListener('click', () => {
                if (!isAuthenticated || memberToEditId === null) return;
                const memberIndex = allianceMembers.findIndex(m => m.id === memberToEditId);
                if (memberIndex > -1) {
                    allianceMembers[memberIndex].name = editNameInput.value.trim();
                    allianceMembers[memberIndex].rank = editRankSelect.value;
                    updateFirestore();
                }
            });
            awardMedalBtn.addEventListener('click', () => {
                if (!isAuthenticated) return;
                const medalName = awardMedalSelect.value;
                if(memberToEditId && medalName) {
                    awardMedal(memberToEditId, medalName);
                    renderActiveMedalsInEditModal();
                }
            });
            activeMedalsList.addEventListener('click', (e) => {
                if (!isAuthenticated) return;
                const removeBtn = e.target.closest('.remove-medal-btn');
                if (removeBtn && memberToEditId) {
                    const medalId = parseFloat(removeBtn.dataset.medalId);
                    const memberIndex = allianceMembers.findIndex(m => m.id === memberToEditId);
                    if(memberIndex > -1) {
                        allianceMembers[memberIndex].medals = allianceMembers[memberIndex].medals.filter(m => m.id !== medalId);
                        renderActiveMedalsInEditModal();
                        updateFirestore();
                    }
                }
            });
            cancelEditBtn.addEventListener('click', () => {
                editModal.classList.add('hidden');
                memberToEditId = null;
            });
            editModal.addEventListener('click', (e) => { if (e.target.id === 'edit-modal') cancelEditBtn.click(); });
            
            const allTabs = [tabManualPick, tabHistory, tabMedals];
            const allContent = [contentManualPick, contentHistory, contentMedals];

            allTabs.forEach((tab, index) => {
                tab.addEventListener('click', () => {
                    allTabs.forEach(t => t.classList.remove('active'));
                    allContent.forEach(c => c.classList.add('hidden'));
                    tab.classList.add('active');
                    allContent[index].classList.remove('hidden');
                });
            });
            
            addHistoryButton.addEventListener('click', () => {
                if (!isAuthenticated) return;
                addHistoryPlayerSelect.innerHTML = `<option value="">Select a player...</option>`;
                const sortedMembers = [...allianceMembers].sort((a,b) => a.name.localeCompare(b.name));
                sortedMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.name;
                    option.textContent = member.name;
                    addHistoryPlayerSelect.appendChild(option);
                });
                addHistoryDateInput.value = '';
                addHistoryModal.classList.remove('hidden');
            });
            saveAddHistoryBtn.addEventListener('click', () => {
                if (!isAuthenticated) return;
                const player = addHistoryPlayerSelect.value;
                const date = addHistoryDateInput.value;
                if(player && date.match(/^\d{2}-\d{2}$/)) {
                    selectionHistory.unshift({ player, date, id: Date.now() });
                    updateFirestore();
                    addHistoryModal.classList.add('hidden');
                } else {
                    alert('Please select a player and enter a valid date in MM-DD format.');
                }
            });
            cancelAddHistoryBtn.addEventListener('click', () => addHistoryModal.classList.add('hidden'));

            historySearchInput.addEventListener('input', renderHistory);
            randomSelectButton.addEventListener('click', () => selectRandomly(allianceMembers, randomSelectButton));

            // --- AWARD MEDAL MODAL LOGIC ---
            function validateMedalAward() {
                const memberId = parseFloat(awardMedalMemberSelect.value);
                const medalName = awardMedalTypeSelect.value;
                const validationMsg = awardMedalValidationMsg;
                const saveBtn = saveAwardMedalBtn;

                if (!memberId || !medalName) {
                    saveBtn.disabled = true;
                    validationMsg.textContent = '';
                    return;
                }

                const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
                let isMedalOnGlobalCooldown = false;
                for (const member of allianceMembers) {
                    if (member.medals && member.medals.some(m => m.name === medalName && m.awardedDate > sevenDaysAgo)) {
                        isMedalOnGlobalCooldown = true;
                        break;
                    }
                }

                if (isMedalOnGlobalCooldown) {
                    validationMsg.textContent = `This medal was already awarded this week.`;
                    saveBtn.disabled = true;
                    return;
                }
                
                const member = allianceMembers.find(m => m.id === memberId);
                if (member && member.medals && member.medals.some(m => m.name === medalName && m.expires > Date.now())) {
                    validationMsg.textContent = `${member.name} already has an active ${medalName}.`;
                    saveBtn.disabled = true;
                    return;
                }

                validationMsg.textContent = '';
                saveBtn.disabled = false;
            }

            openAwardMedalModalBtn.addEventListener('click', () => {
                if (!isAuthenticated) return;
                awardMedalMemberSelect.innerHTML = '<option value="">Select a member...</option>';
                const sortedMembers = [...allianceMembers].sort((a,b) => a.name.localeCompare(b.name));
                sortedMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.name;
                    awardMedalMemberSelect.appendChild(option);
                });
                
                populateMedalSelect(awardMedalTypeSelect);
                
                validateMedalAward();
                awardMedalModal.classList.remove('hidden');
            });

            cancelAwardMedalBtn.addEventListener('click', () => awardMedalModal.classList.add('hidden'));
            awardMedalModal.addEventListener('click', (e) => { if(e.target.id === 'award-medal-modal') cancelAwardMedalBtn.click(); });
            awardMedalMemberSelect.addEventListener('change', validateMedalAward);
            awardMedalTypeSelect.addEventListener('change', validateMedalAward);

            saveAwardMedalBtn.addEventListener('click', () => {
                if (!isAuthenticated) return;
                const memberId = parseFloat(awardMedalMemberSelect.value);
                const medalName = awardMedalTypeSelect.value;
                if (memberId && medalName) {
                    if (awardMedal(memberId, medalName)) {
                        renderAll(); // Re-render everything to show changes
                        awardMedalModal.classList.add('hidden');
                    }
                }
            });

            // --- AUTHENTICATION LOGIC ---
            openLoginModalBtn.addEventListener('click', () => loginModal.classList.remove('hidden'));
            cancelLoginBtn.addEventListener('click', () => loginModal.classList.add('hidden'));
            loginModal.addEventListener('click', (e) => { if(e.target.id === 'login-modal') cancelLoginBtn.click(); });

            loginButton.addEventListener('click', () => {
                const user = usernameInput.value;
                const pass = passwordInput.value;
                if (user === 'sw4prez' && pass === 'newspaper') {
                    setAuthState(true);
                } else {
                    loginErrorMsg.textContent = 'Invalid username or password.';
                    setTimeout(() => loginErrorMsg.textContent = '', 3000);
                }
            });

            logoutButton.addEventListener('click', () => {
                setAuthState(false);
            });

            // --- READ ME MODAL LOGIC ---
            readMeButton.addEventListener('click', () => readMeModal.classList.remove('hidden'));
            closeReadMeBtn.addEventListener('click', () => readMeModal.classList.add('hidden'));
            readMeModal.addEventListener('click', (e) => { if(e.target.id === 'read-me-modal') closeReadMeBtn.click(); });

            // --- INITIALIZATION ---
            setAuthState(false); // Start logged out
            populateMedalSelect(awardMedalSelect);
            initializeFirebase();
        });
    </script>
</body>
</html>
