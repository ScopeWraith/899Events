<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THOR Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        /* Desktop font size (~88% of default 16px) */
        html {
            font-size: 14.08px;
        }

        /* Mobile font size (~77% of default 16px) */
        @media (max-width: 1024px) { /* Tailwind's 'lg' breakpoint */
            html {
                font-size: 12.32px;
            }
        }

        html, body {
            height: 100%;
            overflow: hidden; /* Prevent the main page from scrolling */
        }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #020617; /* bg-slate-950 */
            background-image: radial-gradient(circle at top right, rgba(14, 165, 233, 0.15), transparent 40%),
                              radial-gradient(circle at bottom left, rgba(168, 85, 247, 0.15), transparent 50%);
        }
        .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }
        /* Shared card styling */
        .card {
            background-color: rgba(30, 41, 59, 0.5); /* bg-slate-800/50 */
            backdrop-filter: blur(12px);
            border: 1px solid rgba(51, 65, 85, 0.5); /* border-slate-700/50 */
            position: relative;
        }
        /* Aurora border effect */
        .card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            border-radius: inherit; /* Use the parent's border-radius */
            padding: 1px;
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.4), rgba(168, 85, 247, 0.4));
            -webkit-mask:
                linear-gradient(#fff 0 0) content-box,
                linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            z-index: -1;
            pointer-events: none;
        }
        .conductor-reveal {
            animation: reveal 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
        }
        @keyframes reveal {
            0% { letter-spacing: -0.5em; opacity: 0; }
            40% { opacity: 0.6; }
            100% { letter-spacing: normal; opacity: 1; }
        }
        .item-enter {
            animation: item-enter 0.5s ease-out;
        }
        @keyframes item-enter {
            0% { opacity: 0; transform: scale(0.95) translateY(10px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Loading Spinner */
        .loader {
            border: 4px solid #334155; /* border-slate-700 */
            border-top: 4px solid #06b6d4; /* border-cyan-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Mobile Nav Button Styling */
        .mobile-nav-btn {
            margin-top: 5px;
            transition: all 0.3s ease;
            color: #94a3b8; /* text-slate-400 */
            position: relative;
        }
        .mobile-nav-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 2px;
            background-color: #06b6d4;
            transition: width 0.3s ease;
        }
        .mobile-nav-btn.active {
            color: #06b6d4; /* text-cyan-500 */
        }
        .mobile-nav-btn.active::after {
            width: 50%;
        }

        /* Desktop Sidebar Nav Styling */
        .desktop-nav-btn {
            transition: all 0.3s ease;
            color: #94a3b8; /* text-slate-400 */
            border-left: 3px solid transparent;
        }
        .desktop-nav-btn:hover {
            background-color: rgba(51, 65, 85, 0.3); /* bg-slate-700/30 */
            color: #e2e8f0; /* text-slate-200 */
        }
        .desktop-nav-btn.active {
            color: #06b6d4; /* text-cyan-400 */
            border-left-color: #06b6d4;
            background-color: rgba(14, 165, 233, 0.1);
        }

        .text-glow-gold {
            text-shadow: 0 0 8px rgba(250, 204, 21, 0.9), 0 0 20px rgba(250, 204, 21, 0.7);
        }
        .text-glow-cyan {
            text-shadow: 0 0 8px rgba(34, 211, 238, 0.9), 0 0 20px rgba(34, 211, 238, 0.7);
        }

        /* Auth Visibility Control */
        .logged-out .admin-control { display: none !important; }
        .logged-in .login-button { display: none !important; }
        .logged-out .logout-button { display: none !important; }
        
        /* How It Works Modal Tabs */
        .how-it-works-tab {
            background-color: transparent; border-bottom: 2px solid transparent; transition: all 0.3s ease; color: #94a3b8;
        }
        .how-it-works-tab.active { color: #06b6d4; border-bottom-color: #06b6d4; }
        .how-it-works-tab-content { display: none; }
        .how-it-works-tab-content.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Conductor Panel Styling */
        #conductor-panel-wrapper {
            transition: max-height 0.5s ease-in-out, padding-bottom 0.5s ease-in-out, opacity 0.3s ease-in-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            padding-bottom: 0;
        }
        #conductor-panel-wrapper.is-visible {
            max-height: 500px; /* Large enough for content */
            opacity: 1;
            padding-bottom: 1rem; /* Reduced gap */
        }
        @media (min-width: 1024px) {
             #conductor-panel-wrapper.is-visible {
                padding-bottom: 2rem; /* gap-8 on desktop */
             }
        }

        /* Toggle Switch */
        .toggle-switch {
            width: 36px;
            height: 20px;
        }
        .toggle-switch .toggle-switch-track {
            background-color: #4b5563; /* gray-600 */
        }
        .toggle-switch .toggle-switch-thumb {
            width: 16px;
            height: 16px;
            top: 2px;
            left: 2px;
            transform: translateX(0);
        }
        .desktop-nav-btn.active .toggle-switch .toggle-switch-track {
            background-color: #0891b2; /* cyan-600 */
        }
        .desktop-nav-btn.active .toggle-switch .toggle-switch-thumb {
            transform: translateX(16px);
        }

        /* Mobile Toggle Switch */
        .toggle-switch-mobile {
            width: 24px;
            height: 14px;
        }
        .toggle-switch-mobile .toggle-switch-track {
            background-color: #4b5563; /* gray-600 */
        }
        .toggle-switch-mobile .toggle-switch-thumb {
            width: 10px;
            height: 10px;
            top: 2px;
            left: 2px;
            transform: translateX(0);
        }
        .mobile-nav-btn.active .toggle-switch-mobile .toggle-switch-track {
            background-color: #0891b2; /* cyan-600 */
        }
        .mobile-nav-btn.active .toggle-switch-mobile .toggle-switch-thumb {
            transform: translateX(10px);
        }
        .toggle-switch-track, .toggle-switch-thumb {
            transition: all 0.2s ease-in-out;
        }

    </style>
</head>
<body class="text-slate-300 logged-out">
    
    <canvas id="confetti-canvas" class="fixed top-0 left-0 w-full h-full pointer-events-none z-[100]"></canvas>

    <div id="loading-overlay" class="fixed inset-0 bg-slate-900/80 flex flex-col items-center justify-center z-50 transition-opacity duration-300">
        <div class="loader"></div>
        <p class="mt-4 text-lg text-slate-300">Connecting to Database...</p>
    </div>

    <!-- Main container for layout -->
    <div class="h-full p-4 lg:p-8 flex flex-col lg:flex-row gap-8">
        
        <!-- ===== DESKTOP SIDEBAR ===== -->
        <aside class="hidden lg:flex flex-col w-64 flex-shrink-0">
            <div class="card flex-grow flex flex-col rounded-2xl">
                <div class="p-4 border-b border-slate-700/50">
                    <h1 class="text-xl font-bold text-white text-center font-orbitron">THOR Tracker</h1>
                </div>
                <nav id="desktop-nav" class="flex-grow p-2 space-y-1">
                    <button data-tab="conductor" class="desktop-nav-btn w-full flex items-center justify-between p-3 rounded-lg">
                        <span class="font-semibold">Conductor</span>
                        <div class="toggle-switch relative">
                            <div class="toggle-switch-track absolute top-0 left-0 right-0 bottom-0 rounded-full"></div>
                            <div class="toggle-switch-thumb absolute bg-white rounded-full"></div>
                        </div>
                    </button>
                    <button data-tab="members" class="desktop-nav-btn w-full flex items-center p-3 rounded-lg space-x-3">
                        <i class="fa-solid fa-users w-5 h-5 text-center"></i>
                        <span class="font-semibold">Members</span>
                    </button>
                    <button data-tab="history" class="desktop-nav-btn w-full flex items-center p-3 rounded-lg space-x-3">
                        <i class="fa-solid fa-clock-rotate-left w-5 h-5 text-center"></i>
                        <span class="font-semibold">History</span>
                    </button>
                    <button data-tab="medals" class="desktop-nav-btn w-full flex items-center p-3 rounded-lg space-x-3">
                        <i class="fa-solid fa-medal w-5 h-5 text-center"></i>
                        <span class="font-semibold">Medals</span>
                    </button>
                </nav>
                 <div class="p-4 border-t border-slate-700/50 mt-auto flex flex-col items-center justify-between space-y-2">
                    <button id="how-it-works-button" class="text-slate-400 hover:text-cyan-400 font-bold py-2 px-4 rounded-lg text-sm transition-colors flex items-center space-x-2">
                        <i class="fa-solid fa-circle-question w-4 h-4"></i>
                        <span>How it works!</span>
                    </button>
                    <div class="flex-grow text-center">
                        <button id="open-login-modal-btn" class="login-button bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors">Admin Login</button>
                        <button id="logout-button" class="logout-button bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors">Logout</button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- ===== Main Content Area (Mobile & Desktop) ===== -->
        <main class="w-full max-w-md mx-auto lg:max-w-none lg:mx-0 flex-grow flex flex-col min-h-0">
            
            <!-- ===== Conductor Panel (now inside main content) ===== -->
            <div id="conductor-panel-wrapper" class="flex-shrink-0">
                 <div class="card rounded-2xl p-3 md:p-4">
                    <div class="relative mb-2">
                        <h2 class="text-xl font-bold text-white text-center text-glow-cyan">Today's Conductor</h2>
                    </div>
                    <div id="conductor-display" class="bg-slate-900/70 rounded-lg p-3 flex items-center justify-center text-center">
                        <span id="conductor-name" class="font-orbitron text-2xl md:text-3xl font-bold text-slate-500 transition-colors duration-300">SELECT A CONDUCTOR</span>
                    </div>
                    <div id="action-buttons-container" class="admin-control mt-3">
                        <div id="random-buttons-container" class="grid grid-cols-1">
                            <button id="random-select-button" class="w-full bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm transition-all transform hover:scale-[1.02] focus:outline-none focus:ring-4 focus:ring-cyan-300/50">
                                CHOOSE CONDUCTOR
                            </button>
                        </div>
                        <div id="pending-buttons-container" class="hidden grid grid-cols-3 gap-3">
                            <button id="reroll-button" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm transition-all transform hover:scale-[1.02] focus:outline-none focus:ring-4 focus:ring-slate-400/50">RE-ROLL</button>
                            <button id="lock-in-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm transition-all transform hover:scale-[1.02] focus:outline-none focus:ring-4 focus:ring-green-300/50">LOCK IN</button>
                            <button id="cancel-selection-button" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm transition-all transform hover:scale-[1.02] focus:outline-none focus:ring-4 focus:ring-red-400/50">CANCEL</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- This card contains the tabbed content panels -->
            <div class="card rounded-2xl flex-grow flex flex-col min-h-0">
                
                <!-- Mobile Nav (now at top of card) -->
                <div id="mobile-nav" class="lg:hidden border-b border-slate-700/50">
                    <div class="grid grid-cols-4 text-center">
                        <button data-tab="conductor" class="mobile-nav-btn py-2.5 px-2 flex flex-col items-center justify-center gap-1.5">
                            <div class="toggle-switch-mobile relative">
                                <div class="toggle-switch-track absolute top-0 left-0 right-0 bottom-0 rounded-full"></div>
                                <div class="toggle-switch-thumb absolute bg-white rounded-full"></div>
                            </div>
                            <span class="text-xs font-semibold">Conductor</span>
                        </button>
                        <button data-tab="members" class="mobile-nav-btn py-2.5 px-2 flex flex-col items-center justify-center gap-1.5">
                            <i class="fa-solid fa-users w-5 h-5 mt-0.5"></i>
                            <span class="text-xs font-semibold">Members</span>
                        </button>
                        <button data-tab="history" class="mobile-nav-btn py-2.5 px-2 flex flex-col items-center justify-center gap-1.5">
                            <i class="fa-solid fa-clock-rotate-left w-5 h-5 mt-0.5"></i>
                            <span class="text-xs font-semibold">History</span>
                        </button>
                        <button data-tab="medals" class="mobile-nav-btn py-2.5 px-2 flex flex-col items-center justify-center gap-1.5">
                            <i class="fa-solid fa-medal w-5 h-5 mt-0.5"></i>
                            <span class="text-xs font-semibold">Medals</span>
                        </button>
                    </div>
                </div>

                <!-- Main Content Panels -->
                <div class="flex-grow flex flex-col min-h-0">
                    <!-- Content Panels Wrapper -->
                    <div class="p-4 lg:p-6 flex-grow flex flex-col min-h-0">
                        <div id="content-members" class="hidden h-full flex flex-col">
                            <div class="flex items-center mb-2 flex-shrink-0">
                                <input type="text" id="member-search-input" placeholder="Search members..." class="w-full bg-slate-800/60 border border-slate-600 rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-cyan-400">
                                <button id="add-member-button" class="admin-control ml-2 text-cyan-400 hover:text-cyan-300" title="Add new member">
                                   <i class="fa-solid fa-plus-circle w-6 h-6"></i>
                                </button>
                            </div>
                            <div id="manual-pick-list-container" class="space-y-1 custom-scrollbar pr-2 overflow-y-auto flex-grow"></div>
                        </div>
                        <div id="content-history" class="h-full flex flex-col">
                             <div class="flex items-center mb-2 flex-shrink-0">
                                <input type="text" id="history-search-input" placeholder="Search player history..." class="w-full bg-slate-800/60 border border-slate-600 rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-cyan-400">
                                <button id="add-history-button" class="admin-control ml-2 text-cyan-400 hover:text-cyan-300" title="Add history entry">
                                    <i class="fa-solid fa-plus-circle w-6 h-6"></i>
                                </button>
                             </div>
                             <div id="history-list-container" class="space-y-2 custom-scrollbar pr-2 overflow-y-auto flex-grow"></div>
                        </div>
                        <div id="content-medals" class="hidden h-full flex flex-col">
                            <div class="flex justify-between items-center mb-3 flex-shrink-0">
                                 <h3 class="text-lg font-bold text-white">Active Medal Awards</h3>
                                 <button id="open-award-medal-modal-btn" class="admin-control bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-1 px-3 rounded-lg text-xs flex items-center space-x-1">
                                    <i class="fa-solid fa-medal w-4 h-4"></i>
                                     <span>Award Medals</span>
                                 </button>
                            </div>
                            <div id="medals-list-container" class="space-y-2 custom-scrollbar pr-2 overflow-y-auto flex-grow"></div>
                        </div>
                    </div>
                    <!-- Mobile Footer -->
                    <div class="lg:hidden p-4 border-t border-slate-700/50 mt-auto flex items-center justify-between space-x-4">
                        <button id="how-it-works-button-mobile" class="text-slate-400 hover:text-cyan-400 font-bold py-2 px-4 rounded-lg text-xs transition-colors flex items-center space-x-2">
                            <i class="fa-solid fa-circle-question w-4 h-4"></i>
                            <span>How it works!</span>
                        </button>
                        <div class="flex-grow text-right">
                            <button id="open-login-modal-btn-mobile" class="login-button bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg text-xs transition-colors">Admin Login</button>
                            <button id="logout-button-mobile" class="logout-button bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-xs transition-colors">Logout</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- All Modals -->
    <div id="login-modal" class="modal-overlay hidden fixed inset-0 bg-slate-950/90 flex items-center justify-center z-50 p-4">
        <div class="card p-6 w-full max-w-sm rounded-2xl">
            <h2 class="text-xl font-bold text-white mb-4 text-center">Admin Login</h2>
            <div class="space-y-4">
                <div>
                    <label for="password-input" class="block text-sm font-medium text-slate-300">Password</label>
                    <input type="password" id="password-input" class="mt-1 w-full bg-slate-700/50 border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-400">
                </div>
                <p id="login-error-msg" class="text-xs text-red-400 h-4 text-center"></p>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-login-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg text-sm">Cancel</button>
                <button id="login-button" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Login</button>
            </div>
        </div>
    </div>
    <div id="confirmation-modal" class="modal-overlay hidden fixed inset-0 bg-slate-900/80 flex items-center justify-center z-50 p-4">
        <div class="card p-6 w-full max-w-sm text-center rounded-2xl">
            <h2 id="confirmation-title" class="text-lg font-bold text-white mb-4">Are you sure?</h2>
            <p id="confirmation-message" class="text-sm text-slate-300 mb-6">This action cannot be undone.</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded-lg text-sm">Cancel</button>
                <button id="confirm-action-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg text-sm">Confirm</button>
            </div>
        </div>
    </div>
    <div id="add-history-modal" class="modal-overlay hidden fixed inset-0 bg-slate-900/80 flex items-center justify-center z-50 p-4">
        <div class="card p-6 w-full max-w-sm rounded-2xl">
            <h2 class="text-xl font-bold text-white mb-4">Add History Entry</h2>
            <div class="space-y-4">
                <div>
                    <label for="add-history-player-select" class="block text-sm font-medium text-slate-300">Player</label>
                    <select id="add-history-player-select" class="mt-1 w-full bg-slate-700/50 border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-400"></select>
                </div>
                <div>
                    <label for="add-history-date-input" class="block text-sm font-medium text-slate-300">Date (MM-DD-YYYY)</label>
                    <input type="text" id="add-history-date-input" placeholder="e.g., 07-08-2025" class="mt-1 w-full bg-slate-700/50 border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-400">
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-add-history-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg text-sm">Cancel</button>
                <button id="save-add-history-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Save Entry</button>
            </div>
        </div>
    </div>
    <div id="edit-history-modal" class="modal-overlay hidden fixed inset-0 bg-slate-900/80 flex items-center justify-center z-50 p-4">
        <div class="card p-6 w-full max-w-sm rounded-2xl">
            <h2 class="text-xl font-bold text-white mb-4">Edit History Entry</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-300">Player</label>
                    <p id="edit-history-player-name" class="mt-1 w-full bg-slate-800/60 border border-slate-600 rounded-lg px-3 py-2 text-slate-400"></p>
                </div>
                <div>
                    <label for="edit-history-date-input" class="block text-sm font-medium text-slate-300">Date (MM-DD-YYYY)</label>
                    <input type="text" id="edit-history-date-input" class="mt-1 w-full bg-slate-700/50 border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-400" placeholder="e.g., 07-08-2025">
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-edit-history-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg text-sm">Cancel</button>
                <button id="save-edit-history-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Save Changes</button>
            </div>
        </div>
    </div>
    <div id="add-modal" class="modal-overlay hidden fixed inset-0 bg-slate-900/80 flex items-center justify-center z-50 p-4">
        <div class="card p-6 w-full max-w-sm rounded-2xl">
            <h2 class="text-xl font-bold text-white mb-4">Add New Member</h2>
            <div class="space-y-4">
                <div>
                    <label for="add-name-input" class="block text-sm font-medium text-slate-300">Name</label>
                    <input type="text" id="add-name-input" class="mt-1 w-full bg-slate-700/50 border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-400">
                </div>
                <div>
                    <label for="add-rank-select" class="block text-sm font-medium text-slate-300">Rank</label>
                    <select id="add-rank-select" class="mt-1 w-full bg-slate-700/50 border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-400">
                        <option>R1</option> <option>R2</option> <option>R3</option> <option>R4</option> <option>R5</option>
                    </select>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-add-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg text-sm">Cancel</button>
                <button id="save-add-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Save Member</button>
            </div>
        </div>
    </div>
    <div id="edit-modal" class="modal-overlay hidden fixed inset-0 bg-slate-900/80 flex items-center justify-center z-50 p-4">
        <div class="card p-6 w-full max-w-md rounded-2xl">
             <h2 class="text-xl font-bold text-white mb-4">Edit Member</h2>
            <div class="space-y-4">
                <div>
                    <label for="edit-name-input" class="block text-sm font-medium text-slate-300">Name</label>
                    <input type="text" id="edit-name-input" class="mt-1 w-full bg-slate-700/50 border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-400">
                </div>
                <div>
                    <label for="edit-rank-select" class="block text-sm font-medium text-slate-300">Rank</label>
                    <select id="edit-rank-select" class="mt-1 w-full bg-slate-700/50 border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-400">
                        <option>R1</option> <option>R2</option> <option>R3</option> <option>R4</option> <option>R5</option>
                    </select>
                </div>
                <div class="border-t border-slate-700 pt-4">
                    <label for="award-medal-select" class="block text-sm font-medium text-slate-300">Award a Medal (30 Day Bonus)</label>
                    <div class="flex gap-2 mt-1">
                        <select id="award-medal-select" class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-400"></select>
                        <button id="award-medal-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold px-4 rounded-lg text-sm">Award</button>
                    </div>
                </div>
                <div id="edit-sub-boost-section" class="hidden border-t border-slate-700 pt-4">
                    <h3 class="text-sm font-medium text-slate-300">Active Buffs</h3>
                    <div class="flex justify-between items-center mt-2 bg-slate-700/50 p-2 rounded-md">
                        <div>
                            <p class="text-sm font-semibold text-yellow-400">Substitution Boost Active</p>
                            <p id="sub-boost-description" class="text-xs text-slate-400"></p>
                        </div>
                        <button id="remove-sub-boost-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-lg text-xs">Remove</button>
                    </div>
                </div>
                 <div>
                    <h3 class="text-sm font-medium text-slate-300 mt-4">Active Medals</h3>
                    <div id="active-medals-list" class="mt-2 space-y-2"></div>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-edit-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg text-sm">Done</button>
                <button id="save-edit-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-sm">Save Name/Rank</button>
            </div>
        </div>
    </div>
    <div id="award-medal-modal" class="modal-overlay hidden fixed inset-0 bg-slate-900/80 flex items-center justify-center z-50 p-4">
        <div class="card p-6 w-full max-w-sm rounded-2xl">
            <h2 class="text-xl font-bold text-white mb-4">Award a Medal</h2>
            <div class="space-y-4">
                <div>
                    <label for="award-medal-member-select" class="block text-sm font-medium text-slate-300">Member</label>
                    <select id="award-medal-member-select" class="mt-1 w-full bg-slate-700/50 border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-400"></select>
                </div>
                <div>
                    <label for="award-medal-type-select" class="block text-sm font-medium text-slate-300">Medal</label>
                    <select id="award-medal-type-select" class="mt-1 w-full bg-slate-700/50 border border-slate-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-400"></select>
                </div>
                <p id="award-medal-validation-msg" class="text-xs text-yellow-400 h-4"></p>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-award-medal-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg text-sm">Cancel</button>
                <button id="save-award-medal-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg text-sm disabled:bg-slate-600 disabled:cursor-not-allowed" disabled>Award Medal</button>
            </div>
        </div>
    </div>
    <div id="player-info-modal" class="modal-overlay hidden fixed inset-0 bg-slate-950/90 flex items-center justify-center z-50 p-4">
        <div class="card p-4 sm:p-6 w-full max-w-md rounded-2xl">
            <div class="flex justify-between items-center mb-4">
                <h2 id="player-info-name" class="text-xl sm:text-2xl font-bold text-white font-orbitron truncate pr-2">Player Name</h2>
                <button id="close-player-info-btn" class="text-3xl font-light leading-none text-slate-400 hover:text-white transition-colors flex-shrink-0">&times;</button>
            </div>
            <div class="admin-control mb-4">
                <button id="designate-conductor-btn" class="w-full bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm transition-all flex items-center justify-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <span>Designate as Conductor</span>
                </button>
            </div>
            <div class="bg-slate-800/50 rounded-lg p-3 text-center mb-4">
                <p class="text-xs text-slate-400">Conductor Eligibility</p>
                <p id="player-info-eligibility" class="text-lg font-bold text-white">Eligible Now</p>
            </div>
            <div class="border-y border-slate-700/50 py-4 my-4">
                <div class="grid grid-cols-3 gap-2 sm:gap-4 text-center">
                    <div>
                        <div class="text-cyan-400 mx-auto mb-1"><svg class="w-7 h-7 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg></div>
                        <p class="text-xs text-slate-400">Total Luck</p><p id="player-info-luck" class="text-lg font-bold text-white">0%</p>
                    </div>
                    <div>
                        <div class="text-purple-400 mx-auto mb-1"><svg class="w-7 h-7 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                        <p class="text-xs text-slate-400">CD Reduction</p><p id="player-info-cd-reduction" class="text-lg font-bold text-white">0%</p>
                    </div>
                    <div>
                        <div class="text-amber-400 mx-auto mb-1"><svg class="w-7 h-7 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path></svg></div>
                        <p class="text-xs text-slate-400">Active Medals</p><p id="player-info-active-medals" class="text-lg font-bold text-white">0</p>
                    </div>
                </div>
            </div>
            <div class="space-y-4">
                <div>
                    <h3 class="text-base font-bold text-white mb-2">Medal History</h3>
                    <div id="player-info-medals-list" class="space-y-2 custom-scrollbar pr-2 overflow-y-auto" style="max-height: 120px;"></div>
                </div>
                <div>
                    <h3 class="text-base font-bold text-white mb-2">Conductor History</h3>
                    <div id="player-info-conductor-history-list" class="space-y-2 custom-scrollbar pr-2 overflow-y-auto" style="max-height: 120px;"></div>
                </div>
            </div>
        </div>
    </div>
    <div id="how-it-works-modal" class="modal-overlay hidden fixed inset-0 bg-slate-950/90 flex items-center justify-center z-50 p-4">
        <div class="card p-6 w-full max-w-2xl rounded-2xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white font-orbitron">How it works!</h2>
                <button id="close-how-it-works-btn" class="text-3xl font-light leading-none text-slate-400 hover:text-white transition-colors">&times;</button>
            </div>
            <div id="how-it-works-tabs-container" class="border-b border-slate-700 mb-4">
                <nav class="grid grid-cols-4 -mb-px" aria-label="Tabs">
                    <button data-tab="overview" class="how-it-works-tab py-2 font-medium text-sm rounded-t-lg active">Overview</button>
                    <button data-tab="selection" class="how-it-works-tab py-2 font-medium text-sm rounded-t-lg">Selection</button>
                    <button data-tab="ranks-medals" class="how-it-works-tab py-2 font-medium text-sm rounded-t-lg">Bonuses</button>
                    <button data-tab="admin" class="how-it-works-tab py-2 font-medium text-sm rounded-t-lg">Admin</button>
                </nav>
            </div>
            <div id="how-it-works-content" class="text-sm space-y-4 text-slate-300 custom-scrollbar pr-2 overflow-y-auto" style="max-height: 60vh;">
                <!-- Content for How It Works tabs will be populated by JS -->
            </div>
             <div class="mt-6 flex justify-end">
                <button id="close-how-it-works-btn-2" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-6 rounded-lg text-sm">Close</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        document.addEventListener('DOMContentLoaded', async () => {
            // --- CONFIGURATION ---
            const CONFIG = {
                RANK_LUCK: { 'R1': 10, 'R2': 25, 'R3': 50, 'R4': 85, 'R5': 130 },
                MEDAL_LUCK: {
                    'VS Gold': 20, 'VS Silver': 18, 'VS Bronze': 15,
                    'Champion Duel - Alliance Gold': 30,
                    'Champion Duel - Alliance Silver': 25,
                    'Champion Duel - Alliance Bronze': 20,
                    'General\'s Trial - Gold': 10,
                    'Desert Storm Team A - MVP': 5, 'Desert Storm Team B - MVP': 5,
                    'Star - Killer Award': 15,
                    'Star - Helper Award': 12,
                    'Star - Rally Award': 10,
                    'Alliance Donator - 1st': 10, 'Alliance Donator - 2nd': 8, 'Alliance Donator - 3rd': 5,
                    'Mega Express Medal': 25,
                    'Capitol Award': 15,
                    'Doomsday Award': 10,
                    'Meteorite Award': 5,
                    'Count Master Award': 5,
                    'Frontline Medal': 5,
                },
                RANK_COOLDOWN: { 'R1': 120, 'R2': 90, 'R3': 60, 'R4': 45, 'R5': 40 },
                MEDAL_COOLDOWN_REDUCTION: {
                    'VS Gold': 0.30,
                    'VS Silver': 0.20,
                    'VS Bronze': 0.10,
                    'Champion Duel - Alliance Gold': 0.15,
                    'Champion Duel - Alliance Silver': 0.12,
                    'Champion Duel - Alliance Bronze': 0.10,
                    'General\'s Trial - Gold': 0.05,
                    'Desert Storm Team A - MVP': 0.15,
                    'Desert Storm Team B - MVP': 0.15,
                    'Star - Killer Award': 0.10,
                    'Star - Helper Award': 0.08,
                    'Star - Rally Award': 0.05,
                    'Alliance Donator - 1st': 0.20,
                    'Alliance Donator - 2nd': 0.15,
                    'Alliance Donator - 3rd': 0.10,
                    'Mega Express Medal': 0.50,
                    'Capitol Award': 0.25,
                    'Doomsday Award': 0.20,
                    'Meteorite Award': 0.15,
                    'Count Master Award': 0.10,
                    'Frontline Medal': 0.10,
                },
                SUB_BOOST_LUCK: 50,
            };

            // --- ELEMENTS ---
            const loadingOverlay = document.getElementById('loading-overlay');
            const historyListContainer = document.getElementById('history-list-container');
            const conductorNameSpan = document.getElementById('conductor-name');
            const randomSelectButton = document.getElementById('random-select-button');
            const lockInButton = document.getElementById('lock-in-button');
            const rerollButton = document.getElementById('reroll-button');
            const cancelSelectionButton = document.getElementById('cancel-selection-button');
            const pendingButtonsContainer = document.getElementById('pending-buttons-container');
            const randomButtonsContainer = document.getElementById('random-buttons-container');
            const addMemberButton = document.getElementById('add-member-button');
            const manualPickListContainer = document.getElementById('manual-pick-list-container');
            
            // Main views and panels
            const conductorPanelWrapper = document.getElementById('conductor-panel-wrapper');
            const contentMembers = document.getElementById('content-members');
            const contentHistory = document.getElementById('content-history');
            const contentMedals = document.getElementById('content-medals');

            const memberSearchInput = document.getElementById('member-search-input');
            const historySearchInput = document.getElementById('history-search-input');
            const addHistoryButton = document.getElementById('add-history-button');
            const addHistoryModal = document.getElementById('add-history-modal');
            const addHistoryPlayerSelect = document.getElementById('add-history-player-select');
            const addHistoryDateInput = document.getElementById('add-history-date-input');
            const saveAddHistoryBtn = document.getElementById('save-add-history-btn');
            const cancelAddHistoryBtn = document.getElementById('cancel-add-history-btn');
            
            // Edit History Modal Elements
            const editHistoryModal = document.getElementById('edit-history-modal');
            const editHistoryPlayerName = document.getElementById('edit-history-player-name');
            const editHistoryDateInput = document.getElementById('edit-history-date-input');
            const saveEditHistoryBtn = document.getElementById('save-edit-history-btn');
            const cancelEditHistoryBtn = document.getElementById('cancel-edit-history-btn');

            const addModal = document.getElementById('add-modal');
            const addNameInput = document.getElementById('add-name-input');
            const addRankSelect = document.getElementById('add-rank-select');
            const saveAddBtn = document.getElementById('save-add-btn');
            const cancelAddBtn = document.getElementById('cancel-add-btn');
            const editModal = document.getElementById('edit-modal');
            const editNameInput = document.getElementById('edit-name-input');
            const editRankSelect = document.getElementById('edit-rank-select');
            const saveEditBtn = document.getElementById('save-edit-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const awardMedalSelect = document.getElementById('award-medal-select');
            const awardMedalBtn = document.getElementById('award-medal-btn');
            const activeMedalsList = document.getElementById('active-medals-list');
            const medalsListContainer = document.getElementById('medals-list-container');
            const confirmationModal = document.getElementById('confirmation-modal');
            const confirmationTitle = document.getElementById('confirmation-title');
            const confirmationMessage = document.getElementById('confirmation-message');
            const confirmActionBtn = document.getElementById('confirm-action-btn');
            const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
            const editSubBoostSection = document.getElementById('edit-sub-boost-section');
            const subBoostDescription = document.getElementById('sub-boost-description');
            const removeSubBoostBtn = document.getElementById('remove-sub-boost-btn');

            // Player Info Modal Elements
            const playerInfoModal = document.getElementById('player-info-modal');
            const playerInfoName = document.getElementById('player-info-name');
            const closePlayerInfoBtn = document.getElementById('close-player-info-btn');
            const designateConductorBtn = document.getElementById('designate-conductor-btn');
            const playerInfoEligibility = document.getElementById('player-info-eligibility');
            const playerInfoLuck = document.getElementById('player-info-luck');
            const playerInfoCdReduction = document.getElementById('player-info-cd-reduction');
            const playerInfoActiveMedals = document.getElementById('player-info-active-medals');
            const playerInfoMedalsList = document.getElementById('player-info-medals-list');
            const playerInfoConductorHistoryList = document.getElementById('player-info-conductor-history-list');

            // Award Medal Modal Elements
            const openAwardMedalModalBtn = document.getElementById('open-award-medal-modal-btn');
            const awardMedalModal = document.getElementById('award-medal-modal');
            const awardMedalMemberSelect = document.getElementById('award-medal-member-select');
            const awardMedalTypeSelect = document.getElementById('award-medal-type-select');
            const awardMedalValidationMsg = document.getElementById('award-medal-validation-msg');
            const saveAwardMedalBtn = document.getElementById('save-award-medal-btn');
            const cancelAwardMedalBtn = document.getElementById('cancel-award-medal-btn');

            // Auth Elements
            const loginModal = document.getElementById('login-modal');
            const loginButton = document.getElementById('login-button');
            const cancelLoginBtn = document.getElementById('cancel-login-btn');
            const passwordInput = document.getElementById('password-input');
            const loginErrorMsg = document.getElementById('login-error-msg');
            const loginButtons = [document.getElementById('open-login-modal-btn'), document.getElementById('open-login-modal-btn-mobile')];
            const logoutButtons = [document.getElementById('logout-button'), document.getElementById('logout-button-mobile')];

            // How It Works Modal Elements
            const howItWorksModal = document.getElementById('how-it-works-modal');
            const closeHowItWorksBtn = document.getElementById('close-how-it-works-btn');
            const closeHowItWorksBtn2 = document.getElementById('close-how-it-works-btn-2');
            const howItWorksTabsContainer = document.getElementById('how-it-works-tabs-container');
            const howItWorksContent = document.getElementById('how-it-works-content');
            const howItWorksButtons = [document.getElementById('how-it-works-button'), document.getElementById('how-it-works-button-mobile')];

            // --- LOCAL STATE ---
            let allianceMembers = [];
            let selectionHistory = [];
            let currentConductor = 'SELECT A CONDUCTOR';
            let pendingConductor = null;
            let memberToEditId = null;
            let historyToEditId = null;
            let infoModalMemberId = null;
            let db, docRef;
            let confirmCallback = null;
            let isAuthenticated = false;

            // --- DATE HELPERS ---
            /**
             * Safely parses a date value from various formats into a numeric timestamp.
             * @param {any} dateValue - The value to parse (number, string, or Firestore Timestamp).
             * @returns {number|null} A numeric timestamp or null if parsing fails.
             */
            function getTimestamp(dateValue) {
                if (!dateValue) return null;
                // If it's a Firestore Timestamp object, convert it
                if (typeof dateValue.toDate === 'function') {
                    return dateValue.toDate().getTime();
                }
                // If it's already a valid number (timestamp), return it
                if (typeof dateValue === 'number' && !isNaN(dateValue)) {
                    return dateValue;
                }
                // If it's a string, try parsing it
                if (typeof dateValue === 'string') {
                    const date = new Date(dateValue);
                    if (!isNaN(date.getTime())) {
                        return date.getTime();
                    }
                }
                // Return null if parsing fails
                return null;
            }

            /**
             * Formats a timestamp into a consistent, readable date string.
             * @param {number|null} timestamp - The numeric timestamp to format.
             * @returns {string} A formatted date string (e.g., "07/08/25") or "Invalid Date".
             */
            function formatDate(timestamp) {
                if (timestamp === null || isNaN(timestamp)) {
                    return 'Invalid Date';
                }
                return new Date(timestamp).toLocaleDateString(undefined, {
                    month: '2-digit',
                    day: '2-digit',
                    year: '2-digit'
                });
            }


            // --- FIREBASE SETUP ---
            async function initializeFirebase() {
                try {
                    const firebaseConfig = {
                      apiKey: "AIzaSyBL9GRWKf15wDTYdguYnQtU28WblgqT5jE",
                      authDomain: "allianceconductor.firebaseapp.com",
                      projectId: "allianceconductor",
                      storageBucket: "allianceconductor.appspot.com",
                      messagingSenderId: "650853696222",
                      appId: "1:650853696222:web:a3c418857558336bee384f"
                    };

                    const docId = 'conductor-selector-data';
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    const auth = getAuth(app);

                    await signInAnonymously(auth);

                    const collectionPath = `conductors`;
                    docRef = doc(db, collectionPath, docId);

                    onSnapshot(docRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            allianceMembers = (data.members || []).map((member, index) => {
                                if (typeof member === 'string') {
                                    return { id: Date.now() + index, name: member, rank: 'R1', medals: [], subBoost: false };
                                }
                                // Sanitize medal dates on load
                                const medals = (member.medals || []).map(m => ({
                                    ...m,
                                    id: m.id || Date.now() + Math.random(),
                                    awardedDate: getTimestamp(m.awardedDate),
                                    expires: getTimestamp(m.expires)
                                }));
                                return { ...member, id: member.id || Date.now() + index, medals: medals, subBoost: member.subBoost || false };
                            });
                            
                            // Sanitize history dates on load
                            selectionHistory = (data.history || []).map((item, index) => ({
                                ...item,
                                date: getTimestamp(item.date),
                                id: item.id || Date.now() + index
                            }));

                            currentConductor = data.currentConductor || 'SELECT A CONDUCTOR';
                        } else {
                            console.log("No data found in Firestore. Initializing with default data.");
                            initializeDefaultData();
                        }
                        renderAll();
                        loadingOverlay.style.opacity = '0';
                        setTimeout(() => loadingOverlay.style.display = 'none', 300);
                    });

                } catch (error) {
                    console.error("Firebase Initialization Error:", error);
                    loadingOverlay.innerHTML = `<p class="text-red-400 text-center">Connection Failed.<br>Please check console for errors.</p>`;
                }
            }

            // --- DATA MANAGEMENT ---
            async function updateFirestore() {
                if (!isAuthenticated) {
                    console.log("Not authenticated. Skipping Firestore update.");
                    return;
                }
                if (!docRef) return;
                try {
                    const sanitizedMembers = allianceMembers.map(m => ({
                        id: m.id,
                        name: m.name,
                        rank: m.rank,
                        medals: m.medals || [],
                        subBoost: m.subBoost || false,
                    }));

                    await setDoc(docRef, {
                        members: sanitizedMembers,
                        history: selectionHistory,
                        currentConductor: currentConductor
                    });
                } catch (error) {
                    console.error("Error updating Firestore:", error);
                }
            }

            function initializeDefaultData() {
                allianceMembers = ["13Edy13", "Aceman12", "Aheleosthe2nd", "AirForester", "Andre Rabelo", "Anthony 69", "Arghonut 모험가", "atalon", "aZzIel", "Bamslang", "Basow", "Beezees", "Belleroo", "Bettel nerd", "B L Ä N K", "bobo1987 보보", "CaeTaka", "CaptainObviouss", "Chan 찬", "Chefjuanpi", "Churchill JAPABR", "Cindelll", "Curty Mc", "Dauntethemechanic", "DARS MILK", "Dino1311", "Dollystroyer", "DontWorryDaddysHere", "Drewstroyer", "Duck0311", "Dumpchicken", "Ender", "foxzilla", "Gangster 25", "General Bjam", "Grande Anão", "GPêê", "Guerneros del Chaco", "Gunbarista", "Hadrianswall", "ilovecafs", "Isorryl", "jessictia", "Jmelo1686", "JojoBans", "JTWolf", "KAYRONMAN", "KBL50", "Keylonis", "Kitt3nnnn", "LÄDY", "Leccarré", "leoyutian", "likes2ride", "LION 1937", "MÄXIMÜS", "MattCat 맷 더 캣", "Mayhem007", "Maz·Ibrahim.ч", "MICH3773", "MotoM0t0", "Mr Peaches", "Ms Andrea", "n3tt1k", "NinerGang211", "NikolaiVolkoff", "NoShtSherlock 셜록", "NyahNyah메롱", "Peacekëeper", "PewnurScope", "Ratatoui11e", "Reb13", "Risssy", "Robert ツ", "ScopeWraith", "scrap11", "SHAMAN ЛЮТЬ", "Shbeda", "SimBLÄ NK", "SimplyMom", "SniperXT3", "SN0WMan", "Squeeze1", "st ALBA", "SuperElectron Bioman", "techwrath", "TeeOhiNwhY", "The Palette", "Tigerfan1", "turtletime 거북이", "uJeam", "UrSwigBoaBro", "VENOM THENEW CARNAGE", "Vuladi", "Warrior Poet", "Whedonite92", "Xelaesor", "Zerrrro", "윤스 oops", "에녹 · Enoch"]
                .map((name, index) => ({ id: Date.now() + index, name: name, rank: 'R1', medals: [], subBoost: false }));
                selectionHistory = [{ player: "Rat", date: Date.now() - 86400000 * 2, id: Date.now()+1 }, { player: "Lecarre", date: Date.now() - 86400000 * 3, id: Date.now()+2 }, { player: "MagicalMike (AllDayDad)", date: Date.now() - 86400000 * 4, id: Date.now()+3 }];
                currentConductor = 'SELECT A CONDUCTOR';
                if (isAuthenticated) updateFirestore();
            }

            function awardMedal(memberId, medalName) {
                const memberIndex = allianceMembers.findIndex(m => m.id === memberId);
                if (memberIndex > -1) {
                    const member = allianceMembers[memberIndex];
                    const now = Date.now();
                    const newMedal = {
                        id: now,
                        name: medalName,
                        awardedDate: now,
                        expires: now + (30 * 24 * 60 * 60 * 1000)
                    };
                    if (!member.medals) member.medals = [];
                    member.medals.push(newMedal);

                    updateFirestore();
                    return true;
                }
                return false;
            }

            // --- RENDER FUNCTIONS ---
            function populateHowItWorksContent() {
                howItWorksContent.innerHTML = `
                <div id="tab-content-overview" class="how-it-works-tab-content">
                    <p>This tool is designed to select a "Train Conductor" from a pool of alliance members based on a weighted random selection. The goal is to create a fair, transparent, and balanced rotation that rewards active and high-ranking members while still giving everyone a chance.</p>
                    <ul class="list-disc list-inside space-y-2 mt-4">
                        <li><strong>Fairness First:</strong> The system uses a "Luck" score to weigh the odds. Higher luck means a better chance of being selected, but it never guarantees it.</li>
                        <li><strong>Cooldown System:</strong> After a member serves as conductor, they enter a cooldown period to ensure others get a turn.</li>
                        <li><strong>Rewarding Performance:</strong> Higher ranks and special medals provide bonuses to a member's luck and can reduce their cooldown time, rewarding dedication and achievement.</li>
                        <li><strong>Admin Management:</strong> Logged-in administrators have full control over the member list, selection history, and medal awards to keep the system up-to-date.</li>
                    </ul>
                </div>
                <div id="tab-content-selection" class="how-it-works-tab-content">
                    <h3 class="font-semibold text-cyan-400 mb-2 text-lg">The Drawing</h3>
                    <p>When an admin clicks the "Choose Conductor" button, the system performs a weighted random drawing from all eligible members.</p>
                    <ul class="list-disc list-inside space-y-2 mt-2">
                        <li><strong>Eligibility:</strong> A member is considered eligible if they are not on cooldown. If all members are on cooldown, this rule is ignored and everyone becomes eligible.</li>
                        <li><strong>Luck Score:</strong> Each eligible member's chance is determined by their total Luck score. The formula is essentially <code>1 + Rank Luck + Medal Luck + Sub Boost</code>. This score becomes their "weight" in the drawing.</li>
                        <li><strong>The Pick:</strong> The system chooses a winner from the eligible pool based on these weights. A member with a 100 Luck score has roughly double the chance of being picked as a member with a 50 Luck score.</li>
                        <li><strong>Pending Confirmation:</strong> The chosen member is not final until an admin clicks "Lock In". This allows for re-rolls if the selected member is unavailable.</li>
                        <li><strong>Re-rolling:</strong> If the "Re-roll" button is used, the pending conductor is returned to the pool for the next drawing without any penalty or bonus, and a new conductor is chosen from the remaining eligible members.</li>
                        <li><strong>Substitution Boost:</strong> If a chosen conductor is substituted, they are put back into the pool and receive a temporary <strong>+50% "Sub Boost"</strong> to their luck. This boost is removed the next time they are successfully locked in as conductor.</li>
                    </ul>
                </div>
                <div id="tab-content-ranks-medals" class="how-it-works-tab-content space-y-6">
                    <div>
                        <h3 class="font-semibold text-cyan-400 mb-2 text-lg">Rank Bonuses</h3>
                        <p class="mb-3">A member's rank determines their base cooldown period and provides a permanent luck bonus.</p>
                        <div class="overflow-x-auto"><table class="w-full text-left border-collapse"><thead><tr class="bg-slate-800/50"><th class="p-2 font-semibold text-white">Rank</th><th class="p-2 font-semibold text-white">Cooldown</th><th class="p-2 font-semibold text-white">Luck Bonus</th></tr></thead><tbody id="how-it-works-rank-bonus-table"></tbody></table></div>
                    </div>
                     <div>
                        <h3 class="font-semibold text-cyan-400 mb-2 text-lg">Medal Bonuses (30 Day Duration)</h3>
                        <p class="mb-3">Awarded medals provide powerful, temporary bonuses for 30 days. They can increase luck, reduce cooldowns, or both.</p>
                        <div class="overflow-x-auto"><table class="w-full text-left border-collapse"><thead><tr class="bg-slate-800/50"><th class="p-2 font-semibold text-white">Medal Name</th><th class="p-2 font-semibold text-white">Luck Bonus</th><th class="p-2 font-semibold text-white">CD Reduction</th></tr></thead><tbody id="how-it-works-medal-bonus-table"></tbody></table></div>
                    </div>
                </div>
                <div id="tab-content-admin" class="how-it-works-tab-content">
                    <h3 class="font-semibold text-cyan-400 mb-2 text-lg">Admin Responsibilities</h3>
                    <p>To access administrative controls, you must log in using the provided credentials. Admins are responsible for maintaining the accuracy of the tool.</p>
                    <ul class="list-disc list-inside space-y-2 mt-2">
                        <li><strong>Manage Members:</strong> Add new members, edit their name and rank, or remove them from the alliance list via the "Members" tab.</li>
                        <li><strong>Award Medals:</strong> Award medals to members to grant them temporary bonuses. This can be done from the "Medals" tab or from the member edit screen.</li>
                        <li><strong>Designate Conductor:</strong> Manually set a member as the conductor by clicking their name in the "Members" list to open the Player Information Card and using the "Designate" button.</li>
                        <li><strong>Manage History:</strong> Manually add or delete past conductor records from the "History" tab to correct errors or fill in missing data.</li>
                    </ul>
                </div>`;
                populateBonusTables();
            }

            function populateBonusTables() {
                const rankTableBody = document.getElementById("how-it-works-rank-bonus-table");
                if (!rankTableBody) return;
                rankTableBody.innerHTML = '';
                Object.keys(CONFIG.RANK_COOLDOWN).forEach(rank => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-slate-700/50';
                    row.innerHTML = `<td class="p-2 font-semibold text-cyan-400">${rank}</td><td class="p-2">${CONFIG.RANK_COOLDOWN[rank]} days</td><td class="p-2">+${CONFIG.RANK_LUCK[rank]}%</td>`;
                    rankTableBody.appendChild(row);
                });

                const medalTableBody = document.getElementById("how-it-works-medal-bonus-table");
                 if (!medalTableBody) return;
                medalTableBody.innerHTML = '';
                const medalDisplayOrder = [
                    'VS Gold', 'VS Silver', 'VS Bronze', 'Champion Duel - Alliance Gold', 'Champion Duel - Alliance Silver', 'Champion Duel - Alliance Bronze',
                    'Star - Killer Award', 'Star - Helper Award', 'Star - Rally Award', 'Desert Storm Team A - MVP', 'Desert Storm Team B - MVP',
                    'Alliance Donator - 1st', 'Alliance Donator - 2nd', 'Alliance Donator - 3rd', 'Mega Express Medal', 'Capitol Award',
                    'Doomsday Award', 'General\'s Trial - Gold', 'Meteorite Award', 'Count Master Award', 'Frontline Medal'
                ];
                medalDisplayOrder.forEach(medal => {
                    const luck = CONFIG.MEDAL_LUCK[medal] || 0;
                    const reduction = CONFIG.MEDAL_COOLDOWN_REDUCTION[medal] || 0;
                    const row = document.createElement('tr');
                    row.className = 'border-b border-slate-700/50';
                    row.innerHTML = `<td class="p-2">${medal}</td><td class="p-2">+${luck}%</td><td class="p-2">${Math.round(reduction * 100)}%</td>`;
                    medalTableBody.appendChild(row);
                });
            }

            function populateMedalSelect(selectElement) {
                selectElement.innerHTML = `<option value="">Select a medal...</option>`;
                Object.keys(CONFIG.MEDAL_LUCK).sort().forEach(medalName => {
                    const option = document.createElement('option');
                    option.value = medalName;
                    option.textContent = medalName;
                    selectElement.appendChild(option);
                });
            }

            const renderManualPickList = () => {
                const searchTerm = memberSearchInput.value.toLowerCase();
                manualPickListContainer.innerHTML = '';
                const filteredMembers = allianceMembers.filter(member => member.name.toLowerCase().includes(searchTerm));

                [...filteredMembers].sort((a, b) => a.name.localeCompare(b.name)).forEach(member => {
                    const div = document.createElement('div');
                    div.className = 'item-enter flex justify-between items-center p-2 rounded-lg hover:bg-slate-700/50 transition-colors duration-200 group text-sm';
                    const cooldownInfo = getMemberCooldownInfo(member.name);
                    const onCooldown = cooldownInfo && cooldownInfo.remainingDays > 0;
                    const nameColorClass = onCooldown ? 'text-slate-400' : 'text-green-400';
                    const activeMedalsCount = member.medals ? member.medals.filter(m => m.expires > Date.now()).length : 0;
                    const totalCooldownReduction = calculateCooldownReduction(member);
                    const cooldownReductionText = totalCooldownReduction > 0 ? `${Math.round(totalCooldownReduction * 100)}%` : '-';
                    const totalLuck = calculateTotalLuck(member);
                    let subBoostIndicator = member.subBoost ? `<span class="ml-2 text-xs font-bold bg-yellow-500/80 text-white px-2 py-0.5 rounded-full" title="+${CONFIG.SUB_BOOST_LUCK}% Luck Boost">SUB</span>` : '';

                    div.innerHTML = `
                        <div class="flex-grow flex items-center overflow-hidden">
                            <button class="text-left player-info-trigger truncate w-full" data-id="${member.id}" title="${member.name}">
                                <span class="font-semibold ${nameColorClass}">${member.name}</span><span class="text-xs text-slate-500 ml-2">${member.rank}</span>${subBoostIndicator}
                            </button>
                        </div>
                        <div class="flex-shrink-0 flex items-center space-x-2 text-xs text-center pointer-events-none">
                             <div class="w-10"><span class="font-bold text-cyan-400">${totalLuck}%</span><span class="block text-slate-500 text-[10px]">Luck %</span></div>
                             <div class="w-10"><span class="font-bold text-purple-400">${cooldownReductionText}</span><span class="block text-slate-500 text-[10px]">CD %</span></div>
                            <div class="w-10"><span class="font-bold text-amber-400">${activeMedalsCount}</span><span class="block text-slate-500 text-[10px]">Medals</span></div>
                        </div>
                        <div class="admin-control flex items-center space-x-2 opacity-0 group-hover:opacity-100 transition-opacity ml-2">
                            <button class="edit-member-btn text-slate-400 hover:text-cyan-400" data-id="${member.id}" title="Edit member"><i class="fa-solid fa-pencil w-4 h-4"></i></button>
                            <button class="delete-member-btn text-slate-400 hover:text-red-400" data-id="${member.id}" title="Delete member"><i class="fa-solid fa-trash-can w-4 h-4"></i></button>
                        </div>`;
                    manualPickListContainer.appendChild(div);
                });
            };

            const renderHistory = () => {
                const searchTerm = historySearchInput.value.toLowerCase();
                historyListContainer.innerHTML = '';

                const conductorEvents = selectionHistory.map(item => ({...item, type: 'conductor'}));
                const medalEvents = allianceMembers.flatMap(member => 
                    (member.medals || []).map(medal => ({
                        id: medal.id,
                        player: member.name,
                        date: medal.awardedDate,
                        medalName: medal.name,
                        type: 'medal'
                    }))
                );

                const combinedHistory = [...conductorEvents, ...medalEvents];
                const sortedHistory = combinedHistory.sort((a, b) => (b.date || 0) - (a.date || 0));
                const filteredHistory = sortedHistory.filter(item => 
                    item.player.toLowerCase().includes(searchTerm) || 
                    (item.type === 'medal' && item.medalName.toLowerCase().includes(searchTerm))
                );

                const groupedByDay = filteredHistory.reduce((acc, item) => {
                    if (!item.date) return acc;
                    const dateStr = new Date(item.date).toLocaleDateString();
                    if (!acc[dateStr]) {
                        acc[dateStr] = [];
                    }
                    acc[dateStr].push(item);
                    return acc;
                }, {});

                Object.keys(groupedByDay).forEach(dateStr => {
                    const groupDate = new Date(groupedByDay[dateStr][0].date);
                    const today = new Date();
                    let dateString = groupDate.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    if (groupDate.toDateString() === today.toDateString()) {
                        dateString += ' (Today)';
                    }

                    const dateHeader = document.createElement('div');
                    dateHeader.className = 'text-sm font-semibold text-slate-400 pt-3 pb-1 border-b-2 border-slate-700/50';
                    historyListContainer.appendChild(dateHeader);
                    dateHeader.textContent = dateString;
                    
                    const dayContainer = document.createElement('div');
                    dayContainer.className = 'space-y-1.5 pt-2';

                    groupedByDay[dateStr].forEach(item => {
                        const div = document.createElement('div');
                        let iconHtml, textHtml, adminHtml = '';
                        const member = allianceMembers.find(m => m.name === item.player);
                        const playerNameHTML = member 
                                ? `<button class="font-bold text-white underline hover:text-cyan-300 player-info-trigger" data-id="${member.id}">${item.player}</button>`
                                : `<span class="font-bold text-white">${item.player}</span>`;
                        
                        div.className = 'item-enter flex items-center gap-3 py-1.5 px-2 rounded-lg bg-slate-800/40';

                        if (item.type === 'conductor') {
                            iconHtml = `<div class="flex-shrink-0 w-8 h-8 rounded-full bg-cyan-500/20 flex items-center justify-center"><i class="fa-solid fa-train-subway text-cyan-400"></i></div>`;
                            textHtml = `<div><p class="font-semibold text-white">${playerNameHTML}</p><p class="text-xs text-slate-400">Became Conductor</p></div>`;
                            adminHtml = `<div class="flex items-center space-x-2 ml-auto">
                                            <button class="admin-control edit-history-btn text-slate-400 hover:text-cyan-400" data-id="${item.id}" title="Edit history entry"><i class="fa-solid fa-pencil w-3 h-3"></i></button>
                                            <button class="admin-control delete-history-btn text-slate-500 hover:text-red-400" data-id="${item.id}" title="Delete history entry"><i class="fa-solid fa-trash-can w-3 h-3"></i></button>
                                         </div>`;
                        } else { // Medal Event
                             if (item.medalName === 'Mega Express Medal') {
                                div.classList.add('bg-gradient-to-br', 'from-cyan-500/20', 'to-blue-800/20');
                                iconHtml = `<div class="flex-shrink-0 w-8 h-8 rounded-full bg-cyan-500/30 flex items-center justify-center"><i class="fa-solid fa-heart text-cyan-300 animate-pulse"></i></div>`;
                                textHtml = `<div><p class="font-semibold text-white">${playerNameHTML}</p><p class="text-xs font-semibold text-cyan-300">Awarded <span class="text-white">${item.medalName}</span></p></div>`;
                            } else {
                                iconHtml = `<div class="flex-shrink-0 w-8 h-8 rounded-full bg-amber-500/20 flex items-center justify-center"><i class="fa-solid fa-medal text-amber-400"></i></div>`;
                                textHtml = `<div><p class="font-semibold text-white">${playerNameHTML}</p><p class="text-xs text-slate-400">Awarded <span class="font-semibold text-amber-300">${item.medalName}</span></p></div>`;
                            }
                        }
                        div.innerHTML = iconHtml + textHtml + (adminHtml || '');
                        dayContainer.appendChild(div);
                    });
                    historyListContainer.appendChild(dayContainer);
                });
            };

            const renderConductor = () => {
                if (currentConductor && currentConductor !== 'SELECT A CONDUCTOR') {
                    conductorNameSpan.textContent = currentConductor;
                    conductorNameSpan.classList.remove('text-slate-500', 'text-cyan-400');
                    conductorNameSpan.classList.add('text-white', 'conductor-reveal', 'text-glow-gold');
                    conductorNameSpan.addEventListener('animationend', () => conductorNameSpan.classList.remove('conductor-reveal'), { once: true });
                } else {
                    conductorNameSpan.textContent = 'SELECT A CONDUCTOR';
                    conductorNameSpan.classList.remove('text-white', 'text-glow-gold', 'text-cyan-400');
                    conductorNameSpan.classList.add('text-slate-500');
                }
            };

            const renderActiveMedalsInEditModal = () => {
                if (memberToEditId === null) return;
                const member = allianceMembers.find(m => m.id === memberToEditId);
                activeMedalsList.innerHTML = '';
                if (!member || !member.medals || member.medals.length === 0) {
                    activeMedalsList.innerHTML = `<p class="text-xs text-slate-400 italic">No active medals.</p>`;
                    return;
                }
                const activeMedals = member.medals.filter(medal => medal.expires > Date.now());
                if (activeMedals.length === 0) {
                     activeMedalsList.innerHTML = `<p class="text-xs text-slate-400 italic">No active medals.</p>`;
                     return;
                }
                activeMedals.forEach(medal => {
                    const daysLeft = Math.ceil((medal.expires - Date.now()) / (1000 * 60 * 60 * 24));
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center bg-slate-700/50 p-2 rounded-md';
                    div.innerHTML = `<div><p class="text-sm font-semibold text-white">${medal.name}</p><p class="text-xs text-slate-400">Expires in ${daysLeft} day(s)</p></div><button class="remove-medal-btn text-red-500 hover:text-red-400" data-medal-id="${medal.id}" title="Remove Medal">&times;</button>`;
                    activeMedalsList.appendChild(div);
                });
            };

            const renderMedalsTab = () => {
                medalsListContainer.innerHTML = '';
                const now = Date.now();
                const allActiveMedals = allianceMembers.reduce((acc, member) => {
                    if (member.medals) {
                        acc.push(...member.medals.filter(medal => medal.expires > now).map(medal => ({ ...medal, memberName: member.name })));
                    }
                    return acc;
                }, []).sort((a, b) => b.awardedDate - a.awardedDate);

                if (allActiveMedals.length === 0) {
                    medalsListContainer.innerHTML = `<p class="text-sm text-slate-400 italic text-center">No active medals.</p>`;
                    return;
                }
                allActiveMedals.forEach(medal => {
                    const daysLeft = Math.ceil((medal.expires - now) / (1000 * 60 * 60 * 24));
                    const div = document.createElement('div');
                    div.className = 'item-enter flex items-center justify-between p-2 rounded-lg bg-slate-800/50 text-sm';
                    div.innerHTML = `<div class="flex-grow"><p class="font-semibold text-cyan-300">${medal.name}</p><p class="text-xs text-slate-300">Awarded to <span class="font-bold text-white">${medal.memberName}</span></p></div><div class="text-right flex-shrink-0 ml-2"><p class="font-semibold text-white">${formatDate(medal.awardedDate)}</p><p class="text-xs text-slate-400">${daysLeft}d left</p></div>`;
                    medalsListContainer.appendChild(div);
                });
            };

            const renderAll = () => {
                renderManualPickList();
                renderHistory();
                renderConductor();
                renderMedalsTab();
            };

            // --- LUCK & COOLDOWN CALCULATION ---
            const getMemberCooldownInfo = (memberName) => {
                const memberObject = allianceMembers.find(m => m.name === memberName);
                if (!memberObject) return null;

                const sortedMemberHistory = selectionHistory.filter(h => h.player === memberObject.name && h.date !== null).sort((a, b) => b.date - a.date);
                if (sortedMemberHistory.length === 0) return { remainingDays: 0, eligibilityDate: new Date() };

                const lastSelection = sortedMemberHistory[0];
                const lastDate = new Date(lastSelection.date); // This is now safe because dates are sanitized on load
                const today = new Date();
                today.setHours(0,0,0,0);

                const baseCooldownDays = CONFIG.RANK_COOLDOWN[memberObject.rank] || 30;
                const cooldownReductionPercent = calculateCooldownReduction(memberObject);
                const effectiveCooldownDays = Math.round(baseCooldownDays * (1 - cooldownReductionPercent));

                const eligibilityDate = new Date(lastDate.getTime());
                eligibilityDate.setDate(eligibilityDate.getDate() + effectiveCooldownDays);

                const diffTime = eligibilityDate - today;
                const remainingDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                return { remainingDays: Math.max(0, remainingDays), eligibilityDate };
            };

            const calculateCooldownReduction = (member) => {
                let totalReduction = 0;
                if (member.medals) {
                    member.medals.forEach(medal => {
                        if (medal.expires > Date.now() && CONFIG.MEDAL_COOLDOWN_REDUCTION[medal.name]) {
                            totalReduction += CONFIG.MEDAL_COOLDOWN_REDUCTION[medal.name];
                        }
                    });
                }
                return totalReduction;
            };

            const calculateTotalLuck = (member) => {
                let totalLuck = CONFIG.RANK_LUCK[member.rank] || 0;
                if (member.medals) {
                    member.medals.forEach(medal => {
                        if (medal.expires > Date.now()) {
                            totalLuck += CONFIG.MEDAL_LUCK[medal.name] || 0;
                        }
                    });
                }
                if (member.subBoost) {
                    totalLuck += CONFIG.SUB_BOOST_LUCK;
                }
                return totalLuck;
            };

            // --- UI STATE & AUTH MANAGEMENT ---
            function setAuthState(state) {
                isAuthenticated = state;
                document.body.classList.toggle('logged-in', state);
                document.body.classList.toggle('logged-out', !state);
                if (state) loginModal.classList.add('hidden');
                renderManualPickList();
                renderHistory();
            }

            function showPendingMode(name) {
                pendingConductor = name;
                conductorNameSpan.textContent = name;
                conductorNameSpan.classList.remove('text-white', 'text-glow-gold', 'text-slate-500');
                conductorNameSpan.classList.add('text-cyan-400');
                randomButtonsContainer.classList.add('hidden');
                pendingButtonsContainer.classList.remove('hidden');
            }

            function showRandomMode() {
                pendingConductor = null;
                renderConductor();
                randomButtonsContainer.classList.remove('hidden');
                pendingButtonsContainer.classList.add('hidden');
            }

            function showConfirmationModal(title, message, onConfirm) {
                confirmationTitle.textContent = title;
                confirmationMessage.textContent = message;
                confirmCallback = onConfirm;
                confirmationModal.classList.remove('hidden');
            }

            function openPlayerInfoModal(memberId) {
                infoModalMemberId = memberId;
                const member = allianceMembers.find(m => m.id === memberId);
                if (!member) return;

                playerInfoName.textContent = member.name;
                playerInfoLuck.textContent = `${calculateTotalLuck(member)}%`;
                playerInfoCdReduction.textContent = `${Math.round(calculateCooldownReduction(member) * 100)}%`;
                const activeMedalsCount = member.medals ? member.medals.filter(m => m.expires > Date.now()).length : 0;
                playerInfoActiveMedals.textContent = activeMedalsCount;

                const cooldownInfo = getMemberCooldownInfo(member.name);
                if (cooldownInfo && cooldownInfo.remainingDays > 0) {
                    playerInfoEligibility.textContent = `On ${new Date(cooldownInfo.eligibilityDate).toLocaleDateString(undefined, { month: 'short', day: 'numeric' })}`;
                    playerInfoEligibility.className = 'text-lg font-bold text-amber-400';
                } else {
                    playerInfoEligibility.textContent = 'Eligible Now';
                    playerInfoEligibility.className = 'text-lg font-bold text-green-400';
                }

                playerInfoMedalsList.innerHTML = !member.medals || member.medals.length === 0 ? `<p class="text-sm text-slate-400 italic text-center">No medals earned.</p>` : [...member.medals].sort((a, b) => b.awardedDate - a.awardedDate).map(medal => `<div class="flex justify-between items-center bg-slate-800/50 p-2 rounded-md"><span class="font-semibold ${medal.expires < Date.now() ? 'text-slate-500' : 'text-green-400'}">${medal.name}</span><span class="text-xs text-slate-400">${formatDate(medal.awardedDate)}</span></div>`).join('');
                
                const memberHistory = selectionHistory.filter(h => h.player === member.name).sort((a,b) => b.date - a.date);
                playerInfoConductorHistoryList.innerHTML = memberHistory.length === 0 ? `<p class="text-sm text-slate-400 italic text-center">No conductor history.</p>` : memberHistory.map(entry => `<div class="flex justify-between items-center bg-slate-800/50 p-2 rounded-md"><span class="font-semibold text-slate-300">Conductor</span><span class="text-xs text-slate-400">${formatDate(entry.date)}</span></div>`).join('');

                playerInfoModal.classList.remove('hidden');
            }
            
            function triggerConfetti() {
                const canvas = document.getElementById('confetti-canvas');
                const myConfetti = confetti.create(canvas, { resize: true, useWorker: true });
                const duration = 2 * 1000, animationEnd = Date.now() + duration;
                const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 100 };
                function randomInRange(min, max) { return Math.random() * (max - min) + min; }
                const interval = setInterval(() => {
                  const timeLeft = animationEnd - Date.now();
                  if (timeLeft <= 0) return clearInterval(interval);
                  const particleCount = 50 * (timeLeft / duration);
                  myConfetti({ ...defaults, particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } });
                  myConfetti({ ...defaults, particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } });
                }, 250);
            }

            // --- CORE LOGIC & EVENT HANDLERS ---
            const selectRandomly = (pool, buttonToUpdate, excludedMember = null) => {
                if (!isAuthenticated) return;
                showRandomMode();
                if (pool.length === 0) return;

                randomSelectButton.disabled = true;
                if (buttonToUpdate) buttonToUpdate.textContent = 'CHOOSING...';

                const eligibleByCooldown = pool.filter(member => (!getMemberCooldownInfo(member.name) || getMemberCooldownInfo(member.name).remainingDays <= 0) && (!excludedMember || member.name !== excludedMember.name));
                const selectionPool = eligibleByCooldown.length > 0 ? eligibleByCooldown : pool.filter(m => excludedMember ? m.name !== excludedMember.name : true);

                if (selectionPool.length === 0) {
                    console.log("No eligible members found.");
                    randomSelectButton.disabled = false;
                    if(buttonToUpdate) buttonToUpdate.textContent = 'CHOOSE CONDUCTOR';
                    return;
                }
                
                const weightedPool = selectionPool.map(member => ({ member, weight: 1 + calculateTotalLuck(member) }));
                const totalWeight = weightedPool.reduce((sum, item) => sum + item.weight, 0);
                let randomWeight = Math.random() * totalWeight;
                let winner = weightedPool[weightedPool.length - 1].member;

                for(const item of weightedPool) {
                    randomWeight -= item.weight;
                    if (randomWeight <= 0) { winner = item.member; break; }
                }

                let drumRollCount = 0;
                const drumRollInterval = setInterval(() => {
                    conductorNameSpan.textContent = selectionPool[Math.floor(Math.random() * selectionPool.length)].name;
                    conductorNameSpan.classList.remove('text-white', 'text-glow-gold');
                    conductorNameSpan.classList.add('text-cyan-400');
                    if (++drumRollCount > 15) {
                        clearInterval(drumRollInterval);
                        showPendingMode(winner.name);
                        randomSelectButton.disabled = false;
                        if(buttonToUpdate) buttonToUpdate.textContent = 'CHOOSE CONDUCTOR';
                    }
                }, 100);
            };
            
            // --- TAB SWITCHING LOGIC ---
            function switchMainContentTab(tabName) {
                // Deactivate all main content tabs
                document.querySelectorAll('#desktop-nav [data-tab], #mobile-nav [data-tab]').forEach(btn => {
                    if (btn.dataset.tab !== 'conductor') {
                        btn.classList.remove('active');
                    }
                });
                // Activate the selected main content tab
                document.querySelectorAll(`[data-tab="${tabName}"]`).forEach(btn => btn.classList.add('active'));

                // Show the correct content panel
                [contentMembers, contentHistory, contentMedals].forEach(p => p.classList.add('hidden'));
                const contentPanel = document.getElementById(`content-${tabName}`);
                if (contentPanel) {
                    contentPanel.classList.remove('hidden');
                }
            }

            function toggleConductorPanel() {
                const isVisible = conductorPanelWrapper.classList.toggle('is-visible');
                document.querySelectorAll('[data-tab="conductor"]').forEach(b => b.classList.toggle('active', isVisible));
            }

            // Combined event listener for all navigation
            document.querySelectorAll('#desktop-nav button, #mobile-nav button').forEach(button => {
                button.addEventListener('click', () => {
                    const tabName = button.dataset.tab;
                    if (tabName === 'conductor') {
                        toggleConductorPanel();
                    } else {
                        switchMainContentTab(tabName);
                    }
                });
            });


            // --- EVENT LISTENERS ---
            addMemberButton.addEventListener('click', () => { if(isAuthenticated) addModal.classList.remove('hidden'); });
            
            manualPickListContainer.addEventListener('click', (e) => {
                const infoTrigger = e.target.closest('.player-info-trigger');
                const editBtn = e.target.closest('.edit-member-btn');
                const deleteBtn = e.target.closest('.delete-member-btn');

                if (infoTrigger) {
                    openPlayerInfoModal(parseFloat(infoTrigger.dataset.id));
                } else if (editBtn && isAuthenticated) {
                    memberToEditId = parseFloat(editBtn.dataset.id);
                    const member = allianceMembers.find(m => m.id === memberToEditId);
                    if (member) {
                        editNameInput.value = member.name;
                        editRankSelect.value = member.rank;
                        editSubBoostSection.classList.toggle('hidden', !member.subBoost);
                        if(member.subBoost) subBoostDescription.textContent = `Provides a +${CONFIG.SUB_BOOST_LUCK}% luck bonus.`;
                        renderActiveMedalsInEditModal();
                        editModal.classList.remove('hidden');
                    }
                } else if (deleteBtn && isAuthenticated) {
                    showConfirmationModal('Delete Member?', 'Are you sure you want to remove this member permanently?', () => {
                        allianceMembers = allianceMembers.filter(m => m.id !== parseFloat(deleteBtn.dataset.id));
                        updateFirestore();
                    });
                }
            });

            lockInButton.addEventListener('click', () => {
                if (!isAuthenticated || !pendingConductor) return;
                showConfirmationModal('Lock In Conductor?', `Are you sure you want to lock in ${pendingConductor}?`, () => {
                    currentConductor = pendingConductor;
                    selectionHistory.unshift({ player: currentConductor, date: Date.now(), id: Date.now() });
                    const memberIndex = allianceMembers.findIndex(m => m.name === currentConductor);
                    if (memberIndex > -1 && allianceMembers[memberIndex].subBoost) {
                        allianceMembers[memberIndex].subBoost = false;
                    }
                    updateFirestore();
                    showRandomMode();
                    triggerConfetti();
                });
            });

            rerollButton.addEventListener('click', () => {
                if (!isAuthenticated || !pendingConductor) return;
                showConfirmationModal('Re-roll Conductor?', `This will return ${pendingConductor} to the pool and pick a new conductor.`, () => {
                    const originalPick = allianceMembers.find(m => m.name === pendingConductor);
                    selectRandomly(allianceMembers, null, originalPick);
                });
            });
            
            cancelSelectionButton.addEventListener('click', () => { if (isAuthenticated) showRandomMode(); });

            historyListContainer.addEventListener('click', (e) => {
                 const deleteButton = e.target.closest('.delete-history-btn');
                 const editButton = e.target.closest('.edit-history-btn');
                 const playerTrigger = e.target.closest('.player-info-trigger');

                 if (playerTrigger) {
                    const memberId = parseFloat(playerTrigger.dataset.id);
                    if (!isNaN(memberId)) {
                        openPlayerInfoModal(memberId);
                    }
                 }
                 
                 if (isAuthenticated) {
                     if (deleteButton) {
                        showConfirmationModal('Delete History Entry?', 'Are you sure you want to remove this history entry?', () => {
                            selectionHistory = selectionHistory.filter(item => item.id !== parseFloat(deleteButton.dataset.id));
                            updateFirestore();
                        });
                     } else if (editButton) {
                        historyToEditId = parseFloat(editButton.dataset.id);
                        const historyItem = selectionHistory.find(item => item.id === historyToEditId);
                        if (historyItem) {
                            editHistoryPlayerName.textContent = historyItem.player;
                            const date = new Date(historyItem.date);
                            const month = (date.getMonth() + 1).toString().padStart(2, '0');
                            const day = date.getDate().toString().padStart(2, '0');
                            const year = date.getFullYear();
                            editHistoryDateInput.value = `${month}-${day}-${year}`;
                            editHistoryModal.classList.remove('hidden');
                        }
                     }
                 }
            });

            saveAddBtn.addEventListener('click', () => {
                if (!isAuthenticated) return;
                const newName = addNameInput.value.trim();
                if (newName && !allianceMembers.some(m => m.name === newName)) {
                    allianceMembers.push({ id: Date.now(), name: newName, rank: addRankSelect.value, medals: [], subBoost: false });
                    updateFirestore();
                    addModal.classList.add('hidden');
                } else if (newName) {
                    console.log("A member with this name already exists.");
                }
            });
            cancelAddBtn.addEventListener('click', () => addModal.classList.add('hidden'));

            saveEditBtn.addEventListener('click', () => {
                if (!isAuthenticated || memberToEditId === null) return;
                const memberIndex = allianceMembers.findIndex(m => m.id === memberToEditId);
                if (memberIndex > -1) {
                    allianceMembers[memberIndex].name = editNameInput.value.trim();
                    allianceMembers[memberIndex].rank = editRankSelect.value;
                    updateFirestore();
                    editModal.classList.add('hidden');
                    memberToEditId = null;
                }
            });
            awardMedalBtn.addEventListener('click', () => {
                if (!isAuthenticated || !memberToEditId) return;
                const medalName = awardMedalSelect.value;
                if(medalName && awardMedal(memberToEditId, medalName)) {
                    renderActiveMedalsInEditModal();
                }
            });
            removeSubBoostBtn.addEventListener('click', () => {
                if (!isAuthenticated || memberToEditId === null) return;
                const memberIndex = allianceMembers.findIndex(m => m.id === memberToEditId);
                if (memberIndex > -1) {
                    allianceMembers[memberIndex].subBoost = false;
                    editSubBoostSection.classList.add('hidden');
                    updateFirestore();
                }
            });
            activeMedalsList.addEventListener('click', (e) => {
                if (!isAuthenticated) return;
                const removeBtn = e.target.closest('.remove-medal-btn');
                if (removeBtn && memberToEditId) {
                    const medalId = parseFloat(removeBtn.dataset.medalId);
                    const memberIndex = allianceMembers.findIndex(m => m.id === memberToEditId);
                    if(memberIndex > -1) {
                        allianceMembers[memberIndex].medals = allianceMembers[memberIndex].medals.filter(m => m.id !== medalId);
                        renderActiveMedalsInEditModal();
                        updateFirestore();
                    }
                }
            });
            cancelEditBtn.addEventListener('click', () => { editModal.classList.add('hidden'); memberToEditId = null; });
            
            addHistoryButton.addEventListener('click', () => {
                if (!isAuthenticated) return;
                addHistoryPlayerSelect.innerHTML = `<option value="">Select a player...</option>`;
                [...allianceMembers].sort((a,b) => a.name.localeCompare(b.name)).forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.name;
                    option.textContent = member.name;
                    addHistoryPlayerSelect.appendChild(option);
                });
                addHistoryDateInput.value = '';
                addHistoryModal.classList.remove('hidden');
            });

            saveAddHistoryBtn.addEventListener('click', () => {
                if (!isAuthenticated) return;
                const player = addHistoryPlayerSelect.value;
                const dateStr = addHistoryDateInput.value;
                if(player && dateStr.match(/^\d{2}-\d{2}-\d{4}$/)) {
                    const [month, day, year] = dateStr.split('-');
                    selectionHistory.unshift({ player, date: new Date(year, month - 1, day).getTime(), id: Date.now() });
                    updateFirestore();
                    addHistoryModal.classList.add('hidden');
                } else {
                    console.log('Please select a player and enter a valid date in MM-DD-YYYY format.');
                }
            });
            cancelAddHistoryBtn.addEventListener('click', () => addHistoryModal.classList.add('hidden'));

            // Edit History Modal Listeners
            cancelEditHistoryBtn.addEventListener('click', () => {
                editHistoryModal.classList.add('hidden');
                historyToEditId = null;
            });
            saveEditHistoryBtn.addEventListener('click', () => {
                if (!isAuthenticated || historyToEditId === null) return;
                const dateStr = editHistoryDateInput.value;
                if (dateStr.match(/^\d{2}-\d{2}-\d{4}$/)) {
                    const historyIndex = selectionHistory.findIndex(item => item.id === historyToEditId);
                    if (historyIndex > -1) {
                        const [month, day, year] = dateStr.split('-');
                        selectionHistory[historyIndex].date = new Date(year, month - 1, day).getTime();
                        updateFirestore();
                        editHistoryModal.classList.add('hidden');
                        historyToEditId = null;
                    }
                } else {
                    console.error("Invalid date format. Please use MM-DD-YYYY.");
                }
            });

            memberSearchInput.addEventListener('input', renderManualPickList);
            historySearchInput.addEventListener('input', renderHistory);
            randomSelectButton.addEventListener('click', () => selectRandomly(allianceMembers, randomSelectButton));

            closePlayerInfoBtn.addEventListener('click', () => playerInfoModal.classList.add('hidden'));
            designateConductorBtn.addEventListener('click', () => {
                if (!isAuthenticated || infoModalMemberId === null) return;
                const member = allianceMembers.find(m => m.id === infoModalMemberId);
                if (!member) return;
                showConfirmationModal(`Designate ${member.name}?`, `Are you sure you want to make ${member.name} the conductor?`, () => {
                    currentConductor = member.name;
                    selectionHistory.unshift({ player: currentConductor, date: Date.now(), id: Date.now() });
                    if (member.subBoost) member.subBoost = false;
                    updateFirestore();
                    showRandomMode();
                    playerInfoModal.classList.add('hidden');
                    triggerConfetti();
                });
            });

            function validateMedalAward() {
                const memberId = parseFloat(awardMedalMemberSelect.value);
                const medalName = awardMedalTypeSelect.value;
                if (!memberId || !medalName) {
                    saveAwardMedalBtn.disabled = true;
                    awardMedalValidationMsg.textContent = '';
                    return;
                }

                // Special handling for Mega Express Medal
                if (medalName === 'Mega Express Medal') {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const startOfToday = today.getTime();

                    const awardsToday = allianceMembers
                        .flatMap(m => m.medals || [])
                        .filter(med => med.name === 'Mega Express Medal' && med.awardedDate >= startOfToday)
                        .length;

                    if (awardsToday >= 2) {
                        awardMedalValidationMsg.textContent = `Mega Express can only be awarded twice per day.`;
                        saveAwardMedalBtn.disabled = true;
                        return;
                    }
                } else {
                    // Existing logic for other medals
                    const sixDaysAgo = Date.now() - (6 * 24 * 60 * 60 * 1000);
                    if (allianceMembers.some(m => m.medals && m.medals.some(med => med.name === medalName && med.awardedDate > sixDaysAgo))) {
                        awardMedalValidationMsg.textContent = `This medal was already awarded this week.`;
                        saveAwardMedalBtn.disabled = true;
                        return;
                    }
                }

                // Check if the specific member already has this medal active, UNLESS it's a Mega Express Medal
                const member = allianceMembers.find(m => m.id === memberId);
                if (medalName !== 'Mega Express Medal' && member && member.medals && member.medals.some(m => m.name === medalName && m.expires > Date.now())) {
                    awardMedalValidationMsg.textContent = `${member.name} already has an active ${medalName}.`;
                    saveAwardMedalBtn.disabled = true;
                    return;
                }

                awardMedalValidationMsg.textContent = '';
                saveAwardMedalBtn.disabled = false;
            }
            openAwardMedalModalBtn.addEventListener('click', () => {
                if (!isAuthenticated) return;
                awardMedalMemberSelect.innerHTML = '<option value="">Select a member...</option>';
                [...allianceMembers].sort((a,b) => a.name.localeCompare(b.name)).forEach(member => {
                    const option = document.createElement('option'); option.value = member.id; option.textContent = member.name; awardMedalMemberSelect.appendChild(option);
                });
                populateMedalSelect(awardMedalTypeSelect);
                validateMedalAward();
                awardMedalModal.classList.remove('hidden');
            });
            cancelAwardMedalBtn.addEventListener('click', () => awardMedalModal.classList.add('hidden'));
            awardMedalMemberSelect.addEventListener('change', validateMedalAward);
            awardMedalTypeSelect.addEventListener('change', validateMedalAward);
            saveAwardMedalBtn.addEventListener('click', () => {
                if (!isAuthenticated) return;
                const memberId = parseFloat(awardMedalMemberSelect.value);
                const medalName = awardMedalTypeSelect.value;
                if (memberId && medalName && awardMedal(memberId, medalName)) {
                    renderAll();
                    awardMedalModal.classList.add('hidden');
                }
            });

            loginButtons.forEach(btn => btn.addEventListener('click', () => loginModal.classList.remove('hidden')));
            logoutButtons.forEach(btn => btn.addEventListener('click', () => setAuthState(false)));
            loginButton.addEventListener('click', () => {
                if (passwordInput.value === 'newspaper') setAuthState(true);
                else { loginErrorMsg.textContent = 'Invalid password.'; setTimeout(() => loginErrorMsg.textContent = '', 3000); }
            });
            cancelLoginBtn.addEventListener('click', () => loginModal.classList.add('hidden'));

            confirmActionBtn.addEventListener('click', () => { if (confirmCallback) confirmCallback(); confirmationModal.classList.add('hidden'); });
            confirmCancelBtn.addEventListener('click', () => confirmationModal.classList.add('hidden'));
            
            const openHowItWorks = () => {
                howItWorksModal.classList.remove('hidden');
                howItWorksTabsContainer.querySelector('[data-tab="overview"]').click();
            }
            howItWorksButtons.forEach(btn => btn.addEventListener('click', openHowItWorks));
            
            // Close modals when clicking outside
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                    }
                });
            });

            closeHowItWorksBtn.addEventListener('click', () => howItWorksModal.classList.add('hidden'));
            closeHowItWorksBtn2.addEventListener('click', () => howItWorksModal.classList.add('hidden'));
            howItWorksTabsContainer.addEventListener('click', (e) => {
                const tabButton = e.target.closest('.how-it-works-tab');
                if (!tabButton) return;
                howItWorksTabsContainer.querySelectorAll('.how-it-works-tab').forEach(tab => tab.classList.remove('active'));
                howItWorksContent.querySelectorAll('.how-it-works-tab-content').forEach(content => content.style.display = 'none');
                tabButton.classList.add('active');
                howItWorksContent.querySelector(`#tab-content-${tabButton.dataset.tab}`).style.display = 'block';
            });

            // --- INITIALIZATION ---
            setAuthState(false);
            // Set the initial active tab to History
            switchMainContentTab('history');
            // Make conductor panel visible by default
            toggleConductorPanel();
            populateHowItWorksContent();
            populateMedalSelect(awardMedalSelect);
            initializeFirebase();
        });
    </script>
</body>
</html>
