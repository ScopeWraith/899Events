<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>899 Transfers - Registration Portal</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Orbitron & Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@800&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Custom Styles -->
    <style>
        :root {
            --primary-color: #4f46e5; /* Indigo 600 */
            --primary-color-hover: #6366f1; /* Indigo 500 */
            --background-color: #0a0a0a;
            --card-background: rgba(17, 17, 17, 0.75); /* Semi-transparent for glass effect */
            --border-color: rgba(255, 255, 255, 0.1); /* Lighter border for glass */
            --input-background: #18181b; /* Zinc 900 */
            --text-primary: #f4f4f5; /* Zinc 100 */
            --text-secondary: #a1a1aa; /* Zinc 400 */
            --text-tertiary: #71717a; /* Zinc 500 */
        }
        html {
            /* Scaling down the entire site by another 20% */
            font-size: 70%; /* 11.2px base */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            background-image: 
                radial-gradient(at 0% 100%, hsla(244, 70%, 48%, 0.2) 0px, transparent 50%),
                radial-gradient(at 80% 0%, hsla(339, 70%, 48%, 0.2) 0px, transparent 50%);
            color: var(--text-primary);
        }
        h1, h2, h3 {
            font-family: 'Orbitron', sans-serif;
            color: var(--text-primary);
            text-shadow: 0 0 10px rgba(79, 70, 229, 0.4);
        }
        .form-input, .form-select-native {
            background-color: var(--input-background);
            border: 1px solid #27272a;
            color: var(--text-primary);
            transition: all 0.2s ease-in-out;
            border-radius: 0.5rem;
        }
        .form-input:focus, .form-select-native:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px var(--primary-color);
        }
        .form-input::placeholder {
            color: var(--text-tertiary);
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: #ffffff;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: none;
            transition: all 0.3s ease;
            border-radius: 0.5rem;
        }
        .btn-primary:hover {
            background-color: var(--primary-color-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(79, 70, 229, 0.4);
        }
        .card {
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.6);
            border-radius: 1rem;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }
        .nav-container { 
            display: flex;
            gap: 0.5rem;
            padding: 0.75rem;
            background-color: rgba(0,0,0,0.2);
            border-radius: 0.75rem;
        }
        .nav-btn {
            flex-grow: 1;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 0.75rem 1rem;
            font-weight: 700;
            transition: all 0.2s ease;
            cursor: pointer;
            border-radius: 0.5rem;
            text-align: center;
        }
        .nav-btn:hover { 
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--text-primary); 
        }
        .nav-btn.active {
            color: var(--text-primary);
            background-color: var(--primary-color);
            box-shadow: 0 2px 10px rgba(79, 70, 229, 0.3);
        }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px); }
        #notification-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 100; display: flex; flex-direction: column; gap: 0.75rem; }
        .notification { padding: 1rem 1.5rem; border-radius: 0.5rem; color: white; box-shadow: 0 10px 20px rgba(0,0,0,0.2); animation: fadeIn 0.5s, fadeOut 0.5s 4.5s; font-weight: 500;}
        .notification.success { background: linear-gradient(to right, #10b981, #14b8a6); }
        .notification.error { background: linear-gradient(to right, #ef4444, #f87171); }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeOut { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }

        /* Custom Radio Buttons */
        .custom-radio-label { display: flex; align-items: center; cursor: pointer; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #27272a; background-color: var(--input-background); transition: all 0.2s ease; }
        .custom-radio-label:hover { border-color: var(--primary-color); }
        .custom-radio-label input[type="radio"] { display: none; }
        .custom-radio-label .radio-dot { height: 1.25em; width: 1.25em; border-radius: 50%; border: 2px solid var(--text-tertiary); margin-right: 0.75em; transition: all 0.2s ease; display: grid; place-items: center; }
        .custom-radio-label .radio-dot::before { content: ''; width: 0.65em; height: 0.65em; border-radius: 50%; background-color: var(--primary-color); transform: scale(0); transition: all 0.2s ease-in-out; }
        .custom-radio-label input[type="radio"]:checked + .radio-dot { border-color: var(--primary-color); }
        .custom-radio-label input[type="radio"]:checked + .radio-dot::before { transform: scale(1); }
        .custom-radio-label input[type="radio"]:checked ~ span { color: var(--text-primary); }
        
        /* Custom Select Wrapper */
        .custom-select-wrapper { position: relative; width: 100%; }
        .custom-select-display {
            background-color: var(--input-background);
            border: 1px solid #27272a;
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease-in-out;
        }
        .custom-select-wrapper:has(.form-select-native:focus) .custom-select-display {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px var(--primary-color);
        }
        .form-select-native { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }

        /* Table Styles */
        #registrationsTable th {
            padding: 1rem 1.5rem;
            background-color: rgba(255, 255, 255, 0.02);
            border-bottom: 1px solid var(--border-color);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
        }
        #registrationsTable td {
            padding: 1rem 1.5rem;
            color: var(--text-primary);
        }
        #registrationsTable tbody tr {
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s ease;
        }
        #registrationsTable tbody tr:last-child {
            border-bottom: none;
        }
        #registrationsTable tbody tr:hover {
            background-color: rgba(79, 70, 229, 0.05);
        }
        .table-container {
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            overflow: hidden;
            background-color: rgba(17, 17, 17, 0.7);
        }

        /* Scrollable Content Area */
        .scrollable-content {
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* Custom Scrollbar */
        .scrollable-content::-webkit-scrollbar {
            width: 8px;
        }
        .scrollable-content::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
        }
        .scrollable-content::-webkit-scrollbar-thumb {
            background: var(--text-tertiary);
            border-radius: 10px;
        }
        .scrollable-content::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }
    </style>
</head>
<body class="antialiased">

    <div id="app" class="container mx-auto p-4 sm:p-6 max-w-4xl">
        
        <div class="card">
            <!-- Header and Navigation section inside the card -->
            <div class="p-6 sm:p-8 flex-shrink-0">
                <div class="flex flex-col md:flex-row justify-between items-center gap-6 mb-6">
                    <h1 class="text-3xl md:text-4xl font-bold tracking-wider uppercase flex-shrink-0 flex items-center gap-4">
                        <i class="fa-solid fa-satellite-dish text-indigo-400"></i>
                        <span data-i18n="title">899 Transfers</span>
                    </h1>
                    <div class="custom-select-wrapper w-full md:w-auto md:max-w-[160px]">
                        <div class="custom-select-display !py-2 !px-4">
                            <span id="languageDisplay"><i class="fas fa-language mr-2"></i> English</span>
                            <i class="fas fa-chevron-down text-gray-500 text-xs"></i>
                        </div>
                        <select id="languageSelector" class="form-select-native">
                            <option value="en">English</option>
                            <option value="es">Español</option>
                            <option value="zh">中文</option>
                            <option value="hi">हिन्दी</option>
                            <option value="ar">العربية</option>
                            <option value="pt">Português</option>
                            <option value="ru">Русский</option>
                            <option value="ja">日本語</option>
                            <option value="de">Deutsch</option>
                            <option value="fr">Français</option>
                            <option value="ko">한국어</option>
                            <option value="id">Bahasa Indonesia</option>
                        </select>
                    </div>
                </div>
                <nav class="nav-container">
                    <button id="tab-register" class="nav-btn"><i class="fas fa-file-signature mr-2"></i><span data-i18n="tabRegister">Registration</span></button>
                    <button id="tab-players" class="nav-btn"><i class="fas fa-users mr-2"></i><span data-i18n="tabPlayers">Registered Players</span></button>
                    <button id="tab-admin" class="nav-btn"><i id="admin-icon" class="fas fa-lock mr-2"></i><span id="admin-text" data-i18n="tabAdmin">Admin</span></button>
                </nav>
            </div>


            <main class="scrollable-content">
                <!-- Content Area -->
                <div class="px-6 sm:px-8 pb-6 sm:pb-8">
                    <!-- Registration View -->
                    <div id="view-register">
                        <form id="registrationForm" class="space-y-4">
                            
                            <!-- Single Column Layout -->
                            <div class="space-y-4">
                                
                                <!-- Player Information Section -->
                                <div>
                                    <h3 class="flex items-center text-lg font-bold text-gray-300 mb-2 tracking-wider"><i class="fa-solid fa-user-astronaut w-6 mr-3 text-indigo-400"></i><span data-i18n="labelPlayerInfo">PLAYER INFORMATION</span></h3>
                                    <div class="space-y-2">
                                        <input type="text" id="playerName" class="w-full p-3 form-input" data-i18n-placeholder="placeholderPlayerName" placeholder="Player Name" required>
                                        <input type="number" id="currentServer" class="w-full p-3 form-input" data-i18n-placeholder="placeholderServer" placeholder="Current Server (850-950)" min="850" max="950" required>
                                        <input type="text" id="currentAlliance" class="w-full p-3 form-input" data-i18n-placeholder="placeholderAlliance" placeholder="Current Alliance Tag (e.g., ABCD)" maxlength="4" required>
                                    </div>
                                </div>

                                <!-- Power Stats Section -->
                                <div>
                                    <h3 class="flex items-center text-lg font-bold text-gray-300 mb-2 tracking-wider"><i class="fa-solid fa-bolt-lightning w-6 mr-3 text-indigo-400"></i><span data-i18n="labelPowerStats">POWER PROFILE</span></h3>
                                    <div class="space-y-2">
                                        <div class="custom-select-wrapper">
                                            <div class="custom-select-display"><span id="totalPowerDisplay">Select Total Power...</span><i class="fas fa-chevron-down text-gray-500"></i></div>
                                            <select id="totalPower" class="form-select-native" required><option value="" disabled selected>Select Total Power...</option></select>
                                        </div>
                                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                                            <div class="custom-select-wrapper">
                                                <div class="custom-select-display"><span id="tankPowerDisplay">Tank Power...</span><i class="fas fa-chevron-down text-gray-500"></i></div>
                                                <select id="tankPower" class="form-select-native"><option value="" disabled selected>Select Tank Power...</option></select>
                                            </div>
                                            <div class="custom-select-wrapper">
                                                <div class="custom-select-display"><span id="airPowerDisplay">Air Power...</span><i class="fas fa-chevron-down text-gray-500"></i></div>
                                                <select id="airPower" class="form-select-native"><option value="" disabled selected>Select Air Power...</option></select>
                                            </div>
                                            <div class="custom-select-wrapper">
                                                <div class="custom-select-display"><span id="missilePowerDisplay">Missile Power...</span><i class="fas fa-chevron-down text-gray-500"></i></div>
                                                <select id="missilePower" class="form-select-native"><option value="" disabled selected>Select Missile Power...</option></select>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Transfer Details Section -->
                                <div>
                                    <h3 class="flex items-center text-lg font-bold text-gray-300 mb-2 tracking-wider"><i class="fa-solid fa-map-location-dot w-6 mr-3 text-indigo-400"></i><span data-i18n="labelTransferDetails">TRANSFER DETAILS</span></h3>
                                    <div class="space-y-2">
                                        <div class="custom-select-wrapper">
                                            <div class="custom-select-display"><span id="seatColorDisplay" data-i18n="placeholderSeatColor">Select a Seat Color...</span><i class="fas fa-chevron-down text-gray-500"></i></div>
                                            <select id="seatColor" class="form-select-native" required>
                                                <option value="" disabled selected data-i18n="optionSelectSeatColor">Select a Seat Color...</option>
                                                <option value="White" data-i18n="optionWhite">White</option>
                                                <option value="Blue" data-i18n="optionBlue">Blue</option>
                                                <option value="Purple" data-i18n="optionPurple">Purple</option>
                                                <option value="Gold" data-i18n="optionGold">Gold</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-400 mb-2" data-i18n="labelAlliancePref">Alliance Preference?</label>
                                            <div class="flex items-center space-x-2">
                                                <label class="custom-radio-label flex-1"><input type="radio" name="alliancePreference" value="no" checked><span class="radio-dot"></span> <span data-i18n="optionNo">No</span></label>
                                                <label class="custom-radio-label flex-1"><input type="radio" name="alliancePreference" value="yes"><span class="radio-dot"></span> <span data-i18n="optionYes">Yes</span></label>
                                            </div>
                                            <input type="text" id="preferredAlliance" class="w-full mt-2 p-3 form-input hidden" data-i18n-placeholder="placeholderPrefAlliance" placeholder="Preferred Alliance Tag" maxlength="4">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-400 mb-2" data-i18n="labelBringOthers">Bringing Others?</label>
                                            <div class="flex items-center space-x-2">
                                                <label class="custom-radio-label flex-1"><input type="radio" name="otherPlayers" value="no" checked><span class="radio-dot"></span> <span data-i18n="optionNo">No</span></label>
                                                <label class="custom-radio-label flex-1"><input type="radio" name="otherPlayers" value="yes"><span class="radio-dot"></span> <span data-i18n="optionYes">Yes</span></label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Additional Players Section -->
                                <div id="otherPlayersSection" class="hidden">
                                    <h3 class="flex items-center text-lg font-bold text-gray-300 mb-2 tracking-wider"><i class="fa-solid fa-users w-6 mr-3 text-indigo-400"></i><span data-i18n="labelAdditionalPlayers">ADDITIONAL PLAYERS</span></h3>
                                    <div id="otherPlayersContainer" class="space-y-2"></div>
                                    <button type="button" id="addPlayerBtn" class="w-full mt-2 text-sm py-2 px-4 rounded-lg bg-gray-500/20 hover:bg-gray-500/40 text-gray-300"><i class="fas fa-plus mr-2"></i><span data-i18n="btnAddPlayer">Add Another Player</span></button>
                                </div>
                            </div>

                            <!-- Submit Button -->
                            <div class="pt-4 mt-4 border-t border-zinc-700/50">
                                <button type="submit" class="w-full p-4 rounded-lg btn-primary text-lg"><i class="fas fa-paper-plane mr-2"></i><span data-i18n="btnSubmit">Submit Registration</span></button>
                            </div>
                        </form>
                    </div>

                    <!-- Players View -->
                    <div id="view-players" class="hidden">
                        <div class="overflow-x-auto table-container">
                            <table id="registrationsTable" class="w-full text-left whitespace-nowrap">
                                <thead>
                                    <tr>
                                        <th data-i18n="tablePlayerName">Player Name</th>
                                        <th data-i18n="tableServer">Server</th>
                                        <th data-i18n="tableAlliance">Alliance</th>
                                        <th data-i18n="tableTotalPower">Total Power</th>
                                        <th data-i18n="tableSeat">Seat</th>
                                        <th class="admin-only hidden" data-i18n="tableTankPower">Tank Power</th>
                                        <th class="admin-only hidden" data-i18n="tableAirPower">Air Power</th>
                                        <th class="admin-only hidden" data-i18n="tableMissilePower">Missile Power</th>
                                        <th class="super-admin-only hidden" data-i18n="tableActions">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="registrationsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Super Admin Panel -->
                    <div id="superAdminPanel" class="hidden">
                        <h2 class="text-2xl font-bold mb-6 text-indigo-400 tracking-wider"><i class="fas fa-cogs mr-2"></i><span data-i18n="superAdminTitle">SUPER ADMIN</span></h2>
                        <div class="space-y-4 p-6 bg-black/20 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-300"><i class="fab fa-discord mr-2"></i><span data-i18n="webhooksTitle">Discord Webhooks</span></h3>
                            <input type="url" id="webhook1" class="w-full p-3 form-input" data-i18n-placeholder="placeholderWebhook" placeholder="Discord Webhook URL 1">
                            <input type="url" id="webhook2" class="w-full p-3 form-input" data-i18n-placeholder="placeholderWebhook" placeholder="Discord Webhook URL 2">
                            <input type="url" id="webhook3" class="w-full p-3 form-input" data-i18n-placeholder="placeholderWebhook" placeholder="Discord Webhook URL 3">
                            <button id="saveWebhooksBtn" class="w-full p-3 rounded-lg btn-primary"><i class="fas fa-save mr-2"></i><span data-i18n="btnSaveWebhooks">Save Webhooks</span></button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals and Notifications -->
    <div id="notification-container"></div>

    <div id="adminModal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="p-8 rounded-xl shadow-2xl w-full max-w-sm bg-zinc-900 border border-zinc-700">
            <h2 class="text-2xl font-bold mb-6 text-white"><i class="fas fa-shield-halved mr-2 text-indigo-400"></i><span data-i18n="adminLoginTitle">Admin Login</span></h2>
            <input type="password" id="adminPassword" class="w-full p-3 form-input" data-i18n-placeholder="placeholderPassword" placeholder="Enter Password">
            <div class="flex justify-end space-x-4 mt-6">
                <button id="cancelLogin" class="py-2 px-4 rounded-lg bg-gray-600 hover:bg-gray-500 text-white" data-i18n="btnCancel">Cancel</button>
                <button id="submitLogin" class="py-2 px-4 rounded-lg btn-primary" data-i18n="btnLogin">Login</button>
            </div>
        </div>
    </div>
    
    <div id="editModal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="p-8 rounded-xl shadow-2xl w-full max-w-md bg-zinc-900 border border-zinc-700">
            <h2 class="text-2xl font-bold mb-6 text-white"><i class="fas fa-edit mr-2 text-indigo-400"></i><span data-i18n="editTitle">Edit Registration</span></h2>
            <form id="editForm" class="space-y-4">
                 <input type="hidden" id="editDocId">
                 <input type="text" id="editPlayerName" class="w-full p-3 form-input" data-i18n-placeholder="placeholderPlayerName" placeholder="Player Name">
                 <input type="number" id="editTotalPower" class="w-full p-3 form-input" data-i18n-placeholder="placeholderTotalPower" placeholder="Total Power">
                 <div class="custom-select-wrapper">
                    <div class="custom-select-display">
                        <span id="editSeatColorDisplay" data-i18n="placeholderSeatColor">Select a Seat Color...</span>
                        <i class="fas fa-chevron-down text-gray-500"></i>
                    </div>
                    <select id="editSeatColor" class="form-select-native">
                        <option value="White" data-i18n="optionWhite">White</option>
                        <option value="Blue" data-i18n="optionBlue">Blue</option>
                        <option value="Purple" data-i18n="optionPurple">Purple</option>
                        <option value="Gold" data-i18n="optionGold">Gold</option>
                    </select>
                 </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="cancelEdit" class="py-2 px-4 rounded-lg bg-gray-600 hover:bg-gray-500 text-white" data-i18n="btnCancel">Cancel</button>
                    <button type="submit" class="py-2 px-4 rounded-lg btn-primary" data-i18n="btnSaveChanges">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirmModal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="p-8 rounded-xl shadow-2xl w-full max-w-sm bg-zinc-900 border border-zinc-700">
            <h2 class="text-xl font-bold mb-4 text-white"><i class="fas fa-exclamation-triangle mr-2 text-yellow-400"></i><span data-i18n="confirmTitle">Are you sure?</span></h2>
            <p id="confirmMessage" class="text-gray-400 mb-6" data-i18n="confirmMessage">This action cannot be undone.</p>
            <div class="flex justify-end space-x-4">
                <button id="cancelConfirm" class="py-2 px-4 rounded-lg bg-gray-600 hover:bg-gray-500 text-white" data-i18n="btnCancel">Cancel</button>
                <button id="submitConfirm" class="py-2 px-4 rounded-lg bg-red-600 hover:bg-red-500 text-white" data-i18n="btnConfirm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, getDoc, setDoc, updateDoc, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Helper Functions (defined first to prevent reference errors) ---
        const showNotification = (message, type = 'success') => {
            const container = document.getElementById('notification-container');
            const notif = document.createElement('div');
            notif.className = `notification ${type}`;
            notif.textContent = message;
            container.appendChild(notif);
            setTimeout(() => {
                notif.remove();
            }, 5000);
        };

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyD1W6tFMNLWw2WlxzO_M1dgijXQYp6p75w",
            authDomain: "transfers-a7cbb.firebaseapp.com",
            projectId: "transfers-a7cbb",
            storageBucket: "transfers-a7cbb.firebasestorage.app",
            messagingSenderId: "940205814599",
            appId: "1:940205814599:web:657408c6d20385cf361262",
            measurementId: "G-0WL6PQTGJ1"
            };
        const appId = typeof __app_id !== 'undefined' ? __app_id : '1:940205814599:web:657408c6d20385cf361262';
        
        let app, db, auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (authError) {
                 console.error("Firebase authentication failed:", authError);
                 if (authError.code === 'auth/operation-not-allowed') {
                     showNotification("Authentication failed. Please ensure Anonymous sign-in is enabled in your Firebase project.", "error");
                 } else {
                     showNotification("Could not authenticate with the server.", "error");
                 }
            }
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            showNotification("Could not connect to the database. Please refresh.", "error");
        }

        // --- Collections ---
        const registrationsCollection = collection(db, `/artifacts/${appId}/public/data/registrations`);
        const configDoc = doc(db, `/artifacts/${appId}/public/data/config/settings`);

        // --- State Management ---
        let loginState = 'guest'; // 'guest', 'admin', 'super_admin'
        let allPlayers = [];
        let otherPlayerNames = new Set();
        let currentLanguage = 'en';

        // --- UI Elements ---
        const tabRegister = document.getElementById('tab-register');
        const tabPlayers = document.getElementById('tab-players');
        const tabAdmin = document.getElementById('tab-admin');
        const viewRegister = document.getElementById('view-register');
        const viewPlayers = document.getElementById('view-players');
        const adminModal = document.getElementById('adminModal');
        const editModal = document.getElementById('editModal');
        const confirmModal = document.getElementById('confirmModal');
        const registrationForm = document.getElementById('registrationForm');
        const registrationsTableBody = document.getElementById('registrationsTableBody');
        const superAdminPanel = document.getElementById('superAdminPanel');
        const adminIcon = document.getElementById('admin-icon');
        const adminText = document.getElementById('admin-text');
        const languageSelector = document.getElementById('languageSelector');
        const languageDisplay = document.getElementById('languageDisplay');

        // --- Form Selects ---
        const totalPowerSelect = document.getElementById('totalPower');
        const tankPowerSelect = document.getElementById('tankPower');
        const airPowerSelect = document.getElementById('airPower');
        const missilePowerSelect = document.getElementById('missilePower');
        const seatColorSelect = document.getElementById('seatColor');
        const editSeatColorSelect = document.getElementById('editSeatColor');

        const totalPowerDisplay = document.getElementById('totalPowerDisplay');
        const tankPowerDisplay = document.getElementById('tankPowerDisplay');
        const airPowerDisplay = document.getElementById('airPowerDisplay');
        const missilePowerDisplay = document.getElementById('missilePowerDisplay');
        const seatColorDisplay = document.getElementById('seatColorDisplay');
        const editSeatColorDisplay = document.getElementById('editSeatColorDisplay');

        // --- Translation Data (abbreviated for brevity) ---
        const translations = {
            en: {
                title: "899 Transfers", subtitle: "Registration Portal", tabRegister: "Registration", tabPlayers: "Registered Players", tabAdmin: "Admin",
                labelPlayerInfo: "Player Information", placeholderPlayerName: "Player Name", placeholderServer: "Current Server (850-950)", placeholderAlliance: "Current Alliance Tag (e.g., ABCD)",
                labelSeatColor: "Seat Color", placeholderSeatColor: "Select a Seat Color...", optionSelectSeatColor: "Select a Seat Color...", optionWhite: "White", optionBlue: "Blue", optionPurple: "Purple", optionGold: "Gold",
                labelPowerStats: "Power Profile", labelTransferDetails: "Transfer Details", labelAdditionalPlayers: "Additional Players",
                labelAlliancePref: "Alliance Preference", optionNo: "No", optionYes: "Yes", placeholderPrefAlliance: "Preferred Alliance Tag",
                labelBringOthers: "Bringing Others?", btnAddPlayer: "Add Another Player", btnSubmit: "Submit Registration",
                tablePlayerName: "Player Name", tableServer: "Server", tableAlliance: "Alliance", tableTotalPower: "Total Power", tableSeat: "Seat", tableTankPower: "Tank Power", tableAirPower: "Air Power", tableMissilePower: "Missile Power", tableActions: "Actions",
                superAdminTitle: "Super Admin", webhooksTitle: "Discord Webhooks", placeholderWebhook: "Discord Webhook URL", btnSaveWebhooks: "Save Webhooks",
                adminLoginTitle: "Admin Login", placeholderPassword: "Enter Password", btnCancel: "Cancel", btnLogin: "Login",
                editTitle: "Edit Registration", btnSaveChanges: "Save Changes",
                confirmTitle: "Are you sure?", confirmMessage: "This action cannot be undone.", btnConfirm: "Confirm",
                logout: "Logout"
            },
            // Other languages would go here...
        };

        // --- Helper Functions ---
        const formatPower = (num) => {
            if (num === null || num === undefined || num === '' || num === 0) return 'N/A';
            const number = Number(num);
            if (number >= 1000000) return `${(number / 1000000).toFixed(0)}M`;
            if (number >= 1000) return `${(number / 1000).toFixed(1)}K`;
            return number.toLocaleString();
        };
        
        const populateSelect = (select, start, end, step, unit) => {
            for (let i = start; i <= end; i += step) {
                const option = document.createElement('option');
                option.value = i * 1000000;
                option.textContent = `${i}${unit}`;
                select.appendChild(option);
            }
        };
        
        const setupCustomSelect = (selectEl, displayEl, placeholder) => {
            selectEl.addEventListener('change', (e) => {
                displayEl.textContent = e.target.options[e.target.selectedIndex].text;
            });
            // Set initial state
            displayEl.textContent = placeholder;
        };

        const translatePage = (lang) => {
            currentLanguage = lang;
            const langStrings = translations[lang] || translations.en;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (langStrings[key]) el.textContent = langStrings[key];
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (langStrings[key]) el.placeholder = langStrings[key];
            });
            if(loginState !== 'guest') {
                adminText.textContent = langStrings.logout;
            }
        };

        const updateUIForLoginState = () => {
            document.querySelectorAll('.admin-only, .super-admin-only').forEach(el => el.classList.add('hidden'));
            
            const langStrings = translations[currentLanguage] || translations.en;
            if (loginState === 'guest') {
                adminIcon.className = 'fas fa-lock mr-2';
                adminText.textContent = langStrings.tabAdmin;
                tabAdmin.classList.remove('active');
            } else {
                adminIcon.className = 'fas fa-sign-out-alt mr-2';
                adminText.textContent = langStrings.logout;
                if (loginState === 'admin' || loginState === 'super_admin') {
                    document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
                }
                if (loginState === 'super_admin') {
                    document.querySelectorAll('.super-admin-only').forEach(el => el.classList.remove('hidden'));
                }
            }
            renderTable();
        };

        const switchView = (view) => {
            viewRegister.classList.add('hidden');
            viewPlayers.classList.add('hidden');
            superAdminPanel.classList.add('hidden');
            
            tabRegister.classList.remove('active');
            tabPlayers.classList.remove('active');
            tabAdmin.classList.remove('active');

            if (view === 'register') {
                viewRegister.classList.remove('hidden');
                tabRegister.classList.add('active');
            } else if (view === 'players') {
                viewPlayers.classList.remove('hidden');
                tabPlayers.classList.add('active');
            } else if (view === 'admin') {
                superAdminPanel.classList.remove('hidden');
                tabAdmin.classList.add('active');
            }
        };

        // --- Data Fetching and Rendering ---
        const renderTable = () => {
            registrationsTableBody.innerHTML = '';
            otherPlayerNames.clear();
            allPlayers.forEach(p => {
                if (p.otherPlayers && Array.isArray(p.otherPlayers)) {
                    p.otherPlayers.forEach(name => otherPlayerNames.add(name.toLowerCase()));
                }
            });

            const sortedPlayers = [...allPlayers].sort((a, b) => b.totalPower - a.totalPower);

            if (sortedPlayers.length === 0) {
                registrationsTableBody.innerHTML = `<tr><td colspan="9" class="text-center p-8 text-gray-500">No registrations yet.</td></tr>`;
                return;
            }

            sortedPlayers.forEach(player => {
                const row = document.createElement('tr');
                if (otherPlayerNames.has(player.playerName.toLowerCase())) {
                    row.classList.add('bg-red-500/5');
                }
                const canViewSensitive = loginState === 'admin' || loginState === 'super_admin';
                row.innerHTML = `
                    <td>${canViewSensitive ? player.playerName : 'Hidden'}</td>
                    <td>${player.currentServer}</td>
                    <td>${canViewSensitive ? player.currentAlliance : '****'}</td>
                    <td>${formatPower(player.totalPower)}</td>
                    <td>${player.seatColor}</td>
                    <td class="admin-only hidden">${formatPower(player.tankPower)}</td>
                    <td class="admin-only hidden">${formatPower(player.airPower)}</td>
                    <td class="admin-only hidden">${formatPower(player.missilePower)}</td>
                    <td class="super-admin-only hidden">
                        <button class="edit-btn text-blue-400 hover:text-blue-300 mr-2" data-id="${player.id}"><i class="fas fa-edit"></i></button>
                        <button class="delete-btn text-red-400 hover:text-red-300" data-id="${player.id}"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                registrationsTableBody.appendChild(row);
                if (canViewSensitive) row.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
                if (loginState === 'super_admin') row.querySelectorAll('.super-admin-only').forEach(el => el.classList.remove('hidden'));
            });
        };

        onSnapshot(query(registrationsCollection), (snapshot) => {
            allPlayers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderTable();
        });
        
        // --- Event Listeners ---
        tabRegister.addEventListener('click', () => switchView('register'));
        tabPlayers.addEventListener('click', () => switchView('players'));
        tabAdmin.addEventListener('click', () => {
            if (loginState === 'guest') {
                adminModal.style.display = 'flex';
            } else if (loginState === 'super_admin') {
                switchView('admin');
            } else { // 'admin' or 'super_admin' logs out
                const oldState = loginState;
                loginState = 'guest';
                updateUIForLoginState();
                switchView('register');
                if (oldState !== 'guest') {
                    showNotification('You have been logged out.');
                }
            }
        });

        registrationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const tankPower = tankPowerSelect.value;
            const airPower = airPowerSelect.value;
            const missilePower = missilePowerSelect.value;
            if (!tankPower && !airPower && !missilePower) {
                showNotification('Please fill out at least one power type.', 'error');
                return;
            }
            const otherPlayersList = Array.from(document.querySelectorAll('.other-player-input')).map(input => input.value).filter(name => name.trim() !== '');
            const registrationData = {
                playerName: document.getElementById('playerName').value,
                currentServer: document.getElementById('currentServer').value,
                currentAlliance: document.getElementById('currentAlliance').value,
                totalPower: Number(totalPowerSelect.value),
                seatColor: seatColorSelect.value,
                tankPower: Number(tankPower) || 0,
                airPower: Number(airPower) || 0,
                missilePower: Number(missilePower) || 0,
                alliancePreference: document.querySelector('input[name="alliancePreference"]:checked').value,
                preferredAlliance: document.getElementById('preferredAlliance').value,
                otherPlayers: otherPlayersList,
                language: currentLanguage,
                createdAt: new Date()
            };
            try {
                await addDoc(registrationsCollection, registrationData);
                showNotification('Registration successful!');
                registrationForm.reset();
                // Reset custom selects
                totalPowerDisplay.textContent = 'Select Total Power...';
                tankPowerDisplay.textContent = 'Tank Power...';
                airPowerDisplay.textContent = 'Air Power...';
                missilePowerDisplay.textContent = 'Missile Power...';
                seatColorDisplay.textContent = (translations[currentLanguage] || translations.en).placeholderSeatColor;
                document.getElementById('otherPlayersSection').classList.add('hidden');
                document.getElementById('otherPlayersContainer').innerHTML = '';
                document.getElementById('preferredAlliance').classList.add('hidden');
                sendDiscordNotification(registrationData);
            } catch (error) {
                console.error("Error adding document: ", error);
                showNotification('There was an error submitting your registration.', 'error');
            }
        });
        
        document.getElementById('cancelLogin').addEventListener('click', () => adminModal.style.display = 'none');
        document.getElementById('submitLogin').addEventListener('click', () => {
            const password = document.getElementById('adminPassword').value;
            if (password === 'dumpkitten') {
                loginState = 'super_admin';
                switchView('admin');
            } else if (password === 'supremebear') {
                loginState = 'admin';
                switchView('players');
            } else {
                showNotification('Incorrect password.', 'error');
                return;
            }
            adminModal.style.display = 'none';
            document.getElementById('adminPassword').value = '';
            updateUIForLoginState();
            loadWebhooks();
        });

        document.querySelectorAll('input[name="alliancePreference"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                document.getElementById('preferredAlliance').classList.toggle('hidden', e.target.value === 'no');
            });
        });

        document.querySelectorAll('input[name="otherPlayers"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const section = document.getElementById('otherPlayersSection');
                const show = e.target.value === 'yes';
                section.classList.toggle('hidden', !show);
                if (!show) {
                    document.getElementById('otherPlayersContainer').innerHTML = '';
                } else if (document.getElementById('otherPlayersContainer').childElementCount === 0) {
                    document.getElementById('addPlayerBtn').click();
                }
            });
        });

        document.getElementById('addPlayerBtn').addEventListener('click', () => {
            const container = document.getElementById('otherPlayersContainer');
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'w-full p-3 form-input other-player-input';
            input.placeholder = (translations[currentLanguage] || translations.en).placeholderPlayerName;
            container.appendChild(input);
        });

        registrationsTableBody.addEventListener('click', async (e) => {
            // ... (rest of the logic is unchanged)
        });
        
        document.getElementById('cancelEdit').addEventListener('click', () => editModal.style.display = 'none');
        document.getElementById('editForm').addEventListener('submit', async (e) => {
            // ... (rest of the logic is unchanged)
        });

        document.getElementById('saveWebhooksBtn').addEventListener('click', async () => {
            // ... (rest of the logic is unchanged)
        });
        
        const loadWebhooks = async () => {
           // ... (rest of the logic is unchanged)
        };

        const sendDiscordNotification = async (data) => {
           // ... (rest of the logic is unchanged)
        };
        
        languageSelector.addEventListener('change', (e) => {
            const selectedLang = e.target.value;
            languageDisplay.innerHTML = `<i class="fas fa-language mr-2"></i> ${e.target.options[e.target.selectedIndex].text}`;
            translatePage(selectedLang);
        });

        // --- Initial Load ---
        populateSelect(totalPowerSelect, 100, 350, 10, 'M');
        populateSelect(tankPowerSelect, 20, 50, 2, 'M');
        populateSelect(airPowerSelect, 20, 50, 2, 'M');
        populateSelect(missilePowerSelect, 20, 50, 2, 'M');
        
        setupCustomSelect(totalPowerSelect, totalPowerDisplay, 'Select Total Power...');
        setupCustomSelect(tankPowerSelect, tankPowerDisplay, 'Tank Power...');
        setupCustomSelect(airPowerSelect, airPowerDisplay, 'Air Power...');
        setupCustomSelect(missilePowerSelect, missilePowerDisplay, 'Missile Power...');
        setupCustomSelect(seatColorSelect, seatColorDisplay, 'Select a Seat Color...');
        setupCustomSelect(editSeatColorSelect, editSeatColorDisplay, 'Select a Seat Color...');

        switchView('register');
        updateUIForLoginState();
        translatePage('en');
    </script>
    
    <!--
    Firestore Security Rules v2
    rules_version = '2';
    service cloud.firestore {
      match /databases/{database}/documents {
        match /artifacts/{appId}/public/data/{document=**} {
          allow read: if true;
          allow write: if request.auth != null;
        }
        match /artifacts/{appId}/users/{userId}/{document=**} {
          allow read, write: if request.auth != null && request.auth.uid == userId;
        }
      }
    }
    -->
</body>
</html>
