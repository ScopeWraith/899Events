<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>899 Transfers - Registration Portal</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Orbitron & Lato -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@800&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Lato', sans-serif;
            background-color: #111111;
            background-image: 
                radial-gradient(at 0% 0%, hsla(0,0%,100%,.03) 0, transparent 50%),
                radial-gradient(at 100% 0%, hsla(0,0%,100%,.03) 0, transparent 50%),
                radial-gradient(at 100% 100%, hsla(0,0%,100%,.02) 0, transparent 50%),
                radial-gradient(at 0% 100%, hsla(0,0%,100%,.02) 0, transparent 50%);
            color: #d1d5db; /* gray-300 */
        }
        h1 {
            font-family: 'Orbitron', sans-serif;
            color: #f9fafb; /* gray-50 */
            text-shadow: 0 0 8px rgba(220, 38, 38, 0.4);
        }
        .form-input, .form-select-native {
            background-color: #1f2937; /* gray-800 */
            border: 1px solid #4b5563; /* gray-600 */
            color: #f3f4f6;
            transition: all 0.2s ease-in-out;
        }
        .form-input:focus, .form-select-native:focus {
            outline: none;
            border-color: #dc2626; /* red-600 */
            box-shadow: 0 0 0 1px #dc2626;
        }
        .form-input::placeholder {
            color: #9ca3af;
        }
        .btn-primary {
            background-color: #dc2626; /* red-600 */
            color: #ffffff;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: none;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #ef4444; /* red-500 */
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
        }
        .card {
            background-color: #18181b; /* zinc-900 */
            border: 1px solid #27272a; /* zinc-800 */
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.5);
            border-radius: 0.75rem;
        }
        .tab-nav { 
            display: flex; 
            border-bottom: 1px solid #374151; /* gray-700 */
        }
        .tab-btn {
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: #9ca3af; /* gray-400 */
            padding: 0.75rem 1.5rem;
            font-weight: 700;
            transition: all 0.2s ease;
            cursor: pointer;
            margin-bottom: -1px; /* Overlap the container border */
        }
        .tab-btn:hover { color: #f9fafb; }
        .tab-btn.active {
            color: #dc2626; /* red-600 */
            border-bottom-color: #dc2626;
        }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); }
        #notification-container { position: fixed; bottom: 1rem; right: 1rem; z-index: 100; display: flex; flex-direction: column; gap: 0.5rem; }
        .notification { padding: 1rem; border-radius: 0.5rem; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); animation: fadeIn 0.5s, fadeOut 0.5s 4.5s; }
        .notification.success { background-color: #16a34a; }
        .notification.error { background-color: #dc2626; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(20px); } }

        /* Custom Radio Buttons */
        .custom-radio-label { display: flex; align-items: center; cursor: pointer; }
        .custom-radio-label input[type="radio"] { display: none; }
        .custom-radio-label .radio-dot { height: 1.5em; width: 1.5em; border-radius: 50%; border: 2px solid #4b5563; margin-right: 0.75em; transition: all 0.2s ease; display: grid; place-items: center; }
        .custom-radio-label .radio-dot::before { content: ''; width: 0.75em; height: 0.75em; border-radius: 50%; background-color: #dc2626; transform: scale(0); transition: all 0.2s ease-in-out; }
        .custom-radio-label input[type="radio"]:checked + .radio-dot { border-color: #dc2626; }
        .custom-radio-label input[type="radio"]:checked + .radio-dot::before { transform: scale(1); }
        
        /* Custom Select Wrapper */
        .custom-select-wrapper { position: relative; width: 100%; }
        .custom-select-display {
            background-color: #1f2937;
            border: 1px solid #4b5563;
            color: #f3f4f6;
            padding: 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease-in-out;
        }
        .custom-select-wrapper:has(.form-select-native:focus) .custom-select-display {
            border-color: #dc2626;
            box-shadow: 0 0 0 1px #dc2626;
        }
        .form-select-native { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
    </style>
</head>
<body class="antialiased">

    <div id="app" class="container mx-auto p-4 sm:p-6 max-w-4xl">
        
        <header class="text-center mb-4 relative">
            <h1 class="text-4xl md:text-5xl font-bold tracking-wider uppercase" data-i18n="title">899 Transfers</h1>
            <p class="text-lg text-gray-400" data-i18n="subtitle">Registration Portal</p>
            <div class="absolute top-0 right-0">
                <div class="custom-select-wrapper" style="width: 150px;">
                    <div class="custom-select-display !py-2 !px-3">
                        <span id="languageDisplay"><i class="fas fa-language mr-2"></i> English</span>
                        <i class="fas fa-chevron-down text-gray-500 text-xs"></i>
                    </div>
                    <select id="languageSelector" class="form-select-native">
                        <option value="en">English</option>
                        <option value="es">Español</option>
                        <option value="zh">中文</option>
                        <option value="hi">हिन्दी</option>
                        <option value="ar">العربية</option>
                        <option value="pt">Português</option>
                        <option value="ru">Русский</option>
                        <option value="ja">日本語</option>
                        <option value="de">Deutsch</option>
                        <option value="fr">Français</option>
                        <option value="ko">한국어</option>
                        <option value="id">Bahasa Indonesia</option>
                    </select>
                </div>
            </div>
        </header>

        <div class="card mt-8">
            <!-- Tab Navigation -->
            <div class="px-6 sm:px-8">
                <nav class="tab-nav">
                    <button id="tab-register" class="tab-btn"><i class="fas fa-file-signature mr-2"></i><span data-i18n="tabRegister">Registration</span></button>
                    <button id="tab-players" class="tab-btn"><i class="fas fa-users mr-2"></i><span data-i18n="tabPlayers">Registered Players</span></button>
                    <button id="tab-admin" class="tab-btn ml-auto"><i id="admin-icon" class="fas fa-lock mr-2"></i><span id="admin-text" data-i18n="tabAdmin">Admin</span></button>
                </nav>
            </div>

            <main>
                <!-- Content is now inside the card -->
                <div class="p-6 sm:p-8">
                    <!-- Registration View -->
                    <div id="view-register">
                        <form id="registrationForm" class="space-y-8">
                            <!-- Player Info Section -->
                            <div>
                                <label class="block text-sm font-bold text-gray-400 mb-3 tracking-wider" data-i18n="labelPlayerInfo">PLAYER INFORMATION</label>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <input type="text" id="playerName" class="w-full p-3 rounded-lg form-input" data-i18n-placeholder="placeholderPlayerName" placeholder="Player Name" required>
                                    <input type="number" id="currentServer" class="w-full p-3 rounded-lg form-input" data-i18n-placeholder="placeholderServer" placeholder="Current Server (850-950)" min="850" max="950" required>
                                    <input type="text" id="currentAlliance" class="w-full p-3 rounded-lg form-input" data-i18n-placeholder="placeholderAlliance" placeholder="Current Alliance Tag (e.g., ABCD)" maxlength="4" required>
                                    <input type="number" id="totalPower" class="w-full p-3 rounded-lg form-input" data-i18n-placeholder="placeholderTotalPower" placeholder="Total Power" required>
                                </div>
                            </div>
                            
                            <!-- Seat Color Section -->
                            <div>
                                <label for="seatColor" class="block text-sm font-bold text-gray-400 mb-3 tracking-wider" data-i18n="labelSeatColor">SEAT COLOR</label>
                                <div class="custom-select-wrapper">
                                    <div class="custom-select-display">
                                        <span id="seatColorDisplay" data-i18n="placeholderSeatColor">Select a Seat Color...</span>
                                        <i class="fas fa-chevron-down text-gray-500"></i>
                                    </div>
                                    <select id="seatColor" class="form-select-native" required>
                                        <option value="" disabled selected data-i18n="optionSelectSeatColor">Select a Seat Color...</option>
                                        <option value="White" data-i18n="optionWhite">White</option>
                                        <option value="Blue" data-i18n="optionBlue">Blue</option>
                                        <option value="Purple" data-i18n="optionPurple">Purple</option>
                                        <option value="Gold" data-i18n="optionGold">Gold</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Power Stats Section -->
                            <div>
                                <label class="block text-sm font-bold text-gray-400 mb-3 tracking-wider" data-i18n="labelPowerStats">POWER STATS (at least one required)</label>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <input type="number" id="tankPower" class="w-full p-3 rounded-lg form-input" data-i18n-placeholder="placeholderTankPower" placeholder="Tank Power">
                                    <input type="number" id="airPower" class="w-full p-3 rounded-lg form-input" data-i18n-placeholder="placeholderAirPower" placeholder="Air Power">
                                    <input type="number" id="missilePower" class="w-full p-3 rounded-lg form-input" data-i18n-placeholder="placeholderMissilePower" placeholder="Missile Power">
                                </div>
                            </div>

                            <!-- Options Section -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 pt-2">
                                <div>
                                    <label class="block text-sm font-bold text-gray-400 mb-3 tracking-wider" data-i18n="labelAlliancePref">ALLIANCE PREFERENCE</label>
                                    <div class="flex items-center space-x-6">
                                        <label class="custom-radio-label"><input type="radio" name="alliancePreference" value="no" checked><span class="radio-dot"></span> <span data-i18n="optionNo">No</span></label>
                                        <label class="custom-radio-label"><input type="radio" name="alliancePreference" value="yes"><span class="radio-dot"></span> <span data-i18n="optionYes">Yes</span></label>
                                    </div>
                                    <input type="text" id="preferredAlliance" class="w-full mt-3 p-3 rounded-lg form-input hidden" data-i18n-placeholder="placeholderPrefAlliance" placeholder="Preferred Alliance Tag" maxlength="4">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-400 mb-3 tracking-wider" data-i18n="labelBringOthers">BRINGING OTHERS?</label>
                                    <div class="flex items-center space-x-6">
                                        <label class="custom-radio-label"><input type="radio" name="otherPlayers" value="no" checked><span class="radio-dot"></span> <span data-i18n="optionNo">No</span></label>
                                        <label class="custom-radio-label"><input type="radio" name="otherPlayers" value="yes"><span class="radio-dot"></span> <span data-i18n="optionYes">Yes</span></label>
                                    </div>
                                </div>
                            </div>

                            <div id="otherPlayersContainer" class="space-y-3"></div>
                            <button type="button" id="addPlayerBtn" class="w-full text-sm py-2 px-4 rounded-lg bg-gray-500/20 hover:bg-gray-500/40 text-gray-300 hidden"><i class="fas fa-plus mr-2"></i><span data-i18n="btnAddPlayer">Add Another Player</span></button>

                            <button type="submit" class="w-full p-4 rounded-lg btn-primary text-lg mt-4"><i class="fas fa-paper-plane mr-2"></i><span data-i18n="btnSubmit">Submit Registration</span></button>
                        </form>
                    </div>

                    <!-- Players View -->
                    <div id="view-players" class="hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left whitespace-nowrap">
                                <thead class="text-xs text-gray-400 uppercase tracking-wider bg-black/20">
                                    <tr>
                                        <th class="p-3" data-i18n="tablePlayerName">Player Name</th>
                                        <th class="p-3" data-i18n="tableServer">Server</th>
                                        <th class="p-3" data-i18n="tableAlliance">Alliance</th>
                                        <th class="p-3" data-i18n="tableTotalPower">Total Power</th>
                                        <th class="p-3" data-i18n="tableSeat">Seat</th>
                                        <th class="p-3 admin-only hidden" data-i18n="tableTankPower">Tank Power</th>
                                        <th class="p-3 admin-only hidden" data-i18n="tableAirPower">Air Power</th>
                                        <th class="p-3 admin-only hidden" data-i18n="tableMissilePower">Missile Power</th>
                                        <th class="p-3 super-admin-only hidden" data-i18n="tableActions">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="registrationsTableBody" class="divide-y divide-gray-700"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Super Admin Panel -->
                    <div id="superAdminPanel" class="hidden">
                        <h2 class="text-2xl font-bold mb-6 text-red-500 tracking-wider"><i class="fas fa-cogs mr-2"></i><span data-i18n="superAdminTitle">SUPER ADMIN</span></h2>
                        <div class="space-y-4">
                            <h3 class="text-lg font-semibold text-gray-300"><i class="fab fa-discord mr-2"></i><span data-i18n="webhooksTitle">Discord Webhooks</span></h3>
                            <input type="url" id="webhook1" class="w-full p-3 rounded-lg form-input" data-i18n-placeholder="placeholderWebhook" placeholder="Discord Webhook URL 1">
                            <input type="url" id="webhook2" class="w-full p-3 rounded-lg form-input" data-i18n-placeholder="placeholderWebhook" placeholder="Discord Webhook URL 2">
                            <input type="url" id="webhook3" class="w-full p-3 rounded-lg form-input" data-i18n-placeholder="placeholderWebhook" placeholder="Discord Webhook URL 3">
                            <button id="saveWebhooksBtn" class="w-full p-3 rounded-lg btn-primary"><i class="fas fa-save mr-2"></i><span data-i18n="btnSaveWebhooks">Save Webhooks</span></button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals and Notifications -->
    <div id="notification-container"></div>

    <div id="adminModal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="p-8 rounded-xl shadow-2xl w-full max-w-sm bg-zinc-900 border border-zinc-800">
            <h2 class="text-2xl font-bold mb-6 text-white"><i class="fas fa-shield-halved mr-2 text-red-500"></i><span data-i18n="adminLoginTitle">Admin Login</span></h2>
            <input type="password" id="adminPassword" class="w-full p-3 rounded-lg form-input" data-i18n-placeholder="placeholderPassword" placeholder="Enter Password">
            <div class="flex justify-end space-x-4 mt-6">
                <button id="cancelLogin" class="py-2 px-4 rounded-lg bg-gray-600 hover:bg-gray-500 text-white" data-i18n="btnCancel">Cancel</button>
                <button id="submitLogin" class="py-2 px-4 rounded-lg btn-primary" data-i18n="btnLogin">Login</button>
            </div>
        </div>
    </div>
    
    <div id="editModal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="p-8 rounded-xl shadow-2xl w-full max-w-md bg-zinc-900 border border-zinc-800">
            <h2 class="text-2xl font-bold mb-6 text-white"><i class="fas fa-edit mr-2 text-red-500"></i><span data-i18n="editTitle">Edit Registration</span></h2>
            <form id="editForm" class="space-y-4">
                 <input type="hidden" id="editDocId">
                 <input type="text" id="editPlayerName" class="w-full p-3 rounded-lg form-input" data-i18n-placeholder="placeholderPlayerName" placeholder="Player Name">
                 <input type="number" id="editTotalPower" class="w-full p-3 rounded-lg form-input" data-i18n-placeholder="placeholderTotalPower" placeholder="Total Power">
                 <div class="custom-select-wrapper">
                    <div class="custom-select-display">
                        <span id="editSeatColorDisplay" data-i18n="placeholderSeatColor">Select a Seat Color...</span>
                        <i class="fas fa-chevron-down text-gray-500"></i>
                    </div>
                    <select id="editSeatColor" class="form-select-native">
                        <option value="White" data-i18n="optionWhite">White</option>
                        <option value="Blue" data-i18n="optionBlue">Blue</option>
                        <option value="Purple" data-i18n="optionPurple">Purple</option>
                        <option value="Gold" data-i18n="optionGold">Gold</option>
                    </select>
                 </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="cancelEdit" class="py-2 px-4 rounded-lg bg-gray-600 hover:bg-gray-500 text-white" data-i18n="btnCancel">Cancel</button>
                    <button type="submit" class="py-2 px-4 rounded-lg btn-primary" data-i18n="btnSaveChanges">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirmModal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="p-8 rounded-xl shadow-2xl w-full max-w-sm bg-zinc-900 border border-zinc-800">
            <h2 class="text-xl font-bold mb-4 text-white"><i class="fas fa-exclamation-triangle mr-2 text-yellow-400"></i><span data-i18n="confirmTitle">Are you sure?</span></h2>
            <p id="confirmMessage" class="text-gray-400 mb-6" data-i18n="confirmMessage">This action cannot be undone.</p>
            <div class="flex justify-end space-x-4">
                <button id="cancelConfirm" class="py-2 px-4 rounded-lg bg-gray-600 hover:bg-gray-500 text-white" data-i18n="btnCancel">Cancel</button>
                <button id="submitConfirm" class="py-2 px-4 rounded-lg bg-red-600 hover:bg-red-500 text-white" data-i18n="btnConfirm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, getDoc, setDoc, updateDoc, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Helper Functions (defined first to prevent reference errors) ---
        const showNotification = (message, type = 'success') => {
            const container = document.getElementById('notification-container');
            const notif = document.createElement('div');
            notif.className = `notification ${type}`;
            notif.textContent = message;
            container.appendChild(notif);
            setTimeout(() => {
                notif.remove();
            }, 5000);
        };

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyD1W6tFMNLWw2WlxzO_M1dgijXQYp6p75w",
            authDomain: "transfers-a7cbb.firebaseapp.com",
            projectId: "transfers-a7cbb",
            storageBucket: "transfers-a7cbb.firebasestorage.app",
            messagingSenderId: "940205814599",
            appId: "1:940205814599:web:657408c6d20385cf361262",
            measurementId: "G-0WL6PQTGJ1"
            };
        const appId = typeof __app_id !== 'undefined' ? __app_id : '1:940205814599:web:657408c6d20385cf361262';
        
        let app, db, auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (authError) {
                 console.error("Firebase authentication failed:", authError);
                 if (authError.code === 'auth/operation-not-allowed') {
                     showNotification("Authentication failed. Please ensure Anonymous sign-in is enabled in your Firebase project.", "error");
                 } else {
                     showNotification("Could not authenticate with the server.", "error");
                 }
            }
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            showNotification("Could not connect to the database. Please refresh.", "error");
        }

        // --- Collections ---
        const registrationsCollection = collection(db, `/artifacts/${appId}/public/data/registrations`);
        const configDoc = doc(db, `/artifacts/${appId}/public/data/config/settings`);

        // --- State Management ---
        let loginState = 'guest'; // 'guest', 'admin', 'super_admin'
        let allPlayers = [];
        let otherPlayerNames = new Set();
        let currentLanguage = 'en';

        // --- UI Elements ---
        const tabRegister = document.getElementById('tab-register');
        const tabPlayers = document.getElementById('tab-players');
        const tabAdmin = document.getElementById('tab-admin');
        const viewRegister = document.getElementById('view-register');
        const viewPlayers = document.getElementById('view-players');
        const adminModal = document.getElementById('adminModal');
        const editModal = document.getElementById('editModal');
        const confirmModal = document.getElementById('confirmModal');
        const registrationForm = document.getElementById('registrationForm');
        const registrationsTableBody = document.getElementById('registrationsTableBody');
        const superAdminPanel = document.getElementById('superAdminPanel');
        const adminIcon = document.getElementById('admin-icon');
        const adminText = document.getElementById('admin-text');
        const seatColorSelect = document.getElementById('seatColor');
        const seatColorDisplay = document.getElementById('seatColorDisplay');
        const editSeatColorSelect = document.getElementById('editSeatColor');
        const editSeatColorDisplay = document.getElementById('editSeatColorDisplay');
        const languageSelector = document.getElementById('languageSelector');
        const languageDisplay = document.getElementById('languageDisplay');

        // --- Translation Data ---
        const translations = {
            en: {
                title: "899 Transfers", subtitle: "Registration Portal", tabRegister: "Registration", tabPlayers: "Registered Players", tabAdmin: "Admin",
                labelPlayerInfo: "Player Information", placeholderPlayerName: "Player Name", placeholderServer: "Current Server (850-950)", placeholderAlliance: "Current Alliance Tag (e.g., ABCD)", placeholderTotalPower: "Total Power",
                labelSeatColor: "Seat Color", placeholderSeatColor: "Select a Seat Color...", optionSelectSeatColor: "Select a Seat Color...", optionWhite: "White", optionBlue: "Blue", optionPurple: "Purple", optionGold: "Gold",
                labelPowerStats: "Power Stats (at least one required)", placeholderTankPower: "Tank Power", placeholderAirPower: "Air Power", placeholderMissilePower: "Missile Power",
                labelAlliancePref: "Alliance Preference", optionNo: "No", optionYes: "Yes", placeholderPrefAlliance: "Preferred Alliance Tag",
                labelBringOthers: "Bringing Others?", btnAddPlayer: "Add Another Player", btnSubmit: "Submit Registration",
                tablePlayerName: "Player Name", tableServer: "Server", tableAlliance: "Alliance", tableTotalPower: "Total Power", tableSeat: "Seat", tableTankPower: "Tank Power", tableAirPower: "Air Power", tableMissilePower: "Missile Power", tableActions: "Actions",
                superAdminTitle: "Super Admin", webhooksTitle: "Discord Webhooks", placeholderWebhook: "Discord Webhook URL", btnSaveWebhooks: "Save Webhooks",
                adminLoginTitle: "Admin Login", placeholderPassword: "Enter Password", btnCancel: "Cancel", btnLogin: "Login",
                editTitle: "Edit Registration", btnSaveChanges: "Save Changes",
                confirmTitle: "Are you sure?", confirmMessage: "This action cannot be undone.", btnConfirm: "Confirm",
                logout: "Logout"
            },
            es: {
                title: "Transferencias 899", subtitle: "Portal de Registro", tabRegister: "Registro", tabPlayers: "Jugadores Registrados", tabAdmin: "Admin",
                labelPlayerInfo: "Información del Jugador", placeholderPlayerName: "Nombre del Jugador", placeholderServer: "Servidor Actual (850-950)", placeholderAlliance: "Etiqueta de Alianza (ej. ABCD)", placeholderTotalPower: "Poder Total",
                labelSeatColor: "Color de Asiento", placeholderSeatColor: "Selecciona un Color...", optionSelectSeatColor: "Selecciona un Color...", optionWhite: "Blanco", optionBlue: "Azul", optionPurple: "Morado", optionGold: "Dorado",
                labelPowerStats: "Estadísticas de Poder (mínimo uno)", placeholderTankPower: "Poder de Tanque", placeholderAirPower: "Poder Aéreo", placeholderMissilePower: "Poder de Misiles",
                labelAlliancePref: "Preferencia de Alianza", optionNo: "No", optionYes: "Sí", placeholderPrefAlliance: "Etiqueta de Alianza Preferida",
                labelBringOthers: "¿Traes a otros jugadores?", btnAddPlayer: "Añadir Otro Jugador", btnSubmit: "Enviar Registro",
                tablePlayerName: "Nombre del Jugador", tableServer: "Servidor", tableAlliance: "Alianza", tableTotalPower: "Poder Total", tableSeat: "Asiento", tableTankPower: "Poder Tanque", tableAirPower: "Poder Aéreo", tableMissilePower: "Poder Misiles", tableActions: "Acciones",
                superAdminTitle: "Super Admin", webhooksTitle: "Webhooks de Discord", placeholderWebhook: "URL de Webhook", btnSaveWebhooks: "Guardar Webhooks",
                adminLoginTitle: "Acceso Admin", placeholderPassword: "Ingresar Contraseña", btnCancel: "Cancelar", btnLogin: "Acceder",
                editTitle: "Editar Registro", btnSaveChanges: "Guardar Cambios",
                confirmTitle: "¿Estás seguro?", confirmMessage: "Esta acción no se puede deshacer.", btnConfirm: "Confirmar",
                logout: "Cerrar Sesión"
            },
            zh: {
                title: "899 服务器转移", subtitle: "注册门户", tabRegister: "注册", tabPlayers: "已注册玩家", tabAdmin: "管理员",
                labelPlayerInfo: "玩家信息", placeholderPlayerName: "玩家名称", placeholderServer: "当前服务器 (850-950)", placeholderAlliance: "当前联盟标签 (例如 ABCD)", placeholderTotalPower: "总战力",
                labelSeatColor: "席位颜色", placeholderSeatColor: "选择席位颜色...", optionSelectSeatColor: "选择席位颜色...", optionWhite: "白色", optionBlue: "蓝色", optionPurple: "紫色", optionGold: "金色",
                labelPowerStats: "战力数据 (至少一项)", placeholderTankPower: "坦克战力", placeholderAirPower: "空军战力", placeholderMissilePower: "导弹战力",
                labelAlliancePref: "联盟偏好", optionNo: "否", optionYes: "是", placeholderPrefAlliance: "首选联盟标签",
                labelBringOthers: "有其他玩家同行吗?", btnAddPlayer: "添加另一名玩家", btnSubmit: "提交注册",
                tablePlayerName: "玩家名称", tableServer: "服务器", tableAlliance: "联盟", tableTotalPower: "总战力", tableSeat: "席位", tableTankPower: "坦克战力", tableAirPower: "空军战力", tableMissilePower: "导弹战力", tableActions: "操作",
                superAdminTitle: "超级管理员", webhooksTitle: "Discord Webhooks", placeholderWebhook: "Discord Webhook 网址", btnSaveWebhooks: "保存 Webhooks",
                adminLoginTitle: "管理员登录", placeholderPassword: "输入密码", btnCancel: "取消", btnLogin: "登录",
                editTitle: "编辑注册信息", btnSaveChanges: "保存更改",
                confirmTitle: "您确定吗?", confirmMessage: "此操作无法撤销。", btnConfirm: "确认",
                logout: "登出"
            },
            hi: {
                title: "899 सर्वर स्थानांतरण", subtitle: "पंजीकरण पोर्टल", tabRegister: "पंजीकरण", tabPlayers: "पंजीकृत खिलाड़ी", tabAdmin: "एडमिन",
                labelPlayerInfo: "खिलाड़ी की जानकारी", placeholderPlayerName: "खिलाड़ी का नाम", placeholderServer: "वर्तमान सर्वर (850-950)", placeholderAlliance: "वर्तमान गठबंधन टैग (उदा. ABCD)", placeholderTotalPower: "कुल शक्ति",
                labelSeatColor: "सीट का रंग", placeholderSeatColor: "एक सीट का रंग चुनें...", optionSelectSeatColor: "एक सीट का रंग चुनें...", optionWhite: "सफ़ेद", optionBlue: "नीला", optionPurple: "बैंगनी", optionGold: "सुनहरा",
                labelPowerStats: "शक्ति आँकड़े (कम से कम एक)", placeholderTankPower: "टैंक शक्ति", placeholderAirPower: "वायु शक्ति", placeholderMissilePower: "मिसाइल शक्ति",
                labelAlliancePref: "गठबंधन वरीयता", optionNo: "नहीं", optionYes: "हाँ", placeholderPrefAlliance: "पसंदीदा गठबंधन टैग",
                labelBringOthers: "अन्य खिलाड़ियों को ला रहे हैं?", btnAddPlayer: "एक और खिलाड़ी जोड़ें", btnSubmit: "पंजीकरण जमा करें",
                tablePlayerName: "खिलाड़ी का नाम", tableServer: "सर्वर", tableAlliance: "गठबंधन", tableTotalPower: "कुल शक्ति", tableSeat: "सीट", tableTankPower: "टैंक शक्ति", tableAirPower: "वायु शक्ति", tableMissilePower: "मिसाइल शक्ति", tableActions: "कार्रवाइयाँ",
                superAdminTitle: "सुपर एडमिन", webhooksTitle: "डिस्कॉर्ड वेबहुक", placeholderWebhook: "डिस्कॉर्ड वेबहुक यूआरएल", btnSaveWebhooks: "वेबहुक सहेजें",
                adminLoginTitle: "एडमिन लॉगिन", placeholderPassword: "पासवर्ड डालें", btnCancel: "रद्द करें", btnLogin: "लॉगिन करें",
                editTitle: "पंजीकरण संपादित करें", btnSaveChanges: "बदलाव सहेजें",
                confirmTitle: "क्या आप निश्चित हैं?", confirmMessage: "यह कार्रवाई पूर्ववत नहीं की जा सकती।", btnConfirm: "पुष्टि करें",
                logout: "लॉग आउट"
            },
            ar: {
                title: "نقل خادم 899", subtitle: "بوابة التسجيل", tabRegister: "تسجيل", tabPlayers: "اللاعبون المسجلون", tabAdmin: "مشرف",
                labelPlayerInfo: "معلومات اللاعب", placeholderPlayerName: "اسم اللاعب", placeholderServer: "الخادم الحالي (850-950)", placeholderAlliance: "علامة التحالف الحالية (مثل ABCD)", placeholderTotalPower: "إجمالي القوة",
                labelSeatColor: "لون المقعد", placeholderSeatColor: "اختر لون المقعد...", optionSelectSeatColor: "اختر لون المقعد...", optionWhite: "أبيض", optionBlue: "أزرق", optionPurple: "أرجواني", optionGold: "ذهبي",
                labelPowerStats: "إحصائيات القوة (واحد على الأقل)", placeholderTankPower: "قوة الدبابات", placeholderAirPower: "قوة الطيران", placeholderMissilePower: "قوة الصواريخ",
                labelAlliancePref: "تفضيل التحالف", optionNo: "لا", optionYes: "نعم", placeholderPrefAlliance: "علامة التحالف المفضلة",
                labelBringOthers: "هل تحضر لاعبين آخرين؟", btnAddPlayer: "إضافة لاعب آخر", btnSubmit: "إرسال التسجيل",
                tablePlayerName: "اسم اللاعب", tableServer: "الخادم", tableAlliance: "التحالف", tableTotalPower: "إجمالي القوة", tableSeat: "المقعد", tableTankPower: "قوة الدبابات", tableAirPower: "قوة الطيران", tableMissilePower: "قوة الصواريخ", tableActions: "الإجراءات",
                superAdminTitle: "مشرف خارق", webhooksTitle: "Discord Webhooks", placeholderWebhook: "رابط Discord Webhook", btnSaveWebhooks: "حفظ Webhooks",
                adminLoginTitle: "تسجيل دخول المشرف", placeholderPassword: "أدخل كلمة المرور", btnCancel: "إلغاء", btnLogin: "تسجيل الدخول",
                editTitle: "تعديل التسجيل", btnSaveChanges: "حفظ التغييرات",
                confirmTitle: "هل أنت متأكد؟", confirmMessage: "لا يمكن التراجع عن هذا الإجراء.", btnConfirm: "تأكيد",
                logout: "تسجيل الخروج"
            },
            pt: {
                title: "Transferências 899", subtitle: "Portal de Registro", tabRegister: "Registro", tabPlayers: "Jogadores Registrados", tabAdmin: "Admin",
                labelPlayerInfo: "Informações do Jogador", placeholderPlayerName: "Nome do Jogador", placeholderServer: "Servidor Atual (850-950)", placeholderAlliance: "Tag da Aliança (ex: ABCD)", placeholderTotalPower: "Poder Total",
                labelSeatColor: "Cor do Assento", placeholderSeatColor: "Selecione uma Cor...", optionSelectSeatColor: "Selecione uma Cor...", optionWhite: "Branco", optionBlue: "Azul", optionPurple: "Roxo", optionGold: "Dourado",
                labelPowerStats: "Atributos de Poder (pelo menos um)", placeholderTankPower: "Poder de Tanque", placeholderAirPower: "Poder Aéreo", placeholderMissilePower: "Poder de Míssil",
                labelAlliancePref: "Preferência de Aliança", optionNo: "Não", optionYes: "Sim", placeholderPrefAlliance: "Tag da Aliança Preferida",
                labelBringOthers: "Trazendo outros jogadores?", btnAddPlayer: "Adicionar Outro Jogador", btnSubmit: "Enviar Registro",
                tablePlayerName: "Nome do Jogador", tableServer: "Servidor", tableAlliance: "Aliança", tableTotalPower: "Poder Total", tableSeat: "Assento", tableTankPower: "Poder Tanque", tableAirPower: "Poder Aéreo", tableMissilePower: "Poder Míssil", tableActions: "Ações",
                superAdminTitle: "Super Admin", webhooksTitle: "Webhooks do Discord", placeholderWebhook: "URL do Webhook", btnSaveWebhooks: "Salvar Webhooks",
                adminLoginTitle: "Login de Admin", placeholderPassword: "Digite a Senha", btnCancel: "Cancelar", btnLogin: "Login",
                editTitle: "Editar Registro", btnSaveChanges: "Salvar Alterações",
                confirmTitle: "Você tem certeza?", confirmMessage: "Esta ação não pode ser desfeita.", btnConfirm: "Confirmar",
                logout: "Sair"
            },
            ru: {
                title: "Трансферы 899", subtitle: "Портал регистрации", tabRegister: "Регистрация", tabPlayers: "Зарегистрированные игроки", tabAdmin: "Админ",
                labelPlayerInfo: "Информация об игроке", placeholderPlayerName: "Имя игрока", placeholderServer: "Текущий сервер (850-950)", placeholderAlliance: "Тег альянса (напр. ABCD)", placeholderTotalPower: "Общая мощь",
                labelSeatColor: "Цвет места", placeholderSeatColor: "Выберите цвет...", optionSelectSeatColor: "Выберите цвет...", optionWhite: "Белый", optionBlue: "Синий", optionPurple: "Фиолетовый", optionGold: "Золотой",
                labelPowerStats: "Параметры мощи (минимум один)", placeholderTankPower: "Мощь танков", placeholderAirPower: "Мощь авиации", placeholderMissilePower: "Мощь ракет",
                labelAlliancePref: "Предпочтение альянса", optionNo: "Нет", optionYes: "Да", placeholderPrefAlliance: "Предпочитаемый тег альянса",
                labelBringOthers: "Приводите других игроков?", btnAddPlayer: "Добавить игрока", btnSubmit: "Отправить регистрацию",
                tablePlayerName: "Имя игрока", tableServer: "Сервер", tableAlliance: "Альянс", tableTotalPower: "Общая мощь", tableSeat: "Место", tableTankPower: "Мощь танков", tableAirPower: "Мощь авиации", tableMissilePower: "Мощь ракет", tableActions: "Действия",
                superAdminTitle: "Супер-админ", webhooksTitle: "Веб-хуки Discord", placeholderWebhook: "URL веб-хука", btnSaveWebhooks: "Сохранить веб-хуки",
                adminLoginTitle: "Вход для админа", placeholderPassword: "Введите пароль", btnCancel: "Отмена", btnLogin: "Войти",
                editTitle: "Редактировать регистрацию", btnSaveChanges: "Сохранить изменения",
                confirmTitle: "Вы уверены?", confirmMessage: "Это действие нельзя отменить.", btnConfirm: "Подтвердить",
                logout: "Выйти"
            },
            ja: {
                title: "899サーバー移籍", subtitle: "登録ポータル", tabRegister: "登録", tabPlayers: "登録済みプレイヤー", tabAdmin: "管理者",
                labelPlayerInfo: "プレイヤー情報", placeholderPlayerName: "プレイヤー名", placeholderServer: "現在のサーバー (850-950)", placeholderAlliance: "現在の同盟タグ (例: ABCD)", placeholderTotalPower: "総戦力",
                labelSeatColor: "座席の色", placeholderSeatColor: "色を選択...", optionSelectSeatColor: "色を選択...", optionWhite: "白", optionBlue: "青", optionPurple: "紫", optionGold: "金",
                labelPowerStats: "戦力ステータス (最低1つ)", placeholderTankPower: "戦車戦力", placeholderAirPower: "空軍戦力", placeholderMissilePower: "ミサイル戦力",
                labelAlliancePref: "同盟の希望", optionNo: "いいえ", optionYes: "はい", placeholderPrefAlliance: "希望の同盟タグ",
                labelBringOthers: "他のプレイヤーを連れてきますか？", btnAddPlayer: "プレイヤーを追加", btnSubmit: "登録を送信",
                tablePlayerName: "プレイヤー名", tableServer: "サーバー", tableAlliance: "同盟", tableTotalPower: "総戦力", tableSeat: "座席", tableTankPower: "戦車戦力", tableAirPower: "空軍戦力", tableMissilePower: "ミサイル戦力", tableActions: "操作",
                superAdminTitle: "スーパー管理者", webhooksTitle: "Discord Webhook", placeholderWebhook: "Discord Webhook URL", btnSaveWebhooks: "Webhookを保存",
                adminLoginTitle: "管理者ログイン", placeholderPassword: "パスワードを入力", btnCancel: "キャンセル", btnLogin: "ログイン",
                editTitle: "登録を編集", btnSaveChanges: "変更を保存",
                confirmTitle: "よろしいですか？", confirmMessage: "この操作は元に戻せません。", btnConfirm: "確認",
                logout: "ログアウト"
            },
            de: {
                title: "899 Transfers", subtitle: "Registrierungsportal", tabRegister: "Registrierung", tabPlayers: "Registrierte Spieler", tabAdmin: "Admin",
                labelPlayerInfo: "Spielerinformationen", placeholderPlayerName: "Spielername", placeholderServer: "Aktueller Server (850-950)", placeholderAlliance: "Allianz-Tag (z.B. ABCD)", placeholderTotalPower: "Gesamtstärke",
                labelSeatColor: "Sitzfarbe", placeholderSeatColor: "Wähle eine Farbe...", optionSelectSeatColor: "Wähle eine Farbe...", optionWhite: "Weiß", optionBlue: "Blau", optionPurple: "Lila", optionGold: "Gold",
                labelPowerStats: "Stärkewerte (mindestens einer)", placeholderTankPower: "Panzerstärke", placeholderAirPower: "Luftstärke", placeholderMissilePower: "Raketenstärke",
                labelAlliancePref: "Allianzpräferenz", optionNo: "Nein", optionYes: "Ja", placeholderPrefAlliance: "Bevorzugter Allianz-Tag",
                labelBringOthers: "Andere Spieler mitbringen?", btnAddPlayer: "Weiteren Spieler hinzufügen", btnSubmit: "Registrierung absenden",
                tablePlayerName: "Spielername", tableServer: "Server", tableAlliance: "Allianz", tableTotalPower: "Gesamtstärke", tableSeat: "Sitz", tableTankPower: "Panzerstärke", tableAirPower: "Luftstärke", tableMissilePower: "Raketenstärke", tableActions: "Aktionen",
                superAdminTitle: "Super-Admin", webhooksTitle: "Discord Webhooks", placeholderWebhook: "Discord Webhook URL", btnSaveWebhooks: "Webhooks speichern",
                adminLoginTitle: "Admin-Login", placeholderPassword: "Passwort eingeben", btnCancel: "Abbrechen", btnLogin: "Anmelden",
                editTitle: "Registrierung bearbeiten", btnSaveChanges: "Änderungen speichern",
                confirmTitle: "Sind Sie sicher?", confirmMessage: "Diese Aktion kann nicht rückgängig gemacht werden.", btnConfirm: "Bestätigen",
                logout: "Abmelden"
            },
            fr: {
                title: "Transferts 899", subtitle: "Portail d'inscription", tabRegister: "Inscription", tabPlayers: "Joueurs inscrits", tabAdmin: "Admin",
                labelPlayerInfo: "Informations du joueur", placeholderPlayerName: "Nom du joueur", placeholderServer: "Serveur actuel (850-950)", placeholderAlliance: "Tag d'alliance (ex: ABCD)", placeholderTotalPower: "Puissance totale",
                labelSeatColor: "Couleur du siège", placeholderSeatColor: "Sélectionnez une couleur...", optionSelectSeatColor: "Sélectionnez une couleur...", optionWhite: "Blanc", optionBlue: "Bleu", optionPurple: "Violet", optionGold: "Or",
                labelPowerStats: "Stats de puissance (au moins une)", placeholderTankPower: "Puissance des chars", placeholderAirPower: "Puissance aérienne", placeholderMissilePower: "Puissance des missiles",
                labelAlliancePref: "Préférence d'alliance", optionNo: "Non", optionYes: "Oui", placeholderPrefAlliance: "Tag d'alliance préféré",
                labelBringOthers: "Amenez-vous d'autres joueurs?", btnAddPlayer: "Ajouter un autre joueur", btnSubmit: "Soumettre l'inscription",
                tablePlayerName: "Nom du joueur", tableServer: "Serveur", tableAlliance: "Alliance", tableTotalPower: "Puissance totale", tableSeat: "Siège", tableTankPower: "Puissance chars", tableAirPower: "Puissance aérienne", tableMissilePower: "Puissance missiles", tableActions: "Actions",
                superAdminTitle: "Super Admin", webhooksTitle: "Webhooks Discord", placeholderWebhook: "URL du Webhook", btnSaveWebhooks: "Enregistrer les Webhooks",
                adminLoginTitle: "Connexion Admin", placeholderPassword: "Entrez le mot de passe", btnCancel: "Annuler", btnLogin: "Connexion",
                editTitle: "Modifier l'inscription", btnSaveChanges: "Sauvegarder les modifications",
                confirmTitle: "Êtes-vous sûr?", confirmMessage: "Cette action est irréversible.", btnConfirm: "Confirmer",
                logout: "Déconnexion"
            },
            ko: {
                title: "899 서버 이전", subtitle: "등록 포털", tabRegister: "등록", tabPlayers: "등록된 플레이어", tabAdmin: "관리자",
                labelPlayerInfo: "플레이어 정보", placeholderPlayerName: "플레이어 이름", placeholderServer: "현재 서버 (850-950)", placeholderAlliance: "현재 동맹 태그 (예: ABCD)", placeholderTotalPower: "총 전투력",
                labelSeatColor: "좌석 색상", placeholderSeatColor: "색상 선택...", optionSelectSeatColor: "색상 선택...", optionWhite: "흰색", optionBlue: "파란색", optionPurple: "보라색", optionGold: "금색",
                labelPowerStats: "전투력 정보 (하나 이상)", placeholderTankPower: "탱크 전투력", placeholderAirPower: "공군 전투력", placeholderMissilePower: "미사일 전투력",
                labelAlliancePref: "동맹 선호", optionNo: "아니요", optionYes: "예", placeholderPrefAlliance: "선호하는 동맹 태그",
                labelBringOthers: "다른 플레이어와 함께 오나요?", btnAddPlayer: "다른 플레이어 추가", btnSubmit: "등록 제출",
                tablePlayerName: "플레이어 이름", tableServer: "서버", tableAlliance: "동맹", tableTotalPower: "총 전투력", tableSeat: "좌석", tableTankPower: "탱크 전투력", tableAirPower: "공군 전투력", tableMissilePower: "미사일 전투력", tableActions: "작업",
                superAdminTitle: "최고 관리자", webhooksTitle: "Discord 웹훅", placeholderWebhook: "Discord 웹훅 URL", btnSaveWebhooks: "웹훅 저장",
                adminLoginTitle: "관리자 로그인", placeholderPassword: "비밀번호 입력", btnCancel: "취소", btnLogin: "로그인",
                editTitle: "등록 수정", btnSaveChanges: "변경 사항 저장",
                confirmTitle: "확실합니까?", confirmMessage: "이 작업은 되돌릴 수 없습니다.", btnConfirm: "확인",
                logout: "로그아웃"
            },
            id: {
                title: "Transfer 899", subtitle: "Portal Registrasi", tabRegister: "Registrasi", tabPlayers: "Pemain Terdaftar", tabAdmin: "Admin",
                labelPlayerInfo: "Informasi Pemain", placeholderPlayerName: "Nama Pemain", placeholderServer: "Server Saat Ini (850-950)", placeholderAlliance: "Tag Aliansi (cth: ABCD)", placeholderTotalPower: "Total Kekuatan",
                labelSeatColor: "Warna Kursi", placeholderSeatColor: "Pilih Warna Kursi...", optionSelectSeatColor: "Pilih Warna Kursi...", optionWhite: "Putih", optionBlue: "Biru", optionPurple: "Ungu", optionGold: "Emas",
                labelPowerStats: "Statistik Kekuatan (minimal satu)", placeholderTankPower: "Kekuatan Tank", placeholderAirPower: "Kekuatan Udara", placeholderMissilePower: "Kekuatan Misil",
                labelAlliancePref: "Preferensi Aliansi", optionNo: "Tidak", optionYes: "Ya", placeholderPrefAlliance: "Tag Aliansi Pilihan",
                labelBringOthers: "Membawa pemain lain?", btnAddPlayer: "Tambah Pemain Lain", btnSubmit: "Kirim Registrasi",
                tablePlayerName: "Nama Pemain", tableServer: "Server", tableAlliance: "Aliansi", tableTotalPower: "Total Kekuatan", tableSeat: "Kursi", tableTankPower: "Kekuatan Tank", tableAirPower: "Kekuatan Udara", tableMissilePower: "Kekuatan Misil", tableActions: "Aksi",
                superAdminTitle: "Super Admin", webhooksTitle: "Webhook Discord", placeholderWebhook: "URL Webhook Discord", btnSaveWebhooks: "Simpan Webhook",
                adminLoginTitle: "Login Admin", placeholderPassword: "Masukkan Kata Sandi", btnCancel: "Batal", btnLogin: "Login",
                editTitle: "Edit Registrasi", btnSaveChanges: "Simpan Perubahan",
                confirmTitle: "Apakah Anda yakin?", confirmMessage: "Tindakan ini tidak dapat dibatalkan.", btnConfirm: "Konfirmasi",
                logout: "Keluar"
            }
        };

        // --- Helper Functions (defined first to prevent reference errors) ---
        const showConfirm = (message, onConfirm) => {
            document.getElementById('confirmMessage').textContent = message;
            confirmModal.style.display = 'flex';
            const confirmBtn = document.getElementById('submitConfirm');
            const cancelBtn = document.getElementById('cancelConfirm');
            const confirmHandler = () => { onConfirm(); cleanup(); };
            const cancelHandler = () => cleanup();
            function cleanup() {
                confirmModal.style.display = 'none';
                confirmBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', cancelHandler);
            }
            confirmBtn.addEventListener('click', confirmHandler, { once: true });
            cancelBtn.addEventListener('click', cancelHandler, { once: true });
        };
        
        const formatPower = (num) => {
            if (num === null || num === undefined || num === '') return 'N/A';
            return Number(num).toLocaleString();
        };

        const translatePage = (lang) => {
            currentLanguage = lang;
            const langStrings = translations[lang];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (langStrings[key]) {
                    el.textContent = langStrings[key];
                }
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (langStrings[key]) {
                    el.placeholder = langStrings[key];
                }
            });
            // Update admin tab text based on login state
            if(loginState !== 'guest') {
                adminText.textContent = langStrings.logout;
            }
        };

        const updateUIForLoginState = () => {
            document.querySelectorAll('.admin-only, .super-admin-only').forEach(el => el.classList.add('hidden'));
            
            const langStrings = translations[currentLanguage];
            if (loginState === 'guest') {
                adminIcon.className = 'fas fa-lock mr-2';
                adminText.textContent = langStrings.tabAdmin;
                tabAdmin.classList.remove('active');
            } else {
                adminIcon.className = 'fas fa-sign-out-alt mr-2';
                adminText.textContent = langStrings.logout;
                if (loginState === 'admin' || loginState === 'super_admin') {
                    document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
                }
                if (loginState === 'super_admin') {
                    document.querySelectorAll('.super-admin-only').forEach(el => el.classList.remove('hidden'));
                }
            }
            renderTable();
        };

        const switchView = (view) => {
            viewRegister.classList.add('hidden');
            viewPlayers.classList.add('hidden');
            superAdminPanel.classList.add('hidden');
            tabRegister.classList.remove('active');
            tabPlayers.classList.remove('active');
            tabAdmin.classList.remove('active');

            if (view === 'register') {
                viewRegister.classList.remove('hidden');
                tabRegister.classList.add('active');
            } else if (view === 'players') {
                viewPlayers.classList.remove('hidden');
                tabPlayers.classList.add('active');
            } else if (view === 'admin') {
                superAdminPanel.classList.remove('hidden');
                tabAdmin.classList.add('active');
            }
        };

        // --- Data Fetching and Rendering ---
        const renderTable = () => {
            registrationsTableBody.innerHTML = '';
            otherPlayerNames.clear();
            allPlayers.forEach(p => {
                if (p.otherPlayers && Array.isArray(p.otherPlayers)) {
                    p.otherPlayers.forEach(name => otherPlayerNames.add(name.toLowerCase()));
                }
            });

            const sortedPlayers = [...allPlayers].sort((a, b) => b.totalPower - a.totalPower);

            if (sortedPlayers.length === 0) {
                registrationsTableBody.innerHTML = `<tr><td colspan="9" class="text-center p-8 text-gray-500">No registrations yet.</td></tr>`;
                return;
            }

            sortedPlayers.forEach(player => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-500/10 transition-colors duration-200';
                if (otherPlayerNames.has(player.playerName.toLowerCase())) {
                    row.classList.add('bg-red-500/5');
                }
                const canViewSensitive = loginState === 'admin' || loginState === 'super_admin';
                row.innerHTML = `
                    <td class="p-3">${canViewSensitive ? player.playerName : 'Hidden'}</td>
                    <td class="p-3">${player.currentServer}</td>
                    <td class="p-3">${canViewSensitive ? player.currentAlliance : '****'}</td>
                    <td class="p-3">${formatPower(player.totalPower)}</td>
                    <td class="p-3">${player.seatColor}</td>
                    <td class="p-3 admin-only hidden">${formatPower(player.tankPower)}</td>
                    <td class="p-3 admin-only hidden">${formatPower(player.airPower)}</td>
                    <td class="p-3 admin-only hidden">${formatPower(player.missilePower)}</td>
                    <td class="p-3 super-admin-only hidden">
                        <button class="edit-btn text-blue-400 hover:text-blue-300 mr-2" data-id="${player.id}"><i class="fas fa-edit"></i></button>
                        <button class="delete-btn text-red-400 hover:text-red-300" data-id="${player.id}"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                registrationsTableBody.appendChild(row);
                if (canViewSensitive) row.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
                if (loginState === 'super_admin') row.querySelectorAll('.super-admin-only').forEach(el => el.classList.remove('hidden'));
            });
        };

        onSnapshot(query(registrationsCollection), (snapshot) => {
            allPlayers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderTable();
        });
        
        // --- Event Listeners ---
        tabRegister.addEventListener('click', () => switchView('register'));
        tabPlayers.addEventListener('click', () => switchView('players'));
        tabAdmin.addEventListener('click', () => {
            if (loginState === 'guest') {
                adminModal.style.display = 'flex';
            } else if (loginState === 'super_admin') {
                switchView('admin');
            } else { // 'admin' or 'super_admin' logs out
                const oldState = loginState;
                loginState = 'guest';
                updateUIForLoginState();
                switchView('register');
                if (oldState !== 'guest') {
                    showNotification('You have been logged out.');
                }
            }
        });

        registrationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const tankPower = document.getElementById('tankPower').value;
            const airPower = document.getElementById('airPower').value;
            const missilePower = document.getElementById('missilePower').value;
            if (!tankPower && !airPower && !missilePower) {
                showNotification('Please fill out at least one power type.', 'error');
                return;
            }
            const otherPlayersList = Array.from(document.querySelectorAll('.other-player-input')).map(input => input.value).filter(name => name.trim() !== '');
            const registrationData = {
                playerName: document.getElementById('playerName').value,
                currentServer: document.getElementById('currentServer').value,
                currentAlliance: document.getElementById('currentAlliance').value,
                totalPower: Number(document.getElementById('totalPower').value),
                seatColor: document.getElementById('seatColor').value,
                tankPower: Number(tankPower) || 0,
                airPower: Number(airPower) || 0,
                missilePower: Number(missilePower) || 0,
                alliancePreference: document.querySelector('input[name="alliancePreference"]:checked').value,
                preferredAlliance: document.getElementById('preferredAlliance').value,
                otherPlayers: otherPlayersList,
                language: currentLanguage,
                createdAt: new Date()
            };
            try {
                await addDoc(registrationsCollection, registrationData);
                showNotification('Registration successful!');
                registrationForm.reset();
                seatColorDisplay.textContent = translations[currentLanguage].placeholderSeatColor;
                document.getElementById('otherPlayersContainer').innerHTML = '';
                document.getElementById('addPlayerBtn').classList.add('hidden');
                document.getElementById('preferredAlliance').classList.add('hidden');
                sendDiscordNotification(registrationData);
            } catch (error) {
                console.error("Error adding document: ", error);
                showNotification('There was an error submitting your registration.', 'error');
            }
        });
        
        document.getElementById('cancelLogin').addEventListener('click', () => adminModal.style.display = 'none');
        document.getElementById('submitLogin').addEventListener('click', () => {
            const password = document.getElementById('adminPassword').value;
            if (password === 'dumpkitten') {
                loginState = 'super_admin';
                switchView('admin');
            } else if (password === 'supremebear') {
                loginState = 'admin';
                switchView('players');
            } else {
                showNotification('Incorrect password.', 'error');
                return;
            }
            adminModal.style.display = 'none';
            document.getElementById('adminPassword').value = '';
            updateUIForLoginState();
            loadWebhooks();
        });

        document.querySelectorAll('input[name="alliancePreference"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                document.getElementById('preferredAlliance').classList.toggle('hidden', e.target.value === 'no');
            });
        });

        document.querySelectorAll('input[name="otherPlayers"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const addBtn = document.getElementById('addPlayerBtn');
                addBtn.classList.toggle('hidden', e.target.value === 'no');
                if (e.target.value === 'no') {
                    document.getElementById('otherPlayersContainer').innerHTML = '';
                } else if (document.getElementById('otherPlayersContainer').childElementCount === 0) {
                    document.getElementById('addPlayerBtn').click();
                }
            });
        });

        document.getElementById('addPlayerBtn').addEventListener('click', () => {
            const container = document.getElementById('otherPlayersContainer');
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'w-full p-3 rounded-lg form-input other-player-input';
            input.placeholder = translations[currentLanguage].placeholderPlayerName;
            container.appendChild(input);
        });

        registrationsTableBody.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const docId = button.dataset.id;
            if (!docId) return;

            if (button.classList.contains('delete-btn')) {
                showConfirm(translations[currentLanguage].confirmMessage, async () => {
                    try {
                        await deleteDoc(doc(registrationsCollection, docId));
                        showNotification('Registration deleted.');
                    } catch (error) {
                        showNotification('Failed to delete registration.', 'error');
                    }
                });
            }

            if (button.classList.contains('edit-btn')) {
                const player = allPlayers.find(p => p.id === docId);
                if (player) {
                    document.getElementById('editDocId').value = player.id;
                    document.getElementById('editPlayerName').value = player.playerName;
                    document.getElementById('editTotalPower').value = player.totalPower;
                    editSeatColorSelect.value = player.seatColor;
                    editSeatColorDisplay.textContent = translations[currentLanguage][`option${player.seatColor}`] || player.seatColor;
                    editModal.style.display = 'flex';
                }
            }
        });
        
        document.getElementById('cancelEdit').addEventListener('click', () => editModal.style.display = 'none');
        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const docId = document.getElementById('editDocId').value;
            const updatedData = {
                playerName: document.getElementById('editPlayerName').value,
                totalPower: Number(document.getElementById('editTotalPower').value),
                seatColor: document.getElementById('editSeatColor').value
            };
            try {
                await updateDoc(doc(registrationsCollection, docId), updatedData);
                showNotification('Registration updated successfully.');
                editModal.style.display = 'none';
            } catch (error) {
                showNotification('Failed to update registration.', 'error');
            }
        });

        document.getElementById('saveWebhooksBtn').addEventListener('click', async () => {
            const webhooks = {
                url1: document.getElementById('webhook1').value,
                url2: document.getElementById('webhook2').value,
                url3: document.getElementById('webhook3').value,
            };
            try {
                await setDoc(configDoc, { webhooks });
                showNotification('Webhooks saved!');
            } catch (error) {
                showNotification('Failed to save webhooks.', 'error');
            }
        });
        
        const loadWebhooks = async () => {
            if (loginState !== 'super_admin') return;
            try {
                const docSnap = await getDoc(configDoc);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.webhooks) {
                        document.getElementById('webhook1').value = data.webhooks.url1 || '';
                        document.getElementById('webhook2').value = data.webhooks.url2 || '';
                        document.getElementById('webhook3').value = data.webhooks.url3 || '';
                    }
                }
            } catch (error) {
                console.error('Error loading webhooks:', error);
            }
        };

        const sendDiscordNotification = async (data) => {
            try {
                const docSnap = await getDoc(configDoc);
                if (!docSnap.exists()) return;
                const webhooks = docSnap.data().webhooks;
                if (!webhooks) return;
                const otherPlayersText = data.otherPlayers.length > 0 ? data.otherPlayers.join(', ') : 'None';
                const alliancePrefText = data.alliancePreference === 'yes' ? `Yes (${data.preferredAlliance})` : 'No';
                const embed = {
                    title: 'New Transfer Registration',
                    color: 0xdc2626, // Red-600
                    fields: [
                        { name: 'Player Name', value: data.playerName, inline: true },
                        { name: 'Total Power', value: formatPower(data.totalPower), inline: true },
                        { name: 'Seat Color', value: data.seatColor, inline: true },
                        { name: 'Current Server', value: data.currentServer, inline: true },
                        { name: 'Current Alliance', value: data.currentAlliance, inline: true },
                        { name: 'Alliance Preference', value: alliancePrefText, inline: true },
                        { name: 'Tank Power', value: formatPower(data.tankPower), inline: true },
                        { name: 'Air Power', value: formatPower(data.airPower), inline: true },
                        { name: 'Missile Power', value: formatPower(data.missilePower), inline: true },
                        { name: 'Language', value: data.language.toUpperCase(), inline: true},
                        { name: 'Other Players', value: otherPlayersText, inline: false },
                    ],
                    timestamp: new Date().toISOString(),
                    footer: { text: '899 Transfers Bot' }
                };
                const payload = { embeds: [embed] };
                Object.values(webhooks).forEach(url => {
                    if (url) {
                        fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        }).catch(err => console.error(`Failed to send to webhook ${url}:`, err));
                    }
                });
            } catch (error) {
                console.error('Failed to send Discord notification:', error);
            }
        };
        
        // Custom Select Logic
        seatColorSelect.addEventListener('change', (e) => {
            seatColorDisplay.textContent = e.target.options[e.target.selectedIndex].text;
        });
        editSeatColorSelect.addEventListener('change', (e) => {
            editSeatColorDisplay.textContent = e.target.options[e.target.selectedIndex].text;
        });
        languageSelector.addEventListener('change', (e) => {
            const selectedLang = e.target.value;
            languageDisplay.innerHTML = `<i class="fas fa-language mr-2"></i> ${e.target.options[e.target.selectedIndex].text}`;
            translatePage(selectedLang);
        });


        // --- Initial Load ---
        switchView('register');
        updateUIForLoginState();
        translatePage('en');
    </script>
    
    <!--
    Firestore Security Rules v2
    rules_version = '2';
    service cloud.firestore {
      match /databases/{database}/documents {
        match /artifacts/{appId}/public/data/{document=**} {
          allow read: if true;
          allow write: if request.auth != null;
        }
        match /artifacts/{appId}/users/{userId}/{document=**} {
          allow read, write: if request.auth != null && request.auth.uid == userId;
        }
      }
    }
    -->
</body>
</html>
