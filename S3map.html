<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S3 Interactive Map</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Set base font size to scale the entire UI down */
        html {
            font-size: 75%;
        }
        body {
            overscroll-behavior: none;
            cursor: default;
            font-family: 'Inter', sans-serif;
            background-color: #000000;
        }
        .plot {
            cursor: pointer;
            overflow: hidden;
            line-height: 1.2;
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out, border-color 0.2s ease-out, background-color 0.2s ease-out, background-image 0.2s ease-out;
            border-width: 3px;
        }
        .plot:hover {
             transform: scale(1.05);
        }
        #tooltip {
            pointer-events: none;
            transition: opacity 0.1s ease-in-out;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        #alliance-modal .modal-content, #code-modal .modal-content, #confirm-modal .modal-content {
             backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
             border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .hover-glow:hover {
            box-shadow: inset 0 0 25px 8px var(--glow-color, rgba(190, 220, 255, 0.25));
        }
        /* Styles for sidebar, dock, and stats */
        #sidebar {
            position: fixed;
            right: 0;
            top: 0;
            height: 100%;
            width: 210px; /* Scaled down from 280px */
            background-color: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            z-index: 100;
            transform: translateX(0);
            transition: transform 0.3s ease-in-out;
        }
        #sidebar.collapsed {
            transform: translateX(100%);
        }
        #action-dock {
            position: fixed;
            top: 50%;
            right: 210px; /* Scaled down from 280px */
            transform: translateY(-50%);
            z-index: 101;
            display: flex;
            flex-direction: column;
            gap: 6px; /* Scaled down from 8px */
            transition: right 0.3s ease-in-out;
        }
        #sidebar.collapsed ~ #action-dock {
            right: 0px; /* Move to edge when collapsed */
        }
        .action-button {
            width: 24px;  /* Scaled down from 32px */
            height: 36px; /* Scaled down from 48px */
            background-color: rgba(31, 41, 55, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-right: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #d1d5db;
        }
        #sidebar-toggle {
             border-radius: 6px 0 0 6px; /* Scaled down */
        }
        .action-button:hover {
            background-color: rgba(55, 65, 81, 0.8);
        }
        #sidebar-toggle .fa-solid {
            transition: transform 0.3s ease-in-out;
        }
        #sidebar.collapsed ~ #action-dock #sidebar-toggle .fa-solid {
            transform: rotate(180deg);
        }
        #alliance-summary {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        #button-dock {
            padding: 0.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        .dock-button {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: 0.75rem;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: #e5e7eb;
            transition: background-color 0.2s;
        }
        .dock-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .dock-button .fa-solid {
            margin-right: 0.75rem;
        }
        .form-switch .form-check-input {
            cursor: pointer;
        }
        .summary-item {
            margin-bottom: 1rem;
            padding: 1rem;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
        }
        .summary-item h5 {
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        .summary-item p {
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
        }
        /* Gradients for city buffs (used by toggle) */
        .gradient-iron { background-image: linear-gradient(to bottom right, #9ca3af, #4b5563); }
        .gradient-gold { background-image: linear-gradient(to bottom right, #facc15, #ca8a04); }
        .gradient-food { background-image: linear-gradient(to bottom right, #a16207, #422006); }
    </style>
</head>
<body class="text-white overflow-hidden">

    <div id="app" class="w-screen h-screen"></div>

    <div id="sidebar" class="collapsed">
        <div id="alliance-summary">
            <h4 class="text-lg font-bold border-b border-gray-700 pb-2 mb-4">Alliance Statistics</h4>
            <div id="stats-container"></div>
        </div>
        <div id="button-dock">
             <button class="dock-button">
                <span><i class="fa-solid fa-palette"></i>Show City Buffs</span>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="buff-toggle-switch">
                </div>
            </button>
            <button class="dock-button">
                <span><i class="fa-solid fa-layer-group"></i>Show City Levels</span>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="level-toggle-switch">
                </div>
            </button>
            <button class="dock-button">
                <span><i class="fa-solid fa-tag"></i>Show Land ID</span>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="id-toggle-switch">
                </div>
            </button>
        </div>
    </div>

    <div id="action-dock">
        <button id="sidebar-toggle" class="action-button" title="Toggle Sidebar">
            <i class="fa-solid fa-chevron-right"></i>
        </button>
        <button id="export-btn" class="action-button" title="Export Map Data">
            <i class="fa-solid fa-file-export"></i>
        </button>
        <button id="import-btn" class="action-button" title="Import Map Data">
            <i class="fa-solid fa-file-import"></i>
        </button>
        <button id="clear-btn" class="action-button" title="Clear All Assignments">
            <i class="fa-solid fa-trash"></i>
        </button>
    </div>

    <div id="tooltip" class="hidden absolute bg-black/50 text-white text-xs p-3 rounded-lg shadow-2xl opacity-0 z-50">
        <h4 id="tooltip-title" class="font-bold text-sm text-sky-300"></h4>
        <p><span class="font-semibold opacity-80">Level:</span> <span id="tooltip-level"></span></p>
        <p><span class="font-semibold opacity-80">Buff:</span> <span id="tooltip-buff"></span></p>
    </div>

    <div id="alliance-modal" class="hidden fixed inset-0 bg-black/60 flex justify-center items-center z-50">
        <div class="modal-content bg-gray-900/50 p-6 rounded-2xl shadow-2xl w-full max-w-sm text-center text-white">
            <h3 id="modal-title" class="font-bold text-xl mb-1 text-sky-300"></h3>
            <p id="modal-plot-id" class="text-xs text-slate-400"></p>
            <div id="modal-details" class="my-4 text-left bg-black/50 p-4 rounded-lg">
                 <p><span class="font-semibold opacity-80">Level:</span> <span id="modal-level" class="font-bold"></span></p>
                 <p><span class="font-semibold opacity-80">Buff:</span> <span id="modal-buff" class="font-bold"></span></p>
            </div>
            <div id="modal-buttons" class="grid grid-cols-2 gap-3"></div>
            <button id="modal-clear-btn" class="w-full mt-4 bg-gray-700 text-slate-200 p-2 rounded-lg font-semibold hover:bg-gray-600 transition-colors">
                Clear Alliance
            </button>
            <button id="modal-close-btn" class="w-full mt-2 text-sm text-slate-400 hover:text-white transition-colors">
                Close
            </button>
        </div>
    </div>
    
    <div id="code-modal" class="hidden fixed inset-0 bg-black/60 flex justify-center items-center z-50">
        <div class="modal-content bg-gray-900/50 p-6 rounded-2xl shadow-2xl w-full max-w-lg text-white">
            <h3 id="code-modal-title" class="font-bold text-xl mb-4"></h3>
            <textarea id="code-modal-textarea" class="w-full h-40 bg-gray-800 text-white p-2 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-sky-500"></textarea>
            <div class="flex justify-end gap-4 mt-4">
                <button id="code-modal-action-btn" class="bg-sky-600 hover:bg-sky-500 text-white font-bold py-2 px-4 rounded-lg"></button>
                <button id="code-modal-close-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Close</button>
            </div>
        </div>
    </div>
    
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black/60 flex justify-center items-center z-50">
        <div class="modal-content bg-gray-900/50 p-6 rounded-2xl shadow-2xl w-full max-w-sm text-white">
            <h3 id="confirm-modal-title" class="font-bold text-xl mb-4">Are you sure?</h3>
            <p id="confirm-modal-body" class="mb-6">This action cannot be undone.</p>
            <div class="flex justify-end gap-4">
                <button id="confirm-modal-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="confirm-modal-confirm-btn" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg">Confirm</button>
            </div>
        </div>
    </div>


    <script type="module">
        // --- CONFIGURATION ---
        const alliances = {
            THOR: { name: 'THOR', color: 'bg-blue-600', textColor: 'text-white', hover: 'hover-glow' },
            fafo: { name: 'fafo', color: 'bg-red-600', textColor: 'text-white', hover: 'hover-glow' },
            HERA: { name: 'HERA', color: 'bg-yellow-400', textColor: 'text-slate-900', hover: 'hover-glow' },
            pHNx: { name: 'pHNx', color: 'bg-purple-600', textColor: 'text-white', hover: 'hover-glow' },
        };
        const landLimits = {
            Stronghold: 4,
            City: 6
        };
        const cityLevelBorders = {
            1: 'border-purple-500', 2: 'border-blue-500', 3: 'border-green-500',
            4: 'border-yellow-500', 5: 'border-orange-500', 6: 'border-red-500',
            7: 'border-pink-500' 
        };
        const defaultMainPlotClasses = { base: 'bg-gray-900/50 border-gray-800', hover: 'hover-glow' }; // Darkened border
        const defaultCornerPlotClasses = { base: 'bg-gray-800', hover: 'hover-glow' };

        // Scaled down map dimensions
        const rows = 13, cols = 13, cellWidth = 75, cellHeight = 60, cornerPlotSizeRatio = 0.67; 
        
        const externalDataCSV = `ID,Name,Type,Buff%,BuffType
SA01,Stronghold,Stronghold,1%,Iron
SA02,Stronghold,Stronghold,1%,Iron
SA03,Stronghold,Stronghold,1%,Iron
SA04,Stronghold,Stronghold,1%,Iron
SA05,Stronghold,Stronghold,1%,Iron
SA06,Stronghold,Stronghold,1%,Iron
SA07,Stronghold,Stronghold,1%,Iron
SA08,Stronghold,Stronghold,1%,Iron
SA09,Stronghold,Stronghold,1%,Iron
SA10,Stronghold,Stronghold,1%,Iron
SA11,Stronghold,Stronghold,1%,Iron
SA12,Stronghold,Stronghold,1%,Iron
SA13,Stronghold,Stronghold,1%,Iron
CA01,City,Trade Post,NA,NA
CA02,City,Village,7.5%,Food
CA03,City,Village,7.5%,Iron
CA04,City,Village,7.5%,Food
CA05,City,Village,7.5%,Iron
CA06,City,Village,7.5%,Food
CA07,City,Village,7.5%,Food
CA08,City,Village,7.5%,Iron
CA09,City,Village,7.5%,Food
CA10,City,Village,7.5%,Iron
CA11,City,Village,7.5%,Food
CA12,City,Trade Post,NA,NA
SB01,Stronghold,Stronghold,1%,Iron
SB02,Stronghold,Stronghold,2%,Iron
SB03,Stronghold,Stronghold,2%,Iron
SB04,Stronghold,Stronghold,2%,Iron
SB05,Stronghold,Stronghold,2%,Iron
SB06,Stronghold,Stronghold,2%,Iron
SB07,Stronghold,Stronghold,2%,Iron
SB08,Stronghold,Stronghold,2%,Iron
SB09,Stronghold,Stronghold,2%,Iron
SB10,Stronghold,Stronghold,2%,Iron
SB11,Stronghold,Stronghold,2%,Iron
SB12,Stronghold,Stronghold,2%,Iron
SB13,Stronghold,Stronghold,1%,Iron
CB01,City,Village,7.5%,Iron
CB02,City,Trade Post,NA,NA
CB03,City,Altar,7.5%,Coin
CB04,City,Altar,7.5%,Gathering Speed
CB05,City,Altar,7.5%,Coin
CB06,City,Altar,7.5%,Gathering Speed
CB07,City,Altar,7.5%,Coin
CB08,City,Altar,7.5%,Gathering Speed
CB09,City,Altar,7.5%,Coin
CB10,City,Altar,7.5%,Gathering Speed
CB11,City,Trade Post,NA,NA
CB12,City,Village,7.5%,Iron
SC01,Stronghold,Stronghold,1%,Iron
SC02,Stronghold,Stronghold,2%,Iron
SC03,Stronghold,Stronghold,3%,Iron
SC04,Stronghold,Stronghold,3%,Iron
SC05,Stronghold,Stronghold,3%,Iron
SC06,Stronghold,Stronghold,3%,Iron
SC07,Stronghold,Stronghold,3%,Iron
SC08,Stronghold,Stronghold,3%,Iron
SC09,Stronghold,Stronghold,3%,Iron
SC10,Stronghold,Stronghold,3%,Iron
SC11,Stronghold,Stronghold,3%,Iron
SC12,Stronghold,Stronghold,2%,Iron
SC13,Stronghold,Stronghold,1%,Iron
CC01,City,Village,7.5%,Food
CC02,City,Altar,7.5%,Gathering Speed
CC03,City,Trade Post,NA,NA
CC04,City,Town,15%,Food
CC05,City,Town,15%,Iron
CC06,City,Town,15%,Food
CC07,City,Town,15%,Food
CC08,City,Town,15%,Iron
CC09,City,Town,15%,Food
CC10,City,Trade Post,NA,NA
CC11,City,Altar,7.5%,Gathering Speed
CC12,City,Village,7.5%,Food
SD01,Stronghold,Stronghold,1%,Iron
SD02,Stronghold,Stronghold,2%,Iron
SD03,Stronghold,Stronghold,3%,Iron
SD04,Stronghold,Stronghold,4%,Iron
SD05,Stronghold,Stronghold,4%,Iron
SD06,Stronghold,Stronghold,4%,Iron
SD07,Stronghold,Stronghold,4%,Iron
SD08,Stronghold,Stronghold,4%,Iron
SD09,Stronghold,Stronghold,4%,Iron
SD10,Stronghold,Stronghold,4%,Iron
SD11,Stronghold,Stronghold,3%,Iron
SD12,Stronghold,Stronghold,2%,Iron
SD13,Stronghold,Stronghold,1%,Iron
CD01,City,Village,7.5%,Iron
CD02,City,Altar,7.5%,Coin
CD03,City,Town,15%,Iron
CD04,City,Trade Post,NA,NA
CD05,City,Temple of the Sun,15%,Coin
CD06,City,Temple of the Sun,15%,Gathering Speed
CD07,City,Temple of the Sun,15%,Coin
CD08,City,Temple of the Sun,15%,Gathering Speed
CD09,City,Trade Post,NA,NA
CD10,City,Town,15%,Iron
CD11,City,Altar,7.5%,Coin
CD12,City,Village,7.5%,Iron
SE01,Stronghold,Stronghold,1%,Iron
SE02,Stronghold,Stronghold,2%,Iron
SE03,Stronghold,Stronghold,3%,Iron
SE04,Stronghold,Stronghold,4%,Iron
SE05,Stronghold,Stronghold,5%,Iron
SE06,Stronghold,Stronghold,5%,Iron
SE07,Stronghold,Stronghold,5%,Iron
SE08,Stronghold,Stronghold,5%,Iron
SE09,Stronghold,Stronghold,5%,Iron
SE10,Stronghold,Stronghold,4%,Iron
SE11,Stronghold,Stronghold,3%,Iron
SE12,Stronghold,Stronghold,2%,Iron
SE13,Stronghold,Stronghold,1%,Iron
CE01,City,Village,7.5%,Food
CE02,City,Altar,7.5%,Gathering Speed
CE03,City,Town,15%,Food
CE04,City,Temple of the Sun,15%,Gathering Speed
CE05,City,Trade Post,NA,NA
CE06,City,Ancient Tombs,25%,Food
CE07,City,Ancient Tombs,25%,Food
CE08,City,Trade Post,NA,NA
CE09,City,Temple of the Sun,15%,Gathering Speed
CE10,City,Town,15%,Food
CE11,City,Altar,7.5%,Gathering Speed
CE12,City,Village,7.5%,Food
SF01,Stronghold,Stronghold,1%,Iron
SF02,Stronghold,Stronghold,2%,Iron
SF03,Stronghold,Stronghold,3%,Iron
SF04,Stronghold,Stronghold,4%,Iron
SF05,Stronghold,Stronghold,5%,Iron
SF06,Stronghold,Stronghold,6%,Iron
SF07,Stronghold,Stronghold,6%,Iron
SF08,Stronghold,Stronghold,6%,Iron
SF09,Stronghold,Stronghold,5%,Iron
SF10,Stronghold,Stronghold,4%,Iron
SF11,Stronghold,Stronghold,3%,Iron
SF12,Stronghold,Stronghold,2%,Iron
SF13,Stronghold,Stronghold,1%,Iron
CF01,City,Village,7.5%,Iron
CF02,City,Altar,7.5%,Coin
CF03,City,Town,15%,Iron
CF04,City,Temple of the Sun,15%,Coin
CF05,City,Ancient Tombs,25%,Iron
CF06,City,Square of Judgment,20%,Construction
CF07,City,Square of Judgment,10%,Healing
CF08,City,Ancient Tombs,25%,Iron
CF09,City,Temple of the Sun,15%,Coin
CF10,City,Town,15%,Iron
CF11,City,Altar,7.5%,Coin
CF12,City,Village,7.5%,Iron
SG01,Stronghold,Stronghold,1%,Iron
SG02,Stronghold,Stronghold,2%,Iron
SG03,Stronghold,Stronghold,4%,Iron
SG04,Stronghold,Stronghold,8%,Iron
SG05,Stronghold,Stronghold,16%,Iron
SG06,Stronghold,Stronghold,16%,Realm
SG07,Stronghold,Great Pyramid,10%,March
SG08,Stronghold,Stronghold,16%,Realm
SG09,Stronghold,Stronghold,16%,Iron
SG10,Stronghold,Stronghold,8%,Iron
SG11,Stronghold,Stronghold,4%,Iron
SG12,Stronghold,Stronghold,2%,Iron
SG13,Stronghold,Stronghold,1%,Iron
CG01,City,Village,7.5%,Food
CG02,City,Altar,7.5%,Gathering Speed
CG03,City,Town,15%,Food
CG04,City,Temple of the Sun,15%,Gathering Speed
CG05,City,Ancient Tombs,25%,Food
CG06,City,Square of Judgment,20%,Research
CG07,City,Square of Judgment,5%,Training
CG08,City,Ancient Tombs,25%,Food
CG09,City,Temple of the Sun,15%,Gathering Speed
CG10,City,Town,15%,Food
CG11,City,Altar,7.5%,Coin
CG12,City,Village,7.5%,Food
SH01,Stronghold,Stronghold,1%,Iron
SH02,Stronghold,Stronghold,2%,Iron
SH03,Stronghold,Stronghold,4%,Iron
SH04,Stronghold,Stronghold,8%,Iron
SH05,Stronghold,Stronghold,16%,Iron
SH06,Stronghold,Stronghold,16%,Iron
SH07,Stronghold,Stronghold,16%,Iron
SH08,Stronghold,Stronghold,16%,Iron
SH09,Stronghold,Stronghold,16%,Iron
SH10,Stronghold,Stronghold,8%,Iron
SH11,Stronghold,Stronghold,4%,Iron
SH12,Stronghold,Stronghold,2%,Iron
SH13,Stronghold,Stronghold,1%,Iron
CH01,City,Village,7.5%,Iron
CH02,City,Altar,7.5%,Coin
CH03,City,Town,15%,Iron
CH04,City,Temple of the Sun,15%,Coin
CH05,City,Trade Post,NA,NA
CH06,City,Ancient Tombs,25%,Iron
CH07,City,Ancient Tombs,25%,Iron
CH08,City,Trade Post,NA,NA
CH09,City,Temple of the Sun,15%,Coin
CH10,City,Town,15%,Iron
CH11,City,Altar,7.5%,Gathering Speed
CH12,City,Village,7.5%,Iron
SI01,Stronghold,Stronghold,1%,Iron
SI02,Stronghold,Stronghold,2%,Iron
SI03,Stronghold,Stronghold,4%,Iron
SI04,Stronghold,Stronghold,8%,Iron
SI05,Stronghold,Stronghold,8%,Iron
SI06,Stronghold,Stronghold,8%,Iron
SI07,Stronghold,Stronghold,8%,Iron
SI08,Stronghold,Stronghold,8%,Iron
SI09,Stronghold,Stronghold,8%,Iron
SI10,Stronghold,Stronghold,8%,Iron
SI11,Stronghold,Stronghold,4%,Iron
SI12,Stronghold,Stronghold,2%,Iron
SI13,Stronghold,Stronghold,1%,Iron
CI01,City,Village,7.5%,Food
CI02,City,Altar,7.5%,Gathering Speed
CI03,City,Town,15%,Food
CI04,City,Trade Post,NA,NA
CI05,City,Temple of the Sun,15%,Coin
CI06,City,Temple of the Sun,15%,Gathering Speed
CI07,City,Temple of the Sun,15%,Coin
CI08,City,Temple of the Sun,15%,Gathering Speed
CI09,City,Trade Post,NA,NA
CI10,City,Town,15%,Food
CI11,City,Altar,7.5%,Coin
CI12,City,Village,7.5%,Food
SJ01,Stronghold,Stronghold,1%,Iron
SJ02,Stronghold,Stronghold,2%,Iron
SJ03,Stronghold,Stronghold,3%,Iron
SJ04,Stronghold,Stronghold,4%,Iron
SJ05,Stronghold,Stronghold,4%,Iron
SJ06,Stronghold,Stronghold,4%,Iron
SJ07,Stronghold,Stronghold,4%,Iron
SJ08,Stronghold,Stronghold,4%,Iron
SJ09,Stronghold,Stronghold,4%,Iron
SJ10,Stronghold,Stronghold,4%,Iron
SJ11,Stronghold,Stronghold,3%,Iron
SJ12,Stronghold,Stronghold,2%,Iron
SJ13,Stronghold,Stronghold,1%,Iron
CJ01,City,Village,7.5%,Iron
CJ02,City,Altar,7.5%,Coin
CJ03,City,Trade Post,NA,NA
CJ04,City,Town,15%,Iron
CJ05,City,Town,15%,Food
CJ06,City,Town,15%,Iron
CJ07,City,Town,15%,Iron
CJ08,City,Town,15%,Food
CJ09,City,Town,15%,Iron
CJ10,City,Trade Post,NA,NA
CJ11,City,Altar,7.5%,Gathering Speed
CJ12,City,Village,7.5%,Iron
SK01,Stronghold,Stronghold,1%,Iron
SK02,Stronghold,Stronghold,2%,Iron
SK03,Stronghold,Stronghold,3%,Iron
SK04,Stronghold,Stronghold,3%,Iron
SK05,Stronghold,Stronghold,3%,Iron
SK06,Stronghold,Stronghold,3%,Iron
SK07,Stronghold,Stronghold,3%,Iron
SK08,Stronghold,Stronghold,3%,Iron
SK09,Stronghold,Stronghold,3%,Iron
SK10,Stronghold,Stronghold,3%,Iron
SK11,Stronghold,Stronghold,3%,Iron
SK12,Stronghold,Stronghold,2%,Iron
SK13,Stronghold,Stronghold,1%,Iron
CK01,City,Village,7.5%,Food
CK02,City,Trade Post,NA,NA
CK03,City,Altar,7.5%,Coin
CK04,City,Altar,7.5%,Gathering Speed
CK05,City,Altar,7.5%,Coin
CK06,City,Altar,7.5%,Gathering Speed
CK07,City,Altar,7.5%,Coin
CK08,City,Altar,7.5%,Gathering Speed
CK09,City,Altar,7.5%,Coin
CK10,City,Altar,7.5%,Gathering Speed
CK11,City,Trade Post,NA,NA
CK12,City,Village,7.5%,Food
SL01,Stronghold,Stronghold,1%,Iron
SL02,Stronghold,Stronghold,2%,Iron
SL03,Stronghold,Stronghold,2%,Iron
SL04,Stronghold,Stronghold,2%,Iron
SL05,Stronghold,Stronghold,2%,Iron
SL06,Stronghold,Stronghold,2%,Iron
SL07,Stronghold,Stronghold,2%,Iron
SL08,Stronghold,Stronghold,2%,Iron
SL09,Stronghold,Stronghold,2%,Iron
SL10,Stronghold,Stronghold,2%,Iron
SL11,Stronghold,Stronghold,2%,Iron
SL12,Stronghold,Stronghold,2%,Iron
SL13,Stronghold,Stronghold,1%,Iron
CL01,City,Trade Post,NA,NA
CL02,City,Village,7.5%,Iron
CL03,City,Village,7.5%,Food
CL04,City,Village,7.5%,Iron
CL05,City,Village,7.5%,Food
CL06,City,Village,7.5%,Iron
CL07,City,Village,7.5%,Iron
CL08,City,Village,7.5%,Food
CL09,City,Village,7.5%,Iron
CL10,City,Village,7.5%,Food
CL11,City,Village,7.5%,Iron
CL12,City,Trade Post,NA,NA
SM01,Stronghold,Stronghold,1%,Iron
SM02,Stronghold,Stronghold,1%,Iron
SM03,Stronghold,Stronghold,1%,Iron
SM04,Stronghold,Stronghold,1%,Iron
SM05,Stronghold,Stronghold,1%,Iron
SM06,Stronghold,Stronghold,1%,Iron
SM07,Stronghold,Stronghold,1%,Iron
SM08,Stronghold,Stronghold,1%,Iron
SM09,Stronghold,Stronghold,1%,Iron
SM10,Stronghold,Stronghold,1%,Iron
SM11,Stronghold,Stronghold,1%,Iron
SM12,Stronghold,Stronghold,1%,Iron
SM13,Stronghold,Stronghold,1%,Iron`;

        // --- STATE & REFERENCES ---
        let view = { x: 0, y: 0, zoom: 1 };
        let plotData = {}; 
        let selectedCell = null;
        let hoveredCell = null;
        const plotElements = new Map();
        const dragInfo = { isDragging: false, startX: 0, startY: 0, viewStartX: 0, viewStartY: 0 };
        let hideTooltipTimer; 
        let showCityBuffs = false;
        let showCityLevels = false; // Disabled by default
        let showLandIds = false; // Disabled by default

        // --- DOM REFERENCES ---
        const app = document.getElementById('app');
        const tooltip = document.getElementById('tooltip'), tooltipTitle = document.getElementById('tooltip-title'), tooltipLevel = document.getElementById('tooltip-level'), tooltipBuff = document.getElementById('tooltip-buff');
        const allianceModal = document.getElementById('alliance-modal'), modalTitle = document.getElementById('modal-title'), modalPlotId = document.getElementById('modal-plot-id'), modalDetails = document.getElementById('modal-details'), modalLevel = document.getElementById('modal-level'), modalBuffModal = document.querySelector('#modal-details #modal-buff'), modalButtons = document.getElementById('modal-buttons'), modalClearBtn = document.getElementById('modal-clear-btn'), modalCloseBtn = document.getElementById('modal-close-btn');
        const codeModal = document.getElementById('code-modal'), codeModalTitle = document.getElementById('code-modal-title'), codeModalTextarea = document.getElementById('code-modal-textarea'), codeModalActionButton = document.getElementById('code-modal-action-btn'), codeModalCloseButton = document.getElementById('code-modal-close-btn');
        const confirmModal = document.getElementById('confirm-modal'), confirmModalTitle = document.getElementById('confirm-modal-title'), confirmModalBody = document.getElementById('confirm-modal-body'), confirmModalConfirmBtn = document.getElementById('confirm-modal-confirm-btn'), confirmModalCancelBtn = document.getElementById('confirm-modal-cancel-btn');
        let transformWrapper;
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const statsContainer = document.getElementById('stats-container');
        const buffToggleSwitch = document.getElementById('buff-toggle-switch');
        const levelToggleSwitch = document.getElementById('level-toggle-switch');
        const idToggleSwitch = document.getElementById('id-toggle-switch');
        const exportBtn = document.getElementById('export-btn');
        const importBtn = document.getElementById('import-btn');
        const clearBtn = document.getElementById('clear-btn');

        // --- DATA & LEVEL CALCULATION ---
        function calculatePlotData() {
            const externalData = new Map(
                externalDataCSV.trim().split('\n').slice(1).map(line => {
                    const [ID, Name, Type, BuffPercent, BuffType] = line.split(',');
                    return [ID, { Name, Type, Buff: `${BuffPercent} ${BuffType}` }];
                })
            );

            for (let i = 0; i < rows; i++) {
                for (let j = 0; j < cols; j++) {
                    const key = `${j + 1},${i + 1}`;
                    const customId = `S${String.fromCharCode(65 + i)}${(j + 1).toString().padStart(2, '0')}`;
                    const data = externalData.get(customId) || {};
                    const level = Math.min(i, rows - 1 - i, j, cols - 1 - j) + 1;
                    plotData[key] = { type: 'Stronghold', name: 'Stronghold', level: level, buff: data.Buff, alliance: null, customId: customId };
                }
            }
            const cornerRows = rows - 1, cornerCols = cols - 1;
            for (let i = 0; i < cornerRows; i++) {
                for (let j = 0; j < cornerCols; j++) {
                    const key = `C(${j + 1.5},${i + 1.5})`;
                    const customId = `C${String.fromCharCode(65 + i)}${(j + 1).toString().padStart(2, '0')}`;
                    const data = externalData.get(customId) || {};
                    const level = Math.min(i, cornerRows - 1 - i, j, cornerCols - 1 - j) + 1;
                    plotData[key] = { type: 'City', name: data.Type || 'City', level: level, buff: data.Buff, alliance: null, customId: customId };
                }
            }
        }
        
        // --- EFFICIENT UPDATE FUNCTIONS ---
        function getPlotCounts() {
            const counts = {};
            for (const allyName in alliances) {
                counts[allyName] = { Stronghold: 0, City: 0 };
            }
            for (const key in plotData) {
                const plot = plotData[key];
                if (plot.alliance && counts[plot.alliance]) {
                    counts[plot.alliance][plot.type]++;
                }
            }
            return counts;
        }

        function updateElementStyle(key) {
            const el = plotElements.get(key);
            if (!el) return;

            const data = plotData[key] || {};
            const allianceName = data.alliance;
            const allianceInfo = allianceName ? alliances[allianceName] : null;
            
            const allClassesToRemove = [
                ...Object.values(alliances).flatMap(a => [a.color, a.textColor]),
                ...Object.values(cityLevelBorders),
                defaultMainPlotClasses.base,
                defaultCornerPlotClasses.base,
                'border-white', // Add new class to removal list
                'border-gray-500', 
                'gradient-iron', 'gradient-gold', 'gradient-food'
            ].flatMap(c => c.split(' '));

            el.classList.remove(...allClassesToRemove);

            if (data.type === 'Stronghold') {
                 if (allianceInfo) {
                    el.classList.add(allianceInfo.color, allianceInfo.textColor);
                 } else {
                    el.classList.add(...defaultMainPlotClasses.base.split(' '));
                 }
            } else if (data.type === 'City') {
                if(showCityLevels) {
                    const levelBorder = cityLevelBorders[data.level] || 'border-gray-600';
                    el.classList.add(levelBorder);
                } else {
                    if (data.name === 'Trade Post') {
                        el.classList.add('border-white');
                    } else {
                        el.classList.add('border-gray-500');
                    }
                }

                if (allianceInfo) {
                    el.classList.add(allianceInfo.color, allianceInfo.textColor);
                } else {
                    if (showCityBuffs) {
                        if (data.buff?.includes('Iron')) el.classList.add('gradient-iron');
                        else if (data.buff?.includes('Coin')) el.classList.add('gradient-gold');
                        else if (data.buff?.includes('Food')) el.classList.add('gradient-food');
                        else el.classList.add(defaultCornerPlotClasses.base);
                    } else {
                        el.classList.add(defaultCornerPlotClasses.base);
                    }
                }
            }
        }

        function updateAllStyles() {
            plotElements.forEach((el, key) => updateElementStyle(key));
        }

        function updateIdVisibility() {
            const idElements = document.querySelectorAll('.plot-id-label');
            idElements.forEach(el => {
                if (showLandIds) {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            });
        }
        
        function updateAllianceStats() {
            const stats = {};
            for (const allyName in alliances) {
                stats[allyName] = { Stronghold: 0, City: 0, buffs: {} };
            }

            for (const key in plotData) {
                const plot = plotData[key];
                if (plot.alliance && stats[plot.alliance]) {
                    stats[plot.alliance][plot.type]++;
                    if (plot.buff && plot.buff !== 'NA NA') {
                        const buffParts = plot.buff.split(' ');
                        const value = parseFloat(buffParts[0]);
                        const type = buffParts.slice(1).join(' ');
                        if (!isNaN(value)) {
                            stats[plot.alliance].buffs[type] = (stats[plot.alliance].buffs[type] || 0) + value;
                        }
                    }
                }
            }

            statsContainer.innerHTML = '';
            for (const allyName in stats) {
                const allyData = stats[allyName];
                const allyInfo = alliances[allyName];
                
                if (allyData.Stronghold === 0 && allyData.City === 0) continue;

                let buffHTML = '';
                for (const buffType in allyData.buffs) {
                    buffHTML += `<p class="opacity-80"><strong>${buffType}:</strong> ${allyData.buffs[buffType].toFixed(1)}%</p>`;
                }

                const summaryHTML = `
                    <div class="summary-item">
                        <h5 class="${allyInfo.textColor} ${allyInfo.color} px-2 py-1 rounded-md">${allyName}</h5>
                        <p><strong>Strongholds:</strong> ${allyData.Stronghold} / ${landLimits.Stronghold}</p>
                        <p><strong>Cities:</strong> ${allyData.City} / ${landLimits.City}</p>
                        ${buffHTML}
                    </div>
                `;
                statsContainer.innerHTML += summaryHTML;
            }
        }

        function updateViewTransform() {
            if (transformWrapper) {
                transformWrapper.style.transform = `translate(${view.x}px, ${view.y}px) scale(${view.zoom})`;
            }
        }

        function initializeMap() {
            calculatePlotData();
            app.innerHTML = '';

            transformWrapper = document.createElement('div');
            transformWrapper.style.transformOrigin = '0 0';
            
            const totalWidth = cols * cellWidth;
            const totalHeight = rows * cellHeight;
            const mapBackground = document.createElement('div');
            mapBackground.className = 'rounded-lg';
            mapBackground.style.cssText = `position: absolute; width: ${totalWidth}px; height: ${totalHeight}px; background-image: radial-gradient(ellipse at center, #4b5563 0%, #111827 80%); z-index: 1;`;
            transformWrapper.appendChild(mapBackground);

            const mainPlotGrid = document.createElement('div');
            mainPlotGrid.className = 'relative grid z-10';
            mainPlotGrid.style.cssText = `display: grid; grid-template-columns: repeat(${cols}, ${cellWidth}px); grid-template-rows: repeat(${rows}, ${cellHeight}px);`;

            const cornerPlotContainer = document.createElement('div');
            cornerPlotContainer.className = 'absolute top-0 left-0 z-20';
            
            const createPlotHTML = (key) => {
                const data = plotData[key];
                if (!data) return '';
                if (data.type === 'Stronghold') {
                     return `<div class="relative w-full h-full"><span class="absolute top-1 left-1/2 -translate-x-1/2 font-semibold text-xs">${data.level || ''} SH</span><span class="plot-id-label absolute left-1/2 -translate-x-1/2 text-[8px] italic opacity-50" style="bottom: -3px;">${data.customId}</span></div>`;
                } else {
                    return `<div class="relative w-full h-full flex items-center justify-center"><span class="font-semibold text-center text-[8px] leading-none">${data.name}</span><span class="plot-id-label absolute left-1/2 -translate-x-1/2 text-[8px] italic opacity-50" style="bottom: -3px;">${data.customId}</span></div>`;
                }
            };
            
            for (let i = 0; i < rows; i++) {
                for (let j = 0; j < cols; j++) {
                    const key = `${j + 1},${i + 1}`;
                    const el = document.createElement('div');
                    let borderRadiusClass = '';
                    if (i === 0 && j === 0) borderRadiusClass = 'rounded-tl-lg';
                    else if (i === 0 && j === cols - 1) borderRadiusClass = 'rounded-tr-lg';
                    else if (i === rows - 1 && j === 0) borderRadiusClass = 'rounded-bl-lg';
                    else if (i === rows - 1 && j === cols - 1) borderRadiusClass = 'rounded-br-lg';
                    
                    el.className = `plot text-xs hover-glow ${borderRadiusClass}`;
                    el.style.cssText = `grid-column: ${j + 1}; grid-row: ${i + 1};`;
                    el.innerHTML = createPlotHTML(key);
                    el.addEventListener('mousedown', (e) => handleMouseDown(e, key));
                    el.addEventListener('mouseenter', (e) => handleMouseEnter(e, key));
                    el.addEventListener('mousemove', (e) => handleMouseMove(e));
                    el.addEventListener('mouseleave', () => handleMouseLeave());
                    plotElements.set(key, el);
                    mainPlotGrid.appendChild(el);
                }
            }
            
            const cornerRows = rows - 1;
            const cornerCols = cols - 1;
            for (let i = 0; i < cornerRows; i++) {
                for (let j = 0; j < cornerCols; j++) {
                    const key = `C(${j + 1.5},${i + 1.5})`;
                    const el = document.createElement('div');
                    el.className = 'plot absolute text-xs rounded-lg hover-glow';
                    el.style.cssText = `top: ${(i + 1) * cellHeight}px; left: ${(j + 1) * cellWidth}px; transform: translate(-50%, -50%); width: ${cellWidth * cornerPlotSizeRatio}px; height: ${cellHeight * cornerPlotSizeRatio}px;`;
                    el.innerHTML = createPlotHTML(key);
                    el.addEventListener('mousedown', (e) => handleMouseDown(e, key));
                    el.addEventListener('mouseenter', (e) => handleMouseEnter(e, key));
                    el.addEventListener('mousemove', (e) => handleMouseMove(e));
                    el.addEventListener('mouseleave', () => handleMouseLeave());
                    plotElements.set(key, el);
                    cornerPlotContainer.appendChild(el);
                }
            }
            transformWrapper.append(mainPlotGrid, cornerPlotContainer);
            app.appendChild(transformWrapper);
            updateAllStyles();
            updateViewTransform();
            updateAllianceStats();
            updateIdVisibility();
        }

        // --- EVENT HANDLERS ---
        function handleMouseEnter(e, key) {
            clearTimeout(hideTooltipTimer);
            if (dragInfo.isDragging) return;
            hoveredCell = key;
            const data = plotData[key] || {};
            const el = plotElements.get(key);
            if(el) {
                el.style.setProperty('--glow-color', 'rgba(190, 220, 255, 0.25)');
            }
            const tooltipBuffP = tooltipBuff.parentElement;
            if (data.name === 'Trade Post') {
                tooltipBuffP.classList.add('hidden');
            } else {
                tooltipBuffP.classList.remove('hidden');
                tooltipBuff.textContent = data.buff || "N/A";
            }
            tooltipTitle.textContent = `${data.name || "Plot"} (${data.customId || ""})`;
            tooltipLevel.textContent = data.level || "N/A";
            tooltip.classList.remove('hidden');
            tooltip.style.opacity = '1';
            handleMouseMove(e);
        }
        
        function handleMouseLeave() {
            hoveredCell = null;
            hideTooltipTimer = setTimeout(() => {
                tooltip.style.opacity = '0';
                setTimeout(() => tooltip.classList.add('hidden'), 100);
            }, 50);
        }

        function handleMouseDown(e, key = null) {
            e.stopPropagation(); e.preventDefault();
            Object.assign(dragInfo, { isDragging: false, startX: e.pageX, startY: e.pageY, viewStartX: view.x, viewStartY: view.y, clickedCell: key });
            document.addEventListener('mousemove', handleDragMove);
            document.addEventListener('mouseup', handleMouseUp);
            clearTimeout(hideTooltipTimer);
            tooltip.classList.add('hidden');
        }
        
        function handleMouseMove(e) {
            if(hoveredCell && !dragInfo.isDragging) {
                tooltip.style.left = `${e.pageX + 20}px`;
                tooltip.style.top = `${e.pageY + 20}px`;
            }
        }

        function handleDragMove(e) {
            e.preventDefault();
            if (!dragInfo.isDragging && (Math.abs(e.pageX - dragInfo.startX) > 5 || Math.abs(e.pageY - dragInfo.startY) > 5)) {
                dragInfo.isDragging = true;
                document.body.style.cursor = 'move';
            }
            if (dragInfo.isDragging) {
                view.x = dragInfo.viewStartX + (e.pageX - dragInfo.startX);
                view.y = dragInfo.viewStartY + (e.pageY - dragInfo.startY);
                updateViewTransform();
            }
        }

        function handleMouseUp() {
            document.body.style.cursor = 'default';
            if (!dragInfo.isDragging && dragInfo.clickedCell) {
                selectedCell = dragInfo.clickedCell;
                updateModal(allianceModal);
            }
            dragInfo.isDragging = false;
            document.removeEventListener('mousemove', handleDragMove);
            document.removeEventListener('mouseup', handleMouseUp);
        }

        function handleWheel(e) {
            const rect = app.getBoundingClientRect();
            const x = (e.clientX - rect.left - view.x) / view.zoom;
            const y = (e.clientY - rect.top - view.y) / view.zoom;
            const delta = -e.deltaY * 0.001;
            const newZoom = Math.max(0.5, Math.min(view.zoom + delta, 3));
            view.x -= x * (newZoom - view.zoom);
            view.y -= y * (newZoom - view.zoom);
            view.zoom = newZoom;
            updateViewTransform();
        }

        function updateModal(modalToUpdate) {
            if (selectedCell && modalToUpdate === allianceModal) {
                const data = plotData[selectedCell] || {};
                const plotCounts = getPlotCounts();

                const buffParentModal = modalBuffModal.parentElement;
                if (data.name === 'Trade Post') {
                    buffParentModal.classList.add('hidden');
                } else {
                    buffParentModal.classList.remove('hidden');
                    modalBuffModal.textContent = data.buff || 'N/A';
                }
                modalTitle.textContent = `${data.name} Details`;
                modalDetails.style.display = 'block';
                modalLevel.textContent = data.level || 'N/A';
                modalPlotId.textContent = `${data.customId || ''} (${selectedCell})`;
                modalButtons.innerHTML = '';
                Object.values(alliances).forEach(ally => {
                    const btn = document.createElement('button');
                    btn.textContent = ally.name;
                    btn.className = `p-3 rounded-lg font-semibold transition-all duration-150 ease-in-out hover:scale-105 ${ally.color} ${ally.textColor} ${ally.hover}`;
                    
                    const isAtLimit = (plotCounts[ally.name][data.type] >= landLimits[data.type]);
                    if (isAtLimit) {
                        btn.disabled = true;
                        btn.classList.add('opacity-50', 'cursor-not-allowed');
                    }

                    btn.onclick = () => {
                        if (btn.disabled) return;
                        plotData[selectedCell].alliance = ally.name;
                        updateElementStyle(selectedCell);
                        updateAllianceStats();
                        selectedCell = null;
                        updateModal(allianceModal);
                    };
                    modalButtons.appendChild(btn);
                });
                allianceModal.classList.remove('hidden');
            } else {
                allianceModal.classList.add('hidden');
            }
        }
        
        modalClearBtn.onclick = () => {
             if (selectedCell) {
                if(plotData[selectedCell]) plotData[selectedCell].alliance = null;
                updateElementStyle(selectedCell);
                updateAllianceStats();
                selectedCell = null;
                updateModal(allianceModal);
            }
        };

        modalCloseBtn.onclick = () => {
            selectedCell = null;
            updateModal(allianceModal);
        };
        
        codeModalCloseButton.onclick = () => {
            codeModal.classList.add('hidden');
        };

        buffToggleSwitch.addEventListener('change', (e) => {
            showCityBuffs = e.target.checked;
            updateAllStyles();
        });
        
        levelToggleSwitch.addEventListener('change', (e) => {
            showCityLevels = e.target.checked;
            updateAllStyles();
        });

        idToggleSwitch.addEventListener('change', (e) => {
            showLandIds = e.target.checked;
            updateIdVisibility();
        });

        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
        });

        clearBtn.addEventListener('click', () => {
            confirmModal.classList.remove('hidden');
        });

        confirmModalCancelBtn.addEventListener('click', () => {
            confirmModal.classList.add('hidden');
        });

        confirmModalConfirmBtn.addEventListener('click', () => {
            for (const key in plotData) {
                plotData[key].alliance = null;
            }
            updateAllStyles();
            updateAllianceStats();
            confirmModal.classList.add('hidden');
        });

        exportBtn.addEventListener('click', () => {
            const assignments = [];
            for (const key in plotData) {
                if (plotData[key].alliance) {
                    assignments.push(`${plotData[key].customId}:${plotData[key].alliance}`);
                }
            }
            codeModalTitle.textContent = 'Export Map Code';
            codeModalTextarea.value = assignments.join(',');
            codeModalTextarea.readOnly = true;
            codeModalActionButton.textContent = 'Copy Code';
            codeModalActionButton.onclick = () => {
                codeModalTextarea.select();
                document.execCommand('copy');
            };
            codeModal.classList.remove('hidden');
        });

        importBtn.addEventListener('click', () => {
            codeModalTitle.textContent = 'Import Map Code';
            codeModalTextarea.value = '';
            codeModalTextarea.readOnly = false;
            codeModalActionButton.textContent = 'Apply Import';
            codeModalActionButton.onclick = () => {
                const code = codeModalTextarea.value;
                if (code) {
                    // Clear existing assignments first
                    for (const key in plotData) {
                        plotData[key].alliance = null;
                    }
                    // Apply imported assignments
                    const assignments = code.split(',');
                    const plotDataByCustomId = Object.fromEntries(Object.entries(plotData).map(([key, data]) => [data.customId, data]));
                    assignments.forEach(assignment => {
                        const [customId, allyName] = assignment.split(':');
                        if (plotDataByCustomId[customId] && alliances[allyName]) {
                            plotDataByCustomId[customId].alliance = allyName;
                        }
                    });
                    updateAllStyles();
                    updateAllianceStats();
                    codeModal.classList.add('hidden');
                }
            };
            codeModal.classList.remove('hidden');
        });

        // --- STARTUP ---
        app.addEventListener('wheel', handleWheel);
        app.addEventListener('mousedown', (e) => handleMouseDown(e, null));
        
        initializeMap();
    </script>
</body>
</html>
