<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>S3 Interactive Map</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Set base font size to scale the entire UI down */
        html {
            font-size: 75%;
        }
        body {
            overscroll-behavior: none;
            cursor: default;
            font-family: 'Inter', sans-serif;
            background-color: #000000;
        }
        .plot {
            cursor: pointer;
            overflow: hidden;
            line-height: 1.2;
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out, border-color 0.2s ease-out, background-color 0.2s ease-out, background-image 0.2s ease-out;
            border-width: 3px;
        }
        .plot:hover {
             transform: scale(1.05);
        }
        #action-tooltip {
            pointer-events: none;
            transition: opacity 0.1s ease-in-out;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        /* New Tooltip Style */
        #tooltip {
            pointer-events: none;
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.9), rgba(17, 24, 39, 0.95));
            border: 1px solid rgba(255, 255, 255, 0.2);
            transform: scale(0.95);
            opacity: 0;
        }
        #tooltip.visible {
            opacity: 1;
            transform: scale(1);
        }
        .modal-content {
             backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
             border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .hover-glow:hover {
            box-shadow: inset 0 0 25px 8px var(--glow-color, rgba(190, 220, 255, 0.25));
        }
        .inner-glow-red {
            box-shadow: inset 0 0 15px 5px rgba(239, 68, 68, 0.6);
        }
        /* Styles for sidebar, dock, and stats */
        #sidebar {
            position: fixed;
            right: 0;
            top: 0;
            height: 100%;
            width: 210px; /* Scaled down from 280px */
            background-color: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            z-index: 100;
            transform: translateX(0);
            transition: transform 0.3s ease-in-out;
        }
        #sidebar.collapsed {
            transform: translateX(100%);
        }
        #action-dock {
            position: fixed;
            top: 50%;
            right: 210px; /* Scaled down from 280px */
            transform: translateY(-50%);
            z-index: 101;
            display: flex;
            flex-direction: column;
            gap: 12px; /* Increased gap */
            transition: right 0.3s ease-in-out;
        }
        #sidebar.collapsed ~ #action-dock {
            right: 0;
        }
        .action-button {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #e5e7eb;
            font-size: 1rem;
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
            transition: all 0.2s ease-out;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        #sidebar-toggle {
            width: 36px;
            height: 54px;
            border-radius: 8px 0 0 8px;
            background-color: rgba(31, 41, 55, 0.7);
        }
        #save-map-btn { background-color: #059669; } /* Emerald */
        #import-map-btn { background-color: #0284c7; } /* Sky */
        #clear-btn { background-color: #be123c; } /* Rose */
        #help-btn { background-color: #ca8a04; } /* Amber */

        .action-button:hover {
            transform: scale(1.1);
            filter: brightness(1.2);
        }
        .action-button:disabled {
            background-color: #4b5563;
            cursor: not-allowed;
            filter: grayscale(1);
        }
        #sidebar-toggle .fa-solid {
            transition: transform 0.3s ease-in-out;
        }
        #sidebar.collapsed ~ #action-dock #sidebar-toggle .fa-solid {
            transform: rotate(180deg);
        }
        #alliance-summary {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        /* Custom Scrollbar Styling */
        #alliance-summary::-webkit-scrollbar, .modal-scroll-content::-webkit-scrollbar, #modal-body-content::-webkit-scrollbar, #import-map-list::-webkit-scrollbar {
            width: 8px;
        }
        #alliance-summary::-webkit-scrollbar-track, .modal-scroll-content::-webkit-scrollbar-track, #modal-body-content::-webkit-scrollbar-track, #import-map-list::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
        }
        #alliance-summary::-webkit-scrollbar-thumb, .modal-scroll-content::-webkit-scrollbar-thumb, #modal-body-content::-webkit-scrollbar-thumb, #import-map-list::-webkit-scrollbar-thumb {
            background-color: rgba(255,255,255,0.2);
            border-radius: 4px;
            border: 2px solid transparent;
            background-clip: content-box;
        }
        #alliance-summary::-webkit-scrollbar-thumb:hover, .modal-scroll-content::-webkit-scrollbar-thumb:hover, #modal-body-content::-webkit-scrollbar-thumb:hover, #import-map-list::-webkit-scrollbar-thumb:hover {
            background-color: rgba(255,255,255,0.4);
        }
        #button-dock {
            padding: 0.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        .dock-button {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: 0.75rem;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: #e5e7eb;
            transition: background-color 0.2s;
        }
        .dock-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .dock-button .fa-solid {
            margin-right: 0.75rem;
        }
        .form-switch .form-check-input {
            cursor: pointer;
        }
        .summary-item {
            margin-bottom: 1rem;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .summary-item h5 {
            font-weight: 700;
            padding: 0.5rem;
        }
        .summary-item .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem; 
            padding: 0.75rem;
            font-size: 0.8rem;
            background-color: rgba(0,0,0,0.2);
        }
        .summary-item .stat-item {
            display: flex;
            justify-content: space-between;
        }
        .summary-item .stat-label {
            font-weight: 600;
            color: #9ca3af; /* Lighter gray for label */
        }
        .summary-item .stat-value {
            font-weight: 700;
            color: #e5e7eb;
        }
        .summary-item .buff-list {
            padding: 0.5rem 0.75rem;
            font-size: 0.75rem;
            background-color: rgba(0,0,0,0.1);
        }
        /* Gradients for city buffs (used by toggle) */
        .gradient-iron { background-image: linear-gradient(to bottom right, #9ca3af, #4b5563); }
        .gradient-gold { background-image: linear-gradient(to bottom right, #facc15, #ca8a04); }
        .gradient-food { background-image: linear-gradient(to bottom right, #a16207, #422006); }

        /* Styles for new collapsible menu */
        #map-options-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.35s ease-in-out;
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
        #map-options-container.expanded {
            max-height: 25rem; /* Adjust as needed */
        }
        #map-options-toggle .chevron-icon {
            transition: transform 0.3s ease-in-out;
        }
        #map-options-toggle.expanded .chevron-icon {
            transform: rotate(180deg);
        }
        
        /* New Alliance Gradient Themes */
        .bg-alliance-1 { background-image: linear-gradient(to right, #f87171, #dc2626); } /* Red */
        .bg-alliance-2 { background-image: linear-gradient(to right, #60a5fa, #2563eb); } /* Blue */
        .bg-alliance-3 { background-image: linear-gradient(to right, #facc15, #eab308); } /* Yellow */
        .bg-alliance-4 { background-image: linear-gradient(to right, #4ade80, #16a34a); } /* Green */
        .bg-alliance-5 { background-image: linear-gradient(to right, #c084fc, #9333ea); } /* Purple */
        .bg-alliance-6 { background-image: linear-gradient(to right, #fb923c, #f97316); } /* Orange */
        .bg-alliance-7 { background-image: linear-gradient(to right, #22d3ee, #0891b2); } /* Cyan */
        .bg-alliance-8 { background-image: linear-gradient(to right, #f472b6, #db2777); } /* Pink */
        .bg-alliance-9 { background-image: linear-gradient(to right, #a3e635, #65a30d); } /* Lime */
        .bg-alliance-10 { background-image: linear-gradient(to right, #e5e7eb, #9ca3af); } /* Silver */

        .plot .plot-label {
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .capture-order-label {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
            border: 1px solid rgba(255,255,255,0.5);
        }

        /* Alliance Modal Overhaul */
        #alliance-modal .modal-content {
            width: 100%;
            max-width: 32rem; /* Wider modal */
            background: linear-gradient(145deg, rgba(23, 30, 46, 0.9), rgba(10, 14, 23, 0.95));
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }
        #modal-header {
            text-align: center;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 1rem;
            flex-shrink: 0;
        }
        #modal-body-content {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 0.5rem; /* For scrollbar */
        }
        #modal-alliance-list {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
        }
        .alliance-assign-button {
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 600;
            font-size: 0.8rem;
            text-align: center;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .alliance-assign-button:hover {
            transform: translateY(-1px);
            border-color: rgba(255, 255, 255, 0.5);
        }
        .alliance-assign-button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            background-image: none !important;
            background-color: rgba(75, 85, 99, 0.5) !important;
            color: #9ca3af !important;
        }
        #modal-tool-dock {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
            flex-shrink: 0;
        }
        .tool-dock-button {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 0.5rem;
            background-color: rgba(255, 255, 255, 0.1);
            color: #d1d5db;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease-in-out;
            font-weight: bold;
        }
        .tool-dock-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
            color: #fff;
        }
        .tool-dock-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .tool-dock-button:disabled:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: #d1d5db;
        }
        .tool-dock-button.danger:hover {
            background-color: #ef4444; /* red-500 */
            color: #fff;
        }
        .tool-dock-button.conflict {
            padding: 0 0.75rem;
            width: auto;
        }
        .tool-dock-button.conflict:hover {
            background-color: #f97316; /* orange-500 */
        }
        
        @media (max-width: 768px) {
            #sidebar {
                width: 240px; /* Slightly wider for easier touch on mobile */
            }
            #action-dock {
                right: 240px;
            }
        }
    </style>
</head>
<body class="text-white overflow-hidden">

    <div id="app" class="w-screen h-screen"></div>

    <!-- Sidebar for Stats and Controls -->
    <div id="sidebar" class="collapsed">
        <div id="alliance-summary">
            <h4 id="alliance-stats-title" class="text-lg font-bold text-center pb-2 mb-4">Alliance Statistics</h4>
            <div id="server-select-container" class="mb-4">
                <label for="server-select" class="block text-sm font-medium text-slate-300 mb-2">Select Server</label>
                <select id="server-select" class="w-full bg-gray-800 text-white p-2 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-sky-500"></select>
            </div>
            <div id="stats-container"></div>
        </div>
        <div id="button-dock">
             <button id="map-options-toggle" class="dock-button">
                <span><i class="fa-solid fa-map-location-dot"></i>Map Options</span>
                <i class="fa-solid fa-chevron-up chevron-icon"></i>
            </button>
            <div id="map-options-container">
                <button class="dock-button">
                    <span><i class="fa-solid fa-palette"></i>Show City Buffs</span>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="buff-toggle-switch">
                    </div>
                </button>
                <div id="buff-legend-container" class="hidden text-xs text-slate-400 space-y-2 p-3 -mt-2 mb-2 bg-black/20 rounded-b-lg">
                     <p class="font-bold text-slate-300">Buff Color Legend:</p>
                     <p><span class="inline-block w-3 h-3 rounded-full gradient-food mr-2"></span>Food Buff</p>
                     <p><span class="inline-block w-3 h-3 rounded-full gradient-iron mr-2"></span>Iron Buff</p>
                     <p><span class="inline-block w-3 h-3 rounded-full gradient-gold mr-2"></span>Coin Buff</p>
                </div>
                <button class="dock-button">
                    <span><i class="fa-solid fa-layer-group"></i>Show City Levels</span>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="level-toggle-switch" checked>
                    </div>
                </button>
                <button class="dock-button">
                    <span><i class="fa-solid fa-tag"></i>Show Land ID</span>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="id-toggle-switch">
                    </div>
                </button>
                <button class="dock-button">
                    <span><i class="fa-solid fa-text-slash"></i>Minimal Mode</span>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="minimal-mode-switch">
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Action Dock -->
    <div id="action-dock">
        <button id="sidebar-toggle" class="action-button" title="Toggle Sidebar">
            <i class="fa-solid fa-chevron-right"></i>
        </button>
        <button id="save-map-btn" class="action-button" title="Save Map">
            <i class="fa-solid fa-save"></i>
        </button>
        <button id="import-map-btn" class="action-button" title="Import Map">
            <i class="fa-solid fa-cloud-download-alt"></i>
        </button>
        <button id="clear-btn" class="action-button" title="Clear All Assignments">
            <i class="fa-solid fa-trash"></i>
        </button>
        <button id="help-btn" class="action-button" title="S3 Guide">
            <i class="fa-solid fa-circle-question"></i>
        </button>
    </div>

    <!-- Tooltips -->
    <div id="tooltip" class="hidden absolute text-white text-sm rounded-xl shadow-2xl z-50 max-w-xs w-64">
        <!-- Tooltip Header -->
        <div class="px-4 py-2 border-b border-slate-700/50">
            <h4 id="tooltip-title" class="font-bold text-base text-sky-300 truncate"></h4>
            <p class="text-xs text-slate-400 -mt-1">ID: <span id="tooltip-id"></span></p>
        </div>
        <!-- Tooltip Body -->
        <div class="p-4 space-y-3">
            <div class="flex items-center justify-between gap-4">
                <span class="font-semibold text-slate-400">Level</span>
                <span id="tooltip-level" class="font-bold text-slate-100 bg-slate-700 px-2 py-0.5 rounded"></span>
            </div>
            <div id="tooltip-buff-p" class="flex items-center justify-between gap-4">
                <span class="font-semibold text-slate-400">Buff</span>
                <span id="tooltip-buff" class="font-bold text-slate-100 text-right"></span>
            </div>
            <div id="tooltip-owner-p" class="hidden flex items-center justify-between gap-4">
                <span class="font-semibold text-slate-400">Owner</span>
                <span id="tooltip-owner" class="font-bold text-slate-100"></span>
            </div>
            
            <!-- S3 Resources Section -->
            <div id="tooltip-s3-resources" class="hidden pt-3 mt-3 border-t border-slate-700/50">
                 <div class="space-y-2">
                    <div id="tooltip-mithril-p" class="hidden flex items-center justify-between gap-4">
                        <span class="font-semibold text-slate-300 flex items-center"><i class="fa-solid fa-gem text-sky-400 fa-fw mr-2"></i>Mithril</span>
                        <span id="tooltip-mithril" class="font-bold text-sky-300"></span>
                    </div>
                    <div id="tooltip-spice-p" class="hidden flex items-center justify-between gap-4">
                        <span class="font-semibold text-slate-300 flex items-center"><i class="fa-solid fa-pepper-hot text-amber-400 fa-fw mr-2"></i>Spice</span>
                        <span id="tooltip-spice" class="font-bold text-amber-300"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="action-tooltip" class="hidden absolute bg-gray-900/80 text-white text-xs p-2 rounded-md shadow-2xl opacity-0 z-50"></div>


    <!-- Modals -->
    <div id="help-modal" class="hidden fixed inset-0 bg-black/60 flex justify-center items-center z-50 p-4">
        <div class="modal-content bg-gray-900/80 p-6 rounded-2xl shadow-2xl w-full max-w-2xl text-white relative">
             <button id="help-modal-close-btn" class="absolute top-3 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
            <h3 class="font-bold text-xl text-amber-400 mb-4">Season 3 "Golden Kingdom" Guide</h3>
            <div class="modal-scroll-content max-h-[70vh] overflow-y-auto pr-4 text-slate-300 text-sm space-y-4">
                <p>Success in S3 hinges on managing key resources, increasing Curse Resistance, and coordinating with your alliance.</p>
                <div>
                    <h4 class="font-bold text-lg text-slate-100 mb-2">Key Resources</h4>
                    <ul class="list-disc list-inside space-y-1 pl-2">
                        <li><strong>Mithril:</strong> Essential for upgrading most seasonal buildings. Primarily acquired from Digging Strongholds.</li>
                        <li><strong>Sacred Water:</strong> Crucial for upgrading the Curse Research Lab. Primarily acquired from Blessing Fountains.</li>
                        <li><strong>Spice:</strong> The most important resource for overall progression, produced hourly by captured cities.</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-bold text-lg text-slate-100 mb-2">Core Mechanics</h4>
                    <ul class="list-disc list-inside space-y-1 pl-2">
                        <li><strong>Curse Resistance:</strong> A vital stat for fighting Elite Zombies, Stronghold Protectors, and reducing losses in city sieges. Upgrade this at the Curse Research Lab.</li>
                        <li><strong>Resistance Leader:</strong> A player with high Curse Resistance should lead rallies against Strongholds and Elites, as their resistance stat applies to all members.</li>
                    </ul>
                </div>
                 <div>
                    <h4 class="font-bold text-lg text-slate-100 mb-2">Strategic Buildings & Plots</h4>
                     <ul class="list-disc list-inside space-y-1 pl-2">
                        <li><strong>Digging Strongholds:</strong> Your first capture must be a Level 1 Digging Stronghold. This is your main source of Mithril. You are limited to 8 strongholds total and 2 captures per day.</li>
                        <li><strong>Cities:</strong> Capture these during the "City Clash S3" event to generate Spice. Higher level cities produce significantly more Spice.</li>
                         <li><strong>Protector's Field:</strong> It is highly recommended to only level this to Level 10 initially to conserve Mithril and Sacred Water for more critical upgrades.</li>
                         <li><strong>Trade Posts:</strong> Become contestable across different warzones in Week 3, driving large-scale conflict.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div id="alliance-modal" class="hidden fixed inset-0 bg-black/60 flex justify-center items-center z-50 p-4">
        <div class="modal-content p-6 rounded-2xl shadow-2xl text-white relative">
            <button id="alliance-modal-close-x" class="absolute top-3 right-4 text-gray-400 hover:text-white text-2xl z-10">&times;</button>
            
            <div id="modal-header">
                <h3 id="modal-title" class="font-bold text-xl text-sky-300"></h3>
                <p id="modal-plot-id" class="text-xs text-slate-400"></p>
            </div>
            
            <div id="modal-body-content">
                <div id="regular-plot-section">
                    <div id="modal-details" class="mb-6 space-y-2 text-left bg-black/30 p-4 rounded-lg border border-slate-700/50">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-slate-400">Level</span>
                            <span id="modal-level" class="font-bold text-slate-100"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-slate-400">Buff</span>
                            <span id="modal-buff" class="font-bold text-slate-100 text-right"></span>
                        </div>
                        <div id="modal-mithril-p" class="flex justify-between items-center">
                            <span class="font-semibold text-slate-400 flex items-center"><i class="fa-solid fa-gem text-sky-400 fa-fw mr-2"></i>Mithril</span>
                            <span id="modal-mithril" class="font-bold text-sky-300"></span>
                        </div>
                        <div id="modal-spice-p" class="flex justify-between items-center">
                            <span class="font-semibold text-slate-400 flex items-center"><i class="fa-solid fa-pepper-hot text-amber-400 fa-fw mr-2"></i>Spice</span>
                            <span id="modal-spice" class="font-bold text-amber-300"></span>
                        </div>
                    </div>
                    <h4 class="text-center font-semibold text-slate-300 mb-3">Assign to Alliance</h4>
                    <div id="modal-alliance-list"></div>
                </div>

                <div id="trade-post-section" class="hidden">
                    <div class="my-4 text-left">
                        <label class="block text-sm font-medium text-slate-300 mb-2">Owner Alliance</label>
                        <div id="trade-post-alliance-buttons" class="grid grid-cols-2 gap-3 mb-4"></div>
                        <label for="player-name-input" class="block text-sm font-medium text-slate-300 mb-2">Owner Player Name</label>
                        <input type="text" id="player-name-input" class="w-full bg-gray-800 text-white p-2 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Enter player name...">
                    </div>
                    <button id="save-trade-post-btn" class="w-full bg-sky-600 text-white p-2 rounded-lg font-semibold hover:bg-sky-500 transition-colors">
                        Save Owner
                    </button>
                    <button id="trade-post-help-btn" class="w-full mt-4 bg-amber-600/80 text-white p-2 rounded-lg font-bold hover:bg-amber-500/90 transition-all shadow-lg hover:shadow-amber-500/50 transform hover:scale-105">
                        <i class="fa-solid fa-circle-info mr-2"></i>Trade Post Help
                    </button>
                </div>
            </div>

            <div id="modal-tool-dock">
                <div id="capture-order-buttons" class="flex gap-2" title="Capture Order (Coming Soon)">
                    <button class="tool-dock-button" disabled>1</button>
                    <button class="tool-dock-button" disabled>2</button>
                    <button class="tool-dock-button" disabled>3</button>
                    <button class="tool-dock-button" disabled>4</button>
                </div>
                <div class="flex-grow"></div>
                <button id="modal-conflict-btn" class="tool-dock-button conflict" title="Set Conflict">
                    <i class="fa-solid fa-swords"></i>
                </button>
                <button id="modal-clear-btn" class="tool-dock-button danger" title="Clear Assignment">
                    <i class="fa-solid fa-trash-can"></i>
                </button>
            </div>
        </div>
    </div>
    
    <div id="trade-post-info-modal" class="hidden fixed inset-0 bg-black/60 flex justify-center items-center z-50 p-4">
        <div class="modal-content bg-gray-900/50 p-6 rounded-2xl shadow-2xl w-full max-w-md text-white relative">
            <button id="trade-post-info-close-btn" class="absolute top-3 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
            <h3 class="font-bold text-xl mb-4 text-sky-300">About Trade Posts</h3>
            <div class="text-left space-y-3 text-slate-300">
                <p>Trade Posts are located in specific locations on the map, placed on the diagonals going towards the capitol. Trade Posts can be of different levels up to level 5.</p>
                <p>Trade posts don’t equal strongholds or cities. They can be occupied by individuals, and will unlock a market in which everyone can buy items. The owner of the trade posts can earn taxes.</p>
                <p>There’s no need to control adjacent territory, and there’s no limit on the number of trade posts you can have. However, trade posts can be captured by others, so you need to defend them. Therefore, it’s usually difficult for one player to manage too many trade posts effectively.</p>
            </div>
        </div>
    </div>

    <div id="conflict-modal" class="hidden fixed inset-0 bg-black/60 flex justify-center items-center z-50 p-4">
        <div class="modal-content bg-gray-900/80 p-6 rounded-2xl shadow-2xl w-full max-w-md text-white relative">
            <button id="conflict-modal-close-btn" class="absolute top-3 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
            <h3 class="font-bold text-xl mb-4 text-center text-orange-400">Set Plot Conflict</h3>
            <div class="grid grid-cols-2 gap-6">
                <div>
                    <h4 class="font-semibold text-center mb-2 text-slate-300">Alliance 1</h4>
                    <div id="conflict-alliance-1-list" class="space-y-2"></div>
                </div>
                <div>
                    <h4 class="font-semibold text-center mb-2 text-slate-300">Alliance 2</h4>
                    <div id="conflict-alliance-2-list" class="space-y-2"></div>
                </div>
            </div>
            <button id="set-conflict-btn" class="w-full mt-6 bg-orange-600 text-white p-2 rounded-lg font-semibold hover:bg-orange-500 transition-colors">
                Set Conflict
            </button>
        </div>
    </div>

    <div id="save-map-modal" class="hidden fixed inset-0 bg-black/60 flex justify-center items-center z-50 p-4">
        <div class="modal-content bg-gray-900/80 p-6 rounded-2xl shadow-2xl w-full max-w-md text-white relative">
            <button id="save-map-modal-close-btn" class="absolute top-3 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
            <h3 class="font-bold text-xl mb-4 text-center text-emerald-400">Save Map Layout</h3>
            <div class="space-y-4">
                <input type="text" id="save-map-name" class="w-full bg-gray-800 text-white p-2 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Map Name">
                <input type="text" id="save-player-name" class="w-full bg-gray-800 text-white p-2 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Your Name">
                <textarea id="save-map-description" class="w-full h-24 bg-gray-800 text-white p-2 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Description..."></textarea>
                <input type="password" id="save-delete-password" class="w-full bg-gray-800 text-white p-2 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Optional Delete Password">
            </div>
            <button id="save-map-submit-btn" class="w-full mt-6 bg-emerald-600 text-white p-2 rounded-lg font-semibold hover:bg-emerald-500 transition-colors">
                Save to Cloud
            </button>
        </div>
    </div>

    <div id="import-map-modal" class="hidden fixed inset-0 bg-black/60 flex justify-center items-center z-50 p-4">
        <div class="modal-content bg-gray-900/80 p-6 rounded-2xl shadow-2xl w-full max-w-2xl text-white relative flex flex-col max-h-[80vh]">
            <button id="import-map-modal-close-btn" class="absolute top-3 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
            <h3 class="font-bold text-xl mb-4 text-center text-sky-400">Load Map from Cloud</h3>
            <div id="import-map-list" class="flex-grow overflow-y-auto space-y-3 pr-2">
                <!-- Map list will be populated here -->
            </div>
        </div>
    </div>
    
    <div id="delete-prompt-modal" class="hidden fixed inset-0 bg-black/60 flex justify-center items-center z-50 p-4">
        <div class="modal-content bg-gray-900/80 p-6 rounded-2xl shadow-2xl w-full max-w-sm text-white relative">
            <button id="delete-prompt-close-btn" class="absolute top-3 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
            <h3 class="font-bold text-xl mb-4 text-center text-red-400">Delete Map</h3>
            <p id="delete-prompt-message" class="text-center mb-4">Please enter the password to delete this map.</p>
            <input type="password" id="delete-password-input" class="w-full bg-gray-800 text-white p-2 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Delete Password">
            <div class="flex gap-4 mt-6">
                <button id="delete-prompt-cancel-btn" class="w-full bg-gray-600 text-white p-2 rounded-lg font-semibold hover:bg-gray-500 transition-colors">Cancel</button>
                <button id="delete-prompt-confirm-btn" class="w-full bg-red-600 text-white p-2 rounded-lg font-semibold hover:bg-red-500 transition-colors">Delete</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="hidden fixed inset-0 bg-black/60 flex justify-center items-center z-50 p-4">
        <div class="modal-content bg-gray-900/50 p-6 rounded-2xl shadow-2xl w-full max-w-sm text-white relative">
            <button id="confirm-modal-close-btn" class="absolute top-3 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
            <h3 id="confirm-modal-title" class="font-bold text-xl mb-4">Are you sure?</h3>
            <p id="confirm-modal-body" class="mb-6">This action cannot be undone.</p>
            <div class="flex justify-end gap-4">
                <button id="confirm-modal-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="confirm-modal-confirm-btn" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg">Confirm</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, serverTimestamp, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const serverData = {
            899: {
                THOR: { name: 'THOR', color: 'bg-alliance-2', textColor: 'text-white' },
                FAFO: { name: 'fAfO', color: 'bg-alliance-1', textColor: 'text-white' },
                HERA: { name: 'HeRA', color: 'bg-alliance-3', textColor: 'text-black' },
                PHNX: { name: 'pHNx', color: 'bg-alliance-5', textColor: 'text-white' },
                TROW: { name: 'TroW', color: 'bg-alliance-4', textColor: 'text-white' },
                VALT: { name: 'VaLT', color: 'bg-alliance-6', textColor: 'text-white' },
                COLD: { name: 'COLD', color: 'bg-alliance-7', textColor: 'text-white' },
                TONE: { name: 'Tone', color: 'bg-alliance-8', textColor: 'text-white' },
                MINI: { name: 'MINI', color: 'bg-alliance-9', textColor: 'text-black' },
                DOM:  { name: 'DoM',  color: 'bg-alliance-10', textColor: 'text-black' }
            },
            900: {}, 901: {}, 902: {}, 903: {}, 904: {}, 905: {}, 906: {}
        };

        const landLimits = {
            Stronghold: 8,
            City: 6
        };
        const cityLevelBorders = {
            1: 'border-purple-500', 2: 'border-blue-500', 3: 'border-green-500',
            4: 'border-yellow-500', 5: 'border-orange-500', 6: 'border-red-500'
        };
        const defaultMainPlotClasses = { base: 'bg-gray-900/50 border-gray-800', hover: 'hover-glow' };
        const defaultCornerPlotClasses = { base: 'bg-gray-800', hover: 'hover-glow' };

        // Resource Generation Rates
        const SPICE_RATES = { 1: 100, 2: 200, 3: 300, 4: 400, 5: 500, 6: 600 };
        const MITHRIL_RATES = { 1: 100, 2: 120, 3: 140, 4: 160, 5: 180, 6: 200 };

        const plotAcronyms = {
            'Stronghold': 'Sh',
            'Village': 'Vi',
            'Altar': 'Al',
            'Town': 'T',
            'Temple of the Sun': 'TotS',
            'Ancient Tombs': 'AT',
            'Square of Judgment': 'SoJ',
            'Trade Post': 'TP',
            'Great Pyramid': 'GP'
        };

        const rows = 13, cols = 13, cellWidth = 75, cellHeight = 60, cornerPlotSizeRatio = 0.67; 
        
        const externalDataCSV = `ID,Name,Type,Buff%,BuffType
SA01,Stronghold,Stronghold,1%,Iron
SA02,Stronghold,Stronghold,1%,Iron
SA03,Stronghold,Stronghold,1%,Iron
SA04,Stronghold,Stronghold,1%,Iron
SA05,Stronghold,Stronghold,1%,Iron
SA06,Stronghold,Stronghold,1%,Iron
SA07,Stronghold,Stronghold,1%,Iron
SA08,Stronghold,Stronghold,1%,Iron
SA09,Stronghold,Stronghold,1%,Iron
SA10,Stronghold,Stronghold,1%,Iron
SA11,Stronghold,Stronghold,1%,Iron
SA12,Stronghold,Stronghold,1%,Iron
SA13,Stronghold,Stronghold,1%,Iron
CA01,City,Trade Post,NA,NA
CA02,City,Village,7.5%,Food
CA03,City,Village,7.5%,Iron
CA04,City,Village,7.5%,Food
CA05,City,Village,7.5%,Iron
CA06,City,Village,7.5%,Food
CA07,City,Village,7.5%,Food
CA08,City,Village,7.5%,Iron
CA09,City,Village,7.5%,Food
CA10,City,Village,7.5%,Iron
CA11,City,Village,7.5%,Food
CA12,City,Trade Post,NA,NA
SB01,Stronghold,Stronghold,1%,Iron
SB02,Stronghold,Stronghold,2%,Iron
SB03,Stronghold,Stronghold,2%,Iron
SB04,Stronghold,Stronghold,2%,Iron
SB05,Stronghold,Stronghold,2%,Iron
SB06,Stronghold,Stronghold,2%,Iron
SB07,Stronghold,Stronghold,2%,Iron
SB08,Stronghold,Stronghold,2%,Iron
SB09,Stronghold,Stronghold,2%,Iron
SB10,Stronghold,Stronghold,2%,Iron
SB11,Stronghold,Stronghold,2%,Iron
SB12,Stronghold,Stronghold,2%,Iron
SB13,Stronghold,Stronghold,1%,Iron
CB01,City,Village,7.5%,Iron
CB02,City,Trade Post,NA,NA
CB03,City,Altar,7.5%,Coin
CB04,City,Altar,7.5%,Gathering Speed
CB05,City,Altar,7.5%,Coin
CB06,City,Altar,7.5%,Gathering Speed
CB07,City,Altar,7.5%,Coin
CB08,City,Altar,7.5%,Gathering Speed
CB09,City,Altar,7.5%,Coin
CB10,City,Altar,7.5%,Gathering Speed
CB11,City,Trade Post,NA,NA
CB12,City,Village,7.5%,Iron
SC01,Stronghold,Stronghold,1%,Iron
SC02,Stronghold,Stronghold,2%,Iron
SC03,Stronghold,Stronghold,3%,Iron
SC04,Stronghold,Stronghold,3%,Iron
SC05,Stronghold,Stronghold,3%,Iron
SC06,Stronghold,Stronghold,3%,Iron
SC07,Stronghold,Stronghold,3%,Iron
SC08,Stronghold,Stronghold,3%,Iron
SC09,Stronghold,Stronghold,3%,Iron
SC10,Stronghold,Stronghold,3%,Iron
SC11,Stronghold,Stronghold,3%,Iron
SC12,Stronghold,Stronghold,2%,Iron
SC13,Stronghold,Stronghold,1%,Iron
CC01,City,Village,7.5%,Food
CC02,City,Altar,7.5%,Gathering Speed
CC03,City,Trade Post,NA,NA
CC04,City,Town,15%,Food
CC05,City,Town,15%,Iron
CC06,City,Town,15%,Food
CC07,City,Town,15%,Food
CC08,City,Town,15%,Iron
CC09,City,Town,15%,Food
CC10,City,Trade Post,NA,NA
CC11,City,Altar,7.5%,Gathering Speed
CC12,City,Village,7.5%,Food
SD01,Stronghold,Stronghold,1%,Iron
SD02,Stronghold,Stronghold,2%,Iron
SD03,Stronghold,Stronghold,3%,Iron
SD04,Stronghold,Stronghold,4%,Iron
SD05,Stronghold,Stronghold,4%,Iron
SD06,Stronghold,Stronghold,4%,Iron
SD07,Stronghold,Stronghold,4%,Iron
SD08,Stronghold,Stronghold,4%,Iron
SD09,Stronghold,Stronghold,4%,Iron
SD10,Stronghold,Stronghold,4%,Iron
SD11,Stronghold,Stronghold,3%,Iron
SD12,Stronghold,Stronghold,2%,Iron
SD13,Stronghold,Stronghold,1%,Iron
CD01,City,Village,7.5%,Iron
CD02,City,Altar,7.5%,Coin
CD03,City,Town,15%,Iron
CD04,City,Trade Post,NA,NA
CD05,City,Temple of the Sun,15%,Coin
CD06,City,Temple of the Sun,15%,Gathering Speed
CD07,City,Temple of the Sun,15%,Coin
CD08,City,Temple of the Sun,15%,Gathering Speed
CD09,City,Trade Post,NA,NA
CD10,City,Town,15%,Iron
CD11,City,Altar,7.5%,Coin
CD12,City,Village,7.5%,Iron
SE01,Stronghold,Stronghold,1%,Iron
SE02,Stronghold,Stronghold,2%,Iron
SE03,Stronghold,Stronghold,3%,Iron
SE04,Stronghold,Stronghold,4%,Iron
SE05,Stronghold,Stronghold,5%,Iron
SE06,Stronghold,Stronghold,5%,Iron
SE07,Stronghold,Stronghold,5%,Iron
SE08,Stronghold,Stronghold,5%,Iron
SE09,Stronghold,Stronghold,5%,Iron
SE10,Stronghold,Stronghold,4%,Iron
SE11,Stronghold,Stronghold,3%,Iron
SE12,Stronghold,Stronghold,2%,Iron
SE13,Stronghold,Stronghold,1%,Iron
CE01,City,Village,7.5%,Food
CE02,City,Altar,7.5%,Gathering Speed
CE03,City,Town,15%,Food
CE04,City,Temple of the Sun,15%,Gathering Speed
CE05,City,Trade Post,NA,NA
CE06,City,Ancient Tombs,25%,Food
CE07,City,Ancient Tombs,25%,Food
CE08,City,Trade Post,NA,NA
CE09,City,Temple of the Sun,15%,Gathering Speed
CE10,City,Town,15%,Food
CE11,City,Altar,7.5%,Gathering Speed
CE12,City,Village,7.5%,Food
SF01,Stronghold,Stronghold,1%,Iron
SF02,Stronghold,Stronghold,2%,Iron
SF03,Stronghold,Stronghold,3%,Iron
SF04,Stronghold,Stronghold,4%,Iron
SF05,Stronghold,Stronghold,5%,Iron
SF06,Stronghold,Stronghold,6%,Iron
SF07,Stronghold,Stronghold,6%,Iron
SF08,Stronghold,Stronghold,6%,Iron
SF09,Stronghold,Stronghold,5%,Iron
SF10,Stronghold,Stronghold,4%,Iron
SF11,Stronghold,Stronghold,3%,Iron
SF12,Stronghold,Stronghold,2%,Iron
SF13,Stronghold,Stronghold,1%,Iron
CF01,City,Village,7.5%,Iron
CF02,City,Altar,7.5%,Coin
CF03,City,Town,15%,Iron
CF04,City,Temple of the Sun,15%,Coin
CF05,City,Ancient Tombs,25%,Iron
CF06,City,Square of Judgment,20%,Construction
CF07,City,Square of Judgment,10%,Healing
CF08,City,Ancient Tombs,25%,Iron
CF09,City,Temple of the Sun,15%,Coin
CF10,City,Town,15%,Iron
CF11,City,Altar,7.5%,Coin
CF12,City,Village,7.5%,Iron
SG01,Stronghold,Stronghold,1%,Iron
SG02,Stronghold,Stronghold,2%,Iron
SG03,Stronghold,Stronghold,4%,Iron
SG04,Stronghold,Stronghold,8%,Iron
SG05,Stronghold,Stronghold,16%,Iron
SG06,Stronghold,Stronghold,16%,Iron
SG07,Stronghold,Great Pyramid,10%,March
SG08,Stronghold,Stronghold,16%,Iron
SG09,Stronghold,Stronghold,16%,Iron
SG10,Stronghold,Stronghold,8%,Iron
SG11,Stronghold,Stronghold,4%,Iron
SG12,Stronghold,Stronghold,2%,Iron
SG13,Stronghold,Stronghold,1%,Iron
CG01,City,Village,7.5%,Food
CG02,City,Altar,7.5%,Gathering Speed
CG03,City,Town,15%,Food
CG04,City,Temple of the Sun,15%,Gathering Speed
CG05,City,Ancient Tombs,25%,Food
CG06,City,Square of Judgment,20%,Research
CG07,City,Square of Judgment,5%,Training
CG08,City,Ancient Tombs,25%,Food
CG09,City,Temple of the Sun,15%,Gathering Speed
CG10,City,Town,15%,Food
CG11,City,Altar,7.5%,Coin
CG12,City,Village,7.5%,Food
SH01,Stronghold,Stronghold,1%,Iron
SH02,Stronghold,Stronghold,2%,Iron
SH03,Stronghold,Stronghold,4%,Iron
SH04,Stronghold,Stronghold,8%,Iron
SH05,Stronghold,Stronghold,16%,Iron
SH06,Stronghold,Stronghold,16%,Iron
SH07,Stronghold,Stronghold,16%,Iron
SH08,Stronghold,Stronghold,16%,Iron
SH09,Stronghold,Stronghold,16%,Iron
SH10,Stronghold,Stronghold,8%,Iron
SH11,Stronghold,Stronghold,4%,Iron
SH12,Stronghold,Stronghold,2%,Iron
SH13,Stronghold,Stronghold,1%,Iron
CH01,City,Village,7.5%,Iron
CH02,City,Altar,7.5%,Coin
CH03,City,Town,15%,Iron
CH04,City,Temple of the Sun,15%,Coin
CH05,City,Trade Post,NA,NA
CH06,City,Ancient Tombs,25%,Iron
CH07,City,Ancient Tombs,25%,Iron
CH08,City,Trade Post,NA,NA
CH09,City,Temple of the Sun,15%,Coin
CH10,City,Town,15%,Iron
CH11,City,Altar,7.5%,Gathering Speed
CH12,City,Village,7.5%,Iron
SI01,Stronghold,Stronghold,1%,Iron
SI02,Stronghold,Stronghold,2%,Iron
SI03,Stronghold,Stronghold,4%,Iron
SI04,Stronghold,Stronghold,8%,Iron
SI05,Stronghold,Stronghold,8%,Iron
SI06,Stronghold,Stronghold,8%,Iron
SI07,Stronghold,Stronghold,8%,Iron
SI08,Stronghold,Stronghold,8%,Iron
SI09,Stronghold,Stronghold,8%,Iron
SI10,Stronghold,Stronghold,8%,Iron
SI11,Stronghold,Stronghold,4%,Iron
SI12,Stronghold,Stronghold,2%,Iron
SI13,Stronghold,Stronghold,1%,Iron
CI01,City,Village,7.5%,Food
CI02,City,Altar,7.5%,Gathering Speed
CI03,City,Town,15%,Food
CI04,City,Trade Post,NA,NA
CI05,City,Temple of the Sun,15%,Coin
CI06,City,Temple of the Sun,15%,Gathering Speed
CI07,City,Temple of the Sun,15%,Coin
CI08,City,Temple of the Sun,15%,Gathering Speed
CI09,City,Trade Post,NA,NA
CI10,City,Town,15%,Food
CI11,City,Altar,7.5%,Coin
CI12,City,Village,7.5%,Food
SJ01,Stronghold,Stronghold,1%,Iron
SJ02,Stronghold,Stronghold,2%,Iron
SJ03,Stronghold,Stronghold,3%,Iron
SJ04,Stronghold,Stronghold,4%,Iron
SJ05,Stronghold,Stronghold,4%,Iron
SJ06,Stronghold,Stronghold,4%,Iron
SJ07,Stronghold,Stronghold,4%,Iron
SJ08,Stronghold,Stronghold,4%,Iron
SJ09,Stronghold,Stronghold,4%,Iron
SJ10,Stronghold,Stronghold,4%,Iron
SJ11,Stronghold,Stronghold,3%,Iron
SJ12,Stronghold,Stronghold,2%,Iron
SJ13,Stronghold,Stronghold,1%,Iron
CJ01,City,Village,7.5%,Iron
CJ02,City,Altar,7.5%,Coin
CJ03,City,Trade Post,NA,NA
CJ04,City,Town,15%,Iron
CJ05,City,Town,15%,Food
CJ06,City,Town,15%,Iron
CJ07,City,Town,15%,Iron
CJ08,City,Town,15%,Food
CJ09,City,Town,15%,Iron
CJ10,City,Trade Post,NA,NA
CJ11,City,Altar,7.5%,Gathering Speed
CJ12,City,Village,7.5%,Iron
SK01,Stronghold,Stronghold,1%,Iron
SK02,Stronghold,Stronghold,2%,Iron
SK03,Stronghold,Stronghold,3%,Iron
SK04,Stronghold,Stronghold,3%,Iron
SK05,Stronghold,Stronghold,3%,Iron
SK06,Stronghold,Stronghold,3%,Iron
SK07,Stronghold,Stronghold,3%,Iron
SK08,Stronghold,Stronghold,3%,Iron
SK09,Stronghold,Stronghold,3%,Iron
SK10,Stronghold,Stronghold,3%,Iron
SK11,Stronghold,Stronghold,3%,Iron
SK12,Stronghold,Stronghold,2%,Iron
SK13,Stronghold,Stronghold,1%,Iron
CK01,City,Village,7.5%,Food
CK02,City,Trade Post,NA,NA
CK03,City,Altar,7.5%,Coin
CK04,City,Altar,7.5%,Gathering Speed
CK05,City,Altar,7.5%,Coin
CK06,City,Altar,7.5%,Gathering Speed
CK07,City,Altar,7.5%,Coin
CK08,City,Altar,7.5%,Gathering Speed
CK09,City,Altar,7.5%,Coin
CK10,City,Altar,7.5%,Gathering Speed
CK11,City,Trade Post,NA,NA
CK12,City,Village,7.5%,Food
SL01,Stronghold,Stronghold,1%,Iron
SL02,Stronghold,Stronghold,2%,Iron
SL03,Stronghold,Stronghold,2%,Iron
SL04,Stronghold,Stronghold,2%,Iron
SL05,Stronghold,Stronghold,2%,Iron
SL06,Stronghold,Stronghold,2%,Iron
SL07,Stronghold,Stronghold,2%,Iron
SL08,Stronghold,Stronghold,2%,Iron
SL09,Stronghold,Stronghold,2%,Iron
SL10,Stronghold,Stronghold,2%,Iron
SL11,Stronghold,Stronghold,2%,Iron
SL12,Stronghold,Stronghold,2%,Iron
SL13,Stronghold,Stronghold,1%,Iron
CL01,City,Trade Post,NA,NA
CL02,City,Village,7.5%,Iron
CL03,City,Village,7.5%,Food
CL04,City,Village,7.5%,Iron
CL05,City,Village,7.5%,Food
CL06,City,Village,7.5%,Iron
CL07,City,Village,7.5%,Iron
CL08,City,Village,7.5%,Food
CL09,City,Village,7.5%,Iron
CL10,City,Village,7.5%,Food
CL11,City,Village,7.5%,Iron
CL12,City,Trade Post,NA,NA
SM01,Stronghold,Stronghold,1%,Iron
SM02,Stronghold,Stronghold,1%,Iron
SM03,Stronghold,Stronghold,1%,Iron
SM04,Stronghold,Stronghold,1%,Iron
SM05,Stronghold,Stronghold,1%,Iron
SM06,Stronghold,Stronghold,1%,Iron
SM07,Stronghold,Stronghold,1%,Iron
SM08,Stronghold,Stronghold,1%,Iron
SM09,Stronghold,Stronghold,1%,Iron
SM10,Stronghold,Stronghold,1%,Iron
SM11,Stronghold,Stronghold,1%,Iron
SM12,Stronghold,Stronghold,1%,Iron
SM13,Stronghold,Stronghold,1%,Iron`;

        // --- STATE & REFERENCES ---
        let activeAlliances = {};
        let view = { x: 0, y: 0, zoom: 1 };
        let plotData = {}; 
        let selectedCell = null;
        let hoveredCell = null;
        const plotElements = new Map();
        const dragInfo = { isMouseDown: false, startX: 0, startY: 0, viewStartX: 0, viewStartY: 0, isDragging: false, clickedCell: null };
        let touchState = {
            isPinching: false,
            initialPinchDistance: 0,
            viewStartZoom: 1
        };
        let hideTooltipTimer; 
        let showCityBuffs = false;
        let showCityLevels = true;
        let showLandIds = false;
        let isMinimalMode = false;
        let selectedTradePostAlliance = null;
        let db;
        const MASTER_DELETE_PASSWORD = 'kitty';

        // --- DOM REFERENCES ---
        const app = document.getElementById('app');
        const tooltip = document.getElementById('tooltip'), tooltipTitle = document.getElementById('tooltip-title'), tooltipId = document.getElementById('tooltip-id'), tooltipLevel = document.getElementById('tooltip-level'), tooltipBuff = document.getElementById('tooltip-buff'), tooltipOwnerP = document.getElementById('tooltip-owner-p'), tooltipOwner = document.getElementById('tooltip-owner'), tooltipMithril = document.getElementById('tooltip-mithril'), tooltipSpice = document.getElementById('tooltip-spice'), tooltipBuffP = document.getElementById('tooltip-buff-p'), tooltipMithrilP = document.getElementById('tooltip-mithril-p'), tooltipSpiceP = document.getElementById('tooltip-spice-p'), tooltipS3Resources = document.getElementById('tooltip-s3-resources');
        const actionTooltip = document.getElementById('action-tooltip');
        
        // Modals
        const allianceModal = document.getElementById('alliance-modal'), modalTitle = document.getElementById('modal-title'), modalPlotId = document.getElementById('modal-plot-id');
        const regularPlotSection = document.getElementById('regular-plot-section');
        const modalDetails = document.getElementById('modal-details'), modalLevel = document.getElementById('modal-level'), modalBuffEl = document.getElementById('modal-buff'), modalMithrilEl = document.getElementById('modal-mithril'), modalSpiceEl = document.getElementById('modal-spice');
        const modalAllianceList = document.getElementById('modal-alliance-list'), modalClearBtn = document.getElementById('modal-clear-btn');
        const tradePostSection = document.getElementById('trade-post-section');
        const tradePostAllianceButtons = document.getElementById('trade-post-alliance-buttons');
        const playerNameInput = document.getElementById('player-name-input');
        const saveTradePostBtn = document.getElementById('save-trade-post-btn');
        const tradePostHelpBtn = document.getElementById('trade-post-help-btn');
        const tradePostInfoModal = document.getElementById('trade-post-info-modal');
        const tradePostInfoCloseBtn = document.getElementById('trade-post-info-close-btn');
        const conflictModal = document.getElementById('conflict-modal');
        const conflictModalCloseBtn = document.getElementById('conflict-modal-close-btn');
        const setConflictBtn = document.getElementById('set-conflict-btn');
        const saveMapModal = document.getElementById('save-map-modal');
        const saveMapModalCloseBtn = document.getElementById('save-map-modal-close-btn');
        const saveMapSubmitBtn = document.getElementById('save-map-submit-btn');
        const importMapModal = document.getElementById('import-map-modal');
        const importMapModalCloseBtn = document.getElementById('import-map-modal-close-btn');
        const deletePromptModal = document.getElementById('delete-prompt-modal');
        const deletePromptCloseBtn = document.getElementById('delete-prompt-close-btn');
        const deletePromptConfirmBtn = document.getElementById('delete-prompt-confirm-btn');
        const deletePromptCancelBtn = document.getElementById('delete-prompt-cancel-btn');
        const confirmModal = document.getElementById('confirm-modal'), confirmModalConfirmBtn = document.getElementById('confirm-modal-confirm-btn'), confirmModalCancelBtn = document.getElementById('confirm-modal-cancel-btn');
        const helpModal = document.getElementById('help-modal');
        const helpModalCloseBtn = document.getElementById('help-modal-close-btn');
        const allianceModalCloseX = document.getElementById('alliance-modal-close-x');
        
        let transformWrapper;
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const serverSelectContainer = document.getElementById('server-select-container');
        const serverSelect = document.getElementById('server-select');
        const statsContainer = document.getElementById('stats-container');
        // Map Options
        const mapOptionsToggle = document.getElementById('map-options-toggle');
        const mapOptionsContainer = document.getElementById('map-options-container');
        const buffLegendContainer = document.getElementById('buff-legend-container');
        const buffToggleSwitch = document.getElementById('buff-toggle-switch');
        const levelToggleSwitch = document.getElementById('level-toggle-switch');
        const idToggleSwitch = document.getElementById('id-toggle-switch');
        const minimalModeSwitch = document.getElementById('minimal-mode-switch');

        // Action Dock Buttons
        const actionDock = document.getElementById('action-dock');
        const helpBtn = document.getElementById('help-btn');
        const saveMapBtn = document.getElementById('save-map-btn');
        const importMapBtn = document.getElementById('import-map-btn');
        const clearBtn = document.getElementById('clear-btn');

        // --- FIREBASE SETUP ---
        window.onload = function() {
            try {
                // PASTE YOUR FIREBASE CONFIG OBJECT HERE
                const firebaseConfig = {
  apiKey: "AIzaSyBX-Az_FFAeU-IoqE_PpuySCzcrdfKaAJc",
  authDomain: "s3interactive-61c98.firebaseapp.com",
  projectId: "s3interactive-61c98",
  storageBucket: "s3interactive-61c98.firebasestorage.app",
  messagingSenderId: "57533332370",
  appId: "1:57533332370:web:3f12b72fc59aa235121f4b"
};

                if (firebaseConfig && firebaseConfig.apiKey && firebaseConfig.apiKey !== "REPLACE_WITH_YOUR_API_KEY") {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    const auth = getAuth(app);
                    signInAnonymously(auth)
                        .then(() => {
                            console.log("Firebase initialized and signed in anonymously.");
                        })
                        .catch((error) => {
                            console.error("Anonymous sign-in failed:", error);
                            alert("Could not connect to the database. Save/Load features are disabled.");
                            saveMapBtn.disabled = true;
                            importMapBtn.disabled = true;
                        });
                } else {
                    console.warn("Firebase config not found or is placeholder. Database features will be disabled.");
                    saveMapBtn.disabled = true;
                    importMapBtn.disabled = true;
                }
            } catch (e) {
                console.error("Error initializing Firebase:", e);
                saveMapBtn.disabled = true;
                importMapBtn.disabled = true;
            }

            // Initialize the rest of the app
            setupServerSelection();
            initializeMap();
        };

        // --- DATA & LEVEL CALCULATION ---
        function calculatePlotData() {
            const externalData = new Map(
                externalDataCSV.trim().split('\n').slice(1).map(line => {
                    const [ID, Name, Type, BuffPercent, BuffType] = line.split(',');
                    return [ID, { Name, Type, Buff: `${BuffPercent} ${BuffType}` }];
                })
            );

            // Strongholds
            for (let i = 0; i < rows; i++) {
                for (let j = 0; j < cols; j++) {
                    const key = `${j + 1},${i + 1}`;
                    const customId = `S${String.fromCharCode(65 + i)}${(j + 1).toString().padStart(2, '0')}`;
                    const data = externalData.get(customId) || {};
                    const level = Math.min(i, rows - 1 - i, j, cols - 1 - j) + 1;
                    plotData[key] = { 
                        type: 'Stronghold', 
                        name: 'Stronghold', 
                        level: level, 
                        buff: data.Buff, 
                        alliance: null, 
                        customId: customId,
                        mithril: MITHRIL_RATES[level] || 0,
                        spice: 0,
                        captureOrder: null,
                        conflict: null,
                    };
                }
            }
            // Cities
            const cornerRows = rows - 1, cornerCols = cols - 1;
            for (let i = 0; i < cornerRows; i++) {
                for (let j = 0; j < cornerCols; j++) {
                    const key = `C(${j + 1.5},${i + 1.5})`;
                    const customId = `C${String.fromCharCode(65 + i)}${(j + 1).toString().padStart(2, '0')}`;
                    const data = externalData.get(customId) || {};
                    const level = Math.min(i, cornerRows - 1 - i, j, cornerCols - 1 - j) + 1;
                    plotData[key] = { 
                        type: 'City', 
                        name: data.Type || 'City', 
                        level: level, 
                        buff: data.Buff, 
                        alliance: null, 
                        customId: customId,
                        spice: data.Type === 'Trade Post' ? 0 : SPICE_RATES[level] || 0,
                        mithril: 0,
                        playerName: '',
                        captureOrder: null,
                        conflict: null,
                    };
                }
            }
        }
        
        // --- EFFICIENT UPDATE FUNCTIONS ---
        function getPlotCounts() {
            const counts = {};
            for (const allyKey in activeAlliances) {
                counts[allyKey] = { Stronghold: 0, City: 0 };
            }
            for (const key in plotData) {
                const plot = plotData[key];
                // IMPORTANT: Exclude Trade Posts from alliance city limits
                if (plot.alliance && counts[plot.alliance] && plot.name !== 'Trade Post') {
                    counts[plot.alliance][plot.type]++;
                }
            }
            return counts;
        }

        function updateElementStyle(key) {
            const el = plotElements.get(key);
            if (!el) return;

            const data = plotData[key] || {};
            const allianceKey = data.alliance;
            const allianceInfo = allianceKey ? activeAlliances[allianceKey] : null;
            
            const allClassesToRemove = [
                'bg-alliance-1', 'bg-alliance-2', 'bg-alliance-3', 'bg-alliance-4', 'bg-alliance-5', 
                'bg-alliance-6', 'bg-alliance-7', 'bg-alliance-8', 'bg-alliance-9', 'bg-alliance-10',
                'text-white', 'text-black', 'border-red-500', 'inner-glow-red',
                ...Object.values(cityLevelBorders),
                defaultMainPlotClasses.base,
                defaultCornerPlotClasses.base,
                'border-white', 
                'border-gray-500', 
                'gradient-iron', 'gradient-gold', 'gradient-food'
            ].flatMap(c => c.split(' '));

            el.classList.remove(...allClassesToRemove);

            if (data.conflict) {
                el.classList.add('border-red-500', 'inner-glow-red');
            } else if (data.type === 'Stronghold') {
                 if (allianceInfo) {
                    el.classList.add(allianceInfo.color, allianceInfo.textColor);
                 } else {
                    el.classList.add(...defaultMainPlotClasses.base.split(' '));
                 }
            } else if (data.type === 'City') {
                if (data.name === 'Trade Post') {
                    el.classList.add('border-white');
                    if (allianceInfo) {
                         el.classList.add(allianceInfo.color, allianceInfo.textColor);
                    } else {
                         el.classList.add(defaultCornerPlotClasses.base);
                    }
                } else { // Regular Cities
                    if (showCityLevels) {
                        const levelBorder = cityLevelBorders[data.level] || 'border-gray-600';
                        el.classList.add(levelBorder);
                    } else {
                        el.classList.add('border-gray-500');
                    }

                    if (allianceInfo) {
                        el.classList.add(allianceInfo.color, allianceInfo.textColor);
                    } else {
                        if (showCityBuffs) {
                            if (data.buff?.includes('Iron')) el.classList.add('gradient-iron');
                            else if (data.buff?.includes('Coin')) el.classList.add('gradient-gold');
                            else if (data.buff?.includes('Food')) el.classList.add('gradient-food');
                            else el.classList.add(defaultCornerPlotClasses.base);
                        } else {
                            el.classList.add(defaultCornerPlotClasses.base);
                        }
                    }
                }
            }
        }
        
        function updatePlotLabel(key) {
            const el = plotElements.get(key);
            const data = plotData[key];
            if (!el || !data) return;

            // Update capture order label
            let orderLabel = el.querySelector('.capture-order-label');
            if (data.captureOrder) {
                if (!orderLabel) {
                    orderLabel = document.createElement('div');
                    orderLabel.className = 'capture-order-label';
                    el.appendChild(orderLabel);
                }
                orderLabel.textContent = data.captureOrder.step;
                orderLabel.style.backgroundColor = captureOrderGroupColors[data.captureOrder.group];
                orderLabel.classList.remove('hidden');
            } else if (orderLabel) {
                orderLabel.classList.add('hidden');
            }

            const labelEl = el.querySelector('.plot-label');
            if (!labelEl) return;
            
            labelEl.className = 'plot-label text-center leading-none w-full';
            let labelText = '';
            const allyInfo = data.alliance ? activeAlliances[data.alliance] : null;

            if (data.conflict) {
                const [ally1, ally2] = data.conflict;
                const name1 = activeAlliances[ally1]?.name || 'N/A';
                const name2 = activeAlliances[ally2]?.name || 'N/A';
                labelEl.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full leading-tight">
                        <span class="text-xs font-bold">${name1}</span>
                        <i class="fa-solid fa-swords text-red-400 text-[10px] my-0.5"></i>
                        <span class="text-xs font-bold">${name2}</span>
                    </div>
                `;
            } else if (data.type === 'Stronghold') {
                if (allyInfo) {
                    labelEl.classList.add('font-bold', 'text-xs');
                    labelText = allyInfo.name;
                } else {
                    labelEl.classList.add('font-normal', 'text-xs', 'opacity-20', 'select-none', 'pointer-events-none');
                    labelText = isMinimalMode ? plotAcronyms.Stronghold : 'Stronghold';
                }
                 labelEl.textContent = labelText;
            } else { // Is a City
                labelEl.classList.add('font-semibold', 'text-[8px]');
                if (data.name === 'Trade Post') {
                    labelText = allyInfo ? allyInfo.name : (isMinimalMode ? plotAcronyms['Trade Post'] : 'Trade Post');
                } else {
                    labelText = isMinimalMode ? plotAcronyms[data.name] || data.name : data.name;
                }
                 labelEl.textContent = labelText;
            }
        }

        function updateAllStyles() {
            plotElements.forEach((el, key) => updateElementStyle(key));
        }
        
        function updateAllLabels() {
            plotElements.forEach((el, key) => updatePlotLabel(key));
        }

        function updateIdVisibility() {
            const idElements = document.querySelectorAll('.plot-id-label');
            idElements.forEach(el => {
                el.classList.toggle('hidden', !showLandIds);
            });
        }
        
        function updateAllianceStats() {
            const stats = {};
            let totalAssignments = 0;
            for (const allyKey in activeAlliances) {
                stats[allyKey] = { 
                    Stronghold: 0, 
                    City: 0, 
                    buffs: {},
                    totalSpice: 0,
                    totalMithril: 0
                };
            }
            const plotCounts = getPlotCounts();

            for (const key in plotData) {
                const plot = plotData[key];
                if (plot.alliance && stats[plot.alliance]) {
                    totalAssignments++;
                    stats[plot.alliance].totalSpice += plot.spice || 0;
                    stats[plot.alliance].totalMithril += plot.mithril || 0;

                    if (plot.buff && plot.buff !== 'NA NA') {
                        const buffParts = plot.buff.split(' ');
                        const value = parseFloat(buffParts[0]);
                        const type = buffParts.slice(1).join(' ');
                        if (!isNaN(value)) {
                            stats[plot.alliance].buffs[type] = (stats[plot.alliance].buffs[type] || 0) + value;
                        }
                    }
                }
            }

            serverSelectContainer.classList.toggle('hidden', totalAssignments > 0);

            if (totalAssignments === 0) {
                 statsContainer.innerHTML = `
                    <div class="text-xs text-slate-400 space-y-3 p-2 bg-black/20 rounded-lg">
                        <p class="font-bold text-slate-300">How to Use:</p>
                        <p><i class="fa-solid fa-hand-pointer fa-fw mr-1"></i>Click any plot to assign it.</p>
                        <p><i class="fa-solid fa-cloud-arrow-up fa-fw mr-1"></i>Use Save/Import to share maps.</p>
                        <p><i class="fa-solid fa-gear fa-fw mr-1"></i>Use 'Map Options' to customize the view.</p>
                        <p><i class="fa-solid fa-arrows-up-down-left-right fa-fw mr-1"></i>Drag or pan to move the map.</p>
                        <p><i class="fa-solid fa-magnifying-glass-plus fa-fw mr-1"></i>Use scroll wheel to zoom.</p>
                        <hr class="border-slate-700 my-2">
                        <p class="font-bold text-slate-300">City Level Legend:</p>
                        <p><span class="inline-block w-3 h-3 rounded-full border-2 border-purple-500 mr-2 align-middle"></span> Level 1</p>
                        <p><span class="inline-block w-3 h-3 rounded-full border-2 border-blue-500 mr-2 align-middle"></span> Level 2</p>
                        <p><span class="inline-block w-3 h-3 rounded-full border-2 border-green-500 mr-2 align-middle"></span> Level 3</p>
                        <p><span class="inline-block w-3 h-3 rounded-full border-2 border-yellow-500 mr-2 align-middle"></span> Level 4</p>
                        <p><span class="inline-block w-3 h-3 rounded-full border-2 border-orange-500 mr-2 align-middle"></span> Level 5</p>
                        <p><span class="inline-block w-3 h-3 rounded-full border-2 border-red-500 mr-2 align-middle"></span> Level 6</p>
                    </div>
                `;
                return;
            }

            statsContainer.innerHTML = '';
            for (const allyKey in stats) {
                const allyData = stats[allyKey];
                const allyInfo = activeAlliances[allyKey];
                const counts = plotCounts[allyKey];
                
                if (!allyInfo || (counts.Stronghold === 0 && counts.City === 0 && allyData.totalSpice === 0 && allyData.totalMithril === 0)) continue;

                const buffText = Object.entries(allyData.buffs).map(([type, value]) => `${type}: ${value.toFixed(1)}%`).join(', ');

                const summaryHTML = `
                    <div class="summary-item">
                        <h5 class="${allyInfo.textColor} ${allyInfo.color} text-center text-sm">${allyInfo.name}</h5>
                        <div class="stats-grid">
                            <div class="stat-item"><span class="stat-label">Strongholds:</span><span class="stat-value">${counts.Stronghold}/${landLimits.Stronghold}</span></div>
                            <div class="stat-item"><span class="stat-label">Cities:</span><span class="stat-value">${counts.City}/${landLimits.City}</span></div>
                            <div class="stat-item"><span class="stat-label">Mithril:</span><span class="stat-value">${allyData.totalMithril.toLocaleString()} pH</span></div>
                            <div class="stat-item"><span class="stat-label">Spice:</span><span class="stat-value">${allyData.totalSpice.toLocaleString()} pH</span></div>
                        </div>
                        ${buffText ? `<div class="buff-list text-slate-400"><strong>Buffs:</strong> ${buffText}</div>` : ''}
                    </div>
                `;
                statsContainer.innerHTML += summaryHTML;
            }
        }

        function updateViewTransform() {
            if (transformWrapper) {
                transformWrapper.style.transform = `translate(${view.x}px, ${view.y}px) scale(${view.zoom})`;
            }
        }

        function initializeMap() {
            calculatePlotData();
            app.innerHTML = '';

            transformWrapper = document.createElement('div');
            transformWrapper.style.transformOrigin = '0 0';
            
            const totalWidth = cols * cellWidth;
            const totalHeight = rows * cellHeight;
            const mapBackground = document.createElement('div');
            mapBackground.className = 'rounded-lg';
            mapBackground.style.cssText = `position: absolute; width: ${totalWidth}px; height: ${totalHeight}px; background-image: radial-gradient(ellipse at center, #4b5563 0%, #111827 80%); z-index: 1;`;
            transformWrapper.appendChild(mapBackground);

            const mainPlotGrid = document.createElement('div');
            mainPlotGrid.style.cssText = `display: grid; grid-template-columns: repeat(${cols}, ${cellWidth}px); grid-template-rows: repeat(${rows}, ${cellHeight}px); position: relative; z-index: 10;`;

            const cornerPlotContainer = document.createElement('div');
            cornerPlotContainer.className = 'absolute top-0 left-0 z-20';
            
            const createPlotHTML = (key) => {
                const data = plotData[key];
                if (!data) return '';
                
                return `<div class="relative w-full h-full flex items-center justify-center">
                            ${data.type === 'Stronghold' ? `<span class="absolute top-1 left-1/2 -translate-x-1/2 font-semibold text-xs">Lv${data.level || ''}</span>` : ''}
                            <span class="plot-label"></span>
                            <span class="plot-id-label hidden absolute left-1/2 -translate-x-1/2 text-[8px] italic opacity-50" style="bottom: -3px;">${data.customId}</span>
                        </div>`;
            };
            
            for (let i = 0; i < rows; i++) {
                for (let j = 0; j < cols; j++) {
                    const key = `${j + 1},${i + 1}`;
                    const el = document.createElement('div');
                    let borderRadiusClass = '';
                    if (i === 0 && j === 0) borderRadiusClass = 'rounded-tl-lg';
                    else if (i === 0 && j === cols - 1) borderRadiusClass = 'rounded-tr-lg';
                    else if (i === rows - 1 && j === 0) borderRadiusClass = 'rounded-bl-lg';
                    else if (i === rows - 1 && j === cols - 1) borderRadiusClass = 'rounded-br-lg';
                    
                    el.className = `plot text-xs hover-glow ${borderRadiusClass}`;
                    el.style.cssText = `grid-column: ${j + 1}; grid-row: ${i + 1};`;
                    el.innerHTML = createPlotHTML(key);
                    plotElements.set(key, el); 
                    updatePlotLabel(key); 
                    el.addEventListener('mouseenter', (e) => handleMouseEnter(e, key));
                    el.addEventListener('mouseleave', (e) => handleMouseLeave(e));
                    mainPlotGrid.appendChild(el);
                }
            }
            
            const cornerRows = rows - 1;
            const cornerCols = cols - 1;
            for (let i = 0; i < cornerRows; i++) {
                for (let j = 0; j < cornerCols; j++) {
                    const key = `C(${j + 1.5},${i + 1.5})`;
                    const el = document.createElement('div');
                    el.className = 'plot absolute text-xs rounded-lg hover-glow';
                    el.style.cssText = `top: ${(i + 1) * cellHeight}px; left: ${(j + 1) * cellWidth}px; transform: translate(-50%, -50%); width: ${cellWidth * cornerPlotSizeRatio}px; height: ${cellHeight * cornerPlotSizeRatio}px;`;
                    el.innerHTML = createPlotHTML(key);
                    plotElements.set(key, el);
                    updatePlotLabel(key); 
                    el.addEventListener('mouseenter', (e) => handleMouseEnter(e, key));
                    el.addEventListener('mouseleave', (e) => handleMouseLeave(e));
                    cornerPlotContainer.appendChild(el);
                }
            }
            transformWrapper.append(mainPlotGrid, cornerPlotContainer);
            app.appendChild(transformWrapper);
            
            // Center map on initial load
            view.x = (app.clientWidth - totalWidth * view.zoom) / 2;
            view.y = (app.clientHeight - totalHeight * view.zoom) / 2;

            updateAllStyles();
            updateViewTransform();
            updateAllianceStats();
            updateIdVisibility();
        }

        // --- EVENT HANDLERS ---
        function handleMouseEnter(e, key) {
            clearTimeout(hideTooltipTimer);
            if (dragInfo.isDragging) return;
            hoveredCell = key;
            const data = plotData[key] || {};
            const el = plotElements.get(key);
            if(el) {
                el.style.setProperty('--glow-color', 'rgba(190, 220, 255, 0.25)');
                 el.addEventListener('mousemove', updateTooltipPosition);
            }
            
            tooltipTitle.textContent = data.name || "Plot";
            tooltipId.textContent = data.customId || "";
            tooltipLevel.textContent = data.level || "N/A";
            
            if (data.name === 'Trade Post') {
                tooltipBuffP.classList.add('hidden');
                const allyInfo = data.alliance ? activeAlliances[data.alliance] : null;
                if (allyInfo) tooltipTitle.textContent = `${allyInfo.name}'s Trade Post`;
                
                if (data.playerName) {
                    tooltipOwner.textContent = data.playerName;
                    tooltipOwnerP.classList.remove('hidden');
                } else {
                    tooltipOwnerP.classList.add('hidden');
                }
            } else {
                tooltipBuffP.classList.remove('hidden');
                tooltipOwnerP.classList.add('hidden');
                tooltipBuff.textContent = data.buff || "N/A";
            }

            const hasResources = data.mithril > 0 || data.spice > 0;
            tooltipS3Resources.classList.toggle('hidden', !hasResources);

            if (data.mithril > 0) {
                tooltipMithril.textContent = `${data.mithril.toLocaleString()} / hr`;
                tooltipMithrilP.classList.remove('hidden');
            } else {
                tooltipMithrilP.classList.add('hidden');
            }

            if (data.spice > 0) {
                tooltipSpice.textContent = `${data.spice.toLocaleString()} / hr`;
                tooltipSpiceP.classList.remove('hidden');
            } else {
                tooltipSpiceP.classList.add('hidden');
            }

            tooltip.classList.remove('hidden');
            setTimeout(() => {
                tooltip.classList.add('visible');
            }, 10);
            updateTooltipPosition(e);
        }
        
        function handleMouseLeave(e) {
            hoveredCell = null;
            tooltip.classList.remove('visible');
            hideTooltipTimer = setTimeout(() => {
                tooltip.classList.add('hidden');
            }, 200); // Match the CSS transition duration

             if (e.currentTarget) {
                e.currentTarget.removeEventListener('mousemove', updateTooltipPosition);
            }
        }
        
        function updateTooltipPosition(e) {
            if (tooltip.classList.contains('hidden') && !tooltip.classList.contains('visible')) return;
            tooltip.style.left = `${e.pageX + 20}px`;
            tooltip.style.top = `${e.pageY + 20}px`;
        }
        
        function handleTouchStart(e) {
            e.preventDefault();
            if (e.touches.length === 1) {
                handleMouseDown(e.touches[0], findKeyFromElement(e.target));
            } else if (e.touches.length === 2) {
                dragInfo.isMouseDown = false; // Prevent drag from firing
                touchState.isPinching = true;
                touchState.initialPinchDistance = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                touchState.viewStartZoom = view.zoom;
            }
        }
        function handleTouchMove(e) {
            e.preventDefault();
            if (touchState.isPinching && e.touches.length === 2) {
                const newDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                const zoomFactor = newDist / touchState.initialPinchDistance;
                const newZoom = Math.max(0.5, Math.min(touchState.viewStartZoom * zoomFactor, 3));
                const rect = app.getBoundingClientRect();
                const x = ((e.touches[0].clientX + e.touches[1].clientX) / 2 - rect.left - view.x) / view.zoom;
                const y = ((e.touches[0].clientY + e.touches[1].clientY) / 2 - rect.top - view.y) / view.zoom;
                view.x -= x * (newZoom - view.zoom);
                view.y -= y * (newZoom - view.zoom);
                view.zoom = newZoom;
                updateViewTransform();
            } else if (dragInfo.isMouseDown && e.touches.length === 1) {
                handleMouseMove(e.touches[0]);
            }
        }
        function handleTouchEnd(e) {
            if (e.touches.length < 2) {
                touchState.isPinching = false;
            }
            handleMouseUp();
        }

        function handleMouseDown(e, key = null) {
            dragInfo.isMouseDown = true;
            Object.assign(dragInfo, { 
                isDragging: false, 
                startX: e.pageX, 
                startY: e.pageY, 
                viewStartX: view.x, 
                viewStartY: view.y, 
                clickedCell: key 
            });
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
        }
        
        function handleMouseMove(e) {
            if (!dragInfo.isMouseDown) return;
            if (!dragInfo.isDragging && (Math.abs(e.pageX - dragInfo.startX) > 5 || Math.abs(e.pageY - dragInfo.startY) > 5)) {
                dragInfo.isDragging = true;
                dragInfo.clickedCell = null; // It's a drag, not a tap
                tooltip.classList.add('hidden');
            }
            if (dragInfo.isDragging) {
                document.body.style.cursor = 'move';
                view.x = dragInfo.viewStartX + (e.pageX - dragInfo.startX);
                view.y = dragInfo.viewStartY + (e.pageY - dragInfo.startY);
                updateViewTransform();
            }
        }

        function handleMouseUp() {
            if (!dragInfo.isDragging && dragInfo.clickedCell) {
                openModalForCell(dragInfo.clickedCell);
            }
            document.body.style.cursor = 'default';
            dragInfo.isMouseDown = false;
            dragInfo.isDragging = false;
            dragInfo.clickedCell = null;
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);
        }

        function handleWheel(e) {
            e.preventDefault();
            const rect = app.getBoundingClientRect();
            const x = (e.clientX - rect.left - view.x) / view.zoom;
            const y = (e.clientY - rect.top - view.y) / view.zoom;
            const delta = -e.deltaY * 0.001;
            const newZoom = Math.max(0.5, Math.min(view.zoom + delta, 3));
            view.x -= x * (newZoom - view.zoom);
            view.y -= y * (newZoom - view.zoom);
            view.zoom = newZoom;
            updateViewTransform();
        }

        function findKeyFromElement(target) {
            const plotElement = target.closest('.plot');
            if (!plotElement) return null;
            for (const [key, el] of plotElements.entries()) {
                if (el === plotElement) {
                    return key;
                }
            }
            return null;
        }

        function openModalForCell(cellKey) {
            if (!cellKey) return;
            selectedCell = cellKey;
            const data = plotData[selectedCell] || {};
            modalPlotId.textContent = `ID: ${data.customId || ''} (${selectedCell})`;

            if (data.name === 'Trade Post') {
                modalTitle.textContent = `Assign Trade Post`;
                regularPlotSection.classList.add('hidden');
                tradePostSection.classList.remove('hidden');
                modalClearBtn.classList.remove('hidden');

                playerNameInput.value = data.playerName || '';
                tradePostAllianceButtons.innerHTML = '';
                selectedTradePostAlliance = data.alliance;

                Object.entries(activeAlliances).forEach(([allyKey, allyData]) => {
                    const btn = document.createElement('button');
                    btn.textContent = allyData.name;
                    btn.className = `alliance-assign-button ${allyData.color} ${allyData.textColor}`;
                    if (allyKey === selectedTradePostAlliance) {
                        btn.classList.add('ring-2', 'ring-white', 'ring-offset-2', 'ring-offset-gray-800');
                    }
                    btn.onclick = () => {
                        selectedTradePostAlliance = allyKey;
                        const allBtns = tradePostAllianceButtons.querySelectorAll('button');
                        allBtns.forEach(b => b.classList.remove('ring-2', 'ring-white', 'ring-offset-2', 'ring-offset-gray-800'));
                        btn.classList.add('ring-2', 'ring-white', 'ring-offset-2', 'ring-offset-gray-800');
                    };
                    tradePostAllianceButtons.appendChild(btn);
                });

            } else { // Regular Plots
                modalTitle.textContent = `Assign ${data.name}`;
                tradePostSection.classList.add('hidden');
                regularPlotSection.classList.remove('hidden');
                modalClearBtn.classList.remove('hidden');

                modalLevel.textContent = data.level || 'N/A';
                modalBuffEl.textContent = data.buff || 'N/A';
                modalMithrilEl.textContent = `${data.mithril?.toLocaleString() || '0'} pH`;
                modalSpiceEl.textContent = `${data.spice?.toLocaleString() || '0'} pH`;
                
                document.getElementById('modal-mithril-p').style.display = data.mithril > 0 ? 'flex' : 'none';
                document.getElementById('modal-spice-p').style.display = data.spice > 0 ? 'flex' : 'none';
                
                const plotCounts = getPlotCounts();
                modalAllianceList.innerHTML = '';
                Object.entries(activeAlliances).forEach(([allyKey, allyData]) => {
                    const btn = document.createElement('button');
                    btn.textContent = allyData.name;
                    btn.className = `alliance-assign-button ${allyData.color} ${allyData.textColor}`;
                    
                    const counts = plotCounts[allyKey];
                    if (counts) {
                        const isAtLimit = (counts[data.type] >= landLimits[data.type]);
                        if (isAtLimit && data.alliance !== allyKey) {
                            btn.disabled = true;
                        }
                    }

                    btn.onclick = () => {
                        if (btn.disabled) return;
                        plotData[selectedCell].alliance = allyKey;
                        plotData[selectedCell].conflict = null;
                        plotData[selectedCell].captureOrder = null;
                        updateElementStyle(selectedCell);
                        updatePlotLabel(selectedCell);
                        updateAllianceStats();
                        closeModal();
                    };
                    modalAllianceList.appendChild(btn);
                });
            }
            allianceModal.classList.remove('hidden');
        }
        
        function closeModal() {
            selectedCell = null;
            selectedTradePostAlliance = null;
            allianceModal.classList.add('hidden');
        }

        modalClearBtn.onclick = () => {
             if (selectedCell) {
                const plot = plotData[selectedCell];
                if(plot) {
                    plot.alliance = null;
                    plot.conflict = null;
                    plot.captureOrder = null;
                    if (plot.name === 'Trade Post') {
                        plot.playerName = '';
                    }
                }
                updateElementStyle(selectedCell);
                updatePlotLabel(selectedCell);
                updateAllianceStats();
                closeModal();
            }
        };
        
        allianceModalCloseX.onclick = closeModal;

        // Trade Post Listeners
        saveTradePostBtn.onclick = () => {
            if (selectedCell) {
                plotData[selectedCell].alliance = selectedTradePostAlliance;
                plotData[selectedCell].playerName = playerNameInput.value.trim();
                updateElementStyle(selectedCell);
                updatePlotLabel(selectedCell);
                updateAllianceStats();
                closeModal();
            }
        };

        tradePostHelpBtn.onclick = () => {
            tradePostInfoModal.classList.remove('hidden');
        };
        
        const allModals = [helpModal, allianceModal, tradePostInfoModal, saveMapModal, importMapModal, conflictModal, confirmModal, deletePromptModal];
        allModals.forEach(modal => {
            if(modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                    }
                });
            }
        });
        
        tradePostInfoCloseBtn.onclick = () => tradePostInfoModal.classList.add('hidden');
        conflictModalCloseBtn.onclick = () => conflictModal.classList.add('hidden');
        saveMapModalCloseBtn.onclick = () => saveMapModal.classList.add('hidden');
        importMapModalCloseBtn.onclick = () => importMapModal.classList.add('hidden');
        deletePromptCloseBtn.onclick = () => deletePromptModal.classList.add('hidden');
        deletePromptCancelBtn.onclick = () => deletePromptModal.classList.add('hidden');
        confirmModalCancelBtn.addEventListener('click', () => confirmModal.classList.add('hidden'));
        confirmModal.querySelector('#confirm-modal-close-btn')?.addEventListener('click', () => confirmModal.classList.add('hidden'));

        mapOptionsToggle.addEventListener('click', () => {
            mapOptionsContainer.classList.toggle('expanded');
            mapOptionsToggle.classList.toggle('expanded');
        });

        buffToggleSwitch.addEventListener('change', (e) => {
            showCityBuffs = e.target.checked;
            buffLegendContainer.classList.toggle('hidden', !showCityBuffs);
            updateAllStyles();
        });
        
        levelToggleSwitch.addEventListener('change', (e) => {
            showCityLevels = e.target.checked;
            updateAllStyles();
        });

        idToggleSwitch.addEventListener('change', (e) => {
            showLandIds = e.target.checked;
            updateIdVisibility();
        });

        minimalModeSwitch.addEventListener('change', (e) => {
            isMinimalMode = e.target.checked;
            updateAllLabels();
        });

        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
        });

        clearBtn.addEventListener('click', () => {
            confirmModal.querySelector('#confirm-modal-body').textContent = 'This will clear all plot assignments for the current server. This action cannot be undone.';
            confirmModal.querySelector('#confirm-modal-confirm-btn').onclick = () => {
                for (const key in plotData) {
                    plotData[key].alliance = null;
                    plotData[key].playerName = '';
                    plotData[key].conflict = null;
                    plotData[key].captureOrder = null;
                }
                updateAllLabels();
                updateAllStyles();
                updateAllianceStats();
                confirmModal.classList.add('hidden');
            };
            confirmModal.classList.remove('hidden');
        });

        confirmModalCancelBtn.addEventListener('click', () => {
            confirmModal.classList.add('hidden');
        });

        function generateMapState() {
            const assignments = [];
            for (const key in plotData) {
                const plot = plotData[key];
                if (plot.alliance) {
                    assignments.push(`${plot.customId}:${plot.alliance}`);
                } else if (plot.conflict) {
                    assignments.push(`${plot.customId};conflict:${plot.conflict.join(':')}`);
                } else if (plot.name === 'Trade Post' && plot.playerName) {
                     assignments.push(`${plot.customId};player:${plot.playerName}`);
                }
            }
            return assignments.join(',');
        }

        function applyState(code) {
             if (code) {
                // Clear existing assignments first
                for (const key in plotData) {
                    plotData[key].alliance = null;
                    plotData[key].playerName = '';
                    plotData[key].conflict = null;
                    plotData[key].captureOrder = null;
                }
                // Apply imported assignments
                const assignments = code.split(',');
                const plotDataByCustomId = Object.fromEntries(Object.entries(plotData).map(([key, data]) => [data.customId, data]));
                
                assignments.forEach(assignment => {
                    const parts = assignment.split(/[:;]/);
                    const plot = plotDataByCustomId[parts[0]];
                    if (!plot) return;

                    if (assignment.includes(';conflict:')) {
                        const conflictParts = assignment.split(':');
                        plot.conflict = [conflictParts[1], conflictParts[2]];
                    } else if (assignment.includes(';player:')) {
                         const playerParts = assignment.split(':');
                         plot.playerName = playerParts[1];
                    } else if (assignment.includes(':')) {
                        const regularParts = assignment.split(':');
                        const allyKey = regularParts[1];
                        if (activeAlliances[allyKey]) {
                            plot.alliance = allyKey;
                        }
                    }
                });

                updateAllLabels();
                updateAllStyles();
                updateAllianceStats();
            }
        }

        saveMapBtn.addEventListener('click', () => {
            saveMapModal.classList.remove('hidden');
        });

        saveMapSubmitBtn.addEventListener('click', async () => {
            if (!db) {
                alert("Database not initialized. Please check Firebase configuration.");
                return;
            }
            const mapName = document.getElementById('save-map-name').value.trim();
            const playerName = document.getElementById('save-player-name').value.trim();
            const description = document.getElementById('save-map-description').value.trim();
            const deletePassword = document.getElementById('save-delete-password').value;
            const serverId = serverSelect.value;

            if (!mapName || !playerName) {
                alert("Map Name and Your Name are required.");
                return;
            }

            const mapData = generateMapState();
            
            try {
                await addDoc(collection(db, "maps"), {
                    serverId,
                    mapName,
                    playerName,
                    description,
                    mapData,
                    deletePassword: deletePassword || null,
                    createdAt: serverTimestamp()
                });
                saveMapModal.classList.add('hidden');
                alert("Map saved successfully!");
            } catch (e) {
                console.error("Error adding document: ", e);
                alert("Failed to save map. See console for details.");
            }
        });

        async function refreshImportList() {
             const mapListDiv = document.getElementById('import-map-list');
            mapListDiv.innerHTML = '<p>Loading maps...</p>';
            
            try {
                const q = query(collection(db, "maps"), where("serverId", "==", serverSelect.value));
                const querySnapshot = await getDocs(q);
                mapListDiv.innerHTML = '';
                if (querySnapshot.empty) {
                    mapListDiv.innerHTML = '<p>No saved maps found for this server.</p>';
                    return;
                }
                querySnapshot.forEach((doc) => {
                    const map = doc.data();
                    const mapEl = document.createElement('div');
                    mapEl.className = 'bg-slate-800/50 p-4 rounded-lg flex items-center gap-4';
                    mapEl.innerHTML = `
                        <div class="flex-grow">
                            <h4 class="font-bold text-emerald-400">${map.mapName}</h4>
                            <p class="text-sm text-slate-400 italic">by ${map.playerName}</p>
                            <p class="text-sm mt-1">${map.description || 'No description.'}</p>
                        </div>
                        <div class="flex flex-col gap-2">
                            <button class="bg-sky-600 text-white py-1 px-3 rounded-lg font-semibold hover:bg-sky-500 transition-colors text-sm">Load</button>
                            <button class="bg-red-800 text-white py-1 px-3 rounded-lg font-semibold hover:bg-red-700 transition-colors text-sm">Delete</button>
                        </div>
                    `;
                    mapEl.querySelector('.bg-sky-600').addEventListener('click', () => {
                        applyState(map.mapData);
                        importMapModal.classList.add('hidden');
                    });
                     mapEl.querySelector('.bg-red-800').addEventListener('click', () => handleDeleteMap(doc.id, map.deletePassword));
                    mapListDiv.appendChild(mapEl);
                });
            } catch (e) {
                console.error("Error fetching maps: ", e);
                mapListDiv.innerHTML = '<p class="text-red-500">Failed to load maps. See console for details.</p>';
            }
        }
        
        importMapBtn.addEventListener('click', () => {
             if (!db) {
                alert("Database not initialized. Please check Firebase configuration.");
                return;
            }
            importMapModal.classList.remove('hidden');
            refreshImportList();
        });

        async function handleDeleteMap(docId, storedPassword) {
            if (storedPassword) {
                deletePromptModal.classList.remove('hidden');
                document.getElementById('delete-password-input').value = '';
                
                deletePromptConfirmBtn.onclick = async () => {
                    const enteredPassword = document.getElementById('delete-password-input').value;
                    if (enteredPassword === storedPassword || enteredPassword === MASTER_DELETE_PASSWORD) {
                        await deleteDoc(doc(db, "maps", docId));
                        deletePromptModal.classList.add('hidden');
                        refreshImportList();
                    } else {
                        alert("Incorrect password.");
                    }
                };
            } else {
                if (confirm("Are you sure you want to delete this map? This action cannot be undone.")) {
                    await deleteDoc(doc(db, "maps", docId));
                    refreshImportList();
                }
            }
        }


        function setupServerSelection() {
            const serverIds = Object.keys(serverData);
            serverSelect.innerHTML = serverIds.map(id => `<option value="${id}">Server ${id}</option>`).join('');
            serverSelect.value = '899'; // Default server
            activeAlliances = serverData['899'];

            serverSelect.addEventListener('change', (e) => {
                const newServerId = e.target.value;
                activeAlliances = serverData[newServerId];
                // Clear all assignments when changing servers
                for (const key in plotData) {
                    plotData[key].alliance = null;
                    plotData[key].playerName = '';
                }
                updateAllLabels();
                updateAllStyles();
                updateAllianceStats();
            });
        }
        
        helpBtn.addEventListener('click', () => {
            helpModal.classList.remove('hidden');
            if (window.innerWidth <= 768) {
                sidebar.classList.add('collapsed');
            }
        });
        helpModalCloseBtn.addEventListener('click', () => helpModal.classList.add('hidden'));

        // Action Dock Tooltips
        actionDock.addEventListener('mouseover', (e) => {
            const button = e.target.closest('.action-button');
            if (button && button.title) {
                actionTooltip.textContent = button.title;
                actionTooltip.classList.remove('hidden');
                actionTooltip.style.opacity = '1';
                const buttonRect = button.getBoundingClientRect();
                actionTooltip.style.top = `${buttonRect.top + buttonRect.height / 2 - actionTooltip.offsetHeight / 2}px`;
                actionTooltip.style.left = `${buttonRect.left - actionTooltip.offsetWidth - 10}px`;
            }
        });
        actionDock.addEventListener('mouseout', (e) => {
            const button = e.target.closest('.action-button');
            if (button) {
                 actionTooltip.style.opacity = '0';
                 setTimeout(() => actionTooltip.classList.add('hidden'), 100);
            }
        });

        document.getElementById('modal-conflict-btn').addEventListener('click', () => {
            openConflictModal();
        });

        function openConflictModal() {
            const list1 = document.getElementById('conflict-alliance-1-list');
            const list2 = document.getElementById('conflict-alliance-2-list');
            list1.innerHTML = '';
            list2.innerHTML = '';

            let selectedAlliance1 = null;
            let selectedAlliance2 = null;

            const createClickHandler = (list, btn, key, isList1) => {
                return () => {
                    if (isList1) selectedAlliance1 = key;
                    else selectedAlliance2 = key;

                    list.querySelectorAll('button').forEach(b => b.classList.remove('ring-2', 'ring-white'));
                    btn.classList.add('ring-2', 'ring-white');
                };
            };
            
            Object.entries(activeAlliances).forEach(([key, data]) => {
                const btn1 = document.createElement('button');
                btn1.textContent = data.name;
                btn1.className = `w-full text-left p-2 rounded ${data.color} ${data.textColor}`;
                btn1.onclick = createClickHandler(list1, btn1, key, true);
                list1.appendChild(btn1);

                const btn2 = document.createElement('button');
                btn2.textContent = data.name;
                btn2.className = `w-full text-left p-2 rounded ${data.color} ${data.textColor}`;
                btn2.onclick = createClickHandler(list2, btn2, key, false);
                list2.appendChild(btn2);
            });

            setConflictBtn.onclick = () => {
                if (selectedCell && selectedAlliance1 && selectedAlliance2) {
                    const plot = plotData[selectedCell];
                    plot.conflict = [selectedAlliance1, selectedAlliance2];
                    plot.alliance = null; // Clear regular assignment
                    plot.captureOrder = null;
                    updateElementStyle(selectedCell);
                    updatePlotLabel(selectedCell);
                    conflictModal.classList.add('hidden');
                    closeModal();
                }
            };

            conflictModal.classList.remove('hidden');
        }


        // --- STARTUP ---
        if (window.innerWidth <= 768) {
            sidebar.classList.add('collapsed');
        }
        app.addEventListener('wheel', handleWheel, { passive: false });
        // Mouse Listeners
        app.addEventListener('mousedown', (e) => handleMouseDown(e, findKeyFromElement(e.target)));
        // Touch Listeners
        app.addEventListener('touchstart', handleTouchStart, { passive: false });
        app.addEventListener('touchmove', handleTouchMove, { passive: false });
        app.addEventListener('touchend', handleTouchEnd);
        app.addEventListener('touchcancel', handleTouchEnd);
        
        setupServerSelection();
        initializeMap();
        
    </script>
</body>
</html>
