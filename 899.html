<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Last War: Survival - 899 Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        :root {
            --color-bg: #0D1117;
            --color-primary: #00BFFF; /* Brighter Blue */
            --color-highlight: #F87171; /* High-contrast Red */
            --color-glass-bg: rgba(22, 27, 34, 0.40); 
            --color-dropdown-bg: rgba(22, 27, 34, 0.95);
        }

        @keyframes pulse-live {
            0%, 100% { box-shadow: 0 0 5px var(--color-primary); }
            50% { box-shadow: 0 0 10px var(--color-primary); }
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--color-bg); color: #c9d1d9; }
        
        #particle-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: radial-gradient(circle at top left, rgba(0, 191, 255, 0.1), transparent 40%), radial-gradient(circle at bottom right, rgba(248, 113, 113, 0.1), transparent 40%);
        }
        
        .glass-pane {
            background-color: var(--color-glass-bg);
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border-radius: 1rem; border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .header-main { 
            padding: 0.75rem 1.5rem; 
            position: relative;
            z-index: 50;
        }
        .nav-item { position: relative; }
        .nav-link {
            position: relative; padding: 0.5rem; font-weight: 600; font-size: 0.75rem;
            color: #c9d1d9; transition: color 0.3s ease; display: flex;
            flex-direction: column; align-items: center; gap: 0.25rem;
            width: 80px; cursor: pointer;
        }
        .nav-link i { font-size: 1rem; }
        .nav-link:hover { color: #fff; }
        .nav-link::after {
            content: ''; position: absolute; bottom: 0; left: 20%; right: 20%; height: 2px;
            background-color: var(--color-primary); transform: scaleX(0);
            transform-origin: center; transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
        }
        .nav-item:hover .nav-link::after, .nav-link.active::after { transform: scaleX(1); }
        .nav-link.active { color: #fff; }
        
        .dropdown-menu {
            position: absolute; top: calc(100% + 12px); left: 50%;
            transform: translateX(-50%) translateY(-10px);
            opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0s 0.3s;
            z-index: 100;
            padding: 0.5rem;
            min-width: 180px;
            border-top: 2px solid var(--color-primary);
            background-color: var(--color-dropdown-bg);
        }
        .nav-item:hover .dropdown-menu,
        .nav-item.open .dropdown-menu {
            transform: translateX(-50%) translateY(0);
            opacity: 1; visibility: visible;
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0s 0s;
        }
        .dropdown-link {
            display: block; padding: 0.6rem 1rem; border-radius: 0.5rem;
            font-size: 0.875rem; color: #c9d1d9;
            transition: background-color 0.2s ease, color 0.2s ease;
            white-space: nowrap; cursor: pointer;
        }
        .dropdown-link:hover { background-color: rgba(0, 191, 255, 0.1); color: #fff; }

        .auth-button {
            padding: 0.6rem 1.25rem; font-weight: 600; font-size: 0.875rem;
            color: #c9d1d9; background-color: rgba(255,255,255,0.05);
            border-radius: 0.5rem; border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            display: flex; align-items: center; gap: 0.5rem;
        }
        .auth-button:hover {
            color: #fff; background-color: rgba(0, 191, 255, 0.1);
            border-color: var(--color-primary);
        }

        .section-container { padding: 1.25rem; }
        .event-card {
            background-color: rgba(13, 17, 23, 0.7); border-radius: 0.75rem;
            overflow: hidden; transition: all 0.3s ease;
            display: flex; flex-direction: column; border: 1px solid rgba(255,255,255,0.1);
        }
        .event-card:hover { box-shadow: 0 0 10px 0px var(--color-primary); }
        .live-indicator { animation: pulse-live 2s infinite; }

        .carousel-viewport { overflow: hidden; }
        .carousel-track { display: flex; transition: transform 0.5s ease-in-out; }
        .carousel-slide { display: grid; grid-template-columns: repeat(1, 1fr); gap: 1rem; flex: 0 0 100%; }
        @media (min-width: 640px) { .carousel-slide { grid-template-columns: repeat(2, 1fr); } }
        @media (min-width: 1024px) { .carousel-slide { grid-template-columns: repeat(3, 1fr); } }
        .carousel-button:disabled { opacity: 0.3; cursor: not-allowed; }
        
        .toggle-button {
            position: relative; padding: 0.75rem 1rem; font-size: 0.9rem;
            font-weight: 600; color: #8b949e;
            background-color: transparent; border: none;
            transition: color 0.3s ease;
        }
        .toggle-button:hover { color: #c9d1d9; }
        .toggle-button.active { color: #fff; }
        .toggle-button::after {
            content: ''; position: absolute; bottom: 0.5rem; left: 1rem; right: 1rem; height: 2px;
            background-color: var(--color-primary); transform: scaleX(0);
            transition: transform 0.3s ease-in-out;
        }
        .toggle-button.active::after { transform: scaleX(1); }

        .podium-card {
            display: flex; flex-direction: column; text-align: center;
            padding: 1.5rem; transition: all 0.3s ease;
        }
        .podium-gold { border-image: linear-gradient(to bottom, #FFD700, #FBBF24) 1; }
        .podium-silver { border-image: linear-gradient(to bottom, #C0C0C0, #D1D5DB) 1; }
        .podium-bronze { border-image: linear-gradient(to bottom, #CD7F32, #D97706) 1; }

        .styled-table { width: 100%; border-collapse: collapse; }
        .styled-table th, .styled-table td { padding: 0.75rem 1rem; text-align: left; vertical-align: middle; }
        .styled-table thead { border-bottom: 2px solid var(--color-primary); }
        .styled-table th { font-size: 0.875rem; font-weight: 700; color: #fff; text-transform: uppercase; letter-spacing: 0.05em; }
        .styled-table tbody tr { border-bottom: 1px solid rgba(255, 255, 255, 0.1); transition: background-color 0.2s ease; }
        .styled-table tbody tr:last-child { border-bottom: none; }
        .styled-table tbody tr:hover { background-color: rgba(0, 191, 255, 0.05); }
        .styled-table .tag { font-weight: 800; color: #fff; }
        .action-button {
            background: rgba(255,255,255,0.1); border-radius: 0.375rem;
            padding: 0.5rem; transition: all 0.2s ease;
        }
        .action-button:hover { background: var(--color-primary); color: #0D1117; }
        
        /* Modal Styles */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            display: none; /* Hidden by default */
        }
        .modal-container {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            z-index: 1001;
            width: 90%;
            max-width: 500px;
            opacity: 0;
            transition: all 0.3s ease;
            display: none; /* Hidden by default */
        }
        .modal-backdrop.visible, .modal-container.visible {
            opacity: 1;
            display: block;
        }
        .modal-container.visible {
             transform: translate(-50%, -50%) scale(1);
        }
        .form-input {
            background-color: rgba(13, 17, 23, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #c9d1d9;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(0, 191, 255, 0.3);
        }
        .primary-btn {
            background-color: var(--color-primary);
            color: var(--color-bg);
            font-weight: 700;
            transition: background-color 0.3s ease;
        }
        .primary-btn:hover {
            background-color: #00a9e0;
        }
    </style>
</head>
<body class="bg-custom-gradient">
    <canvas id="particle-canvas"></canvas>

    <!-- Auth Modal -->
    <div id="auth-modal-backdrop" class="modal-backdrop"></div>
    <div id="auth-modal-container" class="modal-container">
        <div class="glass-pane p-6 sm:p-8">
            <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-white transition-colors">
                <i class="fas fa-times fa-lg"></i>
            </button>
            <!-- Login Form -->
            <div id="login-form-container">
                <h2 class="text-2xl font-bold text-white text-center mb-4">Login</h2>
                <p class="text-center text-gray-400 mb-6">Welcome back to the 899 Hub.</p>
                <form id="login-form">
                    <div class="space-y-4">
                        <input type="email" id="login-email" placeholder="Email" class="w-full p-3 rounded-lg form-input" required>
                        <input type="password" id="login-password" placeholder="Password" class="w-full p-3 rounded-lg form-input" required>
                    </div>
                    <div class="flex justify-between items-center mt-4 mb-6 text-sm">
                        <a href="#" id="forgot-password-link" class="text-gray-400 hover:text-white">Forgot Password?</a>
                    </div>
                    <button type="submit" class="w-full p-3 rounded-lg primary-btn">Login</button>
                    <p class="text-center text-sm text-gray-400 mt-6">
                        Don't have an account? <a href="#" id="show-register-form" class="font-semibold hover:text-white" style="color: var(--color-primary);">Register here</a>
                    </p>
                </form>
            </div>
            <!-- Registration Form -->
            <div id="register-form-container" style="display: none;">
                <h2 class="text-2xl font-bold text-white text-center mb-4">Create Account</h2>
                <p class="text-center text-gray-400 mb-6">Join the 899 community.</p>
                <form id="register-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="register-username" placeholder="Username" class="w-full p-3 rounded-lg form-input md:col-span-2" required>
                        <input type="email" id="register-email" placeholder="Email" class="w-full p-3 rounded-lg form-input md:col-span-2" required>
                        <input type="password" id="register-password" placeholder="Password" class="w-full p-3 rounded-lg form-input" required>
                        <input type="password" id="register-password-verify" placeholder="Verify Password" class="w-full p-3 rounded-lg form-input" required>
                        
                        <select id="register-alliance" class="w-full p-3 rounded-lg form-input" required>
                            <option value="" disabled selected>Select Alliance</option>
                            <option value="THOR">THOR</option><option value="fAfO">fAfO</option><option value="HeRA">HeRA</option>
                            <option value="pHNx">pHNx</option><option value="TroW">TroW</option><option value="VaLT">VaLT</option>
                            <option value="COLD">COLD</option><option value="Tone">Tone</option><option value="DoM">DoM</option>
                            <option value="MINI">MINI</option><option value="MEGA">MEGA</option><option value="Lat1">Lat1</option>
                            <option value="WSKT">WSKT</option><option value="ValT">ValT</option><option value="BRSL">BRSL</option>
                            <option value="TCM1">TCM1</option><option value="BLSD">BLSD</option><option value="REI">REI</option>
                            <option value="wpg1">wpg1</option><option value="SHRK">SHRK</option>
                        </select>
                        <select id="register-alliance-rank" class="w-full p-3 rounded-lg form-input" required>
                            <option value="" disabled selected>Select Alliance Rank</option>
                            <option value="R5">R5</option><option value="R4">R4</option><option value="R3">R3</option>
                            <option value="R2">R2</option><option value="R1">R1</option>
                        </select>

                        <input type="text" id="register-power" placeholder="Total Power (e.g., 150,000,000)" class="power-input w-full p-3 rounded-lg form-input md:col-span-2" required>
                        <input type="text" id="register-tank-power" placeholder="Tank Power" class="power-input w-full p-3 rounded-lg form-input" required>
                        <input type="text" id="register-air-power" placeholder="Air Power" class="power-input w-full p-3 rounded-lg form-input" required>
                        <input type="text" id="register-missile-power" placeholder="Missile Power" class="power-input w-full p-3 rounded-lg form-input md:col-span-2" required>
                    </div>
                    <button type="submit" class="w-full p-3 rounded-lg primary-btn mt-6">Register</button>
                     <p id="register-error" class="text-red-400 text-center text-sm mt-4"></p>
                    <p class="text-center text-sm text-gray-400 mt-6">
                        Already have an account? <a href="#" id="show-login-form" class="font-semibold hover:text-white" style="color: var(--color-primary);">Login here</a>
                    </p>
                </form>
            </div>
        </div>
    </div>

    <div class="relative min-h-screen w-full p-4 sm:p-6 lg:p-8">
        <div class="max-w-6xl mx-auto">

            <header class="glass-pane header-main flex justify-between items-center mb-6">
                <div class="flex-shrink-0">
                    <h1 class="text-2xl md:text-3xl font-black tracking-tighter text-white">899<span class="font-bold" style="color: var(--color-primary);">EVENTS</span></h1>
                    <p class="text-xs text-gray-400">Official Event Hub</p>
                </div>
                
                <nav id="main-nav" class="hidden md:flex flex-grow justify-center items-center">
                    <div class="nav-item"><div class="nav-link"><i class="fas fa-shield-alt"></i><span>Alliances</span></div><div class="dropdown-menu glass-pane"><a class="dropdown-link" data-target="page-top-alliances">Top Alliances</a><a class="dropdown-link" data-target="page-alliance-list">Alliance List</a><a class="dropdown-link" data-target="page-recruitment">Recruitment</a></div></div>
                    <div class="nav-item"><div class="nav-link" data-main-target="page-players"><i class="fas fa-users"></i><span>Players</span></div></div>
                    <div class="nav-item"><div class="nav-link active" data-main-target="page-events"><i class="fas fa-calendar-alt"></i><span>Events</span></div></div>
                    <div class="nav-item"><div class="nav-link"><i class="fas fa-trophy"></i><span>Season</span></div><div class="dropdown-menu glass-pane"><a class="dropdown-link" data-target="page-season-overview">Season Overview</a><a class="dropdown-link" data-target="page-season-rewards">Rewards</a><a class="dropdown-link" data-target="page-season-history">History</a></div></div>
                    <div class="nav-item"><div class="nav-link"><i class="fas fa-tools"></i><span>Tools</span></div><div class="dropdown-menu glass-pane"><a class="dropdown-link" data-target="page-calculators">Calculators</a><a class="dropdown-link" data-target="page-guides">Guides</a></div></div>
                    <div class="nav-item"><div class="nav-link"><i class="fas fa-globe"></i><span>Language</span></div><div class="dropdown-menu glass-pane"><a href="#" class="dropdown-link">English</a><a href="#" class="dropdown-link">Espa√±ol</a><a href="#" class="dropdown-link">Deutsch</a></div></div>
                </nav>

                <div id="auth-container" class="hidden md:flex flex-shrink-0">
                    <button id="login-btn" class="auth-button"><i class="fas fa-sign-in-alt fa-fw mr-2"></i>Login</button>
                    <button id="logout-btn" class="auth-button hidden"><i class="fas fa-sign-out-alt fa-fw mr-2"></i>Logout</button>
                </div>
                <button class="md:hidden text-white"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg></button>
            </header>

            <!-- Page Content Container -->
            <div id="page-container">

                <!-- Events Page (Visible by default) -->
                <div id="page-events" class="page-content">
                    <div class="flex items-center justify-center flex-wrap mb-6" id="event-toggles">
                        <button class="toggle-button active" data-filter="all">All Events</button>
                        <button class="toggle-button" data-filter="seasonal-events">Seasonal</button>
                        <button class="toggle-button" data-filter="server-events">Server-Wide</button>
                        <button class="toggle-button" data-filter="arms-race-events">Arms Race</button>
                        <button class="toggle-button" data-filter="alliance-events">Alliance</button>
                    </div>
                    <main class="space-y-8" id="events-main-container">
                        <!-- Event sections will be populated dynamically from Firestore -->
                        <section id="seasonal-events" class="glass-pane section-container event-section">
                             <h2 class="text-xl font-bold border-l-4 pl-3 mb-4" style="border-color: var(--color-primary);">Seasonal Events</h2>
                             <p class="text-gray-400">No active seasonal events. Check back later!</p>
                        </section>
                         <section id="server-events" class="glass-pane section-container event-section">
                             <h2 class="text-xl font-bold border-l-4 pl-3 mb-4" style="border-color: var(--color-primary);">Server-Wide Events</h2>
                             <p class="text-gray-400">No active server-wide events. Check back later!</p>
                        </section>
                    </main>
                </div>

                <!-- Top Alliances Page -->
                <div id="page-top-alliances" class="page-content" style="display: none;">
                    <div class="glass-pane section-container">
                        <h2 class="text-3xl font-bold text-white text-center mb-8">Top Alliances</h2>
                        <!-- Podium will be populated dynamically from Firestore -->
                         <p class="text-center text-gray-400">Alliance ranking data is being calculated. Please check back soon.</p>
                    </div>
                </div>
                <!-- Alliance List Page -->
                <div id="page-alliance-list" class="page-content" style="display: none;">
                    <div class="glass-pane section-container">
                        <h2 class="text-3xl font-bold text-white text-center mb-4">Alliance List</h2>
                        <div class="mb-6">
                            <input type="text" placeholder="Search by tag or name..." class="w-full bg-gray-900/50 border border-gray-700 rounded-lg px-4 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                        </div>
                        <div class="overflow-x-auto">
                            <table class="styled-table">
                                <thead>
                                    <tr>
                                        <th>Tag</th>
                                        <th>Name</th>
                                        <th>Power</th>
                                        <th>Leader</th>
                                        <th>Vacancy</th>
                                    </tr>
                                </thead>
                                <tbody id="alliance-list-body">
                                    <!-- Alliance data will be populated dynamically from Firestore -->
                                     <tr><td colspan="5" class="text-center py-8 text-gray-400">No alliance data available.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- Players Page -->
                <div id="page-players" class="page-content" style="display: none;">
                    <div class="glass-pane section-container">
                        <h2 class="text-3xl font-bold text-white text-center mb-4">Registered Players</h2>
                        <div class="mb-6">
                            <input type="text" placeholder="Search for a player..." class="w-full bg-gray-900/50 border border-gray-700 rounded-lg px-4 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                        </div>
                        <div class="overflow-x-auto">
                            <table class="styled-table">
                                <thead>
                                    <tr>
                                        <th class="w-12"></th>
                                        <th>Alliance</th>
                                        <th>Name</th>
                                        <th>Alliance Rank</th>
                                        <th>Total Power</th>
                                        <th>Tanks</th>
                                        <th>Air</th>
                                        <th>Missiles</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="player-list-body">
                                    <!-- Player data will be populated dynamically from Firestore -->
                                     <tr><td colspan="9" class="text-center py-8 text-gray-400">No registered players found. Please register to be listed.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- Other Placeholder Pages -->
                <div id="page-recruitment" class="page-content" style="display: none;"><div class="glass-pane section-container"><h2 class="text-2xl font-bold text-white">Recruitment</h2></div></div>
                <div id="page-season-overview" class="page-content" style="display: none;"><div class="glass-pane section-container"><h2 class="text-2xl font-bold text-white">Season Overview</h2></div></div>
                <div id="page-season-rewards" class="page-content" style="display: none;"><div class="glass-pane section-container"><h2 class="text-2xl font-bold text-white">Season Rewards</h2></div></div>
                <div id="page-season-history" class="page-content" style="display: none;"><div class="glass-pane section-container"><h2 class="text-2xl font-bold text-white">Season History</h2></div></div>
                <div id="page-calculators" class="page-content" style="display: none;"><div class="glass-pane section-container"><h2 class="text-2xl font-bold text-white">Calculators</h2></div></div>
                <div id="page-guides" class="page-content" style="display: none;"><div class="glass-pane section-container"><h2 class="text-2xl font-bold text-white">Guides</h2></div></div>
            </div>

            <footer class="text-center mt-12 py-4 border-t border-gray-800/50"><p class="text-gray-500">&copy; 2024 Last War Survival - Server 899 Community.</p></footer>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // TODO: Add your Firebase project's configuration here
        const firebaseConfig = {
        apiKey: "AIzaSyA8KKDjjw0Pb_wknZ3TRWuL7-7XMo4VeY0",
        authDomain: "events-ea397.firebaseapp.com",
        projectId: "events-ea397",
        storageBucket: "events-ea397.firebasestorage.app",
        messagingSenderId: "51859633788",
        appId: "1:51859633788:web:3653d3e7edb6d3c1c4fbf9",
        measurementId: "G-0ZCMZ86PJD"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- AUTHENTICATION & FIRESTORE LOGIC ---

        const authModalBackdrop = document.getElementById('auth-modal-backdrop');
        const authModalContainer = document.getElementById('auth-modal-container');
        const loginFormContainer = document.getElementById('login-form-container');
        const registerFormContainer = document.getElementById('register-form-container');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const closeBtn = document.getElementById('close-modal-btn');

        function showModal() {
            authModalBackdrop.classList.add('visible');
            authModalContainer.classList.add('visible');
        }

        function hideModal() {
            authModalBackdrop.classList.remove('visible');
            authModalContainer.classList.remove('visible');
        }

        loginBtn.addEventListener('click', showModal);
        closeBtn.addEventListener('click', hideModal);
        authModalBackdrop.addEventListener('click', hideModal);

        document.getElementById('show-register-form').addEventListener('click', (e) => {
            e.preventDefault();
            loginFormContainer.style.display = 'none';
            registerFormContainer.style.display = 'block';
        });

        document.getElementById('show-login-form').addEventListener('click', (e) => {
            e.preventDefault();
            registerFormContainer.style.display = 'none';
            loginFormContainer.style.display = 'block';
        });
        
        // Handle Auth State Changes
        onAuthStateChanged(auth, user => {
            if (user) {
                // User is signed in
                loginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                hideModal();
                // You can fetch user profile here if needed
            } else {
                // User is signed out
                loginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
            }
        });
        
        // Login Form Submission
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    // Signed in 
                    console.log('User logged in:', userCredential.user);
                })
                .catch((error) => {
                    console.error("Login Error:", error);
                    alert(error.message);
                });
        });

        // Logout
        logoutBtn.addEventListener('click', () => {
            signOut(auth).catch(error => console.error("Logout error:", error));
        });

        // Registration Form Submission
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const errorElement = document.getElementById('register-error');
            errorElement.textContent = '';

            const username = document.getElementById('register-username').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const passwordVerify = document.getElementById('register-password-verify').value;
            const alliance = document.getElementById('register-alliance').value;
            const allianceRank = document.getElementById('register-alliance-rank').value;
            
            // Helper to parse formatted number strings
            const parsePower = (str) => parseInt(str.replace(/,/g, ''), 10) || 0;

            const power = parsePower(document.getElementById('register-power').value);
            const tankPower = parsePower(document.getElementById('register-tank-power').value);
            const airPower = parsePower(document.getElementById('register-air-power').value);
            const missilePower = parsePower(document.getElementById('register-missile-power').value);

            if (password !== passwordVerify) {
                errorElement.textContent = "Passwords do not match.";
                return;
            }
            if (!username || !email || !alliance || !allianceRank) {
                 errorElement.textContent = "Please fill out all fields.";
                 return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Now create the user document in Firestore
                const registrationTimestamp = new Date();
                const userProfile = {
                    uid: user.uid,
                    username: username,
                    email: email, // Stored for backend use, not public display
                    alliance: alliance,
                    allianceRank: allianceRank,
                    power: power,
                    tankPower: tankPower,
                    airPower: airPower,
                    missilePower: missilePower,
                    likes: 0,
                    registrationTimestampKST: registrationTimestamp.toLocaleString('en-US', { timeZone: 'Asia/Seoul' }),
                    registrationTimestampUTC: registrationTimestamp.toISOString(),
                    browserLanguage: navigator.language || navigator.userLanguage
                };

                // Use a 'users' collection. The document ID will be the user's UID.
                await setDoc(doc(db, "users", user.uid), userProfile);
                
                console.log('User registered and profile created:', user.uid);
                hideModal();

            } catch (error) {
                console.error("Registration Error:", error);
                errorElement.textContent = error.message;
            }
        });

        // Forgot Password
        document.getElementById('forgot-password-link').addEventListener('click', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            if (!email) {
                alert('Please enter your email address in the email field first.');
                return;
            }
            sendPasswordResetEmail(auth, email)
                .then(() => {
                    alert('Password reset email sent! Please check your inbox.');
                })
                .catch((error) => {
                    alert(error.message);
                });
        });

        // --- UTILITY & UI SCRIPTS ---

        // Particle animation script
        const canvas = document.getElementById('particle-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];

        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        function createParticles() {
            particles = []; let particleCount = (canvas.width * canvas.height) / 10000;
            for (let i = 0; i < particleCount; i++) {
                particles.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, vx: (Math.random() - 0.5) * 0.5, vy: (Math.random() - 0.5) * 0.5, size: Math.random() * 1.5 + 0.5, color: Math.random() > 0.3 ? 'rgba(0, 191, 255, 0.5)' : 'rgba(248, 113, 113, 0.1)' });
            }
        }
        function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => {
                p.x += p.vx; p.y += p.vy;
                if (p.x < 0 || p.x > canvas.width) p.vx *= -1;
                if (p.y < 0 || p.y > canvas.height) p.vy *= -1;
                ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); ctx.fill();
            });
            requestAnimationFrame(animateParticles);
        }
        window.addEventListener('resize', () => { resizeCanvas(); createParticles(); });
        resizeCanvas(); createParticles(); animateParticles();

        // UI Interaction script
        document.addEventListener('DOMContentLoaded', () => {
            const navItems = document.querySelectorAll('.nav-item');
            const navLinks = document.querySelectorAll('.nav-link');
            const dropdownLinks = document.querySelectorAll('.dropdown-link');
            const pages = document.querySelectorAll('.page-content');

            function showPage(targetId) {
                pages.forEach(page => {
                    page.style.display = page.id === targetId ? 'block' : 'none';
                });
                
                let activeSet = false;
                navLinks.forEach(link => {
                    const mainTarget = link.dataset.mainTarget;
                    const parentItem = link.closest('.nav-item');
                    const dropdowns = parentItem.querySelectorAll('.dropdown-link');
                    let isParentOfActive = false;

                    dropdowns.forEach(ddLink => {
                        if (ddLink.dataset.target === targetId) {
                           isParentOfActive = true;
                        }
                    });

                    if (mainTarget === targetId || isParentOfActive) {
                        link.classList.add('active');
                        activeSet = true;
                    } else {
                        link.classList.remove('active');
                    }
                });
                 if (!activeSet) {
                    const eventsLink = document.querySelector('.nav-link[data-main-target="page-events"]');
                    if (eventsLink) eventsLink.classList.add('active');
                }
            }

            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const wasOpen = item.classList.contains('open');
                    navItems.forEach(i => i.classList.remove('open'));
                    if (!wasOpen) {
                        item.classList.add('open');
                    }
                });
                 item.addEventListener('mouseenter', () => {
                    if (document.querySelector('.nav-item.open')) {
                         navItems.forEach(i => i.classList.remove('open'));
                         item.classList.add('open');
                    }
                });
            });

            dropdownLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const targetId = link.dataset.target;
                    if (targetId) {
                        showPage(targetId);
                    }
                    navItems.forEach(i => i.classList.remove('open'));
                });
            });

            navLinks.forEach(link => {
                if (link.dataset.mainTarget) {
                    link.addEventListener('click', () => {
                        showPage(link.dataset.mainTarget);
                    });
                }
            });

            window.addEventListener('click', () => {
                navItems.forEach(item => item.classList.remove('open'));
            });

            showPage('page-events'); 

            // Format power inputs with commas
            document.querySelectorAll('.power-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    let value = e.target.value.replace(/,/g, '');
                    if (isNaN(value)) {
                        e.target.value = '';
                        return;
                    }
                    e.target.value = Number(value).toLocaleString('en-US');
                });
            });
        });
    </script>
</body>
</html>
