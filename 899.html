<!-- 
===============================================
FIREBASE SECURITY RULES (FIRESTORE)
===============================================
NOTE: The 'if' statements in these rules are the correct and required syntax for Firestore Security Rules (version 2) on 'allow' lines.

rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- HELPER FUNCTIONS ---
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function getUserData(userId) {
      // Caching user data reads can optimize rule execution.
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }

    function isAdmin() {
      return isSignedIn() && getUserData(request.auth.uid).isAdmin == true;
    }
    
    function isVerified() {
      return isSignedIn() && getUserData(request.auth.uid).isVerified == true;
    }
    
    function isLeader() {
        let userRank = getUserData(request.auth.uid).allianceRank;
        return isAdmin() || (isVerified() && (userRank == 'R5' || userRank == 'R4'));
    }

    function isMemberOf(allianceId) {
        return isSignedIn() && getUserData(request.auth.uid).alliance == allianceId;
    }

    // --- USER DATA, FRIENDS & PRESENCE ---
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || canManageUser(userId);
      allow delete: if isOwner(userId);
    }
    
    // Friend requests, friends list, etc.
    match /users/{userId}/{subcollection}/{docId} {
        allow read, write: if isSignedIn() && (isOwner(userId) || request.auth.uid == docId);
    }

    // This collection stores the real-time presence status of users.
    match /sessions/{userId} {
      // Everyone can read presence information to see who is online.
      allow read: if true; 
      // A user can only write to their own session document.
      allow write: if isOwner(userId);
    }
    
    // --- NOTIFICATIONS ---
    match /notifications/{notificationId} {
        allow read, update, delete: if isSignedIn() && isOwner(resource.data.recipientUid);
        allow create: if isSignedIn(); // Any signed-in user can create a notification (e.g., friend request)
    }


    function canManageUser(targetUserId) {
      let managerData = getUserData(request.auth.uid);
      let targetData = getUserData(targetUserId);
      return isSignedIn() && (
        managerData.isAdmin == true ||
        (
          managerData.alliance == targetData.alliance &&
          (
            (managerData.allianceRank == 'R5' && ['R4', 'R3', 'R2', 'R1'].includes(targetData.allianceRank)) ||
            (managerData.allianceRank == 'R4' && ['R3', 'R2', 'R1'].includes(targetData.allianceRank))
          )
        )
      );
    }

    // --- POSTS (ANNOUNCEMENTS & EVENTS) ---
    match /posts/{postId} {
      allow read: if true;
      allow create: if canCreatePost(request.resource.data);
      allow update, delete: if isOwner(resource.data.authorUid) || isAdmin();
    }
    
    function canCreatePost(postData) {
      let userRank = getUserData(request.auth.uid).allianceRank;
      return isOwner(postData.authorUid) && (
        isAdmin() ||
        (
          !(postData.subType == 'server' || postData.subType == 'seasonal' || postData.subType == 'hot_deals' || postData.subType == 'wanted_boss' || postData.subType == 'campaign' || postData.subType == 'vs') &&
          !(!isVerified() && postData.subType == 'alliance' && postData.mainType == 'event') &&
          (
            (postData.subType == 'alliance' && (userRank == 'R5' || userRank == 'R4')) ||
            (postData.subType == 'leadership' && userRank == 'R5')
          )
        )
      );
    }
    
    // --- CHAT CHANNELS ---
    match /world_chat/{messageId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn() && request.resource.data.authorUid == request.auth.uid;
        allow update, delete: if isAdmin();
    }
    
    match /leadership_chat/{messageId} {
        allow read, create: if isLeader();
        allow update, delete: if isAdmin();
    }
    
    match /alliance_chats/{allianceId}/messages/{messageId} {
        allow read, create: if isMemberOf(allianceId);
        allow update, delete: if (isLeader() && isMemberOf(allianceId));
    }
    
    // --- ALLIANCE-SPECIFIC EVENTS & ANNOUNCEMENTS ---
    match /alliance_chats/{allianceId}/announcements/{announcementId} {
        allow read: if isMemberOf(allianceId);
        allow create, update, delete: if isLeader() && isMemberOf(allianceId);
    }
    
    match /alliance_chats/{allianceId}/events/{eventId} {
        allow read: if isMemberOf(allianceId);
        allow create, update, delete: if isLeader() && isMemberOf(allianceId);
    }
  }
}

/*
===============================================
FIREBASE REALTIME DATABASE RULES
===============================================
These rules are for managing user presence via the Realtime Database,
which provides superior `onDisconnect` handling.

{
  "rules": {
    "status": {
      "$uid": {
        ".read": "auth != null",
        ".write": "auth != null && auth.uid === $uid"
      }
    }
  }
}

*/
-->

<!-- 
===============================================
FIREBASE SECURITY RULES (STORAGE)
===============================================
These rules should be deployed to your Firebase project's Storage settings.

rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    match /avatars/{userId} {
      allow read;
      allow write: if request.auth != null 
                   && request.auth.uid == userId
                   && request.resource.size < 2 * 1024 * 1024 // Max 2MB for larger images
                   && request.resource.contentType.matches('image/.*');
    }

    match /post_thumbnails/{postId} {
        allow read;
        allow write: if request.auth != null
                     && request.resource.size < 2 * 1024 * 1024 // Max 2MB for larger images
                     && request.resource.contentType.matches('image/.*');
    }
  }
}
-->

<!--
===============================================
CHANGELOG
===============================================
- Prompt 60 (Current):
    - Replaced "Season" nav button with a new "Feed" notification system.
    - Feed dropdown shows real-time notifications for friend requests, verification requests, and alliance announcements.
    - Added a notification badge with an unread count to the Feed button.
    - Implemented functionality for sending friend requests from player cards.
    - Implemented accepting/declining friend requests from the notification feed.
    - Alliance leaders (R4/R5) now receive verification requests for new members.
    - Alliance members now receive notifications for new alliance-specific announcements.
    - Updated Firestore security rules to support the new `notifications` collection.
- Prompt 59:
    - Integrated real-time user presence (Online, Away, Offline).
    - Uses Firebase Realtime Database for robust `onDisconnect` handling.
    - User status changes to 'Away' after 5 minutes of inactivity.
    - Status indicators (dots) added to Player cards and Chat messages.
    - Added a pre-loader to prevent content flash before authentication check completes.
- Prompt 58:
    - Implemented full real-time chat functionality for World, Alliance, and Leadership channels.
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Last War: Survival - 899 Dashboard</title>
    <link rel="icon" href="data:,">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        :root {
            --color-bg: #0D1117;
            --color-primary: #00BFFF;
            --color-primary-glow: rgba(0, 191, 255, 0.5);
            --color-highlight: #F87171;
            --color-glass-bg: rgba(22, 27, 34, 0.6); 
            --color-dropdown-bg: rgba(18, 24, 33, 0.98);
            
            /* Post/Event Theme Colors */
            --post-color-server: #ff00d0;
            --post-color-seasonal: #9370DB;
            --post-color-leadership: #C0C0C0;
            --post-color-alliance: #00BFFF;
            --post-color-hot_deals: #FF6347;
            --post-color-wanted_boss: #DC143C;
            --post-color-campaign: #32CD32;
            --post-color-vs: #0077ff;
        }

        @keyframes pulse-border-horizontal { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        @keyframes pulse-opacity { 50% { opacity: 0.6; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes success-pop { 0% { transform: scale(0.7); opacity: 0; } 80% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); } }
        @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
        @keyframes spin { to { transform: rotate(360deg); } }

        html { font-size: 90%; }
        body { font-family: 'Exo 2', sans-serif; background-color: var(--color-bg); color: #c9d1d9; overflow-x: hidden; }
        #app-preloader { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--color-bg); z-index: 9999; display: flex; align-items: center; justify-content: center; transition: opacity 0.5s ease; }
        .spinner { width: 50px; height: 50px; border: 4px solid rgba(255, 255, 255, 0.2); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; }
        #app-container { display: none; } /* Initially hidden */
        #particle-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at top left, rgba(0, 191, 255, 0.05), transparent 30%), radial-gradient(circle at bottom right, rgba(248, 113, 113, 0.05), transparent 30%); }
        .glass-pane { background: linear-gradient(135deg, rgba(22, 27, 34, 0.6), rgba(22, 27, 34, 0.3)); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 1rem; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); }
        .header-main { padding: 0.75rem 1.5rem; position: relative; z-index: 50; }
        .nav-item { position: relative; }
        .nav-link { position: relative; padding: 0.5rem; font-weight: 600; font-size: 0.75rem; color: #c9d1d9; transition: color 0.3s ease; display: flex; flex-direction: column; align-items: center; gap: 0.25rem; width: 80px; cursor: pointer; }
        .nav-link i { font-size: 1rem; }
        .nav-link:hover, .nav-link.active { color: #fff; }
        .nav-link::after { content: ''; position: absolute; bottom: 0; left: 20%; right: 20%; height: 2px; background-color: var(--color-primary); transform: scaleX(0); transform-origin: center; transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1); }
        .nav-item:hover .nav-link::after, .nav-link.active::after { transform: scaleX(1); }
        .dropdown-pane { position: absolute; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, transform 0.3s ease, visibility 0s 0.3s; z-index: 100; padding: 0.5rem; min-width: 180px; border-top: 2px solid var(--color-primary); }
        .dropdown-menu { top: calc(100% + 12px); left: 50%; transform: translateX(-50%) translateY(-10px); }
        .nav-item.open .dropdown-menu { transform: translateX(-50%) translateY(0); opacity: 1; visibility: visible; transition: opacity 0.3s ease, transform 0.3s ease, visibility 0s 0s; }
        .dropdown-link { display: block; padding: 0.6rem 1rem; border-radius: 0.5rem; font-size: 0.875rem; color: #c9d1d9; transition: background-color 0.2s ease, color 0.2s ease; white-space: nowrap; cursor: pointer; }
        .dropdown-link:hover { background-color: rgba(0, 191, 255, 0.1); color: #fff; }
        .auth-button { padding: 0.6rem 1.25rem; font-weight: 600; font-size: 0.875rem; color: #c9d1d9; background-color: rgba(255,255,255,0.05); border-radius: 0.5rem; border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem; }
        .auth-button:hover { color: #fff; background-color: rgba(0, 191, 255, 0.1); border-color: var(--color-primary); }
        .section-container { padding: 1.25rem; }
        .modal-backdrop { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); z-index: 1000; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        .modal-container { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.95); z-index: 1001; width: 90%; max-width: 450px; opacity: 0; transition: all 0.3s ease; pointer-events: none; }
        .modal-backdrop.visible, .modal-container.visible { opacity: 1; pointer-events: auto; }
        .modal-container.visible { transform: translate(-50%, -50%) scale(1); }
        .auth-form { display: none; animation: fadeIn 0.5s forwards; }
        .auth-form.active { display: block; }
        .modal-content-wrapper { padding: 1.5rem; max-height: 85vh; display: flex; flex-direction: column; }
        .modal-content-scroll { overflow-y: auto; padding-right: 1rem; margin-right: -1rem; }
        .modal-content-scroll::-webkit-scrollbar { width: 8px; }
        .modal-content-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 10px; }
        .modal-content-scroll::-webkit-scrollbar-thumb { background: var(--color-primary); border-radius: 10px; }
        .modal-content-scroll::-webkit-scrollbar-thumb:hover { background: #00a9e0; }
        .input-group { position: relative; display: flex; align-items: center; background-color: rgba(13, 17, 23, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 0.5rem; transition: border-color 0.3s ease, box-shadow 0.3s ease; }
        .input-group:focus-within { border-color: var(--color-primary); box-shadow: 0 0 0 2px var(--color-primary-glow), inset 0 1px 2px rgba(0,0,0,0.5); }
        .input-icon { padding: 0 0.75rem; color: #667; border-right: 1px solid rgba(255, 255, 255, 0.1); }
        .input-group:focus-within .input-icon { color: var(--color-primary); }
        .form-input, .form-textarea { background-color: transparent; border: none; color: #c9d1d9; padding: 0.75rem; width: 100%; }
        .form-input:focus, .form-textarea:focus { outline: none; box-shadow: none; }
        .form-textarea { min-height: 100px; resize: vertical; }
        .primary-btn { background: linear-gradient(to right, #00BFFF, #1E90FF); color: white; font-weight: 700; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0, 191, 255, 0.2); }
        .primary-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 191, 255, 0.3); }
        .primary-btn:disabled { background: #555; cursor: not-allowed; transform: none; box-shadow: none; }
        .secondary-btn { background-color: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #c9d1d9; font-weight: 600; transition: all 0.3s ease; }
        .secondary-btn:hover { background-color: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); }
        .form-error { min-height: 20px; }
        .progress-bar { display: flex; justify-content: space-between; margin-bottom: 1.5rem; position: relative; }
        .progress-bar::before { content: ''; position: absolute; top: 50%; left: 0; transform: translateY(-50%); height: 2px; width: 100%; background-color: rgba(255,255,255,0.1); z-index: -1; }
        .progress-bar .line { position: absolute; top: 50%; left: 0; transform: translateY(-50%); height: 2px; background-color: var(--color-primary); width: 0%; transition: width 0.4s ease; z-index: 0; }
        .progress-step { width: 25px; height: 25px; background-color: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.4s ease; position: relative; z-index: 1; }
        .progress-step.active { background-color: var(--color-primary); border-color: var(--color-primary); color: var(--color-bg); }
        .form-slide { display: none; animation: fadeIn 0.5s ease-in-out; }
        .form-slide.active { display: block; }
        .custom-select-container { position: relative; flex-grow: 1; }
        .custom-select-value { display: flex; align-items: center; justify-content: space-between; width: 100%; text-align: left; }
        .custom-select-options { display: block; position: absolute; left: 0; right: 0; max-height: 200px; overflow-y: auto; z-index: 1050; opacity: 0; visibility: hidden; transform: scaleY(0.95); transition: opacity 0.2s ease, transform 0.2s ease, visibility 0s 0.2s; background-color: var(--color-dropdown-bg); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.5rem; padding: 0.5rem; }
        .custom-select-options.open-down { top: calc(100% + 8px); transform-origin: top; }
        .custom-select-options.open-up { bottom: calc(100% + 8px); transform-origin: bottom; }
        .custom-select-container.open .custom-select-options { opacity: 1; visibility: visible; transform: scaleY(1); transition: opacity 0.2s ease, transform 0.2s ease, visibility 0s 0s; }
        .custom-select-option { display: block; padding: 0.75rem 1rem; cursor: pointer; border-radius: 0.375rem; }
        .custom-select-option:hover { background-color: rgba(0, 191, 255, 0.1); }
        .custom-select-search { background-color: rgba(13, 17, 23, 1); border: none; border-bottom: 1px solid rgba(255,255,255,0.2); padding: 0.75rem; width: 100%; color: #c9d1d9; }
        .custom-select-search:focus { outline: none; border-color: var(--color-primary); }
        .custom-select-options::-webkit-scrollbar { width: 8px; }
        .custom-select-options::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 10px; }
        .custom-select-options::-webkit-scrollbar-thumb { background: var(--color-primary); border-radius: 10px; }
        .custom-select-options::-webkit-scrollbar-thumb:hover { background: #00a9e0; }
        #mobile-nav-menu { position: fixed; top: 0; right: 0; bottom: 0; width: 280px; z-index: 1100; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); background: linear-gradient(225deg, rgba(22, 27, 34, 0.9), rgba(13, 17, 23, 0.98)); }
        #mobile-nav-menu.open { transform: translateX(0); }
        .mobile-nav-link { display: flex; align-items: center; padding: 0.75rem 1.5rem; font-size: 1rem; font-weight: 600; color: #c9d1d9; border-radius: 0.5rem; transition: background-color 0.2s, color 0.2s; }
        .mobile-nav-link:hover, .mobile-nav-link.active { background-color: rgba(0, 191, 255, 0.1); color: #fff; }
        .section-header { display: flex; align-items: center; gap: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid; border-image: linear-gradient(to right, var(--glow-color, var(--color-primary)), transparent) 1; }
        
        /* --- Filter Buttons --- */
        .filter-btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
            margin-bottom: .25rem;
        }
        .filter-btn {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            border-radius: 6px;
            border: 1px solid #30363d;
            background-color: rgba(33, 38, 45, 0.5);
            color: #8b949e;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .filter-btn:hover {
            background-color: #30363d;
            color: #c9d1d9;
        }
        .filter-btn.active {
            color: #fff;
            border-color: var(--glow-color, var(--color-primary));
            background-color: var(--glow-color-bg, rgba(0, 191, 255, 0.1));
            box-shadow: 0 0 8px -2px var(--glow-color, var(--color-primary));
        }

        /* --- Gamer UI Card Styles --- */
        .post-card {
            background: linear-gradient(145deg, #212832, #161B22);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            padding: 0;
            display: flex;
            min-height: 80px; /* Made more compact */
            animation: fadeIn 0.5s ease-out;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .post-card:hover {
            transform: translateY(-4px);
        }
        .post-card-thumbnail-wrapper {
            flex-shrink: 0;
            width: 110px; /* Slightly smaller */
            clip-path: polygon(0 0, 100% 0, 85% 100%, 0% 100%);
            position: relative;
            border-radius: 8px 0 0 8px;
            overflow: hidden;
        }
        .post-card-thumbnail {
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            transition: transform 0.4s ease;
        }
        .post-card:hover .post-card-thumbnail {
            transform: scale(1.1);
        }
        .post-card-body {
            display: flex;
            flex-grow: 1;
            justify-content: space-between;
            align-items: center;
            padding: 0.0rem 1rem; /* Reduced padding */
            gap: 0.75rem;
        }
        .post-card-content {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            justify-content: center;
        }
        .post-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        .post-card-category {
            color: #ffffff;
            padding: 0.2rem 0.5rem; 
            font-size: .6rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-radius: 4px;
            align-self: flex-start;
        }
        .post-card-title {
            font-size: 1.3rem; /* Adjusted size */
            font-weight: 700;
            color: #fff;
            line-height: 1.2;
            margin-top: 0.1rem;
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        .post-card-details {
            display: block;
            font-size: 0.95rem; /* Increased size */
            color: #a0a8b1;
            margin-top: 0.25rem;
            line-height: 1.4;
            max-height: 2.8em; /* 2 lines */
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .post-card-status {
            text-align: right;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            justify-content: center;
        }
        .post-card-status .status-label {
            font-size: 0.75rem;
            font-weight: 100;
            text-transform: uppercase;
            color: #a0a8b1;
            letter-spacing: 0.5px;
        }
        .post-card-status .status-time {
            font-size: 1.5rem;
            font-weight: 500;
            color: #fff;
            line-height: 1;
        }
        .status-date {
            font-size: 0.7rem;
            color: #8b949e;
            margin-top: 0.1rem;
            font-weight: 600;
        }
        .event-card.live .post-card-status .status-time {
            text-shadow: 0 0 8px var(--glow-color);
        }
        .post-card::before {
            content: '';
            position: absolute;
            top: -2px; left: -2px; right: -2px; bottom: -2px;
            background: linear-gradient(120deg, transparent, var(--glow-color), transparent);
            background-size: 200% 100%;
            z-index: -1;
            border-radius: 10px;
            opacity: 0;
            transition: opacity 0.4s ease;
            animation: pulse-border-horizontal 3s ease-in-out infinite, pulse-opacity 2s ease-in-out infinite;
        }
        .event-card.live {
             box-shadow: 0 0 6px -1px var(--glow-color);
        }
        .event-card.live::before {
            opacity: 1;
        }
        .event-card.upcoming { filter: grayscale(100%); opacity: .45; }
        .event-card.upcoming::before { opacity: 0 !important; animation: none !important; }
        .event-card.upcoming { box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .post-card.event-card.upcoming:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.4); }
        .event-card.ended .post-card-thumbnail { filter: grayscale(80%); }
        .event-card.ended { background: linear-gradient(145deg, #2a2f37, #1e2229); }
        
        .post-card-actions-trigger {
            position: absolute;
            bottom: 8px;
            left: 8px;
            width: 32px;
            height: 32px;
            background-color: rgba(0, 0, 0, 0.6);
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 0;
            transform: scale(0.8);
            z-index: 10;
        }
        .post-card:hover .post-card-actions-trigger {
            opacity: 1;
            transform: scale(1);
        }
        .post-card-actions-trigger:hover {
            background-color: rgba(0, 0, 0, 0.8);
            transform: scale(1.1);
        }
        .actions-modal-btn {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            width: 100%;
            padding: 0.75rem 1rem;
            font-weight: 600;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .actions-modal-btn.edit:hover {
            background-color: rgba(0, 191, 255, 0.1);
            color: #fff;
        }
        .actions-modal-btn.delete:hover {
            background-color: rgba(248, 113, 113, 0.1);
            color: var(--color-highlight);
        }
        
        /* Skeleton Loader Styles */
        .skeleton-loader {
            background: linear-gradient(to right, #2c3440 0%, #38414e 20%, #2c3440 40%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite linear;
            border-radius: 4px;
        }
        .skeleton-card .skeleton-loader { opacity: 0.7; }

        /* Social Page & Presence Styles */
        .social-tabs {
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .social-tab-btn {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            color: #8b949e;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
        }
        .social-tab-btn:hover {
            color: #c9d1d9;
        }
        .social-tab-btn.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }
        .social-content-pane {
            display: none;
            animation: fadeIn 0.4s;
        }
        .social-content-pane.active {
            display: block;
        }
        .chat-window {
            height: 60vh;
            background-color: rgba(13, 17, 23, 0.5);
            border-radius: 0.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse;
        }
        .chat-message {
            padding: 0.5rem 1rem;
            display: flex;
            gap: 0.75rem;
            align-items: flex-start;
            position: relative;
        }
        .chat-message:hover .delete-message-btn {
            opacity: 1;
        }
        .chat-message.self {
            flex-direction: row-reverse;
        }
        .chat-message-bubble {
            max-width: 70%;
            padding: 0.5rem 0.75rem;
            border-radius: 0.75rem;
            background-color: #21262d;
            word-wrap: break-word;
        }
        .chat-message.self .chat-message-bubble {
            background-color: var(--color-primary);
            color: #0D1117;
        }
        .chat-message-author {
            font-weight: 700;
            font-size: 0.8rem;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .chat-message.self .chat-message-author {
            color: #0D1117;
        }
        .delete-message-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(220, 20, 60, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 10px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .chat-message:not(.self) .delete-message-btn {
            right: -25px;
        }
        .chat-message.self .delete-message-btn {
            left: -25px;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #6e7681; /* Offline */
        }
        .status-dot.online {
            background-color: #238636; /* Online */
            box-shadow: 0 0 5px #238636;
        }
        .status-dot.away {
            background-color: #d29922; /* Away */
        }
        .player-card-header .status-dot {
            margin-left: 0.5rem;
        }
        
        /* Feed / Notification Styles */
        .notification-badge {
            position: absolute;
            top: 0;
            right: 12px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: var(--color-highlight);
            color: white;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: scale(0);
            transition: transform 0.2s ease-in-out;
        }
        .notification-badge.visible {
            transform: scale(1);
        }
        #feed-dropdown {
            width: 360px;
            max-height: 400px;
            overflow-y: auto;
            right: 0;
            left: auto;
            transform: translateX(0) translateY(-10px);
        }
        .nav-item.open #feed-dropdown {
             transform: translateX(0) translateY(0);
        }
        .notification-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
            cursor: pointer;
            border-left: 3px solid transparent;
        }
        .notification-item:not(.is-read) {
            background-color: rgba(0, 191, 255, 0.05);
            border-left-color: var(--color-primary);
        }
        .notification-item:hover {
            background-color: rgba(0, 191, 255, 0.1);
        }
        .notification-icon {
            flex-shrink: 0;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        .notification-content {
            flex-grow: 1;
        }
        .notification-text {
            font-size: 0.875rem;
            line-height: 1.4;
        }
        .notification-time {
            font-size: 0.75rem;
            color: #8b949e;
            margin-top: 0.25rem;
        }
        .notification-actions {
            margin-top: 0.75rem;
            display: flex;
            gap: 0.5rem;
        }
        .notification-action-btn {
            flex-grow: 1;
            padding: 0.3rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 0.375rem;
        }

    </style>
</head>
<body>
    <div id="app-preloader">
        <div class="spinner"></div>
    </div>

    <div id="app-container">
        <canvas id="particle-canvas"></canvas>

        <!-- Mobile Nav Menu -->
        <div id="mobile-nav-menu" class="glass-pane !rounded-l-lg !rounded-r-none">
            <div class="p-4 flex justify-between items-center border-b border-white/10">
                <h3 class="text-xl font-bold text-white">Menu</h3>
                <button id="close-mobile-menu-btn" class="text-gray-400 hover:text-white"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <nav id="mobile-nav-links" class="flex flex-col p-2"></nav>
        </div>

        <!-- Auth & Edit Modals -->
        <div id="modal-backdrop" class="modal-backdrop"></div>
        <div id="auth-modal-container" class="modal-container">
            <div class="glass-pane">
                <div class="modal-content-wrapper">
                    <button id="close-auth-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-white transition-colors z-10">
                        <i class="fas fa-times fa-lg"></i>
                    </button>
                    <div class="modal-content-scroll">
                        <!-- Login Form -->
                        <div id="login-form-container" class="auth-form">
                            <h2 class="text-2xl font-bold text-white text-center mb-4">Login</h2>
                            <p class="text-center text-gray-400 mb-6">Welcome back to the 899 Hub.</p>
                            <form id="login-form">
                                <div class="space-y-4">
                                    <div class="input-group"><i class="fas fa-envelope input-icon"></i><input type="email" id="login-email" placeholder="Email" class="form-input" required></div>
                                    <div class="input-group"><i class="fas fa-lock input-icon"></i><input type="password" id="login-password" placeholder="Password" class="form-input" required></div>
                                </div>
                                <p id="login-error" class="text-red-400 text-center text-sm mt-4 form-error"></p>
                                <button type="submit" id="login-submit-btn" class="w-full p-3 rounded-lg primary-btn mt-2">Login</button>
                                <div class="text-center text-sm text-gray-400 mt-6">
                                    <a href="#" id="forgot-password-link" class="font-semibold hover:text-white" style="color: var(--color-primary);">Forgot Password?</a>
                                </div>
                                <p class="text-center text-sm text-gray-400 mt-4">
                                    Don't have an account? <a href="#" id="show-register-link" class="font-semibold hover:text-white" style="color: var(--color-primary);">Register here</a>
                                </p>
                            </form>
                        </div>
                        <!-- Registration Form -->
                        <div id="register-form-container" class="auth-form">
                            <div id="registration-flow">
                                <h2 class="text-2xl font-bold text-white text-center mb-4">Create Account</h2>
                                <div class="progress-bar" id="register-progress-bar">
                                    <div class="line"></div>
                                    <div class="progress-step active" data-step="1"><i class="fas fa-user-circle"></i></div>
                                    <div class="progress-step" data-step="2"><i class="fas fa-shield-alt"></i></div>
                                    <div class="progress-step" data-step="3"><i class="fas fa-fist-raised"></i></div>
                                    <div class="progress-step" data-step="4"><i class="fas fa-camera"></i></div>
                                </div>
                                <form id="register-form">
                                    <div class="form-slide active" data-slide="1"><p class="text-center text-gray-400 mb-6">Step 1: Your Account Details</p><div class="space-y-4">
                                        <div class="input-group"><i class="fas fa-user input-icon"></i><input type="text" id="register-username" placeholder="Username" class="form-input" required></div>
                                        <div class="input-group"><i class="fas fa-envelope input-icon"></i><input type="email" id="register-email" placeholder="Email" class="form-input" required></div>
                                        <div class="input-group"><i class="fas fa-lock input-icon"></i><input type="password" id="register-password" placeholder="Password (min. 6 characters)" class="form-input" required></div>
                                        <div class="input-group"><i class="fas fa-check-circle input-icon"></i><input type="password" id="register-password-verify" placeholder="Verify Password" class="form-input" required></div>
                                    </div></div>
                                    <div class="form-slide" data-slide="2"><p class="text-center text-gray-400 mb-6">Step 2: Alliance Information</p><div class="space-y-4">
                                         <div class="input-group"><i class="fas fa-shield-alt input-icon"></i>
                                            <div class="custom-select-container" data-type="alliance">
                                                <input type="hidden" id="register-alliance" name="alliance" required>
                                                <button type="button" class="custom-select-value form-input"><span>Select Alliance</span><i class="fas fa-chevron-down text-xs"></i></button>
                                                <div class="custom-select-options">
                                                    <input type="text" class="custom-select-search" placeholder="Search alliances...">
                                                    <div class="options-list"></div>
                                                </div>
                                            </div>
                                         </div>
                                        <div class="input-group"><i class="fas fa-star input-icon"></i>
                                            <div class="custom-select-container" data-type="rank">
                                                <input type="hidden" id="register-alliance-rank" name="alliance-rank" required>
                                                <button type="button" class="custom-select-value form-input"><span>Select Alliance Rank</span><i class="fas fa-chevron-down text-xs"></i></button>
                                                <div class="custom-select-options">
                                                    <div class="options-list"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div></div>
                                    <div class="form-slide" data-slide="3"><p class="text-center text-gray-400 mb-6">Step 3: Your Power Stats</p><div class="space-y-4">
                                        <div class="input-group"><i class="fas fa-fist-raised input-icon"></i><input type="text" id="register-power" placeholder="Total Power (e.g., 150,000,000)" class="power-input form-input" required></div>
                                        <div class="input-group"><i class="fas fa-truck-monster input-icon"></i><input type="text" id="register-tank-power" placeholder="Tank Power" class="power-input form-input" required></div>
                                        <div class="input-group"><i class="fas fa-fighter-jet input-icon"></i><input type="text" id="register-air-power" placeholder="Air Power" class="power-input form-input" required></div>
                                        <div class="input-group"><i class="fas fa-rocket input-icon"></i><input type="text" id="register-missile-power" placeholder="Missile Power" class="power-input form-input" required></div>
                                    </div></div>
                                    <div class="form-slide" data-slide="4">
                                        <p class="text-center text-gray-400 mb-6">Step 4: Upload an Avatar (Optional)</p>
                                        <div class="flex flex-col items-center gap-4">
                                            <img id="register-avatar-preview" src="https://placehold.co/128x128/161B22/FFFFFF?text=Avatar" class="w-32 h-32 rounded-full object-cover border-2 border-white/20">
                                            <button type="button" id="register-avatar-btn" class="w-full p-3 rounded-lg secondary-btn">
                                                <i class="fas fa-upload mr-2"></i> Choose Image
                                            </button>
                                            <input type="file" id="register-avatar-input" class="hidden" accept="image/*">
                                        </div>
                                    </div>
                                    <p id="register-error" class="text-red-400 text-center text-sm mt-4 form-error"></p>
                                    <div id="register-nav-container" class="flex items-center mt-6"><button type="button" id="register-back-btn" class="px-6 py-2 rounded-lg secondary-btn flex items-center"><i class="fas fa-arrow-left mr-2"></i>Back</button><div class="flex-grow flex justify-center"><button type="button" id="register-next-btn" class="px-6 py-2 rounded-lg primary-btn flex items-center">Next<i class="fas fa-arrow-right ml-2"></i></button><button type="submit" id="register-submit-btn" class="px-6 py-2 rounded-lg primary-btn hidden flex items-center"><i class="fas fa-check-circle mr-2"></i>Register</button></div></div>
                                    <p class="text-center text-sm text-gray-400 mt-6">Already have an account? <a href="#" id="show-login-link" class="font-semibold hover:text-white" style="color: var(--color-primary);">Login here</a></p>
                                </form>
                            </div>
                            <div id="registration-success">
                                <i class="fas fa-check-circle success-icon"></i>
                                <h2 class="text-2xl font-bold text-white mt-4">Registration Complete!</h2>
                                <p class="text-gray-400 mt-2">Welcome to the 899 Hub. You will be logged in shortly.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="edit-profile-modal-container" class="modal-container">
             <div class="glass-pane">
                <div class="modal-content-wrapper">
                    <button id="close-edit-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-white transition-colors z-10">
                        <i class="fas fa-times fa-lg"></i>
                    </button>
                    <div class="modal-content-scroll">
                        <h2 class="text-2xl font-bold text-white text-center mb-6">Edit Your Profile</h2>
                        <form id="edit-profile-form">
                             <div class="space-y-4">
                                <div class="input-group"><i class="fas fa-user input-icon"></i><input type="text" id="edit-username" placeholder="Username" class="form-input" required></div>
                                <div class="input-group"><i class="fas fa-shield-alt input-icon"></i>
                                    <div class="custom-select-container w-full" data-type="alliance">
                                        <input type="hidden" id="edit-alliance" name="alliance" required>
                                        <button type="button" class="custom-select-value form-input"><span>Select Alliance</span><i class="fas fa-chevron-down text-xs"></i></button>
                                        <div class="custom-select-options dropdown-pane glass-pane">
                                            <input type="text" class="custom-select-search" placeholder="Search alliances...">
                                            <div class="options-list"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="input-group"><i class="fas fa-star input-icon"></i>
                                     <div class="custom-select-container w-full" data-type="rank">
                                        <input type="hidden" id="edit-alliance-rank" name="alliance-rank" required>
                                        <button type="button" class="custom-select-value form-input"><span>Select Alliance Rank</span><i class="fas fa-chevron-down text-xs"></i></button>
                                        <div class="custom-select-options dropdown-pane glass-pane">
                                            <div class="options-list"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="input-group"><i class="fas fa-fist-raised input-icon"></i><input type="text" id="edit-power" placeholder="Total Power" class="power-input form-input" required></div>
                                <div class="input-group"><i class="fas fa-truck-monster input-icon"></i><input type="text" id="edit-tank-power" placeholder="Tank Power" class="power-input form-input" required></div>
                                <div class="input-group"><i class="fas fa-fighter-jet input-icon"></i><input type="text" id="edit-air-power" placeholder="Air Power" class="power-input form-input" required></div>
                                <div class="input-group"><i class="fas fa-rocket input-icon"></i><input type="text" id="edit-missile-power" placeholder="Missile Power" class="power-input form-input" required></div>
                            </div>
                            <p id="edit-profile-error" class="text-red-400 text-center text-sm mt-4 form-error"></p>
                            <button type="submit" class="w-full p-3 rounded-lg primary-btn mt-6">Save Changes</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Player Settings Modal -->
        <div id="player-settings-modal-container" class="modal-container">
             <div class="glass-pane">
                <div class="modal-content-wrapper">
                    <button id="close-player-settings-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-white transition-colors z-10">
                        <i class="fas fa-times fa-lg"></i>
                    </button>
                    <div class="modal-content-scroll">
                        <h2 class="text-2xl font-bold text-white text-center mb-2">Player Settings</h2>
                        <p id="player-settings-username" class="text-center text-gray-400 mb-6"></p>
                        <form id="player-settings-form">
                             <div class="space-y-4">
                                <div class="input-group"><i class="fas fa-star input-icon"></i>
                                     <div class="custom-select-container w-full" data-type="rank">
                                        <input type="hidden" id="setting-alliance-rank" name="alliance-rank" required>
                                        <button type="button" class="custom-select-value form-input"><span>Select Alliance Rank</span><i class="fas fa-chevron-down text-xs"></i></button>
                                        <div class="custom-select-options">
                                            <div class="options-list"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="input-group"><i class="fas fa-user-tag input-icon"></i>
                                     <div class="custom-select-container w-full" data-type="role">
                                        <input type="hidden" id="setting-alliance-role" name="alliance-role">
                                        <button type="button" class="custom-select-value form-input"><span>Select Alliance Role</span><i class="fas fa-chevron-down text-xs"></i></button>
                                        <div class="custom-select-options">
                                            <div class="options-list"></div>
                                        </div>
                                    </div>
                                </div>
                                <div id="verification-toggle-container" class="flex items-center justify-between bg-gray-900/50 p-3 rounded-lg">
                                    <label for="setting-verified" class="font-semibold text-white">Verified Status</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="setting-verified">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                            <p id="player-settings-error" class="text-red-400 text-center text-sm mt-4 form-error"></p>
                            <button type="submit" class="w-full p-3 rounded-lg primary-btn mt-6">Save Settings</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create/Edit Post Modal -->
        <div id="create-post-modal-container" class="modal-container">
             <div class="glass-pane">
                <div class="modal-content-wrapper">
                    <button id="close-create-post-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-white transition-colors z-10">
                        <i class="fas fa-times fa-lg"></i>
                    </button>
                    <div class="modal-content-scroll">
                        <form id="create-post-form">
                            <div id="post-creation-flow">
                                 <!-- Slide 1: Main Type (Event vs Announcement) - SKIPPED IN NEW FLOW -->
                                <div class="form-slide" data-slide="1">
                                    <h2 class="text-2xl font-bold text-white text-center mb-4">Create New Post</h2>
                                    <p class="text-center text-gray-400 mb-6">What would you like to create?</p>
                                    <div id="post-main-type-selection-container" class="space-y-4">
                                       <!-- Dynamically inserted buttons for Event/Announcement -->
                                    </div>
                                </div>
                                <!-- Slide 2: Sub-Type Selection -->
                                <div class="form-slide" data-slide="2">
                                    <h2 id="post-subtype-header" class="text-2xl font-bold text-white text-center mb-4"></h2>
                                    <p class="text-center text-gray-400 mb-6">Select a category.</p>
                                    <div id="post-subtype-selection-container" class="space-y-3">
                                       <!-- Dynamically inserted sub-type buttons -->
                                    </div>
                                </div>
                                <!-- Slide 3: Content -->
                                <div class="form-slide" data-slide="3">
                                    <h2 id="post-content-header" class="text-2xl font-bold text-white text-center mb-4"></h2>
                                    <p class="text-center text-gray-400 mb-6">Provide the details for your post.</p>
                                    <div class="space-y-4">
                                        <div id="post-alliance-group" class="input-group hidden"><i class="fas fa-shield-alt input-icon"></i>
                                             <div class="custom-select-container w-full" data-type="alliance">
                                                <input type="hidden" id="post-alliance" name="post-alliance">
                                                <button type="button" class="custom-select-value form-input"><span>Select Alliance</span><i class="fas fa-chevron-down text-xs"></i></button>
                                                <div class="custom-select-options">
                                                    <input type="text" class="custom-select-search" placeholder="Search alliances...">
                                                    <div class="options-list"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="input-group"><i class="fas fa-heading input-icon"></i><input type="text" id="post-title" placeholder="Title" class="form-input" required></div>
                                        <div class="input-group !items-start"><i class="fas fa-align-left input-icon pt-3"></i><textarea id="post-details" placeholder="Details..." class="form-textarea" required></textarea></div>
                                        <div>
                                            <p class="text-sm text-gray-400 mb-2">Thumbnail (Optional)</p>
                                            <div class="flex items-center gap-4">
                                                <img id="post-thumbnail-preview" src="https://placehold.co/100x100/161B22/444444?text=PREVIEW" class="w-24 h-24 rounded-lg object-cover border-2 border-white/20">
                                                <button type="button" id="post-thumbnail-btn" class="flex-grow p-3 rounded-lg secondary-btn">
                                                    <i class="fas fa-upload mr-2"></i> Choose Image
                                                </button>
                                                <input type="file" id="post-thumbnail-input" class="hidden" accept="image/*">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                 <!-- Slide 4: Timing (for events) -->
                                <div class="form-slide" data-slide="4">
                                    <h2 class="text-2xl font-bold text-white text-center mb-4">Event Schedule</h2>
                                    <p class="text-center text-gray-400 mb-6">Set the schedule for your event.</p>
                                    <div id="post-timing-group" class="space-y-4">
                                         <div>
                                            <label class="text-sm font-semibold text-gray-400 mb-1 block">Start Time</label>
                                            <div class="flex gap-2">
                                                <div class="input-group w-1/2"><i class="fas fa-calendar-day input-icon"></i>
                                                    <div class="custom-select-container" data-type="day-of-week">
                                                        <input type="hidden" id="post-start-day" required><button type="button" class="custom-select-value form-input"><span>Day</span><i class="fas fa-chevron-down text-xs"></i></button><div class="custom-select-options"><div class="options-list"></div></div>
                                                    </div>
                                                </div>
                                                <div class="input-group w-1/2"><i class="fas fa-clock input-icon"></i>
                                                    <div class="custom-select-container" data-type="hour-of-day">
                                                        <input type="hidden" id="post-start-hour" required><button type="button" class="custom-select-value form-input"><span>Hour</span><i class="fas fa-chevron-down text-xs"></i></button><div class="custom-select-options"><div class="options-list"></div></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="text-sm font-semibold text-gray-400 mb-1 block">End Time</label>
                                            <div class="flex gap-2">
                                                 <div class="input-group w-1/2"><i class="fas fa-calendar-day input-icon"></i>
                                                    <div class="custom-select-container" data-type="day-of-week">
                                                        <input type="hidden" id="post-end-day" required><button type="button" class="custom-select-value form-input"><span>Day</span><i class="fas fa-chevron-down text-xs"></i></button><div class="custom-select-options"><div class="options-list"></div></div>
                                                    </div>
                                                </div>
                                                <div class="input-group w-1/2"><i class="fas fa-clock input-icon"></i>
                                                    <div class="custom-select-container" data-type="hour-of-day">
                                                        <input type="hidden" id="post-end-hour" required><button type="button" class="custom-select-value form-input"><span>Hour</span><i class="fas fa-chevron-down text-xs"></i></button><div class="custom-select-options"><div class="options-list"></div></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                         <div>
                                            <label class="text-sm font-semibold text-gray-400 mb-1 block">Repetition</label>
                                            <div class="flex gap-2">
                                                 <div class="input-group w-1/2"><i class="fas fa-redo-alt input-icon"></i>
                                                    <div class="custom-select-container" data-type="repeat-type">
                                                        <input type="hidden" id="post-repeat-type" value="none" required><button type="button" class="custom-select-value form-input"><span>None</span><i class="fas fa-chevron-down text-xs"></i></button><div class="custom-select-options"><div class="options-list"></div></div>
                                                    </div>
                                                </div>
                                                <div id="post-repeat-weeks-container" class="input-group w-1/2 hidden"><i class="fas fa-hashtag input-icon"></i>
                                                    <input type="number" id="post-repeat-weeks" class="form-input" min="1" value="1" placeholder="Weeks">
                                                </div>
                                            </div>
                                        </div>
                                        <p class="text-xs text-center text-gray-400">Times are based on your local timezone.</p>
                                    </div>
                                </div>
                            </div>
                            <p id="create-post-error" class="text-red-400 text-center text-sm mt-4 form-error"></p>
                             <div id="post-nav-container" class="flex items-center mt-6">
                                <button type="button" id="post-back-btn" class="px-6 py-2 rounded-lg secondary-btn flex items-center"><i class="fas fa-arrow-left mr-2"></i>Back</button>
                                <div class="flex-grow flex justify-center">
                                    <button type="button" id="post-next-btn" class="px-6 py-2 rounded-lg primary-btn flex items-center">Next<i class="fas fa-arrow-right ml-2"></i></button>
                                    <button type="submit" id="post-submit-btn" class="px-6 py-2 rounded-lg primary-btn hidden flex items-center"><i class="fas fa-check-circle mr-2"></i>Create Post</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirmation-modal-container" class="modal-container">
            <div class="glass-pane">
                <div class="modal-content-wrapper p-6 text-center">
                    <h2 id="confirmation-title" class="text-2xl font-bold text-white mb-4">Confirm Action</h2>
                    <p id="confirmation-message" class="text-gray-300 mb-6">Are you sure?</p>
                    <div class="flex justify-center gap-4">
                        <button id="confirmation-cancel-btn" class="w-full p-3 rounded-lg secondary-btn">Cancel</button>
                        <button id="confirmation-confirm-btn" class="w-full p-3 rounded-lg primary-btn bg-red-600 hover:bg-red-700 !shadow-red-500/30">Confirm</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Post Actions Modal -->
        <div id="post-actions-modal-container" class="modal-container" style="max-width: 300px;">
            <div class="glass-pane">
                <div class="modal-content-wrapper p-4">
                    <h3 class="text-lg font-bold text-white text-center mb-4">Post Options</h3>
                    <div class="space-y-2">
                        <button id="modal-edit-post-btn" class="actions-modal-btn edit">
                            <i class="fas fa-edit fa-fw"></i>
                            <span>Edit Post</span>
                        </button>
                        <button id="modal-delete-post-btn" class="actions-modal-btn delete">
                            <i class="fas fa-trash-alt fa-fw"></i>
                            <span>Delete Post</span>
                        </button>
                    </div>
                     <button id="close-post-actions-modal-btn" class="w-full p-2 rounded-lg secondary-btn mt-4">Cancel</button>
                </div>
            </div>
        </div>


        <div class="relative min-h-screen w-full p-4 sm:p-6 lg:p-8">
            <div class="max-w-6xl mx-auto">

                <header class="glass-pane header-main flex justify-between items-center mb-6">
                    <div class="flex-shrink-0">
                        <h1 class="text-2xl md:text-3xl font-black tracking-tighter text-white" style="text-shadow: 0 0 10px var(--color-primary-glow);">899<span class="font-bold" style="color: var(--color-primary);">HUB</span></h1>
                        <p class="text-xs text-gray-400">Official Community Hub</p>
                    </div>
                    
                    <nav id="main-nav" class="hidden md:flex flex-grow justify-center items-center">
                        <div class="nav-item"><div class="nav-link active" data-main-target="page-events"><i class="fas fa-calendar-alt"></i><span>Events</span></div></div>
                        <div class="nav-item"><div class="nav-link" data-main-target="page-social"><i class="fas fa-comments"></i><span>Social</span></div></div>
                        <div class="nav-item"><div class="nav-link" data-main-target="page-players"><i class="fas fa-users"></i><span>Players</span></div></div>
                        <div class="nav-item" id="feed-nav-item">
                            <div class="nav-link" data-main-target="page-feed">
                                <i class="fas fa-bell"></i><span>Feed</span>
                                <span id="notification-badge" class="notification-badge"></span>
                            </div>
                            <div id="feed-dropdown" class="dropdown-menu dropdown-pane glass-pane">
                                <!-- Notifications will be rendered here -->
                                <p class="text-center text-gray-500 p-4">No new notifications.</p>
                            </div>
                        </div>
                    </nav>

                    <div id="auth-container" class="hidden md:flex flex-shrink-0 relative">
                        <button id="login-btn" class="auth-button"><i class="fas fa-sign-in-alt fa-fw mr-2"></i>Login</button>
                        <div id="user-profile-container" class="hidden">
                            <button id="player-card-btn" class="auth-button">
                                 <img id="user-avatar-button" src="https://placehold.co/48x48/161B22/FFFFFF?text=?" class="w-6 h-6 rounded-full mr-2 object-cover" alt="User Avatar">
                                <span id="username-display"></span>
                                <i class="fas fa-caret-down ml-2"></i>
                            </button>
                            <div id="player-card-dropdown" class="dropdown-pane glass-pane">
                                <div id="player-card-info" class="p-2 mb-2 border-b border-white/10"></div>
                                <button id="upload-avatar-btn" class="dropdown-link"><i class="fas fa-camera w-6 text-center mr-2"></i>Change Avatar</button>
                                <input type="file" id="avatar-upload-input" class="hidden" accept="image/*">
                                <button id="edit-profile-btn" class="dropdown-link"><i class="fas fa-edit w-6 text-center mr-2"></i>Edit Profile</button>
                                <button id="logout-btn" class="dropdown-link"><i class="fas fa-sign-out-alt w-6 text-center mr-2"></i>Logout</button>
                            </div>
                        </div>
                    </div>
                    <button id="open-mobile-menu-btn" class="md:hidden auth-button !px-4"><span class="font-bold tracking-wider">MENU</span></button>
                </header>

                <!-- Page Content Container -->
                <div id="page-container">
                    <!-- Feed Page -->
                    <div id="page-feed" class="page-content" style="display: none;">
                        <div class="glass-pane section-container">
                             <h2 class="text-3xl font-bold text-white tracking-wider mb-6" style="text-shadow: 0 0 10px var(--color-primary);">YOUR FEED</h2>
                             <div id="feed-page-container" class="space-y-4">
                                <!-- Full page notifications will be rendered here -->
                             </div>
                        </div>
                    </div>
                    
                    <!-- Social Page -->
                    <div id="page-social" class="page-content" style="display: none;">
                        <div class="glass-pane section-container">
                            <div class="flex flex-col md:flex-row gap-4">
                                <!-- Main Content: Tabs and Panes -->
                                <div class="flex-grow">
                                    <div class="social-tabs flex items-center mb-4">
                                        <button class="social-tab-btn active" data-tab="world-chat"><i class="fas fa-globe mr-2"></i>World Chat</button>
                                        <button class="social-tab-btn" data-tab="alliance-chat"><i class="fas fa-shield-alt mr-2"></i>Alliance</button>
                                        <button class="social-tab-btn" data-tab="leadership-chat"><i class="fas fa-crown mr-2"></i>Leadership</button>
                                        <button class="social-tab-btn" data-tab="friends"><i class="fas fa-user-friends mr-2"></i>Friends</button>
                                    </div>

                                    <!-- World Chat Pane -->
                                    <div id="pane-world-chat" class="social-content-pane active">
                                        <div class="flex flex-col h-full">
                                            <div id="world-chat-window" class="chat-window p-4 flex-grow">
                                                <!-- Messages will be injected here -->
                                                <p class="text-center text-gray-500 m-auto">Welcome to World Chat!</p>
                                            </div>
                                            <form id="world-chat-form" class="mt-4 flex gap-2">
                                                <input type="text" id="world-chat-input" class="form-input flex-grow" placeholder="Type a message in world chat..." required>
                                                <button type="submit" class="primary-btn px-6 rounded-lg"><i class="fas fa-paper-plane"></i></button>
                                            </form>
                                        </div>
                                    </div>

                                    <!-- Alliance Chat Pane -->
                                    <div id="pane-alliance-chat" class="social-content-pane">
                                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                            <div class="lg:col-span-2 flex flex-col h-full">
                                                <div id="alliance-chat-window" class="chat-window p-4 flex-grow">
                                                   <p class="text-center text-gray-500 m-auto">Your private alliance chat.</p>
                                                </div>
                                                <form id="alliance-chat-form" class="mt-4 flex gap-2">
                                                    <input type="text" id="alliance-chat-input" class="form-input flex-grow" placeholder="Message your alliance..." required>
                                                    <button type="submit" class="primary-btn px-6 rounded-lg"><i class="fas fa-paper-plane"></i></button>
                                                </form>
                                            </div>
                                            <div class="lg:col-span-1 space-y-4">
                                                <div>
                                                    <h3 class="section-header text-lg font-bold mb-2" style="--glow-color: var(--color-alliance);"><i class="fas fa-bullhorn"></i>Alliance Announcements</h3>
                                                    <div id="alliance-announcements-list" class="space-y-2 text-sm p-2 rounded-lg bg-black/20 max-h-48 overflow-y-auto">
                                                        <p class="text-gray-400 text-center">No announcements.</p>
                                                    </div>
                                                </div>
                                                 <div>
                                                    <h3 class="section-header text-lg font-bold mb-2" style="--glow-color: var(--color-alliance);"><i class="fas fa-calendar-check"></i>Alliance Events</h3>
                                                    <div id="alliance-events-list" class="space-y-2 text-sm p-2 rounded-lg bg-black/20 max-h-48 overflow-y-auto">
                                                        <p class="text-gray-400 text-center">No events.</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Leadership Chat Pane -->
                                    <div id="pane-leadership-chat" class="social-content-pane">
                                        <div class="flex flex-col h-full">
                                            <div id="leadership-chat-window" class="chat-window p-4 flex-grow">
                                                <p class="text-center text-gray-500 m-auto">Private chat for R4/R5 Leadership.</p>
                                            </div>
                                            <form id="leadership-chat-form" class="mt-4 flex gap-2">
                                                <input type="text" id="leadership-chat-input" class="form-input flex-grow" placeholder="Message leadership..." required>
                                                <button type="submit" class="primary-btn px-6 rounded-lg"><i class="fas fa-paper-plane"></i></button>
                                            </form>
                                        </div>
                                    </div>
                                    
                                    <!-- Friends Pane -->
                                    <div id="pane-friends" class="social-content-pane">
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div>
                                                <h3 class="section-header text-lg font-bold mb-2"><i class="fas fa-user-check"></i>Your Friends</h3>
                                                <div id="friends-list" class="space-y-2 p-2 rounded-lg bg-black/20 h-96 overflow-y-auto">
                                                    <p class="text-gray-400 text-center p-4">You haven't added any friends yet.</p>
                                                </div>
                                            </div>
                                            <div>
                                                <h3 class="section-header text-lg font-bold mb-2"><i class="fas fa-user-plus"></i>Friend Requests</h3>
                                                <div id="friend-requests-list" class="space-y-2 p-2 rounded-lg bg-black/20 h-40 overflow-y-auto">
                                                    <p class="text-gray-400 text-center p-4">No pending requests.</p>
                                                </div>
                                                <h3 class="section-header text-lg font-bold mb-2 mt-4"><i class="fas fa-paper-plane"></i>Sent Requests</h3>
                                                <div id="sent-requests-list" class="space-y-2 p-2 rounded-lg bg-black/20 h-40 overflow-y-auto">
                                                    <p class="text-gray-400 text-center p-4">No sent requests.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Players Page -->
                    <div id="page-players" class="page-content" style="display: none;">
                        <div class="glass-pane section-container">
                            <div class="text-center mb-8">
                                <h2 class="text-3xl font-bold text-white tracking-wider" style="text-shadow: 0 0 10px var(--color-primary);">PLAYERS OF 899</h2>
                                <div class="themed-line-break mx-auto mt-2"></div>
                            </div>

                            <div class="flex flex-col md:flex-row gap-4 mb-6">
                                <div class="input-group flex-grow">
                                    <i class="fas fa-search input-icon"></i>
                                    <input type="text" id="player-search-input" placeholder="Search by player name..." class="form-input">
                                </div>
                                <div class="input-group md:max-w-xs">
                                    <i class="fas fa-shield-alt input-icon"></i>
                                    <div class="custom-select-container" data-type="alliance-filter">
                                        <input type="hidden" id="alliance-filter" name="alliance-filter">
                                        <button type="button" class="custom-select-value form-input"><span>All Alliances</span><i class="fas fa-chevron-down text-xs"></i></button>
                                        <div class="custom-select-options">
                                            <div class="options-list"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="player-list-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                                 <!-- Player cards will be inserted here -->
                            </div>
                        </div>
                    </div>
                    <!-- Events Page -->
                    <div id="page-events" class="page-content">
                        <main id="events-main-container" class="space-y-6">
                            
                            <div id="filter-container" class="filter-btn-group">
                                <!-- Filter buttons will be dynamically inserted here -->
                            </div>

                            <div id="announcements-container" class="space-y-4">
                                <!-- Skeletons or announcement cards will be rendered here -->
                            </div>

                            <div id="events-section-container" class="space-y-4">
                                <!-- Skeletons or event group headers and lists will be rendered here -->
                            </div>

                        </main>
                    </div>
                    <!-- Top Alliances Page -->
                    <div id="page-top-alliances" class="page-content" style="display: none;">
                        <div class="glass-pane section-container">
                            <h2 class="text-3xl font-bold text-white text-center mb-8">Top Alliances</h2>
                            <div id="podium-container" class="flex flex-col md:flex-row items-end justify-center gap-4">
                                <!-- 2nd Place -->
                                <div class="w-full md:w-1/4 order-2 md:order-1">
                                    <div id="silver-podium" class="glass-pane podium-card podium-silver h-full">
                                        <!-- Silver/2nd place content will be populated here -->
                                    </div>
                                </div>
                                <!-- 1st Place -->
                                <div class="w-full md:w-1/3 order-1 md:order-2">
                                    <div id="gold-podium" class="glass-pane podium-card podium-gold h-full">
                                        <!-- Gold/1st place content will be populated here -->
                                    </div>
                                </div>
                                <!-- 3rd Place -->
                                <div class="w-full md:w-1/4 order-3 md:order-3">
                                    <div id="bronze-podium" class="glass-pane podium-card podium-bronze h-full">
                                        <!-- Bronze/3rd place content will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Other Pages -->
                    <div id="page-alliance-list" class="page-content" style="display: none;"><div class="glass-pane section-container"><h2 class="text-2xl font-bold text-white">Alliance List</h2></div></div>
                    <div id="page-recruitment" class="page-content" style="display: none;"><div class="glass-pane section-container"><h2 class="text-2xl font-bold text-white">Recruitment</h2></div></div>
                    <div id="page-season-overview" class="page-content" style="display: none;"><div class="glass-pane section-container"><h2 class="text-2xl font-bold text-white">Season Overview</h2></div></div>
                    <div id="page-season-rewards" class="page-content" style="display: none;"><div class="glass-pane section-container"><h2 class="text-2xl font-bold text-white">Season Rewards</h2></div></div>
                    <div id="page-season-history" class="page-content" style="display: none;"><div class="glass-pane section-container"><h2 class="text-2xl font-bold text-white">Season History</h2></div></div>
                    <div id="page-calculators" class="page-content" style="display: none;"><div class="glass-pane section-container"><h2 class="text-2xl font-bold text-white">Calculators</h2></div></div>
                    <div id="page-guides" class="page-content" style="display: none;"><div class="glass-pane section-container"><h2 class="text-2xl font-bold text-white">Guides</h2></div></div>

                </div>

                <footer class="text-center mt-12 py-4 border-t border-gray-800/50"><p class="text-gray-500">&copy; 2024 Last War Survival - Server 899 Community.</p></footer>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, query, updateDoc, addDoc, serverTimestamp, deleteDoc, orderBy, limit, where, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        import { getDatabase, ref as dbRef, onValue, set, onDisconnect, serverTimestamp as rtdbServerTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";


        const firebaseConfig = {
            apiKey: "AIzaSyA8KKDjjw0Pb_wknZ3TRWuL7-7XMo4VeY0",
            authDomain: "events-ea397.firebaseapp.com",
            databaseURL: "https://events-ea397-default-rtdb.firebaseio.com",
            projectId: "events-ea397",
            storageBucket: "events-ea397.firebasestorage.app",
            messagingSenderId: "51859633788",
            appId: "1:51859633788:web:3653d3e7edb6d3c1c4fbf9",
            measurementId: "G-0ZCMZ86PJD"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);
        const storage = getStorage(app);
        
        let currentUserData = null;
        let allPlayers = []; // Cache for player data
        let allPosts = []; // Cache for post data
        let userSessions = {}; // Cache for user presence data
        let userNotifications = []; // Cache for user notifications
        
        const ALLIANCES = ["THOR", "fAfO", "HeRA", "pHNx", "TroW", "VaLT", "COLD", "Tone", "DoM", "MINI", "MEGA", "Lat1", "WSKT", "ValT", "BRSL", "TCM1", "BLSD", "REI", "wpg1", "SHRK"];
        const ALLIANCE_RANKS = [
            { value: 'R5', text: 'R5 (Leader)'}, { value: 'R4', text: 'R4'}, { value: 'R3', text: 'R3'},
            { value: 'R2', text: 'R2'}, { value: 'R1', text: 'R1 (Member)'},
        ];
        const ALLIANCE_ROLES = [
            { value: '', text: 'None'}, { value: 'Warlord', text: 'Warlord'}, { value: 'Recruiter', text: 'Recruiter'},
            { value: 'Muse', text: 'Muse'}, { value: 'Butler', text: 'Butler'},
        ];
        const DAYS_OF_WEEK = [
            { value: '0', text: 'Sunday' }, { value: '1', text: 'Monday' }, { value: '2', text: 'Tuesday' },
            { value: '3', text: 'Wednesday' }, { value: '4', text: 'Thursday' }, { value: '5', text: 'Friday' },
            { value: '6', text: 'Saturday' }
        ];
        const HOURS_OF_DAY = Array.from({ length: 24 }, (_, i) => ({
            value: i.toString(),
            text: `${i.toString().padStart(2, '0')}:00`
        }));
        const REPEAT_TYPES = [
            { value: 'none', text: 'None' },
            { value: 'weekly', text: 'Weekly' }
        ];
        
        const POST_TYPES = {
            // Announcements
            server_announcement: { mainType: 'announcement', subType: 'server', text: 'Server Announcement', isAdminOnly: true, visibility: 'public' },
            leadership_announcement: { mainType: 'announcement', subType: 'leadership', text: 'Leadership Announcement', allowedRanks: ['R5'], visibility: 'public' },
            alliance_announcement: { mainType: 'announcement', subType: 'alliance', text: 'Alliance Announcement', allowedRanks: ['R5', 'R4'], visibility: 'alliance' },
            // Events
            alliance_event: { mainType: 'event', subType: 'alliance', text: 'Alliance Event', allowedRanks: ['R5', 'R4'], isVerifiedRequired: true, visibility: 'alliance' },
            server_event: { mainType: 'event', subType: 'server', text: 'Server Event', isAdminOnly: true, visibility: 'public' },
            seasonal_event: { mainType: 'event', subType: 'seasonal', text: 'Seasonal Event', isAdminOnly: true, visibility: 'public' },
            hot_deals: { mainType: 'event', subType: 'hot_deals', text: 'Hot Deals Event', isAdminOnly: true, visibility: 'public' },
            wanted_boss: { mainType: 'event', subType: 'wanted_boss', text: 'Wanted Boss Event', isAdminOnly: true, visibility: 'public' },
            campaign: { mainType: 'event', subType: 'campaign', text: 'Campaign Event', isAdminOnly: true, visibility: 'public' },
            vs: { mainType: 'event', subType: 'vs', text: 'VS Event', isAdminOnly: true, visibility: 'public' },
        };

        const POST_STYLES = {
            server: { color: 'var(--post-color-server)', icon: 'fas fa-server', bgColor: 'rgba(255, 215, 0, 0.1)'},
            seasonal: { color: 'var(--post-color-seasonal)', icon: 'fas fa-snowflake', bgColor: 'rgba(147, 112, 219, 0.1)'},
            leadership: { color: 'var(--post-color-leadership)', icon: 'fas fa-crown', bgColor: 'rgba(192, 192, 192, 0.1)'},
            alliance: { color: 'var(--post-color-alliance)', icon: 'fas fa-shield-alt', bgColor: 'rgba(0, 191, 255, 0.1)'},
            hot_deals: { color: 'var(--post-color-hot_deals)', icon: 'fas fa-fire-alt', bgColor: 'rgba(255, 99, 71, 0.1)'},
            wanted_boss: { color: 'var(--post-color-wanted_boss)', icon: 'fas fa-skull-crossbones', bgColor: 'rgba(220, 20, 60, 0.1)'},
            campaign: { color: 'var(--post-color-campaign)', icon: 'fas fa-map-marked-alt', bgColor: 'rgba(50, 205, 50, 0.1)'},
            vs: { color: 'var(--post-color-vs)', icon: 'fas fa-fist-raised', bgColor: 'rgba(255, 165, 0, 0.1)'},
        };


        // --- DOM ELEMENTS ---
        const appPreloader = document.getElementById('app-preloader');
        const appContainer = document.getElementById('app-container');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const authModalContainer = document.getElementById('auth-modal-container');
        const editProfileModalContainer = document.getElementById('edit-profile-modal-container');
        const playerSettingsModalContainer = document.getElementById('player-settings-modal-container');
        const createPostModalContainer = document.getElementById('create-post-modal-container');
        const confirmationModalContainer = document.getElementById('confirmation-modal-container');
        const postActionsModalContainer = document.getElementById('post-actions-modal-container');
        
        const loginFormContainer = document.getElementById('login-form-container');
        const registerFormContainer = document.getElementById('register-form-container');
        const loginBtn = document.getElementById('login-btn');
        const userProfileContainer = document.getElementById('user-profile-container');
        const usernameDisplay = document.getElementById('username-display');
        const playerListContainer = document.getElementById('player-list-container');
        const playerCardBtn = document.getElementById('player-card-btn');
        const playerCardDropdown = document.getElementById('player-card-dropdown');
        const playerCardInfo = document.getElementById('player-card-info');
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const mobileNavMenu = document.getElementById('mobile-nav-menu');
        const mobileNavLinksContainer = document.getElementById('mobile-nav-links');
        const playerSearchInput = document.getElementById('player-search-input');
        const allianceFilterInput = document.getElementById('alliance-filter');
        const announcementsContainer = document.getElementById('announcements-container');
        const eventsSectionContainer = document.getElementById('events-section-container');
        const userAvatarButton = document.getElementById('user-avatar-button');
        const uploadAvatarBtn = document.getElementById('upload-avatar-btn');
        const avatarUploadInput = document.getElementById('avatar-upload-input');
        const verificationToggleContainer = document.getElementById('verification-toggle-container');
        const eventsMainContainer = document.getElementById('events-main-container');
        const filterContainer = document.getElementById('filter-container');
        const feedDropdown = document.getElementById('feed-dropdown');
        const feedNavItem = document.getElementById('feed-nav-item');
        const notificationBadge = document.getElementById('notification-badge');
        const feedPageContainer = document.getElementById('feed-page-container');


        let activePlayerSettingsUID = null;
        let postCreationData = {}; // Object to hold data across slides
        let resizedThumbnailBlob = null;
        let activeFilter = 'all';
        let countdownInterval = null;
        let editingPostId = null;
        let actionPostId = null; // For the post actions modal
        
        // --- CHAT, PRESENCE & NOTIFICATION LISTENERS ---
        let worldChatListener = null;
        let allianceChatListener = null;
        let leadershipChatListener = null;
        let sessionsListener = null;
        let notificationListener = null;
        let awayTimer = null;

        // --- UTILITY & SKELETON FUNCTIONS ---
        function formatTimeAgo(date) {
            if (!date) return '';
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);

            let interval = seconds / 31536000;
            if (interval > 1) return `${Math.floor(interval)}y ago`;
            interval = seconds / 2592000;
            if (interval > 1) return `${Math.floor(interval)}mo ago`;
            interval = seconds / 86400;
            if (interval > 1) return `${Math.floor(interval)}d ago`;
            interval = seconds / 3600;
            if (interval > 1) return `${Math.floor(interval)}h ago`;
            interval = seconds / 60;
            if (interval > 1) return `${Math.floor(interval)}m ago`;
            return `${Math.floor(seconds)}s ago`;
        }
        
        function formatEventDateTime(date) {
            if (!date || isNaN(date.getTime())) return 'N/A';
            // Format: Thu, Jul 31 @ 1:30 PM
            return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }) + ' @ ' +
                   date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        }

        function formatDuration(ms) {
            if (ms < 0) ms = 0;
            const totalSeconds = Math.floor(ms / 1000);
            const days = Math.floor(totalSeconds / 86400);
            const hours = Math.floor((totalSeconds % 86400) / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            
            let parts = [];
            if (days > 0) parts.push(`${days}d`);
            if (hours > 0) parts.push(`${hours}h`);
            if (minutes > 0) parts.push(`${minutes}m`);
            
            return parts.slice(0, 2).join(' ') || '<1m';
        }
        
        function createSkeletonCard() {
            return `
                <div class="post-card skeleton-card">
                    <div class="post-card-thumbnail-wrapper">
                        <div class="post-card-thumbnail skeleton-loader"></div>
                    </div>
                    <div class="post-card-body">
                        <div class="post-card-content">
                            <div class="post-card-header">
                                <div class="skeleton-loader h-5 w-24"></div>
                            </div>
                            <div class="skeleton-loader h-8 w-4/5 mt-2"></div>
                            <div class="skeleton-loader h-4 w-full mt-2"></div>
                            <div class="skeleton-loader h-4 w-2/3 mt-1"></div>
                        </div>
                        <div class="post-card-status">
                            <div class="skeleton-loader h-4 w-16 mb-2"></div>
                            <div class="skeleton-loader h-7 w-24"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSkeletons() {
            announcementsContainer.innerHTML = `
                <div class="section-header text-xl font-bold mb-4" style="--glow-color: var(--color-highlight);">
                    <i class="fas fa-bullhorn"></i>
                    <span class="flex-grow">Announcements</span>
                </div>
                <div class="grid grid-cols-1 gap-4">
                    ${createSkeletonCard()}
                </div>
            `;
            eventsSectionContainer.innerHTML = `
                <div class="section-header text-xl font-bold mb-4">
                     <i class="fas fa-calendar-alt"></i>
                     <span class="flex-grow">Events</span>
                </div>
                <div class="grid grid-cols-1 gap-4">
                    ${createSkeletonCard()}
                    ${createSkeletonCard()}
                    ${createSkeletonCard()}
                </div>
            `;
        }

        function getEventStatus(event) {
            const now = new Date();
            let startTime = event.startTime?.toDate();
            let endTime = event.endTime?.toDate();

            if (!startTime || !endTime) {
                return { status: 'ended' }; 
            }

            if (event.isRecurring) {
                if (endTime < now) {
                    const timeDiff = now.getTime() - endTime.getTime();
                    const weeksToAdvance = Math.ceil(timeDiff / (7 * 24 * 60 * 60 * 1000));
                    startTime.setDate(startTime.getDate() + weeksToAdvance * 7);
                    endTime.setDate(endTime.getDate() + weeksToAdvance * 7);
                }
            }

            if (startTime > now) {
                return { status: 'upcoming', timeDiff: startTime - now };
            } else if (startTime <= now && endTime > now) {
                return { status: 'live', timeDiff: endTime - now };
            } else {
                return { status: 'ended', endedDate: endTime };
            }
        }


        function updateCountdowns() {
            document.querySelectorAll('.event-card').forEach(el => {
                const postId = el.dataset.postId;
                const post = allPosts.find(p => p.id === postId);
                if (!post) return;

                const statusInfo = getEventStatus(post);
                const statusEl = el.querySelector('.status-content-wrapper');
                const dateEl = el.querySelector('.status-date'); 

                if (!statusEl || !dateEl) return;

                el.classList.remove('live', 'ended', 'upcoming');
                
                const originalStartTime = post.startTime?.toDate();
                if (originalStartTime) {
                    dateEl.textContent = formatEventDateTime(originalStartTime);
                }

                switch(statusInfo.status) {
                    case 'upcoming':
                        el.classList.add('upcoming');
                        statusEl.innerHTML = `<div class="status-label">STARTS IN</div><div class="status-time">${formatDuration(statusInfo.timeDiff)}</div>`;
                        break;
                    case 'live':
                        el.classList.add('live');
                        statusEl.innerHTML = `<div class="status-label">ENDS IN</div><div class="status-time">${formatDuration(statusInfo.timeDiff)}</div>`;
                        break;
                    case 'ended':
                        el.classList.add('ended');
                        statusEl.innerHTML = `<div class="status-label">ENDED</div><div class="status-time">${statusInfo.endedDate.toLocaleDateString([], { month: 'short', day: 'numeric' })}</div>`;
                        break;
                }
            });
        }

        // --- UNSUBSCRIBE FUNCTIONS FOR LISTENERS ---
        let userDocListener = null;

        // --- MODAL & FORM SWITCHING LOGIC ---
        function showModal(modal) {
            hideAllModals();
            modalBackdrop.classList.add('visible');
            modal.classList.add('visible');
        }

        function showAuthModal(formToShow) {
            showModal(authModalContainer);
            document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));
            if (formToShow === 'register') {
                registerFormContainer.classList.add('active');
                initializeRegistrationStepper();
            } else {
                loginFormContainer.classList.add('active');
            }
        }
        
        function showEditProfileModal() { showModal(editProfileModalContainer); populateEditForm(); }
        function showPlayerSettingsModal(player) { activePlayerSettingsUID = player.uid; showModal(playerSettingsModalContainer); populatePlayerSettingsForm(player); }
        
        function showCreatePostModal(mainType) { 
            editingPostId = null;
            document.getElementById('create-post-form').reset();
            document.getElementById('post-nav-container').style.display = 'flex';
            showModal(createPostModalContainer); 
            initializePostStepper(mainType);
            document.getElementById('post-content-header').textContent = 'Create New Post';
            document.getElementById('post-submit-btn').innerHTML = '<i class="fas fa-check-circle mr-2"></i>Create Post';
        }

        function showConfirmationModal(title, message, onConfirm) {
            document.getElementById('confirmation-title').textContent = title;
            document.getElementById('confirmation-message').textContent = message;
            
            const confirmBtn = document.getElementById('confirmation-confirm-btn');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            newConfirmBtn.addEventListener('click', () => {
                onConfirm();
                hideAllModals();
            });
            
            showModal(confirmationModalContainer);
        }
        
        function showPostActionsModal(postId) {
            actionPostId = postId;
            showModal(postActionsModalContainer);
        }

        function hideAllModals() {
            modalBackdrop.classList.remove('visible');
            authModalContainer.classList.remove('visible');
            editProfileModalContainer.classList.remove('visible');
            playerSettingsModalContainer.classList.remove('visible');
            createPostModalContainer.classList.remove('visible');
            confirmationModalContainer.classList.remove('visible');
            postActionsModalContainer.classList.remove('visible');
            activePlayerSettingsUID = null;
            editingPostId = null;
            actionPostId = null;
        }
        
        loginBtn.addEventListener('click', () => showAuthModal('login'));
        document.getElementById('close-auth-modal-btn').addEventListener('click', hideAllModals);
        document.getElementById('close-edit-modal-btn').addEventListener('click', hideAllModals);
        document.getElementById('close-player-settings-modal-btn').addEventListener('click', hideAllModals);
        document.getElementById('close-create-post-modal-btn').addEventListener('click', hideAllModals);
        document.getElementById('confirmation-cancel-btn').addEventListener('click', hideAllModals);
        document.getElementById('close-post-actions-modal-btn').addEventListener('click', hideAllModals);

        modalBackdrop.addEventListener('click', (e) => {
            if (e.target === modalBackdrop) {
                hideAllModals();
                mobileNavMenu.classList.remove('open');
            }
        });

        document.getElementById('show-register-link').addEventListener('click', (e) => { e.preventDefault(); showAuthModal('register'); });
        document.getElementById('show-login-link').addEventListener('click', (e) => { e.preventDefault(); showAuthModal('login'); });

        // --- AUTHENTICATION & DATA LOGIC ---

        // Listen for posts immediately on load
        onSnapshot(query(collection(db, 'posts')), (querySnapshot) => {
            allPosts = [];
            querySnapshot.forEach((doc) => allPosts.push({ id: doc.id, ...doc.data() }));
            renderPosts(allPosts);
        }, (error) => console.error("Error with posts listener:", error));

        // Listen for users immediately on load
        onSnapshot(query(collection(db, 'users')), (querySnapshot) => {
            allPlayers = [];
            querySnapshot.forEach((doc) => { allPlayers.push({uid: doc.id, ...doc.data()}); });
            applyPlayerFilters(); // Initial render
            updateTopAlliancesPodium(allPlayers);
        }, (error) => console.error("Error with users listener:", error));

        // Listen for all user sessions for presence
        sessionsListener = onSnapshot(collection(db, 'sessions'), (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                userSessions[change.doc.id] = change.doc.data();
            });
            // Re-render components that show presence
            applyPlayerFilters();
            // You might need to re-render chat messages if they are visible
            const activeChat = document.querySelector('.social-content-pane.active .chat-window');
            if(activeChat) {
                // This is a simplified re-render; a more robust solution would update just the status dot
                const chatType = activeChat.id.split('-')[0] + '_chat';
                // This part is tricky without re-fetching all messages. We'll rely on player list for now.
            }
        });


        // Handle auth state changes to update UI accordingly
        onAuthStateChanged(auth, (user) => {
            if (userDocListener) userDocListener(); // Detach old listener
            detachAllListeners(); // Always detach old listeners on auth change

            if (user) {
                setupPresenceManagement(user);
                setupNotificationListener(user);
                userDocListener = onSnapshot(doc(db, "users", user.uid), (userDoc) => {
                    if (userDoc.exists()) {
                        currentUserData = { uid: user.uid, ...userDoc.data() };
                        updateUIForLoggedInUser();
                        renderPosts(allPosts);
                        applyPlayerFilters();
                        setupChatListeners(); // Setup new chat listeners with user data
                    }
                });
                hideAllModals();
            } else {
                currentUserData = null;
                updateUIForLoggedOutUser();
                renderPosts(allPosts);
                applyPlayerFilters();
            }
            buildMobileNav();
            // Hide preloader after first auth check
            appPreloader.style.opacity = '0';
            setTimeout(() => {
                appPreloader.style.display = 'none';
                appContainer.style.display = 'block';
            }, 500);
        });
        
        function updateUIForLoggedInUser() {
            if (!currentUserData) return;
            usernameDisplay.textContent = currentUserData.username;
            updateAvatarDisplay(currentUserData);
            updatePlayerCard(currentUserData);
            loginBtn.classList.add('hidden');
            userProfileContainer.classList.remove('hidden');
        }

        function updateUIForLoggedOutUser() {
            loginBtn.classList.remove('hidden');
            userProfileContainer.classList.add('hidden');
            userProfileContainer.classList.remove('open');
        }

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorElement = document.getElementById('login-error');
            const submitBtn = document.getElementById('login-submit-btn');
            errorElement.textContent = '';
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Logging In...';

            signInWithEmailAndPassword(auth, email, password).catch((error) => {
                console.error("Login Error:", error);
                errorElement.textContent = (error.code === 'auth/invalid-credential') 
                    ? "Invalid email or password." 
                    : "An unknown error occurred.";
            }).finally(() => {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Login';
            });
        });

        logoutBtn.addEventListener('click', () => {
            // Manually set offline before signing out
            if(currentUserData) {
                updateUserStatus(currentUserData.uid, 'offline');
            }
            signOut(auth).catch(error => console.error("Logout error:", error));
        });

        document.getElementById('forgot-password-link').addEventListener('click', (e) => {
            e.preventDefault();
            const email = prompt("Please enter your email address to receive a password reset link:");
            if (!email) return;

            sendPasswordResetEmail(auth, email)
                .then(() => alert('Password reset email sent! Please check your inbox.'))
                .catch((error) => alert(error.message));
        });
        
        // --- PLAYER CARD, AVATAR & EDIT PROFILE ---
        playerCardBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            userProfileContainer.classList.toggle('open');
        });
        
        editProfileBtn.addEventListener('click', () => {
            userProfileContainer.classList.remove('open');
            showEditProfileModal();
        });

        uploadAvatarBtn.addEventListener('click', () => avatarUploadInput.click());

        avatarUploadInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            const user = auth.currentUser;
            if (!file || !user) return;

            userAvatarButton.style.opacity = '0.5';
            try {
                const resizedBlob = await resizeImage(file, { maxWidth: 1024, maxHeight: 1024 });
                const avatarRef = ref(storage, `avatars/${user.uid}`);
                await uploadBytes(avatarRef, resizedBlob);
                const downloadURL = await getDownloadURL(avatarRef);
                await updateDoc(doc(db, "users", user.uid), { avatarUrl: downloadURL });
            } catch (error) {
                console.error("Avatar upload error:", error);
                alert("Failed to upload avatar. Please try again.");
            } finally {
                userAvatarButton.style.opacity = '1';
            }
        });

        function updateAvatarDisplay(data) {
            const avatarUrl = data.avatarUrl || `https://placehold.co/48x48/0D1117/FFFFFF?text=${data.username.charAt(0).toUpperCase()}`;
            userAvatarButton.src = avatarUrl;
        }

        function updatePlayerCard(data) {
             playerCardInfo.innerHTML = `
                <p class="text-sm text-gray-400">Alliance: <strong class="text-white">[${data.alliance}] ${data.allianceRank}</strong></p>
                <p class="text-sm text-gray-400">Power: <strong class="text-white">${(data.power || 0).toLocaleString()}</strong></p>
             `;
        }
        
        function populateEditForm() {
            if (!currentUserData) return;
            document.getElementById('edit-username').value = currentUserData.username;
            
            const editAllianceSelect = document.getElementById('edit-alliance').closest('.custom-select-container');
            const editRankSelect = document.getElementById('edit-alliance-rank').closest('.custom-select-container');
            
            setCustomSelectValue(editAllianceSelect, currentUserData.alliance);
            const rankData = ALLIANCE_RANKS.find(r => r.value === currentUserData.allianceRank);
            setCustomSelectValue(editRankSelect, currentUserData.allianceRank, rankData ? rankData.text : currentUserData.allianceRank);
            
            document.getElementById('edit-power').value = (currentUserData.power || 0).toLocaleString();
            document.getElementById('edit-tank-power').value = (currentUserData.tankPower || 0).toLocaleString();
            document.getElementById('edit-air-power').value = (currentUserData.airPower || 0).toLocaleString();
            document.getElementById('edit-missile-power').value = (currentUserData.missilePower || 0).toLocaleString();
        }

        document.getElementById('edit-profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;
            
            const errorElement = document.getElementById('edit-profile-error');
            errorElement.textContent = '';
            
            const parsePower = (str) => parseInt(String(str).replace(/,/g, ''), 10) || 0;

            const updatedData = {
                username: document.getElementById('edit-username').value,
                alliance: document.getElementById('edit-alliance').value,
                allianceRank: document.getElementById('edit-alliance-rank').value,
                power: parsePower(document.getElementById('edit-power').value),
                tankPower: parsePower(document.getElementById('edit-tank-power').value),
                airPower: parsePower(document.getElementById('edit-air-power').value),
                missilePower: parsePower(document.getElementById('edit-missile-power').value),
            };

            if (currentUserData && updatedData.alliance !== currentUserData.alliance) {
                updatedData.isVerified = false;
            }

            try {
                await updateDoc(doc(db, "users", user.uid), updatedData);
                hideAllModals();
            } catch (error) {
                console.error("Update profile error:", error);
                errorElement.textContent = "Failed to update profile.";
            }
        });


        // --- REGISTRATION STEPPER LOGIC ---
        let currentRegStep = 1;
        let resizedAvatarBlob = null;
        const registrationFlow = document.getElementById('registration-flow');
        const registrationSuccess = document.getElementById('registration-success');
        const regFormSlides = registrationFlow.querySelectorAll('.form-slide');
        const regProgressSteps = registrationFlow.querySelectorAll('.progress-step');
        const regProgressBarLine = registrationFlow.querySelector('.progress-bar .line');
        const regBackBtn = document.getElementById('register-back-btn');
        const regNextBtn = document.getElementById('register-next-btn');
        const regSubmitBtn = document.getElementById('register-submit-btn');
        const registerError = document.getElementById('register-error');

        function initializeRegistrationStepper() { 
            currentRegStep = 1; 
            resizedAvatarBlob = null;
            document.getElementById('register-avatar-preview').src = 'https://placehold.co/128x128/161B22/FFFFFF?text=Avatar';
            showRegStep(currentRegStep);
            registrationFlow.style.display = 'block';
            registrationSuccess.style.display = 'none';
        }
        function showRegStep(stepIndex) {
            regFormSlides.forEach((slide) => slide.classList.remove('active'));
            const currentSlide = registrationFlow.querySelector(`.form-slide[data-slide="${stepIndex}"]`);
            if(currentSlide) currentSlide.classList.add('active');

            regProgressSteps.forEach((step, index) => step.classList.toggle('active', index < stepIndex - 1));
            regProgressBarLine.style.width = `${((stepIndex - 1) / (regFormSlides.length - 1)) * 100}%`;
            regBackBtn.style.visibility = stepIndex === 1 ? 'hidden' : 'visible';
            regNextBtn.classList.toggle('hidden', stepIndex === regFormSlides.length);
            regSubmitBtn.classList.toggle('hidden', stepIndex !== regFormSlides.length);
        }
        function validateRegStep(stepIndex) {
            registerError.textContent = '';
            const slide = regFormSlides[stepIndex - 1]; // Adjust for 1-based index
            if (stepIndex === 1) {
                const username = slide.querySelector('#register-username').value;
                const email = slide.querySelector('#register-email').value;
                const password = slide.querySelector('#register-password').value;
                const passwordVerify = slide.querySelector('#register-password-verify').value;
                if (!username || !email || !password || !passwordVerify) { registerError.textContent = 'Please fill out all account fields.'; return false; }
                if (password.length < 6) { registerError.textContent = 'Password must be at least 6 characters long.'; return false; }
                if (password !== passwordVerify) { registerError.textContent = 'Passwords do not match.'; return false; }
            } else if (stepIndex === 2) {
                if (!slide.querySelector('#register-alliance').value || !slide.querySelector('#register-alliance-rank').value) { registerError.textContent = 'Please select your alliance and rank.'; return false; }
            } else if (stepIndex === 3) {
                if (!slide.querySelector('#register-power').value) { registerError.textContent = 'Please enter your total power.'; return false; }
            }
            return true;
        }
        regNextBtn.addEventListener('click', () => { if (validateRegStep(currentRegStep)) { currentRegStep++; showRegStep(currentRegStep); } });
        regBackBtn.addEventListener('click', () => { currentRegStep--; showRegStep(currentRegStep); });
        
        document.getElementById('register-avatar-btn').addEventListener('click', () => {
            document.getElementById('register-avatar-input').click();
        });

        document.getElementById('register-avatar-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            resizedAvatarBlob = await resizeImage(file, { maxWidth: 1024, maxHeight: 1024 });
            document.getElementById('register-avatar-preview').src = URL.createObjectURL(resizedAvatarBlob);
        });
        
        function resizeImage(file, options) {
            const { maxWidth, maxHeight } = options;
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        let { width, height } = img;
                        if (width > height) {
                            if (width > maxWidth) {
                                height = Math.round(height * (maxWidth / width));
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = Math.round(width * (maxHeight / height));
                                height = maxHeight;
                            }
                        }
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob((blob) => {
                            if (blob) { resolve(blob); } 
                            else { reject(new Error('Canvas to Blob conversion failed')); }
                        }, 'image/jpeg', 0.9);
                    };
                    img.onerror = (err) => reject(err);
                    img.src = event.target.result;
                };
                reader.onerror = (err) => reject(err);
                reader.readAsDataURL(file);
            });
        }


        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!validateRegStep(currentRegStep)) return;
            regSubmitBtn.disabled = true;
            regSubmitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Registering...';
            const username = document.getElementById('register-username').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const alliance = document.getElementById('register-alliance').value;
            const allianceRank = document.getElementById('register-alliance-rank').value;
            const parsePower = (str) => parseInt(String(str).replace(/,/g, ''), 10) || 0;
            const power = parsePower(document.getElementById('register-power').value);
            const tankPower = parsePower(document.getElementById('register-tank-power').value);
            const airPower = parsePower(document.getElementById('register-air-power').value);
            const missilePower = parsePower(document.getElementById('register-missile-power').value);
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                let avatarUrl = null;
                if (resizedAvatarBlob) {
                    const avatarRef = ref(storage, `avatars/${user.uid}`);
                    await uploadBytes(avatarRef, resizedAvatarBlob);
                    avatarUrl = await getDownloadURL(avatarRef);
                }

                const userProfile = {
                    username, email, alliance, allianceRank, power, tankPower, airPower, missilePower,
                    likes: 0, allianceRole: '', isVerified: false, avatarUrl,
                    isAdmin: email === 'mikestancato@gmail.com',
                    registrationTimestampUTC: new Date().toISOString(),
                };
                if (userProfile.isAdmin) {
                    userProfile.isVerified = true;
                }

                await setDoc(doc(db, "users", user.uid), userProfile);
                
                // Create verification notifications for leaders
                const leadersQuery = query(collection(db, 'users'), where('alliance', '==', alliance), where('allianceRank', 'in', ['R5', 'R4']));
                const leadersSnapshot = await getDocs(leadersQuery);
                const batch = writeBatch(db);
                leadersSnapshot.forEach(leaderDoc => {
                    const notificationRef = doc(collection(db, 'notifications'));
                    batch.set(notificationRef, {
                        recipientUid: leaderDoc.id,
                        senderUid: user.uid,
                        senderUsername: username,
                        type: 'verification_request',
                        message: `${username} has joined your alliance and is awaiting verification.`,
                        isRead: false,
                        timestamp: serverTimestamp()
                    });
                });
                await batch.commit();

                registrationFlow.style.display = 'none';
                registrationSuccess.style.display = 'block';
                setTimeout(hideAllModals, 3000);
            } catch (error) {
                console.error("Registration Error:", error);
                registerError.textContent = error.code === 'auth/email-already-in-use' ? 'This email is already registered.' : 'An error occurred.';
            } finally {
                regSubmitBtn.disabled = false;
                regSubmitBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Register';
            }
        });
        
        // --- POST CREATION/EDIT STEPPER ---
        let currentPostStep = 1;
        const postFlow = document.getElementById('post-creation-flow');
        const postFormSlides = postFlow.querySelectorAll('.form-slide');
        const postBackBtn = document.getElementById('post-back-btn');
        const postNextBtn = document.getElementById('post-next-btn');
        const postSubmitBtn = document.getElementById('post-submit-btn');
        const createPostError = document.getElementById('create-post-error');

        function initializePostStepper(mainType) {
            document.getElementById('create-post-form').reset();
            postCreationData = {};
            resizedThumbnailBlob = null;
            document.getElementById('post-thumbnail-preview').src = 'https://placehold.co/100x100/161B22/444444?text=PREVIEW';
            
            postCreationData.mainType = mainType;
            currentPostStep = 2; // Start at sub-type selection
            populateSubTypeSelection();
            showPostStep(currentPostStep);
            
            postBackBtn.classList.remove('hidden');
            postNextBtn.classList.remove('hidden');
        }

        function getAvailablePostTypes(mainType) {
            return Object.entries(POST_TYPES).filter(([key, type]) => {
                if (type.mainType !== mainType) return false;
                if (!currentUserData) return false;
                if (type.isAdminOnly) return currentUserData.isAdmin;
                if (type.isVerifiedRequired && !currentUserData.isVerified) return false;
                if (type.allowedRanks) return type.allowedRanks.includes(currentUserData.allianceRank);
                return false;
            });
        }
        
        function populateSubTypeSelection() {
            const container = document.getElementById('post-subtype-selection-container');
            const header = document.getElementById('post-subtype-header');
            header.textContent = `Select ${postCreationData.mainType.charAt(0).toUpperCase() + postCreationData.mainType.slice(1)} Type`;
            container.innerHTML = '';
            
            const availableSubTypes = getAvailablePostTypes(postCreationData.mainType);

            availableSubTypes.forEach(([key, type]) => {
                const style = POST_STYLES[type.subType];
                const button = document.createElement('button');
                button.type = 'button';
                button.dataset.key = key;
                button.className = 'type-selection-card w-full p-4 rounded-lg text-left flex items-center gap-4';
                button.innerHTML = `
                    <i class="${style.icon} fa-2x w-10 text-center" style="color: ${style.color};"></i>
                    <div>
                        <h3 class="font-bold text-lg text-white">${type.text}</h3>
                        <p class="text-sm text-gray-500">Create a new ${type.subType.replace('_', ' ')} ${type.mainType}.</p>
                    </div>
                `;
                button.addEventListener('click', () => {
                    Object.assign(postCreationData, type);
                    currentPostStep++;
                    showPostStep(currentPostStep);
                });
                container.appendChild(button);
            });
        }

        function showPostStep(stepIndex) {
            postFormSlides.forEach(slide => slide.classList.remove('active'));
            const currentSlide = postFlow.querySelector(`.form-slide[data-slide="${stepIndex}"]`);
            if(currentSlide) currentSlide.classList.add('active');
            
            const isEvent = postCreationData.mainType === 'event';
            const totalSteps = isEvent ? 4 : 3;

            postBackBtn.style.visibility = stepIndex === 1 ? 'hidden' : 'visible';
            postNextBtn.classList.toggle('hidden', stepIndex >= totalSteps);
            postSubmitBtn.classList.toggle('hidden', stepIndex !== totalSteps);
            
            if(stepIndex === 3) {
                const header = document.getElementById('post-content-header');
                header.textContent = editingPostId ? `Edit ${postCreationData.text}` : `New ${postCreationData.text}`;
                const allianceGroup = document.getElementById('post-alliance-group');
                if(currentUserData.isAdmin && (postCreationData.visibility === 'alliance' || postCreationData.visibility === 'leadership')) {
                    allianceGroup.classList.remove('hidden');
                } else {
                    allianceGroup.classList.add('hidden');
                }
            }
        }

        function validatePostStep(stepIndex) {
            createPostError.textContent = '';
            if (stepIndex === 3) {
                 if (!document.getElementById('post-title').value || !document.getElementById('post-details').value) {
                    createPostError.textContent = 'Title and details are required.';
                    return false;
                }
            } else if (stepIndex === 4 && postCreationData.mainType === 'event') {
                if (!document.getElementById('post-start-day').value || !document.getElementById('post-start-hour').value ||
                    !document.getElementById('post-end-day').value || !document.getElementById('post-end-hour').value) {
                    createPostError.textContent = 'Please select a start/end day and hour for the event.';
                    return false;
                }
            }
            return true;
        }
        
        postNextBtn.addEventListener('click', () => {
            if (validatePostStep(currentPostStep)) {
                currentPostStep++;
                showPostStep(currentPostStep);
            }
        });
        
        postBackBtn.addEventListener('click', () => {
            if (currentPostStep === 2) { // If on the first visible step, "Back" closes the modal
                hideAllModals();
                return;
            }
            currentPostStep--;
            showPostStep(currentPostStep);
        });

        document.getElementById('post-thumbnail-btn').addEventListener('click', () => {
            document.getElementById('post-thumbnail-input').click();
        });

        document.getElementById('post-thumbnail-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            resizedThumbnailBlob = await resizeImage(file, { maxWidth: 1024, maxHeight: 1024 });
            document.getElementById('post-thumbnail-preview').src = URL.createObjectURL(resizedThumbnailBlob);
        });
        
        document.getElementById('post-repeat-type').addEventListener('change', (e) => {
            const repeatWeeksContainer = document.getElementById('post-repeat-weeks-container');
            repeatWeeksContainer.classList.toggle('hidden', e.target.value !== 'weekly');
        });

        // --- EVENTS & ANNOUNCEMENTS LOGIC ---
        function renderPosts(postsToRender) {
            if (countdownInterval) clearInterval(countdownInterval);
            
            let visiblePosts = postsToRender.filter(post => {
                if (!currentUserData) return post.visibility === 'public';
                if (post.visibility === 'public') return true;
                if (currentUserData.isAdmin) return true;
                if (post.visibility === 'alliance' && post.alliance === currentUserData.alliance) return true;
                return false;
            });
            
            buildFilterControls(visiblePosts);

            if (activeFilter !== 'all') {
                visiblePosts = visiblePosts.filter(p => p.subType === activeFilter);
            }

            const announcements = visiblePosts
                .filter(p => p.mainType === 'announcement')
                .sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));

            const events = visiblePosts.filter(p => p.mainType === 'event');
            
            renderAnnouncements(announcements);
            renderEvents(events);
            
            if (announcements.length === 0 && events.length > 0) {
                eventsSectionContainer.style.marginTop = '0';
            } else if (announcements.length > 0) {
                eventsSectionContainer.style.marginTop = '2rem';
            }

            countdownInterval = setInterval(updateCountdowns, 1000 * 30);
            updateCountdowns();
        }

        function renderAnnouncements(announcements) {
            let createBtnHTML = '';
            if (currentUserData && getAvailablePostTypes('announcement').length > 0) {
                createBtnHTML = `<button id="create-announcement-btn" class="ml-4 primary-btn !p-0 w-5 h-5 rounded-full flex items-center justify-center text-xl" title="Create New Announcement"><i class="fas fa-plus" style="font-size:.6rem"></i></button>`;
            }

            const contentHTML = announcements.length > 0
                ? `<div class="grid grid-cols-1 gap-4">${announcements.map(createCard).join('')}</div>`
                : `<p class="text-center text-gray-500 py-4">No announcements to display.</p>`;

            announcementsContainer.innerHTML = `
                <div class="section-header text-xl font-bold mb-4" style="--glow-color: var(--color-highlight);">
                    <i class="fas fa-bullhorn"></i>
                    <span class="flex-grow">Announcements</span>
                    ${createBtnHTML}
                </div>
                ${contentHTML}
            `;
        }
        
        function createCard(post) {
            const style = POST_STYLES[post.subType] || {};
            const isEvent = post.mainType === 'event';
            const color = style.color || 'var(--color-primary)';
            const headerStyle = post.thumbnailUrl ? `background-image: url('${post.thumbnailUrl}')` : `background-color: #101419;`;
            const postDate = post.createdAt?.toDate();
            const timestamp = postDate ? formatTimeAgo(postDate) : '...';
            const postTypeText = POST_TYPES[`${post.subType}_${post.mainType}`]?.text || post.subType.replace(/_/g, ' ').toUpperCase();

            let actionsTriggerHTML = '';
            if (currentUserData && (currentUserData.isAdmin || post.authorUid === currentUserData.uid)) {
                actionsTriggerHTML = `
                    <button class="post-card-actions-trigger" data-post-id="${post.id}" title="Post Options">
                        <i class="fas fa-cog"></i>
                    </button>
                `;
            }

            let statusContentHTML = '';
            if (isEvent) {
                statusContentHTML = `<div class="status-content-wrapper"></div><div class="status-date"></div>`; 
            } else {
                statusContentHTML = `
                    <div class="status-content-wrapper">
                        <div class="status-label" title="${postDate?.toLocaleString() || ''}">Posted</div>
                        <div class="status-time">${timestamp}</div>
                    </div>
                    <div class="status-date">${postDate ? formatEventDateTime(postDate) : ''}</div>
                `;
            }

            return `
                <div class="post-card ${isEvent ? 'event-card' : 'announcement-card'}" data-post-id="${post.id}" style="--glow-color: ${color};">
                    <div class="post-card-thumbnail-wrapper">
                        <div class="post-card-thumbnail" style="${headerStyle}"></div>
                        ${actionsTriggerHTML}
                    </div>
                    <div class="post-card-body">
                        <div class="post-card-content">
                            <div class="post-card-header">
                                <span class="post-card-category" style="background-color: ${color};">${postTypeText}</span>
                            </div>
                            <h3 class="post-card-title">${post.title}</h3>
                            <p class="post-card-details">${post.details}</p>
                        </div>
                        <div class="post-card-status">
                            ${statusContentHTML}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderEvents(events) {
            const now = new Date();
            const sevenDaysFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);

            let displayableEvents = events.filter(event => {
                const status = getEventStatus(event);
                const prospectiveStartTime = event.isRecurring ? getEventStatus(event).startTime : event.startTime?.toDate();
                return status.status === 'live' || (status.status === 'upcoming' && (prospectiveStartTime || event.startTime?.toDate()) <= sevenDaysFromNow);
            });

            displayableEvents.sort((a, b) => {
                const statusA = getEventStatus(a);
                const statusB = getEventStatus(b);
                if (statusA.status === 'live' && statusB.status !== 'live') return -1;
                if (statusA.status !== 'live' && statusB.status === 'live') return 1;
                if (statusA.status === 'live' && statusB.status === 'live') {
                    return statusA.timeDiff - statusB.timeDiff;
                }
                if (statusA.status === 'upcoming' && statusB.status === 'upcoming') {
                    if (statusA.timeDiff !== statusB.timeDiff) {
                        return statusA.timeDiff - statusB.timeDiff;
                    }
                    return a.title.localeCompare(b.title);
                }
                return 0;
            });
            
            let createBtnHTML = '';
            if (currentUserData && getAvailablePostTypes('event').length > 0) {
                createBtnHTML = `<button id="create-event-btn" class="ml-4 primary-btn !p-0 w-5 h-5 rounded-full flex items-center justify-center text-xl" title="Create New Event"><i class="fas fa-plus" style="font-size:.6rem"></i></button>`;
            }

            const headerHTML = announcementsContainer.innerHTML.trim() === '' ? '' : '<div></div>';
            
            const contentHTML = displayableEvents.length > 0
                ? `<div class="grid grid-cols-1 gap-4">${displayableEvents.map(createCard).join('')}</div>`
                : `<p class="text-center text-gray-500 py-4">No upcoming events in the next 7 days.</p>`;

            eventsSectionContainer.innerHTML = `
                ${headerHTML}
                <div class="section-header text-xl font-bold mb-4">
                    <i class="fas fa-calendar-alt"></i>
                    <span class="flex-grow">Events</span>
                    ${createBtnHTML}
                </div>
                ${contentHTML}
            `;
        }

        function calculateNextDateTime(dayOfWeek, hour) {
            const targetDay = parseInt(dayOfWeek, 10);
            const targetHour = parseInt(hour, 10);
            const now = new Date();
            
            let resultDate = new Date();
            resultDate.setDate(now.getDate() + (targetDay - now.getDay() + 7) % 7);
            resultDate.setHours(targetHour, 0, 0, 0);

            if (resultDate < now) {
                resultDate.setDate(resultDate.getDate() + 7);
            }
            
            return resultDate;
        }

        async function populatePostFormForEdit(postId) {
            const post = allPosts.find(p => p.id === postId);
            if (!post) {
                console.error("Post not found for editing:", postId);
                return;
            }

            editingPostId = postId;
            postCreationData = { ...POST_TYPES[`${post.subType}_${post.mainType}`] };

            document.getElementById('create-post-form').reset();
            
            document.getElementById('post-content-header').textContent = `Edit ${postCreationData.text}`;
            const submitBtn = document.getElementById('post-submit-btn');
            submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Save Changes';

            document.getElementById('post-nav-container').style.display = 'none';
            document.querySelectorAll('.form-slide').forEach(s => s.classList.remove('active'));
            document.querySelector('.form-slide[data-slide="3"]').classList.add('active');
            if (post.mainType === 'event') {
                document.querySelector('.form-slide[data-slide="4"]').classList.add('active');
            }
            
            document.getElementById('post-title').value = post.title;
            document.getElementById('post-details').value = post.details;
            document.getElementById('post-thumbnail-preview').src = post.thumbnailUrl || 'https://placehold.co/100x100/161B22/444444?text=PREVIEW';
            
            if (post.mainType === 'event' && post.startTime) {
                const startDate = post.startTime.toDate();
                const endDate = post.endTime.toDate();

                setCustomSelectValue(document.querySelector('#post-start-day').closest('.custom-select-container'), startDate.getDay().toString(), DAYS_OF_WEEK[startDate.getDay()].text);
                setCustomSelectValue(document.querySelector('#post-start-hour').closest('.custom-select-container'), startDate.getHours().toString(), HOURS_OF_DAY[startDate.getHours()].text);
                setCustomSelectValue(document.querySelector('#post-end-day').closest('.custom-select-container'), endDate.getDay().toString(), DAYS_OF_WEEK[endDate.getDay()].text);
                setCustomSelectValue(document.querySelector('#post-end-hour').closest('.custom-select-container'), endDate.getHours().toString(), HOURS_OF_DAY[endDate.getHours()].text);
                
                const repeatType = post.isRecurring ? 'weekly' : 'none';
                setCustomSelectValue(document.querySelector('#post-repeat-type').closest('.custom-select-container'), repeatType, REPEAT_TYPES.find(rt => rt.value === repeatType).text);
                document.getElementById('post-repeat-weeks-container').classList.toggle('hidden', !post.isRecurring);
                if (post.isRecurring) {
                    document.getElementById('post-repeat-weeks').value = post.repeatWeeks || 1;
                }
            }
            
            showModal(createPostModalContainer);
            postSubmitBtn.classList.remove('hidden');
        }


        document.getElementById('create-post-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('post-submit-btn');
            if (!currentUserData) {
                createPostError.textContent = 'You must be logged in to post.';
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';

            let alliance = (postCreationData.visibility === 'alliance' || postCreationData.visibility === 'leadership') 
                ? (currentUserData.isAdmin ? document.getElementById('post-alliance').value : currentUserData.alliance)
                : null;
            
            const finalPostData = {
                mainType: postCreationData.mainType,
                subType: postCreationData.subType,
                title: document.getElementById('post-title').value,
                details: document.getElementById('post-details').value,
                authorUid: currentUserData.uid,
                authorUsername: currentUserData.username,
                alliance: alliance,
                visibility: postCreationData.visibility,
                isRecurring: document.getElementById('post-repeat-type').value === 'weekly',
            };

            if (postCreationData.mainType === 'event') {
                const startDay = document.getElementById('post-start-day').value;
                const startHour = document.getElementById('post-start-hour').value;
                const endDay = document.getElementById('post-end-day').value;
                const endHour = document.getElementById('post-end-hour').value;

                finalPostData.startTime = calculateNextDateTime(startDay, startHour);
                finalPostData.endTime = calculateNextDateTime(endDay, endHour);

                if (finalPostData.endTime < finalPostData.startTime) {
                    finalPostData.endTime.setDate(finalPostData.endTime.getDate() + 7);
                }
                
                if (finalPostData.isRecurring) {
                    finalPostData.repeatWeeks = parseInt(document.getElementById('post-repeat-weeks').value, 10) || 1;
                }
            }
            
            try {
                let postDocRef;
                if (editingPostId) {
                    postDocRef = doc(db, 'posts', editingPostId);
                    if (resizedThumbnailBlob) {
                        const thumbnailRef = ref(storage, `post_thumbnails/${editingPostId}`);
                        await uploadBytes(thumbnailRef, resizedThumbnailBlob);
                        finalPostData.thumbnailUrl = await getDownloadURL(thumbnailRef);
                    }
                    await updateDoc(postDocRef, finalPostData);
                } else {
                    finalPostData.createdAt = serverTimestamp();
                    postDocRef = await addDoc(collection(db, 'posts'), finalPostData);
                    if (resizedThumbnailBlob) {
                        const thumbnailRef = ref(storage, `post_thumbnails/${postDocRef.id}`);
                        await uploadBytes(thumbnailRef, resizedThumbnailBlob);
                        const downloadURL = await getDownloadURL(thumbnailRef);
                        await updateDoc(postDocRef, { thumbnailUrl: downloadURL });
                    }
                }
                
                // If it's an alliance announcement, create notifications
                if (finalPostData.subType === 'alliance' && finalPostData.mainType === 'announcement') {
                    const membersQuery = query(collection(db, 'users'), where('alliance', '==', finalPostData.alliance));
                    const membersSnapshot = await getDocs(membersQuery);
                    const batch = writeBatch(db);
                    membersSnapshot.forEach(memberDoc => {
                        if (memberDoc.id === currentUserData.uid) return; // Don't notify self
                        const notificationRef = doc(collection(db, 'notifications'));
                        batch.set(notificationRef, {
                            recipientUid: memberDoc.id,
                            senderUid: currentUserData.uid,
                            senderUsername: currentUserData.username,
                            type: 'alliance_announcement',
                            message: `New announcement in your alliance: "${finalPostData.title}"`,
                            relatedId: postDocRef.id,
                            isRead: false,
                            timestamp: serverTimestamp()
                        });
                    });
                    await batch.commit();
                }

                hideAllModals();
            } catch (error) {
                console.error("Error saving post: ", error);
                createPostError.textContent = 'Failed to save post.';
            } finally {
                submitBtn.disabled = false;
            }
        });

        // --- FILTERING LOGIC ---
        function buildFilterControls(visiblePosts) {
            const availableSubTypes = [...new Set(visiblePosts.map(p => p.subType))];
            
            filterContainer.innerHTML = ''; // Clear previous buttons
            
            const allBtn = document.createElement('button');
            allBtn.className = 'filter-btn active';
            allBtn.textContent = 'All';
            allBtn.dataset.filter = 'all';
            allBtn.style.setProperty('--glow-color', 'var(--color-primary)');
            allBtn.style.setProperty('--glow-color-bg', 'rgba(0, 191, 255, 0.1)');
            filterContainer.appendChild(allBtn);

            availableSubTypes.forEach(subType => {
                const style = POST_STYLES[subType] || {};
                const postTypeInfo = Object.values(POST_TYPES).find(pt => pt.subType === subType);
                const btn = document.createElement('button');
                btn.className = 'filter-btn';
                btn.textContent = postTypeInfo ? postTypeInfo.text : subType.replace('_', ' ');
                btn.dataset.filter = subType;
                btn.style.setProperty('--glow-color', style.color || 'var(--color-primary)');
                btn.style.setProperty('--glow-color-bg', style.bgColor || 'rgba(0, 191, 255, 0.1)');
                filterContainer.appendChild(btn);
            });
        }

        filterContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('filter-btn')) {
                activeFilter = e.target.dataset.filter;
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                renderPosts(allPosts);
            }
        });

        // --- PLAYER LIST & SETTINGS LOGIC ---
        function applyPlayerFilters() {
            const searchTerm = playerSearchInput.value.toLowerCase();
            const allianceFilter = allianceFilterInput.value;

            const filteredPlayers = allPlayers.filter(player => {
                const nameMatch = player.username.toLowerCase().includes(searchTerm);
                const allianceMatch = !allianceFilter || player.alliance === allianceFilter;
                return nameMatch && allianceMatch;
            });
            renderPlayers(filteredPlayers);
        }

        playerSearchInput.addEventListener('input', applyPlayerFilters);
        allianceFilterInput.addEventListener('change', applyPlayerFilters);

        function renderPlayers(players) {
            playerListContainer.innerHTML = '';
            if (players.length === 0) {
                playerListContainer.innerHTML = `<p class="text-center col-span-full py-8 text-gray-400">No players match the current filters.</p>`;
                return;
            }
            players.forEach(player => {
                const card = document.createElement('div');
                card.className = 'player-card glass-pane p-4 flex flex-col relative';
                card.dataset.rank = player.allianceRank;
                card.dataset.uid = player.uid;

                let gearIconHTML = '';
                if (currentUserData && currentUserData.uid !== player.uid) {
                    const canManage = canManageUser(currentUserData, player);
                    if(canManage) {
                        gearIconHTML = `<button class="absolute top-3 right-3 text-gray-400 hover:text-white transition-colors player-settings-btn" data-uid="${player.uid}"><i class="fas fa-cog"></i></button>`;
                    }
                }

                const avatarUrl = player.avatarUrl || `https://placehold.co/48x48/0D1117/FFFFFF?text=${player.username.charAt(0).toUpperCase()}`;
                const session = userSessions[player.uid];
                const statusClass = session ? session.status : 'offline';

                card.innerHTML = `
                    ${gearIconHTML}
                    <div class="flex items-center pb-3 border-b player-card-header" style="border-color: rgba(255,255,255,0.1);">
                        <img src="${avatarUrl}" class="w-12 h-12 rounded-full mr-4 border-2 object-cover" style="border-color: rgba(255,255,255,0.2);" alt="${player.username}" onerror="this.src='https://placehold.co/48x48/0D1117/FFFFFF?text=?';">
                        <div>
                            <h3 class="font-bold text-lg text-white flex items-center">${player.username} <span class="status-dot ${statusClass} ml-2"></span></h3>
                            <p class="text-sm font-semibold" style="color: var(--color-primary);">[${player.alliance}] - ${player.allianceRank}</p>
                        </div>
                    </div>
                    <div class="flex-grow my-4 space-y-3">
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-400 flex items-center"><i class="fas fa-fist-raised w-6 text-center mr-2" style="color: var(--color-primary);"></i>Total Power</span>
                            <span class="font-bold text-white">${(player.power || 0).toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-400 flex items-center"><i class="fas fa-truck-monster w-6 text-center mr-2" style="color: var(--color-primary);"></i>Tank Power</span>
                            <span class="font-bold text-white">${(player.tankPower || 0).toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-400 flex items-center"><i class="fas fa-fighter-jet w-6 text-center mr-2" style="color: var(--color-primary);"></i>Air Power</span>
                            <span class="font-bold text-white">${(player.airPower || 0).toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-400 flex items-center"><i class="fas fa-rocket w-6 text-center mr-2" style="color: var(--color-primary);"></i>Missile Power</span>
                            <span class="font-bold text-white">${(player.missilePower || 0).toLocaleString()}</span>
                        </div>
                    </div>
                    <div class="flex justify-around items-center pt-3 border-t border-white/10">
                        <button class="text-gray-400 hover:text-white transition-colors !text-lg" title="Message Player"><i class="fas fa-comment-dots"></i></button>
                        <button class="add-friend-btn text-gray-400 hover:text-white transition-colors !text-lg" title="Add Friend"><i class="fas fa-user-plus"></i></button>
                        <button class="text-gray-400 hover:text-white transition-colors !text-lg" title="Like Profile"><i class="fas fa-thumbs-up"></i></button>
                    </div>
                `;
                const settingsBtn = card.querySelector('.player-settings-btn');
                if (settingsBtn) {
                    settingsBtn.addEventListener('click', () => {
                        const targetPlayer = allPlayers.find(p => p.uid === settingsBtn.dataset.uid);
                        if(targetPlayer) showPlayerSettingsModal(targetPlayer)
                    });
                }
                playerListContainer.appendChild(card);
            });
        }
        
        function canManageUser(manager, targetUser) {
            if (!manager || !targetUser) return false;
            if (manager.isAdmin) return true;
            if (manager.alliance !== targetUser.alliance) return false;
            if (manager.allianceRank === 'R5' && ['R4', 'R3', 'R2', 'R1'].includes(targetUser.allianceRank)) return true;
            if (manager.allianceRank === 'R4' && ['R3', 'R2', 'R1'].includes(targetUser.allianceRank)) return true;
            return false;
        }

        function populatePlayerSettingsForm(player) {
            document.getElementById('player-settings-username').textContent = player.username;
            const rankSelect = document.getElementById('setting-alliance-rank').closest('.custom-select-container');
            const roleSelect = document.getElementById('setting-alliance-role').closest('.custom-select-container');
            const verifiedCheckbox = document.getElementById('setting-verified');
            
            setCustomSelectValue(rankSelect, player.allianceRank, ALLIANCE_RANKS.find(r => r.value === player.allianceRank)?.text);
            setCustomSelectValue(roleSelect, player.allianceRole, ALLIANCE_ROLES.find(r => r.value === player.allianceRole)?.text);
            verifiedCheckbox.checked = player.isVerified || false;

            const canVerify = canManageUser(currentUserData, player);
            verificationToggleContainer.style.display = canVerify ? 'flex' : 'none';
        }

        document.getElementById('player-settings-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!activePlayerSettingsUID || !currentUserData) return;

            const targetPlayer = allPlayers.find(p => p.uid === activePlayerSettingsUID);
            if (!targetPlayer) return;

            const errorElement = document.getElementById('player-settings-error');
            errorElement.textContent = '';

            const updatedData = {
                allianceRank: document.getElementById('setting-alliance-rank').value,
                allianceRole: document.getElementById('setting-alliance-role').value,
            };

            if (canManageUser(currentUserData, targetPlayer)) {
                updatedData.isVerified = document.getElementById('setting-verified').checked;
            }

            try {
                await updateDoc(doc(db, "users", activePlayerSettingsUID), updatedData);
                hideAllModals();
            } catch (error) {
                console.error("Error updating player settings:", error);
                errorElement.textContent = "Failed to save settings.";
            }
        });


        // --- TOP ALLIANCES PODIUM LOGIC ---
        function updateTopAlliancesPodium(players) {
            const topAlliances = ['THOR', 'fAfO', 'HeRA'];
            const podiumData = topAlliances.map(allianceTag => {
                const members = players.filter(p => p.alliance === allianceTag);
                const totalPower = members.reduce((sum, p) => sum + (p.power || 0), 0);
                const leader = members.find(p => p.allianceRank === 'R5')?.username || 'Unassigned';
                const warlord = members.find(p => p.allianceRole === 'Warlord')?.username || 'Unassigned';
                const recruiter = members.find(p => p.allianceRole === 'Recruiter')?.username || 'Unassigned';
                const muse = members.find(p => p.allianceRole === 'Muse')?.username || 'Unassigned';
                const butler = members.find(p => p.allianceRole === 'Butler')?.username || 'Unassigned';
                return { tag: allianceTag, totalPower, leader, warlord, recruiter, muse, butler };
            });

            const [gold, silver, bronze] = podiumData;

            document.getElementById('gold-podium').innerHTML = generatePodiumHTML(gold, '1st', 'gold');
            document.getElementById('silver-podium').innerHTML = generatePodiumHTML(silver, '2nd', 'silver');
            document.getElementById('bronze-podium').innerHTML = generatePodiumHTML(bronze, '3rd', 'bronze');
        }

        function generatePodiumHTML(data, rank, type) {
            if (!data) return '<p>Loading...</p>';
            const rankClasses = {
                gold: { sup: 'text-3xl font-bold text-yellow-400', main: 'text-6xl font-black text-yellow-300', text: 'text-yellow-200', border: 'border-yellow-500/50'},
                silver: { sup: 'text-2xl font-bold text-gray-400', main: 'text-5xl font-black text-gray-300', text: 'text-gray-300', border: 'border-gray-600'},
                bronze: { sup: 'text-2xl font-bold text-yellow-800', main: 'text-5xl font-black text-yellow-700', text: 'text-yellow-200/70', border: 'border-yellow-800/50'}
            };
            const cls = rankClasses[type];

            return `
                <div class="mb-4"><span class="${cls.main}">${rank.charAt(0)}</span><sup class="${cls.sup}">${rank.slice(1)}</sup></div>
                <h3 class="text-3xl font-extrabold text-white">[${data.tag}]</h3>
                <div class="text-base ${cls.text} mt-2 space-y-1">
                    <p><i class="fas fa-crown mr-2"></i>Leader: ${data.leader}</p>
                    <p><i class="fas fa-fist-raised mr-2"></i>Power: ${(data.totalPower / 1_000_000_000).toFixed(1)}B</p>
                </div>
                <div class="border-t ${cls.border} my-4"></div>
                <div class="text-left text-sm space-y-2">
                    <p><strong class="${cls.text}">Warlord:</strong> ${data.warlord}</p>
                    <p><strong class="${cls.text}">Recruiter:</strong> ${data.recruiter}</p>
                    <p><strong class="${cls.text}">Muse:</strong> ${data.muse}</p>
                    <p><strong class="${cls.text}">Butler:</strong> ${data.butler}</p>
                </div>
            `;
        }


        // --- CUSTOM SELECT LOGIC ---
        function setupCustomSelect(container) {
            const type = container.dataset.type;
            const hiddenInput = container.querySelector('input[type="hidden"]');
            const valueButton = container.querySelector('.custom-select-value');
            const optionsContainer = container.querySelector('.custom-select-options');
            const searchInput = container.querySelector('.custom-select-search');
            const optionsList = container.querySelector('.options-list');
            
            let sourceData = [];
            if (type === 'alliance') sourceData = ALLIANCES.map(a => ({value: a, text: a}));
            else if (type === 'rank') sourceData = ALLIANCE_RANKS;
            else if (type === 'role') sourceData = ALLIANCE_ROLES;
            else if (type === 'alliance-filter') sourceData = [{value: '', text: 'All Alliances'}, ...ALLIANCES.map(a => ({value: a, text: a}))];
            else if (type === 'day-of-week') sourceData = DAYS_OF_WEEK;
            else if (type === 'hour-of-day') sourceData = HOURS_OF_DAY;
            else if (type === 'repeat-type') sourceData = REPEAT_TYPES;
            
            const isSearchable = searchInput && type === 'alliance';
            if(searchInput && !isSearchable) searchInput.style.display = 'none';

            function renderOptions(data = [], filter = '') {
                optionsList.innerHTML = '';
                const filteredData = data.filter(item => item.text.toLowerCase().includes(filter.toLowerCase()));
                filteredData.forEach(item => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'custom-select-option';
                    optionDiv.textContent = item.text;
                    optionDiv.dataset.value = item.value;
                    optionsList.appendChild(optionDiv);
                });
            }

            valueButton.addEventListener('click', (e) => {
                e.stopPropagation();

                const isOpen = container.classList.contains('open');
                document.querySelectorAll('.custom-select-container').forEach(c => c.classList.remove('open'));
                if (!isOpen) {
                    const rect = container.getBoundingClientRect();
                    const spaceBelow = window.innerHeight - rect.bottom;
                    optionsContainer.classList.remove('open-up', 'open-down');
                    if (spaceBelow < 220 && rect.top > 220) { 
                        optionsContainer.classList.add('open-up');
                    } else {
                        optionsContainer.classList.add('open-down');
                    }
                    container.classList.add('open');
                    if (isSearchable) { searchInput.value = ''; searchInput.focus(); }
                    renderOptions(sourceData);
                } else {
                    container.classList.remove('open');
                }
            });

            if (isSearchable) {
                searchInput.addEventListener('input', () => renderOptions(sourceData, searchInput.value));
            }

            optionsList.addEventListener('click', (e) => {
                if (e.target.classList.contains('custom-select-option')) {
                    const value = e.target.dataset.value;
                    const text = e.target.textContent;
                    setCustomSelectValue(container, value, text);
                    container.classList.remove('open');
                    hiddenInput.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });
            renderOptions(sourceData);
        }

        function setCustomSelectValue(container, value, text) {
            const hiddenInput = container.querySelector('input[type="hidden"]');
            const valueSpan = container.querySelector('.custom-select-value span');
            hiddenInput.value = value;
            valueSpan.textContent = text || value;
        }
        
        // --- MOBILE NAV LOGIC ---
        function buildMobileNav() {
            mobileNavLinksContainer.innerHTML = '';
            const desktopNav = document.getElementById('main-nav');
            
            desktopNav.querySelectorAll('.nav-item').forEach(item => {
                const link = item.querySelector('.nav-link');
                const newLink = document.createElement('a');
                newLink.href = '#';
                newLink.className = 'mobile-nav-link';
                newLink.innerHTML = `<i class="${link.querySelector('i').className} w-6 text-center mr-3"></i>${link.querySelector('span').textContent}`;
                
                const dropdown = item.querySelector('.dropdown-menu');
                if (dropdown) {
                    newLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        const subMenu = newLink.nextElementSibling;
                        subMenu.style.display = subMenu.style.display === 'block' ? 'none' : 'block';
                    });
                    mobileNavLinksContainer.appendChild(newLink);

                    const subMenuContainer = document.createElement('div');
                    subMenuContainer.style.display = 'none';
                    subMenuContainer.className = 'ml-8';
                    dropdown.querySelectorAll('.dropdown-link').forEach(ddLink => {
                        const newDdLink = document.createElement('a');
                        newDdLink.href = '#';
                        newDdLink.className = 'mobile-nav-link !py-2 !text-base';
                        newDdLink.textContent = ddLink.textContent;
                        newDdLink.addEventListener('click', (e) => {
                            e.preventDefault();
                            showPage(ddLink.dataset.target);
                            mobileNavMenu.classList.remove('open');
                            modalBackdrop.classList.remove('visible');
                        });
                        subMenuContainer.appendChild(newDdLink);
                    });
                    mobileNavLinksContainer.appendChild(subMenuContainer);

                } else {
                     newLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        showPage(link.dataset.mainTarget);
                        mobileNavMenu.classList.remove('open');
                        modalBackdrop.classList.remove('visible');
                    });
                    mobileNavLinksContainer.appendChild(newLink);
                }
            });

            const divider = document.createElement('hr');
            divider.className = 'border-t border-white/10 my-4';
            mobileNavLinksContainer.appendChild(divider);

            if (currentUserData) {
                const editProfileMobile = document.createElement('a');
                editProfileMobile.href = '#';
                editProfileMobile.className = 'mobile-nav-link';
                editProfileMobile.innerHTML = `<i class="fas fa-user-edit w-6 text-center mr-3"></i>Edit Profile`;
                editProfileMobile.onclick = (e) => { e.preventDefault(); mobileNavMenu.classList.remove('open'); showEditProfileModal(); };
                mobileNavLinksContainer.appendChild(editProfileMobile);

                const logoutMobile = document.createElement('a');
                logoutMobile.href = '#';
                logoutMobile.className = 'mobile-nav-link';
                logoutMobile.innerHTML = `<i class="fas fa-sign-out-alt w-6 text-center mr-3"></i>Logout`;
                logoutMobile.onclick = (e) => { e.preventDefault(); signOut(auth); };
                mobileNavLinksContainer.appendChild(logoutMobile);
            } else {
                const loginMobile = document.createElement('a');
                loginMobile.href = '#';
                loginMobile.className = 'mobile-nav-link';
                loginMobile.innerHTML = `<i class="fas fa-sign-in-alt w-6 text-center mr-3"></i>Login / Register`;
                loginMobile.onclick = (e) => { e.preventDefault(); mobileNavMenu.classList.remove('open'); showAuthModal('login'); };
                mobileNavLinksContainer.appendChild(loginMobile);
            }
        }

        document.getElementById('open-mobile-menu-btn').addEventListener('click', () => {
            mobileNavMenu.classList.add('open');
            modalBackdrop.classList.add('visible');
        });
        document.getElementById('close-mobile-menu-btn').addEventListener('click', () => {
            mobileNavMenu.classList.remove('open');
            modalBackdrop.classList.remove('visible');
        });


        // --- UI & PARTICLE SCRIPTS ---
        const canvas = document.getElementById('particle-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        function createParticles() {
            particles = []; let particleCount = (canvas.width * canvas.height) / 10000;
            for (let i = 0; i < particleCount; i++) { particles.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, vx: (Math.random() - 0.5) * 0.5, vy: (Math.random() - 0.5) * 0.5, size: Math.random() * 1.5 + 0.5, color: Math.random() > 0.3 ? 'rgba(0, 191, 255, 0.5)' : 'rgba(248, 113, 113, 0.1)' }); }
        }
        function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => { p.x += p.vx; p.y += p.vy; if (p.x < 0 || p.x > canvas.width) p.vx *= -1; if (p.y < 0 || p.y > canvas.height) p.vy *= -1; ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); ctx.fill(); });
            requestAnimationFrame(animateParticles);
        }
        window.addEventListener('resize', () => { resizeCanvas(); createParticles(); });
        resizeCanvas(); createParticles(); animateParticles();
        
        const pages = document.querySelectorAll('.page-content');
        function showPage(targetId) {
            pages.forEach(page => { page.style.display = page.id === targetId ? 'block' : 'none'; });
            document.querySelectorAll('#main-nav .nav-link').forEach(link => {
                const mainTarget = link.dataset.mainTarget;
                link.classList.toggle('active', mainTarget === targetId);
            });
        }

        // --- PRESENCE MANAGEMENT ---
        function setupPresenceManagement(user) {
            const userStatusDatabaseRef = dbRef(rtdb, '/status/' + user.uid);
            const userStatusFirestoreRef = doc(db, '/sessions/' + user.uid);

            const isOfflineForRTDB = {
                status: 'offline',
                lastSeen: rtdbServerTimestamp(),
            };
            const isOnlineForRTDB = {
                status: 'online',
                lastSeen: rtdbServerTimestamp(),
            };
            
            const isOfflineForFirestore = {
                status: 'offline',
                lastSeen: serverTimestamp(),
            };
            const isOnlineForFirestore = {
                status: 'online',
                lastSeen: serverTimestamp(),
            };
            
            onValue(dbRef(rtdb, '.info/connected'), (snapshot) => {
                if (snapshot.val() === false) {
                    setDoc(userStatusFirestoreRef, isOfflineForFirestore);
                    return;
                }

                onDisconnect(userStatusDatabaseRef).set(isOfflineForRTDB).then(() => {
                    set(userStatusDatabaseRef, isOnlineForRTDB);
                    setDoc(userStatusFirestoreRef, isOnlineForFirestore);
                });
            });

            function resetAwayTimer() {
                if (awayTimer) clearTimeout(awayTimer);
                
                // If user was away, set them back to online
                if(userSessions[user.uid] && userSessions[user.uid].status === 'away') {
                     updateUserStatus(user.uid, 'online');
                }

                awayTimer = setTimeout(() => {
                    updateUserStatus(user.uid, 'away');
                }, 5 * 60 * 1000); // 5 minutes
            }

            // Listen for activity
            ['mousemove', 'mousedown', 'keydown', 'scroll', 'touchstart'].forEach(event => {
                document.addEventListener(event, resetAwayTimer, { passive: true });
            });
            
            resetAwayTimer(); // Initial call
        }

        function updateUserStatus(uid, status) {
            const userStatusFirestoreRef = doc(db, '/sessions/' + uid);
            const userStatusDatabaseRef = dbRef(rtdb, '/status/' + uid);

            const statusUpdate = {
                status: status,
                lastSeen: serverTimestamp()
            };
            const rtdbStatusUpdate = {
                status: status,
                lastSeen: rtdbServerTimestamp()
            };

            setDoc(userStatusFirestoreRef, statusUpdate, { merge: true });
            set(userStatusDatabaseRef, rtdbStatusUpdate);
        }


        // --- SOCIAL PAGE & CHAT LOGIC ---
        const socialTabBtns = document.querySelectorAll('.social-tab-btn');
        const socialContentPanes = document.querySelectorAll('.social-content-pane');

        socialTabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                socialTabBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                const targetPaneId = `pane-${btn.dataset.tab}`;
                socialContentPanes.forEach(pane => {
                    pane.classList.toggle('active', pane.id === targetPaneId);
                });
            });
        });
        
        function isUserLeader(user) {
            if (!user) return false;
            return user.isAdmin || (user.isVerified && (user.allianceRank === 'R5' || user.allianceRank === 'R4'));
        }

        function setupChatListeners() {
            if (!currentUserData) return;

            // World Chat Listener
            const worldChatQuery = query(collection(db, "world_chat"), orderBy("timestamp", "desc"), limit(50));
            worldChatListener = onSnapshot(worldChatQuery, (snapshot) => {
                const messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderMessages(messages, document.getElementById('world-chat-window'), 'world_chat');
            });

            // Alliance Chat Listener
            if (currentUserData.alliance) {
                const allianceChatQuery = query(collection(db, `alliance_chats/${currentUserData.alliance}/messages`), orderBy("timestamp", "desc"), limit(50));
                allianceChatListener = onSnapshot(allianceChatQuery, (snapshot) => {
                    const messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderMessages(messages, document.getElementById('alliance-chat-window'), 'alliance_chat');
                });
            }

            // Leadership Chat Listener
            if (isUserLeader(currentUserData)) {
                const leadershipChatQuery = query(collection(db, "leadership_chat"), orderBy("timestamp", "desc"), limit(50));
                leadershipChatListener = onSnapshot(leadershipChatQuery, (snapshot) => {
                    const messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderMessages(messages, document.getElementById('leadership-chat-window'), 'leadership_chat');
                });
            }
        }

        function detachAllListeners() {
            if (worldChatListener) worldChatListener();
            if (allianceChatListener) allianceChatListener();
            if (leadershipChatListener) leadershipChatListener();
            if (notificationListener) notificationListener();
            worldChatListener = null;
            allianceChatListener = null;
            leadershipChatListener = null;
            notificationListener = null;
            if (awayTimer) clearTimeout(awayTimer);
        }

        function renderMessages(messages, container, chatType) {
            container.innerHTML = ''; // Clear previous messages
            if (messages.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 m-auto">No messages yet. Be the first to say something!</p>`;
                return;
            }
            messages.forEach(msg => {
                const isSelf = msg.authorUid === currentUserData.uid;
                const canDelete = currentUserData.isAdmin || (chatType === 'alliance_chat' && currentUserData.allianceRank === 'R5');
                
                const avatarUrl = msg.authorAvatarUrl || `https://placehold.co/48x48/0D1117/FFFFFF?text=${msg.authorUsername.charAt(0).toUpperCase()}`;
                const session = userSessions[msg.authorUid];
                const statusClass = session ? session.status : 'offline';

                const messageEl = document.createElement('div');
                messageEl.className = `chat-message ${isSelf ? 'self' : ''}`;
                messageEl.innerHTML = `
                    <img src="${avatarUrl}" class="w-8 h-8 rounded-full flex-shrink-0" alt="${msg.authorUsername}">
                    <div class="chat-message-bubble">
                        <p class="chat-message-author">${msg.authorUsername} <span class="status-dot ${statusClass}"></span></p>
                        <p class="text-sm">${msg.text}</p>
                    </div>
                    ${canDelete ? `<button class="delete-message-btn" data-id="${msg.id}" data-type="${chatType}"><i class="fas fa-times"></i></button>` : ''}
                `;
                container.appendChild(messageEl);
            });
        }

        async function handleSendMessage(e, chatType) {
            e.preventDefault();
            if (!currentUserData) return;

            let input, collectionPath;
            switch(chatType) {
                case 'world_chat':
                    input = document.getElementById('world-chat-input');
                    collectionPath = 'world_chat';
                    break;
                case 'alliance_chat':
                    input = document.getElementById('alliance-chat-input');
                    if (!currentUserData.alliance) return;
                    collectionPath = `alliance_chats/${currentUserData.alliance}/messages`;
                    break;
                case 'leadership_chat':
                    input = document.getElementById('leadership-chat-input');
                    collectionPath = 'leadership_chat';
                    break;
            }

            const text = input.value.trim();
            if (text === '') return;
            input.value = '';

            const messageData = {
                text: text,
                authorUid: currentUserData.uid,
                authorUsername: currentUserData.username,
                authorAvatarUrl: currentUserData.avatarUrl || null,
                alliance: currentUserData.alliance,
                timestamp: serverTimestamp()
            };

            try {
                await addDoc(collection(db, collectionPath), messageData);
            } catch (error) {
                console.error(`Error sending message to ${chatType}:`, error);
                input.value = text; // Restore text on failure
            }
        }

        document.getElementById('world-chat-form').addEventListener('submit', (e) => handleSendMessage(e, 'world_chat'));
        document.getElementById('alliance-chat-form').addEventListener('submit', (e) => handleSendMessage(e, 'alliance_chat'));
        document.getElementById('leadership-chat-form').addEventListener('submit', (e) => handleSendMessage(e, 'leadership_chat'));
        
        async function handleDeleteMessage(e) {
            const deleteBtn = e.target.closest('.delete-message-btn');
            if (!deleteBtn) return;

            const messageId = deleteBtn.dataset.id;
            const chatType = deleteBtn.dataset.type;
            
            let docPath;
             switch(chatType) {
                case 'world_chat':
                    docPath = `world_chat/${messageId}`;
                    break;
                case 'alliance_chat':
                    if (!currentUserData.alliance) return;
                    docPath = `alliance_chats/${currentUserData.alliance}/messages/${messageId}`;
                    break;
                case 'leadership_chat':
                    docPath = `leadership_chat/${messageId}`;
                    break;
                default:
                    return;
            }

            showConfirmationModal('Delete Message?', 'Are you sure you want to permanently delete this message?', async () => {
                try {
                    await deleteDoc(doc(db, docPath));
                } catch (error) {
                    console.error("Error deleting message:", error);
                }
            });
        }

        document.getElementById('page-social').addEventListener('click', handleDeleteMessage);
        
        // --- NOTIFICATION / FEED LOGIC ---
        function setupNotificationListener(user) {
            const q = query(collection(db, "notifications"), where("recipientUid", "==", user.uid), orderBy("timestamp", "desc"));
            notificationListener = onSnapshot(q, (snapshot) => {
                userNotifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderNotifications(userNotifications);
            });
        }

        function renderNotifications(notifications) {
            const unreadCount = notifications.filter(n => !n.isRead).length;
            
            if (unreadCount > 0) {
                notificationBadge.textContent = unreadCount;
                notificationBadge.classList.add('visible');
            } else {
                notificationBadge.classList.remove('visible');
            }

            if (notifications.length === 0) {
                feedDropdown.innerHTML = '<p class="text-center text-gray-500 p-4">No new notifications.</p>';
                feedPageContainer.innerHTML = '<p class="text-center text-gray-500 p-8">Your feed is empty.</p>';
                return;
            }

            feedDropdown.innerHTML = notifications.slice(0, 5).map(n => createNotificationHTML(n, 'dropdown')).join('');
            feedPageContainer.innerHTML = notifications.map(n => createNotificationHTML(n, 'page')).join('');
        }

        function createNotificationHTML(notification, context) {
            const timeAgo = notification.timestamp ? formatTimeAgo(notification.timestamp.toDate()) : '';
            const isReadClass = notification.isRead ? '' : 'is-read';
            
            let iconHTML = '';
            let actionsHTML = '';

            switch(notification.type) {
                case 'friend_request':
                    iconHTML = `<div class="notification-icon bg-blue-500/20 text-blue-400"><i class="fas fa-user-plus"></i></div>`;
                    actionsHTML = `
                        <div class="notification-actions">
                            <button class="notification-action-btn primary-btn" data-action="accept-friend" data-sender-uid="${notification.senderUid}">Accept</button>
                            <button class="notification-action-btn secondary-btn" data-action="decline-friend">Decline</button>
                        </div>
                    `;
                    break;
                case 'verification_request':
                     iconHTML = `<div class="notification-icon bg-yellow-500/20 text-yellow-400"><i class="fas fa-user-check"></i></div>`;
                     actionsHTML = `
                        <div class="notification-actions">
                             <button class="notification-action-btn primary-btn" data-action="verify-user" data-target-uid="${notification.senderUid}">Verify User</button>
                        </div>
                     `;
                    break;
                case 'alliance_announcement':
                    iconHTML = `<div class="notification-icon bg-red-500/20 text-red-400"><i class="fas fa-bullhorn"></i></div>`;
                    break;
                default:
                    iconHTML = `<div class="notification-icon bg-gray-500/20 text-gray-400"><i class="fas fa-bell"></i></div>`;
            }

            return `
                <div class="notification-item ${isReadClass}" data-id="${notification.id}" data-type="${notification.type}" data-sender-uid="${notification.senderUid}">
                    ${iconHTML}
                    <div class="notification-content">
                        <p class="notification-text">${notification.message}</p>
                        <p class="notification-time">${timeAgo}</p>
                        ${notification.isRead ? '' : actionsHTML}
                    </div>
                </div>
            `;
        }
        
        async function handleNotificationClick(e) {
            const item = e.target.closest('.notification-item');
            if (!item) return;

            const notificationId = item.dataset.id;
            const notification = userNotifications.find(n => n.id === notificationId);
            if (!notification) return;

            const actionBtn = e.target.closest('.notification-action-btn');
            
            if (actionBtn) {
                const action = actionBtn.dataset.action;
                const senderUid = notification.senderUid;

                if (action === 'accept-friend') {
                    const batch = writeBatch(db);
                    // Add to both users' friends subcollection
                    batch.set(doc(db, `users/${currentUserData.uid}/friends/${senderUid}`), { since: serverTimestamp() });
                    batch.set(doc(db, `users/${senderUid}/friends/${currentUserData.uid}`), { since: serverTimestamp() });
                    // Delete the notification
                    batch.delete(doc(db, 'notifications', notificationId));
                    await batch.commit();
                } else if (action === 'decline-friend') {
                    await deleteDoc(doc(db, 'notifications', notificationId));
                } else if (action === 'verify-user') {
                    const targetUid = actionBtn.dataset.targetUid;
                    await updateDoc(doc(db, 'users', targetUid), { isVerified: true });
                    await deleteDoc(doc(db, 'notifications', notificationId));
                }
            } else {
                // If not clicking an action button, mark as read
                if (!notification.isRead) {
                    await updateDoc(doc(db, 'notifications', notificationId), { isRead: true });
                }
            }
        }

        feedDropdown.addEventListener('click', handleNotificationClick);
        feedPageContainer.addEventListener('click', handleNotificationClick);


        // --- GLOBAL EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            renderSkeletons(); // Show placeholders on initial load
            document.querySelectorAll('.custom-select-container').forEach(setupCustomSelect);

            const navItems = document.querySelectorAll('.nav-item');
            
            navItems.forEach(item => {
                const link = item.querySelector('.nav-link');
                const dropdown = item.querySelector('.dropdown-menu');
                
                if (dropdown) {
                    item.addEventListener('mouseenter', () => { if (window.innerWidth > 768) item.classList.add('open'); });
                    item.addEventListener('mouseleave', () => { if (window.innerWidth > 768) item.classList.remove('open'); });
                    link.addEventListener('click', (e) => {
                        if (window.innerWidth <= 768) {
                            e.preventDefault();
                            e.stopPropagation();
                            const wasOpen = item.classList.contains('open');
                            navItems.forEach(i => i.classList.remove('open'));
                            if (!wasOpen) item.classList.add('open');
                        }
                    });
                } else {
                    link.addEventListener('click', () => showPage(link.dataset.mainTarget));
                }
            });
            
            window.addEventListener('click', (e) => { 
                if (!e.target.closest('.nav-item')) {
                    document.querySelectorAll('.nav-item.open').forEach(item => item.classList.remove('open'));
                }
                if (!e.target.closest('#user-profile-container')) {
                    userProfileContainer.classList.remove('open');
                }
                if (!e.target.closest('.custom-select-container')) {
                    document.querySelectorAll('.custom-select-container').forEach(c => c.classList.remove('open'));
                }
            });

            document.querySelectorAll('.dropdown-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const targetId = link.dataset.target;
                    if (targetId) showPage(targetId);
                    link.closest('.nav-item').classList.remove('open');
                });
            });

            eventsMainContainer.addEventListener('click', e => {
                const actionsBtn = e.target.closest('.post-card-actions-trigger');
                if (actionsBtn) {
                    const postId = actionsBtn.dataset.postId;
                    showPostActionsModal(postId);
                }
                const createAnnouncementBtn = e.target.closest('#create-announcement-btn');
                if (createAnnouncementBtn) {
                    showCreatePostModal('announcement');
                }

                const createEventBtn = e.target.closest('#create-event-btn');
                if (createEventBtn) {
                    showCreatePostModal('event');
                }
            });

            document.getElementById('modal-edit-post-btn').addEventListener('click', () => {
                if (actionPostId) {
                    hideAllModals();
                    populatePostFormForEdit(actionPostId);
                }
            });

            document.getElementById('modal-delete-post-btn').addEventListener('click', () => {
                if (actionPostId) {
                    const postToDelete = allPosts.find(p => p.id === actionPostId);
                    hideAllModals();
                    showConfirmationModal('Delete Post?', `Are you sure you want to delete "${postToDelete.title}"? This action cannot be undone.`, () => {
                        deleteDoc(doc(db, 'posts', actionPostId))
                            .catch(err => console.error("Error deleting post: ", err));
                    });
                }
            });

            showPage('page-events'); 
            document.querySelectorAll('.power-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    let value = String(e.target.value).replace(/,/g, '');
                    if (isNaN(value)) { e.target.value = ''; return; }
                    e.target.value = Number(value).toLocaleString('en-US');
                });
            });
            
            // Player card action for sending friend request
            playerListContainer.addEventListener('click', async (e) => {
                const addFriendBtn = e.target.closest('.add-friend-btn');
                if (addFriendBtn && currentUserData) {
                    const playerCard = addFriendBtn.closest('.player-card');
                    const recipientUid = playerCard.dataset.uid;
                    if (recipientUid === currentUserData.uid) return; // Can't add self

                    addFriendBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
                    
                    try {
                        await addDoc(collection(db, 'notifications'), {
                            recipientUid: recipientUid,
                            senderUid: currentUserData.uid,
                            senderUsername: currentUserData.username,
                            senderAvatarUrl: currentUserData.avatarUrl || null,
                            type: 'friend_request',
                            message: `${currentUserData.username} sent you a friend request.`,
                            isRead: false,
                            timestamp: serverTimestamp()
                        });
                        addFriendBtn.innerHTML = `<i class="fas fa-check"></i>`;
                        addFriendBtn.title = "Request Sent";
                        addFriendBtn.disabled = true;
                    } catch (error) {
                        console.error("Error sending friend request:", error);
                        addFriendBtn.innerHTML = `<i class="fas fa-user-plus"></i>`;
                    }
                }
            });
        });
    </script>
</body>
</html>
