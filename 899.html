<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Last War: Survival - 899 Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        :root {
            --color-bg: #0D1117;
            --color-primary: #00BFFF; /* Brighter Blue */
            --color-highlight: #F87171; /* High-contrast Red */
            --color-glass-bg: rgba(22, 27, 34, 0.40); 
            --color-dropdown-bg: rgba(18, 24, 33, 0.98); /* Increased opacity */
        }

        @keyframes pulse-live {
            0%, 100% { box-shadow: 0 0 8px var(--color-primary); }
            50% { box-shadow: 0 0 16px var(--color-primary); }
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-10px); } }
        @keyframes success-pop { 
            0% { transform: scale(0.7); opacity: 0; }
            80% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes slideOutRight { from { transform: translateX(0); } to { transform: translateX(100%); } }

        body { font-family: 'Inter', sans-serif; background-color: var(--color-bg); color: #c9d1d9; overflow-x: hidden; }
        
        #particle-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: radial-gradient(circle at top left, rgba(0, 191, 255, 0.1), transparent 40%), radial-gradient(circle at bottom right, rgba(248, 113, 113, 0.1), transparent 40%);
        }
        
        .glass-pane {
            background-color: var(--color-glass-bg);
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border-radius: 1rem; border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .header-main { 
            padding: 0.75rem 1.5rem; 
            position: relative;
            z-index: 50;
        }
        .nav-item { position: relative; }
        .nav-link {
            position: relative; padding: 0.5rem; font-weight: 600; font-size: 0.75rem;
            color: #c9d1d9; transition: color 0.3s ease; display: flex;
            flex-direction: column; align-items: center; gap: 0.25rem;
            width: 80px; cursor: pointer;
        }
        .nav-link i { font-size: 1rem; }
        .nav-link:hover { color: #fff; }
        .nav-link::after {
            content: ''; position: absolute; bottom: 0; left: 20%; right: 20%; height: 2px;
            background-color: var(--color-primary); transform: scaleX(0);
            transform-origin: center; transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
        }
        .nav-item:hover .nav-link::after, .nav-link.active::after { transform: scaleX(1); }
        .nav-link.active { color: #fff; }
        
        .dropdown-pane {
            position: absolute;
            opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0s 0.3s;
            z-index: 100;
            padding: 0.5rem;
            min-width: 180px;
            border-top: 2px solid var(--color-primary);
        }
        .dropdown-menu {
            top: calc(100% + 12px); left: 50%;
            transform: translateX(-50%) translateY(-10px);
        }
        .nav-item.open .dropdown-menu {
            transform: translateX(-50%) translateY(0);
            opacity: 1; visibility: visible;
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0s 0s;
        }
        .dropdown-link {
            display: block; padding: 0.6rem 1rem; border-radius: 0.5rem;
            font-size: 0.875rem; color: #c9d1d9;
            transition: background-color 0.2s ease, color 0.2s ease;
            white-space: nowrap; cursor: pointer;
        }
        .dropdown-link:hover { background-color: rgba(0, 191, 255, 0.1); color: #fff; }

        .auth-button {
            padding: 0.6rem 1.25rem; font-weight: 600; font-size: 0.875rem;
            color: #c9d1d9; background-color: rgba(255,255,255,0.05);
            border-radius: 0.5rem; border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            display: flex; align-items: center; gap: 0.5rem;
        }
        .auth-button:hover {
            color: #fff; background-color: rgba(0, 191, 255, 0.1);
            border-color: var(--color-primary);
        }

        .section-container { padding: 1.25rem; }
        
        /* --- Modal Styles --- */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        .modal-container {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            z-index: 1001;
            width: 90%;
            max-width: 500px;
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: none;
        }
        .modal-backdrop.visible, .modal-container.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-container.visible {
             transform: translate(-50%, -50%) scale(1);
        }
        .auth-form {
            display: none;
            animation: fadeIn 0.5s forwards;
        }
        .auth-form.active {
            display: block;
        }
        
        .input-group {
            position: relative; /* Added for dropdown positioning */
            display: flex;
            align-items: center;
            background-color: rgba(13, 17, 23, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .input-group:focus-within {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(0, 191, 255, 0.3);
        }
        .input-icon {
            padding: 0 0.75rem;
            color: #667;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }
        .input-group:focus-within .input-icon {
            color: var(--color-primary);
        }
        .form-input, .form-textarea {
            background-color: transparent;
            border: none;
            color: #c9d1d9;
            padding: 0.75rem;
            width: 100%;
        }
        .form-input:focus, .form-textarea:focus {
            outline: none;
            box-shadow: none;
        }
        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .primary-btn {
            background-color: var(--color-primary);
            color: var(--color-bg);
            font-weight: 700;
            transition: all 0.3s ease;
        }
        .primary-btn:hover {
            background-color: #00a9e0;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 191, 255, 0.2);
        }
        .primary-btn:disabled {
            background-color: #555;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .secondary-btn {
            background-color: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #c9d1d9;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .secondary-btn:hover {
            background-color: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.3);
        }
        .form-error {
            min-height: 20px;
        }
        
        /* Stepper (Registration & Post Creation) */
        .progress-bar { display: flex; justify-content: space-between; margin-bottom: 2rem; position: relative; }
        .progress-bar::before { content: ''; position: absolute; top: 50%; left: 0; transform: translateY(-50%); height: 2px; width: 100%; background-color: rgba(255,255,255,0.1); z-index: -1; }
        .progress-bar .line { position: absolute; top: 50%; left: 0; transform: translateY(-50%); height: 2px; background-color: var(--color-primary); width: 0%; transition: width 0.4s ease; z-index: 0; }
        .progress-step { width: 30px; height: 30px; background-color: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.4s ease; position: relative; z-index: 1; }
        .progress-step.active { background-color: var(--color-primary); border-color: var(--color-primary); color: var(--color-bg); }
        .form-slide { display: none; animation: fadeIn 0.5s ease-in-out; }
        .form-slide.active { display: block; }
        #registration-success { display: none; text-align: center; animation: success-pop 0.5s ease-out forwards; }
        #registration-success .success-icon { font-size: 4rem; color: var(--color-primary); }

        .type-selection-card {
            border: 2px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }
        .type-selection-card:hover {
            border-color: var(--color-primary);
            background-color: rgba(0, 191, 255, 0.05);
            transform: translateY(-5px);
        }
        .type-selection-card i {
            transition: all 0.3s ease;
        }
        .type-selection-card:hover i {
            color: var(--color-primary);
            transform: scale(1.1);
        }

        /* Player Card Dropdown */
        #player-card-dropdown { 
            top: calc(100% + 10px); 
            right: 0; 
            min-width: 250px;
            transform: translateY(-10px);
        }
        #user-profile-container.open #player-card-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        /* Custom Select Dropdown */
        .custom-select-container { position: relative; flex-grow: 1; }
        .custom-select-value { display: flex; align-items: center; justify-content: space-between; width: 100%; text-align: left; }
        .custom-select-options { 
            display: block;
            position: absolute; 
            left: 0;
            right: 0; 
            max-height: 180px; /* Approx 4.5 items */
            overflow-y: auto; 
            z-index: 1050; /* Increased z-index to appear over modal content */
            opacity: 0;
            visibility: hidden;
            transform: scaleY(0.95);
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0s 0.2s;
            background-color: var(--color-dropdown-bg);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 0.5rem;
            padding: 0.5rem;
        }
        .custom-select-options.open-down {
            top: calc(100% + 8px);
            transform-origin: top;
        }
        .custom-select-options.open-up {
            bottom: calc(100% + 8px);
            transform-origin: bottom;
        }
        .custom-select-container.open .custom-select-options {
            opacity: 1;
            visibility: visible;
            transform: scaleY(1);
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0s 0s;
        }
        .custom-select-option { display: block; padding: 0.75rem 1rem; cursor: pointer; border-radius: 0.375rem; }
        .custom-select-option:hover { background-color: rgba(0, 191, 255, 0.1); }
        .custom-select-search { background-color: rgba(13, 17, 23, 1); border: none; border-bottom: 1px solid rgba(255,255,255,0.2); padding: 0.75rem; width: 100%; color: #c9d1d9; }
        .custom-select-search:focus { outline: none; border-color: var(--color-primary); }
        /* Custom Scrollbar */
        .custom-select-options::-webkit-scrollbar { width: 8px; }
        .custom-select-options::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 10px; }
        .custom-select-options::-webkit-scrollbar-thumb { background: var(--color-primary); border-radius: 10px; }
        .custom-select-options::-webkit-scrollbar-thumb:hover { background: #00a9e0; }

        /* Mobile Nav */
        #mobile-nav-menu {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 280px;
            z-index: 200;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #mobile-nav-menu.open {
            transform: translateX(0);
        }
        .mobile-nav-link {
            display: block;
            padding: 1rem 1.5rem;
            font-size: 1.125rem;
            font-weight: 600;
            color: #c9d1d9;
            transition: all 0.2s ease;
        }
        .mobile-nav-link:hover {
            background-color: rgba(0, 191, 255, 0.1);
            color: #fff;
        }
        
        /* Podium Styles */
        .podium-card {
            display: flex; flex-direction: column; text-align: center;
            padding: 1.5rem; transition: all 0.3s ease;
        }
        .podium-gold { border-image: linear-gradient(to bottom, #FFD700, #FBBF24) 1; }
        .podium-silver { border-image: linear-gradient(to bottom, #C0C0C0, #D1D5DB) 1; }
        .podium-bronze { border-image: linear-gradient(to bottom, #CD7F32, #D97706) 1; }
        
        /* Verification Toggle */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            transition: .4s;
            border-radius: 28px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--color-primary);
        }
        input:checked + .slider:before {
            transform: translateX(22px);
        }

        /* Post/Event Card Styles */
        .post-card {
            border-left: 4px solid;
            transition: all 0.3s ease;
        }
        .post-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .post-tag {
            font-size: 0.75rem;
            font-weight: 700;
            padding: 0.25rem 0.6rem;
            border-radius: 9999px;
            text-transform: uppercase;
        }
    </style>
</head>
<body>
    <canvas id="particle-canvas"></canvas>

    <!-- Mobile Nav Menu -->
    <div id="mobile-nav-menu" class="glass-pane !rounded-l-lg !rounded-r-none">
        <div class="p-4 flex justify-end">
             <button id="close-mobile-menu-btn" class="text-gray-400 hover:text-white"><i class="fas fa-times fa-2x"></i></button>
        </div>
        <nav id="mobile-nav-links" class="flex flex-col mt-4"></nav>
    </div>

    <!-- Auth & Edit Modals -->
    <div id="modal-backdrop" class="modal-backdrop"></div>
    <div id="auth-modal-container" class="modal-container">
        <div class="glass-pane p-6 sm:p-8 relative overflow-hidden">
            <button id="close-auth-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-white transition-colors z-10">
                <i class="fas fa-times fa-lg"></i>
            </button>
            <!-- Login Form -->
            <div id="login-form-container" class="auth-form">
                <h2 class="text-2xl font-bold text-white text-center mb-4">Login</h2>
                <p class="text-center text-gray-400 mb-6">Welcome back to the 899 Hub.</p>
                <form id="login-form">
                    <div class="space-y-4">
                        <div class="input-group"><i class="fas fa-envelope input-icon"></i><input type="email" id="login-email" placeholder="Email" class="form-input" required></div>
                        <div class="input-group"><i class="fas fa-lock input-icon"></i><input type="password" id="login-password" placeholder="Password" class="form-input" required></div>
                    </div>
                    <p id="login-error" class="text-red-400 text-center text-sm mt-4 form-error"></p>
                    <button type="submit" id="login-submit-btn" class="w-full p-3 rounded-lg primary-btn mt-2">Login</button>
                    <div class="text-center text-sm text-gray-400 mt-6">
                        <a href="#" id="forgot-password-link" class="font-semibold hover:text-white" style="color: var(--color-primary);">Forgot Password?</a>
                    </div>
                    <p class="text-center text-sm text-gray-400 mt-4">
                        Don't have an account? <a href="#" id="show-register-link" class="font-semibold hover:text-white" style="color: var(--color-primary);">Register here</a>
                    </p>
                </form>
            </div>
            <!-- Registration Form -->
            <div id="register-form-container" class="auth-form">
                <div id="registration-flow">
                    <h2 class="text-2xl font-bold text-white text-center mb-4">Create Account</h2>
                    <div class="progress-bar" id="register-progress-bar">
                        <div class="line"></div>
                        <div class="progress-step active" data-step="1"><i class="fas fa-user-circle"></i></div>
                        <div class="progress-step" data-step="2"><i class="fas fa-shield-alt"></i></div>
                        <div class="progress-step" data-step="3"><i class="fas fa-fist-raised"></i></div>
                        <div class="progress-step" data-step="4"><i class="fas fa-camera"></i></div>
                    </div>
                    <form id="register-form">
                        <div class="form-slide active" data-slide="1"><p class="text-center text-gray-400 mb-6">Step 1: Your Account Details</p><div class="space-y-4">
                            <div class="input-group"><i class="fas fa-user input-icon"></i><input type="text" id="register-username" placeholder="Username" class="form-input" required></div>
                            <div class="input-group"><i class="fas fa-envelope input-icon"></i><input type="email" id="register-email" placeholder="Email" class="form-input" required></div>
                            <div class="input-group"><i class="fas fa-lock input-icon"></i><input type="password" id="register-password" placeholder="Password (min. 6 characters)" class="form-input" required></div>
                            <div class="input-group"><i class="fas fa-check-circle input-icon"></i><input type="password" id="register-password-verify" placeholder="Verify Password" class="form-input" required></div>
                        </div></div>
                        <div class="form-slide" data-slide="2"><p class="text-center text-gray-400 mb-6">Step 2: Alliance Information</p><div class="space-y-4">
                             <div class="input-group"><i class="fas fa-shield-alt input-icon"></i>
                                <div class="custom-select-container" data-type="alliance">
                                    <input type="hidden" id="register-alliance" name="alliance" required>
                                    <button type="button" class="custom-select-value form-input"><span>Select Alliance</span><i class="fas fa-chevron-down text-xs"></i></button>
                                    <div class="custom-select-options">
                                        <input type="text" class="custom-select-search" placeholder="Search alliances...">
                                        <div class="options-list"></div>
                                    </div>
                                </div>
                             </div>
                            <div class="input-group"><i class="fas fa-star input-icon"></i>
                                <div class="custom-select-container" data-type="rank">
                                    <input type="hidden" id="register-alliance-rank" name="alliance-rank" required>
                                    <button type="button" class="custom-select-value form-input"><span>Select Alliance Rank</span><i class="fas fa-chevron-down text-xs"></i></button>
                                    <div class="custom-select-options">
                                        <div class="options-list"></div>
                                    </div>
                                </div>
                            </div>
                        </div></div>
                        <div class="form-slide" data-slide="3"><p class="text-center text-gray-400 mb-6">Step 3: Your Power Stats</p><div class="space-y-4">
                            <div class="input-group"><i class="fas fa-fist-raised input-icon"></i><input type="text" id="register-power" placeholder="Total Power (e.g., 150,000,000)" class="power-input form-input" required></div>
                            <div class="input-group"><i class="fas fa-truck-monster input-icon"></i><input type="text" id="register-tank-power" placeholder="Tank Power" class="power-input form-input" required></div>
                            <div class="input-group"><i class="fas fa-fighter-jet input-icon"></i><input type="text" id="register-air-power" placeholder="Air Power" class="power-input form-input" required></div>
                            <div class="input-group"><i class="fas fa-rocket input-icon"></i><input type="text" id="register-missile-power" placeholder="Missile Power" class="power-input form-input" required></div>
                        </div></div>
                        <div class="form-slide" data-slide="4">
                            <p class="text-center text-gray-400 mb-6">Step 4: Upload an Avatar (Optional)</p>
                            <div class="flex flex-col items-center gap-4">
                                <img id="register-avatar-preview" src="https://placehold.co/128x128/161B22/FFFFFF?text=Avatar" class="w-32 h-32 rounded-full object-cover border-2 border-white/20">
                                <button type="button" id="register-avatar-btn" class="w-full p-3 rounded-lg secondary-btn">
                                    <i class="fas fa-upload mr-2"></i> Choose Image
                                </button>
                                <input type="file" id="register-avatar-input" class="hidden" accept="image/*">
                            </div>
                        </div>
                        <p id="register-error" class="text-red-400 text-center text-sm mt-4 form-error"></p>
                        <div id="register-nav-container" class="flex items-center mt-6"><button type="button" id="register-back-btn" class="px-6 py-2 rounded-lg secondary-btn flex items-center"><i class="fas fa-arrow-left mr-2"></i>Back</button><div class="flex-grow flex justify-center"><button type="button" id="register-next-btn" class="px-6 py-2 rounded-lg primary-btn flex items-center">Next<i class="fas fa-arrow-right ml-2"></i></button><button type="submit" id="register-submit-btn" class="px-6 py-2 rounded-lg primary-btn hidden flex items-center"><i class="fas fa-check-circle mr-2"></i>Register</button></div></div>
                        <p class="text-center text-sm text-gray-400 mt-6">Already have an account? <a href="#" id="show-login-link" class="font-semibold hover:text-white" style="color: var(--color-primary);">Login here</a></p>
                    </form>
                </div>
                <div id="registration-success">
                    <i class="fas fa-check-circle success-icon"></i>
                    <h2 class="text-2xl font-bold text-white mt-4">Registration Complete!</h2>
                    <p class="text-gray-400 mt-2">Welcome to the 899 Hub. You will be logged in shortly.</p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="edit-profile-modal-container" class="modal-container">
         <div class="glass-pane p-6 sm:p-8 relative overflow-hidden">
            <button id="close-edit-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-white transition-colors z-10">
                <i class="fas fa-times fa-lg"></i>
            </button>
            <h2 class="text-2xl font-bold text-white text-center mb-6">Edit Your Profile</h2>
            <form id="edit-profile-form">
                 <div class="space-y-4">
                    <div class="input-group"><i class="fas fa-user input-icon"></i><input type="text" id="edit-username" placeholder="Username" class="form-input" required></div>
                    <div class="input-group"><i class="fas fa-shield-alt input-icon"></i>
                        <div class="custom-select-container w-full" data-type="alliance">
                            <input type="hidden" id="edit-alliance" name="alliance" required>
                            <button type="button" class="custom-select-value form-input"><span>Select Alliance</span><i class="fas fa-chevron-down text-xs"></i></button>
                            <div class="custom-select-options dropdown-pane glass-pane">
                                <input type="text" class="custom-select-search" placeholder="Search alliances...">
                                <div class="options-list"></div>
                            </div>
                        </div>
                    </div>
                    <div class="input-group"><i class="fas fa-star input-icon"></i>
                         <div class="custom-select-container w-full" data-type="rank">
                            <input type="hidden" id="edit-alliance-rank" name="alliance-rank" required>
                            <button type="button" class="custom-select-value form-input"><span>Select Alliance Rank</span><i class="fas fa-chevron-down text-xs"></i></button>
                            <div class="custom-select-options dropdown-pane glass-pane">
                                <div class="options-list"></div>
                            </div>
                        </div>
                    </div>
                    <div class="input-group"><i class="fas fa-fist-raised input-icon"></i><input type="text" id="edit-power" placeholder="Total Power" class="power-input form-input" required></div>
                    <div class="input-group"><i class="fas fa-truck-monster input-icon"></i><input type="text" id="edit-tank-power" placeholder="Tank Power" class="power-input form-input" required></div>
                    <div class="input-group"><i class="fas fa-fighter-jet input-icon"></i><input type="text" id="edit-air-power" placeholder="Air Power" class="power-input form-input" required></div>
                    <div class="input-group"><i class="fas fa-rocket input-icon"></i><input type="text" id="edit-missile-power" placeholder="Missile Power" class="power-input form-input" required></div>
                </div>
                <p id="edit-profile-error" class="text-red-400 text-center text-sm mt-4 form-error"></p>
                <button type="submit" class="w-full p-3 rounded-lg primary-btn mt-6">Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Player Settings Modal -->
    <div id="player-settings-modal-container" class="modal-container">
         <div class="glass-pane p-6 sm:p-8 relative overflow-hidden">
            <button id="close-player-settings-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-white transition-colors z-10">
                <i class="fas fa-times fa-lg"></i>
            </button>
            <h2 class="text-2xl font-bold text-white text-center mb-2">Player Settings</h2>
            <p id="player-settings-username" class="text-center text-gray-400 mb-6"></p>
            <form id="player-settings-form">
                 <div class="space-y-4">
                    <div class="input-group"><i class="fas fa-star input-icon"></i>
                         <div class="custom-select-container w-full" data-type="rank">
                            <input type="hidden" id="setting-alliance-rank" name="alliance-rank" required>
                            <button type="button" class="custom-select-value form-input"><span>Select Alliance Rank</span><i class="fas fa-chevron-down text-xs"></i></button>
                            <div class="custom-select-options">
                                <div class="options-list"></div>
                            </div>
                        </div>
                    </div>
                    <div class="input-group"><i class="fas fa-user-tag input-icon"></i>
                         <div class="custom-select-container w-full" data-type="role">
                            <input type="hidden" id="setting-alliance-role" name="alliance-role">
                            <button type="button" class="custom-select-value form-input"><span>Select Alliance Role</span><i class="fas fa-chevron-down text-xs"></i></button>
                            <div class="custom-select-options">
                                <div class="options-list"></div>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center justify-between bg-gray-900/50 p-3 rounded-lg">
                        <label for="setting-verified" class="font-semibold text-white">Verified Status</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="setting-verified">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <p id="player-settings-error" class="text-red-400 text-center text-sm mt-4 form-error"></p>
                <button type="submit" class="w-full p-3 rounded-lg primary-btn mt-6">Save Settings</button>
            </form>
        </div>
    </div>

    <!-- Create Event/Announcement Modal -->
    <div id="create-post-modal-container" class="modal-container">
         <div class="glass-pane p-6 sm:p-8 relative overflow-hidden">
            <button id="close-create-post-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-white transition-colors z-10">
                <i class="fas fa-times fa-lg"></i>
            </button>
            <h2 class="text-2xl font-bold text-white text-center mb-4">Create New Post</h2>
            <form id="create-post-form">
                <div id="post-creation-flow">
                    <div class="progress-bar" id="post-progress-bar">
                        <div class="line"></div>
                        <div class="progress-step" data-step="1"><i class="fas fa-clipboard-list"></i></div>
                        <div class="progress-step" data-step="2"><i class="fas fa-tags"></i></div>
                        <div class="progress-step" data-step="3"><i class="fas fa-pencil-alt"></i></div>
                        <div class="progress-step" data-step="4"><i class="fas fa-clock"></i></div>
                    </div>
                     <!-- Slide 1: Main Type -->
                    <div class="form-slide" data-slide="1">
                        <p class="text-center text-gray-400 mb-6">What would you like to create?</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button type="button" data-type="announcement" class="post-type-btn type-selection-card p-6 rounded-lg text-center">
                                <i class="fas fa-bullhorn fa-3x mb-3 text-gray-400"></i>
                                <h3 class="font-bold text-lg text-white">Announcement</h3>
                                <p class="text-sm text-gray-500">Share news with the server or your alliance.</p>
                            </button>
                            <button type="button" data-type="event" class="post-type-btn type-selection-card p-6 rounded-lg text-center">
                                <i class="fas fa-calendar-alt fa-3x mb-3 text-gray-400"></i>
                                <h3 class="font-bold text-lg text-white">Event</h3>
                                <p class="text-sm text-gray-500">Schedule a one-time or recurring event.</p>
                            </button>
                        </div>
                    </div>
                    <!-- Slide 2: Sub-Type -->
                    <div class="form-slide" data-slide="2">
                        <p class="text-center text-gray-400 mb-6">What kind of <span class="font-bold" id="selected-main-type-text">post</span> is this?</p>
                        <div class="input-group"><i class="fas fa-tags input-icon"></i>
                             <div class="custom-select-container w-full" data-type="post-subtype">
                                <input type="hidden" id="post-subtype" name="post-subtype" required>
                                <button type="button" class="custom-select-value form-input"><span>Select Category</span><i class="fas fa-chevron-down text-xs"></i></button>
                                <div class="custom-select-options">
                                    <div class="options-list"></div>
                                </div>
                            </div>
                        </div>
                        <div id="post-alliance-group" class="input-group hidden mt-4"><i class="fas fa-shield-alt input-icon"></i>
                             <div class="custom-select-container w-full" data-type="alliance">
                                <input type="hidden" id="post-alliance" name="post-alliance">
                                <button type="button" class="custom-select-value form-input"><span>Select Alliance</span><i class="fas fa-chevron-down text-xs"></i></button>
                                <div class="custom-select-options">
                                    <input type="text" class="custom-select-search" placeholder="Search alliances...">
                                    <div class="options-list"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Slide 3: Content -->
                    <div class="form-slide" data-slide="3">
                        <p class="text-center text-gray-400 mb-6">Provide the details for your post.</p>
                        <div class="space-y-4">
                            <div class="input-group"><i class="fas fa-heading input-icon"></i><input type="text" id="post-title" placeholder="Title" class="form-input" required></div>
                            <div class="input-group !items-start"><i class="fas fa-align-left input-icon pt-3"></i><textarea id="post-details" placeholder="Details..." class="form-textarea" required></textarea></div>
                        </div>
                    </div>
                     <!-- Slide 4: Timing -->
                    <div class="form-slide" data-slide="4">
                        <p class="text-center text-gray-400 mb-6">Set the schedule for your post.</p>
                        <div id="post-timing-group" class="space-y-4">
                            <div class="flex items-center justify-between bg-gray-900/50 p-3 rounded-lg">
                                <label for="post-repeat-weekly" class="font-semibold text-white">Repeat Weekly</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="post-repeat-weekly">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <!-- Event-specific date/time -->
                            <div id="post-event-dates" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="input-group"><i class="fas fa-calendar-plus input-icon"></i><input type="datetime-local" id="post-start-time" class="form-input" title="Event Start Time"></div>
                                <div class="input-group"><i class="fas fa-calendar-minus input-icon"></i><input type="datetime-local" id="post-end-time" class="form-input" title="Event End Time"></div>
                            </div>
                             <!-- Recurring Announcement Time -->
                            <div id="post-recurring-announcement" class="hidden">
                                 <p class="text-sm text-center text-gray-400">This announcement will repeat weekly at the time it is created.</p>
                            </div>
                            <p class="text-xs text-center text-gray-400">Times are entered in your local timezone and will be converted for all users.</p>
                        </div>
                    </div>
                </div>
                <p id="create-post-error" class="text-red-400 text-center text-sm mt-4 form-error"></p>
                 <div id="post-nav-container" class="flex items-center mt-6">
                    <button type="button" id="post-back-btn" class="px-6 py-2 rounded-lg secondary-btn flex items-center"><i class="fas fa-arrow-left mr-2"></i>Back</button>
                    <div class="flex-grow flex justify-center">
                        <button type="button" id="post-next-btn" class="px-6 py-2 rounded-lg primary-btn flex items-center">Next<i class="fas fa-arrow-right ml-2"></i></button>
                        <button type="submit" id="post-submit-btn" class="px-6 py-2 rounded-lg primary-btn hidden flex items-center"><i class="fas fa-check-circle mr-2"></i>Create Post</button>
                    </div>
                </div>
            </form>
        </div>
    </div>


    <div class="relative min-h-screen w-full p-4 sm:p-6 lg:p-8">
        <div class="max-w-6xl mx-auto">

            <header class="glass-pane header-main flex justify-between items-center mb-6">
                <div class="flex-shrink-0">
                    <h1 class="text-2xl md:text-3xl font-black tracking-tighter text-white">899<span class="font-bold" style="color: var(--color-primary);">EVENTS</span></h1>
                    <p class="text-xs text-gray-400">Official Event Hub</p>
                </div>
                
                <nav id="main-nav" class="hidden md:flex flex-grow justify-center items-center">
                    <div class="nav-item"><div class="nav-link"><i class="fas fa-shield-alt"></i><span>Alliances</span></div><div class="dropdown-menu dropdown-pane glass-pane"><a class="dropdown-link" data-target="page-top-alliances">Top Alliances</a><a class="dropdown-link" data-target="page-alliance-list">Alliance List</a><a class="dropdown-link" data-target="page-recruitment">Recruitment</a></div></div>
                    <div class="nav-item"><div class="nav-link" data-main-target="page-players"><i class="fas fa-users"></i><span>Players</span></div></div>
                    <div class="nav-item"><div class="nav-link active" data-main-target="page-events"><i class="fas fa-calendar-alt"></i><span>Events</span></div></div>
                    <div class="nav-item"><div class="nav-link"><i class="fas fa-trophy"></i><span>Season</span></div><div class="dropdown-menu dropdown-pane glass-pane"><a class="dropdown-link" data-target="page-season-overview">Season Overview</a><a class="dropdown-link" data-target="page-season-rewards">Rewards</a><a class="dropdown-link" data-target="page-season-history">History</a></div></div>
                    <div class="nav-item"><div class="nav-link"><i class="fas fa-tools"></i><span>Tools</span></div><div class="dropdown-menu dropdown-pane glass-pane"><a class="dropdown-link" data-target="page-calculators">Calculators</a><a class="dropdown-link" data-target="page-guides">Guides</a></div></div>
                    <div class="nav-item"><div class="nav-link"><i class="fas fa-globe"></i><span>Language</span></div><div class="dropdown-menu dropdown-pane glass-pane"><a href="#" class="dropdown-link">English</a><a href="#" class="dropdown-link">Espa√±ol</a><a href="#" class="dropdown-link">Deutsch</a></div></div>
                </nav>

                <div id="auth-container" class="hidden md:flex flex-shrink-0 relative">
                    <button id="login-btn" class="auth-button"><i class="fas fa-sign-in-alt fa-fw mr-2"></i>Login</button>
                    <div id="user-profile-container" class="hidden">
                        <button id="player-card-btn" class="auth-button">
                             <img id="user-avatar-button" src="" class="w-6 h-6 rounded-full mr-2 object-cover" alt="User Avatar">
                            <span id="username-display"></span>
                            <i class="fas fa-caret-down ml-2"></i>
                        </button>
                        <div id="player-card-dropdown" class="dropdown-pane glass-pane">
                            <div id="player-card-info" class="p-2 mb-2 border-b border-white/10"></div>
                            <button id="upload-avatar-btn" class="dropdown-link"><i class="fas fa-camera w-6 text-center mr-2"></i>Change Avatar</button>
                            <input type="file" id="avatar-upload-input" class="hidden" accept="image/*">
                            <button id="edit-profile-btn" class="dropdown-link"><i class="fas fa-edit w-6 text-center mr-2"></i>Edit Profile</button>
                            <button id="logout-btn" class="dropdown-link"><i class="fas fa-sign-out-alt w-6 text-center mr-2"></i>Logout</button>
                        </div>
                    </div>
                </div>
                <button id="open-mobile-menu-btn" class="md:hidden text-white"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg></button>
            </header>

            <!-- Page Content Container -->
            <div id="page-container">
                <!-- Players Page -->
                <div id="page-players" class="page-content" style="display: none;">
                    <div class="glass-pane section-container">
                        <div class="text-center mb-8">
                            <h2 class="text-3xl font-bold text-white tracking-wider" style="text-shadow: 0 0 10px var(--color-primary);">PLAYERS OF 899</h2>
                            <div class="themed-line-break mx-auto mt-2"></div>
                        </div>

                        <div class="flex flex-col md:flex-row gap-4 mb-6">
                            <div class="input-group flex-grow">
                                <i class="fas fa-search input-icon"></i>
                                <input type="text" id="player-search-input" placeholder="Search by player name..." class="form-input">
                            </div>
                            <div class="input-group md:max-w-xs">
                                <i class="fas fa-shield-alt input-icon"></i>
                                <div class="custom-select-container" data-type="alliance-filter">
                                    <input type="hidden" id="alliance-filter" name="alliance-filter">
                                    <button type="button" class="custom-select-value form-input"><span>All Alliances</span><i class="fas fa-chevron-down text-xs"></i></button>
                                    <div class="custom-select-options">
                                        <div class="options-list"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="player-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                             <!-- Player cards will be inserted here -->
                        </div>
                    </div>
                </div>
                <!-- Events Page -->
                <div id="page-events" class="page-content">
                    <main class="space-y-8" id="events-main-container">
                        <div class="flex justify-between items-center">
                            <h2 class="text-3xl font-bold text-white">Events & Announcements</h2>
                            <button id="create-post-btn" class="primary-btn px-4 py-2 rounded-lg hidden flex items-center gap-2">
                                <i class="fas fa-plus-circle"></i> Create
                            </button>
                        </div>

                        <!-- Announcements Section -->
                        <section>
                             <h3 class="text-xl font-bold border-l-4 pl-3 mb-4" style="border-color: var(--color-highlight);">
                                <i class="fas fa-bullhorn mr-2"></i>Announcements
                             </h3>
                             <div id="announcements-container" class="space-y-4">
                                 <!-- Announcement cards will be inserted here -->
                             </div>
                        </section>

                        <!-- Events Section -->
                        <section>
                             <h3 class="text-xl font-bold border-l-4 pl-3 mb-4" style="border-color: var(--color-primary);">
                                <i class="fas fa-calendar-alt mr-2"></i>Upcoming Events
                             </h3>
                             <div id="events-container" class="space-y-4">
                                 <!-- Event cards will be inserted here -->
                             </div>
                        </section>
                    </main>
                </div>
                <!-- Top Alliances Page -->
                <div id="page-top-alliances" class="page-content" style="display: none;">
                    <div class="glass-pane section-container">
                        <h2 class="text-3xl font-bold text-white text-center mb-8">Top Alliances</h2>
                        <div id="podium-container" class="flex flex-col md:flex-row items-end justify-center gap-4">
                            <!-- 2nd Place -->
                            <div class="w-full md:w-1/4 order-2 md:order-1">
                                <div id="silver-podium" class="glass-pane podium-card podium-silver h-full">
                                    <!-- Silver/2nd place content will be populated here -->
                                </div>
                            </div>
                            <!-- 1st Place -->
                            <div class="w-full md:w-1/3 order-1 md:order-2">
                                <div id="gold-podium" class="glass-pane podium-card podium-gold h-full">
                                    <!-- Gold/1st place content will be populated here -->
                                </div>
                            </div>
                            <!-- 3rd Place -->
                            <div class="w-full md:w-1/4 order-3 md:order-3">
                                <div id="bronze-podium" class="glass-pane podium-card podium-bronze h-full">
                                    <!-- Bronze/3rd place content will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Other Pages -->
                <div id="page-alliance-list" class="page-content" style="display: none;"><div class="glass-pane section-container"><h2 class="text-2xl font-bold text-white">Alliance List</h2></div></div>
                <div id="page-recruitment" class="page-content" style="display: none;"><div class="glass-pane section-container"><h2 class="text-2xl font-bold text-white">Recruitment</h2></div></div>
                <div id="page-season-overview" class="page-content" style="display: none;"><div class="glass-pane section-container"><h2 class="text-2xl font-bold text-white">Season Overview</h2></div></div>
                <div id="page-season-rewards" class="page-content" style="display: none;"><div class="glass-pane section-container"><h2 class="text-2xl font-bold text-white">Season Rewards</h2></div></div>
                <div id="page-season-history" class="page-content" style="display: none;"><div class="glass-pane section-container"><h2 class="text-2xl font-bold text-white">Season History</h2></div></div>
                <div id="page-calculators" class="page-content" style="display: none;"><div class="glass-pane section-container"><h2 class="text-2xl font-bold text-white">Calculators</h2></div></div>
                <div id="page-guides" class="page-content" style="display: none;"><div class="glass-pane section-container"><h2 class="text-2xl font-bold text-white">Guides</h2></div></div>

            </div>

            <footer class="text-center mt-12 py-4 border-t border-gray-800/50"><p class="text-gray-500">&copy; 2024 Last War Survival - Server 899 Community.</p></footer>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, query, updateDoc, addDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        /*
        * ===============================================
        * FIREBASE SECURITY RULES V2 (Corrected Syntax)
        * ===============================================
        */
        /*
        rules_version = '2';

        service cloud.firestore {
          match /databases/{database}/documents {
            
            // Helper Functions
            function isSignedIn() {
              return request.auth != null;
            }
            
            function isOwner(userId) {
              return request.auth.uid == userId;
            }

            function getUserData() {
              return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
            }

            function isAdmin() {
              // Check for the existence of the isAdmin field before accessing it
              return isSignedIn() && ('isAdmin' in getUserData()) && getUserData().isAdmin == true;
            }
            
            // User profiles: Can be read by any signed-in user, but only written by the owner.
            match /users/{userId} {
              allow read: if isSignedIn();
              allow create: if request.auth.uid == userId;
              allow update, delete: if isOwner(userId);
            }

            // Posts: Anyone can read any post
            match /posts/{postId} {
              allow read: if true;
              allow create: if canCreatePost(request.resource.data);
              allow update, delete: if isOwner(resource.data.authorUid) || isAdmin();
            }

            function canCreatePost(post) {
              let user = getUserData();
              let isVerified = user.isVerified == true;
              
              let hasRequiredRank = (post.subType == 'alliance' && user.allianceRank in ['R5', 'R4']) ||
                                    (post.subType == 'leadership' && user.allianceRank == 'R5');
              
              let isAllowedTypeForUser = !(post.subType == 'server' || post.subType == 'seasonal');

              return (isAdmin() && isVerified) || 
                     (isVerified && isOwner(post.authorUid) && hasRequiredRank && isAllowedTypeForUser);
            }
          }
        }
        */

        /*
        * ===============================================
        * FIREBASE STORAGE RULES V2
        * ===============================================
        */
        /*
        rules_version = '2';

        service firebase.storage {
          match /b/{bucket}/o {
            match /avatars/{userId} {
              // Allow anyone to read avatars
              allow read;
              
              // Allow a user to write (create, update, delete) their own avatar
              // if they are authenticated and it's their own user ID.
              // Also, validate the uploaded file size and type.
              allow write: if request.auth != null 
                           && request.auth.uid == userId
                           && request.resource.size < 1 * 1024 * 1024 // Max 1MB
                           && request.resource.contentType.matches('image/.*'); // Must be an image
            }
          }
        }
        */

        // TODO: Replace with your Firebase project's configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA8KKDjjw0Pb_wknZ3TRWuL7-7XMo4VeY0",
            authDomain: "events-ea397.firebaseapp.com",
            projectId: "events-ea397",
            storageBucket: "events-ea397.firebasestorage.app",
            messagingSenderId: "51859633788",
            appId: "1:51859633788:web:3653d3e7edb6d3c1c4fbf9",
            measurementId: "G-0ZCMZ86PJD"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        let currentUserData = null;
        let allPlayers = []; // Cache for player data
        
        const ALLIANCES = ["THOR", "fAfO", "HeRA", "pHNx", "TroW", "VaLT", "COLD", "Tone", "DoM", "MINI", "MEGA", "Lat1", "WSKT", "ValT", "BRSL", "TCM1", "BLSD", "REI", "wpg1", "SHRK"];
        const ALLIANCE_RANKS = [
            { value: 'R5', text: 'R5 (Leader)'}, { value: 'R4', text: 'R4'}, { value: 'R3', text: 'R3'},
            { value: 'R2', text: 'R2'}, { value: 'R1', text: 'R1 (Member)'},
        ];
        const ALLIANCE_ROLES = [
            { value: '', text: 'None'}, { value: 'Warlord', text: 'Warlord'}, { value: 'Recruiter', text: 'Recruiter'},
            { value: 'Muse', text: 'Muse'}, { value: 'Butler', text: 'Butler'},
        ];
        
        const SUB_TYPES = {
            event: [
                { value: 'alliance', text: 'Alliance Event', allowedRanks: ['R5', 'R4'], visibility: 'alliance' },
                { value: 'server', text: 'Server Event', isAdminOnly: true, visibility: 'public' },
                { value: 'seasonal', text: 'Seasonal Event', isAdminOnly: true, visibility: 'public' }
            ],
            announcement: [
                { value: 'alliance', text: 'Alliance Announcement', allowedRanks: ['R5', 'R4'], visibility: 'alliance' },
                { value: 'leadership', text: 'Leadership Announcement', allowedRanks: ['R5'], visibility: 'leadership' },
                { value: 'server', text: 'Server Announcement', isAdminOnly: true, visibility: 'public' }
            ]
        };

        // --- DOM ELEMENTS ---
        const modalBackdrop = document.getElementById('modal-backdrop');
        const authModalContainer = document.getElementById('auth-modal-container');
        const editProfileModalContainer = document.getElementById('edit-profile-modal-container');
        const playerSettingsModalContainer = document.getElementById('player-settings-modal-container');
        const createPostModalContainer = document.getElementById('create-post-modal-container');
        
        const loginFormContainer = document.getElementById('login-form-container');
        const registerFormContainer = document.getElementById('register-form-container');
        const loginBtn = document.getElementById('login-btn');
        const userProfileContainer = document.getElementById('user-profile-container');
        const usernameDisplay = document.getElementById('username-display');
        const playerListContainer = document.getElementById('player-list-container');
        const playerCardBtn = document.getElementById('player-card-btn');
        const playerCardDropdown = document.getElementById('player-card-dropdown');
        const playerCardInfo = document.getElementById('player-card-info');
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const mobileNavMenu = document.getElementById('mobile-nav-menu');
        const mobileNavLinksContainer = document.getElementById('mobile-nav-links');
        const playerSearchInput = document.getElementById('player-search-input');
        const allianceFilterInput = document.getElementById('alliance-filter');
        const createPostBtn = document.getElementById('create-post-btn');
        const announcementsContainer = document.getElementById('announcements-container');
        const eventsContainer = document.getElementById('events-container');
        const userAvatarButton = document.getElementById('user-avatar-button');
        const uploadAvatarBtn = document.getElementById('upload-avatar-btn');
        const avatarUploadInput = document.getElementById('avatar-upload-input');


        let activePlayerSettingsUID = null;
        let postCreationData = {}; // Object to hold data across slides
        let usersListener = null; // To hold the unsubscribe function for the users listener
        let postsListener = null; // To hold the unsubscribe function for the posts listener

        // --- MODAL & FORM SWITCHING LOGIC ---
        function showModal(modal) {
            hideAllModals();
            modalBackdrop.classList.add('visible');
            modal.classList.add('visible');
        }

        function showAuthModal(formToShow) {
            showModal(authModalContainer);
            document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));
            if (formToShow === 'register') {
                registerFormContainer.classList.add('active');
                initializeRegistrationStepper();
            } else {
                loginFormContainer.classList.add('active');
            }
        }
        
        function showEditProfileModal() { showModal(editProfileModalContainer); populateEditForm(); }
        function showPlayerSettingsModal(player) { activePlayerSettingsUID = player.uid; showModal(playerSettingsModalContainer); populatePlayerSettingsForm(player); }
        function showCreatePostModal() { 
            showModal(createPostModalContainer); 
            initializePostStepper();
        }

        function hideAllModals() {
            modalBackdrop.classList.remove('visible');
            authModalContainer.classList.remove('visible');
            editProfileModalContainer.classList.remove('visible');
            playerSettingsModalContainer.classList.remove('visible');
            createPostModalContainer.classList.remove('visible');
            activePlayerSettingsUID = null;
        }
        
        loginBtn.addEventListener('click', () => showAuthModal('login'));
        document.getElementById('close-auth-modal-btn').addEventListener('click', hideAllModals);
        document.getElementById('close-edit-modal-btn').addEventListener('click', hideAllModals);
        document.getElementById('close-player-settings-modal-btn').addEventListener('click', hideAllModals);
        document.getElementById('close-create-post-modal-btn').addEventListener('click', hideAllModals);
        createPostBtn.addEventListener('click', showCreatePostModal);

        modalBackdrop.addEventListener('click', (e) => {
            if (e.target === modalBackdrop) {
                hideAllModals();
                mobileNavMenu.classList.remove('open');
            }
        });

        document.getElementById('show-register-link').addEventListener('click', (e) => { e.preventDefault(); showAuthModal('register'); });
        document.getElementById('show-login-link').addEventListener('click', (e) => { e.preventDefault(); showAuthModal('login'); });

        // --- AUTHENTICATION STATE & LOGIC ---
        onAuthStateChanged(auth, async (user) => {
            // Detach any existing listeners before proceeding
            if (usersListener) usersListener();
            if (postsListener) postsListener();

            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    currentUserData = { uid: user.uid, ...userDoc.data() };
                    currentUserData.isAdmin = currentUserData.email === 'mikestancato@gmail.com';

                    usernameDisplay.textContent = currentUserData.username;
                    updatePlayerCard(currentUserData);
                    updateAvatarDisplay(currentUserData);

                    if(currentUserData.isVerified || currentUserData.isAdmin) {
                        createPostBtn.classList.remove('hidden');
                    } else {
                        createPostBtn.classList.add('hidden');
                    }
                }
                loginBtn.classList.add('hidden');
                userProfileContainer.classList.remove('hidden');
                hideAllModals();

                // Attach listeners now that we are authenticated
                usersListener = onSnapshot(query(collection(db, 'users')), (querySnapshot) => {
                    allPlayers = [];
                    querySnapshot.forEach((doc) => { allPlayers.push({uid: doc.id, ...doc.data()}); });
                    applyPlayerFilters();
                    updateTopAlliancesPodium(allPlayers);
                }, (error) => {
                    console.error("Error with users listener:", error);
                });

                postsListener = onSnapshot(query(collection(db, 'posts')), (querySnapshot) => {
                    let posts = [];
                    querySnapshot.forEach((doc) => {
                        posts.push({ id: doc.id, ...doc.data() });
                    });
                    renderPosts(posts);
                }, (error) => {
                    console.error("Error with posts listener:", error);
                });

            } else {
                currentUserData = null;
                allPlayers = [];
                loginBtn.classList.remove('hidden');
                userProfileContainer.classList.add('hidden');
                userProfileContainer.classList.remove('open');
                createPostBtn.classList.add('hidden');
                // Clear UI
                renderPosts([]);
                renderPlayers([]);
            }
            buildMobileNav();
        });
        
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorElement = document.getElementById('login-error');
            const submitBtn = document.getElementById('login-submit-btn');
            errorElement.textContent = '';
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Logging In...';

            signInWithEmailAndPassword(auth, email, password).catch((error) => {
                console.error("Login Error:", error);
                if (error.code === 'auth/invalid-credential') {
                     errorElement.textContent = "Invalid email or password.";
                } else {
                     errorElement.textContent = "An unknown error occurred.";
                }
            }).finally(() => {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Login';
            });
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth).catch(error => console.error("Logout error:", error));
        });

        document.getElementById('forgot-password-link').addEventListener('click', (e) => {
            e.preventDefault();
            const email = prompt("Please enter your email address to receive a password reset link:");
            if (!email) return;
            sendPasswordResetEmail(auth, email)
                .then(() => alert('Password reset email sent! Please check your inbox.'))
                .catch((error) => alert(error.message));
        });
        
        // --- PLAYER CARD & EDIT PROFILE ---
        playerCardBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            userProfileContainer.classList.toggle('open');
        });
        
        editProfileBtn.addEventListener('click', () => {
            userProfileContainer.classList.remove('open');
            showEditProfileModal();
        });

        function updatePlayerCard(data) {
             playerCardInfo.innerHTML = `
                <p class="text-sm text-gray-400">Alliance: <strong class="text-white">[${data.alliance}] ${data.allianceRank}</strong></p>
                <p class="text-sm text-gray-400">Power: <strong class="text-white">${(data.power || 0).toLocaleString()}</strong></p>
             `;
        }
        
        function populateEditForm() {
            if (!currentUserData) return;
            document.getElementById('edit-username').value = currentUserData.username;
            
            const editAllianceSelect = document.getElementById('edit-alliance').closest('.custom-select-container');
            const editRankSelect = document.getElementById('edit-alliance-rank').closest('.custom-select-container');
            
            setCustomSelectValue(editAllianceSelect, currentUserData.alliance);
            const rankData = ALLIANCE_RANKS.find(r => r.value === currentUserData.allianceRank);
            setCustomSelectValue(editRankSelect, currentUserData.allianceRank, rankData ? rankData.text : currentUserData.allianceRank);
            
            document.getElementById('edit-power').value = (currentUserData.power || 0).toLocaleString();
            document.getElementById('edit-tank-power').value = (currentUserData.tankPower || 0).toLocaleString();
            document.getElementById('edit-air-power').value = (currentUserData.airPower || 0).toLocaleString();
            document.getElementById('edit-missile-power').value = (currentUserData.missilePower || 0).toLocaleString();
        }

        document.getElementById('edit-profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;
            
            const errorElement = document.getElementById('edit-profile-error');
            errorElement.textContent = '';
            
            const parsePower = (str) => parseInt(String(str).replace(/,/g, ''), 10) || 0;

            const updatedData = {
                username: document.getElementById('edit-username').value,
                alliance: document.getElementById('edit-alliance').value,
                allianceRank: document.getElementById('edit-alliance-rank').value,
                power: parsePower(document.getElementById('edit-power').value),
                tankPower: parsePower(document.getElementById('edit-tank-power').value),
                airPower: parsePower(document.getElementById('edit-air-power').value),
                missilePower: parsePower(document.getElementById('edit-missile-power').value),
            };

            if (currentUserData && updatedData.alliance !== currentUserData.alliance) {
                updatedData.isVerified = false;
            }

            try {
                await updateDoc(doc(db, "users", user.uid), updatedData);
                usernameDisplay.textContent = updatedData.username;
                currentUserData = {...currentUserData, ...updatedData };
                updatePlayerCard(currentUserData);
                hideAllModals();
            } catch (error) {
                console.error("Update profile error:", error);
                errorElement.textContent = "Failed to update profile.";
            }
        });


        // --- REGISTRATION STEPPER LOGIC ---
        let currentRegStep = 0;
        let resizedAvatarBlob = null;
        const registrationFlow = document.getElementById('registration-flow');
        const registrationSuccess = document.getElementById('registration-success');
        const regFormSlides = registrationFlow.querySelectorAll('.form-slide');
        const regProgressSteps = registrationFlow.querySelectorAll('.progress-step');
        const regProgressBarLine = registrationFlow.querySelector('.progress-bar .line');
        const regBackBtn = document.getElementById('register-back-btn');
        const regNextBtn = document.getElementById('register-next-btn');
        const regSubmitBtn = document.getElementById('register-submit-btn');
        const registerError = document.getElementById('register-error');

        function initializeRegistrationStepper() { 
            currentRegStep = 1; 
            resizedAvatarBlob = null;
            document.getElementById('register-avatar-preview').src = 'https://placehold.co/128x128/161B22/FFFFFF?text=Avatar';
            showRegStep(currentRegStep);
            registrationFlow.style.display = 'block';
            registrationSuccess.style.display = 'none';
        }
        function showRegStep(stepIndex) {
            regFormSlides.forEach((slide) => slide.classList.remove('active'));
            const currentSlide = registrationFlow.querySelector(`.form-slide[data-slide="${stepIndex}"]`);
            if(currentSlide) currentSlide.classList.add('active');

            regProgressSteps.forEach((step, index) => step.classList.toggle('active', index < stepIndex - 1));
            regProgressBarLine.style.width = `${((stepIndex - 1) / (regFormSlides.length - 1)) * 100}%`;
            regBackBtn.style.visibility = stepIndex === 1 ? 'hidden' : 'visible';
            regNextBtn.classList.toggle('hidden', stepIndex === regFormSlides.length);
            regSubmitBtn.classList.toggle('hidden', stepIndex !== regFormSlides.length);
        }
        function validateRegStep(stepIndex) {
            registerError.textContent = '';
            const slide = regFormSlides[stepIndex - 1]; // Adjust for 1-based index
            if (stepIndex === 1) {
                const username = slide.querySelector('#register-username').value;
                const email = slide.querySelector('#register-email').value;
                const password = slide.querySelector('#register-password').value;
                const passwordVerify = slide.querySelector('#register-password-verify').value;
                if (!username || !email || !password || !passwordVerify) { registerError.textContent = 'Please fill out all account fields.'; return false; }
                if (password.length < 6) { registerError.textContent = 'Password must be at least 6 characters long.'; return false; }
                if (password !== passwordVerify) { registerError.textContent = 'Passwords do not match.'; return false; }
            } else if (stepIndex === 2) {
                if (!slide.querySelector('#register-alliance').value || !slide.querySelector('#register-alliance-rank').value) { registerError.textContent = 'Please select your alliance and rank.'; return false; }
            } else if (stepIndex === 3) {
                if (!slide.querySelector('#register-power').value) { registerError.textContent = 'Please enter your total power.'; return false; }
            }
            return true;
        }
        regNextBtn.addEventListener('click', () => { if (validateRegStep(currentRegStep)) { currentRegStep++; showRegStep(currentRegStep); } });
        regBackBtn.addEventListener('click', () => { currentRegStep--; showRegStep(currentRegStep); });
        
        document.getElementById('register-avatar-btn').addEventListener('click', () => {
            document.getElementById('register-avatar-input').click();
        });

        document.getElementById('register-avatar-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 300;
                    canvas.height = 300;
                    ctx.drawImage(img, 0, 0, 300, 300);
                    document.getElementById('register-avatar-preview').src = canvas.toDataURL('image/jpeg');
                    canvas.toBlob((blob) => {
                        resizedAvatarBlob = blob;
                    }, 'image/jpeg', 0.9);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!validateRegStep(currentRegStep)) return;
            regSubmitBtn.disabled = true;
            regSubmitBtn.textContent = 'Registering...';
            const username = document.getElementById('register-username').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const alliance = document.getElementById('register-alliance').value;
            const allianceRank = document.getElementById('register-alliance-rank').value;
            const parsePower = (str) => parseInt(String(str).replace(/,/g, ''), 10) || 0;
            const power = parsePower(document.getElementById('register-power').value);
            const tankPower = parsePower(document.getElementById('register-tank-power').value);
            const airPower = parsePower(document.getElementById('register-air-power').value);
            const missilePower = parsePower(document.getElementById('register-missile-power').value);
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                let avatarUrl = null;
                if (resizedAvatarBlob) {
                    const avatarRef = ref(storage, `avatars/${user.uid}`);
                    await uploadBytes(avatarRef, resizedAvatarBlob);
                    avatarUrl = await getDownloadURL(avatarRef);
                }

                const userProfile = {
                    uid: user.uid, username, email, alliance, allianceRank, power, tankPower, airPower, missilePower,
                    likes: 0, allianceRole: '', isVerified: false, avatarUrl,
                    isAdmin: email === 'mikestancato@gmail.com', // Set admin status
                    registrationTimestampUTC: new Date().toISOString(),
                };
                if (userProfile.isAdmin) {
                    userProfile.isVerified = true; // Auto-verify admin
                }

                await setDoc(doc(db, "users", user.uid), userProfile);
                registrationFlow.style.display = 'none';
                registrationSuccess.style.display = 'block';
                setTimeout(hideAllModals, 3000);
            } catch (error) {
                console.error("Registration Error:", error);
                registerError.textContent = error.code === 'auth/email-already-in-use' ? 'This email is already registered.' : 'An error occurred.';
            } finally {
                regSubmitBtn.disabled = false;
                regSubmitBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Register';
            }
        });
        
        // --- POST CREATION STEPPER ---
        let currentPostStep = 1;
        const postFlow = document.getElementById('post-creation-flow');
        const postFormSlides = postFlow.querySelectorAll('.form-slide');
        const postProgressSteps = postFlow.querySelectorAll('.progress-step');
        const postProgressBarLine = postFlow.querySelector('.progress-bar .line');
        const postBackBtn = document.getElementById('post-back-btn');
        const postNextBtn = document.getElementById('post-next-btn');
        const postSubmitBtn = document.getElementById('post-submit-btn');
        const createPostError = document.getElementById('create-post-error');

        function initializePostStepper() {
            document.getElementById('create-post-form').reset();
            postCreationData = {};
            currentPostStep = 1;
            showPostStep(currentPostStep);
        }

        function showPostStep(stepIndex) {
            postFormSlides.forEach(slide => slide.classList.remove('active'));
            const currentSlide = postFlow.querySelector(`.form-slide[data-slide="${stepIndex}"]`);
            if(currentSlide) currentSlide.classList.add('active');

            const totalSteps = postCreationData.mainType === 'event' ? 4 : 3;
            document.getElementById('post-progress-bar').style.display = 'flex';
            if (stepIndex === 1) document.getElementById('post-progress-bar').style.display = 'none';


            postProgressSteps.forEach((step, index) => {
                step.classList.toggle('active', index < stepIndex -1);
                step.style.display = index < totalSteps ? 'flex' : 'none';
            });
            postProgressBarLine.style.width = `${((stepIndex - 1) / (totalSteps - 1)) * 100}%`;
            
            postBackBtn.style.visibility = stepIndex === 1 ? 'hidden' : 'visible';
            postNextBtn.classList.toggle('hidden', stepIndex === totalSteps);
            postSubmitBtn.classList.toggle('hidden', stepIndex !== totalSteps);
        }

        function validatePostStep(stepIndex) {
            createPostError.textContent = '';
            if (stepIndex === 1) {
                if (!postCreationData.mainType) {
                    createPostError.textContent = 'Please select a post type.';
                    return false;
                }
            } else if (stepIndex === 2) {
                if (!document.getElementById('post-subtype').value) {
                    createPostError.textContent = 'Please select a category.';
                    return false;
                }
            } else if (stepIndex === 3) {
                 if (!document.getElementById('post-title').value || !document.getElementById('post-details').value) {
                    createPostError.textContent = 'Title and details are required.';
                    return false;
                }
            } else if (stepIndex === 4 && postCreationData.mainType === 'event') {
                const isRecurring = document.getElementById('post-repeat-weekly').checked;
                if (!isRecurring) {
                    if (!document.getElementById('post-start-time').value || !document.getElementById('post-end-time').value) {
                        createPostError.textContent = 'Start and end times are required for events.';
                        return false;
                    }
                }
            }
            return true;
        }
        
        postNextBtn.addEventListener('click', () => {
            if (validatePostStep(currentPostStep)) {
                if (currentPostStep === 3 && postCreationData.mainType === 'announcement') {
                    currentPostStep++; 
                }
                currentPostStep++;
                showPostStep(currentPostStep);
            }
        });
        
        postBackBtn.addEventListener('click', () => {
            if (currentPostStep === 5 && postCreationData.mainType === 'announcement') {
                currentPostStep--;
            }
            currentPostStep--;
            showPostStep(currentPostStep);
        });

        document.querySelectorAll('.post-type-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                postCreationData.mainType = btn.dataset.type;
                document.getElementById('selected-main-type-text').textContent = postCreationData.mainType;
                currentPostStep++;
                showPostStep(currentPostStep);
            });
        });

        document.getElementById('post-subtype').addEventListener('change', () => {
            const subTypeValue = document.getElementById('post-subtype').value;
            const subTypeConfig = SUB_TYPES[postCreationData.mainType]?.find(s => s.value === subTypeValue);
            const allianceGroup = document.getElementById('post-alliance-group');
            
            if (currentUserData.isAdmin && subTypeConfig && (subTypeValue === 'alliance' || subTypeValue === 'leadership')) {
                allianceGroup.classList.remove('hidden');
            } else {
                allianceGroup.classList.add('hidden');
            }
            document.getElementById('post-event-dates').classList.toggle('hidden', postCreationData.mainType !== 'event');
            document.getElementById('post-recurring-announcement').classList.toggle('hidden', postCreationData.mainType === 'event');
        });


        // --- EVENTS & ANNOUNCEMENTS LOGIC ---
        function renderPosts(posts) {
            if (!currentUserData) { 
                announcementsContainer.innerHTML = '';
                eventsContainer.innerHTML = '';
                return;
            }

            const visiblePosts = posts.filter(post => {
                if (post.visibility === 'public') return true;
                if (currentUserData.isAdmin) return true; 
                if (post.visibility === 'leadership') return currentUserData.allianceRank === 'R5';
                if (post.visibility === `alliance_${currentUserData.alliance}`) return true;
                return false;
            });

            const announcements = visiblePosts
                .filter(p => p.mainType === 'announcement')
                .sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());

            const events = visiblePosts
                .filter(p => p.mainType === 'event')
                .sort((a, b) => (a.startTime?.toDate() || 0) - (b.startTime?.toDate() || 0));

            renderAnnouncements(announcements);
            renderEvents(events);
        }

        function renderAnnouncements(announcements) {
            announcementsContainer.innerHTML = '';
            if (announcements.length === 0) {
                announcementsContainer.innerHTML = `<p class="text-gray-500">No active announcements.</p>`;
                return;
            }
            announcements.forEach(post => {
                const card = createPostCard(post);
                announcementsContainer.appendChild(card);
            });
        }

        function renderEvents(events) {
            eventsContainer.innerHTML = '';
            if (events.length === 0) {
                eventsContainer.innerHTML = `<p class="text-gray-500">No upcoming events.</p>`;
                return;
            }
            events.forEach(post => {
                const card = createPostCard(post);
                eventsContainer.appendChild(card);
            });
        }

        function createPostCard(post) {
            const card = document.createElement('div');
            const isAdmin = currentUserData && currentUserData.isAdmin;
            const isAuthor = currentUserData && currentUserData.uid === post.authorUid;
            const canEdit = isAdmin || isAuthor;

            const isEvent = post.mainType === 'event';
            const borderColor = isEvent ? 'var(--color-primary)' : 'var(--color-highlight)';
            card.className = 'post-card glass-pane p-4 relative';
            card.style.borderColor = borderColor;

            let tagColor = isEvent ? 'bg-blue-500' : 'bg-red-500';
            const postDate = post.createdAt.toDate().toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'});
            let timeHTML = '';

            if (post.isRecurring) {
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const localTime = post.recurringTime ? new Date(`1970-01-01T${post.recurringTime}Z`).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'N/A';
                timeHTML = `<p class="text-cyan-400"><i class="fas fa-sync-alt w-5"></i>Repeats weekly on ${days[post.recurringDay]} at ${localTime}</p>`;
            } else if (isEvent) {
                const startTime = post.startTime?.toDate().toLocaleString() || 'N/A';
                const endTime = post.endTime?.toDate().toLocaleString() || 'N/A';
                timeHTML = `<p class="text-green-400"><i class="fas fa-play-circle w-5"></i>Starts: ${startTime}</p>
                            <p class="text-red-400"><i class="fas fa-stop-circle w-5"></i>Ends: ${endTime}</p>`;
            }

            card.innerHTML = `
                ${canEdit ? `<button class="absolute top-3 right-3 text-gray-400 hover:text-white delete-post-btn" data-id="${post.id}"><i class="fas fa-trash-alt"></i></button>` : ''}
                <div class="flex items-start gap-3 flex-wrap">
                    <span class="post-tag ${tagColor}">${post.subType}</span>
                    ${post.alliance ? `<span class="post-tag bg-gray-700">[${post.alliance}]</span>` : ''}
                </div>
                <h4 class="text-lg font-bold text-white mt-2">${post.title}</h4>
                <p class="text-sm text-gray-400 mt-1">By ${post.authorUsername} on ${postDate}</p>
                <p class="text-gray-300 mt-3 whitespace-pre-wrap">${post.details}</p>
                ${timeHTML ? `<div class="mt-3 pt-3 border-t border-white/10 text-sm">${timeHTML}</div>` : ''}
            `;

            if(canEdit) {
                card.querySelector('.delete-post-btn').addEventListener('click', async (e) => {
                    e.stopPropagation();
                    if(confirm('Are you sure you want to delete this post?')) {
                        await deleteDoc(doc(db, "posts", post.id));
                    }
                });
            }
            return card;
        }

        document.getElementById('create-post-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserData) {
                createPostError.textContent = 'You must be logged in to post.';
                return;
            }
            if (!validatePostStep(currentPostStep)) return;

            const subTypeValue = document.getElementById('post-subtype').value;
            const subTypeConfig = SUB_TYPES[postCreationData.mainType]?.find(s => s.value === subTypeValue);
            
            let alliance = (subTypeValue === 'alliance' || subTypeValue === 'leadership') 
                ? (currentUserData.isAdmin ? document.getElementById('post-alliance').value : currentUserData.alliance)
                : null;
            if (!alliance && (subTypeValue === 'alliance' || subTypeValue === 'leadership')) {
                createPostError.textContent = 'Alliance is required for this post type.';
                return;
            }
            
            let visibility = subTypeConfig.visibility;
            if (visibility === 'alliance') {
                visibility = `alliance_${alliance}`;
            }

            const finalPostData = {
                mainType: postCreationData.mainType,
                subType: subTypeValue,
                title: document.getElementById('post-title').value,
                details: document.getElementById('post-details').value,
                authorUid: currentUserData.uid,
                authorUsername: currentUserData.username,
                createdAt: serverTimestamp(),
                alliance: alliance,
                visibility: visibility,
                isRecurring: document.getElementById('post-repeat-weekly').checked,
            };

            if (finalPostData.isRecurring) {
                const now = new Date();
                finalPostData.recurringDay = now.getUTCDay(); // Sunday = 0... in UTC
                finalPostData.recurringTime = now.toUTCString().slice(17, 22); // "HH:mm" in UTC
            }
            
            if (postCreationData.mainType === 'event' && !finalPostData.isRecurring) {
                const startTimeValue = document.getElementById('post-start-time').value;
                const endTimeValue = document.getElementById('post-end-time').value;
                finalPostData.startTime = new Date(startTimeValue);
                finalPostData.endTime = new Date(endTimeValue);
                if (finalPostData.endTime <= finalPostData.startTime) {
                    createPostError.textContent = 'End time must be after start time.';
                    return;
                }
            }
            
            try {
                await addDoc(collection(db, 'posts'), finalPostData);
                hideAllModals();
            } catch (error) {
                console.error("Error creating post: ", error);
                createPostError.textContent = 'Failed to create post.';
            }
        });

        // --- PLAYER LIST LOGIC ---
        function applyPlayerFilters() {
            const searchTerm = playerSearchInput.value.toLowerCase();
            const allianceFilter = allianceFilterInput.value;

            const filteredPlayers = allPlayers.filter(player => {
                const nameMatch = player.username.toLowerCase().includes(searchTerm);
                const allianceMatch = !allianceFilter || player.alliance === allianceFilter;
                return nameMatch && allianceMatch;
            });
            renderPlayers(filteredPlayers);
        }

        playerSearchInput.addEventListener('input', applyPlayerFilters);
        allianceFilterInput.addEventListener('change', applyPlayerFilters);

        function renderPlayers(players) {
            playerListContainer.innerHTML = '';
            if (players.length === 0) {
                playerListContainer.innerHTML = `<p class="text-center col-span-full py-8 text-gray-400">No players match the current filters.</p>`;
                return;
            }
            players.forEach(player => {
                const card = document.createElement('div');
                card.className = 'player-card glass-pane p-4 flex flex-col relative';
                card.dataset.rank = player.allianceRank;

                let gearIconHTML = '';
                if (currentUserData && currentUserData.uid !== player.uid) { // Don't show gear on self
                    const isAdmin = currentUserData.isAdmin;
                    const isR5 = currentUserData.allianceRank === 'R5';
                    const isR4 = currentUserData.allianceRank === 'R4';
                    
                    let showGear = false;
                    if (isAdmin) showGear = true;
                    if (isR5 && player.alliance === currentUserData.alliance && ['R1','R2','R3','R4'].includes(player.allianceRank)) showGear = true;
                    if (isR4 && player.alliance === currentUserData.alliance && ['R1','R2','R3'].includes(player.allianceRank)) showGear = true;
                    
                    if(showGear) {
                        gearIconHTML = `<button class="absolute top-3 right-3 text-gray-400 hover:text-white transition-colors player-settings-btn" data-uid="${player.uid}"><i class="fas fa-cog"></i></button>`;
                    }
                }

                const avatarUrl = player.avatarUrl || `https://placehold.co/48x48/0D1117/FFFFFF?text=${player.username.charAt(0).toUpperCase()}`;

                card.innerHTML = `
                    ${gearIconHTML}
                    <div class="flex items-center pb-3 border-b" style="border-color: rgba(255,255,255,0.1);">
                        <img src="${avatarUrl}" class="w-12 h-12 rounded-full mr-4 border-2 object-cover" style="border-color: rgba(255,255,255,0.2);" alt="${player.username}">
                        <div>
                            <h3 class="font-bold text-lg text-white">${player.username}</h3>
                            <p class="text-sm font-semibold" style="color: var(--color-primary);">[${player.alliance}] - ${player.allianceRank}</p>
                        </div>
                    </div>
                    <div class="flex-grow my-4 space-y-3">
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-400 flex items-center"><i class="fas fa-fist-raised w-6 text-center mr-2" style="color: var(--color-primary);"></i>Total Power</span>
                            <span class="font-bold text-white">${(player.power || 0).toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-400 flex items-center"><i class="fas fa-truck-monster w-6 text-center mr-2" style="color: var(--color-primary);"></i>Tank Power</span>
                            <span class="font-bold text-white">${(player.tankPower || 0).toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-400 flex items-center"><i class="fas fa-fighter-jet w-6 text-center mr-2" style="color: var(--color-primary);"></i>Air Power</span>
                            <span class="font-bold text-white">${(player.airPower || 0).toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-400 flex items-center"><i class="fas fa-rocket w-6 text-center mr-2" style="color: var(--color-primary);"></i>Missile Power</span>
                            <span class="font-bold text-white">${(player.missilePower || 0).toLocaleString()}</span>
                        </div>
                    </div>
                    <div class="flex justify-around items-center pt-3 border-t border-white/10">
                        <button class="text-gray-400 hover:text-white transition-colors !text-lg" title="Message Player"><i class="fas fa-comment-dots"></i></button>
                        <button class="text-gray-400 hover:text-white transition-colors !text-lg" title="Add Friend"><i class="fas fa-user-plus"></i></button>
                        <button class="text-gray-400 hover:text-white transition-colors !text-lg" title="Like Profile"><i class="fas fa-thumbs-up"></i></button>
                    </div>
                `;
                const settingsBtn = card.querySelector('.player-settings-btn');
                if (settingsBtn) {
                    settingsBtn.addEventListener('click', () => {
                        const targetPlayer = allPlayers.find(p => p.uid === settingsBtn.dataset.uid);
                        if(targetPlayer) showPlayerSettingsModal(targetPlayer)
                    });
                }
                playerListContainer.appendChild(card);
            });
        }

        // --- TOP ALLIANCES PODIUM LOGIC ---
        function updateTopAlliancesPodium(players) {
            const topAlliances = ['THOR', 'fAfO', 'HeRA'];
            const podiumData = topAlliances.map(allianceTag => {
                const members = players.filter(p => p.alliance === allianceTag);
                const totalPower = members.reduce((sum, p) => sum + (p.power || 0), 0);
                const leader = members.find(p => p.allianceRank === 'R5')?.username || 'Unassigned';
                const warlord = members.find(p => p.allianceRole === 'Warlord')?.username || 'Unassigned';
                const recruiter = members.find(p => p.allianceRole === 'Recruiter')?.username || 'Unassigned';
                const muse = members.find(p => p.allianceRole === 'Muse')?.username || 'Unassigned';
                const butler = members.find(p => p.allianceRole === 'Butler')?.username || 'Unassigned';
                return { tag: allianceTag, totalPower, leader, warlord, recruiter, muse, butler };
            });

            const [gold, silver, bronze] = podiumData;

            document.getElementById('gold-podium').innerHTML = generatePodiumHTML(gold, '1st', 'gold');
            document.getElementById('silver-podium').innerHTML = generatePodiumHTML(silver, '2nd', 'silver');
            document.getElementById('bronze-podium').innerHTML = generatePodiumHTML(bronze, '3rd', 'bronze');
        }

        function generatePodiumHTML(data, rank, type) {
            if (!data) return '<p>Loading...</p>';
            const rankClasses = {
                gold: { sup: 'text-3xl font-bold text-yellow-400', main: 'text-6xl font-black text-yellow-300', text: 'text-yellow-200', border: 'border-yellow-500/50'},
                silver: { sup: 'text-2xl font-bold text-gray-400', main: 'text-5xl font-black text-gray-300', text: 'text-gray-300', border: 'border-gray-600'},
                bronze: { sup: 'text-2xl font-bold text-yellow-800', main: 'text-5xl font-black text-yellow-700', text: 'text-yellow-200/70', border: 'border-yellow-800/50'}
            };
            const cls = rankClasses[type];

            return `
                <div class="mb-4"><span class="${cls.main}">${rank.charAt(0)}</span><sup class="${cls.sup}">${rank.slice(1)}</sup></div>
                <h3 class="text-3xl font-extrabold text-white">[${data.tag}]</h3>
                <div class="text-base ${cls.text} mt-2 space-y-1">
                    <p><i class="fas fa-crown mr-2"></i>Leader: ${data.leader}</p>
                    <p><i class="fas fa-fist-raised mr-2"></i>Power: ${(data.totalPower / 1_000_000_000).toFixed(1)}B</p>
                </div>
                <div class="border-t ${cls.border} my-4"></div>
                <div class="text-left text-sm space-y-2">
                    <p><strong class="${cls.text}">Warlord:</strong> ${data.warlord}</p>
                    <p><strong class="${cls.text}">Recruiter:</strong> ${data.recruiter}</p>
                    <p><strong class="${cls.text}">Muse:</strong> ${data.muse}</p>
                    <p><strong class="${cls.text}">Butler:</strong> ${data.butler}</p>
                </div>
            `;
        }


        // --- CUSTOM SELECT LOGIC ---
        function setupCustomSelect(container) {
            const type = container.dataset.type;
            const hiddenInput = container.querySelector('input[type="hidden"]');
            const valueButton = container.querySelector('.custom-select-value');
            const optionsContainer = container.querySelector('.custom-select-options');
            const searchInput = container.querySelector('.custom-select-search');
            const optionsList = container.querySelector('.options-list');
            
            let sourceData = [];
            if (type === 'alliance') sourceData = ALLIANCES.map(a => ({value: a, text: a}));
            else if (type === 'rank') sourceData = ALLIANCE_RANKS;
            else if (type === 'role') sourceData = ALLIANCE_ROLES;
            else if (type === 'alliance-filter') sourceData = [{value: '', text: 'All Alliances'}, ...ALLIANCES.map(a => ({value: a, text: a}))];
            
            const isSearchable = searchInput && type === 'alliance';
            if(searchInput && !isSearchable) searchInput.style.display = 'none';

            function renderOptions(data = [], filter = '') {
                optionsList.innerHTML = '';
                const filteredData = data.filter(item => item.text.toLowerCase().includes(filter.toLowerCase()));
                filteredData.forEach(item => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'custom-select-option';
                    optionDiv.textContent = item.text;
                    optionDiv.dataset.value = item.value;
                    optionsList.appendChild(optionDiv);
                });
            }

            valueButton.addEventListener('click', (e) => {
                e.stopPropagation();

                // **BUG FIX**: Dynamically populate subtype options just before opening
                if (type === 'post-subtype') {
                    if (!currentUserData || !postCreationData.mainType) return;
                    sourceData = SUB_TYPES[postCreationData.mainType].filter(sub => {
                        if (currentUserData.isAdmin) return true;
                        if (sub.isAdminOnly) return false;
                        if (sub.allowedRanks) return sub.allowedRanks.includes(currentUserData.allianceRank);
                        return false;
                    });
                }

                const isOpen = container.classList.contains('open');
                document.querySelectorAll('.custom-select-container').forEach(c => c.classList.remove('open'));
                if (!isOpen) {
                    const rect = container.getBoundingClientRect();
                    const spaceBelow = window.innerHeight - rect.bottom;
                    optionsContainer.classList.remove('open-up', 'open-down');
                    if (spaceBelow < 220 && rect.top > 220) { 
                        optionsContainer.classList.add('open-up');
                    } else {
                        optionsContainer.classList.add('open-down');
                    }
                    container.classList.add('open');
                    if (isSearchable) { searchInput.value = ''; searchInput.focus(); }
                    renderOptions(sourceData);
                } else {
                    container.classList.remove('open');
                }
            });

            if (isSearchable) {
                searchInput.addEventListener('input', () => renderOptions(sourceData, searchInput.value));
            }

            optionsList.addEventListener('click', (e) => {
                if (e.target.classList.contains('custom-select-option')) {
                    const value = e.target.dataset.value;
                    const text = e.target.textContent;
                    setCustomSelectValue(container, value, text);
                    container.classList.remove('open');
                    hiddenInput.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });
            renderOptions(sourceData);
        }

        function setCustomSelectValue(container, value, text) {
            const hiddenInput = container.querySelector('input[type="hidden"]');
            const valueSpan = container.querySelector('.custom-select-value span');
            hiddenInput.value = value;
            valueSpan.textContent = text || value;
        }
        
        // --- MOBILE NAV LOGIC ---
        function buildMobileNav() {
            mobileNavLinksContainer.innerHTML = '';
            const desktopNav = document.getElementById('main-nav');
            
            desktopNav.querySelectorAll('.nav-item').forEach(item => {
                const link = item.querySelector('.nav-link');
                const newLink = document.createElement('a');
                newLink.href = '#';
                newLink.className = 'mobile-nav-link';
                newLink.innerHTML = `<i class="${link.querySelector('i').className} w-6 text-center mr-3"></i>${link.querySelector('span').textContent}`;
                
                const dropdown = item.querySelector('.dropdown-menu');
                if (dropdown) {
                    newLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        const subMenu = newLink.nextElementSibling;
                        subMenu.style.display = subMenu.style.display === 'block' ? 'none' : 'block';
                    });
                    mobileNavLinksContainer.appendChild(newLink);

                    const subMenuContainer = document.createElement('div');
                    subMenuContainer.style.display = 'none';
                    subMenuContainer.className = 'ml-8';
                    dropdown.querySelectorAll('.dropdown-link').forEach(ddLink => {
                        const newDdLink = document.createElement('a');
                        newDdLink.href = '#';
                        newDdLink.className = 'mobile-nav-link !py-2 !text-base';
                        newDdLink.textContent = ddLink.textContent;
                        newDdLink.addEventListener('click', (e) => {
                            e.preventDefault();
                            showPage(ddLink.dataset.target);
                            mobileNavMenu.classList.remove('open');
                            modalBackdrop.classList.remove('visible');
                        });
                        subMenuContainer.appendChild(newDdLink);
                    });
                    mobileNavLinksContainer.appendChild(subMenuContainer);

                } else {
                     newLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        showPage(link.dataset.mainTarget);
                        mobileNavMenu.classList.remove('open');
                        modalBackdrop.classList.remove('visible');
                    });
                    mobileNavLinksContainer.appendChild(newLink);
                }
            });

            const divider = document.createElement('hr');
            divider.className = 'border-t border-white/10 my-4';
            mobileNavLinksContainer.appendChild(divider);

            if (currentUserData) {
                const editProfileMobile = document.createElement('a');
                editProfileMobile.href = '#';
                editProfileMobile.className = 'mobile-nav-link';
                editProfileMobile.innerHTML = `<i class="fas fa-user-edit w-6 text-center mr-3"></i>Edit Profile`;
                editProfileMobile.onclick = (e) => { e.preventDefault(); mobileNavMenu.classList.remove('open'); showEditProfileModal(); };
                mobileNavLinksContainer.appendChild(editProfileMobile);

                const logoutMobile = document.createElement('a');
                logoutMobile.href = '#';
                logoutMobile.className = 'mobile-nav-link';
                logoutMobile.innerHTML = `<i class="fas fa-sign-out-alt w-6 text-center mr-3"></i>Logout`;
                logoutMobile.onclick = (e) => { e.preventDefault(); signOut(auth); };
                mobileNavLinksContainer.appendChild(logoutMobile);
            } else {
                const loginMobile = document.createElement('a');
                loginMobile.href = '#';
                loginMobile.className = 'mobile-nav-link';
                loginMobile.innerHTML = `<i class="fas fa-sign-in-alt w-6 text-center mr-3"></i>Login / Register`;
                loginMobile.onclick = (e) => { e.preventDefault(); mobileNavMenu.classList.remove('open'); showAuthModal('login'); };
                mobileNavLinksContainer.appendChild(loginMobile);
            }
        }

        document.getElementById('open-mobile-menu-btn').addEventListener('click', () => {
            mobileNavMenu.classList.add('open');
            modalBackdrop.classList.add('visible');
        });
        document.getElementById('close-mobile-menu-btn').addEventListener('click', () => {
            mobileNavMenu.classList.remove('open');
            modalBackdrop.classList.remove('visible');
        });


        // --- UI & PARTICLE SCRIPTS ---
        const canvas = document.getElementById('particle-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        function createParticles() {
            particles = []; let particleCount = (canvas.width * canvas.height) / 10000;
            for (let i = 0; i < particleCount; i++) { particles.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, vx: (Math.random() - 0.5) * 0.5, vy: (Math.random() - 0.5) * 0.5, size: Math.random() * 1.5 + 0.5, color: Math.random() > 0.3 ? 'rgba(0, 191, 255, 0.5)' : 'rgba(248, 113, 113, 0.1)' }); }
        }
        function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => { p.x += p.vx; p.y += p.vy; if (p.x < 0 || p.x > canvas.width) p.vx *= -1; if (p.y < 0 || p.y > canvas.height) p.vy *= -1; ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); ctx.fill(); });
            requestAnimationFrame(animateParticles);
        }
        window.addEventListener('resize', () => { resizeCanvas(); createParticles(); });
        resizeCanvas(); createParticles(); animateParticles();
        
        const pages = document.querySelectorAll('.page-content');
        function showPage(targetId) {
            pages.forEach(page => { page.style.display = page.id === targetId ? 'block' : 'none'; });
            let activeSet = false;
            document.querySelectorAll('#main-nav .nav-link').forEach(link => {
                const mainTarget = link.dataset.mainTarget;
                const parentItem = link.closest('.nav-item');
                const dropdowns = parentItem.querySelectorAll('.dropdown-link');
                let isParentOfActive = false;
                dropdowns.forEach(ddLink => { if (ddLink.dataset.target === targetId) { isParentOfActive = true; } });
                if (mainTarget === targetId || isParentOfActive) { link.classList.add('active'); activeSet = true; } else { link.classList.remove('active'); }
            });
             if (!activeSet) { const eventsLink = document.querySelector('.nav-link[data-main-target="page-events"]'); if (eventsLink) eventsLink.classList.add('active'); }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Initialize all custom selects on the page
            document.querySelectorAll('.custom-select-container').forEach(setupCustomSelect);

            const navItems = document.querySelectorAll('.nav-item');
            
            navItems.forEach(item => {
                const link = item.querySelector('.nav-link');
                const dropdown = item.querySelector('.dropdown-menu');
                
                if (dropdown) {
                    item.addEventListener('mouseenter', () => { if (window.innerWidth > 768) item.classList.add('open'); });
                    item.addEventListener('mouseleave', () => { if (window.innerWidth > 768) item.classList.remove('open'); });
                    link.addEventListener('click', (e) => {
                        if (window.innerWidth <= 768) {
                            e.preventDefault();
                            e.stopPropagation();
                            const wasOpen = item.classList.contains('open');
                            navItems.forEach(i => i.classList.remove('open'));
                            if (!wasOpen) item.classList.add('open');
                        }
                    });
                } else {
                    link.addEventListener('click', () => showPage(link.dataset.mainTarget));
                }
            });
            
            window.addEventListener('click', (e) => { 
                if (!e.target.closest('.nav-item')) {
                    document.querySelectorAll('.nav-item.open').forEach(item => item.classList.remove('open'));
                }
                if (!e.target.closest('#user-profile-container')) {
                    userProfileContainer.classList.remove('open');
                }
                if (!e.target.closest('.custom-select-container')) {
                    document.querySelectorAll('.custom-select-container').forEach(c => c.classList.remove('open'));
                }
            });

            document.querySelectorAll('.dropdown-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const targetId = link.dataset.target;
                    if (targetId) showPage(targetId);
                    link.closest('.nav-item').classList.remove('open');
                });
            });

            showPage('page-events'); 
            document.querySelectorAll('.power-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    let value = String(e.target.value).replace(/,/g, '');
                    if (isNaN(value)) { e.target.value = ''; return; }
                    e.target.value = Number(value).toLocaleString('en-US');
                });
            });
        });
    </script>
</body>
</html>
