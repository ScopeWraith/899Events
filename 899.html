<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Last War: Survival - 899 Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        :root {
            --color-bg: #0D1117;
            --color-primary: #00BFFF;
            --color-highlight: #F87171;
            --color-glass-bg: rgba(22, 27, 34, 0.40); 
            --color-dropdown-bg: rgba(22, 27, 34, 0.95);
        }
        @keyframes pulse-live { 0%, 100% { box-shadow: 0 0 5px var(--color-primary); } 50% { box-shadow: 0 0 10px var(--color-primary); } }
        @keyframes slide-in-right { to { opacity: 1; transform: translateX(0); } }
        body { font-family: 'Inter', sans-serif; background-color: var(--color-bg); color: #c9d1d9; }
        #particle-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at top left, rgba(0, 191, 255, 0.1), transparent 40%), radial-gradient(circle at bottom right, rgba(248, 113, 113, 0.1), transparent 40%); }
        .glass-pane { background-color: var(--color-glass-bg); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border-radius: 1rem; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); }
        .header-main { padding: 0.75rem 1.5rem; position: relative; z-index: 50; }
        .nav-item { position: relative; }
        .nav-link { position: relative; padding: 0.5rem; font-weight: 600; font-size: 0.75rem; color: #c9d1d9; transition: color 0.3s ease; display: flex; flex-direction: column; align-items: center; gap: 0.25rem; width: 80px; cursor: pointer; }
        .nav-link i { font-size: 1rem; }
        .nav-link:hover { color: #fff; }
        .nav-link::after { content: ''; position: absolute; bottom: 0; left: 20%; right: 20%; height: 2px; background-color: var(--color-primary); transform: scaleX(0); transform-origin: center; transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1); }
        .nav-item:hover .nav-link::after, .nav-link.active::after { transform: scaleX(1); }
        .nav-link.active { color: #fff; }
        .dropdown-menu { position: absolute; top: calc(100% + 12px); left: 50%; transform: translateX(-50%) translateY(-10px); opacity: 0; visibility: hidden; transition: opacity 0.3s ease, transform 0.3s ease, visibility 0s 0.3s; z-index: 100; padding: 0.5rem; min-width: 180px; border-top: 2px solid var(--color-primary); background-color: var(--color-dropdown-bg); }
        .nav-item:hover .dropdown-menu, .nav-item.open .dropdown-menu { transform: translateX(-50%) translateY(0); opacity: 1; visibility: visible; transition: opacity 0.3s ease, transform 0.3s ease, visibility 0s 0s; }
        .dropdown-link { display: block; padding: 0.6rem 1rem; border-radius: 0.5rem; font-size: 0.875rem; color: #c9d1d9; transition: background-color 0.2s ease, color 0.2s ease; white-space: nowrap; cursor: pointer; }
        .dropdown-link:hover { background-color: rgba(0, 191, 255, 0.1); color: #fff; }
        .login-button { padding: 0.6rem 1.25rem; font-weight: 600; font-size: 0.875rem; color: #c9d1d9; background-color: rgba(255,255,255,0.05); border-radius: 0.5rem; border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem; }
        .login-button:hover { color: #fff; background-color: rgba(0, 191, 255, 0.1); border-color: var(--color-primary); }
        .section-container { padding: 1.25rem; }
        .event-card { background-color: rgba(13, 17, 23, 0.7); border-radius: 0.75rem; overflow: hidden; transition: all 0.3s ease; display: flex; flex-direction: column; border: 1px solid rgba(255,255,255,0.1); }
        .event-card:hover { box-shadow: 0 0 10px 0px var(--color-primary); }
        .live-indicator { animation: pulse-live 2s infinite; }
        .toggle-button { position: relative; padding: 0.75rem 1rem; font-size: 0.9rem; font-weight: 600; color: #8b949e; background-color: transparent; border: none; transition: color 0.3s ease; flex-shrink: 0; }
        .toggle-button:hover { color: #c9d1d9; }
        .toggle-button.active { color: #fff; }
        .toggle-button::after { content: ''; position: absolute; bottom: 0.5rem; left: 1rem; right: 1rem; height: 2px; background-color: var(--color-primary); transform: scaleX(0); transition: transform 0.3s ease-in-out; }
        .toggle-button.active::after { transform: scaleX(1); }
        .player-card { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .player-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2), 0 0 15px var(--color-primary); }
        .action-button { background: rgba(255,255,255,0.1); border-radius: 0.375rem; padding: 0.5rem; transition: all 0.2s ease; }
        .action-button:hover { background: var(--color-primary); color: #0D1117; }
        .styled-table { width: 100%; border-collapse: collapse; }
        .styled-table th, .styled-table td { padding: 0.75rem 1rem; text-align: left; vertical-align: middle; }
        .styled-table thead { border-bottom: 2px solid var(--color-primary); }
        .styled-table th { font-size: 0.875rem; font-weight: 700; color: #fff; text-transform: uppercase; letter-spacing: 0.05em; }
        .styled-table tbody tr { border-bottom: 1px solid rgba(255, 255, 255, 0.1); transition: background-color 0.2s ease; }
        .styled-table tbody tr:last-child { border-bottom: none; }
        .styled-table tbody tr:hover { background-color: rgba(0, 191, 255, 0.05); }
        .styled-table .tag { font-weight: 800; color: #fff; }
        .filter-dropdown { position: relative; }
        .filter-dropdown-button { background-color: rgba(255,255,255,0.05); border: 1px solid rgba(255, 255, 255, 0.1); }
        .filter-dropdown-button:hover { background-color: rgba(0, 191, 255, 0.1); border-color: var(--color-primary); }
        .filter-dropdown-menu { position: absolute; top: 100%; left: 0; right: 0; z-index: 10; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.3s ease; background-color: var(--color-dropdown-bg); }
        .filter-dropdown.open .filter-dropdown-menu { opacity: 1; visibility: visible; transform: translateY(5px); }
        .filter-dropdown-item { color: #c9d1d9; }
        .filter-dropdown-item:hover { background-color: rgba(0, 191, 255, 0.1); color: #fff; }
        #mobile-menu { opacity: 0; pointer-events: none; transition: opacity 0.3s ease-in-out; }
        #mobile-menu.open { opacity: 1; pointer-events: auto; }
        #mobile-menu-content { transform: translateY(-30px); transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        #mobile-menu.open #mobile-menu-content { transform: translateY(0); }
        .mobile-nav-link { opacity: 0; transform: translateX(-15px); transition: background-color 0.2s ease, transform 0.2s ease; }
        .mobile-nav-link:hover { background-color: rgba(0, 191, 255, 0.1); transform: translateX(0px); }
        #mobile-menu.open .mobile-nav-link, #mobile-menu.open .mobile-menu-divider { animation: slide-in-right 0.5s forwards cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        #mobile-menu.open .mobile-nav-link:nth-of-type(1) { animation-delay: 0.1s; }
        #mobile-menu.open .mobile-nav-link:nth-of-type(2) { animation-delay: 0.15s; }
        #mobile-menu.open .mobile-nav-link:nth-of-type(3) { animation-delay: 0.2s; }
        #mobile-menu.open .mobile-nav-link:nth-of-type(4) { animation-delay: 0.25s; }
        #mobile-menu.open .mobile-nav-link:nth-of-type(5) { animation-delay: 0.3s; }
        #mobile-menu.open .mobile-nav-link:nth-of-type(6) { animation-delay: 0.35s; }
        #mobile-menu.open .mobile-menu-divider { animation-delay: 0.4s; }
        #event-toggles { -ms-overflow-style: none; scrollbar-width: none; }
        #event-toggles::-webkit-scrollbar { height: 4px; }
        #event-toggles::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 2px; }
        #event-toggles::-webkit-scrollbar-thumb { background: var(--color-primary); border-radius: 2px; }
        #event-toggles::-webkit-scrollbar-thumb:hover { background: #00a0d9; }
        .modal { transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        .form-step { display: none; }
        .form-step.active { display: block; }
    </style>
</head>
<body>
    <canvas id="particle-canvas"></canvas>
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900/80 flex items-center justify-center z-[100]"><div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-cyan-500"></div></div>
    
    <!-- Modals -->
    <div id="auth-modal" class="modal hidden fixed inset-0 bg-black/70 backdrop-blur-md z-50 flex items-center justify-center p-4">
        <div class="modal-content glass-pane w-full max-w-md p-8 rounded-2xl"></div>
    </div>
     <div id="create-event-modal" class="modal hidden fixed inset-0 bg-black/70 backdrop-blur-md z-50 flex items-center justify-center p-4">
        <div class="modal-content glass-pane w-full max-w-lg p-8 rounded-2xl"></div>
    </div>


    <div class="relative min-h-screen w-full p-4 sm:p-6 lg:p-8">
        <div class="max-w-6xl mx-auto">
            <header class="glass-pane header-main flex justify-between items-center mb-6">
                <div class="flex-shrink-0">
                    <h1 class="text-2xl md:text-3xl font-black tracking-tighter text-white">899<span class="font-bold" style="color: var(--color-primary);">EVENTS</span></h1>
                    <p class="text-xs text-gray-400">Official Event Hub</p>
                </div>
                
                <nav id="main-nav" class="hidden md:flex flex-grow justify-center items-center">
                    <div class="nav-item"><div class="nav-link" data-main-target="page-events"><i class="fas fa-calendar-alt"></i><span>Events</span></div></div>
                    <div class="nav-item"><div class="nav-link" data-main-target="page-players"><i class="fas fa-users"></i><span>Players</span></div></div>
                    <div id="alliance-nav-container"></div>
                </nav>

                <div id="auth-container" class="hidden md:flex flex-shrink-0"></div>
                
                <button id="mobile-menu-button" class="md:hidden text-white p-2 rounded-md hover:bg-white/10 transition-colors z-50">
                    <svg id="menu-open-icon" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
                    <svg id="menu-close-icon" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </header>
            
            <div id="mobile-menu" class="hidden md:hidden fixed inset-0 bg-black/70 backdrop-blur-md z-40">
                <div id="mobile-menu-content" class="w-full bg-gray-900/90 pt-24 p-8 space-y-4">
                    <a href="#" class="mobile-nav-link text-xl font-bold flex items-center gap-4 p-4 rounded-lg" data-target="page-events"><i class="fas fa-calendar-alt w-6 text-center" style="color: var(--color-primary);"></i>Events</a>
                    <a href="#" class="mobile-nav-link text-xl font-bold flex items-center gap-4 p-4 rounded-lg" data-target="page-players"><i class="fas fa-users w-6 text-center" style="color: var(--color-primary);"></i>Players</a>
                    <div id="mobile-alliance-nav-container"></div>
                    <div class="mobile-menu-divider border-t border-gray-700/50 pt-6 mt-6">
                         <div id="mobile-auth-container"></div>
                    </div>
                </div>
            </div>

            <div id="page-container">
                <div id="page-events" class="page-content">
                    <div class="flex justify-between items-center mb-4">
                         <h2 class="text-3xl font-bold text-white">Events</h2>
                         <button id="create-event-button" class="hidden login-button bg-cyan-500/20 hover:bg-cyan-500/40">
                            <i class="fas fa-plus mr-2"></i>Create Event
                        </button>
                    </div>
                    <main id="events-main-container" class="space-y-8"></main>
                </div>

                <div id="page-players" class="page-content" style="display: none;">
                    <div class="glass-pane section-container">
                        <h2 class="text-3xl font-bold text-white text-center mb-4">Registered Players</h2>
                        <div class="flex flex-col sm:flex-row gap-4 mb-6">
                            <input id="player-search-input" type="text" placeholder="Search for a player..." class="flex-grow bg-gray-900/50 border border-gray-700 rounded-lg px-4 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                            <div id="alliance-filter" class="filter-dropdown flex-shrink-0">
                                <button id="alliance-filter-button" class="filter-dropdown-button w-full sm:w-48 flex items-center justify-between rounded-lg px-4 py-2 text-white transition-colors duration-200">
                                    <span id="alliance-filter-label">All Alliances</span>
                                    <i class="fas fa-chevron-down ml-2 transition-transform duration-300"></i>
                                </button>
                                <div id="alliance-filter-menu" class="filter-dropdown-menu glass-pane mt-2 p-2 rounded-lg w-full"></div>
                            </div>
                        </div>
                        <div id="player-card-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                        <div id="no-players-message" class="hidden text-center py-12"><p class="text-gray-400 text-lg">No players found.</p></div>
                    </div>
                </div>
                
                <div id="page-alliance-members" class="page-content" style="display: none;">
                    <div class="glass-pane section-container">
                        <h2 class="text-3xl font-bold text-white text-center mb-4">Alliance Members</h2>
                        <div id="alliance-members-grid" class="overflow-x-auto"></div>
                    </div>
                </div>
            </div>
            <footer class="text-center mt-12 py-4 border-t border-gray-800/50"><p class="text-gray-500">&copy; 2024 Last War Survival - Server 899 Community.</p></footer>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, onSnapshot, addDoc, updateDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyA8KKDjjw0Pb_wknZ3TRWuL7-7XMo4VeY0",
            authDomain: "events-ea397.firebaseapp.com",
            projectId: "events-ea397",
            storageBucket: "events-ea397.appspot.com",
            messagingSenderId: "51859633788",
            appId: "1:51859633788:web:3653d3e7edb6d3c1c4fbf9"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        /*
        --- Firestore Security Rules (V2) ---
        rules_version = '2';
        service cloud.firestore {
          match /databases/{database}/documents {
            function isVerified() {
              return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.verified == true;
            }
            function isRank(rank) {
              return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.rank >= rank;
            }
            function isAllianceMember(alliance) {
              return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.alliance == alliance;
            }

            match /users/{userId} {
              allow read: if isVerified();
              allow create: if request.auth != null;
              allow update: if request.auth.uid == userId;
            }

            match /players/{playerId} {
              allow read: if true;
            }
            
            match /events/{eventId} {
                allow read: if true;
                allow create: if isRank(4);
            }

            match /alliances/{allianceId} {
                allow read: if true;
            }
            
            // Unverified users can be read by R4/R5 of the same alliance
            match /unverified_users/{userId} {
                allow read: if isRank(4) && isAllianceMember(resource.data.alliance);
                allow write: if isRank(4) && isAllianceMember(resource.data.alliance);
            }
          }
        }
        */

        // --- App State ---
        let currentUserData = null;
        let playersData = [];
        let eventsData = [];

        // --- DOM Elements ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const authModal = document.getElementById('auth-modal');
        const allianceNavContainer = document.getElementById('alliance-nav-container');
        const mobileAllianceNavContainer = document.getElementById('mobile-alliance-nav-container');
        const createEventButton = document.getElementById('create-event-button');
        const eventsMainContainer = document.getElementById('events-main-container');
        const authContainer = document.getElementById('auth-container');
        const mobileAuthContainer = document.getElementById('mobile-auth-container');
        
        // --- UI Functions ---
        const showLoading = (show) => { loadingOverlay.style.display = show ? 'flex' : 'none'; };
        const showModal = (modal, content) => {
            if (content) modal.querySelector('.modal-content').innerHTML = content;
            modal.classList.remove('hidden');
            setTimeout(() => { modal.style.opacity = 1; modal.querySelector('.modal-content').style.transform = 'scale(1)'; }, 10);
        };
        const hideModal = (modal) => {
            modal.style.opacity = 0;
            modal.querySelector('.modal-content').style.transform = 'scale(0.95)';
            setTimeout(() => modal.classList.add('hidden'), 300);
        };

        // --- Auth & Registration ---
        const alliances = ["THOR", "fAfO", "HeRA", "pHNx", "TroW", "VaLT", "COLD", "Tone", "DoM", "MINI", "MEGA", "Lat1", "WSKT", "ValT", "BRSL", "TCM1", "BLSD", "REI", "wpg1", "SHRK"];
        
        const showAuthForm = (type = 'login') => {
            // Complex form HTML is omitted for brevity but would be injected here
        };

        // --- Event Rendering ---
        const renderEvents = () => {
             // Event rendering logic here
        };

        // --- Player Rendering ---
        const renderPlayers = () => {
            // Player card rendering logic here
        };

        // --- Alliance Member Verification UI ---
        const renderAllianceMembers = async () => {
            // Logic to fetch and display unverified members for R4/R5
        };

        // --- Main Auth State Change Handler ---
        onAuthStateChanged(auth, async (user) => {
            showLoading(true);
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists() && userDoc.data().verified) {
                    currentUserData = { uid: user.uid, ...userDoc.data() };
                    allianceNavContainer.innerHTML = `<div class="nav-item"><div class="nav-link" data-main-target="page-alliance-members"><i class="fas fa-user-check"></i><span>Verify</span></div></div>`;
                    mobileAllianceNavContainer.innerHTML = `<a href="#" class="mobile-nav-link text-xl font-bold flex items-center gap-4 p-4 rounded-lg" data-target="page-alliance-members"><i class="fas fa-user-check w-6 text-center" style="color: var(--color-primary);"></i>Verify Members</a>`;
                    if(currentUserData.rank >= 4) createEventButton.classList.remove('hidden');
                } else {
                    currentUserData = null; // Treat as guest if not verified
                    createEventButton.classList.add('hidden');
                }
            } else {
                currentUserData = null;
                allianceNavContainer.innerHTML = '';
                mobileAllianceNavContainer.innerHTML = '';
                createEventButton.classList.add('hidden');
            }
            // updateAuthUI(user);
            renderEvents();
            renderPlayers();
            showLoading(false);
        });

        // --- Data Fetching ---
        onSnapshot(collection(db, "events"), (snapshot) => {
            eventsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderEvents();
        });
        onSnapshot(query(collection(db, "users"), where("verified", "==", true)), (snapshot) => {
            playersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderPlayers();
        });

        // --- Init ---
        showPage('page-events'); // Default page
    </script>
</body>
</html>
