<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Last War: Survival - 899 Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        :root {
            --color-bg: #0D1117;
            --color-primary: #00BFFF;
            --color-highlight: #F87171;
            --color-glass-bg: rgba(22, 27, 34, 0.40); 
            --color-dropdown-bg: rgba(22, 27, 34, 0.95);
        }
        @keyframes pulse-live { 0%, 100% { box-shadow: 0 0 5px var(--color-primary); } 50% { box-shadow: 0 0 10px var(--color-primary); } }
        @keyframes slide-in-right { to { opacity: 1; transform: translateX(0); } }
        body { font-family: 'Inter', sans-serif; background-color: var(--color-bg); color: #c9d1d9; }
        #particle-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at top left, rgba(0, 191, 255, 0.1), transparent 40%), radial-gradient(circle at bottom right, rgba(248, 113, 113, 0.1), transparent 40%); }
        .glass-pane { background-color: var(--color-glass-bg); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border-radius: 1rem; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); }
        .header-main { padding: 0.75rem 1.5rem; position: relative; z-index: 50; }
        .nav-item { position: relative; }
        .nav-link { position: relative; padding: 0.5rem; font-weight: 600; font-size: 0.75rem; color: #c9d1d9; transition: color 0.3s ease; display: flex; flex-direction: column; align-items: center; gap: 0.25rem; width: 80px; cursor: pointer; }
        .nav-link i { font-size: 1rem; }
        .nav-link:hover { color: #fff; }
        .nav-link::after { content: ''; position: absolute; bottom: 0; left: 20%; right: 20%; height: 2px; background-color: var(--color-primary); transform: scaleX(0); transform-origin: center; transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1); }
        .nav-item:hover .nav-link::after, .nav-link.active::after { transform: scaleX(1); }
        .nav-link.active { color: #fff; }
        .dropdown-menu { position: absolute; top: calc(100% + 12px); left: 50%; transform: translateX(-50%) translateY(-10px); opacity: 0; visibility: hidden; transition: opacity 0.3s ease, transform 0.3s ease, visibility 0s 0.3s; z-index: 100; padding: 0.5rem; min-width: 180px; border-top: 2px solid var(--color-primary); background-color: var(--color-dropdown-bg); }
        .nav-item:hover .dropdown-menu, .nav-item.open .dropdown-menu { transform: translateX(-50%) translateY(0); opacity: 1; visibility: visible; transition: opacity 0.3s ease, transform 0.3s ease, visibility 0s 0s; }
        .dropdown-link { display: block; padding: 0.6rem 1rem; border-radius: 0.5rem; font-size: 0.875rem; color: #c9d1d9; transition: background-color 0.2s ease, color 0.2s ease; white-space: nowrap; cursor: pointer; }
        .dropdown-link:hover { background-color: rgba(0, 191, 255, 0.1); color: #fff; }
        .login-button { padding: 0.6rem 1.25rem; font-weight: 600; font-size: 0.875rem; color: #c9d1d9; background-color: rgba(255,255,255,0.05); border-radius: 0.5rem; border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem; }
        .login-button:hover { color: #fff; background-color: rgba(0, 191, 255, 0.1); border-color: var(--color-primary); }
        .section-container { padding: 1.25rem; }
        .event-card { background-color: rgba(13, 17, 23, 0.7); border-radius: 0.75rem; overflow: hidden; transition: all 0.3s ease; display: flex; flex-direction: column; border: 1px solid rgba(255,255,255,0.1); }
        .event-card:hover { box-shadow: 0 0 10px 0px var(--color-primary); }
        .live-indicator { animation: pulse-live 2s infinite; }
        .toggle-button { position: relative; padding: 0.75rem 1rem; font-size: 0.9rem; font-weight: 600; color: #8b949e; background-color: transparent; border: none; transition: color 0.3s ease; flex-shrink: 0; }
        .toggle-button:hover { color: #c9d1d9; }
        .toggle-button.active { color: #fff; }
        .toggle-button::after { content: ''; position: absolute; bottom: 0.5rem; left: 1rem; right: 1rem; height: 2px; background-color: var(--color-primary); transform: scaleX(0); transition: transform 0.3s ease-in-out; }
        .toggle-button.active::after { transform: scaleX(1); }
        .player-card { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .player-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2), 0 0 15px var(--color-primary); }
        .action-button { background: rgba(255,255,255,0.1); border-radius: 0.375rem; padding: 0.5rem; transition: all 0.2s ease; }
        .action-button:hover { background: var(--color-primary); color: #0D1117; }
        .styled-table { width: 100%; border-collapse: collapse; }
        .styled-table th, .styled-table td { padding: 0.75rem 1rem; text-align: left; vertical-align: middle; }
        .styled-table thead { border-bottom: 2px solid var(--color-primary); }
        .styled-table th { font-size: 0.875rem; font-weight: 700; color: #fff; text-transform: uppercase; letter-spacing: 0.05em; }
        .styled-table tbody tr { border-bottom: 1px solid rgba(255, 255, 255, 0.1); transition: background-color 0.2s ease; }
        .styled-table tbody tr:last-child { border-bottom: none; }
        .styled-table tbody tr:hover { background-color: rgba(0, 191, 255, 0.05); }
        .styled-table .tag { font-weight: 800; color: #fff; }
        .filter-dropdown { position: relative; }
        .filter-dropdown-button { background-color: rgba(255,255,255,0.05); border: 1px solid rgba(255, 255, 255, 0.1); }
        .filter-dropdown-button:hover { background-color: rgba(0, 191, 255, 0.1); border-color: var(--color-primary); }
        .filter-dropdown-menu { position: absolute; top: 100%; left: 0; right: 0; z-index: 10; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.3s ease; background-color: var(--color-dropdown-bg); }
        .filter-dropdown.open .filter-dropdown-menu { opacity: 1; visibility: visible; transform: translateY(5px); }
        .filter-dropdown-item { color: #c9d1d9; }
        .filter-dropdown-item:hover { background-color: rgba(0, 191, 255, 0.1); color: #fff; }
        #mobile-menu { opacity: 0; pointer-events: none; transition: opacity 0.3s ease-in-out; }
        #mobile-menu.open { opacity: 1; pointer-events: auto; }
        #mobile-menu-content { transform: translateY(-30px); transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        #mobile-menu.open #mobile-menu-content { transform: translateY(0); }
        .mobile-nav-link { opacity: 0; transform: translateX(-15px); transition: background-color 0.2s ease, transform 0.2s ease; }
        .mobile-nav-link:hover { background-color: rgba(0, 191, 255, 0.1); transform: translateX(0px); }
        #mobile-menu.open .mobile-nav-link, #mobile-menu.open .mobile-menu-divider { animation: slide-in-right 0.5s forwards cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        #mobile-menu.open .mobile-nav-link:nth-of-type(1) { animation-delay: 0.1s; }
        #mobile-menu.open .mobile-nav-link:nth-of-type(2) { animation-delay: 0.15s; }
        #mobile-menu.open .mobile-nav-link:nth-of-type(3) { animation-delay: 0.2s; }
        #mobile-menu.open .mobile-nav-link:nth-of-type(4) { animation-delay: 0.25s; }
        #mobile-menu.open .mobile-nav-link:nth-of-type(5) { animation-delay: 0.3s; }
        #mobile-menu.open .mobile-nav-link:nth-of-type(6) { animation-delay: 0.35s; }
        #mobile-menu.open .mobile-menu-divider { animation-delay: 0.4s; }
        #event-toggles { -ms-overflow-style: none; scrollbar-width: none; }
        #event-toggles::-webkit-scrollbar { height: 4px; }
        #event-toggles::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 2px; }
        #event-toggles::-webkit-scrollbar-thumb { background: var(--color-primary); border-radius: 2px; }
        #event-toggles::-webkit-scrollbar-thumb:hover { background: #00a0d9; }
        .modal { transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        .form-step { display: none; }
        .form-step.active { display: block; }
    </style>
</head>
<body>
    <canvas id="particle-canvas"></canvas>
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900/80 flex items-center justify-center z-[100]"><div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-cyan-500"></div></div>
    
    <!-- Modals -->
    <div id="auth-modal" class="modal hidden fixed inset-0 bg-black/70 backdrop-blur-md z-50 flex items-center justify-center p-4">
        <div class="modal-content glass-pane w-full max-w-md p-8 rounded-2xl">
            <!-- Auth modal content will be injected here -->
        </div>
    </div>
     <div id="add-player-modal" class="modal hidden fixed inset-0 bg-black/70 backdrop-blur-md z-50 flex items-center justify-center p-4">
        <div class="modal-content glass-pane w-full max-w-md p-8 rounded-2xl">
            <!-- Add player modal content -->
        </div>
    </div>
     <div id="create-event-modal" class="modal hidden fixed inset-0 bg-black/70 backdrop-blur-md z-50 flex items-center justify-center p-4">
        <div class="modal-content glass-pane w-full max-w-lg p-8 rounded-2xl">
            <!-- Create event modal content -->
        </div>
    </div>


    <div class="relative min-h-screen w-full p-4 sm:p-6 lg:p-8">
        <div class="max-w-6xl mx-auto">
            <header class="glass-pane header-main flex justify-between items-center mb-6">
                <div class="flex-shrink-0">
                    <h1 class="text-2xl md:text-3xl font-black tracking-tighter text-white">899<span class="font-bold" style="color: var(--color-primary);">EVENTS</span></h1>
                    <p class="text-xs text-gray-400">Official Event Hub</p>
                </div>
                
                <nav id="main-nav" class="hidden md:flex flex-grow justify-center items-center">
                    <div class="nav-item"><div class="nav-link" data-main-target="page-events"><i class="fas fa-calendar-alt"></i><span>Events</span></div></div>
                    <div class="nav-item"><div class="nav-link" data-main-target="page-players"><i class="fas fa-users"></i><span>Players</span></div></div>
                    <div id="alliance-nav-container"></div>
                </nav>

                <div id="auth-container" class="hidden md:flex flex-shrink-0"></div>
                
                <button id="mobile-menu-button" class="md:hidden text-white p-2 rounded-md hover:bg-white/10 transition-colors z-50">
                    <svg id="menu-open-icon" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
                    <svg id="menu-close-icon" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </header>
            
            <div id="mobile-menu" class="md:hidden fixed inset-0 bg-black/70 backdrop-blur-md z-40 flex items-center justify-center">
                <!-- Mobile menu content -->
            </div>

            <div id="page-container">
                <div id="page-events" class="page-content">
                    <div class="flex justify-between items-center mb-4">
                         <h2 class="text-3xl font-bold text-white">Events</h2>
                         <button id="create-event-button" class="hidden login-button bg-cyan-500/20 hover:bg-cyan-500/40">
                            <i class="fas fa-plus mr-2"></i>Create Event
                        </button>
                    </div>
                    <main id="events-main-container" class="space-y-8"></main>
                </div>

                <div id="page-players" class="page-content" style="display: none;">
                    <!-- Players page content -->
                </div>
                
                <div id="page-alliance-members" class="page-content" style="display: none;">
                    <div class="glass-pane section-container">
                        <h2 class="text-3xl font-bold text-white text-center mb-4">Alliance Members</h2>
                        <div id="alliance-members-grid" class="overflow-x-auto"></div>
                    </div>
                </div>
            </div>
            <footer class="text-center mt-12 py-4 border-t border-gray-800/50"><p class="text-gray-500">&copy; 2024 Last War Survival - Server 899 Community.</p></footer>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, onSnapshot, addDoc, updateDoc, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyA8KKDjjw0Pb_wknZ3TRWuL7-7XMo4VeY0",
            authDomain: "events-ea397.firebaseapp.com",
            projectId: "events-ea397",
            storageBucket: "events-ea397.appspot.com",
            messagingSenderId: "51859633788",
            appId: "1:51859633788:web:3653d3e7edb6d3c1c4fbf9"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- App State ---
        let currentUserData = null;

        // --- DOM Elements ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const authModal = document.getElementById('auth-modal');
        const allianceNavContainer = document.getElementById('alliance-nav-container');
        const createEventButton = document.getElementById('create-event-button');
        const eventsMainContainer = document.getElementById('events-main-container');
        
        // --- UI Functions ---
        const showLoading = (show) => { loadingOverlay.style.display = show ? 'flex' : 'none'; };
        const showModal = (modal, content) => {
            if (content) modal.querySelector('.modal-content').innerHTML = content;
            modal.classList.remove('hidden');
            setTimeout(() => { modal.style.opacity = 1; modal.querySelector('.modal-content').style.transform = 'scale(1)'; }, 10);
        };
        const hideModal = (modal) => {
            modal.style.opacity = 0;
            modal.querySelector('.modal-content').style.transform = 'scale(0.95)';
            setTimeout(() => modal.classList.add('hidden'), 300);
        };

        // --- Auth UI & Registration ---
        const alliances = ["THOR", "fAfO", "HeRA", "pHNx", "TroW", "VaLT", "COLD", "Tone", "DoM", "MINI", "MEGA", "Lat1", "WSKT", "ValT", "BRSL", "TCM1", "BLSD", "REI", "wpg1", "SHRK"];
        
        const showAuthForm = (type = 'login') => {
            let content;
            if (type === 'login') {
                content = `
                    <h2 class="text-2xl font-bold text-white text-center mb-6">Login</h2>
                    <form id="login-form" class="space-y-4">
                        <input required class="w-full bg-gray-900/50 border border-gray-700 rounded-lg px-4 py-2 text-white" type="email" name="email" placeholder="Email">
                        <input required class="w-full bg-gray-900/50 border border-gray-700 rounded-lg px-4 py-2 text-white" type="password" name="password" placeholder="Password">
                        <div id="auth-error" class="text-red-400 text-sm text-center h-4"></div>
                        <button type="submit" class="w-full login-button bg-cyan-500/20">Login</button>
                    </form>
                    <div class="text-center mt-4 text-sm">
                        <a href="#" id="forgot-password-link" class="text-cyan-400 hover:underline">Forgot Password?</a>
                        <p class="text-gray-400 mt-2">Don't have an account? <a href="#" id="show-signup-link" class="text-cyan-400 hover:underline">Sign Up</a></p>
                    </div>`;
            } else if (type === 'signup') {
                content = `
                    <h2 class="text-2xl font-bold text-white text-center mb-6">Create Account</h2>
                    <form id="signup-form" class="space-y-4">
                        <div class="form-step active" data-step="1">
                            <h3 class="font-bold mb-2">Step 1: Account Info</h3>
                            <input required class="w-full bg-gray-900/50 border border-gray-700 rounded-lg px-4 py-2 text-white" type="text" name="gamertag" placeholder="In-Game Name">
                            <input required class="w-full bg-gray-900/50 border border-gray-700 rounded-lg px-4 py-2 mt-4 text-white" type="email" name="email" placeholder="Email (for recovery)">
                            <input required class="w-full bg-gray-900/50 border border-gray-700 rounded-lg px-4 py-2 mt-4 text-white" type="password" name="password" placeholder="Password">
                            <input required class="w-full bg-gray-900/50 border border-gray-700 rounded-lg px-4 py-2 mt-4 text-white" type="password" name="password-confirm" placeholder="Confirm Password">
                            <button type="button" class="w-full mt-4 login-button next-step">Next</button>
                        </div>
                        <div class="form-step" data-step="2">
                            <h3 class="font-bold mb-2">Step 2: Player Details</h3>
                            <select name="alliance" required class="w-full bg-gray-900/50 border border-gray-700 rounded-lg px-4 py-2 text-white">${alliances.map(a => `<option value="${a}">${a}</option>`).join('')}</select>
                            <select name="rank" required class="w-full mt-4 bg-gray-900/50 border border-gray-700 rounded-lg px-4 py-2 text-white">
                                ${[1,2,3,4,5].map(r => `<option value="${r}">R${r}</option>`).join('')}
                            </select>
                            <input required class="w-full mt-4 bg-gray-900/50 border border-gray-700 rounded-lg px-4 py-2 text-white" type="text" name="power" placeholder="Total Power (e.g., 150,000,000)">
                            <button type="button" class="w-1/2 mt-4 login-button prev-step">Back</button>
                            <button type="button" class="w-1/2 mt-4 login-button next-step">Next</button>
                        </div>
                         <div class="form-step" data-step="3">
                            <h3 class="font-bold mb-2">Step 3: Squad Power & Avatar</h3>
                            <input required class="w-full bg-gray-900/50 border border-gray-700 rounded-lg px-4 py-2 text-white" type="text" name="tankPower" placeholder="Tank Squad Power">
                            <input required class="w-full mt-4 bg-gray-900/50 border border-gray-700 rounded-lg px-4 py-2 text-white" type="text" name="airPower" placeholder="Air Squad Power">
                            <input required class="w-full mt-4 bg-gray-900/50 border border-gray-700 rounded-lg px-4 py-2 text-white" type="text" name="missilePower" placeholder="Missile Squad Power">
                            <label class="block mt-4 text-sm font-medium text-gray-300">Avatar</label>
                            <input type="file" name="avatar" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cyan-500/20 file:text-cyan-300 hover:file:bg-cyan-500/30">
                            <button type="button" class="w-1/2 mt-4 login-button prev-step">Back</button>
                            <button type="submit" class="w-1/2 mt-4 login-button bg-cyan-500/20">Create Account</button>
                        </div>
                        <div id="auth-error" class="text-red-400 text-sm text-center h-4"></div>
                    </form>
                    <p class="text-center text-gray-400 mt-2">Already have an account? <a href="#" id="show-login-link" class="text-cyan-400 hover:underline">Log In</a></p>`;
            } else { // recovery
                content = `
                    <h2 class="text-2xl font-bold text-white text-center mb-6">Password Recovery</h2>
                    <form id="recovery-form" class="space-y-4">
                        <input required class="w-full bg-gray-900/50 border border-gray-700 rounded-lg px-4 py-2 text-white" type="email" name="email" placeholder="Enter your email">
                        <div id="auth-error" class="text-green-400 text-sm text-center h-4"></div>
                        <button type="submit" class="w-full login-button bg-cyan-500/20">Send Recovery Email</button>
                    </form>
                    <p class="text-center text-gray-400 mt-2"><a href="#" id="show-login-link" class="text-cyan-400 hover:underline">Back to Login</a></p>`;
            }
            showModal(authModal, content);
        };

        // --- Event Prioritization & Rendering ---
        const renderEvents = (events, userData) => {
            const eventTypes = ["alliance", "seasonal", "server-wide", "arms-race"];
            if(userData && userData.alliance){
                // Prioritize user's alliance
                eventTypes.sort((a,b) => a === "alliance" ? -1 : 1);
            }
            
            eventsMainContainer.innerHTML = eventTypes.map(type => {
                const filteredEvents = events.filter(e => e.type === type && (!e.alliance || !userData || e.alliance === userData.alliance));
                if (filteredEvents.length === 0) return '';
                
                return `
                    <section class="glass-pane section-container">
                        <h2 class="text-xl font-bold border-l-4 pl-3 capitalize" style="border-color: var(--color-primary);">${type.replace('-', ' ')}</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-4">
                            ${filteredEvents.map(event => `
                                <div class="event-card">
                                     <img src="${event.imageUrl || 'https://placehold.co/600x300/003344/00A9FF?text=Event'}" class="w-full h-40 object-cover">
                                     <div class="p-4 flex-grow flex flex-col">
                                        <h3 class="text-lg font-bold text-white">${event.name}</h3>
                                        <p class="text-gray-400 text-sm my-2 flex-grow">${event.description}</p>
                                        <div class="flex justify-between items-center text-sm mt-auto">
                                            <span class="font-semibold text-gray-400">${new Date(event.date.seconds * 1000).toLocaleDateString()}</span>
                                        </div>
                                     </div>
                                </div>
                            `).join('')}
                        </div>
                    </section>
                `;
            }).join('');
        };

        // --- Firebase Auth Logic ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                currentUserData = userDoc.exists() ? userDoc.data() : null;
            } else {
                currentUserData = null;
            }
            // Update UI based on auth state
        });
        
        // --- Data Fetching ---
        onSnapshot(collection(db, "events"), (snapshot) => {
            const events = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderEvents(events, currentUserData);
        });

        // --- Initial Load & Navigation ---
        showLoading(true);
        // ... rest of the navigation and initialization logic
    </script>
</body>
</html>
