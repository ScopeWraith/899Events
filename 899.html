<!-- 
===============================================
FIREBASE SECURITY RULES (FIRESTORE)
===============================================
NOTE: The 'if' statements in these rules are the correct and required syntax for Firestore Security Rules (version 2) on 'allow' lines.
The previous version contained invalid statements inside functions, which has now been fixed.

rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- HELPER FUNCTIONS ---
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }

    function isAdmin(userId) {
      return isSignedIn() && getUserData(userId).isAdmin == true;
    }
    
    function isVerified(userId) {
      return isSignedIn() && getUserData(userId).isVerified == true;
    }

    // --- COLLECTION RULES ---

    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || canManageUser(userId);
      allow delete: if isOwner(userId);
    }
    
    function canManageUser(targetUserId) {
      return isSignedIn() && (
        isAdmin(request.auth.uid) ||
        (
          getUserData(request.auth.uid).alliance == getUserData(targetUserId).alliance &&
          (
            (getUserData(request.auth.uid).allianceRank == 'R5' && (getUserData(targetUserId).allianceRank == 'R4' || getUserData(targetUserId).allianceRank == 'R3' || getUserData(targetUserId).allianceRank == 'R2' || getUserData(targetUserId).allianceRank == 'R1')) ||
            (getUserData(request.auth.uid).allianceRank == 'R4' && (getUserData(targetUserId).allianceRank == 'R3' || getUserData(targetUserId).allianceRank == 'R2' || getUserData(targetUserId).allianceRank == 'R1'))
          )
        )
      );
    }

    match /posts/{postId} {
      allow read: if true;
      allow create: if canCreatePost(request.resource.data);
      allow update, delete: if isOwner(resource.data.authorUid) || isAdmin(request.auth.uid);
    }
    
    function canCreatePost(postData) {
      return isOwner(postData.authorUid) && (
        isAdmin(request.auth.uid) ||
        (
          !(postData.subType == 'server' || postData.subType == 'seasonal' || postData.subType == 'hot_deals' || postData.subType == 'wanted_boss' || postData.subType == 'campaign' || postData.subType == 'vs') &&
          !(!isVerified(request.auth.uid) && postData.subType == 'alliance' && postData.mainType == 'event') &&
          (
            (postData.subType == 'alliance' && (getUserData(request.auth.uid).allianceRank == 'R5' || getUserData(request.auth.uid).allianceRank == 'R4')) ||
            (postData.subType == 'leadership' && getUserData(request.auth.uid).allianceRank == 'R5')
          )
        )
      );
    }
  }
}
-->

<!-- 
===============================================
FIREBASE SECURITY RULES (STORAGE)
===============================================
These rules should be deployed to your Firebase project's Storage settings.

rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    match /avatars/{userId} {
      allow read;
      allow write: if request.auth != null 
                   && request.auth.uid == userId
                   && request.resource.size < 2 * 1024 * 1024 // Max 2MB for larger images
                   && request.resource.contentType.matches('image/.*');
    }

    match /post_thumbnails/{postId} {
        allow read;
        allow write: if request.auth != null
                     && request.resource.size < 2 * 1024 * 1024 // Max 2MB for larger images
                     && request.resource.contentType.matches('image/.*');
    }
  }
}
-->

<!--
===============================================
CHANGELOG
===============================================
- Prompt 30: Fixed image squishing on upload. Images are now resized to a max of 1024x1024 while maintaining their original aspect ratio.
- Prompt 29: Changed card layout to a single-column, full-width design for a more focused view.
- Prompt 29: Made cards more vertically compact by adjusting header height and internal padding.
- Prompt 29: Fixed distorted header images by ensuring `background-size: cover` is applied correctly.
- Prompt 29: Removed author information from the card footer to simplify the design.
- Prompt 29: Relocated the event status/timestamp to the card footer for better information flow, placing it to the left of the action buttons.
- Prompt 28: Executed a major visual optimization of the "gamer-style" cards, focusing on unique aesthetics.
- Prompt 28: Implemented `clip-path` to create dynamic, angled shapes for card headers and category tags, enhancing the futuristic look.
- Prompt 28: Refined typography, including font sizes, weights, and letter-spacing, to establish a clearer and more professional visual hierarchy.
- Prompt 28: Optimized margins and padding within the cards for better balance and content readability.
- Prompt 28: Enhanced hover effects for a more engaging and responsive user interaction.
- Prompt 27: Completely redesigned event and announcement cards with a "gamer-like" aesthetic, featuring angled elements, glowing borders, and improved layout.
- Prompt 27: Integrated Edit/Delete buttons seamlessly into the card footer for a cleaner look and better user experience, removing poorly-placed hover buttons.
- Prompt 27: Fixed the bug where the edit modal would appear empty by correcting the form population logic in `populatePostFormForEdit`.
- Prompt 27: Enhanced the edit modal flow to hide the stepper navigation and show a combined form for a more intuitive editing process.
- Prompt 26: Redesigned event and announcement cards for a more appealing and engaging layout.
- Prompt 26: Implemented a generic confirmation modal for post deletion to prevent accidental removal.
- Prompt 26: Integrated edit functionality to reuse the creation modal, pre-filling it with the selected post's data for a seamless editing experience.
- Prompt 25: Corrected Firebase rules syntax by removing invalid 'in' keyword and fixing logic in 'isAdmin' and 'isVerified'.
- Prompt 25: Added a "LIVE" text overlay to event thumbnails for currently running events.
- Prompt 25: Ensured event thumbnails use `object-fit: cover` within an `<img>` tag to prevent stretching.
- Prompt 24: Implemented Edit/Delete functionality for posts, with permissions for admins and original authors.
- Prompt 24: Refined announcement card padding and spacing for better visual balance.
- Prompt 24: Added logic to desaturate event thumbnails for 'upcoming'/'ended' states and colorize them for 'live' events.
- Prompt 24: Ensured event thumbnails use `object-fit: cover` to prevent stretching.
- Prompt 23: Reinstated event thumbnails and removed event descriptions for a cleaner, title-focused layout.
- Prompt 23: Removed event group headers in favor of a single, continuous list.
- Prompt 23: Added explicit, color-coded event type labels (e.g., "SERVER EVENT") inside each event item.
- Prompt 22: Reverted event items to a glass pane background for UI consistency.
- Prompt 22: Added distinct, color-coded labels with icons to each event item for clear identification.
- Prompt 22: Implemented subtle gradient and shadow effects on live/hovered events for a polished, glowing look.
- Prompt 21: Overhauled Event display to a professional, color-coded list format inspired by user-provided reference.
- Prompt 21: Implemented a "time ago" timestamp for announcements and prepended author names with their alliance tag.
- Prompt 21: Refined "live" event styling for better visual prominence.
- Prompt 20: Completely redesigned Event display into professional, multi-part cards for superior clarity and visual appeal.
- Prompt 20: Implemented a responsive two-column grid layout for the event list on larger screens.
- Prompt 20: Refined Announcement cards with more subtle styling and added a placeholder for future 'reaction' functionality.
- Prompt 20: Enhanced event status indicators (Live, Upcoming, etc.) to be more prominent and visually integrated into the new card design.
- Prompt 19: Graphically overhauled Announcement cards with a new layout featuring themed icons and accent colors.
- Prompt 19: Reworked Event list items into a 'ticket' style layout for improved scannability and visual appeal.
- Prompt 19: Enhanced status indicators for events to be more prominent and descriptive.
- Prompt 18: Separated Events and Announcements into distinct, professionally styled sections.
- Prompt 18: Created a new, visually appealing card layout for announcements.
- Prompt 18: Overhauled the event list item design for better clarity, visual hierarchy, and interactivity.
- Prompt 17: Completely overhauled event/announcement display to a more professional, grouped list format.
- Prompt 17: Added dynamic status indicators (Live, Upcoming, Ended) with unique styling and animations for each state.
- Prompt 17: Implemented themed group headers for better organization of the event list.
- Prompt 16: Visually overhauled Event and Announcement cards with a more professional, multi-part layout.
- Prompt 16: Added themed gradient borders and enhanced hover effects to all post cards.
- Prompt 16: Redesigned meta-information display into stylish, pill-shaped badges.
- Prompt 15: Fixed all custom dropdown menus by restoring and improving positioning logic in CSS.
- Prompt 15: Refined dropdown visual alignment for a cleaner presentation.
- Prompt 14: Widened main layout to fix header crowding and better utilize space.
- Prompt 14: Completely redesigned and fixed the Event Schedule modal layout for clarity.
- Prompt 14: Visually optimized event type selection buttons and section headers.
- Prompt 14: Hid the main "Events & Announcements" title and divider as requested.
- Prompt 14: Corrected and locked the Firebase storageBucket URL.
- Prompt 13: Redesigned Event Schedule modal for clarity and better layout.
- Prompt 13: Replaced plain dividers with themed, glowing gradient dividers.
- Prompt 13: Enhanced interactivity of modal selection buttons with new hover effects.
- Prompt 12: Implemented a robust modal scrolling solution with a new wrapper div.
- Prompt 12: Executed a major visual overhaul, beautifying buttons, cards, modals, and forms with gradients, shadows, and refined styles.
- Prompt 12: Enhanced the glass effect for a more vibrant and polished UI.
- Prompt 12: Fixed a latent bug in the Firebase Storage configuration.
- Prompt 11: Reduced overall website width and font sizes for a more compact UI.
- Prompt 11: Overhauled all modals to ensure content fits better and scrolls correctly when overflowing.
- Prompt 11: Adjusted multi-column layouts to better suit the new, narrower design.
- Prompt 10: Overhauled event scheduling with intuitive Day of Week and Hour of Day dropdowns.
- Prompt 10: Simplified event repetition to a "None" or "Weekly" choice, with an input for week count.
- Prompt 10: Fixed mobile navigation menu being obscured by the modal backdrop.
- Prompt 10: Stabilized custom dropdown menus to prevent unexpected closing.
- Prompt 9: Overhauled event time selection with simplified, styled inputs for date, hour, and minute.
- Prompt 9: Redesigned post cards to display thumbnails as a square on the left, with themed icons as a fallback.
- Prompt 9: Heavily styled new components with CSS for a beautiful, integrated look.
- Prompt 8: Overhauled event/announcement display with countdown timers, status indicators, and a filterable legend.
- Prompt 8: Implemented a responsive slide-out filter menu for mobile devices.
- Prompt 7: Redesigned the post creation modal into a more intuitive, guided, multi-step process based on user permissions.
- Prompt 6: Implemented themed, scrolling content areas for all modals to prevent overflow on smaller screens.
- Prompt 5: Refined event/announcement types with specific permissions and optimized the creation modal flow.
- Prompt 5: Enhanced event creation with an option for weekly repetition over a specified number of weeks.
- Prompt 5: Updated Firebase security rules to reflect the new, more granular post type permissions.
- Prompt 4: Added thumbnail upload functionality to the post creation modal with a 300x300 preview.
- Prompt 4: Themed the uploaded thumbnail into a stylish header banner on the event/announcement cards.
- Prompt 4: Updated Firebase Storage security rules to accommodate post thumbnail uploads.
- Prompt 3: Replaced default datetime-local inputs with a custom-styled, user-friendly date and time picker component.
- Prompt 2: Overhauled the post creation modal for a more efficient, permission-based workflow.
- Prompt 2: Completely redesigned the display of event and announcement cards with unique styles, icons, and colors for each type.
- Prompt 2: Updated and refined the permission logic for both creating posts and managing player verification to match detailed requirements.
- Prompt 1: Added robust Firebase Security Rules for Firestore and Storage.
- Prompt 1: Fixed a critical bug where the "Change Avatar" button for existing users was non-functional.
- Prompt 1: Resolved a race condition during user registration that prevented the avatar and profile from displaying correctly without a page refresh.
- Prompt 1: Refactored authentication handling to use real-time listeners for the user's profile, ensuring instant UI updates.
- Prompt 1: Replaced the blocking `confirm()` dialog for post deletion with a non-blocking, two-click confirmation button.
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Last War: Survival - 899 Dashboard</title>
    <link rel="icon" href="data:,">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        :root {
            --color-bg: #0D1117;
            --color-primary: #00BFFF;
            --color-primary-glow: rgba(0, 191, 255, 0.5);
            --color-highlight: #F87171;
            --color-glass-bg: rgba(22, 27, 34, 0.6); 
            --color-dropdown-bg: rgba(18, 24, 33, 0.98);
            
            /* Post/Event Theme Colors */
            --post-color-server: #FFD700;
            --post-color-seasonal: #9370DB;
            --post-color-leadership: #C0C0C0;
            --post-color-alliance: #00BFFF;
            --post-color-hot_deals: #FF6347;
            --post-color-wanted_boss: #DC143C;
            --post-color-campaign: #32CD32;
            --post-color-vs: #FFA500;
        }

        @keyframes pulse-live { 0%, 100% { box-shadow: 0 0 12px var(--glow-color); } 50% { box-shadow: 0 0 24px var(--glow-color); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes success-pop { 0% { transform: scale(0.7); opacity: 0; } 80% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }

        html { font-size: 80%; }
        body { font-family: 'Inter', sans-serif; background-color: var(--color-bg); color: #c9d1d9; overflow-x: hidden; }
        #particle-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at top left, rgba(0, 191, 255, 0.05), transparent 30%), radial-gradient(circle at bottom right, rgba(248, 113, 113, 0.05), transparent 30%); }
        .glass-pane { background: linear-gradient(135deg, rgba(22, 27, 34, 0.6), rgba(22, 27, 34, 0.3)); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 1rem; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); }
        .header-main { padding: 0.75rem 1.5rem; position: relative; z-index: 50; }
        .nav-item { position: relative; }
        .nav-link { position: relative; padding: 0.5rem; font-weight: 600; font-size: 0.75rem; color: #c9d1d9; transition: color 0.3s ease; display: flex; flex-direction: column; align-items: center; gap: 0.25rem; width: 80px; cursor: pointer; }
        .nav-link i { font-size: 1rem; }
        .nav-link:hover, .nav-link.active { color: #fff; }
        .nav-link::after { content: ''; position: absolute; bottom: 0; left: 20%; right: 20%; height: 2px; background-color: var(--color-primary); transform: scaleX(0); transform-origin: center; transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1); }
        .nav-item:hover .nav-link::after, .nav-link.active::after { transform: scaleX(1); }
        .dropdown-pane { position: absolute; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, transform 0.3s ease, visibility 0s 0.3s; z-index: 100; padding: 0.5rem; min-width: 180px; border-top: 2px solid var(--color-primary); }
        .dropdown-menu { top: calc(100% + 12px); left: 50%; transform: translateX(-50%) translateY(-10px); }
        .nav-item.open .dropdown-menu { transform: translateX(-50%) translateY(0); opacity: 1; visibility: visible; transition: opacity 0.3s ease, transform 0.3s ease, visibility 0s 0s; }
        .dropdown-link { display: block; padding: 0.6rem 1rem; border-radius: 0.5rem; font-size: 0.875rem; color: #c9d1d9; transition: background-color 0.2s ease, color 0.2s ease; white-space: nowrap; cursor: pointer; }
        .dropdown-link:hover { background-color: rgba(0, 191, 255, 0.1); color: #fff; }
        .auth-button { padding: 0.6rem 1.25rem; font-weight: 600; font-size: 0.875rem; color: #c9d1d9; background-color: rgba(255,255,255,0.05); border-radius: 0.5rem; border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem; }
        .auth-button:hover { color: #fff; background-color: rgba(0, 191, 255, 0.1); border-color: var(--color-primary); }
        .section-container { padding: 1.25rem; }
        .modal-backdrop { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); z-index: 1000; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        .modal-container { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.95); z-index: 1001; width: 90%; max-width: 450px; opacity: 0; transition: all 0.3s ease; pointer-events: none; }
        .modal-backdrop.visible, .modal-container.visible { opacity: 1; pointer-events: auto; }
        .modal-container.visible { transform: translate(-50%, -50%) scale(1); }
        .auth-form { display: none; animation: fadeIn 0.5s forwards; }
        .auth-form.active { display: block; }
        .modal-content-wrapper { padding: 1.5rem; max-height: 85vh; display: flex; flex-direction: column; }
        .modal-content-scroll { overflow-y: auto; padding-right: 1rem; margin-right: -1rem; }
        .modal-content-scroll::-webkit-scrollbar { width: 8px; }
        .modal-content-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 10px; }
        .modal-content-scroll::-webkit-scrollbar-thumb { background: var(--color-primary); border-radius: 10px; }
        .modal-content-scroll::-webkit-scrollbar-thumb:hover { background: #00a9e0; }
        .input-group { position: relative; display: flex; align-items: center; background-color: rgba(13, 17, 23, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 0.5rem; transition: border-color 0.3s ease, box-shadow 0.3s ease; }
        .input-group:focus-within { border-color: var(--color-primary); box-shadow: 0 0 0 2px var(--color-primary-glow), inset 0 1px 2px rgba(0,0,0,0.5); }
        .input-icon { padding: 0 0.75rem; color: #667; border-right: 1px solid rgba(255, 255, 255, 0.1); }
        .input-group:focus-within .input-icon { color: var(--color-primary); }
        .form-input, .form-textarea { background-color: transparent; border: none; color: #c9d1d9; padding: 0.75rem; width: 100%; }
        .form-input:focus, .form-textarea:focus { outline: none; box-shadow: none; }
        .form-textarea { min-height: 100px; resize: vertical; }
        .primary-btn { background: linear-gradient(to right, #00BFFF, #1E90FF); color: white; font-weight: 700; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0, 191, 255, 0.2); }
        .primary-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 191, 255, 0.3); }
        .primary-btn:disabled { background: #555; cursor: not-allowed; transform: none; box-shadow: none; }
        .secondary-btn { background-color: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #c9d1d9; font-weight: 600; transition: all 0.3s ease; }
        .secondary-btn:hover { background-color: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); }
        .form-error { min-height: 20px; }
        .progress-bar { display: flex; justify-content: space-between; margin-bottom: 1.5rem; position: relative; }
        .progress-bar::before { content: ''; position: absolute; top: 50%; left: 0; transform: translateY(-50%); height: 2px; width: 100%; background-color: rgba(255,255,255,0.1); z-index: -1; }
        .progress-bar .line { position: absolute; top: 50%; left: 0; transform: translateY(-50%); height: 2px; background-color: var(--color-primary); width: 0%; transition: width 0.4s ease; z-index: 0; }
        .progress-step { width: 25px; height: 25px; background-color: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.4s ease; position: relative; z-index: 1; }
        .progress-step.active { background-color: var(--color-primary); border-color: var(--color-primary); color: var(--color-bg); }
        .form-slide { display: none; animation: fadeIn 0.5s ease-in-out; }
        .form-slide.active { display: block; }
        .custom-select-container { position: relative; flex-grow: 1; }
        .custom-select-value { display: flex; align-items: center; justify-content: space-between; width: 100%; text-align: left; }
        .custom-select-options { display: block; position: absolute; left: 0; right: 0; max-height: 200px; overflow-y: auto; z-index: 1050; opacity: 0; visibility: hidden; transform: scaleY(0.95); transition: opacity 0.2s ease, transform 0.2s ease, visibility 0s 0.2s; background-color: var(--color-dropdown-bg); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.5rem; padding: 0.5rem; }
        .custom-select-options.open-down { top: calc(100% + 8px); transform-origin: top; }
        .custom-select-options.open-up { bottom: calc(100% + 8px); transform-origin: bottom; }
        .custom-select-container.open .custom-select-options { opacity: 1; visibility: visible; transform: scaleY(1); transition: opacity 0.2s ease, transform 0.2s ease, visibility 0s 0s; }
        .custom-select-option { display: block; padding: 0.75rem 1rem; cursor: pointer; border-radius: 0.375rem; }
        .custom-select-option:hover { background-color: rgba(0, 191, 255, 0.1); }
        .custom-select-search { background-color: rgba(13, 17, 23, 1); border: none; border-bottom: 1px solid rgba(255,255,255,0.2); padding: 0.75rem; width: 100%; color: #c9d1d9; }
        .custom-select-search:focus { outline: none; border-color: var(--color-primary); }
        .custom-select-options::-webkit-scrollbar { width: 8px; }
        .custom-select-options::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 10px; }
        .custom-select-options::-webkit-scrollbar-thumb { background: var(--color-primary); border-radius: 10px; }
        .custom-select-options::-webkit-scrollbar-thumb:hover { background: #00a9e0; }
        #mobile-nav-menu, #mobile-filter-panel { position: fixed; top: 0; right: 0; bottom: 0; width: 280px; z-index: 1100; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        #mobile-nav-menu.open, #mobile-filter-panel.open { transform: translateX(0); }
        .section-header { display: flex; align-items: center; gap: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid; border-image: linear-gradient(to right, var(--glow-color, var(--color-primary)), transparent) 1; }
        
        /* --- Gamer UI Card Styles --- */
        .post-card {
            background-color: #161B22;
            position: relative;
            display: flex;
            transition: all 0.3s ease;
            animation: fadeIn 0.5s ease-out;
            border-radius: 4px;
            border: 1px solid #222933;
            min-height: 120px;
        }
        .post-card:hover {
            transform: translateY(-5px) scale(1.01);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3), 0 0 20px var(--glow-color-transparent, rgba(0, 191, 255, 0.2));
            border-color: var(--glow-color, var(--color-primary));
        }
        .post-card.ended {
            opacity: 0.65;
            filter: grayscale(60%);
        }
        .post-card-header {
            width: 250px;
            flex-shrink: 0;
            background-size: cover;
            background-position: center;
            position: relative;
            clip-path: polygon(0 0, 100% 0, 85% 100%, 0% 100%);
        }
        .post-card-header::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(to right, rgba(22, 27, 34, 0) 0%, rgba(22, 27, 34, 0.4) 80%, rgba(22, 27, 34, 0.8) 100%);
        }
        .post-card-body {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            padding: 1rem 1.25rem;
        }
        .post-card-category {
            background-color: var(--glow-color, var(--color-primary));
            color: #0D1117;
            padding: 0.25rem 0.75rem;
            font-size: 1rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            align-self: flex-end;
        }
        .post-card-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #fff;
            line-height: 1.3;
            margin: 0.5rem 0;
            flex-grow: 1;
        }
        .post-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
        }
        .card-footer-status {
            text-align: left;
        }
        .card-footer-status .status-label {
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            color: #a0a8b1;
            letter-spacing: 0.5px;
        }
        .card-footer-status .status-time {
            font-size: 1rem;
            font-weight: 700;
            color: #fff;
        }
        .event-card.live .card-footer-status .status-label,
        .event-card.live .card-footer-status .status-time {
            color: var(--post-color-server);
        }
        .card-actions { display: flex; gap: 0.5rem; }
        .card-action-btn {
            background: #21262d;
            border: 1px solid #30363d;
            color: #8b949e;
            width: 32px; height: 32px;
            border-radius: 0.375rem;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }
        .card-action-btn:hover { color: #fff; background: #30363d; border-color: var(--glow-color, var(--color-primary)); }
        .card-action-btn.delete-btn:hover { background-color: var(--color-highlight); border-color: var(--color-highlight); }
        .announcement-card .post-card-header { width: 100px; clip-path: polygon(0 0, 100% 0, 75% 100%, 0% 100%); }
        .announcement-card .post-card-title { font-size: 1.1rem; }

    </style>
</head>
<body>
    <canvas id="particle-canvas"></canvas>

    <!-- Mobile Nav & Filter Menus -->
    <div id="mobile-nav-menu" class="glass-pane !rounded-l-lg !rounded-r-none">
        <div class="p-4 flex justify-end">
             <button id="close-mobile-menu-btn" class="text-gray-400 hover:text-white"><i class="fas fa-times fa-2x"></i></button>
        </div>
        <nav id="mobile-nav-links" class="flex flex-col mt-4"></nav>
    </div>
    <div id="mobile-filter-panel" class="glass-pane !rounded-l-lg !rounded-r-none">
        <div class="p-4 flex justify-between items-center border-b border-white/10">
            <h3 class="text-lg font-bold text-white">Filter Posts</h3>
            <button id="close-mobile-filter-btn" class="text-gray-400 hover:text-white"><i class="fas fa-times fa-lg"></i></button>
        </div>
        <div id="mobile-filter-legend" class="p-4 space-y-2"></div>
    </div>

    <!-- Auth & Edit Modals -->
    <div id="modal-backdrop" class="modal-backdrop"></div>
    <div id="auth-modal-container" class="modal-container">
        <div class="glass-pane">
            <div class="modal-content-wrapper">
                <button id="close-auth-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-white transition-colors z-10">
                    <i class="fas fa-times fa-lg"></i>
                </button>
                <div class="modal-content-scroll">
                    <!-- Login Form -->
                    <div id="login-form-container" class="auth-form">
                        <h2 class="text-2xl font-bold text-white text-center mb-4">Login</h2>
                        <p class="text-center text-gray-400 mb-6">Welcome back to the 899 Hub.</p>
                        <form id="login-form">
                            <div class="space-y-4">
                                <div class="input-group"><i class="fas fa-envelope input-icon"></i><input type="email" id="login-email" placeholder="Email" class="form-input" required></div>
                                <div class="input-group"><i class="fas fa-lock input-icon"></i><input type="password" id="login-password" placeholder="Password" class="form-input" required></div>
                            </div>
                            <p id="login-error" class="text-red-400 text-center text-sm mt-4 form-error"></p>
                            <button type="submit" id="login-submit-btn" class="w-full p-3 rounded-lg primary-btn mt-2">Login</button>
                            <div class="text-center text-sm text-gray-400 mt-6">
                                <a href="#" id="forgot-password-link" class="font-semibold hover:text-white" style="color: var(--color-primary);">Forgot Password?</a>
                            </div>
                            <p class="text-center text-sm text-gray-400 mt-4">
                                Don't have an account? <a href="#" id="show-register-link" class="font-semibold hover:text-white" style="color: var(--color-primary);">Register here</a>
                            </p>
                        </form>
                    </div>
                    <!-- Registration Form -->
                    <div id="register-form-container" class="auth-form">
                        <div id="registration-flow">
                            <h2 class="text-2xl font-bold text-white text-center mb-4">Create Account</h2>
                            <div class="progress-bar" id="register-progress-bar">
                                <div class="line"></div>
                                <div class="progress-step active" data-step="1"><i class="fas fa-user-circle"></i></div>
                                <div class="progress-step" data-step="2"><i class="fas fa-shield-alt"></i></div>
                                <div class="progress-step" data-step="3"><i class="fas fa-fist-raised"></i></div>
                                <div class="progress-step" data-step="4"><i class="fas fa-camera"></i></div>
                            </div>
                            <form id="register-form">
                                <div class="form-slide active" data-slide="1"><p class="text-center text-gray-400 mb-6">Step 1: Your Account Details</p><div class="space-y-4">
                                    <div class="input-group"><i class="fas fa-user input-icon"></i><input type="text" id="register-username" placeholder="Username" class="form-input" required></div>
                                    <div class="input-group"><i class="fas fa-envelope input-icon"></i><input type="email" id="register-email" placeholder="Email" class="form-input" required></div>
                                    <div class="input-group"><i class="fas fa-lock input-icon"></i><input type="password" id="register-password" placeholder="Password (min. 6 characters)" class="form-input" required></div>
                                    <div class="input-group"><i class="fas fa-check-circle input-icon"></i><input type="password" id="register-password-verify" placeholder="Verify Password" class="form-input" required></div>
                                </div></div>
                                <div class="form-slide" data-slide="2"><p class="text-center text-gray-400 mb-6">Step 2: Alliance Information</p><div class="space-y-4">
                                     <div class="input-group"><i class="fas fa-shield-alt input-icon"></i>
                                        <div class="custom-select-container" data-type="alliance">
                                            <input type="hidden" id="register-alliance" name="alliance" required>
                                            <button type="button" class="custom-select-value form-input"><span>Select Alliance</span><i class="fas fa-chevron-down text-xs"></i></button>
                                            <div class="custom-select-options">
                                                <input type="text" class="custom-select-search" placeholder="Search alliances...">
                                                <div class="options-list"></div>
                                            </div>
                                        </div>
                                     </div>
                                    <div class="input-group"><i class="fas fa-star input-icon"></i>
                                        <div class="custom-select-container" data-type="rank">
                                            <input type="hidden" id="register-alliance-rank" name="alliance-rank" required>
                                            <button type="button" class="custom-select-value form-input"><span>Select Alliance Rank</span><i class="fas fa-chevron-down text-xs"></i></button>
                                            <div class="custom-select-options">
                                                <div class="options-list"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div></div>
                                <div class="form-slide" data-slide="3"><p class="text-center text-gray-400 mb-6">Step 3: Your Power Stats</p><div class="space-y-4">
                                    <div class="input-group"><i class="fas fa-fist-raised input-icon"></i><input type="text" id="register-power" placeholder="Total Power (e.g., 150,000,000)" class="power-input form-input" required></div>
                                    <div class="input-group"><i class="fas fa-truck-monster input-icon"></i><input type="text" id="register-tank-power" placeholder="Tank Power" class="power-input form-input" required></div>
                                    <div class="input-group"><i class="fas fa-fighter-jet input-icon"></i><input type="text" id="register-air-power" placeholder="Air Power" class="power-input form-input" required></div>
                                    <div class="input-group"><i class="fas fa-rocket input-icon"></i><input type="text" id="register-missile-power" placeholder="Missile Power" class="power-input form-input" required></div>
                                </div></div>
                                <div class="form-slide" data-slide="4">
                                    <p class="text-center text-gray-400 mb-6">Step 4: Upload an Avatar (Optional)</p>
                                    <div class="flex flex-col items-center gap-4">
                                        <img id="register-avatar-preview" src="https://placehold.co/128x128/161B22/FFFFFF?text=Avatar" class="w-32 h-32 rounded-full object-cover border-2 border-white/20">
                                        <button type="button" id="register-avatar-btn" class="w-full p-3 rounded-lg secondary-btn">
                                            <i class="fas fa-upload mr-2"></i> Choose Image
                                        </button>
                                        <input type="file" id="register-avatar-input" class="hidden" accept="image/*">
                                    </div>
                                </div>
                                <p id="register-error" class="text-red-400 text-center text-sm mt-4 form-error"></p>
                                <div id="register-nav-container" class="flex items-center mt-6"><button type="button" id="register-back-btn" class="px-6 py-2 rounded-lg secondary-btn flex items-center"><i class="fas fa-arrow-left mr-2"></i>Back</button><div class="flex-grow flex justify-center"><button type="button" id="register-next-btn" class="px-6 py-2 rounded-lg primary-btn flex items-center">Next<i class="fas fa-arrow-right ml-2"></i></button><button type="submit" id="register-submit-btn" class="px-6 py-2 rounded-lg primary-btn hidden flex items-center"><i class="fas fa-check-circle mr-2"></i>Register</button></div></div>
                                <p class="text-center text-sm text-gray-400 mt-6">Already have an account? <a href="#" id="show-login-link" class="font-semibold hover:text-white" style="color: var(--color-primary);">Login here</a></p>
                            </form>
                        </div>
                        <div id="registration-success">
                            <i class="fas fa-check-circle success-icon"></i>
                            <h2 class="text-2xl font-bold text-white mt-4">Registration Complete!</h2>
                            <p class="text-gray-400 mt-2">Welcome to the 899 Hub. You will be logged in shortly.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="edit-profile-modal-container" class="modal-container">
         <div class="glass-pane">
            <div class="modal-content-wrapper">
                <button id="close-edit-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-white transition-colors z-10">
                    <i class="fas fa-times fa-lg"></i>
                </button>
                <div class="modal-content-scroll">
                    <h2 class="text-2xl font-bold text-white text-center mb-6">Edit Your Profile</h2>
                    <form id="edit-profile-form">
                         <div class="space-y-4">
                            <div class="input-group"><i class="fas fa-user input-icon"></i><input type="text" id="edit-username" placeholder="Username" class="form-input" required></div>
                            <div class="input-group"><i class="fas fa-shield-alt input-icon"></i>
                                <div class="custom-select-container w-full" data-type="alliance">
                                    <input type="hidden" id="edit-alliance" name="alliance" required>
                                    <button type="button" class="custom-select-value form-input"><span>Select Alliance</span><i class="fas fa-chevron-down text-xs"></i></button>
                                    <div class="custom-select-options dropdown-pane glass-pane">
                                        <input type="text" class="custom-select-search" placeholder="Search alliances...">
                                        <div class="options-list"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="input-group"><i class="fas fa-star input-icon"></i>
                                 <div class="custom-select-container w-full" data-type="rank">
                                    <input type="hidden" id="edit-alliance-rank" name="alliance-rank" required>
                                    <button type="button" class="custom-select-value form-input"><span>Select Alliance Rank</span><i class="fas fa-chevron-down text-xs"></i></button>
                                    <div class="custom-select-options dropdown-pane glass-pane">
                                        <div class="options-list"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="input-group"><i class="fas fa-fist-raised input-icon"></i><input type="text" id="edit-power" placeholder="Total Power" class="power-input form-input" required></div>
                            <div class="input-group"><i class="fas fa-truck-monster input-icon"></i><input type="text" id="edit-tank-power" placeholder="Tank Power" class="power-input form-input" required></div>
                            <div class="input-group"><i class="fas fa-fighter-jet input-icon"></i><input type="text" id="edit-air-power" placeholder="Air Power" class="power-input form-input" required></div>
                            <div class="input-group"><i class="fas fa-rocket input-icon"></i><input type="text" id="edit-missile-power" placeholder="Missile Power" class="power-input form-input" required></div>
                        </div>
                        <p id="edit-profile-error" class="text-red-400 text-center text-sm mt-4 form-error"></p>
                        <button type="submit" class="w-full p-3 rounded-lg primary-btn mt-6">Save Changes</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Player Settings Modal -->
    <div id="player-settings-modal-container" class="modal-container">
         <div class="glass-pane">
            <div class="modal-content-wrapper">
                <button id="close-player-settings-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-white transition-colors z-10">
                    <i class="fas fa-times fa-lg"></i>
                </button>
                <div class="modal-content-scroll">
                    <h2 class="text-2xl font-bold text-white text-center mb-2">Player Settings</h2>
                    <p id="player-settings-username" class="text-center text-gray-400 mb-6"></p>
                    <form id="player-settings-form">
                         <div class="space-y-4">
                            <div class="input-group"><i class="fas fa-star input-icon"></i>
                                 <div class="custom-select-container w-full" data-type="rank">
                                    <input type="hidden" id="setting-alliance-rank" name="alliance-rank" required>
                                    <button type="button" class="custom-select-value form-input"><span>Select Alliance Rank</span><i class="fas fa-chevron-down text-xs"></i></button>
                                    <div class="custom-select-options">
                                        <div class="options-list"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="input-group"><i class="fas fa-user-tag input-icon"></i>
                                 <div class="custom-select-container w-full" data-type="role">
                                    <input type="hidden" id="setting-alliance-role" name="alliance-role">
                                    <button type="button" class="custom-select-value form-input"><span>Select Alliance Role</span><i class="fas fa-chevron-down text-xs"></i></button>
                                    <div class="custom-select-options">
                                        <div class="options-list"></div>
                                    </div>
                                </div>
                            </div>
                            <div id="verification-toggle-container" class="flex items-center justify-between bg-gray-900/50 p-3 rounded-lg">
                                <label for="setting-verified" class="font-semibold text-white">Verified Status</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="setting-verified">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                        <p id="player-settings-error" class="text-red-400 text-center text-sm mt-4 form-error"></p>
                        <button type="submit" class="w-full p-3 rounded-lg primary-btn mt-6">Save Settings</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Post Modal -->
    <div id="create-post-modal-container" class="modal-container">
         <div class="glass-pane">
            <div class="modal-content-wrapper">
                <button id="close-create-post-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-white transition-colors z-10">
                    <i class="fas fa-times fa-lg"></i>
                </button>
                <div class="modal-content-scroll">
                    <form id="create-post-form">
                        <div id="post-creation-flow">
                             <!-- Slide 1: Main Type (Event vs Announcement) -->
                            <div class="form-slide" data-slide="1">
                                <h2 class="text-2xl font-bold text-white text-center mb-4">Create New Post</h2>
                                <p class="text-center text-gray-400 mb-6">What would you like to create?</p>
                                <div id="post-main-type-selection-container" class="space-y-4">
                                   <!-- Dynamically inserted buttons for Event/Announcement -->
                                </div>
                            </div>
                            <!-- Slide 2: Sub-Type Selection -->
                            <div class="form-slide" data-slide="2">
                                <h2 id="post-subtype-header" class="text-2xl font-bold text-white text-center mb-4"></h2>
                                <p class="text-center text-gray-400 mb-6">Select a category.</p>
                                <div id="post-subtype-selection-container" class="space-y-3">
                                   <!-- Dynamically inserted sub-type buttons -->
                                </div>
                            </div>
                            <!-- Slide 3: Content -->
                            <div class="form-slide" data-slide="3">
                                <h2 id="post-content-header" class="text-2xl font-bold text-white text-center mb-4"></h2>
                                <p class="text-center text-gray-400 mb-6">Provide the details for your post.</p>
                                <div class="space-y-4">
                                    <div id="post-alliance-group" class="input-group hidden"><i class="fas fa-shield-alt input-icon"></i>
                                         <div class="custom-select-container w-full" data-type="alliance">
                                            <input type="hidden" id="post-alliance" name="post-alliance">
                                            <button type="button" class="custom-select-value form-input"><span>Select Alliance</span><i class="fas fa-chevron-down text-xs"></i></button>
                                            <div class="custom-select-options">
                                                <input type="text" class="custom-select-search" placeholder="Search alliances...">
                                                <div class="options-list"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="input-group"><i class="fas fa-heading input-icon"></i><input type="text" id="post-title" placeholder="Title" class="form-input" required></div>
                                    <div class="input-group !items-start"><i class="fas fa-align-left input-icon pt-3"></i><textarea id="post-details" placeholder="Details..." class="form-textarea" required></textarea></div>
                                    <div>
                                        <p class="text-sm text-gray-400 mb-2">Thumbnail (Optional)</p>
                                        <div class="flex items-center gap-4">
                                            <img id="post-thumbnail-preview" src="https://placehold.co/100x100/161B22/444444?text=PREVIEW" class="w-24 h-24 rounded-lg object-cover border-2 border-white/20">
                                            <button type="button" id="post-thumbnail-btn" class="flex-grow p-3 rounded-lg secondary-btn">
                                                <i class="fas fa-upload mr-2"></i> Choose Image
                                            </button>
                                            <input type="file" id="post-thumbnail-input" class="hidden" accept="image/*">
                                        </div>
                                    </div>
                                </div>
                            </div>
                             <!-- Slide 4: Timing (for events) -->
                            <div class="form-slide" data-slide="4">
                                <h2 class="text-2xl font-bold text-white text-center mb-4">Event Schedule</h2>
                                <p class="text-center text-gray-400 mb-6">Set the schedule for your event.</p>
                                <div id="post-timing-group" class="space-y-4">
                                     <div>
                                        <label class="text-sm font-semibold text-gray-400 mb-1 block">Start Time</label>
                                        <div class="flex gap-2">
                                            <div class="input-group w-1/2"><i class="fas fa-calendar-day input-icon"></i>
                                                <div class="custom-select-container" data-type="day-of-week">
                                                    <input type="hidden" id="post-start-day" required><button type="button" class="custom-select-value form-input"><span>Day</span><i class="fas fa-chevron-down text-xs"></i></button><div class="custom-select-options"><div class="options-list"></div></div>
                                                </div>
                                            </div>
                                            <div class="input-group w-1/2"><i class="fas fa-clock input-icon"></i>
                                                <div class="custom-select-container" data-type="hour-of-day">
                                                    <input type="hidden" id="post-start-hour" required><button type="button" class="custom-select-value form-input"><span>Hour</span><i class="fas fa-chevron-down text-xs"></i></button><div class="custom-select-options"><div class="options-list"></div></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-sm font-semibold text-gray-400 mb-1 block">End Time</label>
                                        <div class="flex gap-2">
                                             <div class="input-group w-1/2"><i class="fas fa-calendar-day input-icon"></i>
                                                <div class="custom-select-container" data-type="day-of-week">
                                                    <input type="hidden" id="post-end-day" required><button type="button" class="custom-select-value form-input"><span>Day</span><i class="fas fa-chevron-down text-xs"></i></button><div class="custom-select-options"><div class="options-list"></div></div>
                                                </div>
                                            </div>
                                            <div class="input-group w-1/2"><i class="fas fa-clock input-icon"></i>
                                                <div class="custom-select-container" data-type="hour-of-day">
                                                    <input type="hidden" id="post-end-hour" required><button type="button" class="custom-select-value form-input"><span>Hour</span><i class="fas fa-chevron-down text-xs"></i></button><div class="custom-select-options"><div class="options-list"></div></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                     <div>
                                        <label class="text-sm font-semibold text-gray-400 mb-1 block">Repetition</label>
                                        <div class="flex gap-2">
                                             <div class="input-group w-1/2"><i class="fas fa-redo-alt input-icon"></i>
                                                <div class="custom-select-container" data-type="repeat-type">
                                                    <input type="hidden" id="post-repeat-type" value="none" required><button type="button" class="custom-select-value form-input"><span>None</span><i class="fas fa-chevron-down text-xs"></i></button><div class="custom-select-options"><div class="options-list"></div></div>
                                                </div>
                                            </div>
                                            <div id="post-repeat-weeks-container" class="input-group w-1/2 hidden"><i class="fas fa-hashtag input-icon"></i>
                                                <input type="number" id="post-repeat-weeks" class="form-input" min="1" value="1" placeholder="Weeks">
                                            </div>
                                        </div>
                                    </div>
                                    <p class="text-xs text-center text-gray-400">Times are based on your local timezone.</p>
                                </div>
                            </div>
                        </div>
                        <p id="create-post-error" class="text-red-400 text-center text-sm mt-4 form-error"></p>
                         <div id="post-nav-container" class="flex items-center mt-6">
                            <button type="button" id="post-back-btn" class="px-6 py-2 rounded-lg secondary-btn flex items-center"><i class="fas fa-arrow-left mr-2"></i>Back</button>
                            <div class="flex-grow flex justify-center">
                                <button type="button" id="post-next-btn" class="px-6 py-2 rounded-lg primary-btn flex items-center">Next<i class="fas fa-arrow-right ml-2"></i></button>
                                <button type="submit" id="post-submit-btn" class="px-6 py-2 rounded-lg primary-btn hidden flex items-center"><i class="fas fa-check-circle mr-2"></i>Create Post</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal-container" class="modal-container">
        <div class="glass-pane">
            <div class="modal-content-wrapper p-6 text-center">
                <h2 id="confirmation-title" class="text-2xl font-bold text-white mb-4">Confirm Action</h2>
                <p id="confirmation-message" class="text-gray-300 mb-6">Are you sure?</p>
                <div class="flex justify-center gap-4">
                    <button id="confirmation-cancel-btn" class="w-full p-3 rounded-lg secondary-btn">Cancel</button>
                    <button id="confirmation-confirm-btn" class="w-full p-3 rounded-lg primary-btn bg-red-600 hover:bg-red-700 !shadow-red-500/30">Confirm</button>
                </div>
            </div>
        </div>
    </div>


    <div class="relative min-h-screen w-full p-4 sm:p-6 lg:p-8">
        <div class="max-w-6xl mx-auto">

            <header class="glass-pane header-main flex justify-between items-center mb-6">
                <div class="flex-shrink-0">
                    <h1 class="text-2xl md:text-3xl font-black tracking-tighter text-white" style="text-shadow: 0 0 10px var(--color-primary-glow);">899<span class="font-bold" style="color: var(--color-primary);">EVENTS</span></h1>
                    <p class="text-xs text-gray-400">Official Event Hub</p>
                </div>
                
                <nav id="main-nav" class="hidden md:flex flex-grow justify-center items-center">
                    <div class="nav-item"><div class="nav-link"><i class="fas fa-shield-alt"></i><span>Alliances</span></div><div class="dropdown-menu dropdown-pane glass-pane"><a class="dropdown-link" data-target="page-top-alliances">Top Alliances</a><a class="dropdown-link" data-target="page-alliance-list">Alliance List</a><a class="dropdown-link" data-target="page-recruitment">Recruitment</a></div></div>
                    <div class="nav-item"><div class="nav-link" data-main-target="page-players"><i class="fas fa-users"></i><span>Players</span></div></div>
                    <div class="nav-item"><div class="nav-link active" data-main-target="page-events"><i class="fas fa-calendar-alt"></i><span>Events</span></div></div>
                    <div class="nav-item"><div class="nav-link"><i class="fas fa-trophy"></i><span>Season</span></div><div class="dropdown-menu dropdown-pane glass-pane"><a class="dropdown-link" data-target="page-season-overview">Season Overview</a><a class="dropdown-link" data-target="page-season-rewards">Rewards</a><a class="dropdown-link" data-target="page-season-history">History</a></div></div>
                    <div class="nav-item"><div class="nav-link"><i class="fas fa-tools"></i><span>Tools</span></div><div class="dropdown-menu dropdown-pane glass-pane"><a class="dropdown-link" data-target="page-calculators">Calculators</a><a class="dropdown-link" data-target="page-guides">Guides</a></div></div>
                    <div class="nav-item"><div class="nav-link"><i class="fas fa-globe"></i><span>Language</span></div><div class="dropdown-menu dropdown-pane glass-pane"><a href="#" class="dropdown-link">English</a><a href="#" class="dropdown-link">Espaol</a><a href="#" class="dropdown-link">Deutsch</a></div></div>
                </nav>

                <div id="auth-container" class="hidden md:flex flex-shrink-0 relative">
                    <button id="login-btn" class="auth-button"><i class="fas fa-sign-in-alt fa-fw mr-2"></i>Login</button>
                    <div id="user-profile-container" class="hidden">
                        <button id="player-card-btn" class="auth-button">
                             <img id="user-avatar-button" src="https://placehold.co/48x48/161B22/FFFFFF?text=?" class="w-6 h-6 rounded-full mr-2 object-cover" alt="User Avatar">
                            <span id="username-display"></span>
                            <i class="fas fa-caret-down ml-2"></i>
                        </button>
                        <div id="player-card-dropdown" class="dropdown-pane glass-pane">
                            <div id="player-card-info" class="p-2 mb-2 border-b border-white/10"></div>
                            <button id="upload-avatar-btn" class="dropdown-link"><i class="fas fa-camera w-6 text-center mr-2"></i>Change Avatar</button>
                            <input type="file" id="avatar-upload-input" class="hidden" accept="image/*">
                            <button id="edit-profile-btn" class="dropdown-link"><i class="fas fa-edit w-6 text-center mr-2"></i>Edit Profile</button>
                            <button id="logout-btn" class="dropdown-link"><i class="fas fa-sign-out-alt w-6 text-center mr-2"></i>Logout</button>
                        </div>
                    </div>
                </div>
                <button id="open-mobile-menu-btn" class="md:hidden text-white"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg></button>
            </header>

            <!-- Page Content Container -->
            <div id="page-container">
                <!-- Players Page -->
                <div id="page-players" class="page-content" style="display: none;">
                    <div class="glass-pane section-container">
                        <div class="text-center mb-8">
                            <h2 class="text-3xl font-bold text-white tracking-wider" style="text-shadow: 0 0 10px var(--color-primary);">PLAYERS OF 899</h2>
                            <div class="themed-line-break mx-auto mt-2"></div>
                        </div>

                        <div class="flex flex-col md:flex-row gap-4 mb-6">
                            <div class="input-group flex-grow">
                                <i class="fas fa-search input-icon"></i>
                                <input type="text" id="player-search-input" placeholder="Search by player name..." class="form-input">
                            </div>
                            <div class="input-group md:max-w-xs">
                                <i class="fas fa-shield-alt input-icon"></i>
                                <div class="custom-select-container" data-type="alliance-filter">
                                    <input type="hidden" id="alliance-filter" name="alliance-filter">
                                    <button type="button" class="custom-select-value form-input"><span>All Alliances</span><i class="fas fa-chevron-down text-xs"></i></button>
                                    <div class="custom-select-options">
                                        <div class="options-list"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="player-list-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                             <!-- Player cards will be inserted here -->
                        </div>
                    </div>
                </div>
                <!-- Events Page -->
                <div id="page-events" class="page-content">
                    <main class="space-y-8" id="events-main-container">
                        <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4">
                            <h2 class="text-3xl font-bold text-white hidden">Events & Announcements</h2>
                            <div class="flex items-center gap-2 ml-auto">
                                <button id="open-mobile-filter-btn" class="md:hidden secondary-btn px-4 py-2 rounded-lg flex items-center gap-2">
                                    <i class="fas fa-filter"></i> Filter
                                </button>
                                <button id="create-post-btn" class="primary-btn px-4 py-2 rounded-lg hidden flex items-center gap-2">
                                    <i class="fas fa-plus-circle"></i> Create
                                </button>
                            </div>
                        </div>
                        <div class="themed-divider hidden"></div>

                        <div id="announcements-container" class="space-y-4">
                            <!-- New announcement cards will be rendered here -->
                        </div>

                        <div id="events-section-container" class="space-y-4">
                            <!-- Event group headers and lists will be rendered here -->
                        </div>

                    </main>
                </div>
                <!-- Top Alliances Page -->
                <div id="page-top-alliances" class="page-content" style="display: none;">
                    <div class="glass-pane section-container">
                        <h2 class="text-3xl font-bold text-white text-center mb-8">Top Alliances</h2>
                        <div id="podium-container" class="flex flex-col md:flex-row items-end justify-center gap-4">
                            <!-- 2nd Place -->
                            <div class="w-full md:w-1/4 order-2 md:order-1">
                                <div id="silver-podium" class="glass-pane podium-card podium-silver h-full">
                                    <!-- Silver/2nd place content will be populated here -->
                                </div>
                            </div>
                            <!-- 1st Place -->
                            <div class="w-full md:w-1/3 order-1 md:order-2">
                                <div id="gold-podium" class="glass-pane podium-card podium-gold h-full">
                                    <!-- Gold/1st place content will be populated here -->
                                </div>
                            </div>
                            <!-- 3rd Place -->
                            <div class="w-full md:w-1/4 order-3 md:order-3">
                                <div id="bronze-podium" class="glass-pane podium-card podium-bronze h-full">
                                    <!-- Bronze/3rd place content will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Other Pages -->
                <div id="page-alliance-list" class="page-content" style="display: none;"><div class="glass-pane section-container"><h2 class="text-2xl font-bold text-white">Alliance List</h2></div></div>
                <div id="page-recruitment" class="page-content" style="display: none;"><div class="glass-pane section-container"><h2 class="text-2xl font-bold text-white">Recruitment</h2></div></div>
                <div id="page-season-overview" class="page-content" style="display: none;"><div class="glass-pane section-container"><h2 class="text-2xl font-bold text-white">Season Overview</h2></div></div>
                <div id="page-season-rewards" class="page-content" style="display: none;"><div class="glass-pane section-container"><h2 class="text-2xl font-bold text-white">Season Rewards</h2></div></div>
                <div id="page-season-history" class="page-content" style="display: none;"><div class="glass-pane section-container"><h2 class="text-2xl font-bold text-white">Season History</h2></div></div>
                <div id="page-calculators" class="page-content" style="display: none;"><div class="glass-pane section-container"><h2 class="text-2xl font-bold text-white">Calculators</h2></div></div>
                <div id="page-guides" class="page-content" style="display: none;"><div class="glass-pane section-container"><h2 class="text-2xl font-bold text-white">Guides</h2></div></div>

            </div>

            <footer class="text-center mt-12 py-4 border-t border-gray-800/50"><p class="text-gray-500">&copy; 2024 Last War Survival - Server 899 Community.</p></footer>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, query, updateDoc, addDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA8KKDjjw0Pb_wknZ3TRWuL7-7XMo4VeY0",
            authDomain: "events-ea397.firebaseapp.com",
            projectId: "events-ea397",
            storageBucket: "events-ea397.firebasestorage.app",
            messagingSenderId: "51859633788",
            appId: "1:51859633788:web:3653d3e7edb6d3c1c4fbf9",
            measurementId: "G-0ZCMZ86PJD"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        let currentUserData = null;
        let allPlayers = []; // Cache for player data
        let allPosts = []; // Cache for post data
        
        const ALLIANCES = ["THOR", "fAfO", "HeRA", "pHNx", "TroW", "VaLT", "COLD", "Tone", "DoM", "MINI", "MEGA", "Lat1", "WSKT", "ValT", "BRSL", "TCM1", "BLSD", "REI", "wpg1", "SHRK"];
        const ALLIANCE_RANKS = [
            { value: 'R5', text: 'R5 (Leader)'}, { value: 'R4', text: 'R4'}, { value: 'R3', text: 'R3'},
            { value: 'R2', text: 'R2'}, { value: 'R1', text: 'R1 (Member)'},
        ];
        const ALLIANCE_ROLES = [
            { value: '', text: 'None'}, { value: 'Warlord', text: 'Warlord'}, { value: 'Recruiter', text: 'Recruiter'},
            { value: 'Muse', text: 'Muse'}, { value: 'Butler', text: 'Butler'},
        ];
        const DAYS_OF_WEEK = [
            { value: '0', text: 'Sunday' }, { value: '1', text: 'Monday' }, { value: '2', text: 'Tuesday' },
            { value: '3', text: 'Wednesday' }, { value: '4', text: 'Thursday' }, { value: '5', text: 'Friday' },
            { value: '6', text: 'Saturday' }
        ];
        const HOURS_OF_DAY = Array.from({ length: 24 }, (_, i) => ({
            value: i.toString(),
            text: `${i.toString().padStart(2, '0')}:00`
        }));
        const REPEAT_TYPES = [
            { value: 'none', text: 'None' },
            { value: 'weekly', text: 'Weekly' }
        ];
        
        const POST_TYPES = {
            // Announcements
            server_announcement: { mainType: 'announcement', subType: 'server', text: 'Server Announcement', isAdminOnly: true, visibility: 'public' },
            leadership_announcement: { mainType: 'announcement', subType: 'leadership', text: 'Leadership Announcement', allowedRanks: ['R5'], visibility: 'public' },
            alliance_announcement: { mainType: 'announcement', subType: 'alliance', text: 'Alliance Announcement', allowedRanks: ['R5', 'R4'], visibility: 'alliance' },
            // Events
            alliance_event: { mainType: 'event', subType: 'alliance', text: 'Alliance Event', allowedRanks: ['R5', 'R4'], isVerifiedRequired: true, visibility: 'alliance' },
            server_event: { mainType: 'event', subType: 'server', text: 'Server Event', isAdminOnly: true, visibility: 'public' },
            seasonal_event: { mainType: 'event', subType: 'seasonal', text: 'Seasonal Event', isAdminOnly: true, visibility: 'public' },
            hot_deals: { mainType: 'event', subType: 'hot_deals', text: 'Hot Deals Event', isAdminOnly: true, visibility: 'public' },
            wanted_boss: { mainType: 'event', subType: 'wanted_boss', text: 'Wanted Boss Event', isAdminOnly: true, visibility: 'public' },
            campaign: { mainType: 'event', subType: 'campaign', text: 'Campaign Event', isAdminOnly: true, visibility: 'public' },
            vs: { mainType: 'event', subType: 'vs', text: 'VS Event', isAdminOnly: true, visibility: 'public' },
        };

        const POST_STYLES = {
            server: { color: 'var(--post-color-server)', icon: 'fas fa-server', bgColor: 'rgba(255, 215, 0, 0.1)'},
            seasonal: { color: 'var(--post-color-seasonal)', icon: 'fas fa-snowflake', bgColor: 'rgba(147, 112, 219, 0.1)'},
            leadership: { color: 'var(--post-color-leadership)', icon: 'fas fa-crown', bgColor: 'rgba(192, 192, 192, 0.1)'},
            alliance: { color: 'var(--post-color-alliance)', icon: 'fas fa-shield-alt', bgColor: 'rgba(0, 191, 255, 0.1)'},
            hot_deals: { color: 'var(--post-color-hot_deals)', icon: 'fas fa-fire-alt', bgColor: 'rgba(255, 99, 71, 0.1)'},
            wanted_boss: { color: 'var(--post-color-wanted_boss)', icon: 'fas fa-skull-crossbones', bgColor: 'rgba(220, 20, 60, 0.1)'},
            campaign: { color: 'var(--post-color-campaign)', icon: 'fas fa-map-marked-alt', bgColor: 'rgba(50, 205, 50, 0.1)'},
            vs: { color: 'var(--post-color-vs)', icon: 'fas fa-fist-raised', bgColor: 'rgba(255, 165, 0, 0.1)'},
        };


        // --- DOM ELEMENTS ---
        const modalBackdrop = document.getElementById('modal-backdrop');
        const authModalContainer = document.getElementById('auth-modal-container');
        const editProfileModalContainer = document.getElementById('edit-profile-modal-container');
        const playerSettingsModalContainer = document.getElementById('player-settings-modal-container');
        const createPostModalContainer = document.getElementById('create-post-modal-container');
        const confirmationModalContainer = document.getElementById('confirmation-modal-container');
        
        const loginFormContainer = document.getElementById('login-form-container');
        const registerFormContainer = document.getElementById('register-form-container');
        const loginBtn = document.getElementById('login-btn');
        const userProfileContainer = document.getElementById('user-profile-container');
        const usernameDisplay = document.getElementById('username-display');
        const playerListContainer = document.getElementById('player-list-container');
        const playerCardBtn = document.getElementById('player-card-btn');
        const playerCardDropdown = document.getElementById('player-card-dropdown');
        const playerCardInfo = document.getElementById('player-card-info');
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const mobileNavMenu = document.getElementById('mobile-nav-menu');
        const mobileNavLinksContainer = document.getElementById('mobile-nav-links');
        const playerSearchInput = document.getElementById('player-search-input');
        const allianceFilterInput = document.getElementById('alliance-filter');
        const createPostBtn = document.getElementById('create-post-btn');
        const announcementsContainer = document.getElementById('announcements-container');
        const eventsSectionContainer = document.getElementById('events-section-container');
        const userAvatarButton = document.getElementById('user-avatar-button');
        const uploadAvatarBtn = document.getElementById('upload-avatar-btn');
        const avatarUploadInput = document.getElementById('avatar-upload-input');
        const verificationToggleContainer = document.getElementById('verification-toggle-container');
        const filterLegendContainer = document.getElementById('filter-legend-container');
        const mobileFilterPanel = document.getElementById('mobile-filter-panel');
        const mobileFilterLegendContainer = document.getElementById('mobile-filter-legend');
        const eventsMainContainer = document.getElementById('events-main-container');


        let activePlayerSettingsUID = null;
        let postCreationData = {}; // Object to hold data across slides
        let resizedThumbnailBlob = null;
        let activeFilters = new Set(Object.keys(POST_STYLES));
        let countdownInterval = null;
        let editingPostId = null;
        
        // --- UTILITY FUNCTIONS ---
        function formatTimeAgo(date) {
            if (!date) return '';
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);

            let interval = seconds / 31536000;
            if (interval > 1) return `${Math.floor(interval)}y ago`;
            interval = seconds / 2592000;
            if (interval > 1) return `${Math.floor(interval)}mo ago`;
            interval = seconds / 86400;
            if (interval > 1) return `${Math.floor(interval)}d ago`;
            interval = seconds / 3600;
            if (interval > 1) return `${Math.floor(interval)}h ago`;
            interval = seconds / 60;
            if (interval > 1) return `${Math.floor(interval)}m ago`;
            return `${Math.floor(seconds)}s ago`;
        }

        function formatDuration(ms) {
            if (ms < 0) ms = 0;
            const totalSeconds = Math.floor(ms / 1000);
            const days = Math.floor(totalSeconds / 86400);
            const hours = Math.floor((totalSeconds % 86400) / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            
            let parts = [];
            if (days > 0) parts.push(`${days}d`);
            if (hours > 0) parts.push(`${hours}h`);
            if (minutes > 0) parts.push(`${minutes}m`);
            
            return parts.slice(0, 2).join(' ') || '<1m';
        }

        function updateCountdowns() {
            const now = new Date();
            document.querySelectorAll('.event-card').forEach(el => {
                const startTimeAttr = el.dataset.startTime;
                if (!startTimeAttr || startTimeAttr === 'undefined') return;

                const endTimeAttr = el.dataset.endTime;
                const isRecurring = el.dataset.isRecurring === 'true';
                
                let startTime = new Date(startTimeAttr);
                const endTime = (endTimeAttr && endTimeAttr !== 'null' && endTimeAttr !== 'undefined') ? new Date(endTimeAttr) : null;

                const statusEl = el.querySelector('.card-footer-status');
                el.classList.remove('live', 'ended', 'upcoming');

                if (isRecurring) {
                    statusEl.innerHTML = `<div class="status-label" style="color: var(--glow-color)">RECURRING</div><div class="status-time">Weekly Event</div>`;
                     el.classList.add('live'); // Make recurring always appear 'live' visually
                    return;
                }

                const diffToStart = startTime - now;
                const diffToEnd = endTime ? endTime - now : null;

                if (diffToStart > 0) {
                    el.classList.add('upcoming');
                    statusEl.innerHTML = `<div class="status-label">STARTS IN</div><div class="status-time">${formatDuration(diffToStart)}</div>`;
                } else if (diffToEnd !== null && diffToEnd > 0) {
                    el.classList.add('live');
                    statusEl.innerHTML = `<div class="status-label">ENDS IN</div><div class="status-time">${formatDuration(diffToEnd)}</div>`;
                } else {
                    el.classList.add('ended');
                    const endedDate = endTime || startTime;
                    statusEl.innerHTML = `<div class="status-label">ENDED</div><div class="status-time">${endedDate.toLocaleDateString([], { month: 'short', day: 'numeric' })}</div>`;
                }
            });
        }

        // --- UNSUBSCRIBE FUNCTIONS FOR LISTENERS ---
        let userDocListener = null;
        let usersListener = null;
        let postsListener = null;

        // --- MODAL & FORM SWITCHING LOGIC ---
        function showModal(modal) {
            hideAllModals();
            modalBackdrop.classList.add('visible');
            modal.classList.add('visible');
        }

        function showAuthModal(formToShow) {
            showModal(authModalContainer);
            document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));
            if (formToShow === 'register') {
                registerFormContainer.classList.add('active');
                initializeRegistrationStepper();
            } else {
                loginFormContainer.classList.add('active');
            }
        }
        
        function showEditProfileModal() { showModal(editProfileModalContainer); populateEditForm(); }
        function showPlayerSettingsModal(player) { activePlayerSettingsUID = player.uid; showModal(playerSettingsModalContainer); populatePlayerSettingsForm(player); }
        
        function showCreatePostModal() { 
            editingPostId = null;
            document.getElementById('create-post-form').reset();
            document.getElementById('post-nav-container').style.display = 'flex';
            showModal(createPostModalContainer); 
            initializePostStepper();
            document.getElementById('post-content-header').textContent = 'Create New Post';
            document.getElementById('post-submit-btn').innerHTML = '<i class="fas fa-check-circle mr-2"></i>Create Post';
        }

        function showConfirmationModal(title, message, onConfirm) {
            document.getElementById('confirmation-title').textContent = title;
            document.getElementById('confirmation-message').textContent = message;
            
            const confirmBtn = document.getElementById('confirmation-confirm-btn');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            newConfirmBtn.addEventListener('click', () => {
                onConfirm();
                hideAllModals();
            });
            
            showModal(confirmationModalContainer);
        }

        function hideAllModals() {
            modalBackdrop.classList.remove('visible');
            authModalContainer.classList.remove('visible');
            editProfileModalContainer.classList.remove('visible');
            playerSettingsModalContainer.classList.remove('visible');
            createPostModalContainer.classList.remove('visible');
            confirmationModalContainer.classList.remove('visible');
            activePlayerSettingsUID = null;
            editingPostId = null;
        }
        
        loginBtn.addEventListener('click', () => showAuthModal('login'));
        document.getElementById('close-auth-modal-btn').addEventListener('click', hideAllModals);
        document.getElementById('close-edit-modal-btn').addEventListener('click', hideAllModals);
        document.getElementById('close-player-settings-modal-btn').addEventListener('click', hideAllModals);
        document.getElementById('close-create-post-modal-btn').addEventListener('click', hideAllModals);
        document.getElementById('confirmation-cancel-btn').addEventListener('click', hideAllModals);

        createPostBtn.addEventListener('click', showCreatePostModal);

        modalBackdrop.addEventListener('click', (e) => {
            if (e.target === modalBackdrop) {
                hideAllModals();
                mobileNavMenu.classList.remove('open');
                mobileFilterPanel.classList.remove('open');
            }
        });

        document.getElementById('show-register-link').addEventListener('click', (e) => { e.preventDefault(); showAuthModal('register'); });
        document.getElementById('show-login-link').addEventListener('click', (e) => { e.preventDefault(); showAuthModal('login'); });

        // --- AUTHENTICATION STATE & LOGIC ---
        onAuthStateChanged(auth, (user) => {
            // Detach all listeners to prevent memory leaks on user change
            if (userDocListener) userDocListener();
            if (usersListener) usersListener();
            if (postsListener) postsListener();
            if (countdownInterval) clearInterval(countdownInterval);

            if (user) {
                // Attach a real-time listener to the logged-in user's document
                userDocListener = onSnapshot(doc(db, "users", user.uid), (userDoc) => {
                    if (userDoc.exists()) {
                        currentUserData = { uid: user.uid, ...userDoc.data() };
                        updateUIForLoggedInUser();
                    }
                });

                // Attach listeners for collections now that we are authenticated
                usersListener = onSnapshot(query(collection(db, 'users')), (querySnapshot) => {
                    allPlayers = [];
                    querySnapshot.forEach((doc) => { allPlayers.push({uid: doc.id, ...doc.data()}); });
                    applyPlayerFilters();
                    updateTopAlliancesPodium(allPlayers);
                }, (error) => console.error("Error with users listener:", error));

                postsListener = onSnapshot(query(collection(db, 'posts')), (querySnapshot) => {
                    allPosts = [];
                    querySnapshot.forEach((doc) => allPosts.push({ id: doc.id, ...doc.data() }));
                    renderPosts(allPosts);
                }, (error) => console.error("Error with posts listener:", error));

                hideAllModals();

            } else {
                // User is signed out
                currentUserData = null;
                allPlayers = [];
                allPosts = [];
                updateUIForLoggedOutUser();
            }
            buildMobileNav(); // Rebuild mobile nav to show correct auth state
        });
        
        function updateUIForLoggedInUser() {
            if (!currentUserData) return;
            usernameDisplay.textContent = currentUserData.username;
            updateAvatarDisplay(currentUserData);
            updatePlayerCard(currentUserData);

            const canCreateAnyPost = Object.values(POST_TYPES).some(type => {
                if (type.isAdminOnly) return currentUserData.isAdmin;
                if (type.isVerifiedRequired && !currentUserData.isVerified) return false;
                if (type.allowedRanks) return type.allowedRanks.includes(currentUserData.allianceRank);
                return false;
            });
            
            if (canCreateAnyPost) {
                createPostBtn.classList.remove('hidden');
            } else {
                createPostBtn.classList.add('hidden');
            }

            loginBtn.classList.add('hidden');
            userProfileContainer.classList.remove('hidden');
        }

        function updateUIForLoggedOutUser() {
            loginBtn.classList.remove('hidden');
            userProfileContainer.classList.add('hidden');
            userProfileContainer.classList.remove('open');
            createPostBtn.classList.add('hidden');
            // Clear UI content
            renderPosts([]);
            renderPlayers([]);
        }

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorElement = document.getElementById('login-error');
            const submitBtn = document.getElementById('login-submit-btn');
            errorElement.textContent = '';
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Logging In...';

            signInWithEmailAndPassword(auth, email, password).catch((error) => {
                console.error("Login Error:", error);
                errorElement.textContent = (error.code === 'auth/invalid-credential') 
                    ? "Invalid email or password." 
                    : "An unknown error occurred.";
            }).finally(() => {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Login';
            });
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth).catch(error => console.error("Logout error:", error));
        });

        document.getElementById('forgot-password-link').addEventListener('click', (e) => {
            e.preventDefault();
            const email = prompt("Please enter your email address to receive a password reset link:");
            if (!email) return;

            sendPasswordResetEmail(auth, email)
                .then(() => alert('Password reset email sent! Please check your inbox.'))
                .catch((error) => alert(error.message));
        });
        
        // --- PLAYER CARD, AVATAR & EDIT PROFILE ---
        playerCardBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            userProfileContainer.classList.toggle('open');
        });
        
        editProfileBtn.addEventListener('click', () => {
            userProfileContainer.classList.remove('open');
            showEditProfileModal();
        });

        uploadAvatarBtn.addEventListener('click', () => avatarUploadInput.click());

        avatarUploadInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            const user = auth.currentUser;
            if (!file || !user) return;

            userAvatarButton.style.opacity = '0.5';
            try {
                const resizedBlob = await resizeImage(file, { maxWidth: 1024, maxHeight: 1024 });
                const avatarRef = ref(storage, `avatars/${user.uid}`);
                await uploadBytes(avatarRef, resizedBlob);
                const downloadURL = await getDownloadURL(avatarRef);
                await updateDoc(doc(db, "users", user.uid), { avatarUrl: downloadURL });
            } catch (error) {
                console.error("Avatar upload error:", error);
                alert("Failed to upload avatar. Please try again.");
            } finally {
                userAvatarButton.style.opacity = '1';
            }
        });

        function updateAvatarDisplay(data) {
            const avatarUrl = data.avatarUrl || `https://placehold.co/48x48/0D1117/FFFFFF?text=${data.username.charAt(0).toUpperCase()}`;
            userAvatarButton.src = avatarUrl;
        }

        function updatePlayerCard(data) {
             playerCardInfo.innerHTML = `
                <p class="text-sm text-gray-400">Alliance: <strong class="text-white">[${data.alliance}] ${data.allianceRank}</strong></p>
                <p class="text-sm text-gray-400">Power: <strong class="text-white">${(data.power || 0).toLocaleString()}</strong></p>
             `;
        }
        
        function populateEditForm() {
            if (!currentUserData) return;
            document.getElementById('edit-username').value = currentUserData.username;
            
            const editAllianceSelect = document.getElementById('edit-alliance').closest('.custom-select-container');
            const editRankSelect = document.getElementById('edit-alliance-rank').closest('.custom-select-container');
            
            setCustomSelectValue(editAllianceSelect, currentUserData.alliance);
            const rankData = ALLIANCE_RANKS.find(r => r.value === currentUserData.allianceRank);
            setCustomSelectValue(editRankSelect, currentUserData.allianceRank, rankData ? rankData.text : currentUserData.allianceRank);
            
            document.getElementById('edit-power').value = (currentUserData.power || 0).toLocaleString();
            document.getElementById('edit-tank-power').value = (currentUserData.tankPower || 0).toLocaleString();
            document.getElementById('edit-air-power').value = (currentUserData.airPower || 0).toLocaleString();
            document.getElementById('edit-missile-power').value = (currentUserData.missilePower || 0).toLocaleString();
        }

        document.getElementById('edit-profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;
            
            const errorElement = document.getElementById('edit-profile-error');
            errorElement.textContent = '';
            
            const parsePower = (str) => parseInt(String(str).replace(/,/g, ''), 10) || 0;

            const updatedData = {
                username: document.getElementById('edit-username').value,
                alliance: document.getElementById('edit-alliance').value,
                allianceRank: document.getElementById('edit-alliance-rank').value,
                power: parsePower(document.getElementById('edit-power').value),
                tankPower: parsePower(document.getElementById('edit-tank-power').value),
                airPower: parsePower(document.getElementById('edit-air-power').value),
                missilePower: parsePower(document.getElementById('edit-missile-power').value),
            };

            if (currentUserData && updatedData.alliance !== currentUserData.alliance) {
                updatedData.isVerified = false;
            }

            try {
                await updateDoc(doc(db, "users", user.uid), updatedData);
                hideAllModals();
            } catch (error) {
                console.error("Update profile error:", error);
                errorElement.textContent = "Failed to update profile.";
            }
        });


        // --- REGISTRATION STEPPER LOGIC ---
        let currentRegStep = 1;
        let resizedAvatarBlob = null;
        const registrationFlow = document.getElementById('registration-flow');
        const registrationSuccess = document.getElementById('registration-success');
        const regFormSlides = registrationFlow.querySelectorAll('.form-slide');
        const regProgressSteps = registrationFlow.querySelectorAll('.progress-step');
        const regProgressBarLine = registrationFlow.querySelector('.progress-bar .line');
        const regBackBtn = document.getElementById('register-back-btn');
        const regNextBtn = document.getElementById('register-next-btn');
        const regSubmitBtn = document.getElementById('register-submit-btn');
        const registerError = document.getElementById('register-error');

        function initializeRegistrationStepper() { 
            currentRegStep = 1; 
            resizedAvatarBlob = null;
            document.getElementById('register-avatar-preview').src = 'https://placehold.co/128x128/161B22/FFFFFF?text=Avatar';
            showRegStep(currentRegStep);
            registrationFlow.style.display = 'block';
            registrationSuccess.style.display = 'none';
        }
        function showRegStep(stepIndex) {
            regFormSlides.forEach((slide) => slide.classList.remove('active'));
            const currentSlide = registrationFlow.querySelector(`.form-slide[data-slide="${stepIndex}"]`);
            if(currentSlide) currentSlide.classList.add('active');

            regProgressSteps.forEach((step, index) => step.classList.toggle('active', index < stepIndex - 1));
            regProgressBarLine.style.width = `${((stepIndex - 1) / (regFormSlides.length - 1)) * 100}%`;
            regBackBtn.style.visibility = stepIndex === 1 ? 'hidden' : 'visible';
            regNextBtn.classList.toggle('hidden', stepIndex === regFormSlides.length);
            regSubmitBtn.classList.toggle('hidden', stepIndex !== regFormSlides.length);
        }
        function validateRegStep(stepIndex) {
            registerError.textContent = '';
            const slide = regFormSlides[stepIndex - 1]; // Adjust for 1-based index
            if (stepIndex === 1) {
                const username = slide.querySelector('#register-username').value;
                const email = slide.querySelector('#register-email').value;
                const password = slide.querySelector('#register-password').value;
                const passwordVerify = slide.querySelector('#register-password-verify').value;
                if (!username || !email || !password || !passwordVerify) { registerError.textContent = 'Please fill out all account fields.'; return false; }
                if (password.length < 6) { registerError.textContent = 'Password must be at least 6 characters long.'; return false; }
                if (password !== passwordVerify) { registerError.textContent = 'Passwords do not match.'; return false; }
            } else if (stepIndex === 2) {
                if (!slide.querySelector('#register-alliance').value || !slide.querySelector('#register-alliance-rank').value) { registerError.textContent = 'Please select your alliance and rank.'; return false; }
            } else if (stepIndex === 3) {
                if (!slide.querySelector('#register-power').value) { registerError.textContent = 'Please enter your total power.'; return false; }
            }
            return true;
        }
        regNextBtn.addEventListener('click', () => { if (validateRegStep(currentRegStep)) { currentRegStep++; showRegStep(currentRegStep); } });
        regBackBtn.addEventListener('click', () => { currentRegStep--; showRegStep(currentRegStep); });
        
        document.getElementById('register-avatar-btn').addEventListener('click', () => {
            document.getElementById('register-avatar-input').click();
        });

        document.getElementById('register-avatar-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            resizedAvatarBlob = await resizeImage(file, { maxWidth: 1024, maxHeight: 1024 });
            document.getElementById('register-avatar-preview').src = URL.createObjectURL(resizedAvatarBlob);
        });
        
        // Helper function to resize images while maintaining aspect ratio
        function resizeImage(file, options) {
            const { maxWidth, maxHeight } = options;
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        let { width, height } = img;

                        // Maintain aspect ratio
                        if (width > height) {
                            if (width > maxWidth) {
                                height = Math.round(height * (maxWidth / width));
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = Math.round(width * (maxHeight / height));
                                height = maxHeight;
                            }
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob((blob) => {
                            if (blob) {
                                resolve(blob);
                            } else {
                                reject(new Error('Canvas to Blob conversion failed'));
                            }
                        }, 'image/jpeg', 0.9); // Use jpeg for smaller file sizes
                    };
                    img.onerror = (err) => reject(err);
                    img.src = event.target.result;
                };
                reader.onerror = (err) => reject(err);
                reader.readAsDataURL(file);
            });
        }


        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!validateRegStep(currentRegStep)) return;
            regSubmitBtn.disabled = true;
            regSubmitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Registering...';
            const username = document.getElementById('register-username').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const alliance = document.getElementById('register-alliance').value;
            const allianceRank = document.getElementById('register-alliance-rank').value;
            const parsePower = (str) => parseInt(String(str).replace(/,/g, ''), 10) || 0;
            const power = parsePower(document.getElementById('register-power').value);
            const tankPower = parsePower(document.getElementById('register-tank-power').value);
            const airPower = parsePower(document.getElementById('register-air-power').value);
            const missilePower = parsePower(document.getElementById('register-missile-power').value);
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                let avatarUrl = null;
                if (resizedAvatarBlob) {
                    const avatarRef = ref(storage, `avatars/${user.uid}`);
                    await uploadBytes(avatarRef, resizedAvatarBlob);
                    avatarUrl = await getDownloadURL(avatarRef);
                }

                const userProfile = {
                    username, email, alliance, allianceRank, power, tankPower, airPower, missilePower,
                    likes: 0, allianceRole: '', isVerified: false, avatarUrl,
                    isAdmin: email === 'mikestancato@gmail.com',
                    registrationTimestampUTC: new Date().toISOString(),
                };
                if (userProfile.isAdmin) {
                    userProfile.isVerified = true;
                }

                await setDoc(doc(db, "users", user.uid), userProfile);
                
                registrationFlow.style.display = 'none';
                registrationSuccess.style.display = 'block';
                setTimeout(hideAllModals, 3000);
            } catch (error) {
                console.error("Registration Error:", error);
                registerError.textContent = error.code === 'auth/email-already-in-use' ? 'This email is already registered.' : 'An error occurred.';
            } finally {
                regSubmitBtn.disabled = false;
                regSubmitBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Register';
            }
        });
        
        // --- POST CREATION/EDIT STEPPER ---
        let currentPostStep = 1;
        const postFlow = document.getElementById('post-creation-flow');
        const postFormSlides = postFlow.querySelectorAll('.form-slide');
        const postBackBtn = document.getElementById('post-back-btn');
        const postNextBtn = document.getElementById('post-next-btn');
        const postSubmitBtn = document.getElementById('post-submit-btn');
        const createPostError = document.getElementById('create-post-error');

        function initializePostStepper() {
            document.getElementById('create-post-form').reset();
            postCreationData = {};
            resizedThumbnailBlob = null;
            document.getElementById('post-thumbnail-preview').src = 'https://placehold.co/100x100/161B22/444444?text=PREVIEW';
            currentPostStep = 1;
            populateMainTypeSelection();
            showPostStep(currentPostStep);
            postBackBtn.classList.remove('hidden');
            postNextBtn.classList.remove('hidden');
        }

        function getAvailablePostTypes(mainType) {
            return Object.entries(POST_TYPES).filter(([key, type]) => {
                if (type.mainType !== mainType) return false;
                if (type.isAdminOnly) return currentUserData.isAdmin;
                if (type.isVerifiedRequired && !currentUserData.isVerified) return false;
                if (type.allowedRanks) return type.allowedRanks.includes(currentUserData.allianceRank);
                return false;
            });
        }

        function populateMainTypeSelection() {
            const container = document.getElementById('post-main-type-selection-container');
            container.innerHTML = '';

            const canCreateAnnouncement = getAvailablePostTypes('announcement').length > 0;
            const canCreateEvent = getAvailablePostTypes('event').length > 0;

            if (canCreateAnnouncement && canCreateEvent) {
                // Show choice
                container.innerHTML = `
                    <button type="button" data-main-type="announcement" class="main-type-btn type-selection-card w-full p-6 rounded-lg text-center">
                        <i class="fas fa-bullhorn fa-3x mb-3 text-gray-400"></i>
                        <h3 class="font-bold text-lg text-white">Announcement</h3>
                        <p class="text-sm text-gray-500">Share news with the server or your alliance.</p>
                    </button>
                    <button type="button" data-main-type="event" class="main-type-btn type-selection-card w-full p-6 rounded-lg text-center">
                        <i class="fas fa-calendar-alt fa-3x mb-3 text-gray-400"></i>
                        <h3 class="font-bold text-lg text-white">Event</h3>
                        <p class="text-sm text-gray-500">Schedule a one-time or recurring event.</p>
                    </button>
                `;
                container.querySelectorAll('.main-type-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        postCreationData.mainType = btn.dataset.mainType;
                        currentPostStep++;
                        populateSubTypeSelection();
                        showPostStep(currentPostStep);
                    });
                });
            } else if (canCreateAnnouncement) {
                postCreationData.mainType = 'announcement';
                populateSubTypeSelection();
                showPostStep(2); // Skip to sub-type selection
            } else if (canCreateEvent) {
                postCreationData.mainType = 'event';
                populateSubTypeSelection();
                showPostStep(2); // Skip to sub-type selection
            } else {
                container.innerHTML = `<p class="text-center text-gray-400">You do not have permission to create any posts.</p>`;
            }
        }
        
        function populateSubTypeSelection() {
            const container = document.getElementById('post-subtype-selection-container');
            const header = document.getElementById('post-subtype-header');
            header.textContent = `Select ${postCreationData.mainType.charAt(0).toUpperCase() + postCreationData.mainType.slice(1)} Type`;
            container.innerHTML = '';
            
            const availableSubTypes = getAvailablePostTypes(postCreationData.mainType);

            availableSubTypes.forEach(([key, type]) => {
                const style = POST_STYLES[type.subType];
                const button = document.createElement('button');
                button.type = 'button';
                button.dataset.key = key;
                button.className = 'type-selection-card w-full p-4 rounded-lg text-left flex items-center gap-4';
                button.innerHTML = `
                    <i class="${style.icon} fa-2x w-10 text-center" style="color: ${style.color};"></i>
                    <div>
                        <h3 class="font-bold text-lg text-white">${type.text}</h3>
                        <p class="text-sm text-gray-500">Create a new ${type.subType.replace('_', ' ')} ${type.mainType}.</p>
                    </div>
                `;
                button.addEventListener('click', () => {
                    Object.assign(postCreationData, type);
                    currentPostStep++;
                    showPostStep(currentPostStep);
                });
                container.appendChild(button);
            });
        }

        function showPostStep(stepIndex) {
            postFormSlides.forEach(slide => slide.classList.remove('active'));
            const currentSlide = postFlow.querySelector(`.form-slide[data-slide="${stepIndex}"]`);
            if(currentSlide) currentSlide.classList.add('active');
            
            const isEvent = postCreationData.mainType === 'event';
            const totalSteps = isEvent ? 4 : 3;

            postBackBtn.style.visibility = stepIndex === 1 ? 'hidden' : 'visible';
            postNextBtn.classList.toggle('hidden', stepIndex >= totalSteps);
            postSubmitBtn.classList.toggle('hidden', stepIndex !== totalSteps);
            
            if(stepIndex === 3) { // Content slide
                const header = document.getElementById('post-content-header');
                header.textContent = editingPostId ? `Edit ${postCreationData.text}` : `New ${postCreationData.text}`;
                const allianceGroup = document.getElementById('post-alliance-group');
                if(currentUserData.isAdmin && (postCreationData.visibility === 'alliance' || postCreationData.visibility === 'leadership')) {
                    allianceGroup.classList.remove('hidden');
                } else {
                    allianceGroup.classList.add('hidden');
                }
            }
        }

        function validatePostStep(stepIndex) {
            createPostError.textContent = '';
            if (stepIndex === 3) { // Content slide
                 if (!document.getElementById('post-title').value || !document.getElementById('post-details').value) {
                    createPostError.textContent = 'Title and details are required.';
                    return false;
                }
            } else if (stepIndex === 4 && postCreationData.mainType === 'event') { // Timing slide
                if (!document.getElementById('post-start-day').value || !document.getElementById('post-start-hour').value ||
                    !document.getElementById('post-end-day').value || !document.getElementById('post-end-hour').value) {
                    createPostError.textContent = 'Please select a start/end day and hour for the event.';
                    return false;
                }
            }
            return true;
        }
        
        postNextBtn.addEventListener('click', () => {
            if (validatePostStep(currentPostStep)) {
                currentPostStep++;
                showPostStep(currentPostStep);
            }
        });
        
        postBackBtn.addEventListener('click', () => {
            currentPostStep--;
            showPostStep(currentPostStep);
        });

        document.getElementById('post-thumbnail-btn').addEventListener('click', () => {
            document.getElementById('post-thumbnail-input').click();
        });

        document.getElementById('post-thumbnail-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            resizedThumbnailBlob = await resizeImage(file, { maxWidth: 1024, maxHeight: 1024 });
            document.getElementById('post-thumbnail-preview').src = URL.createObjectURL(resizedThumbnailBlob);
        });
        
        document.getElementById('post-repeat-type').addEventListener('change', (e) => {
            const repeatWeeksContainer = document.getElementById('post-repeat-weeks-container');
            repeatWeeksContainer.classList.toggle('hidden', e.target.value !== 'weekly');
        });

        // --- EVENTS & ANNOUNCEMENTS LOGIC ---
        function renderPosts(posts) {
            if (countdownInterval) clearInterval(countdownInterval);
            announcementsContainer.innerHTML = '';
            eventsSectionContainer.innerHTML = '';

            const visiblePosts = posts.filter(post => {
                if (!currentUserData) return false;
                // if (!activeFilters.has(post.subType)) return false; // Filtering logic can be re-enabled here
                if (post.visibility === 'public') return true;
                if (currentUserData.isAdmin) return true;
                if (post.visibility === 'alliance' && post.alliance === currentUserData.alliance) return true;
                return false;
            });

            const announcements = visiblePosts
                .filter(p => p.mainType === 'announcement')
                .sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));

            const events = visiblePosts.filter(p => p.mainType === 'event');
            
            renderAnnouncements(announcements);
            renderEvents(events);

            countdownInterval = setInterval(updateCountdowns, 1000 * 30); // Update every 30 seconds
            updateCountdowns(); // Initial call
        }

        function renderAnnouncements(announcements) {
             if (announcements.length > 0) {
                const header = document.createElement('h3');
                header.className = 'section-header text-xl font-bold mb-4';
                header.style.setProperty('--glow-color', 'var(--color-highlight)');
                header.innerHTML = `<i class="fas fa-bullhorn"></i>Announcements`;
                announcementsContainer.appendChild(header);

                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-1 gap-4';
                announcements.forEach(post => {
                    grid.appendChild(createAnnouncementCard(post));
                });
                announcementsContainer.appendChild(grid);
            }
        }
        
        function createAnnouncementCard(post) {
            const card = document.createElement('div');
            const style = POST_STYLES[post.subType] || {};
            card.className = 'post-card announcement-card';
            const color = style.color || 'var(--color-primary)';
            const colorTransparent = color.replace(')', ', 0.2)').replace('rgb', 'rgba');
            card.style.setProperty('--glow-color', color);
            card.style.setProperty('--glow-color-transparent', colorTransparent);
            
            const postDate = post.createdAt?.toDate();
            const timestamp = postDate ? formatTimeAgo(postDate) : '...';

            let actionsHTML = '';
            if (currentUserData && (currentUserData.isAdmin || post.authorUid === currentUserData.uid)) {
                actionsHTML = `
                    <div class="card-actions">
                        <button class="card-action-btn edit-post-btn" data-post-id="${post.id}" title="Edit"><i class="fas fa-pen"></i></button>
                        <button class="card-action-btn delete-btn" data-post-id="${post.id}" title="Delete"><i class="fas fa-trash"></i></button>
                    </div>
                `;
            }
            
            const headerStyle = post.thumbnailUrl ? `background-image: url('${post.thumbnailUrl}')` : `background-color: #101419;`;

            card.innerHTML = `
                <div class="post-card-header" style="${headerStyle}"></div>
                <div class="post-card-body">
                    <span class="post-card-category">${post.subType.replace('_', ' ')}</span>
                    <h3 class="post-card-title">${post.title}</h3>
                    <div class="post-card-footer">
                        <div class="card-footer-status">
                            <div class="status-label" title="${postDate?.toLocaleString() || ''}">Posted</div>
                            <div class="status-time">${timestamp}</div>
                        </div>
                        ${actionsHTML}
                    </div>
                </div>
            `;
            return card;
        }


        function renderEvents(events) {
            eventsSectionContainer.innerHTML = '';
            if (events.length > 0) {
                if (announcementsContainer.innerHTML !== '') {
                    const divider = document.createElement('div');
                    divider.className = 'py-4';
                    eventsSectionContainer.appendChild(divider);
                }
                const header = document.createElement('h3');
                header.className = 'section-header text-xl font-bold mb-4';
                header.innerHTML = '<i class="fas fa-calendar-alt"></i>Events';
                eventsSectionContainer.appendChild(header);

                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-1 gap-4';

                events.sort((a, b) => {
                    const now = new Date();
                    const startTimeA = a.startTime?.toDate() || 0;
                    const startTimeB = b.startTime?.toDate() || 0;
                    const aIsLive = startTimeA < now && (a.endTime?.toDate() || new Date()) > now;
                    const bIsLive = startTimeB < now && (b.endTime?.toDate() || new Date()) > now;

                    if (aIsLive && !bIsLive) return -1;
                    if (!aIsLive && bIsLive) return 1;
                    
                    return startTimeA - startTimeB;
                });
                events.forEach(post => {
                    grid.appendChild(createEventListItem(post));
                });
                eventsSectionContainer.appendChild(grid);
            }
        }

        function createEventListItem(post) {
            const card = document.createElement('div');
            const style = POST_STYLES[post.subType] || {};
            const postTypeKey = `${post.subType}_${post.mainType}`;
            const eventTypeText = POST_TYPES[postTypeKey]?.text || post.subType.replace(/_/g, ' ').toUpperCase();
            
            card.className = 'post-card event-card';
            const color = style.color || 'var(--color-primary)';
            const colorTransparent = color.replace(')', ', 0.2)').replace('rgb', 'rgba');
            card.style.setProperty('--glow-color', color);
            card.style.setProperty('--glow-color-transparent', colorTransparent);

            card.dataset.postId = post.id;
            card.dataset.startTime = post.startTime?.toDate();
            card.dataset.endTime = post.endTime?.toDate();
            card.dataset.isRecurring = post.isRecurring || false;

            let actionsHTML = '';
            if (currentUserData && (currentUserData.isAdmin || post.authorUid === currentUserData.uid)) {
                actionsHTML = `
                    <div class="card-actions">
                        <button class="card-action-btn edit-post-btn" data-post-id="${post.id}" title="Edit"><i class="fas fa-pen"></i></button>
                        <button class="card-action-btn delete-btn" data-post-id="${post.id}" title="Delete"><i class="fas fa-trash"></i></button>
                    </div>
                `;
            }

            const headerStyle = post.thumbnailUrl ? `background-image: url('${post.thumbnailUrl}')` : `background-color: #101419;`;

            card.innerHTML = `
                <div class="post-card-header" style="${headerStyle}"></div>
                <div class="post-card-body">
                    <span class="post-card-category">${eventTypeText}</span>
                    <h3 class="post-card-title">${post.title}</h3>
                    <div class="post-card-footer">
                        <div class="card-footer-status">
                            <!-- Status updated by JS -->
                        </div>
                        ${actionsHTML}
                    </div>
                </div>
            `;
            return card;
        }

        // Helper to calculate the next occurrence of a given day and hour
        function calculateNextDateTime(dayOfWeek, hour) {
            const targetDay = parseInt(dayOfWeek, 10);
            const targetHour = parseInt(hour, 10);
            let resultDate = new Date();
            resultDate.setHours(targetHour, 0, 0, 0);

            let currentDay = resultDate.getDay();
            let diff = targetDay - currentDay;
            if (diff < 0) {
                diff += 7; // It's a past day of this week, so aim for next week
            }
            
            // If it's today, but the hour has passed, schedule for next week
            if (diff === 0 && resultDate < new Date()) {
                diff += 7;
            }

            resultDate.setDate(resultDate.getDate() + diff);
            return resultDate;
        }

        async function populatePostFormForEdit(postId) {
            const post = allPosts.find(p => p.id === postId);
            if (!post) {
                console.error("Post not found for editing:", postId);
                return;
            }

            editingPostId = postId;
            postCreationData = { ...POST_TYPES[`${post.subType}_${post.mainType}`] };

            document.getElementById('create-post-form').reset();
            
            // Change modal title and button
            document.getElementById('post-content-header').textContent = `Edit ${postCreationData.text}`;
            const submitBtn = document.getElementById('post-submit-btn');
            submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Save Changes';

            // Hide stepper nav and show the combined form
            document.getElementById('post-nav-container').style.display = 'none';
            document.querySelectorAll('.form-slide').forEach(s => s.classList.remove('active'));
            document.querySelector('.form-slide[data-slide="3"]').classList.add('active'); // Content
            if (post.mainType === 'event') {
                document.querySelector('.form-slide[data-slide="4"]').classList.add('active'); // Timing
            }
            
            // Populate content fields
            document.getElementById('post-title').value = post.title;
            document.getElementById('post-details').value = post.details;
            document.getElementById('post-thumbnail-preview').src = post.thumbnailUrl || 'https://placehold.co/100x100/161B22/444444?text=PREVIEW';
            
            // Populate timing fields if it's an event
            if (post.mainType === 'event' && post.startTime) {
                const startDate = post.startTime.toDate();
                const endDate = post.endTime.toDate();

                setCustomSelectValue(document.querySelector('#post-start-day').closest('.custom-select-container'), startDate.getDay().toString(), DAYS_OF_WEEK[startDate.getDay()].text);
                setCustomSelectValue(document.querySelector('#post-start-hour').closest('.custom-select-container'), startDate.getHours().toString(), HOURS_OF_DAY[startDate.getHours()].text);
                setCustomSelectValue(document.querySelector('#post-end-day').closest('.custom-select-container'), endDate.getDay().toString(), DAYS_OF_WEEK[endDate.getDay()].text);
                setCustomSelectValue(document.querySelector('#post-end-hour').closest('.custom-select-container'), endDate.getHours().toString(), HOURS_OF_DAY[endDate.getHours()].text);
                
                const repeatType = post.isRecurring ? 'weekly' : 'none';
                setCustomSelectValue(document.querySelector('#post-repeat-type').closest('.custom-select-container'), repeatType, REPEAT_TYPES.find(rt => rt.value === repeatType).text);
                document.getElementById('post-repeat-weeks-container').classList.toggle('hidden', !post.isRecurring);
                if (post.isRecurring) {
                    document.getElementById('post-repeat-weeks').value = post.repeatWeeks || 1;
                }
            }
            
            // Show the modal
            showModal(createPostModalContainer);
            postSubmitBtn.classList.remove('hidden'); // Ensure submit is visible
        }


        document.getElementById('create-post-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('post-submit-btn');
            if (!currentUserData) {
                createPostError.textContent = 'You must be logged in to post.';
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';

            let alliance = (postCreationData.visibility === 'alliance' || postCreationData.visibility === 'leadership') 
                ? (currentUserData.isAdmin ? document.getElementById('post-alliance').value : currentUserData.alliance)
                : null;
            
            const finalPostData = {
                mainType: postCreationData.mainType,
                subType: postCreationData.subType,
                title: document.getElementById('post-title').value,
                details: document.getElementById('post-details').value,
                authorUid: currentUserData.uid,
                authorUsername: currentUserData.username,
                alliance: alliance,
                visibility: postCreationData.visibility,
                isRecurring: document.getElementById('post-repeat-type').value === 'weekly',
            };

            if (postCreationData.mainType === 'event') {
                const startDay = document.getElementById('post-start-day').value;
                const startHour = document.getElementById('post-start-hour').value;
                const endDay = document.getElementById('post-end-day').value;
                const endHour = document.getElementById('post-end-hour').value;

                finalPostData.startTime = calculateNextDateTime(startDay, startHour);
                finalPostData.endTime = calculateNextDateTime(endDay, endHour);

                if (finalPostData.endTime < finalPostData.startTime) {
                    finalPostData.endTime.setDate(finalPostData.endTime.getDate() + 7);
                }
                
                if (finalPostData.isRecurring) {
                    finalPostData.repeatWeeks = parseInt(document.getElementById('post-repeat-weeks').value, 10) || 1;
                }
            }
            
            try {
                if (editingPostId) { // UPDATE EXISTING POST
                    const postDocRef = doc(db, 'posts', editingPostId);
                    if (resizedThumbnailBlob) {
                        const thumbnailRef = ref(storage, `post_thumbnails/${editingPostId}`);
                        await uploadBytes(thumbnailRef, resizedThumbnailBlob);
                        finalPostData.thumbnailUrl = await getDownloadURL(thumbnailRef);
                    }
                    await updateDoc(postDocRef, finalPostData);
                } else { // CREATE NEW POST
                    finalPostData.createdAt = serverTimestamp();
                    const postDocRef = await addDoc(collection(db, 'posts'), finalPostData);
                    if (resizedThumbnailBlob) {
                        const thumbnailRef = ref(storage, `post_thumbnails/${postDocRef.id}`);
                        await uploadBytes(thumbnailRef, resizedThumbnailBlob);
                        const downloadURL = await getDownloadURL(thumbnailRef);
                        await updateDoc(postDocRef, { thumbnailUrl: downloadURL });
                    }
                }
                hideAllModals();
            } catch (error) {
                console.error("Error saving post: ", error);
                createPostError.textContent = 'Failed to save post.';
            } finally {
                submitBtn.disabled = false;
                // Text will be reset when modal is opened next
            }
        });

        // --- PLAYER LIST & SETTINGS LOGIC ---
        function applyPlayerFilters() {
            const searchTerm = playerSearchInput.value.toLowerCase();
            const allianceFilter = allianceFilterInput.value;

            const filteredPlayers = allPlayers.filter(player => {
                const nameMatch = player.username.toLowerCase().includes(searchTerm);
                const allianceMatch = !allianceFilter || player.alliance === allianceFilter;
                return nameMatch && allianceMatch;
            });
            renderPlayers(filteredPlayers);
        }

        playerSearchInput.addEventListener('input', applyPlayerFilters);
        allianceFilterInput.addEventListener('change', applyPlayerFilters);

        function renderPlayers(players) {
            playerListContainer.innerHTML = '';
            if (players.length === 0) {
                playerListContainer.innerHTML = `<p class="text-center col-span-full py-8 text-gray-400">No players match the current filters.</p>`;
                return;
            }
            players.forEach(player => {
                const card = document.createElement('div');
                card.className = 'player-card glass-pane p-4 flex flex-col relative';
                card.dataset.rank = player.allianceRank;

                let gearIconHTML = '';
                if (currentUserData && currentUserData.uid !== player.uid) {
                    const canManage = canManageUser(currentUserData, player);
                    if(canManage) {
                        gearIconHTML = `<button class="absolute top-3 right-3 text-gray-400 hover:text-white transition-colors player-settings-btn" data-uid="${player.uid}"><i class="fas fa-cog"></i></button>`;
                    }
                }

                const avatarUrl = player.avatarUrl || `https://placehold.co/48x48/0D1117/FFFFFF?text=${player.username.charAt(0).toUpperCase()}`;

                card.innerHTML = `
                    ${gearIconHTML}
                    <div class="flex items-center pb-3 border-b" style="border-color: rgba(255,255,255,0.1);">
                        <img src="${avatarUrl}" class="w-12 h-12 rounded-full mr-4 border-2 object-cover" style="border-color: rgba(255,255,255,0.2);" alt="${player.username}" onerror="this.src='https://placehold.co/48x48/0D1117/FFFFFF?text=?';">
                        <div>
                            <h3 class="font-bold text-lg text-white">${player.username}</h3>
                            <p class="text-sm font-semibold" style="color: var(--color-primary);">[${player.alliance}] - ${player.allianceRank}</p>
                        </div>
                    </div>
                    <div class="flex-grow my-4 space-y-3">
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-400 flex items-center"><i class="fas fa-fist-raised w-6 text-center mr-2" style="color: var(--color-primary);"></i>Total Power</span>
                            <span class="font-bold text-white">${(player.power || 0).toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-400 flex items-center"><i class="fas fa-truck-monster w-6 text-center mr-2" style="color: var(--color-primary);"></i>Tank Power</span>
                            <span class="font-bold text-white">${(player.tankPower || 0).toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-400 flex items-center"><i class="fas fa-fighter-jet w-6 text-center mr-2" style="color: var(--color-primary);"></i>Air Power</span>
                            <span class="font-bold text-white">${(player.airPower || 0).toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-400 flex items-center"><i class="fas fa-rocket w-6 text-center mr-2" style="color: var(--color-primary);"></i>Missile Power</span>
                            <span class="font-bold text-white">${(player.missilePower || 0).toLocaleString()}</span>
                        </div>
                    </div>
                    <div class="flex justify-around items-center pt-3 border-t border-white/10">
                        <button class="text-gray-400 hover:text-white transition-colors !text-lg" title="Message Player"><i class="fas fa-comment-dots"></i></button>
                        <button class="text-gray-400 hover:text-white transition-colors !text-lg" title="Add Friend"><i class="fas fa-user-plus"></i></button>
                        <button class="text-gray-400 hover:text-white transition-colors !text-lg" title="Like Profile"><i class="fas fa-thumbs-up"></i></button>
                    </div>
                `;
                const settingsBtn = card.querySelector('.player-settings-btn');
                if (settingsBtn) {
                    settingsBtn.addEventListener('click', () => {
                        const targetPlayer = allPlayers.find(p => p.uid === settingsBtn.dataset.uid);
                        if(targetPlayer) showPlayerSettingsModal(targetPlayer)
                    });
                }
                playerListContainer.appendChild(card);
            });
        }
        
        function canManageUser(manager, targetUser) {
            if (!manager || !targetUser) return false;
            if (manager.isAdmin) return true;
            if (manager.alliance !== targetUser.alliance) return false;
            if (manager.allianceRank === 'R5' && ['R4', 'R3', 'R2', 'R1'].includes(targetUser.allianceRank)) return true;
            if (manager.allianceRank === 'R4' && ['R3', 'R2', 'R1'].includes(targetUser.allianceRank)) return true;
            return false;
        }

        function populatePlayerSettingsForm(player) {
            document.getElementById('player-settings-username').textContent = player.username;
            const rankSelect = document.getElementById('setting-alliance-rank').closest('.custom-select-container');
            const roleSelect = document.getElementById('setting-alliance-role').closest('.custom-select-container');
            const verifiedCheckbox = document.getElementById('setting-verified');
            
            setCustomSelectValue(rankSelect, player.allianceRank, ALLIANCE_RANKS.find(r => r.value === player.allianceRank)?.text);
            setCustomSelectValue(roleSelect, player.allianceRole, ALLIANCE_ROLES.find(r => r.value === player.allianceRole)?.text);
            verifiedCheckbox.checked = player.isVerified || false;

            const canVerify = canManageUser(currentUserData, player);
            verificationToggleContainer.style.display = canVerify ? 'flex' : 'none';
        }

        document.getElementById('player-settings-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!activePlayerSettingsUID || !currentUserData) return;

            const targetPlayer = allPlayers.find(p => p.uid === activePlayerSettingsUID);
            if (!targetPlayer) return;

            const errorElement = document.getElementById('player-settings-error');
            errorElement.textContent = '';

            const updatedData = {
                allianceRank: document.getElementById('setting-alliance-rank').value,
                allianceRole: document.getElementById('setting-alliance-role').value,
            };

            if (canManageUser(currentUserData, targetPlayer)) {
                updatedData.isVerified = document.getElementById('setting-verified').checked;
            }

            try {
                await updateDoc(doc(db, "users", activePlayerSettingsUID), updatedData);
                hideAllModals();
            } catch (error) {
                console.error("Error updating player settings:", error);
                errorElement.textContent = "Failed to save settings.";
            }
        });


        // --- TOP ALLIANCES PODIUM LOGIC ---
        function updateTopAlliancesPodium(players) {
            const topAlliances = ['THOR', 'fAfO', 'HeRA'];
            const podiumData = topAlliances.map(allianceTag => {
                const members = players.filter(p => p.alliance === allianceTag);
                const totalPower = members.reduce((sum, p) => sum + (p.power || 0), 0);
                const leader = members.find(p => p.allianceRank === 'R5')?.username || 'Unassigned';
                const warlord = members.find(p => p.allianceRole === 'Warlord')?.username || 'Unassigned';
                const recruiter = members.find(p => p.allianceRole === 'Recruiter')?.username || 'Unassigned';
                const muse = members.find(p => p.allianceRole === 'Muse')?.username || 'Unassigned';
                const butler = members.find(p => p.allianceRole === 'Butler')?.username || 'Unassigned';
                return { tag: allianceTag, totalPower, leader, warlord, recruiter, muse, butler };
            });

            const [gold, silver, bronze] = podiumData;

            document.getElementById('gold-podium').innerHTML = generatePodiumHTML(gold, '1st', 'gold');
            document.getElementById('silver-podium').innerHTML = generatePodiumHTML(silver, '2nd', 'silver');
            document.getElementById('bronze-podium').innerHTML = generatePodiumHTML(bronze, '3rd', 'bronze');
        }

        function generatePodiumHTML(data, rank, type) {
            if (!data) return '<p>Loading...</p>';
            const rankClasses = {
                gold: { sup: 'text-3xl font-bold text-yellow-400', main: 'text-6xl font-black text-yellow-300', text: 'text-yellow-200', border: 'border-yellow-500/50'},
                silver: { sup: 'text-2xl font-bold text-gray-400', main: 'text-5xl font-black text-gray-300', text: 'text-gray-300', border: 'border-gray-600'},
                bronze: { sup: 'text-2xl font-bold text-yellow-800', main: 'text-5xl font-black text-yellow-700', text: 'text-yellow-200/70', border: 'border-yellow-800/50'}
            };
            const cls = rankClasses[type];

            return `
                <div class="mb-4"><span class="${cls.main}">${rank.charAt(0)}</span><sup class="${cls.sup}">${rank.slice(1)}</sup></div>
                <h3 class="text-3xl font-extrabold text-white">[${data.tag}]</h3>
                <div class="text-base ${cls.text} mt-2 space-y-1">
                    <p><i class="fas fa-crown mr-2"></i>Leader: ${data.leader}</p>
                    <p><i class="fas fa-fist-raised mr-2"></i>Power: ${(data.totalPower / 1_000_000_000).toFixed(1)}B</p>
                </div>
                <div class="border-t ${cls.border} my-4"></div>
                <div class="text-left text-sm space-y-2">
                    <p><strong class="${cls.text}">Warlord:</strong> ${data.warlord}</p>
                    <p><strong class="${cls.text}">Recruiter:</strong> ${data.recruiter}</p>
                    <p><strong class="${cls.text}">Muse:</strong> ${data.muse}</p>
                    <p><strong class="${cls.text}">Butler:</strong> ${data.butler}</p>
                </div>
            `;
        }


        // --- CUSTOM SELECT LOGIC ---
        function setupCustomSelect(container) {
            const type = container.dataset.type;
            const hiddenInput = container.querySelector('input[type="hidden"]');
            const valueButton = container.querySelector('.custom-select-value');
            const optionsContainer = container.querySelector('.custom-select-options');
            const searchInput = container.querySelector('.custom-select-search');
            const optionsList = container.querySelector('.options-list');
            
            let sourceData = [];
            if (type === 'alliance') sourceData = ALLIANCES.map(a => ({value: a, text: a}));
            else if (type === 'rank') sourceData = ALLIANCE_RANKS;
            else if (type === 'role') sourceData = ALLIANCE_ROLES;
            else if (type === 'alliance-filter') sourceData = [{value: '', text: 'All Alliances'}, ...ALLIANCES.map(a => ({value: a, text: a}))];
            else if (type === 'day-of-week') sourceData = DAYS_OF_WEEK;
            else if (type === 'hour-of-day') sourceData = HOURS_OF_DAY;
            else if (type === 'repeat-type') sourceData = REPEAT_TYPES;
            
            const isSearchable = searchInput && type === 'alliance';
            if(searchInput && !isSearchable) searchInput.style.display = 'none';

            function renderOptions(data = [], filter = '') {
                optionsList.innerHTML = '';
                const filteredData = data.filter(item => item.text.toLowerCase().includes(filter.toLowerCase()));
                filteredData.forEach(item => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'custom-select-option';
                    optionDiv.textContent = item.text;
                    optionDiv.dataset.value = item.value;
                    optionsList.appendChild(optionDiv);
                });
            }

            valueButton.addEventListener('click', (e) => {
                e.stopPropagation();

                const isOpen = container.classList.contains('open');
                document.querySelectorAll('.custom-select-container').forEach(c => c.classList.remove('open'));
                if (!isOpen) {
                    const rect = container.getBoundingClientRect();
                    const spaceBelow = window.innerHeight - rect.bottom;
                    optionsContainer.classList.remove('open-up', 'open-down');
                    if (spaceBelow < 220 && rect.top > 220) { 
                        optionsContainer.classList.add('open-up');
                    } else {
                        optionsContainer.classList.add('open-down');
                    }
                    container.classList.add('open');
                    if (isSearchable) { searchInput.value = ''; searchInput.focus(); }
                    renderOptions(sourceData);
                } else {
                    container.classList.remove('open');
                }
            });

            if (isSearchable) {
                searchInput.addEventListener('input', () => renderOptions(sourceData, searchInput.value));
            }

            optionsList.addEventListener('click', (e) => {
                if (e.target.classList.contains('custom-select-option')) {
                    const value = e.target.dataset.value;
                    const text = e.target.textContent;
                    setCustomSelectValue(container, value, text);
                    container.classList.remove('open');
                    hiddenInput.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });
            renderOptions(sourceData);
        }

        function setCustomSelectValue(container, value, text) {
            const hiddenInput = container.querySelector('input[type="hidden"]');
            const valueSpan = container.querySelector('.custom-select-value span');
            hiddenInput.value = value;
            valueSpan.textContent = text || value;
        }
        
        // --- MOBILE NAV LOGIC ---
        function buildMobileNav() {
            mobileNavLinksContainer.innerHTML = '';
            const desktopNav = document.getElementById('main-nav');
            
            desktopNav.querySelectorAll('.nav-item').forEach(item => {
                const link = item.querySelector('.nav-link');
                const newLink = document.createElement('a');
                newLink.href = '#';
                newLink.className = 'mobile-nav-link';
                newLink.innerHTML = `<i class="${link.querySelector('i').className} w-6 text-center mr-3"></i>${link.querySelector('span').textContent}`;
                
                const dropdown = item.querySelector('.dropdown-menu');
                if (dropdown) {
                    newLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        const subMenu = newLink.nextElementSibling;
                        subMenu.style.display = subMenu.style.display === 'block' ? 'none' : 'block';
                    });
                    mobileNavLinksContainer.appendChild(newLink);

                    const subMenuContainer = document.createElement('div');
                    subMenuContainer.style.display = 'none';
                    subMenuContainer.className = 'ml-8';
                    dropdown.querySelectorAll('.dropdown-link').forEach(ddLink => {
                        const newDdLink = document.createElement('a');
                        newDdLink.href = '#';
                        newDdLink.className = 'mobile-nav-link !py-2 !text-base';
                        newDdLink.textContent = ddLink.textContent;
                        newDdLink.addEventListener('click', (e) => {
                            e.preventDefault();
                            showPage(ddLink.dataset.target);
                            mobileNavMenu.classList.remove('open');
                            modalBackdrop.classList.remove('visible');
                        });
                        subMenuContainer.appendChild(newDdLink);
                    });
                    mobileNavLinksContainer.appendChild(subMenuContainer);

                } else {
                     newLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        showPage(link.dataset.mainTarget);
                        mobileNavMenu.classList.remove('open');
                        modalBackdrop.classList.remove('visible');
                    });
                    mobileNavLinksContainer.appendChild(newLink);
                }
            });

            const divider = document.createElement('hr');
            divider.className = 'border-t border-white/10 my-4';
            mobileNavLinksContainer.appendChild(divider);

            if (currentUserData) {
                const editProfileMobile = document.createElement('a');
                editProfileMobile.href = '#';
                editProfileMobile.className = 'mobile-nav-link';
                editProfileMobile.innerHTML = `<i class="fas fa-user-edit w-6 text-center mr-3"></i>Edit Profile`;
                editProfileMobile.onclick = (e) => { e.preventDefault(); mobileNavMenu.classList.remove('open'); showEditProfileModal(); };
                mobileNavLinksContainer.appendChild(editProfileMobile);

                const logoutMobile = document.createElement('a');
                logoutMobile.href = '#';
                logoutMobile.className = 'mobile-nav-link';
                logoutMobile.innerHTML = `<i class="fas fa-sign-out-alt w-6 text-center mr-3"></i>Logout`;
                logoutMobile.onclick = (e) => { e.preventDefault(); signOut(auth); };
                mobileNavLinksContainer.appendChild(logoutMobile);
            } else {
                const loginMobile = document.createElement('a');
                loginMobile.href = '#';
                loginMobile.className = 'mobile-nav-link';
                loginMobile.innerHTML = `<i class="fas fa-sign-in-alt w-6 text-center mr-3"></i>Login / Register`;
                loginMobile.onclick = (e) => { e.preventDefault(); mobileNavMenu.classList.remove('open'); showAuthModal('login'); };
                mobileNavLinksContainer.appendChild(loginMobile);
            }
        }

        document.getElementById('open-mobile-menu-btn').addEventListener('click', () => {
            mobileNavMenu.classList.add('open');
            modalBackdrop.classList.add('visible');
        });
        document.getElementById('close-mobile-menu-btn').addEventListener('click', () => {
            mobileNavMenu.classList.remove('open');
            modalBackdrop.classList.remove('visible');
        });


        // --- UI & PARTICLE SCRIPTS ---
        const canvas = document.getElementById('particle-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        function createParticles() {
            particles = []; let particleCount = (canvas.width * canvas.height) / 10000;
            for (let i = 0; i < particleCount; i++) { particles.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, vx: (Math.random() - 0.5) * 0.5, vy: (Math.random() - 0.5) * 0.5, size: Math.random() * 1.5 + 0.5, color: Math.random() > 0.3 ? 'rgba(0, 191, 255, 0.5)' : 'rgba(248, 113, 113, 0.1)' }); }
        }
        function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => { p.x += p.vx; p.y += p.vy; if (p.x < 0 || p.x > canvas.width) p.vx *= -1; if (p.y < 0 || p.y > canvas.height) p.vy *= -1; ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); ctx.fill(); });
            requestAnimationFrame(animateParticles);
        }
        window.addEventListener('resize', () => { resizeCanvas(); createParticles(); });
        resizeCanvas(); createParticles(); animateParticles();
        
        const pages = document.querySelectorAll('.page-content');
        function showPage(targetId) {
            pages.forEach(page => { page.style.display = page.id === targetId ? 'block' : 'none'; });
            let activeSet = false;
            document.querySelectorAll('#main-nav .nav-link').forEach(link => {
                const mainTarget = link.dataset.mainTarget;
                const parentItem = link.closest('.nav-item');
                const dropdowns = parentItem.querySelectorAll('.dropdown-link');
                let isParentOfActive = false;
                dropdowns.forEach(ddLink => { if (ddLink.dataset.target === targetId) { isParentOfActive = true; } });
                if (mainTarget === targetId || isParentOfActive) { link.classList.add('active'); activeSet = true; } else { link.classList.remove('active'); }
            });
             if (!activeSet) { const eventsLink = document.querySelector('.nav-link[data-main-target="page-events"]'); if (eventsLink) eventsLink.classList.add('active'); }
        }

        // --- GLOBAL EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize all custom selects on the page
            document.querySelectorAll('.custom-select-container').forEach(setupCustomSelect);

            const navItems = document.querySelectorAll('.nav-item');
            
            navItems.forEach(item => {
                const link = item.querySelector('.nav-link');
                const dropdown = item.querySelector('.dropdown-menu');
                
                if (dropdown) {
                    item.addEventListener('mouseenter', () => { if (window.innerWidth > 768) item.classList.add('open'); });
                    item.addEventListener('mouseleave', () => { if (window.innerWidth > 768) item.classList.remove('open'); });
                    link.addEventListener('click', (e) => {
                        if (window.innerWidth <= 768) {
                            e.preventDefault();
                            e.stopPropagation();
                            const wasOpen = item.classList.contains('open');
                            navItems.forEach(i => i.classList.remove('open'));
                            if (!wasOpen) item.classList.add('open');
                        }
                    });
                } else {
                    link.addEventListener('click', () => showPage(link.dataset.mainTarget));
                }
            });
            
            window.addEventListener('click', (e) => { 
                if (!e.target.closest('.nav-item')) {
                    document.querySelectorAll('.nav-item.open').forEach(item => item.classList.remove('open'));
                }
                if (!e.target.closest('#user-profile-container')) {
                    userProfileContainer.classList.remove('open');
                }
                if (!e.target.closest('.custom-select-container')) {
                    document.querySelectorAll('.custom-select-container').forEach(c => c.classList.remove('open'));
                }
            });

            document.querySelectorAll('.dropdown-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const targetId = link.dataset.target;
                    if (targetId) showPage(targetId);
                    link.closest('.nav-item').classList.remove('open');
                });
            });

            // Event delegation for post controls
            eventsMainContainer.addEventListener('click', e => {
                const editBtn = e.target.closest('.edit-post-btn');
                const deleteBtn = e.target.closest('.delete-btn');

                if (editBtn) {
                    const postId = editBtn.dataset.postId;
                    populatePostFormForEdit(postId);
                }

                if (deleteBtn) {
                    const postId = deleteBtn.dataset.postId;
                    showConfirmationModal('Delete Post?', 'This action cannot be undone.', () => {
                        deleteDoc(doc(db, 'posts', postId))
                            .catch(err => console.error("Error deleting post: ", err));
                    });
                }
            });

            showPage('page-events'); 
            document.querySelectorAll('.power-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    let value = String(e.target.value).replace(/,/g, '');
                    if (isNaN(value)) { e.target.value = ''; return; }
                    e.target.value = Number(value).toLocaleString('en-US');
                });
            });
        });
    </script>
</body>
</html>
