<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Last War: Survival - 899 Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        :root {
            --color-bg: #0D1117;
            --color-primary: #00BFFF;
            --color-highlight: #F87171;
            --color-glass-bg: rgba(22, 27, 34, 0.40); 
            --color-dropdown-bg: rgba(22, 27, 34, 0.95);
        }
        @keyframes pulse-live { 0%, 100% { box-shadow: 0 0 5px var(--color-primary); } 50% { box-shadow: 0 0 10px var(--color-primary); } }
        @keyframes slide-in-right { to { opacity: 1; transform: translateX(0); } }
        body { font-family: 'Inter', sans-serif; background-color: var(--color-bg); color: #c9d1d9; }
        #particle-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at top left, rgba(0, 191, 255, 0.1), transparent 40%), radial-gradient(circle at bottom right, rgba(248, 113, 113, 0.1), transparent 40%); }
        .glass-pane { background-color: var(--color-glass-bg); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border-radius: 1rem; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); }
        .header-main { padding: 0.75rem 1.5rem; position: relative; z-index: 50; }
        .nav-item { position: relative; }
        .nav-link { position: relative; padding: 0.5rem; font-weight: 600; font-size: 0.75rem; color: #c9d1d9; transition: color 0.3s ease; display: flex; flex-direction: column; align-items: center; gap: 0.25rem; width: 80px; cursor: pointer; }
        .nav-link i { font-size: 1rem; }
        .nav-link:hover { color: #fff; }
        .nav-link::after { content: ''; position: absolute; bottom: 0; left: 20%; right: 20%; height: 2px; background-color: var(--color-primary); transform: scaleX(0); transform-origin: center; transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1); }
        .nav-item:hover .nav-link::after, .nav-link.active::after { transform: scaleX(1); }
        .nav-link.active { color: #fff; }
        .dropdown-menu { position: absolute; top: calc(100% + 12px); left: 50%; transform: translateX(-50%) translateY(-10px); opacity: 0; visibility: hidden; transition: opacity 0.3s ease, transform 0.3s ease, visibility 0s 0.3s; z-index: 100; padding: 0.5rem; min-width: 180px; border-top: 2px solid var(--color-primary); background-color: var(--color-dropdown-bg); }
        .nav-item:hover .dropdown-menu, .nav-item.open .dropdown-menu { transform: translateX(-50%) translateY(0); opacity: 1; visibility: visible; transition: opacity 0.3s ease, transform 0.3s ease, visibility 0s 0s; }
        .dropdown-link { display: block; padding: 0.6rem 1rem; border-radius: 0.5rem; font-size: 0.875rem; color: #c9d1d9; transition: background-color 0.2s ease, color 0.2s ease; white-space: nowrap; cursor: pointer; }
        .dropdown-link:hover { background-color: rgba(0, 191, 255, 0.1); color: #fff; }
        .login-button { padding: 0.6rem 1.25rem; font-weight: 600; font-size: 0.875rem; color: #c9d1d9; background-color: rgba(255,255,255,0.05); border-radius: 0.5rem; border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem; }
        .login-button:hover { color: #fff; background-color: rgba(0, 191, 255, 0.1); border-color: var(--color-primary); }
        .section-container { padding: 1.25rem; }
        .event-card { background-color: rgba(13, 17, 23, 0.7); border-radius: 0.75rem; overflow: hidden; transition: all 0.3s ease; display: flex; flex-direction: column; border: 1px solid rgba(255,255,255,0.1); }
        .event-card:hover { box-shadow: 0 0 10px 0px var(--color-primary); }
        .live-indicator { animation: pulse-live 2s infinite; }
        .toggle-button { position: relative; padding: 0.75rem 1rem; font-size: 0.9rem; font-weight: 600; color: #8b949e; background-color: transparent; border: none; transition: color 0.3s ease; flex-shrink: 0; }
        .toggle-button:hover { color: #c9d1d9; }
        .toggle-button.active { color: #fff; }
        .toggle-button::after { content: ''; position: absolute; bottom: 0.5rem; left: 1rem; right: 1rem; height: 2px; background-color: var(--color-primary); transform: scaleX(0); transition: transform 0.3s ease-in-out; }
        .toggle-button.active::after { transform: scaleX(1); }
        .player-card { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .player-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2), 0 0 15px var(--color-primary); }
        .action-button { background: rgba(255,255,255,0.1); border-radius: 0.375rem; padding: 0.5rem; transition: all 0.2s ease; }
        .action-button:hover { background: var(--color-primary); color: #0D1117; }
        .styled-table { width: 100%; border-collapse: collapse; }
        .styled-table th, .styled-table td { padding: 0.75rem 1rem; text-align: left; vertical-align: middle; }
        .styled-table thead { border-bottom: 2px solid var(--color-primary); }
        .styled-table th { font-size: 0.875rem; font-weight: 700; color: #fff; text-transform: uppercase; letter-spacing: 0.05em; }
        .styled-table tbody tr { border-bottom: 1px solid rgba(255, 255, 255, 0.1); transition: background-color 0.2s ease; }
        .styled-table tbody tr:last-child { border-bottom: none; }
        .styled-table tbody tr:hover { background-color: rgba(0, 191, 255, 0.05); }
        .styled-table .tag { font-weight: 800; color: #fff; }
        .filter-dropdown { position: relative; }
        .filter-dropdown-button { background-color: rgba(255,255,255,0.05); border: 1px solid rgba(255, 255, 255, 0.1); }
        .filter-dropdown-button:hover { background-color: rgba(0, 191, 255, 0.1); border-color: var(--color-primary); }
        .filter-dropdown-menu { position: absolute; top: 100%; left: 0; right: 0; z-index: 10; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.3s ease; background-color: var(--color-dropdown-bg); }
        .filter-dropdown.open .filter-dropdown-menu { opacity: 1; visibility: visible; transform: translateY(5px); }
        .filter-dropdown-item { color: #c9d1d9; }
        .filter-dropdown-item:hover { background-color: rgba(0, 191, 255, 0.1); color: #fff; }
        #mobile-menu { opacity: 0; pointer-events: none; transition: opacity 0.3s ease-in-out; }
        #mobile-menu.open { opacity: 1; pointer-events: auto; }
        #mobile-menu-content { transform: translateY(-30px); transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        #mobile-menu.open #mobile-menu-content { transform: translateY(0); }
        .mobile-nav-link { opacity: 0; transform: translateX(-15px); transition: background-color 0.2s ease, transform 0.2s ease; }
        .mobile-nav-link:hover { background-color: rgba(0, 191, 255, 0.1); transform: translateX(0px); }
        #mobile-menu.open .mobile-nav-link, #mobile-menu.open .mobile-menu-divider { animation: slide-in-right 0.5s forwards cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        #mobile-menu.open .mobile-nav-link:nth-of-type(1) { animation-delay: 0.1s; }
        #mobile-menu.open .mobile-nav-link:nth-of-type(2) { animation-delay: 0.15s; }
        #mobile-menu.open .mobile-nav-link:nth-of-type(3) { animation-delay: 0.2s; }
        #mobile-menu.open .mobile-nav-link:nth-of-type(4) { animation-delay: 0.25s; }
        #mobile-menu.open .mobile-nav-link:nth-of-type(5) { animation-delay: 0.3s; }
        #mobile-menu.open .mobile-nav-link:nth-of-type(6) { animation-delay: 0.35s; }
        #mobile-menu.open .mobile-menu-divider { animation-delay: 0.4s; }
        #event-toggles { -ms-overflow-style: none; scrollbar-width: none; }
        #event-toggles::-webkit-scrollbar { height: 4px; }
        #event-toggles::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 2px; }
        #event-toggles::-webkit-scrollbar-thumb { background: var(--color-primary); border-radius: 2px; }
        #event-toggles::-webkit-scrollbar-thumb:hover { background: #00a0d9; }
        .modal { transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
    </style>
</head>
<body>
    <canvas id="particle-canvas"></canvas>
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900/80 flex items-center justify-center z-[100]"><div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-cyan-500"></div></div>
    
    <!-- Modals -->
    <div id="auth-modal" class="modal hidden fixed inset-0 bg-black/70 backdrop-blur-md z-50 flex items-center justify-center p-4">
        <div class="modal-content glass-pane w-full max-w-md p-8 rounded-2xl">
            <!-- Auth modal content will be injected here -->
        </div>
    </div>
     <div id="add-player-modal" class="modal hidden fixed inset-0 bg-black/70 backdrop-blur-md z-50 flex items-center justify-center p-4">
        <div class="modal-content glass-pane w-full max-w-md p-8 rounded-2xl">
            <h2 class="text-2xl font-bold text-white text-center mb-6">Add New Player</h2>
            <form id="add-player-form" class="space-y-4">
                <input required class="w-full bg-gray-900/50 border border-gray-700 rounded-lg px-4 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-cyan-500" type="text" name="name" placeholder="Player Name">
                <input required class="w-full bg-gray-900/50 border border-gray-700 rounded-lg px-4 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-cyan-500" type="text" name="alliance" placeholder="Alliance Tag (e.g., THOR)">
                <input required class="w-full bg-gray-900/50 border border-gray-700 rounded-lg px-4 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-cyan-500" type="number" name="rank" placeholder="Rank (1-5)" min="1" max="5">
                <input required class="w-full bg-gray-900/50 border border-gray-700 rounded-lg px-4 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-cyan-500" type="number" name="power" placeholder="Total Power">
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" id="cancel-add-player" class="login-button bg-red-500/20 hover:bg-red-500/40">Cancel</button>
                    <button type="submit" class="login-button bg-cyan-500/20 hover:bg-cyan-500/40">Add Player</button>
                </div>
            </form>
        </div>
    </div>


    <div class="relative min-h-screen w-full p-4 sm:p-6 lg:p-8">
        <div class="max-w-6xl mx-auto">
            <header class="glass-pane header-main flex justify-between items-center mb-6">
                <div class="flex-shrink-0">
                    <h1 class="text-2xl md:text-3xl font-black tracking-tighter text-white">899<span class="font-bold" style="color: var(--color-primary);">EVENTS</span></h1>
                    <p class="text-xs text-gray-400">Official Event Hub</p>
                </div>
                
                <nav id="main-nav" class="hidden md:flex flex-grow justify-center items-center">
                    <div class="nav-item"><div class="nav-link"><i class="fas fa-shield-alt"></i><span>Alliances</span></div><div class="dropdown-menu glass-pane"><a class="dropdown-link" data-target="page-top-alliances">Top Alliances</a><a class="dropdown-link" data-target="page-alliance-list">Alliance List</a><a class="dropdown-link" data-target="page-recruitment">Recruitment</a></div></div>
                    <div class="nav-item"><div class="nav-link" data-main-target="page-players"><i class="fas fa-users"></i><span>Players</span></div></div>
                    <div class="nav-item"><div class="nav-link active" data-main-target="page-events"><i class="fas fa-calendar-alt"></i><span>Events</span></div></div>
                    <div class="nav-item"><div class="nav-link"><i class="fas fa-trophy"></i><span>Season</span></div><div class="dropdown-menu glass-pane"><a class="dropdown-link" data-target="page-season-overview">Season Overview</a><a class="dropdown-link" data-target="page-season-rewards">Rewards</a><a class="dropdown-link" data-target="page-season-history">History</a></div></div>
                    <div class="nav-item"><div class="nav-link"><i class="fas fa-tools"></i><span>Tools</span></div><div class="dropdown-menu glass-pane"><a class="dropdown-link" data-target="page-calculators">Calculators</a><a class="dropdown-link" data-target="page-guides">Guides</a></div></div>
                    <div class="nav-item"><div class="nav-link"><i class="fas fa-globe"></i><span>Language</span></div><div class="dropdown-menu glass-pane"><a href="#" class="dropdown-link">English</a><a href="#" class="dropdown-link">Espa√±ol</a><a href="#" class="dropdown-link">Deutsch</a></div></div>
                </nav>

                <div id="auth-container" class="hidden md:flex flex-shrink-0">
                    <!-- Auth status will be injected here -->
                </div>
                
                <button id="mobile-menu-button" class="md:hidden text-white p-2 rounded-md hover:bg-white/10 transition-colors z-50">
                    <svg id="menu-open-icon" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
                    <svg id="menu-close-icon" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </header>
            
            <div id="mobile-menu" class="md:hidden fixed inset-0 bg-black/70 backdrop-blur-md z-40 flex items-center justify-center">
                <div id="mobile-menu-content" class="w-full max-w-sm p-8 space-y-2">
                    <a href="#" class="mobile-nav-link text-2xl font-bold flex items-center gap-4 p-4 rounded-lg" data-target="page-events"><i class="fas fa-calendar-alt w-6 text-center" style="color: var(--color-primary);"></i>Events</a>
                    <a href="#" class="mobile-nav-link text-2xl font-bold flex items-center gap-4 p-4 rounded-lg" data-target="page-players"><i class="fas fa-users w-6 text-center" style="color: var(--color-primary);"></i>Players</a>
                    <a href="#" class="mobile-nav-link text-2xl font-bold flex items-center gap-4 p-4 rounded-lg" data-target="page-top-alliances"><i class="fas fa-shield-alt w-6 text-center" style="color: var(--color-primary);"></i>Top Alliances</a>
                    <a href="#" class="mobile-nav-link text-2xl font-bold flex items-center gap-4 p-4 rounded-lg" data-target="page-alliance-list"><i class="fas fa-list-ul w-6 text-center" style="color: var(--color-primary);"></i>Alliance List</a>
                    <a href="#" class="mobile-nav-link text-2xl font-bold flex items-center gap-4 p-4 rounded-lg" data-target="page-season-overview"><i class="fas fa-trophy w-6 text-center" style="color: var(--color-primary);"></i>Season</a>
                    <a href="#" class="mobile-nav-link text-2xl font-bold flex items-center gap-4 p-4 rounded-lg" data-target="page-calculators"><i class="fas fa-tools w-6 text-center" style="color: var(--color-primary);"></i>Tools</a>
                    <div class="mobile-menu-divider border-t border-gray-700/50 pt-6 mt-4">
                         <div id="mobile-auth-container"></div>
                    </div>
                </div>
            </div>

            <div id="page-container">
                <div id="page-events" class="page-content" style="display: none;">
                    <div class="glass-pane section-container">
                        <h2 class="text-3xl font-bold text-white text-center mb-4">Events</h2>
                        <p class="text-center text-gray-400">Event information will be displayed here.</p>
                    </div>
                </div>

                <div id="page-top-alliances" class="page-content" style="display: none;">
                    <div class="glass-pane section-container">
                        <h2 class="text-3xl font-bold text-white text-center mb-4">Top Alliances</h2>
                        <p class="text-center text-gray-400">Top alliance information will be displayed here.</p>
                    </div>
                </div>

                <div id="page-alliance-list" class="page-content" style="display: none;">
                    <div class="glass-pane section-container">
                        <h2 class="text-3xl font-bold text-white text-center mb-4">Alliance List</h2>
                        <p class="text-center text-gray-400">A list of all alliances will be displayed here.</p>
                    </div>
                </div>

                <div id="page-players" class="page-content">
                    <div class="glass-pane section-container">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                            <h2 class="text-3xl font-bold text-white">Registered Players</h2>
                            <button id="add-player-button" class="hidden login-button bg-cyan-500/20 hover:bg-cyan-500/40 w-full md:w-auto">
                                <i class="fas fa-plus mr-2"></i>Add Player
                            </button>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-4 mb-6">
                            <input id="player-search-input" type="text" placeholder="Search for a player..." class="flex-grow bg-gray-900/50 border border-gray-700 rounded-lg px-4 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                            <div id="alliance-filter" class="filter-dropdown flex-shrink-0">
                                <button id="alliance-filter-button" class="filter-dropdown-button w-full sm:w-48 flex items-center justify-between rounded-lg px-4 py-2 text-white transition-colors duration-200">
                                    <span id="alliance-filter-label">All Alliances</span>
                                    <i class="fas fa-chevron-down ml-2 transition-transform duration-300"></i>
                                </button>
                                <div id="alliance-filter-menu" class="filter-dropdown-menu glass-pane mt-2 p-2 rounded-lg w-full"></div>
                            </div>
                        </div>
                        <div id="player-card-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                        <div id="no-players-message" class="hidden text-center py-12"><p class="text-gray-400 text-lg">No players found.</p></div>
                    </div>
                </div>
                
                <div id="page-recruitment" class="page-content" style="display: none;"><div class="glass-pane section-container"><h2 class="text-2xl font-bold text-white">Recruitment</h2></div></div>
                <div id="page-season-overview" class="page-content" style="display: none;"><div class="glass-pane section-container"><h2 class="text-2xl font-bold text-white">Season Overview</h2></div></div>
                <div id="page-season-rewards" class="page-content" style="display: none;"><div class="glass-pane section-container"><h2 class="text-2xl font-bold text-white">Season Rewards</h2></div></div>
                <div id="page-season-history" class="page-content" style="display: none;"><div class="glass-pane section-container"><h2 class="text-2xl font-bold text-white">Season History</h2></div></div>
                <div id="page-calculators" class="page-content" style="display: none;"><div class="glass-pane section-container"><h2 class="text-2xl font-bold text-white">Calculators</h2></div></div>
                <div id="page-guides" class="page-content" style="display: none;"><div class="glass-pane section-container"><h2 class="text-2xl font-bold text-white">Guides</h2></div></div>
            </div>
            <footer class="text-center mt-12 py-4 border-t border-gray-800/50"><p class="text-gray-500">&copy; 2024 Last War Survival - Server 899 Community.</p></footer>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, onSnapshot, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyA8KKDjjw0Pb_wknZ3TRWuL7-7XMo4VeY0",
            authDomain: "events-ea397.firebaseapp.com",
            projectId: "events-ea397",
            storageBucket: "events-ea397.appspot.com",
            messagingSenderId: "51859633788",
            appId: "1:51859633788:web:3653d3e7edb6d3c1c4fbf9"
        };
        
        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Firestore Security Rules (V2) ---
        /*
        rules_version = '2';
        service cloud.firestore {
          match /databases/{database}/documents {
            
            // Users can read their own user document
            match /users/{userId} {
              allow read, update: if request.auth != null && request.auth.uid == userId;
              allow create: if request.auth != null;
            }

            // Alliances can be read by any authenticated user
            match /alliances/{allianceId} {
                allow read: if request.auth != null;
                // Only users with rank >= 4 can create/update alliances
                allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.rank >= 4;
            }

            // Players can be read by anyone
            match /players/{playerId} {
              allow read: if true;
              // Only users with rank >= 4 can create/update/delete players
              allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.rank >= 4;
            }

            // Events can be read by anyone
            match /events/{eventId} {
                allow read: if true;
                // Only users with rank >= 4 can write events
                allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.rank >= 4;
            }
          }
        }
        */

        // --- App State ---
        let playersData = [];
        let currentUserData = null;

        // --- DOM Elements ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const authContainer = document.getElementById('auth-container');
        const mobileAuthContainer = document.getElementById('mobile-auth-container');
        const authModal = document.getElementById('auth-modal');
        const addPlayerModal = document.getElementById('add-player-modal');
        const addPlayerButton = document.getElementById('add-player-button');
        const cancelAddPlayerButton = document.getElementById('cancel-add-player');
        const addPlayerForm = document.getElementById('add-player-form');
        const playerCardGrid = document.getElementById('player-card-grid');
        const noPlayersMessage = document.getElementById('no-players-message');
        const searchInput = document.getElementById('player-search-input');
        const allianceFilter = document.getElementById('alliance-filter');
        const allianceFilterButton = document.getElementById('alliance-filter-button');
        const allianceFilterLabel = document.getElementById('alliance-filter-label');
        const allianceFilterMenu = document.getElementById('alliance-filter-menu');
        const allianceFilterIcon = allianceFilterButton.querySelector('i');

        // --- UI Functions ---
        const showLoading = (show) => { loadingOverlay.style.display = show ? 'flex' : 'none'; };
        const showModal = (modal, content) => {
            if (content) modal.querySelector('.modal-content').innerHTML = content;
            modal.classList.remove('hidden');
            setTimeout(() => { modal.style.opacity = 1; modal.querySelector('.modal-content').style.transform = 'scale(1)'; }, 10);
        };
        const hideModal = (modal) => {
            modal.style.opacity = 0;
            modal.querySelector('.modal-content').style.transform = 'scale(0.95)';
            setTimeout(() => modal.classList.add('hidden'), 300);
        };

        // --- Auth UI ---
        const updateAuthUI = (user) => {
            let desktopHtml, mobileHtml;
            if (user && currentUserData) {
                desktopHtml = `
                    <div class="flex items-center gap-2">
                        <span class="font-semibold text-white">${currentUserData.gamertag}</span>
                        <button id="logout-button" class="login-button bg-red-500/20 hover:bg-red-500/40">Logout</button>
                    </div>`;
                mobileHtml = `<button id="mobile-logout-button" class="login-button justify-center text-lg w-full bg-red-500/20 hover:bg-red-500/40">Logout</button>`;
                
                if (currentUserData.rank >= 4) {
                    addPlayerButton.classList.remove('hidden');
                } else {
                    addPlayerButton.classList.add('hidden');
                }
            } else {
                desktopHtml = `<button id="login-signup-button" class="login-button">Login / Sign Up</button>`;
                mobileHtml = `<button id="mobile-login-signup-button" class="login-button justify-center text-lg w-full">Login / Sign Up</button>`;
                addPlayerButton.classList.add('hidden');
            }
            authContainer.innerHTML = desktopHtml;
            mobileAuthContainer.innerHTML = mobileHtml;

            // Add event listeners
            const loginBtn = document.getElementById('login-signup-button');
            const mobileLoginBtn = document.getElementById('mobile-login-signup-button');
            const logoutBtn = document.getElementById('logout-button');
            const mobileLogoutBtn = document.getElementById('mobile-logout-button');

            if (loginBtn) loginBtn.addEventListener('click', showAuthForm);
            if (mobileLoginBtn) mobileLoginBtn.addEventListener('click', () => {
                showAuthForm();
                toggleMobileMenu();
            });
            if (logoutBtn) logoutBtn.addEventListener('click', () => signOut(auth));
            if (mobileLogoutBtn) mobileLogoutBtn.addEventListener('click', () => signOut(auth));
        };

        const showAuthForm = () => {
            const formHtml = `
                <h2 class="text-2xl font-bold text-white text-center mb-1">Welcome</h2>
                <p class="text-center text-gray-400 mb-6">Login or create an account to continue.</p>
                <form id="email-password-form" class="space-y-4">
                    <input required class="w-full bg-gray-900/50 border border-gray-700 rounded-lg px-4 py-2 text-white" type="email" name="email" placeholder="Email">
                    <input required class="w-full bg-gray-900/50 border border-gray-700 rounded-lg px-4 py-2 text-white" type="password" name="password" placeholder="Password">
                    <div id="auth-error" class="text-red-400 text-sm text-center h-4"></div>
                    <div class="flex gap-4 pt-2">
                        <button type="submit" data-action="login" class="flex-1 login-button">Login</button>
                        <button type="submit" data-action="signup" class="flex-1 login-button bg-cyan-500/20">Sign Up</button>
                    </div>
                </form>
            `;
            showModal(authModal, formHtml);
        };

        // --- Player & Alliance Functions ---
        const formatPower = (num) => num >= 1000000 ? `${(num / 1000000).toFixed(1)}M` : `${(num / 1000).toFixed(1)}K`;
        
        const createPlayerCard = (player) => `
            <div class="player-card glass-pane p-4 flex flex-col">
                <div class="flex items-center mb-4">
                    <img src="https://placehold.co/64x64/003344/00A9FF?text=${player.name.substring(0,2)}" class="w-16 h-16 rounded-full border-2 border-cyan-400">
                    <div class="ml-4">
                        <h3 class="text-xl font-bold text-white">${player.name}</h3>
                        <p class="text-sm font-semibold" style="color: var(--color-primary);">[${player.alliance}] <span class="text-gray-400 font-normal">- R${player.rank}</span></p>
                    </div>
                </div>
                <div class="border-t border-gray-700 my-2"></div>
                <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm mb-4">
                    <div class="flex items-center gap-2"><i class="fas fa-fist-raised w-4 text-center text-gray-400"></i><div><div class="font-bold text-white">${formatPower(player.power)}</div><div class="text-xs text-gray-500">Power</div></div></div>
                </div>
                <div class="border-t border-gray-700 mt-auto pt-4 flex justify-around">
                    <button class="action-button" title="Send Message"><i class="fas fa-comment-dots fa-lg"></i></button>
                    <button class="action-button" title="Add Friend"><i class="fas fa-user-plus fa-lg"></i></button>
                    <button class="action-button" title="Like Player"><i class="fas fa-thumbs-up fa-lg"></i></button>
                </div>
            </div>`;

        const renderPlayers = () => {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedAlliance = allianceFilter.dataset.selected;
            const filtered = playersData.filter(p => p.name.toLowerCase().includes(searchTerm) && (!selectedAlliance || selectedAlliance === 'all' || p.alliance === selectedAlliance));
            const sorted = filtered.sort((a, b) => b.rank - a.rank || b.power - a.power);
            
            playerCardGrid.innerHTML = sorted.length ? sorted.map(createPlayerCard).join('') : '';
            noPlayersMessage.style.display = sorted.length ? 'none' : 'block';
        };

        const populateAllianceFilter = () => {
            const alliances = ['All Alliances', ...new Set(playersData.map(p => p.alliance).sort())];
            allianceFilterMenu.innerHTML = alliances.map(a => `<a href="#" class="filter-dropdown-item block px-4 py-2 rounded-md" data-value="${a === 'All Alliances' ? 'all' : a}">${a}</a>`).join('');
        };

        // --- Firebase Auth Logic ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    currentUserData = userDoc.data();
                } else {
                    const newUserData = { email: user.email, gamertag: user.email.split('@')[0], rank: 1 };
                    await setDoc(userDocRef, newUserData);
                    currentUserData = newUserData;
                }
            } else {
                currentUserData = null;
            }
            updateAuthUI(user);
            showLoading(false);
        });

        // --- Event Listeners ---
        authModal.addEventListener('click', (e) => { if (e.target === authModal) hideModal(authModal); });
        authModal.addEventListener('submit', async (e) => {
            e.preventDefault();
            const action = e.submitter.dataset.action;
            const email = e.target.email.value;
            const password = e.target.password.value;
            const errorDiv = document.getElementById('auth-error');
            errorDiv.textContent = '';
            try {
                if (action === 'signup') {
                    await createUserWithEmailAndPassword(auth, email, password);
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
                hideModal(authModal);
            } catch (error) { errorDiv.textContent = error.message; }
        });

        addPlayerButton.addEventListener('click', () => showModal(addPlayerModal));
        cancelAddPlayerButton.addEventListener('click', () => hideModal(addPlayerModal));
        addPlayerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const newPlayer = {
                name: formData.get('name'),
                alliance: formData.get('alliance').toUpperCase(),
                rank: parseInt(formData.get('rank')),
                power: parseInt(formData.get('power')),
                createdAt: new Date(),
            };
            try {
                await addDoc(collection(db, "players"), newPlayer);
                addPlayerForm.reset();
                hideModal(addPlayerModal);
            } catch (error) { console.error("Error adding player: ", error); alert("Failed to add player."); }
        });

        searchInput.addEventListener('input', renderPlayers);
        allianceFilterButton.addEventListener('click', (e) => { e.stopPropagation(); allianceFilter.classList.toggle('open'); allianceFilterIcon.classList.toggle('rotate-180'); });
        allianceFilterMenu.addEventListener('click', (e) => {
            if (e.target.tagName === 'A') {
                e.preventDefault();
                allianceFilter.dataset.selected = e.target.dataset.value;
                allianceFilterLabel.textContent = e.target.textContent;
                renderPlayers();
            }
        });
        window.addEventListener('click', () => { if (allianceFilter.classList.contains('open')) { allianceFilter.classList.remove('open'); allianceFilterIcon.classList.remove('rotate-180'); } });

        // --- Data Fetching from Firestore ---
        onSnapshot(collection(db, "players"), (snapshot) => {
            playersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderPlayers();
            populateAllianceFilter();
        });

        // --- Initial Load & Navigation ---
        showLoading(true);
        const pages = document.querySelectorAll('.page-content');
        const navLinks = document.querySelectorAll('.nav-link, .dropdown-link, .mobile-nav-link');
        
        const showPage = (targetId) => {
            pages.forEach(p => p.style.display = p.id === targetId ? 'block' : 'none');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            const activeLink = document.querySelector(`.nav-link[data-main-target="${targetId}"], .nav-link[data-target="${targetId}"]`);
            if(activeLink) activeLink.classList.add('active');
        }

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.dataset.target || link.dataset.mainTarget;
                if(targetId) showPage(targetId);
                
                // Close menus
                document.querySelectorAll('.nav-item.open').forEach(item => item.classList.remove('open'));
                if(mobileMenu.classList.contains('open')) toggleMobileMenu();
            });
        });
        
        const mobileMenu = document.getElementById('mobile-menu');
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const menuOpenIcon = document.getElementById('menu-open-icon');
        const menuCloseIcon = document.getElementById('menu-close-icon');
        const toggleMobileMenu = () => {
            mobileMenu.classList.toggle('open');
            menuOpenIcon.classList.toggle('hidden');
            menuCloseIcon.classList.toggle('hidden');
        };
        mobileMenuButton.addEventListener('click', toggleMobileMenu);

        showPage('page-players');
    </script>
</body>
</html>
